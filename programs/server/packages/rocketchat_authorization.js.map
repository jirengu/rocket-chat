{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:authorization/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Permissions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Roles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Base.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Subscriptions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/addUserRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/canAccessRoom.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/getRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/getUsersInRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/hasPermission.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/hasRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/removeUserFromRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/permissions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/roles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/usersInRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/addUserToRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/deleteRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/removeUserFromRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/saveRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/addPermissionToRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/removeRoleFromPermission.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/startup.js"],"names":["RocketChat","authz","ModelPermissions","arguments","findByRole","role","options","query","roles","find","findOneById","_id","findOne","createOrUpdate","name","upsert","$set","addRole","permission","update","$addToSet","removeRole","$pull","models","_Base","Permissions","cache","load","ModelRoles","tryEnsureIndex","findUsersInRole","scope","roleScope","model","findUsersInRoles","isUserInRoles","userId","concat","some","roleName","isUserInRole","description","protectedRole","updateData","protected","addUserRoles","addRolesByUserId","removeUserRoles","removeRolesByUserId","Roles","prototype","roleBaseQuery","findRolesByUserId","fields","_","isUndefined","$each","$pullAll","Meteor","Error","Users","$in","Subscriptions","rid","subscriptions","fetch","users","compact","map","subscription","u","roleNames","user","db","existingRoleNames","pluck","getRoles","invalidRoleNames","difference","isEmpty","roomAccessValidators","room","findOneByRoomIdAndUserId","_room","t","hasPermission","canAccessRoom","validator","call","addRoomAccessValidator","push","getUsersInRole","atLeastOne","permissions","permissionId","all","every","strategy","hasAllPermission","hasAtLeastOnePermission","hasRole","removeUserFromRoles","methods","updatedAt","unblock","records","Date","filter","record","_updatedAt","remove","trashFindDeletedAfter","_deletedAt","on","type","Notifications","notifyLoggedInThisInstance","publish","ready","limit","error","sort","username","method","action","isString","findOneByUsername","add","settings","get","notifyLogged","existingUsers","count","adminCount","userIsAdmin","indexOf","roleData","includes","startup","defaultRoles","$setOnInsert"],"mappings":"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","file":"/packages/rocketchat_authorization.js","sourcesContent":["RocketChat.authz = {};\n","class ModelPermissions extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper(...arguments);\n\t}\n\n\t// FIND\n\tfindByRole(role, options) {\n\t\tconst query = {\n\t\t\troles: role\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindOneById(_id) {\n\t\treturn this.findOne(_id);\n\t}\n\n\tcreateOrUpdate(name, roles) {\n\t\tthis.upsert({ _id: name }, { $set: { roles: roles } });\n\t}\n\n\taddRole(permission, role) {\n\t\tthis.update({ _id: permission }, { $addToSet: { roles: role } });\n\t}\n\n\tremoveRole(permission, role) {\n\t\tthis.update({ _id: permission }, { $pull: { roles: role } });\n\t}\n}\n\nRocketChat.models.Permissions = new ModelPermissions('permissions', true);\nRocketChat.models.Permissions.cache.load();\n","class ModelRoles extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper(...arguments);\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t\tthis.tryEnsureIndex({ 'scope': 1 });\n\t}\n\n\tfindUsersInRole(name, scope, options) {\n\t\tconst role = this.findOne(name);\n\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\tconst model = RocketChat.models[roleScope];\n\n\t\treturn model && model.findUsersInRoles && model.findUsersInRoles(name, scope, options);\n\t}\n\n\tisUserInRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\treturn roles.some((roleName) => {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\treturn model && model.isUserInRole && model.isUserInRole(userId, roleName, scope);\n\t\t});\n\t}\n\n\tcreateOrUpdate(name, scope = 'Users', description, protectedRole) {\n\t\tconst updateData = {};\n\t\tupdateData.name = name;\n\t\tupdateData.scope = scope;\n\n\t\tif (description != null) {\n\t\t\tupdateData.description = description;\n\t\t}\n\n\t\tif (protectedRole) {\n\t\t\tupdateData.protected = protectedRole;\n\t\t}\n\n\t\tthis.upsert({ _id: name }, { $set: updateData });\n\t}\n\n\taddUserRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\tfor (const roleName of roles) {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\tmodel && model.addRolesByUserId && model.addRolesByUserId(userId, roleName, scope);\n\t\t}\n\t\treturn true;\n\t}\n\n\tremoveUserRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\tfor (const roleName of roles) {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\tmodel && model.removeRolesByUserId && model.removeRolesByUserId(userId, roleName, scope);\n\t\t}\n\t\treturn true;\n\t}\n}\n\nRocketChat.models.Roles = new ModelRoles('roles', true);\nRocketChat.models.Roles.cache.load();\n","RocketChat.models._Base.prototype.roleBaseQuery = function(/*userId, scope*/) {\n\treturn;\n};\n\nRocketChat.models._Base.prototype.findRolesByUserId = function(userId/*, options*/) {\n\tconst query = this.roleBaseQuery(userId);\n\treturn this.find(query, { fields: { roles: 1 } });\n};\n\nRocketChat.models._Base.prototype.isUserInRole = function(userId, roleName, scope) {\n\tconst query = this.roleBaseQuery(userId, scope);\n\n\tif (query == null) {\n\t\treturn false;\n\t}\n\n\tquery.roles = roleName;\n\treturn !_.isUndefined(this.findOne(query));\n};\n\nRocketChat.models._Base.prototype.addRolesByUserId = function(userId, roles, scope) {\n\troles = [].concat(roles);\n\tconst query = this.roleBaseQuery(userId, scope);\n\tconst update = {\n\t\t$addToSet: {\n\t\t\troles: { $each: roles }\n\t\t}\n\t};\n\treturn this.update(query, update);\n};\n\nRocketChat.models._Base.prototype.removeRolesByUserId = function(userId, roles, scope) {\n\troles = [].concat(roles);\n\tconst query = this.roleBaseQuery(userId, scope);\n\tconst update = {\n\t\t$pullAll: {\n\t\t\troles: roles\n\t\t}\n\t};\n\treturn this.update(query, update);\n};\n\nRocketChat.models._Base.prototype.findUsersInRoles = function() {\n\tthrow new Meteor.Error('overwrite-function', 'You must overwrite this function in the extended classes');\n};\n","RocketChat.models.Users.roleBaseQuery = function(userId) {\n\treturn { _id: userId };\n};\n\nRocketChat.models.Users.findUsersInRoles = function(roles, scope, options) {\n\troles = [].concat(roles);\n\n\tvar query = {\n\t\troles: { $in: roles }\n\t};\n\n\treturn this.find(query, options);\n};\n","RocketChat.models.Subscriptions.roleBaseQuery = function(userId, scope) {\n\tif (scope == null) {\n\t\treturn;\n\t}\n\n\tvar query = { 'u._id': userId };\n\tif (!_.isUndefined(scope)) {\n\t\tquery.rid = scope;\n\t}\n\treturn query;\n};\n\nRocketChat.models.Subscriptions.findUsersInRoles = function(roles, scope, options) {\n\troles = [].concat(roles);\n\n\tvar query = {\n\t\troles: { $in: roles }\n\t};\n\n\tif (scope) {\n\t\tquery.rid = scope;\n\t}\n\n\tvar subscriptions = this.find(query).fetch();\n\n\tvar users = _.compact(_.map(subscriptions, function(subscription) {\n\t\tif ('undefined' !== typeof subscription.u && 'undefined' !== typeof subscription.u._id) {\n\t\t\treturn subscription.u._id;\n\t\t}\n\t}));\n\n\treturn RocketChat.models.Users.find({ _id: { $in: users } }, options);\n};\n","RocketChat.authz.addUserRoles = function(userId, roleNames, scope) {\n\tif (!userId || !roleNames) {\n\t\treturn false;\n\t}\n\n\tconst user = RocketChat.models.Users.db.findOneById(userId);\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.authz.addUserRoles'\n\t\t});\n\t}\n\n\troleNames = [].concat(roleNames);\n\tconst existingRoleNames = _.pluck(RocketChat.authz.getRoles(), '_id');\n\tconst invalidRoleNames = _.difference(roleNames, existingRoleNames);\n\n\tif (!_.isEmpty(invalidRoleNames)) {\n\t\tfor (const role of invalidRoleNames) {\n\t\t\tRocketChat.models.Roles.createOrUpdate(role);\n\t\t}\n\t}\n\n\tRocketChat.models.Roles.addUserRoles(userId, roleNames, scope);\n\n\treturn true;\n};\n","/* globals RocketChat */\nRocketChat.authz.roomAccessValidators = [\n\tfunction(room, user) {\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, user._id);\n\t\tif (subscription) {\n\t\t\treturn subscription._room;\n\t\t}\n\t},\n\tfunction(room, user) {\n\t\tif (room.t === 'c') {\n\t\t\treturn RocketChat.authz.hasPermission(user._id, 'view-c-room');\n\t\t}\n\t}\n];\n\nRocketChat.authz.canAccessRoom = function(room, user) {\n\treturn RocketChat.authz.roomAccessValidators.some((validator) => {\n\t\treturn validator.call(this, room, user);\n\t});\n};\n\nRocketChat.authz.addRoomAccessValidator = function(validator) {\n\tRocketChat.authz.roomAccessValidators.push(validator);\n};\n","RocketChat.authz.getRoles = function() {\n\treturn RocketChat.models.Roles.find().fetch();\n};\n","RocketChat.authz.getUsersInRole = function(roleName, scope, options) {\n\treturn RocketChat.models.Roles.findUsersInRole(roleName, scope, options);\n};\n","function atLeastOne(userId, permissions = [], scope) {\n\treturn permissions.some((permissionId) => {\n\t\tconst permission = RocketChat.models.Permissions.findOne(permissionId);\n\t\treturn RocketChat.models.Roles.isUserInRoles(userId, permission.roles, scope);\n\t});\n}\n\nfunction all(userId, permissions = [], scope) {\n\treturn permissions.every((permissionId) => {\n\t\tconst permission = RocketChat.models.Permissions.findOne(permissionId);\n\t\treturn RocketChat.models.Roles.isUserInRoles(userId, permission.roles, scope);\n\t});\n}\n\nfunction hasPermission(userId, permissions, scope, strategy) {\n\tif (!userId) {\n\t\treturn false;\n\t}\n\n\tpermissions = [].concat(permissions);\n\treturn strategy(userId, permissions, scope);\n}\n\nRocketChat.authz.hasAllPermission = function(userId, permissions, scope) {\n\treturn hasPermission(userId, permissions, scope, all);\n};\n\nRocketChat.authz.hasPermission = RocketChat.authz.hasAllPermission;\n\nRocketChat.authz.hasAtLeastOnePermission = function(userId, permissions, scope) {\n\treturn hasPermission(userId, permissions, scope, atLeastOne);\n};\n","RocketChat.authz.hasRole = function(userId, roleNames, scope) {\n\troleNames = [].concat(roleNames);\n\treturn RocketChat.models.Roles.isUserInRoles(userId, roleNames, scope);\n};\n","RocketChat.authz.removeUserFromRoles = function(userId, roleNames, scope) {\n\tif (!userId || !roleNames) {\n\t\treturn false;\n\t}\n\n\tconst user = RocketChat.models.Users.findOneById(userId);\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.authz.removeUserFromRoles'\n\t\t});\n\t}\n\n\troleNames = [].concat(roleNames);\n\tconst existingRoleNames = _.pluck(RocketChat.authz.getRoles(), '_id');\n\tconst invalidRoleNames = _.difference(roleNames, existingRoleNames);\n\n\tif (!_.isEmpty(invalidRoleNames)) {\n\t\tthrow new Meteor.Error('error-invalid-role', 'Invalid role', {\n\t\t\tfunction: 'RocketChat.authz.removeUserFromRoles'\n\t\t});\n\t}\n\n\tRocketChat.models.Roles.removeUserRoles(userId, roleNames, scope);\n\n\treturn true;\n};\n","Meteor.methods({\n\t'permissions/get'(updatedAt) {\n\t\tthis.unblock();\n\n\t\tconst records = RocketChat.models.Permissions.find().fetch();\n\n\t\tif (updatedAt instanceof Date) {\n\t\t\treturn {\n\t\t\t\tupdate: records.filter((record) => {\n\t\t\t\t\treturn record._updatedAt > updatedAt;\n\t\t\t\t}),\n\t\t\t\tremove: RocketChat.models.Permissions.trashFindDeletedAfter(updatedAt, {}, {fields: {_id: 1, _deletedAt: 1}}).fetch()\n\t\t\t};\n\t\t}\n\n\t\treturn records;\n\t}\n});\n\n\nRocketChat.models.Permissions.on('changed', (type, permission) => {\n\tRocketChat.Notifications.notifyLoggedInThisInstance('permissions-changed', type, permission);\n});\n","Meteor.publish('roles', function() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\treturn RocketChat.models.Roles.find();\n});\n","Meteor.publish('usersInRole', function(roleName, scope, limit = 50) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'access-permissions')) {\n\t\treturn this.error(new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\tpublish: 'usersInRole'\n\t\t}));\n\t}\n\n\tconst options = {\n\t\tlimit: limit,\n\t\tsort: {\n\t\t\tname: 1\n\t\t}\n\t};\n\n\treturn RocketChat.authz.getUsersInRole(roleName, scope, options);\n});\n","Meteor.methods({\n\t'authorization:addUserToRole'(roleName, username, scope) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:addUserToRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleName || !_.isString(roleName) || !username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n\t\t\t\tmethod: 'authorization:addUserToRole'\n\t\t\t});\n\t\t}\n\n\t\tif (roleName === 'admin' && !RocketChat.authz.hasPermission(Meteor.userId(), 'assign-admin-role')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Assigning admin is not allowed', {\n\t\t\t\tmethod: 'insertOrUpdateUser',\n\t\t\t\taction: 'Assign_admin'\n\t\t\t});\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, {\n\t\t\tfields: {\n\t\t\t\t_id: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'authorization:addUserToRole'\n\t\t\t});\n\t\t}\n\n\t\tconst add = RocketChat.models.Roles.addUserRoles(user._id, roleName, scope);\n\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'added',\n\t\t\t\t_id: roleName,\n\t\t\t\tu: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername: username\n\t\t\t\t},\n\t\t\t\tscope: scope\n\t\t\t});\n\t\t}\n\n\t\treturn add;\n\t}\n});\n","Meteor.methods({\n\t'authorization:deleteRole'(roleName) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:deleteRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tconst role = RocketChat.models.Roles.findOne(roleName);\n\t\tif (!role) {\n\t\t\tthrow new Meteor.Error('error-invalid-role', 'Invalid role', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\tif (role.protected) {\n\t\t\tthrow new Meteor.Error('error-delete-protected-role', 'Cannot delete a protected role', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\tconst roleScope = role.scope || 'Users';\n\t\tconst model = RocketChat.models[roleScope];\n\t\tconst existingUsers = model && model.findUsersInRoles && model.findUsersInRoles(roleName);\n\n\t\tif (existingUsers && existingUsers.count() > 0) {\n\t\t\tthrow new Meteor.Error('error-role-in-use', 'Cannot delete role because it\\'s in use', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Roles.remove(role.name);\n\t}\n});\n","Meteor.methods({\n\t'authorization:removeUserFromRole'(roleName, username, scope) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Access permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleName || !_.isString(roleName) || !username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole'\n\t\t\t});\n\t\t}\n\n\t\tconst user = Meteor.users.findOne({\n\t\t\tusername: username\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\t_id: 1,\n\t\t\t\troles: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole'\n\t\t\t});\n\t\t}\n\n\t\t// prevent removing last user from admin role\n\t\tif (roleName === 'admin') {\n\t\t\tconst adminCount = Meteor.users.find({\n\t\t\t\troles: {\n\t\t\t\t\t$in: ['admin']\n\t\t\t\t}\n\t\t\t}).count();\n\n\t\t\tconst userIsAdmin = user.roles.indexOf('admin') > -1;\n\t\t\tif (adminCount === 1 && userIsAdmin) {\n\t\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Leaving the app without admins is not allowed', {\n\t\t\t\t\tmethod: 'removeUserFromRole',\n\t\t\t\t\taction: 'Remove_last_admin'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tconst remove = RocketChat.models.Roles.removeUserRoles(user._id, roleName, scope);\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'removed',\n\t\t\t\t_id: roleName,\n\t\t\t\tu: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername: username\n\t\t\t\t},\n\t\t\t\tscope: scope\n\t\t\t});\n\t\t}\n\n\t\treturn remove;\n\t}\n});\n","Meteor.methods({\n\t'authorization:saveRole'(roleData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:saveRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleData.name) {\n\t\t\tthrow new Meteor.Error('error-role-name-required', 'Role name is required', {\n\t\t\t\tmethod: 'authorization:saveRole'\n\t\t\t});\n\t\t}\n\n\t\tif (['Users', 'Subscriptions'].includes(roleData.scope) === false) {\n\t\t\troleData.scope = 'Users';\n\t\t}\n\n\t\tconst update = RocketChat.models.Roles.createOrUpdate(roleData.name, roleData.scope, roleData.description);\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'changed',\n\t\t\t\t_id: roleData.name\n\t\t\t});\n\t\t}\n\n\t\treturn update;\n\t}\n});\n","Meteor.methods({\n\t'authorization:addPermissionToRole'(permission, role) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Adding permission is not allowed', {\n\t\t\t\tmethod: 'authorization:addPermissionToRole',\n\t\t\t\taction: 'Adding_permission'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Permissions.addRole(permission, role);\n\t}\n});\n","Meteor.methods({\n\t'authorization:removeRoleFromPermission'(permission, role) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:removeRoleFromPermission',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Permissions.removeRole(permission, role);\n\t}\n});\n","/* eslint no-multi-spaces: 0 */\n\nMeteor.startup(function() {\n\t// Note:\n\t// 1.if we need to create a role that can only edit channel message, but not edit group message\n\t// then we can define edit-<type>-message instead of edit-message\n\t// 2. admin, moderator, and user roles should not be deleted as they are referened in the code.\n\tconst permissions = [\n\t\t{ _id: 'access-permissions',            roles : ['admin'] },\n\t\t{ _id: 'add-oauth-service',             roles : ['admin'] },\n\t\t{ _id: 'add-user-to-joined-room',       roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'add-user-to-any-c-room',        roles : ['admin'] },\n\t\t{ _id: 'add-user-to-any-p-room',        roles : [] },\n\t\t{ _id: 'archive-room',                  roles : ['admin', 'owner'] },\n\t\t{ _id: 'assign-admin-role',             roles : ['admin'] },\n\t\t{ _id: 'ban-user',                      roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'bulk-create-c',                 roles : ['admin'] },\n\t\t{ _id: 'bulk-register-user',            roles : ['admin'] },\n\t\t{ _id: 'create-c',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-d',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-p',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-user',                   roles : ['admin'] },\n\t\t{ _id: 'clean-channel-history',         roles : ['admin'] }, // special permission to bulk delete a channel's mesages\n\t\t{ _id: 'delete-c',                      roles : ['admin'] },\n\t\t{ _id: 'delete-d',                      roles : ['admin'] },\n\t\t{ _id: 'delete-message',                roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'delete-p',                      roles : ['admin'] },\n\t\t{ _id: 'delete-user',                   roles : ['admin'] },\n\t\t{ _id: 'edit-message',                  roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'edit-other-user-active-status', roles : ['admin'] },\n\t\t{ _id: 'edit-other-user-info',          roles : ['admin'] },\n\t\t{ _id: 'edit-other-user-password',      roles : ['admin'] },\n\t\t{ _id: 'edit-privileged-setting',       roles : ['admin'] },\n\t\t{ _id: 'edit-room',                     roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'manage-assets',                 roles : ['admin'] },\n\t\t{ _id: 'manage-emoji',                  roles : ['admin'] },\n\t\t{ _id: 'manage-integrations',           roles : ['admin'] },\n\t\t{ _id: 'manage-own-integrations',       roles : ['admin', 'bot'] },\n\t\t{ _id: 'manage-oauth-apps',             roles : ['admin'] },\n\t\t{ _id: 'mention-all',                   roles : ['admin', 'owner', 'moderator', 'user'] },\n\t\t{ _id: 'mute-user',                     roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'remove-user',                   roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'run-import',                    roles : ['admin'] },\n\t\t{ _id: 'run-migration',                 roles : ['admin'] },\n\t\t{ _id: 'set-moderator',                 roles : ['admin', 'owner'] },\n\t\t{ _id: 'set-owner',                     roles : ['admin', 'owner'] },\n\t\t{ _id: 'unarchive-room',                roles : ['admin'] },\n\t\t{ _id: 'view-c-room',                   roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'view-d-room',                   roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'view-full-other-user-info',     roles : ['admin'] },\n\t\t{ _id: 'view-history',                  roles : ['admin', 'user'] },\n\t\t{ _id: 'view-joined-room',              roles : ['guest', 'bot'] },\n\t\t{ _id: 'view-join-code',                roles : ['admin'] },\n\t\t{ _id: 'view-logs',                     roles : ['admin'] },\n\t\t{ _id: 'view-other-user-channels',      roles : ['admin'] },\n\t\t{ _id: 'view-p-room',                   roles : ['admin', 'user'] },\n\t\t{ _id: 'view-privileged-setting',       roles : ['admin'] },\n\t\t{ _id: 'view-room-administration',      roles : ['admin'] },\n\t\t{ _id: 'view-statistics',               roles : ['admin'] },\n\t\t{ _id: 'view-user-administration',      roles : ['admin'] },\n\t\t{ _id: 'preview-c-room',                roles : ['admin', 'user'] }\n\t];\n\n\tfor (const permission of permissions) {\n\t\tif (!RocketChat.models.Permissions.findOneById(permission._id)) {\n\t\t\tRocketChat.models.Permissions.upsert(permission._id, {$set: permission });\n\t\t}\n\t}\n\n\tconst defaultRoles = [\n\t\t{ name: 'admin',     scope: 'Users',         description: 'Admin' },\n\t\t{ name: 'moderator', scope: 'Subscriptions', description: 'Moderator' },\n\t\t{ name: 'owner',     scope: 'Subscriptions', description: 'Owner' },\n\t\t{ name: 'user',      scope: 'Users',         description: '' },\n\t\t{ name: 'bot',       scope: 'Users',         description: '' },\n\t\t{ name: 'guest',     scope: 'Users',         description: '' }\n\t];\n\n\tfor (const role of defaultRoles) {\n\t\tRocketChat.models.Roles.upsert({ _id: role.name }, { $setOnInsert: { scope: role.scope, description: role.description || '', protected: true } });\n\t}\n});\n"]}