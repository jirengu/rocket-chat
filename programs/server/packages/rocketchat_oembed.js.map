{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:oembed/server/jumpToMessage.js"],"names":["URL","Npm","require","QueryString","RocketChat","callbacks","add","msg","urls","forEach","item","url","indexOf","Meteor","absoluteUrl","urlObj","parse","query","queryString","_","isString","jumpToMessage","models","Messages","findOneById","attachments","push","u","username","getAvatarUrlFromUsername","ts","ignoreParse","priority","LOW"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,sCAEA,IAAMA,MAAMC,IAAIC,OAAJ,CAAY,KAAZ,CAAZ;;AACA,IAAMC,cAAcF,IAAIC,OAAJ,CAAY,aAAZ,CAApB;;AAEAE,WAAWC,SAAX,CAAqBC,GAArB,CAAyB,mBAAzB,EAA8C,UAACC,GAAD,EAAS;AACtD,KAAIA,OAAOA,IAAIC,IAAf,EAAqB;AACpBD,MAAIC,IAAJ,CAASC,OAAT,CAAiB,UAACC,IAAD,EAAU;AAC1B,OAAIA,KAAKC,GAAL,CAASC,OAAT,CAAiBC,OAAOC,WAAP,EAAjB,MAA2C,CAA/C,EAAkD;AACjD,QAAMC,SAASf,IAAIgB,KAAJ,CAAUN,KAAKC,GAAf,CAAf;;AACA,QAAII,OAAOE,KAAX,EAAkB;AACjB,SAAMC,cAAcf,YAAYa,KAAZ,CAAkBD,OAAOE,KAAzB,CAApB;;AACA,SAAIE,EAAEC,QAAF,CAAWF,YAAYX,GAAvB,CAAJ,EAAiC;AAAE;AAClC,UAAMc,gBAAgBjB,WAAWkB,MAAX,CAAkBC,QAAlB,CAA2BC,WAA3B,CAAuCN,YAAYX,GAAnD,CAAtB;;AACA,UAAIc,aAAJ,EAAmB;AAClBd,WAAIkB,WAAJ,GAAkBlB,IAAIkB,WAAJ,IAAmB,EAArC;AACAlB,WAAIkB,WAAJ,CAAgBC,IAAhB,CAAqB;AACpB,gBAASL,cAAcd,GADH;AAEpB,uBAAgBc,cAAcM,CAAd,CAAgBC,QAFZ;AAGpB,uBAAgBC,yBAAyBR,cAAcM,CAAd,CAAgBC,QAAzC,CAHI;AAIpB,wBAAiBlB,KAAKC,GAJF;AAKpB,uBAAgBU,cAAcI,WAAd,IAA6B,EALzB;AAMpB,cAAMJ,cAAcS;AANA,QAArB;AAQApB,YAAKqB,WAAL,GAAmB,IAAnB;AACA;AACD;AACD;AACD;AACD,GAtBD;AAuBA;;AACD,QAAOxB,GAAP;AACA,CA3BD,EA2BGH,WAAWC,SAAX,CAAqB2B,QAArB,CAA8BC,GA3BjC,EA2BsC,eA3BtC,mE","file":"/packages/rocketchat_oembed.js","sourcesContent":["/* globals getAvatarUrlFromUsername */\n\nconst URL = Npm.require('url');\nconst QueryString = Npm.require('querystring');\n\nRocketChat.callbacks.add('beforeSaveMessage', (msg) => {\n\tif (msg && msg.urls) {\n\t\tmsg.urls.forEach((item) => {\n\t\t\tif (item.url.indexOf(Meteor.absoluteUrl()) === 0) {\n\t\t\t\tconst urlObj = URL.parse(item.url);\n\t\t\t\tif (urlObj.query) {\n\t\t\t\t\tconst queryString = QueryString.parse(urlObj.query);\n\t\t\t\t\tif (_.isString(queryString.msg)) { // Jump-to query param\n\t\t\t\t\t\tconst jumpToMessage = RocketChat.models.Messages.findOneById(queryString.msg);\n\t\t\t\t\t\tif (jumpToMessage) {\n\t\t\t\t\t\t\tmsg.attachments = msg.attachments || [];\n\t\t\t\t\t\t\tmsg.attachments.push({\n\t\t\t\t\t\t\t\t'text' : jumpToMessage.msg,\n\t\t\t\t\t\t\t\t'author_name' : jumpToMessage.u.username,\n\t\t\t\t\t\t\t\t'author_icon' : getAvatarUrlFromUsername(jumpToMessage.u.username),\n\t\t\t\t\t\t\t\t'message_link' : item.url,\n\t\t\t\t\t\t\t\t'attachments' : jumpToMessage.attachments || [],\n\t\t\t\t\t\t\t\t'ts': jumpToMessage.ts\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\titem.ignoreParse = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\treturn msg;\n}, RocketChat.callbacks.priority.LOW, 'jumpToMessage');\n"]}