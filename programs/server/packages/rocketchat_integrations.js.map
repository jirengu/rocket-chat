{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:integrations/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/logger.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/validation.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/triggerHandler.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/Integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/IntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/addIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/updateIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/deleteIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/addOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/updateOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/replayOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/deleteOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/clearIntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/triggers.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/processWebhookMessage.js"],"names":["RocketChat","integrations","outgoingEvents","sendMessage","label","value","use","channel","triggerWords","targetRoom","fileUploaded","roomArchived","roomCreated","roomJoined","roomLeft","userCreated","logger","Logger","sections","incoming","outgoing","scopedChannels","validChannelChars","_verifyRequiredFields","integration","event","Match","test","String","trim","Meteor","Error","username","urls","entries","index","url","_","without","undefined","length","_verifyUserHasPermissionForChannels","userId","channels","includes","authz","hasPermission","record","channelType","substr","models","Rooms","findOne","$or","_id","name","Users","usernames","user","_verifyRetryInformation","retryFailedCalls","retryCount","parseInt","retryDelay","toLowerCase","validateOutgoing","_validateOutgoing","map","split","s","triggerWord","scriptEnabled","script","babelOptions","Object","assign","Babel","getDefaultOptions","runtime","compact","minified","comments","scriptCompiled","compile","code","scriptError","e","pick","type","moment","module","import","v","triggerHandler","vm","Npm","require","successResults","compiledScripts","triggers","Integrations","find","observe","added","addIntegration","changed","removeIntegration","removed","debug","isEmpty","concat","values","trigger","updateHistory","historyId","step","data","ranPrepareScript","prepareSentMessage","processSentMessage","resultMessage","finished","httpCallData","httpError","httpResult","error","errorStack","history","omit","room","IntegrationHistory","update","$set","_createdAt","Date","insert","Random","id","nameOrId","message","impersonateUser","findOneByUsername","user_name","tmpRoom","getRoomByNameOrIdWithOptionToJoin","currentUserId","errorOnEmpty","warn","t","bot","i","defaultValues","alias","avatar","emoji","processWebhookMessage","getIntegrationScript","compiledScript","_updatedAt","store","sandbox","console","Store","set","key","val","get","HTTP","method","options","result","call","vmScript","info","createScript","runInNewContext","Script","replace","stack","hasScriptAndMethod","executeScript","params","timeout","eventNameArgumentsToObject","argObject","arguments","arghhh","owner","mapEventArgsToData","channel_id","channel_name","message_id","timestamp","ts","user_id","u","text","msg","createdAt","executeTriggers","triggersToExecute","push","all_direct_messages","all_public_channels","all_private_groups","__any","triggerToExecute","enabled","executeTrigger","executeTriggerUrl","theHistoryId","tries","word","triggerWordAnywhere","indexOf","token","trigger_word","opts","auth","npmRequestOptions","rejectUnauthorized","settings","strictSSL","headers","request","prepareMessage","statusCode","response","status_code","content","content_raw","scriptResult","waitTime","Math","pow","er","setTimeout","attachments","resultMsg","replay","Messages","findOneById","findByType","disableByUserId","multi","_Base","findByIntegrationId","findByIntegrationIdAndCreatedBy","creatorId","findOneByIntegrationIdAndHistoryId","integrationId","findByEventName","findFailed","removeByIntegrationId","remove","publish","_integrationPublication","ready","_integrationHistoryPublication","limit","sort","methods","addIncomingIntegration","isString","extend","_createdBy","fields","Roles","addUserRoles","updateIncomingIntegration","currentIntegration","_updatedBy","deleteIncomingIntegration","addOutgoingIntegration","updateOutgoingIntegration","replayOutgoingIntegration","deleteOutgoingIntegration","clearIntegrationHistory","callbackHandler","_callbackHandler","eventType","_wrapperFunction","callbacks","add","priority","LOW","messageObj","sentData","roomId","channelValue","joinChannel","tryDirectByUserIdOnly","isArray","log","red","parseUrls","groupable","icon_url","icon_emoji","attachment","messageReturn"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,WAAWC,YAAX,GAA0B;AACzBC,iBAAgB;AACfC,eAAa;AACZC,UAAO,wCADK;AAEZC,UAAO,aAFK;AAGZC,QAAK;AACJC,aAAS,IADL;AAEJC,kBAAc,IAFV;AAGJC,gBAAY;AAHR;AAHO,GADE;AAUfC,gBAAc;AACbN,UAAO,yCADM;AAEbC,UAAO,cAFM;AAGbC,QAAK;AACJC,aAAS,IADL;AAEJC,kBAAc,KAFV;AAGJC,gBAAY;AAHR;AAHQ,GAVC;AAmBfE,gBAAc;AACbP,UAAO,yCADM;AAEbC,UAAO,cAFM;AAGbC,QAAK;AACJC,aAAS,KADL;AAEJC,kBAAc,KAFV;AAGJC,gBAAY;AAHR;AAHQ,GAnBC;AA4BfG,eAAa;AACZR,UAAO,wCADK;AAEZC,UAAO,aAFK;AAGZC,QAAK;AACJC,aAAS,KADL;AAEJC,kBAAc,KAFV;AAGJC,gBAAY;AAHR;AAHO,GA5BE;AAqCfI,cAAY;AACXT,UAAO,uCADI;AAEXC,UAAO,YAFI;AAGXC,QAAK;AACJC,aAAS,IADL;AAEJC,kBAAc,KAFV;AAGJC,gBAAY;AAHR;AAHM,GArCG;AA8CfK,YAAU;AACTV,UAAO,qCADE;AAETC,UAAO,UAFE;AAGTC,QAAK;AACJC,aAAS,IADL;AAEJC,kBAAc,KAFV;AAGJC,gBAAY;AAHR;AAHI,GA9CK;AAuDfM,eAAa;AACZX,UAAO,wCADK;AAEZC,UAAO,aAFK;AAGZC,QAAK;AACJC,aAAS,KADL;AAEJC,kBAAc,KAFV;AAGJC,gBAAY;AAHR;AAHO;AAvDE;AADS,CAA1B,0H;;;;;;;;;;;ACAA,yB,CACA,qBAEAO,SAAS,IAAIC,MAAJ,CAAW,cAAX,EAA2B;AACnCC,WAAU;AACTC,YAAU,kBADD;AAETC,YAAU;AAFD;AADyB,CAA3B,CAAT,yH;;;;;;;;;;;;;;;;;ACHA,kBACA,IAAMC,iBAAiB,CAAC,qBAAD,EAAwB,oBAAxB,EAA8C,qBAA9C,CAAvB;AACA,IAAMC,oBAAoB,CAAC,GAAD,EAAM,GAAN,CAA1B;;AAEA,SAASC,qBAAT,CAA+BC,WAA/B,EAA4C;AAC3C,KAAI,CAACA,YAAYC,KAAb,IAAsB,CAACC,MAAMC,IAAN,CAAWH,YAAYC,KAAvB,EAA8BG,MAA9B,CAAvB,IAAgEJ,YAAYC,KAAZ,CAAkBI,IAAlB,OAA6B,EAA7F,IAAmG,CAAC7B,WAAWC,YAAX,CAAwBC,cAAxB,CAAuCsB,YAAYC,KAAnD,CAAxG,EAAmK;AAClK,QAAM,IAAIK,OAAOC,KAAX,CAAiB,0BAAjB,EAA6C,oBAA7C,EAAmE;AAAE,eAAU;AAAZ,GAAnE,CAAN;AACA;;AAED,KAAI,CAACP,YAAYQ,QAAb,IAAyB,CAACN,MAAMC,IAAN,CAAWH,YAAYQ,QAAvB,EAAiCJ,MAAjC,CAA1B,IAAsEJ,YAAYQ,QAAZ,CAAqBH,IAArB,OAAgC,EAA1G,EAA8G;AAC7G,QAAM,IAAIC,OAAOC,KAAX,CAAiB,wBAAjB,EAA2C,kBAA3C,EAA+D;AAAE,eAAU;AAAZ,GAA/D,CAAN;AACA;;AAED,KAAI/B,WAAWC,YAAX,CAAwBC,cAAxB,CAAuCsB,YAAYC,KAAnD,EAA0DnB,GAA1D,CAA8DG,UAA9D,IAA4E,CAACe,YAAYf,UAA7F,EAAyG;AACxG,QAAM,IAAIqB,OAAOC,KAAX,CAAiB,0BAAjB,EAA6C,qBAA7C,EAAoE;AAAE,eAAU;AAAZ,GAApE,CAAN;AACA;;AAED,KAAI,CAACL,MAAMC,IAAN,CAAWH,YAAYS,IAAvB,EAA6B,CAACL,MAAD,CAA7B,CAAL,EAA6C;AAC5C,QAAM,IAAIE,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAE,eAAU;AAAZ,GAAvD,CAAN;AACA;;AAED,sBAA2BP,YAAYS,IAAZ,CAAiBC,OAAjB,EAA3B,kHAAuD;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;;AAAA,MAA3CC,KAA2C;AAAA,MAApCC,GAAoC;;AACtD,MAAIA,IAAIP,IAAJ,OAAe,EAAnB,EAAuB;AACtB,UAAOL,YAAYS,IAAZ,CAAiBE,KAAjB,CAAP;AACA;AACD;;AAEDX,aAAYS,IAAZ,GAAmBI,EAAEC,OAAF,CAAUd,YAAYS,IAAtB,EAA4B,CAACM,SAAD,CAA5B,CAAnB;;AAEA,KAAIf,YAAYS,IAAZ,CAAiBO,MAAjB,KAA4B,CAAhC,EAAmC;AAClC,QAAM,IAAIV,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAE,eAAU;AAAZ,GAAvD,CAAN;AACA;AACD;;AAED,SAASU,mCAAT,CAA6CjB,WAA7C,EAA0DkB,MAA1D,EAAkEC,QAAlE,EAA4E;AAC3E,uBAAoBA,QAApB,yHAA8B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,MAArBpC,OAAqB;;AAC7B,MAAIc,eAAeuB,QAAf,CAAwBrC,OAAxB,CAAJ,EAAsC;AACrC,OAAIA,YAAY,qBAAhB,EAAuC,CACtC;AACA,IAFD,MAEO,IAAI,CAACP,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+BJ,MAA/B,EAAuC,qBAAvC,CAAL,EAAoE;AAC1E,UAAM,IAAIZ,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAE,iBAAU;AAAZ,KAA7D,CAAN;AACA;AACD,GAND,MAMO;AACN,OAAIgB,eAAJ;AACA,OAAMC,cAAczC,QAAQ,CAAR,CAApB;AACAA,aAAUA,QAAQ0C,MAAR,CAAe,CAAf,CAAV;;AAEA,WAAQD,WAAR;AACC,SAAK,GAAL;AACCD,cAAS/C,WAAWkD,MAAX,CAAkBC,KAAlB,CAAwBC,OAAxB,CAAgC;AACxCC,WAAK,CACJ;AAACC,YAAK/C;AAAN,OADI,EAEJ;AAACgD,aAAMhD;AAAP,OAFI;AADmC,MAAhC,CAAT;AAMA;;AACD,SAAK,GAAL;AACCwC,cAAS/C,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC;AACxCC,WAAK,CACJ;AAACC,YAAK/C;AAAN,OADI,EAEJ;AAACyB,iBAAUzB;AAAX,OAFI;AADmC,MAAhC,CAAT;AAMA;AAhBF;;AAmBA,OAAI,CAACwC,MAAL,EAAa;AACZ,UAAM,IAAIjB,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAE,iBAAU;AAAZ,KAAvD,CAAN;AACA;;AAED,OAAIgB,OAAOU,SAAP,IAAoB,CAACzD,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+BJ,MAA/B,EAAuC,qBAAvC,CAArB,IAAsF1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+BJ,MAA/B,EAAuC,yBAAvC,CAAtF,IAA2J,CAACK,OAAOU,SAAP,CAAiBb,QAAjB,CAA0Bd,OAAO4B,IAAP,GAAc1B,QAAxC,CAAhK,EAAmN;AAClN,UAAM,IAAIF,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAE,iBAAU;AAAZ,KAA7D,CAAN;AACA;AACD;AACD;AACD;;AAED,SAAS4B,uBAAT,CAAiCnC,WAAjC,EAA8C;AAC7C,KAAI,CAACA,YAAYoC,gBAAjB,EAAmC;AAClC;AACA,EAH4C,CAK7C;;;AACApC,aAAYqC,UAAZ,GAAyBrC,YAAYqC,UAAZ,IAA0BC,SAAStC,YAAYqC,UAArB,IAAmC,CAA7D,GAAiEC,SAAStC,YAAYqC,UAArB,CAAjE,GAAoG,CAA7H;AACArC,aAAYuC,UAAZ,GAAyB,CAACvC,YAAYuC,UAAb,IAA2B,CAACvC,YAAYuC,UAAZ,CAAuBlC,IAAvB,EAA5B,GAA4D,eAA5D,GAA8EL,YAAYuC,UAAZ,CAAuBC,WAAvB,EAAvG;AACA;;AAEDhE,WAAWC,YAAX,CAAwBgE,gBAAxB;AAA2C,UAASC,iBAAT,CAA2B1C,WAA3B,EAAwCkB,MAAxC,EAAgD;AAC1F,MAAIlB,YAAYjB,OAAZ,IAAuBmB,MAAMC,IAAN,CAAWH,YAAYjB,OAAvB,EAAgCqB,MAAhC,CAAvB,IAAkEJ,YAAYjB,OAAZ,CAAoBsB,IAApB,OAA+B,EAArG,EAAyG;AACxG,UAAOL,YAAYjB,OAAnB;AACA,GAHyF,CAK1F;;;AACAgB,wBAAsBC,WAAtB;;AAEA,MAAImB,WAAW,EAAf;;AACA,MAAI3C,WAAWC,YAAX,CAAwBC,cAAxB,CAAuCsB,YAAYC,KAAnD,EAA0DnB,GAA1D,CAA8DC,OAAlE,EAA2E;AAC1E,OAAI,CAACmB,MAAMC,IAAN,CAAWH,YAAYjB,OAAvB,EAAgCqB,MAAhC,CAAL,EAA8C;AAC7C,UAAM,IAAIE,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAE,iBAAU;AAAZ,KAA7D,CAAN;AACA,IAFD,MAEO;AACNY,eAAWN,EAAE8B,GAAF,CAAM3C,YAAYjB,OAAZ,CAAoB6D,KAApB,CAA0B,GAA1B,CAAN,EAAsC,UAAC7D,OAAD;AAAA,YAAa8D,EAAExC,IAAF,CAAOtB,OAAP,CAAb;AAAA,KAAtC,CAAX;;AAEA,0BAAsBoC,QAAtB,yHAAgC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,SAArBpC,OAAqB;;AAC/B,SAAI,CAACe,kBAAkBsB,QAAlB,CAA2BrC,QAAQ,CAAR,CAA3B,CAAD,IAA2C,CAACc,eAAeuB,QAAf,CAAwBrC,QAAQyD,WAAR,EAAxB,CAAhD,EAAgG;AAC/F,YAAM,IAAIlC,OAAOC,KAAX,CAAiB,wCAAjB,EAA2D,oCAA3D,EAAiG;AAAE,mBAAU;AAAZ,OAAjG,CAAN;AACA;AACD;AACD;AACD,GAZD,MAYO,IAAI,CAAC/B,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+BJ,MAA/B,EAAuC,qBAAvC,CAAL,EAAoE;AAC1E,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,2BAAjB,EAA8C,uDAA9C,EAAuG;AAAE,gBAAU;AAAZ,IAAvG,CAAN;AACA;;AAED,MAAI/B,WAAWC,YAAX,CAAwBC,cAAxB,CAAuCsB,YAAYC,KAAnD,EAA0DnB,GAA1D,CAA8DE,YAA9D,IAA8EgB,YAAYhB,YAA9F,EAA4G;AAC3G,OAAI,CAACkB,MAAMC,IAAN,CAAWH,YAAYhB,YAAvB,EAAqC,CAACoB,MAAD,CAArC,CAAL,EAAqD;AACpD,UAAM,IAAIE,OAAOC,KAAX,CAAiB,4BAAjB,EAA+C,sBAA/C,EAAuE;AAAE,iBAAU;AAAZ,KAAvE,CAAN;AACA;;AAED,yBAAmCP,YAAYhB,YAA/C,yHAA6D;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;;AAAA,QAAjD2B,KAAiD;AAAA,QAA1CmC,WAA0C;;AAC5D,QAAIA,YAAYzC,IAAZ,OAAuB,EAA3B,EAA+B;AAC9B,YAAOL,YAAYhB,YAAZ,CAAyB2B,KAAzB,CAAP;AACA;AACD;;AAEDX,eAAYhB,YAAZ,GAA2B6B,EAAEC,OAAF,CAAUd,YAAYhB,YAAtB,EAAoC,CAAC+B,SAAD,CAApC,CAA3B;AACA,GAZD,MAYO;AACN,UAAOf,YAAYhB,YAAnB;AACA;;AAED,MAAIgB,YAAY+C,aAAZ,KAA8B,IAA9B,IAAsC/C,YAAYgD,MAAlD,IAA4DhD,YAAYgD,MAAZ,CAAmB3C,IAAnB,OAA8B,EAA9F,EAAkG;AACjG,OAAI;AACH,QAAM4C,eAAeC,OAAOC,MAAP,CAAcC,MAAMC,iBAAN,CAAwB;AAAEC,cAAS;AAAX,KAAxB,CAAd,EAA2D;AAAEC,cAAS,IAAX;AAAiBC,eAAU,IAA3B;AAAiCC,eAAU;AAA3C,KAA3D,CAArB;AAEAzD,gBAAY0D,cAAZ,GAA6BN,MAAMO,OAAN,CAAc3D,YAAYgD,MAA1B,EAAkCC,YAAlC,EAAgDW,IAA7E;AACA5D,gBAAY6D,WAAZ,GAA0B9C,SAA1B;AACA,IALD,CAKE,OAAO+C,CAAP,EAAU;AACX9D,gBAAY0D,cAAZ,GAA6B3C,SAA7B;AACAf,gBAAY6D,WAAZ,GAA0BhD,EAAEkD,IAAF,CAAOD,CAAP,EAAU,MAAV,EAAkB,SAAlB,EAA6B,OAA7B,CAA1B;AACA;AACD;;AAED7C,sCAAoCjB,WAApC,EAAiDkB,MAAjD,EAAyDC,QAAzD;;AACAgB,0BAAwBnC,WAAxB;;AAEA,MAAMkC,OAAO1D,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC;AAAEpB,aAAUR,YAAYQ;AAAxB,GAAhC,CAAb;;AAEA,MAAI,CAAC0B,IAAL,EAAW;AACV,SAAM,IAAI5B,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAE,gBAAU;AAAZ,IAAvD,CAAN;AACA;;AAEDP,cAAYgE,IAAZ,GAAmB,kBAAnB;AACAhE,cAAYkB,MAAZ,GAAqBgB,KAAKJ,GAA1B;AACA9B,cAAYjB,OAAZ,GAAsBoC,QAAtB;AAEA,SAAOnB,WAAP;AACA;;AAnED,QAAoD0C,iBAApD;AAAA,4H;;;;;;;;;;;;;;;;;;;;;ACvFA,IAAIuB,eAAJ;AAAWC,OAAOC,MAAP,CAAc,QAAd,EAAuB;AAAC,YAAU,UAASC,CAAT,EAAW;AAACH,WAAOG,CAAP;AAAS;AAAhC,CAAvB,EAAyD,CAAzD;AAGX5F,WAAWC,YAAX,CAAwB4F,cAAxB,GAAyC;AACxC,yCAAc;AAAA;;AAAA;AACb,OAAKC,EAAL,GAAUC,IAAIC,OAAJ,CAAY,IAAZ,CAAV;AACA,OAAKC,cAAL,GAAsB,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,CAAtB;AACA,OAAKC,eAAL,GAAuB,EAAvB;AACA,OAAKC,QAAL,GAAgB,EAAhB;AAEAnG,aAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BC,IAA/B,CAAoC;AAACb,SAAM;AAAP,GAApC,EAAgEc,OAAhE,CAAwE;AACvEC,UAAO,UAACxD,MAAD,EAAY;AAClB,UAAKyD,cAAL,CAAoBzD,MAApB;AACA,IAHsE;AAKvE0D,YAAS,UAAC1D,MAAD,EAAY;AACpB,UAAK2D,iBAAL,CAAuB3D,MAAvB;;AACA,UAAKyD,cAAL,CAAoBzD,MAApB;AACA,IARsE;AAUvE4D,YAAS,UAAC5D,MAAD,EAAY;AACpB,UAAK2D,iBAAL,CAAuB3D,MAAvB;AACA;AAZsE,GAAxE;AAcA;;AArBuC,wCAuBxCyD,cAvBwC;AAAA,0BAuBzBzD,MAvByB,EAuBjB;AACtB/B,UAAOI,QAAP,CAAgBwF,KAAhB,6BAAgD7D,OAAOQ,IAAvD,sBAA4ER,OAAOtB,KAAnF;AACA,OAAIkB,iBAAJ;;AACA,OAAII,OAAOtB,KAAP,IAAgB,CAACzB,WAAWC,YAAX,CAAwBC,cAAxB,CAAuC6C,OAAOtB,KAA9C,EAAqDnB,GAArD,CAAyDC,OAA9E,EAAuF;AACtFS,WAAOI,QAAP,CAAgBwF,KAAhB,CAAsB,0CAAtB,EADsF,CAEtF;;AACAjE,eAAW,CAAC,OAAD,CAAX;AACA,IAJD,MAIO,IAAIN,EAAEwE,OAAF,CAAU9D,OAAOxC,OAAjB,CAAJ,EAA+B;AACrCS,WAAOI,QAAP,CAAgBwF,KAAhB,CAAsB,2FAAtB;AACAjE,eAAW,CAAC,qBAAD,CAAX;AACA,IAHM,MAGA;AACN3B,WAAOI,QAAP,CAAgBwF,KAAhB,CAAsB,6CAAtB,EAAqE7D,OAAOxC,OAA5E;AACAoC,eAAW,GAAGmE,MAAH,CAAU/D,OAAOxC,OAAjB,CAAX;AACA;;AAED,wBAAsBoC,QAAtB,kHAAgC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,QAArBpC,OAAqB;;AAC/B,QAAI,CAAC,KAAK4F,QAAL,CAAc5F,OAAd,CAAL,EAA6B;AAC5B,UAAK4F,QAAL,CAAc5F,OAAd,IAAyB,EAAzB;AACA;;AAED,SAAK4F,QAAL,CAAc5F,OAAd,EAAuBwC,OAAOO,GAA9B,IAAqCP,MAArC;AACA;AACD;;AA7CuC;AAAA;;AAAA,wCA+CxC2D,iBA/CwC;AAAA,6BA+CtB3D,MA/CsB,EA+Cd;AACzB,yBAAsB2B,OAAOqC,MAAP,CAAc,KAAKZ,QAAnB,CAAtB,yHAAoD;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,QAAzCa,OAAyC;AACnD,WAAOA,QAAQjE,OAAOO,GAAf,CAAP;AACA;AACD;;AAnDuC;AAAA;;AAAA,wCAqDxC2D,aArDwC;AAAA,gCAqDkL;AAAA,OAA1MC,SAA0M,SAA1MA,SAA0M;AAAA,OAA/LC,IAA+L,SAA/LA,IAA+L;AAAA,OAAzL3F,WAAyL,SAAzLA,WAAyL;AAAA,OAA5KC,KAA4K,SAA5KA,KAA4K;AAAA,OAArK2F,IAAqK,SAArKA,IAAqK;AAAA,OAA/J9C,WAA+J,SAA/JA,WAA+J;AAAA,OAAlJ+C,gBAAkJ,SAAlJA,gBAAkJ;AAAA,OAAhIC,kBAAgI,SAAhIA,kBAAgI;AAAA,OAA5GC,kBAA4G,SAA5GA,kBAA4G;AAAA,OAAxFC,aAAwF,SAAxFA,aAAwF;AAAA,OAAzEC,QAAyE,SAAzEA,QAAyE;AAAA,OAA/DrF,GAA+D,SAA/DA,GAA+D;AAAA,OAA1DsF,YAA0D,SAA1DA,YAA0D;AAAA,OAA5CC,SAA4C,SAA5CA,SAA4C;AAAA,OAAjCC,UAAiC,SAAjCA,UAAiC;AAAA,OAArBC,KAAqB,SAArBA,KAAqB;AAAA,OAAdC,UAAc,SAAdA,UAAc;AACzN,OAAMC,UAAU;AACfvC,UAAM,kBADS;AAEf2B;AAFe,IAAhB,CADyN,CAMzN;;AACA,OAAI3F,WAAJ,EAAiB;AAChBuG,YAAQvG,WAAR,GAAsBA,WAAtB;AACA,IATwN,CAWzN;;;AACA,OAAIC,KAAJ,EAAW;AACVsG,YAAQtG,KAAR,GAAgBA,KAAhB;AACA;;AAED,OAAI2F,IAAJ,EAAU;AACTW,YAAQX,IAAR,GAAeA,IAAf;;AAEA,QAAIA,KAAK1D,IAAT,EAAe;AACdqE,aAAQX,IAAR,CAAa1D,IAAb,GAAoBrB,EAAE2F,IAAF,CAAOZ,KAAK1D,IAAZ,EAAkB,CAAC,MAAD,EAAS,OAAT,EAAkB,UAAlB,CAAlB,CAApB;AACA;;AAED,QAAI0D,KAAKa,IAAT,EAAe;AACdF,aAAQX,IAAR,CAAaa,IAAb,GAAoB5F,EAAE2F,IAAF,CAAOZ,KAAKa,IAAZ,EAAkB,CAAC,MAAD,EAAS,OAAT,EAAkB,WAAlB,CAAlB,CAApB;AACAF,aAAQX,IAAR,CAAaa,IAAb,CAAkBxE,SAAlB,GAA8B,CAAC,qDAAD,CAA9B;AACA;AACD;;AAED,OAAIa,WAAJ,EAAiB;AAChByD,YAAQzD,WAAR,GAAsBA,WAAtB;AACA;;AAED,OAAI,OAAO+C,gBAAP,KAA4B,WAAhC,EAA6C;AAC5CU,YAAQV,gBAAR,GAA2BA,gBAA3B;AACA;;AAED,OAAIC,kBAAJ,EAAwB;AACvBS,YAAQT,kBAAR,GAA6BA,kBAA7B;AACA;;AAED,OAAIC,kBAAJ,EAAwB;AACvBQ,YAAQR,kBAAR,GAA6BA,kBAA7B;AACA;;AAED,OAAIC,aAAJ,EAAmB;AAClBO,YAAQP,aAAR,GAAwBA,aAAxB;AACA;;AAED,OAAI,OAAOC,QAAP,KAAoB,WAAxB,EAAqC;AACpCM,YAAQN,QAAR,GAAmBA,QAAnB;AACA;;AAED,OAAIrF,GAAJ,EAAS;AACR2F,YAAQ3F,GAAR,GAAcA,GAAd;AACA;;AAED,OAAI,OAAOsF,YAAP,KAAwB,WAA5B,EAAyC;AACxCK,YAAQL,YAAR,GAAuBA,YAAvB;AACA;;AAED,OAAIC,SAAJ,EAAe;AACdI,YAAQJ,SAAR,GAAoBA,SAApB;AACA;;AAED,OAAI,OAAOC,UAAP,KAAsB,WAA1B,EAAuC;AACtCG,YAAQH,UAAR,GAAqBA,UAArB;AACA;;AAED,OAAI,OAAOC,KAAP,KAAiB,WAArB,EAAkC;AACjCE,YAAQF,KAAR,GAAgBA,KAAhB;AACA;;AAED,OAAI,OAAOC,UAAP,KAAsB,WAA1B,EAAuC;AACtCC,YAAQD,UAAR,GAAqBA,UAArB;AACA;;AAED,OAAIZ,SAAJ,EAAe;AACdlH,eAAWkD,MAAX,CAAkBgF,kBAAlB,CAAqCC,MAArC,CAA4C;AAAE7E,UAAK4D;AAAP,KAA5C,EAAgE;AAAEkB,WAAML;AAAR,KAAhE;AACA,WAAOb,SAAP;AACA,IAHD,MAGO;AACNa,YAAQM,UAAR,GAAqB,IAAIC,IAAJ,EAArB;AACA,WAAOtI,WAAWkD,MAAX,CAAkBgF,kBAAlB,CAAqCK,MAArC,CAA4C7D,OAAOC,MAAP,CAAc;AAAErB,UAAKkF,OAAOC,EAAP;AAAP,KAAd,EAAoCV,OAApC,CAA5C,CAAP;AACA;AACD;;AAzIuC;AAAA,MA2IxC;;;AA3IwC,wCA4IxC5H,WA5IwC;AAAA,8BA4IqB;AAAA,OAA/C6G,OAA+C,SAA/CA,OAA+C;AAAA,8BAAtC0B,QAAsC;AAAA,OAAtCA,QAAsC,kCAA3B,EAA2B;AAAA,OAAvBT,IAAuB,SAAvBA,IAAuB;AAAA,OAAjBU,OAAiB,SAAjBA,OAAiB;AAAA,OAARvB,IAAQ,SAARA,IAAQ;AAC5D,OAAI1D,aAAJ,CAD4D,CAE5D;;AACA,OAAIsD,QAAQ4B,eAAZ,EAA6B;AAC5BlF,WAAO1D,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBqF,iBAAxB,CAA0CzB,KAAK0B,SAA/C,CAAP;AACA,IAL2D,CAO5D;AACA;;;AACA,OAAI,CAACpF,IAAL,EAAW;AACVA,WAAO1D,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBqF,iBAAxB,CAA0C7B,QAAQhF,QAAlD,CAAP;AACA;;AAED,OAAI+G,gBAAJ;;AACA,OAAIL,YAAY1B,QAAQvG,UAAxB,EAAoC;AACnCsI,cAAU/I,WAAWgJ,iCAAX,CAA6C;AAAEC,oBAAevF,KAAKJ,GAAtB;AAA2BoF,eAAUA,YAAY1B,QAAQvG,UAAzD;AAAqEyI,mBAAc;AAAnF,KAA7C,KAA4IjB,IAAtJ;AACA,IAFD,MAEO;AACNc,cAAUd,IAAV;AACA,IAlB2D,CAoB5D;;;AACA,OAAI,CAACc,OAAL,EAAc;AACb/H,WAAOI,QAAP,CAAgB+H,IAAhB,wBAAyCnC,QAAQzD,IAAjD;AACA;AACA;;AAEDvC,UAAOI,QAAP,CAAgBwF,KAAhB,uBAA0CI,QAAQzD,IAAlD,mBAAoEwF,QAAQxF,IAA5E,wBAAmGwF,QAAQK,CAA3G;AAEAT,WAAQU,GAAR,GAAc;AAAEC,OAAGtC,QAAQ1D;AAAb,IAAd;AAEA,OAAMiG,gBAAgB;AACrBC,WAAOxC,QAAQwC,KADM;AAErBC,YAAQzC,QAAQyC,MAFK;AAGrBC,WAAO1C,QAAQ0C;AAHM,IAAtB;;AAMA,OAAIX,QAAQK,CAAR,KAAc,GAAlB,EAAuB;AACtBT,YAAQpI,OAAR,GAAkB,MAAMwI,QAAQzF,GAAhC;AACA,IAFD,MAEO;AACNqF,YAAQpI,OAAR,GAAkB,MAAMwI,QAAQzF,GAAhC;AACA;;AAEDqF,aAAUgB,sBAAsBhB,OAAtB,EAA+BjF,IAA/B,EAAqC6F,aAArC,CAAV;AACA,UAAOZ,OAAP;AACA;;AAxLuC;AAAA;;AAAA,wCA0LxCiB,oBA1LwC;AAAA,gCA0LnBpI,WA1LmB,EA0LN;AACjC,OAAMqI,iBAAiB,KAAK3D,eAAL,CAAqB1E,YAAY8B,GAAjC,CAAvB;;AACA,OAAIuG,kBAAkB,CAACA,eAAeC,UAAhB,KAA+B,CAACtI,YAAYsI,UAAlE,EAA8E;AAC7E,WAAOD,eAAerF,MAAtB;AACA;;AAED,OAAMA,SAAShD,YAAY0D,cAA3B;AACA,OAAM6E,QAAQ,EAAd;AACA,OAAMC,UAAU;AACf3H,QADe;AACZgC,QADY;AACT4F,oBADS;AACAxE,kBADA;AAEfyE,WAAO;AACNC,UAAK,UAACC,GAAD,EAAMC,GAAN;AAAA,aAAcN,MAAMK,GAAN,IAAaC,GAA3B;AAAA,MADC;AAENC,UAAK,UAACF,GAAD;AAAA,aAASL,MAAMK,GAAN,CAAT;AAAA;AAFC,KAFQ;AAMfG,UAAM,UAACC,MAAD,EAASpI,GAAT,EAAcqI,OAAd,EAA0B;AAC/B,SAAI;AACH,aAAO;AACNC,eAAQH,KAAKI,IAAL,CAAUH,MAAV,EAAkBpI,GAAlB,EAAuBqI,OAAvB;AADF,OAAP;AAGA,MAJD,CAIE,OAAO5C,KAAP,EAAc;AACf,aAAO;AAAEA;AAAF,OAAP;AACA;AACD;AAdc,IAAhB;AAiBA,OAAI+C,iBAAJ;;AACA,OAAI;AACH5J,WAAOI,QAAP,CAAgByJ,IAAhB,CAAqB,iCAArB,EAAwDrJ,YAAY+B,IAApE;AACAvC,WAAOI,QAAP,CAAgBwF,KAAhB,CAAsBpC,MAAtB;AAEAoG,eAAW,KAAK9E,EAAL,CAAQgF,YAAR,CAAqBtG,MAArB,EAA6B,WAA7B,CAAX;AAEAoG,aAASG,eAAT,CAAyBf,OAAzB;;AAEA,QAAIA,QAAQgB,MAAZ,EAAoB;AACnB,UAAK9E,eAAL,CAAqB1E,YAAY8B,GAAjC,IAAwC;AACvCkB,cAAQ,IAAIwF,QAAQgB,MAAZ,EAD+B;AAEvCjB,kBAFuC;AAGvCD,kBAAYtI,YAAYsI;AAHe,MAAxC;AAMA,YAAO,KAAK5D,eAAL,CAAqB1E,YAAY8B,GAAjC,EAAsCkB,MAA7C;AACA;AACD,IAjBD,CAiBE,OAAOc,CAAP,EAAU;AACXtE,WAAOI,QAAP,CAAgByG,KAAhB,yCAA4DrG,YAAY+B,IAAxE;AACAvC,WAAOI,QAAP,CAAgByG,KAAhB,CAAsBrD,OAAOyG,OAAP,CAAe,KAAf,EAAsB,IAAtB,CAAtB;AACAjK,WAAOI,QAAP,CAAgByG,KAAhB,CAAsB,cAAtB;AACA7G,WAAOI,QAAP,CAAgByG,KAAhB,CAAsBvC,EAAE4F,KAAF,CAAQD,OAAR,CAAgB,KAAhB,EAAuB,IAAvB,CAAtB;AACA,UAAM,IAAInJ,OAAOC,KAAX,CAAiB,yBAAjB,CAAN;AACA;;AAED,OAAI,CAACiI,QAAQgB,MAAb,EAAqB;AACpBhK,WAAOI,QAAP,CAAgByG,KAAhB,sCAAuDrG,YAAY+B,IAAnE;AACA,UAAM,IAAIzB,OAAOC,KAAX,CAAiB,wBAAjB,CAAN;AACA;AACD;;AAjPuC;AAAA;;AAAA,wCAmPxCoJ,kBAnPwC;AAAA,8BAmPrB3J,WAnPqB,EAmPRgJ,MAnPQ,EAmPA;AACvC,OAAIhJ,YAAY+C,aAAZ,KAA8B,IAA9B,IAAsC,CAAC/C,YAAY0D,cAAnD,IAAqE1D,YAAY0D,cAAZ,CAA2BrD,IAA3B,OAAsC,EAA/G,EAAmH;AAClH,WAAO,KAAP;AACA;;AAED,OAAI2C,eAAJ;;AACA,OAAI;AACHA,aAAS,KAAKoF,oBAAL,CAA0BpI,WAA1B,CAAT;AACA,IAFD,CAEE,OAAO8D,CAAP,EAAU;AACX,WAAO,KAAP;AACA;;AAED,UAAO,OAAOd,OAAOgG,MAAP,CAAP,KAA0B,WAAjC;AACA;;AAhQuC;AAAA;;AAAA,wCAkQxCY,aAlQwC;AAAA,yBAkQ1B5J,WAlQ0B,EAkQbgJ,MAlQa,EAkQLa,MAlQK,EAkQGnE,SAlQH,EAkQc;AAAA;;AACrD,OAAI1C,eAAJ;;AACA,OAAI;AACHA,aAAS,KAAKoF,oBAAL,CAA0BpI,WAA1B,CAAT;AACA,IAFD,CAEE,OAAO8D,CAAP,EAAU;AACX,SAAK2B,aAAL,CAAmB;AAAEC,yBAAF;AAAaC,WAAM,+BAAnB;AAAoDU,YAAO,IAA3D;AAAiEC,iBAAYxC;AAA7E,KAAnB;AACA;AACA;;AAED,OAAI,CAACd,OAAOgG,MAAP,CAAL,EAAqB;AACpBxJ,WAAOI,QAAP,CAAgByG,KAAhB,eAAiC2C,MAAjC,yCAAyEhJ,YAAY+B,IAArF;AACA,SAAK0D,aAAL,CAAmB;AAAEC,yBAAF;AAAaC,yCAAkCqD;AAA/C,KAAnB;AACA;AACA;;AAED,OAAI;AAAA;AACH,SAAMT,QAAQ,OAAK7D,eAAL,CAAqB1E,YAAY8B,GAAjC,EAAsCyG,KAApD;AACA,SAAMC,UAAU;AACf3H,UADe;AACZgC,UADY;AACT4F,sBADS;AACAxE,oBADA;AAEfyE,aAAO;AACNC,YAAK,UAACC,GAAD,EAAMC,GAAN;AAAA,eAAcN,MAAMK,GAAN,IAAaC,GAA3B;AAAA,QADC;AAENC,YAAK,UAACF,GAAD;AAAA,eAASL,MAAMK,GAAN,CAAT;AAAA;AAFC,OAFQ;AAMfG,YAAM,UAACC,MAAD,EAASpI,GAAT,EAAcqI,OAAd,EAA0B;AAC/B,WAAI;AACH,eAAO;AACNC,iBAAQH,KAAKI,IAAL,CAAUH,MAAV,EAAkBpI,GAAlB,EAAuBqI,OAAvB;AADF,SAAP;AAGA,QAJD,CAIE,OAAO5C,KAAP,EAAc;AACf,eAAO;AAAEA;AAAF,SAAP;AACA;AACD,OAdc;AAefrD,oBAfe;AAgBfgG,oBAhBe;AAiBfa;AAjBe,MAAhB;;AAoBA,YAAKpE,aAAL,CAAmB;AAAEC,0BAAF;AAAaC,+CAAuCqD;AAApD,MAAnB;;AACA,SAAME,SAAS,OAAK5E,EAAL,CAAQiF,eAAR,CAAwB,wBAAxB,EAAkDf,OAAlD,EAA2D;AAAEsB,eAAS;AAAX,MAA3D,CAAf;;AAEAtK,YAAOI,QAAP,CAAgBwF,KAAhB,sBAAwC4D,MAAxC,uCAA8EhJ,YAAY+B,IAA1F;AACAvC,YAAOI,QAAP,CAAgBwF,KAAhB,CAAsB8D,MAAtB;AAEA;AAAA,SAAOA;AAAP;AA5BG;;AAAA;AA6BH,IA7BD,CA6BE,OAAOpF,CAAP,EAAU;AACX,SAAK2B,aAAL,CAAmB;AAAEC,yBAAF;AAAaC,6CAAsCqD,MAAnD;AAA6D3C,YAAO,IAApE;AAA0EC,iBAAYxC,EAAE4F,KAAF,CAAQD,OAAR,CAAgB,KAAhB,EAAuB,IAAvB;AAAtF,KAAnB;AACAjK,WAAOI,QAAP,CAAgByG,KAAhB,8CAAiErG,YAAY+B,IAA7E;AACAvC,WAAOI,QAAP,CAAgBwF,KAAhB,CAAsBpF,YAAY0D,cAAZ,CAA2B+F,OAA3B,CAAmC,KAAnC,EAA0C,IAA1C,CAAtB,EAHW,CAG6D;;AACxEjK,WAAOI,QAAP,CAAgByG,KAAhB,CAAsB,QAAtB;AACA7G,WAAOI,QAAP,CAAgByG,KAAhB,CAAsBvC,EAAE4F,KAAF,CAAQD,OAAR,CAAgB,KAAhB,EAAuB,IAAvB,CAAtB;AACA;AACA;AACD;;AAtTuC;AAAA;;AAAA,wCAwTxCM,0BAxTwC;AAAA,wCAwTX;AAC5B,OAAMC,YAAY;AACjB/J,WAAOgK,UAAU,CAAV;AADU,IAAlB;;AAIA,WAAQD,UAAU/J,KAAlB;AACC,SAAK,aAAL;AACC,SAAIgK,UAAUjJ,MAAV,IAAoB,CAAxB,EAA2B;AAC1BgJ,gBAAU7C,OAAV,GAAoB8C,UAAU,CAAV,CAApB;AACAD,gBAAUvD,IAAV,GAAiBwD,UAAU,CAAV,CAAjB;AACA;;AACD;;AACD,SAAK,cAAL;AACC,SAAIA,UAAUjJ,MAAV,IAAoB,CAAxB,EAA2B;AAC1B,UAAMkJ,SAASD,UAAU,CAAV,CAAf;AACAD,gBAAU9H,IAAV,GAAiBgI,OAAOhI,IAAxB;AACA8H,gBAAUvD,IAAV,GAAiByD,OAAOzD,IAAxB;AACAuD,gBAAU7C,OAAV,GAAoB+C,OAAO/C,OAA3B;AACA;;AACD;;AACD,SAAK,cAAL;AACC,SAAI8C,UAAUjJ,MAAV,IAAoB,CAAxB,EAA2B;AAC1BgJ,gBAAUvD,IAAV,GAAiBwD,UAAU,CAAV,CAAjB;AACAD,gBAAU9H,IAAV,GAAiB+H,UAAU,CAAV,CAAjB;AACA;;AACD;;AACD,SAAK,aAAL;AACC,SAAIA,UAAUjJ,MAAV,IAAoB,CAAxB,EAA2B;AAC1BgJ,gBAAUG,KAAV,GAAkBF,UAAU,CAAV,CAAlB;AACAD,gBAAUvD,IAAV,GAAiBwD,UAAU,CAAV,CAAjB;AACA;;AACD;;AACD,SAAK,YAAL;AACA,SAAK,UAAL;AACC,SAAIA,UAAUjJ,MAAV,IAAoB,CAAxB,EAA2B;AAC1BgJ,gBAAU9H,IAAV,GAAiB+H,UAAU,CAAV,CAAjB;AACAD,gBAAUvD,IAAV,GAAiBwD,UAAU,CAAV,CAAjB;AACA;;AACD;;AACD,SAAK,aAAL;AACC,SAAIA,UAAUjJ,MAAV,IAAoB,CAAxB,EAA2B;AAC1BgJ,gBAAU9H,IAAV,GAAiB+H,UAAU,CAAV,CAAjB;AACA;;AACD;;AACD;AACCzK,YAAOI,QAAP,CAAgB+H,IAAhB,6CAA+DqC,UAAU/J,KAAzE;AACA+J,eAAU/J,KAAV,GAAkBc,SAAlB;AACA;AA1CF;;AA6CAvB,UAAOI,QAAP,CAAgBwF,KAAhB,6CAAgE4E,UAAU/J,KAA1E,EAAmF+J,SAAnF;AAEA,UAAOA,SAAP;AACA;;AA7WuC;AAAA;;AAAA,wCA+WxCI,kBA/WwC;AAAA,8BA+WrBxE,IA/WqB,SA+WwB;AAAA,OAArC3F,KAAqC,SAArCA,KAAqC;AAAA,OAA9BkH,OAA8B,SAA9BA,OAA8B;AAAA,OAArBV,IAAqB,SAArBA,IAAqB;AAAA,OAAf0D,KAAe,SAAfA,KAAe;AAAA,OAARjI,IAAQ,SAARA,IAAQ;;AAC/D,WAAQjC,KAAR;AACC,SAAK,aAAL;AACC2F,UAAKyE,UAAL,GAAkB5D,KAAK3E,GAAvB;AACA8D,UAAK0E,YAAL,GAAoB7D,KAAK1E,IAAzB;AACA6D,UAAK2E,UAAL,GAAkBpD,QAAQrF,GAA1B;AACA8D,UAAK4E,SAAL,GAAiBrD,QAAQsD,EAAzB;AACA7E,UAAK8E,OAAL,GAAevD,QAAQwD,CAAR,CAAU7I,GAAzB;AACA8D,UAAK0B,SAAL,GAAiBH,QAAQwD,CAAR,CAAUnK,QAA3B;AACAoF,UAAKgF,IAAL,GAAYzD,QAAQ0D,GAApB;;AAEA,SAAI1D,QAAQa,KAAZ,EAAmB;AAClBpC,WAAKoC,KAAL,GAAab,QAAQa,KAArB;AACA;;AAED,SAAIb,QAAQU,GAAZ,EAAiB;AAChBjC,WAAKiC,GAAL,GAAWV,QAAQU,GAAnB;AACA;;AACD;;AACD,SAAK,cAAL;AACCjC,UAAKyE,UAAL,GAAkB5D,KAAK3E,GAAvB;AACA8D,UAAK0E,YAAL,GAAoB7D,KAAK1E,IAAzB;AACA6D,UAAK2E,UAAL,GAAkBpD,QAAQrF,GAA1B;AACA8D,UAAK4E,SAAL,GAAiBrD,QAAQsD,EAAzB;AACA7E,UAAK8E,OAAL,GAAevD,QAAQwD,CAAR,CAAU7I,GAAzB;AACA8D,UAAK0B,SAAL,GAAiBH,QAAQwD,CAAR,CAAUnK,QAA3B;AACAoF,UAAKgF,IAAL,GAAYzD,QAAQ0D,GAApB;AACAjF,UAAK1D,IAAL,GAAYA,IAAZ;AACA0D,UAAKa,IAAL,GAAYA,IAAZ;AACAb,UAAKuB,OAAL,GAAeA,OAAf;;AAEA,SAAIA,QAAQa,KAAZ,EAAmB;AAClBpC,WAAKoC,KAAL,GAAab,QAAQa,KAArB;AACA;;AAED,SAAIb,QAAQU,GAAZ,EAAiB;AAChBjC,WAAKiC,GAAL,GAAWV,QAAQU,GAAnB;AACA;;AACD;;AACD,SAAK,aAAL;AACCjC,UAAKyE,UAAL,GAAkB5D,KAAK3E,GAAvB;AACA8D,UAAK0E,YAAL,GAAoB7D,KAAK1E,IAAzB;AACA6D,UAAK4E,SAAL,GAAiB/D,KAAKgE,EAAtB;AACA7E,UAAK8E,OAAL,GAAeP,MAAMrI,GAArB;AACA8D,UAAK0B,SAAL,GAAiB6C,MAAM3J,QAAvB;AACAoF,UAAKuE,KAAL,GAAaA,KAAb;AACAvE,UAAKa,IAAL,GAAYA,IAAZ;AACA;;AACD,SAAK,cAAL;AACA,SAAK,YAAL;AACA,SAAK,UAAL;AACCb,UAAK4E,SAAL,GAAiB,IAAI1D,IAAJ,EAAjB;AACAlB,UAAKyE,UAAL,GAAkB5D,KAAK3E,GAAvB;AACA8D,UAAK0E,YAAL,GAAoB7D,KAAK1E,IAAzB;AACA6D,UAAK8E,OAAL,GAAexI,KAAKJ,GAApB;AACA8D,UAAK0B,SAAL,GAAiBpF,KAAK1B,QAAtB;AACAoF,UAAK1D,IAAL,GAAYA,IAAZ;AACA0D,UAAKa,IAAL,GAAYA,IAAZ;;AAEA,SAAIvE,KAAK8B,IAAL,KAAc,KAAlB,EAAyB;AACxB4B,WAAKiC,GAAL,GAAW,IAAX;AACA;;AACD;;AACD,SAAK,aAAL;AACCjC,UAAK4E,SAAL,GAAiBtI,KAAK4I,SAAtB;AACAlF,UAAK8E,OAAL,GAAexI,KAAKJ,GAApB;AACA8D,UAAK0B,SAAL,GAAiBpF,KAAK1B,QAAtB;AACAoF,UAAK1D,IAAL,GAAYA,IAAZ;;AAEA,SAAIA,KAAK8B,IAAL,KAAc,KAAlB,EAAyB;AACxB4B,WAAKiC,GAAL,GAAW,IAAX;AACA;;AACD;;AACD;AACC;AAzEF;AA2EA;;AA3buC;AAAA;;AAAA,wCA6bxCkD,eA7bwC;AAAA,6BA6btB;AACjBvL,UAAOI,QAAP,CAAgBwF,KAAhB,CAAsB,kBAAtB,EAA0C6E,UAAU,CAAV,CAA1C;AAEA,OAAMD,YAAY,KAAKD,0BAAL,aAAmCE,SAAnC,CAAlB;AAHiB,OAIThK,KAJS,GAIgB+J,SAJhB,CAIT/J,KAJS;AAAA,OAIFkH,OAJE,GAIgB6C,SAJhB,CAIF7C,OAJE;AAAA,OAIOV,IAJP,GAIgBuD,SAJhB,CAIOvD,IAJP,EAMjB;AACA;AACA;;AACA,OAAI,CAACxG,KAAL,EAAY;AACX;AACA;;AAED,OAAM+K,oBAAoB,EAA1B;AAEAxL,UAAOI,QAAP,CAAgBwF,KAAhB,CAAsB,4CAAtB,EAAoEqB,OAAOA,KAAK3E,GAAZ,GAAkB,OAAtF;;AACA,OAAI2E,IAAJ,EAAU;AACT,YAAQA,KAAKmB,CAAb;AACC,UAAK,GAAL;AACC,UAAMX,KAAKR,KAAK3E,GAAL,CAAS2H,OAAT,CAAiBtC,QAAQwD,CAAR,CAAU7I,GAA3B,EAAgC,EAAhC,CAAX;;AACA,UAAMtB,WAAWK,EAAEC,OAAF,CAAU2F,KAAKxE,SAAf,EAA0BkF,QAAQwD,CAAR,CAAUnK,QAApC,EAA8C,CAA9C,CAAjB;;AAEA,UAAI,KAAKmE,QAAL,CAAc,MAAIsC,EAAlB,CAAJ,EAA2B;AAC1B,6BAAsB/D,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAc,MAAIsC,EAAlB,CAAd,CAAtB,yHAA4D;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAAjDzB,OAAiD;AAC3DwF,0BAAkBC,IAAlB,CAAuBzF,OAAvB;AACA;AACD;;AAED,UAAI,KAAKb,QAAL,CAAcuG,mBAAlB,EAAuC;AACtC,6BAAsBhI,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAcuG,mBAA5B,CAAtB,yHAAwE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAA7D1F,QAA6D;AACvEwF,0BAAkBC,IAAlB,CAAuBzF,QAAvB;AACA;AACD;;AAED,UAAIyB,OAAOzG,QAAP,IAAmB,KAAKmE,QAAL,CAAc,MAAInE,QAAlB,CAAvB,EAAoD;AACnD,6BAAsB0C,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAc,MAAInE,QAAlB,CAAd,CAAtB,yHAAkE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAAvDgF,SAAuD;AACjEwF,0BAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AACD;;AAED,UAAK,GAAL;AACC,UAAI,KAAKb,QAAL,CAAcwG,mBAAlB,EAAuC;AACtC,6BAAsBjI,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAcwG,mBAA5B,CAAtB,yHAAwE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAA7D3F,SAA6D;AACvEwF,0BAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AAED,UAAI,KAAKb,QAAL,CAAc,MAAI8B,KAAK3E,GAAvB,CAAJ,EAAiC;AAChC,6BAAsBoB,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAc,MAAI8B,KAAK3E,GAAvB,CAAd,CAAtB,yHAAkE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAAvD0D,SAAuD;AACjEwF,0BAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AAED,UAAIiB,KAAK3E,GAAL,KAAa2E,KAAK1E,IAAlB,IAA0B,KAAK4C,QAAL,CAAc,MAAI8B,KAAK1E,IAAvB,CAA9B,EAA4D;AAC3D,6BAAsBmB,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAc,MAAI8B,KAAK1E,IAAvB,CAAd,CAAtB,yHAAmE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAAxDyD,SAAwD;AAClEwF,0BAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AACD;;AAED;AACC,UAAI,KAAKb,QAAL,CAAcyG,kBAAlB,EAAsC;AACrC,6BAAsBlI,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAcyG,kBAA5B,CAAtB,yHAAuE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAA5D5F,SAA4D;AACtEwF,0BAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AAED,UAAI,KAAKb,QAAL,CAAc,MAAI8B,KAAK3E,GAAvB,CAAJ,EAAiC;AAChC,8BAAsBoB,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAc,MAAI8B,KAAK3E,GAAvB,CAAd,CAAtB,gIAAkE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAAvD0D,SAAuD;AACjEwF,0BAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AAED,UAAIiB,KAAK3E,GAAL,KAAa2E,KAAK1E,IAAlB,IAA0B,KAAK4C,QAAL,CAAc,MAAI8B,KAAK1E,IAAvB,CAA9B,EAA4D;AAC3D,8BAAsBmB,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAc,MAAI8B,KAAK1E,IAAvB,CAAd,CAAtB,gIAAmE;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAAxDyD,SAAwD;AAClEwF,0BAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AACD;AA9DF;AAgEA,IAjED,MAiEO,IAAI,KAAKb,QAAL,CAAc0G,KAAlB,EAAyB;AAC/B;AACA,2BAAsBnI,OAAOqC,MAAP,CAAc,KAAKZ,QAAL,CAAc0G,KAA5B,CAAtB,gIAA0D;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,SAA/C7F,SAA+C;AACzDwF,uBAAkBC,IAAlB,CAAuBzF,SAAvB;AACA;AACD;;AAEDhG,UAAOI,QAAP,CAAgBwF,KAAhB,YAA+B4F,kBAAkBhK,MAAjD;;AAEA,0BAA+BgK,iBAA/B,gIAAkD;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,QAAvCM,gBAAuC;AACjD9L,WAAOI,QAAP,CAAgBwF,KAAhB,SAA4BkG,iBAAiBvJ,IAA7C,kBAA8DuJ,iBAAiBC,OAA/E,iCAAkHD,iBAAiBrL,KAAnI;;AACA,QAAIqL,iBAAiBC,OAAjB,KAA6B,IAA7B,IAAqCD,iBAAiBrL,KAAjB,KAA2BA,KAApE,EAA2E;AAC1E,UAAKuL,cAAL,CAAoBF,gBAApB,EAAsCtB,SAAtC;AACA;AACD;AACD;;AA7hBuC;AAAA;;AAAA,wCA+hBxCwB,cA/hBwC;AAAA,0BA+hBzBhG,OA/hByB,EA+hBhBwE,SA/hBgB,EA+hBL;AAClC,0BAAkBxE,QAAQ/E,IAA1B,gIAAgC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,QAArBG,GAAqB;AAC/B,SAAK6K,iBAAL,CAAuB7K,GAAvB,EAA4B4E,OAA5B,EAAqCwE,SAArC,EAAgD,CAAhD;AACA;AACD;;AAniBuC;AAAA;;AAAA,wCAqiBxCyB,iBAriBwC;AAAA,6BAqiBtB7K,GAriBsB,EAqiBjB4E,OAriBiB,UAqiB+BkG,YAriB/B,EAqiBwD;AAAA,OAA9DzL,KAA8D,UAA9DA,KAA8D;AAAA,OAAvDkH,OAAuD,UAAvDA,OAAuD;AAAA,OAA9CV,IAA8C,UAA9CA,IAA8C;AAAA,OAAxC0D,KAAwC,UAAxCA,KAAwC;AAAA,OAAjCjI,IAAiC,UAAjCA,IAAiC;;AAAA;;AAAA,OAAXyJ,KAAW,uEAAH,CAAG;AAC/FnM,UAAOI,QAAP,CAAgBwF,KAAhB,mCAAsDI,QAAQzD,IAA9D,UAAuEyD,QAAQ1D,GAA/E;AAEA,OAAI8J,aAAJ,CAH+F,CAI/F;;AACA,OAAIpN,WAAWC,YAAX,CAAwBC,cAAxB,CAAuCuB,KAAvC,EAA8CnB,GAA9C,CAAkDE,YAAtD,EAAoE;AACnE,QAAIwG,QAAQxG,YAAR,IAAwBwG,QAAQxG,YAAR,CAAqBgC,MAArB,GAA8B,CAA1D,EAA6D;AAC5D,4BAA0BwE,QAAQxG,YAAlC,gIAAgD;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,UAArC8D,WAAqC;;AAC/C,UAAI,CAAC0C,QAAQqG,mBAAT,IAAgC1E,QAAQ0D,GAAR,CAAYiB,OAAZ,CAAoBhJ,WAApB,MAAqC,CAAzE,EAA4E;AAC3E8I,cAAO9I,WAAP;AACA;AACA,OAHD,MAGO,IAAI0C,QAAQqG,mBAAR,IAA+B1E,QAAQ0D,GAAR,CAAYzJ,QAAZ,CAAqB0B,WAArB,CAAnC,EAAsE;AAC5E8I,cAAO9I,WAAP;AACA;AACA;AACD,MAT2D,CAW5D;;;AACA,SAAI,CAAC8I,IAAL,EAAW;AACV;AACA;AACD;AACD;;AAED,OAAMlG,YAAY,KAAKD,aAAL,CAAmB;AAAEE,UAAM,2BAAR;AAAqC3F,iBAAawF,OAAlD;AAA2DvF;AAA3D,IAAnB,CAAlB;AAEA,OAAM2F,OAAO;AACZmG,WAAOvG,QAAQuG,KADH;AAEZlE,SAAK;AAFO,IAAb;;AAKA,OAAI+D,IAAJ,EAAU;AACThG,SAAKoG,YAAL,GAAoBJ,IAApB;AACA;;AAED,QAAKxB,kBAAL,CAAwBxE,IAAxB,EAA8B;AAAEJ,oBAAF;AAAWvF,gBAAX;AAAkBkH,oBAAlB;AAA2BV,cAA3B;AAAiC0D,gBAAjC;AAAwCjI;AAAxC,IAA9B;AACA,QAAKuD,aAAL,CAAmB;AAAEC,wBAAF;AAAaC,UAAM,qBAAnB;AAA0CC,cAA1C;AAAgD9C,iBAAa8I;AAA7D,IAAnB;AAEApM,UAAOI,QAAP,CAAgByJ,IAAhB,0CAA2D7D,QAAQzD,IAAnE,uBAAwFnB,GAAxF;AACApB,UAAOI,QAAP,CAAgBwF,KAAhB,CAAsBQ,IAAtB;AAEA,OAAIqG,OAAO;AACVpC,YAAQ,EADE;AAEVb,YAAQ,MAFE;AAGVpI,YAHU;AAIVgF,cAJU;AAKVsG,UAAMnL,SALI;AAMVoL,uBAAmB;AAClBC,yBAAoB,CAAC5N,WAAW6N,QAAX,CAAoBvD,GAApB,CAAwB,gCAAxB,CADH;AAElBwD,gBAAW,CAAC9N,WAAW6N,QAAX,CAAoBvD,GAApB,CAAwB,gCAAxB;AAFM,KANT;AAUVyD,aAAS;AACR,mBAAc;AADN;AAVC,IAAX;;AAeA,OAAI,KAAK5C,kBAAL,CAAwBnE,OAAxB,EAAiC,0BAAjC,CAAJ,EAAkE;AACjEyG,WAAO,KAAKrC,aAAL,CAAmBpE,OAAnB,EAA4B,0BAA5B,EAAwD;AAAEgH,cAASP;AAAX,KAAxD,EAA2EvG,SAA3E,CAAP;AACA;;AAED,QAAKD,aAAL,CAAmB;AAAEC,wBAAF;AAAaC,UAAM,yBAAnB;AAA8CE,sBAAkB;AAAhE,IAAnB;;AAEA,OAAI,CAACoG,IAAL,EAAW;AACV,SAAKxG,aAAL,CAAmB;AAAEC,yBAAF;AAAaC,WAAM,uBAAnB;AAA4CM,eAAU;AAAtD,KAAnB;AACA;AACA;;AAED,OAAIgG,KAAK9E,OAAT,EAAkB;AACjB,QAAMsF,iBAAiB,KAAK9N,WAAL,CAAiB;AAAE6G,qBAAF;AAAWiB,eAAX;AAAiBU,cAAS8E,KAAK9E,OAA/B;AAAwCvB;AAAxC,KAAjB,CAAvB;AACA,SAAKH,aAAL,CAAmB;AAAEC,yBAAF;AAAaC,WAAM,4BAAnB;AAAiDG,yBAAoB2G;AAArE,KAAnB;AACA;;AAED,OAAI,CAACR,KAAKrL,GAAN,IAAa,CAACqL,KAAKjD,MAAvB,EAA+B;AAC9B,SAAKvD,aAAL,CAAmB;AAAEC,yBAAF;AAAaC,WAAM,gCAAnB;AAAqDM,eAAU;AAA/D,KAAnB;AACA;AACA;;AAED,QAAKR,aAAL,CAAmB;AAAEC,wBAAF;AAAaC,UAAM,eAAnB;AAAoC/E,SAAKqL,KAAKrL,GAA9C;AAAmDsF,kBAAc+F,KAAKrG;AAAtE,IAAnB;AACAmD,QAAKI,IAAL,CAAU8C,KAAKjD,MAAf,EAAuBiD,KAAKrL,GAA5B,EAAiCqL,IAAjC,EAAuC,UAAC5F,KAAD,EAAQ6C,MAAR,EAAmB;AACzD,QAAI,CAACA,MAAL,EAAa;AACZ1J,YAAOI,QAAP,CAAgB+H,IAAhB,iCAAmDnC,QAAQzD,IAA3D,YAAsEnB,GAAtE;AACA,KAFD,MAEO;AACNpB,YAAOI,QAAP,CAAgByJ,IAAhB,sCAAwD7D,QAAQzD,IAAhE,YAA2EnB,GAA3E,YAAqFsI,OAAOwD,UAA5F;AACA;;AAED,WAAKjH,aAAL,CAAmB;AAAEC,yBAAF;AAAaC,WAAM,iBAAnB;AAAsCQ,gBAAWE,KAAjD;AAAwDD,iBAAY8C;AAApE,KAAnB;;AAEA,QAAI,OAAKS,kBAAL,CAAwBnE,OAAxB,EAAiC,2BAAjC,CAAJ,EAAmE;AAClE,SAAMgD,UAAU;AACfgE,eAASP,IADM;AAEfU,gBAAU;AACTtG,mBADS;AAETuG,oBAAa1D,SAASA,OAAOwD,UAAhB,GAA6B3L,SAFjC;AAE4C;AACrD8L,gBAAS3D,SAASA,OAAOtD,IAAhB,GAAuB7E,SAHvB;AAIT+L,oBAAa5D,SAASA,OAAO2D,OAAhB,GAA0B9L,SAJ9B;AAKTwL,gBAASrD,SAASA,OAAOqD,OAAhB,GAA0B;AAL1B;AAFK,MAAhB;;AAWA,SAAMQ,eAAe,OAAKnD,aAAL,CAAmBpE,OAAnB,EAA4B,2BAA5B,EAAyDgD,OAAzD,EAAkE9C,SAAlE,CAArB;;AAEA,SAAIqH,gBAAgBA,aAAaF,OAAjC,EAA0C;AACzC,UAAM7G,gBAAgB,OAAKrH,WAAL,CAAiB;AAAE6G,uBAAF;AAAWiB,iBAAX;AAAiBU,gBAAS4F,aAAaF,OAAvC;AAAgDjH;AAAhD,OAAjB,CAAtB;;AACA,aAAKH,aAAL,CAAmB;AAAEC,2BAAF;AAAaC,aAAM,4BAAnB;AAAiDI,2BAAoBC,aAArE;AAAoFC,iBAAU;AAA9F,OAAnB;;AACA;AACA;;AAED,SAAI8G,iBAAiB,KAArB,EAA4B;AAC3B,aAAKtH,aAAL,CAAmB;AAAEC,2BAAF;AAAaC,aAAM,4BAAnB;AAAiDM,iBAAU;AAA3D,OAAnB;;AACA;AACA;AACD,KAjCwD,CAmCzD;;;AACA,QAAI,CAACiD,MAAD,IAAW,CAAC,OAAKzE,cAAL,CAAoBrD,QAApB,CAA6B8H,OAAOwD,UAApC,CAAhB,EAAiE;AAChE,SAAIrG,KAAJ,EAAW;AACV7G,aAAOI,QAAP,CAAgByG,KAAhB,kCAAoDb,QAAQzD,IAA5D,cAAwEnB,GAAxE;AACApB,aAAOI,QAAP,CAAgByG,KAAhB,CAAsBA,KAAtB;AACA;;AAED,SAAI6C,MAAJ,EAAY;AACX1J,aAAOI,QAAP,CAAgByG,KAAhB,kCAAoDb,QAAQzD,IAA5D,cAAwEnB,GAAxE;AACApB,aAAOI,QAAP,CAAgByG,KAAhB,CAAsB6C,MAAtB;;AAEA,UAAIA,OAAOwD,UAAP,KAAsB,GAA1B,EAA+B;AAC9B,cAAKjH,aAAL,CAAmB;AAAEC,4BAAF;AAAaC,cAAM,+BAAnB;AAAoDU,eAAO;AAA3D,QAAnB;;AACA7G,cAAOI,QAAP,CAAgByG,KAAhB,kCAAoDb,QAAQzD,IAA5D;AACAvD,kBAAWkD,MAAX,CAAkBkD,YAAlB,CAA+B+B,MAA/B,CAAsC;AAAE7E,aAAK0D,QAAQ1D;AAAf,QAAtC,EAA4D;AAAE8E,cAAM;AAAE2E,kBAAS;AAAX;AAAR,QAA5D;AACA;AACA;;AAED,UAAIrC,OAAOwD,UAAP,KAAsB,GAA1B,EAA+B;AAC9B,cAAKjH,aAAL,CAAmB;AAAEC,4BAAF;AAAaC,cAAM,+BAAnB;AAAoDU,eAAO;AAA3D,QAAnB;;AACA7G,cAAOI,QAAP,CAAgByG,KAAhB,0CAA0Db,QAAQzD,IAAlE,cAA8EnB,GAA9E;AACApB,cAAOI,QAAP,CAAgByG,KAAhB,CAAsB6C,OAAO2D,OAA7B;AACA;AACA;AACD;;AAED,SAAIrH,QAAQpD,gBAAZ,EAA8B;AAC7B,UAAIuJ,QAAQnG,QAAQnD,UAAhB,IAA8BmD,QAAQjD,UAA1C,EAAsD;AACrD,cAAKkD,aAAL,CAAmB;AAAEC,4BAAF;AAAaW,eAAO,IAApB;AAA0BV,mCAAwBgG,QAAQ,CAAhC;AAA1B,QAAnB;;AAEA,WAAIqB,iBAAJ;;AAEA,eAAQxH,QAAQjD,UAAhB;AACC,aAAK,eAAL;AACC;AACAyK,oBAAWC,KAAKC,GAAL,CAAS,EAAT,EAAavB,QAAQ,CAArB,CAAX;AACA;;AACD,aAAK,eAAL;AACC;AACAqB,oBAAWC,KAAKC,GAAL,CAAS,CAAT,EAAYvB,QAAQ,CAApB,IAAyB,IAApC;AACA;;AACD,aAAK,mBAAL;AACC;AACAqB,oBAAW,CAACrB,QAAQ,CAAT,IAAc,CAAd,GAAkB,IAA7B;AACA;;AACD;AACC,aAAMwB,KAAK,IAAI5M,KAAJ,CAAU,mDAAV,CAAX;;AACA,gBAAKkF,aAAL,CAAmB;AAAEC,8BAAF;AAAaC,gBAAM,mCAAnB;AAAwDU,iBAAO,IAA/D;AAAqEC,sBAAY6G,GAAGzD;AAApF,UAAnB;;AACA;AAhBF;;AAmBAlK,cAAOI,QAAP,CAAgByJ,IAAhB,6BAA+C7D,QAAQzD,IAAvD,YAAkEnB,GAAlE,kBAAkFoM,QAAlF;AACA1M,cAAO8M,UAAP,CAAkB,YAAM;AACvB,eAAK3B,iBAAL,CAAuB7K,GAAvB,EAA4B4E,OAA5B,EAAqC;AAAEvF,qBAAF;AAASkH,yBAAT;AAAkBV,mBAAlB;AAAwB0D,qBAAxB;AAA+BjI;AAA/B,SAArC,EAA4EwD,SAA5E,EAAuFiG,QAAQ,CAA/F;AACA,QAFD,EAEGqB,QAFH;AAGA,OA5BD,MA4BO;AACN,cAAKvH,aAAL,CAAmB;AAAEC,4BAAF;AAAaC,cAAM,kBAAnB;AAAuCU,eAAO;AAA9C,QAAnB;AACA;AACD,MAhCD,MAgCO;AACN,aAAKZ,aAAL,CAAmB;AAAEC,2BAAF;AAAaC,aAAM,oCAAnB;AAAyDU,cAAO;AAAhE,OAAnB;AACA;;AAED;AACA,KAlGwD,CAoGzD;;;AACA,QAAI6C,UAAU,OAAKzE,cAAL,CAAoBrD,QAApB,CAA6B8H,OAAOwD,UAApC,CAAd,EAA+D;AAC9D,SAAIxD,UAAUA,OAAOtD,IAAjB,KAA0BsD,OAAOtD,IAAP,CAAYgF,IAAZ,IAAoB1B,OAAOtD,IAAP,CAAYyH,WAA1D,CAAJ,EAA4E;AAC3E,UAAMC,YAAY,OAAK3O,WAAL,CAAiB;AAAE6G,uBAAF;AAAWiB,iBAAX;AAAiBU,gBAAS+B,OAAOtD,IAAjC;AAAuCA;AAAvC,OAAjB,CAAlB;;AACA,aAAKH,aAAL,CAAmB;AAAEC,2BAAF;AAAaC,aAAM,2BAAnB;AAAgDK,sBAAesH,SAA/D;AAA0ErH,iBAAU;AAApF,OAAnB;AACA;AACD;AACD,IA3GD;AA4GA;;AA/tBuC;AAAA;;AAAA,wCAiuBxCsH,MAjuBwC;AAAA,kBAiuBjCvN,WAjuBiC,EAiuBpBuG,OAjuBoB,EAiuBX;AAC5B,OAAI,CAACvG,WAAD,IAAgBA,YAAYgE,IAAZ,KAAqB,kBAAzC,EAA6D;AAC5D,UAAM,IAAI1D,OAAOC,KAAX,CAAiB,mCAAjB,EAAsD,6DAAtD,CAAN;AACA;;AAED,OAAI,CAACgG,OAAD,IAAY,CAACA,QAAQX,IAAzB,EAA+B;AAC9B,UAAM,IAAItF,OAAOC,KAAX,CAAiB,8BAAjB,EAAiD,4DAAjD,CAAN;AACA;;AAED,OAAMN,QAAQsG,QAAQtG,KAAtB;AACA,OAAMkH,UAAU3I,WAAWkD,MAAX,CAAkB8L,QAAlB,CAA2BC,WAA3B,CAAuClH,QAAQX,IAAR,CAAa2E,UAApD,CAAhB;AACA,OAAM9D,OAAOjI,WAAWkD,MAAX,CAAkBC,KAAlB,CAAwB8L,WAAxB,CAAoClH,QAAQX,IAAR,CAAayE,UAAjD,CAAb;AACA,OAAMnI,OAAO1D,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwByL,WAAxB,CAAoClH,QAAQX,IAAR,CAAa8E,OAAjD,CAAb;AACA,OAAIP,cAAJ;;AAEA,OAAI5D,QAAQX,IAAR,CAAauE,KAAb,IAAsB5D,QAAQX,IAAR,CAAauE,KAAb,CAAmBrI,GAA7C,EAAkD;AACjDqI,YAAQ3L,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwByL,WAAxB,CAAoClH,QAAQX,IAAR,CAAauE,KAAb,CAAmBrI,GAAvD,CAAR;AACA;;AAED,QAAK2J,iBAAL,CAAuBlF,QAAQ3F,GAA/B,EAAoCZ,WAApC,EAAiD;AAAEC,gBAAF;AAASkH,oBAAT;AAAkBV,cAAlB;AAAwB0D,gBAAxB;AAA+BjI;AAA/B,IAAjD;AACA;;AArvBuC;AAAA;;AAAA;AAAA,MAAzC,qH;;;;;;;;;;;;;;;;;;;;;;;;;ACHA1D,WAAWkD,MAAX,CAAkBkD,YAAlB,GAAiC;AAAA;;AAChC,yBAAc;AAAA;AAAA,wDACb,iCAAM,cAAN,CADa;AAEb;;AAH+B,wBAKhC8I,UALgC;AAAA,sBAKrB1J,IALqB,EAKfiF,OALe,EAKN;AACzB,OAAIjF,SAAS,kBAAT,IAA+BA,SAAS,kBAA5C,EAAgE;AAC/D,UAAM,IAAI1D,OAAOC,KAAX,CAAiB,sBAAjB,CAAN;AACA;;AAED,UAAO,KAAKsE,IAAL,CAAU;AAAEb;AAAF,IAAV,EAAoBiF,OAApB,CAAP;AACA;;AAX+B;AAAA;;AAAA,wBAahC0E,eAbgC;AAAA,2BAahBzM,MAbgB,EAaR;AACvB,UAAO,KAAKyF,MAAL,CAAY;AAAEzF;AAAF,IAAZ,EAAwB;AAAE0F,UAAM;AAAE2E,cAAS;AAAX;AAAR,IAAxB,EAAqD;AAAEqC,WAAO;AAAT,IAArD,CAAP;AACA;;AAf+B;AAAA;;AAAA;AAAA,EAA+BpP,WAAWkD,MAAX,CAAkBmM,KAAjD,IAAjC,8F;;;;;;;;;;;;;;;;;;;;;;;;;ACAArP,WAAWkD,MAAX,CAAkBgF,kBAAlB,GAAuC;AAAA;;AACtC,+BAAc;AAAA;AAAA,wDACb,iCAAM,qBAAN,CADa;AAEb;;AAHqC,8BAKtCgH,UALsC;AAAA,sBAK3B1J,IAL2B,EAKrBiF,OALqB,EAKZ;AACzB,OAAIjF,SAAS,kBAAT,IAA+BA,SAAS,kBAA5C,EAAgE;AAC/D,UAAM,IAAI1D,OAAOC,KAAX,CAAiB,0BAAjB,CAAN;AACA;;AAED,UAAO,KAAKsE,IAAL,CAAU;AAAEb;AAAF,IAAV,EAAoBiF,OAApB,CAAP;AACA;;AAXqC;AAAA;;AAAA,8BAatC6E,mBAbsC;AAAA,+BAalB7G,EAbkB,EAadgC,OAbc,EAaL;AAChC,UAAO,KAAKpE,IAAL,CAAU;AAAE,uBAAmBoC;AAArB,IAAV,EAAqCgC,OAArC,CAAP;AACA;;AAfqC;AAAA;;AAAA,8BAiBtC8E,+BAjBsC;AAAA,2CAiBN9G,EAjBM,EAiBF+G,SAjBE,EAiBS/E,OAjBT,EAiBkB;AACvD,UAAO,KAAKpE,IAAL,CAAU;AAAE,uBAAmBoC,EAArB;AAAyB,kCAA8B+G;AAAvD,IAAV,EAA8E/E,OAA9E,CAAP;AACA;;AAnBqC;AAAA;;AAAA,8BAqBtCgF,kCArBsC;AAAA,8CAqBHC,aArBG,EAqBYxI,SArBZ,EAqBuB;AAC5D,UAAO,KAAK9D,OAAL,CAAa;AAAE,uBAAmBsM,aAArB;AAAoCpM,SAAK4D;AAAzC,IAAb,CAAP;AACA;;AAvBqC;AAAA;;AAAA,8BAyBtCyI,eAzBsC;AAAA,2BAyBtBlO,KAzBsB,EAyBfgJ,OAzBe,EAyBN;AAC/B,UAAO,KAAKpE,IAAL,CAAU;AAAE5E;AAAF,IAAV,EAAqBgJ,OAArB,CAAP;AACA;;AA3BqC;AAAA;;AAAA,8BA6BtCmF,UA7BsC;AAAA,sBA6B3BnF,OA7B2B,EA6BlB;AACnB,UAAO,KAAKpE,IAAL,CAAU;AAAEwB,WAAO;AAAT,IAAV,EAA2B4C,OAA3B,CAAP;AACA;;AA/BqC;AAAA;;AAAA,8BAiCtCoF,qBAjCsC;AAAA,iCAiChBH,aAjCgB,EAiCD;AACpC,UAAO,KAAKI,MAAL,CAAY;AAAE,uBAAmBJ;AAArB,IAAZ,CAAP;AACA;;AAnCqC;AAAA;;AAAA;AAAA,EAAqC1P,WAAWkD,MAAX,CAAkBmM,KAAvD,IAAvC,8F;;;;;;;;;;;ACAAvN,OAAOiO,OAAP,CAAe,cAAf;AAA+B,UAASC,uBAAT,GAAmC;AACjE,MAAI,CAAC,KAAKtN,MAAV,EAAkB;AACjB,UAAO,KAAKuN,KAAL,EAAP;AACA;;AAED,MAAIjQ,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAAJ,EAAwE;AACvE,UAAO1C,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BC,IAA/B,EAAP;AACA,GAFD,MAEO,IAAIrG,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAAJ,EAA4E;AAClF,UAAO1C,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BC,IAA/B,CAAoC;AAAE,sBAAkB,KAAK3D;AAAzB,IAApC,CAAP;AACA,GAFM,MAEA;AACN,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,CAAN;AACA;AACD;;AAZD,QAAwCiO,uBAAxC;AAAA,2H;;;;;;;;;;;ACAAlO,OAAOiO,OAAP,CAAe,oBAAf;AAAqC,UAASG,8BAAT,CAAwCR,aAAxC,EAAmE;AAAA,MAAZS,KAAY,uEAAJ,EAAI;;AACvG,MAAI,CAAC,KAAKzN,MAAV,EAAkB;AACjB,UAAO,KAAKuN,KAAL,EAAP;AACA;;AAED,MAAIjQ,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAAJ,EAAwE;AACvE,UAAO1C,WAAWkD,MAAX,CAAkBgF,kBAAlB,CAAqCoH,mBAArC,CAAyDI,aAAzD,EAAwE;AAAEU,UAAM;AAAEtG,iBAAY,CAAC;AAAf,KAAR;AAA4BqG;AAA5B,IAAxE,CAAP;AACA,GAFD,MAEO,IAAInQ,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAAJ,EAA4E;AAClF,UAAO1C,WAAWkD,MAAX,CAAkBgF,kBAAlB,CAAqCqH,+BAArC,CAAqEG,aAArE,EAAoF,KAAKhN,MAAzF,EAAiG;AAAE0N,UAAM;AAAEtG,iBAAY,CAAC;AAAf,KAAR;AAA4BqG;AAA5B,IAAjG,CAAP;AACA,GAFM,MAEA;AACN,SAAM,IAAIrO,OAAOC,KAAX,CAAiB,gBAAjB,CAAN;AACA;AACD;;AAZD,QAA8CmO,8BAA9C;AAAA,2H;;;;;;;;;;;ACAA,kBACA,IAAM5O,oBAAoB,CAAC,GAAD,EAAM,GAAN,CAA1B;AAEAQ,OAAOuO,OAAP,CAAe;AACdC,uBADc,YACS9O,WADT,EACsB;AACnC,MAAI,CAACxB,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAAD,IAAuE,CAAC1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAA5E,EAAoJ;AACnJ,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,cAAnC,EAAmD;AAAEyI,YAAQ;AAAV,IAAnD,CAAN;AACA;;AAED,MAAI,CAACnI,EAAEkO,QAAF,CAAW/O,YAAYjB,OAAvB,CAAL,EAAsC;AACrC,SAAM,IAAIuB,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAEyI,YAAQ;AAAV,IAA7D,CAAN;AACA;;AAED,MAAIhJ,YAAYjB,OAAZ,CAAoBsB,IAApB,OAA+B,EAAnC,EAAuC;AACtC,SAAM,IAAIC,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAEyI,YAAQ;AAAV,IAA7D,CAAN;AACA;;AAED,MAAM7H,WAAWN,EAAE8B,GAAF,CAAM3C,YAAYjB,OAAZ,CAAoB6D,KAApB,CAA0B,GAA1B,CAAN,EAAsC,UAAC7D,OAAD;AAAA,UAAa8D,EAAExC,IAAF,CAAOtB,OAAP,CAAb;AAAA,GAAtC,CAAjB;;AAEA,uBAAsBoC,QAAtB,kHAAgC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,OAArBpC,OAAqB;;AAC/B,OAAI,CAACe,kBAAkBsB,QAAlB,CAA2BrC,QAAQ,CAAR,CAA3B,CAAL,EAA6C;AAC5C,UAAM,IAAIuB,OAAOC,KAAX,CAAiB,wCAAjB,EAA2D,oCAA3D,EAAiG;AAAEyI,aAAQ;AAAV,KAAjG,CAAN;AACA;AACD;;AAED,MAAI,CAACnI,EAAEkO,QAAF,CAAW/O,YAAYQ,QAAvB,CAAD,IAAqCR,YAAYQ,QAAZ,CAAqBH,IAArB,OAAgC,EAAzE,EAA6E;AAC5E,SAAM,IAAIC,OAAOC,KAAX,CAAiB,wBAAjB,EAA2C,kBAA3C,EAA+D;AAAEyI,YAAQ;AAAV,IAA/D,CAAN;AACA;;AAED,MAAIhJ,YAAY+C,aAAZ,KAA8B,IAA9B,IAAsC/C,YAAYgD,MAAlD,IAA4DhD,YAAYgD,MAAZ,CAAmB3C,IAAnB,OAA8B,EAA9F,EAAkG;AACjG,OAAI;AACH,QAAI4C,eAAeG,MAAMC,iBAAN,CAAwB;AAAEC,cAAS;AAAX,KAAxB,CAAnB;AACAL,mBAAepC,EAAEmO,MAAF,CAAS/L,YAAT,EAAuB;AAAEM,cAAS,IAAX;AAAiBC,eAAU,IAA3B;AAAiCC,eAAU;AAA3C,KAAvB,CAAf;AAEAzD,gBAAY0D,cAAZ,GAA6BN,MAAMO,OAAN,CAAc3D,YAAYgD,MAA1B,EAAkCC,YAAlC,EAAgDW,IAA7E;AACA5D,gBAAY6D,WAAZ,GAA0B9C,SAA1B;AACA,IAND,CAME,OAAO+C,CAAP,EAAU;AACX9D,gBAAY0D,cAAZ,GAA6B3C,SAA7B;AACAf,gBAAY6D,WAAZ,GAA0BhD,EAAEkD,IAAF,CAAOD,CAAP,EAAU,MAAV,EAAkB,SAAlB,EAA6B,OAA7B,CAA1B;AACA;AACD;;AAED,wBAAoB3C,QAApB,yHAA8B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,OAArBpC,QAAqB;AAC7B,OAAIwC,eAAJ;AACA,OAAMC,cAAczC,SAAQ,CAAR,CAApB;AACAA,cAAUA,SAAQ0C,MAAR,CAAe,CAAf,CAAV;;AAEA,WAAQD,WAAR;AACC,SAAK,GAAL;AACCD,cAAS/C,WAAWkD,MAAX,CAAkBC,KAAlB,CAAwBC,OAAxB,CAAgC;AACxCC,WAAK,CACJ;AAACC,YAAK/C;AAAN,OADI,EAEJ;AAACgD,aAAMhD;AAAP,OAFI;AADmC,MAAhC,CAAT;AAMA;;AACD,SAAK,GAAL;AACCwC,cAAS/C,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC;AACxCC,WAAK,CACJ;AAACC,YAAK/C;AAAN,OADI,EAEJ;AAACyB,iBAAUzB;AAAX,OAFI;AADmC,MAAhC,CAAT;AAMA;AAhBF;;AAmBA,OAAI,CAACwC,MAAL,EAAa;AACZ,UAAM,IAAIjB,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEyI,aAAQ;AAAV,KAAvD,CAAN;AACA;;AAED,OAAIzH,OAAOU,SAAP,IAAoB,CAACzD,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAArB,IAA2F1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAA3F,IAAqK,CAACK,OAAOU,SAAP,CAAiBb,QAAjB,CAA0Bd,OAAO4B,IAAP,GAAc1B,QAAxC,CAA1K,EAA6N;AAC5N,UAAM,IAAIF,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAEyI,aAAQ;AAAV,KAA7D,CAAN;AACA;AACD;;AAED,MAAM9G,OAAO1D,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC;AAACpB,aAAUR,YAAYQ;AAAvB,GAAhC,CAAb;;AAEA,MAAI,CAAC0B,IAAL,EAAW;AACV,SAAM,IAAI5B,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEyI,YAAQ;AAAV,IAAvD,CAAN;AACA;;AAED,MAAM+C,QAAQ/E,OAAOC,EAAP,CAAU,EAAV,CAAd;AAEAjH,cAAYgE,IAAZ,GAAmB,kBAAnB;AACAhE,cAAY+L,KAAZ,GAAoBA,KAApB;AACA/L,cAAYjB,OAAZ,GAAsBoC,QAAtB;AACAnB,cAAYkB,MAAZ,GAAqBgB,KAAKJ,GAA1B;AACA9B,cAAY6G,UAAZ,GAAyB,IAAIC,IAAJ,EAAzB;AACA9G,cAAYiP,UAAZ,GAAyBzQ,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC,KAAKV,MAArC,EAA6C;AAACgO,WAAQ;AAAC1O,cAAU;AAAX;AAAT,GAA7C,CAAzB;AAEAhC,aAAWkD,MAAX,CAAkByN,KAAlB,CAAwBC,YAAxB,CAAqClN,KAAKJ,GAA1C,EAA+C,KAA/C;AAEA9B,cAAY8B,GAAZ,GAAkBtD,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BmC,MAA/B,CAAsC/G,WAAtC,CAAlB;AAEA,SAAOA,WAAP;AACA;AA5Fa,CAAf,0H;;;;;;;;;;;ACHA,kBACA,IAAMF,oBAAoB,CAAC,GAAD,EAAM,GAAN,CAA1B;AAEAQ,OAAOuO,OAAP,CAAe;AACdQ,0BADc,YACYnB,aADZ,EAC2BlO,WAD3B,EACwC;AACrD,MAAI,CAACa,EAAEkO,QAAF,CAAW/O,YAAYjB,OAAvB,CAAD,IAAoCiB,YAAYjB,OAAZ,CAAoBsB,IAApB,OAA+B,EAAvE,EAA2E;AAC1E,SAAM,IAAIC,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAEyI,YAAQ;AAAV,IAA7D,CAAN;AACA;;AAED,MAAM7H,WAAWN,EAAE8B,GAAF,CAAM3C,YAAYjB,OAAZ,CAAoB6D,KAApB,CAA0B,GAA1B,CAAN,EAAsC,UAAC7D,OAAD;AAAA,UAAa8D,EAAExC,IAAF,CAAOtB,OAAP,CAAb;AAAA,GAAtC,CAAjB;;AAEA,uBAAsBoC,QAAtB,kHAAgC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,OAArBpC,OAAqB;;AAC/B,OAAI,CAACe,kBAAkBsB,QAAlB,CAA2BrC,QAAQ,CAAR,CAA3B,CAAL,EAA6C;AAC5C,UAAM,IAAIuB,OAAOC,KAAX,CAAiB,wCAAjB,EAA2D,oCAA3D,EAAiG;AAAEyI,aAAQ;AAAV,KAAjG,CAAN;AACA;AACD;;AAED,MAAIsG,2BAAJ;;AAEA,MAAI9Q,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAAJ,EAAwE;AACvEoO,wBAAqB9Q,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAArB;AACA,GAFD,MAEO,IAAI1P,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAAJ,EAA4E;AAClFoO,wBAAqB9Q,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuC;AAAEE,SAAKoM,aAAP;AAAsB,sBAAkB,KAAKhN;AAA7C,IAAvC,CAArB;AACA,GAFM,MAEA;AACN,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,cAAnC,EAAmD;AAAEyI,YAAQ;AAAV,IAAnD,CAAN;AACA;;AAED,MAAI,CAACsG,kBAAL,EAAyB;AACxB,SAAM,IAAIhP,OAAOC,KAAX,CAAiB,2BAAjB,EAA8C,qBAA9C,EAAqE;AAAEyI,YAAQ;AAAV,IAArE,CAAN;AACA;;AAED,MAAIhJ,YAAY+C,aAAZ,KAA8B,IAA9B,IAAsC/C,YAAYgD,MAAlD,IAA4DhD,YAAYgD,MAAZ,CAAmB3C,IAAnB,OAA8B,EAA9F,EAAkG;AACjG,OAAI;AACH,QAAI4C,eAAeG,MAAMC,iBAAN,CAAwB;AAAEC,cAAS;AAAX,KAAxB,CAAnB;AACAL,mBAAepC,EAAEmO,MAAF,CAAS/L,YAAT,EAAuB;AAAEM,cAAS,IAAX;AAAiBC,eAAU,IAA3B;AAAiCC,eAAU;AAA3C,KAAvB,CAAf;AAEAzD,gBAAY0D,cAAZ,GAA6BN,MAAMO,OAAN,CAAc3D,YAAYgD,MAA1B,EAAkCC,YAAlC,EAAgDW,IAA7E;AACA5D,gBAAY6D,WAAZ,GAA0B9C,SAA1B;AACA,IAND,CAME,OAAO+C,CAAP,EAAU;AACX9D,gBAAY0D,cAAZ,GAA6B3C,SAA7B;AACAf,gBAAY6D,WAAZ,GAA0BhD,EAAEkD,IAAF,CAAOD,CAAP,EAAU,MAAV,EAAkB,SAAlB,EAA6B,OAA7B,CAA1B;AACA;AACD;;AAED,wBAAoB3C,QAApB,yHAA8B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,OAArBpC,QAAqB;AAC7B,OAAMyC,cAAczC,SAAQ,CAAR,CAApB;AACAA,cAAUA,SAAQ0C,MAAR,CAAe,CAAf,CAAV;AACA,OAAIF,eAAJ;;AAEA,WAAQC,WAAR;AACC,SAAK,GAAL;AACCD,cAAS/C,WAAWkD,MAAX,CAAkBC,KAAlB,CAAwBC,OAAxB,CAAgC;AACxCC,WAAK,CACJ;AAACC,YAAK/C;AAAN,OADI,EAEJ;AAACgD,aAAMhD;AAAP,OAFI;AADmC,MAAhC,CAAT;AAMA;;AACD,SAAK,GAAL;AACCwC,cAAS/C,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC;AACxCC,WAAK,CACJ;AAACC,YAAK/C;AAAN,OADI,EAEJ;AAACyB,iBAAUzB;AAAX,OAFI;AADmC,MAAhC,CAAT;AAMA;AAhBF;;AAmBA,OAAI,CAACwC,MAAL,EAAa;AACZ,UAAM,IAAIjB,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEyI,aAAQ;AAAV,KAAvD,CAAN;AACA;;AAED,OAAIzH,OAAOU,SAAP,IAAoB,CAACzD,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAArB,IAA2F1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAA3F,IAAqK,CAACK,OAAOU,SAAP,CAAiBb,QAAjB,CAA0Bd,OAAO4B,IAAP,GAAc1B,QAAxC,CAA1K,EAA6N;AAC5N,UAAM,IAAIF,OAAOC,KAAX,CAAiB,uBAAjB,EAA0C,iBAA1C,EAA6D;AAAEyI,aAAQ;AAAV,KAA7D,CAAN;AACA;AACD;;AAED,MAAM9G,OAAO1D,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC;AAAEpB,aAAU8O,mBAAmB9O;AAA/B,GAAhC,CAAb;AACAhC,aAAWkD,MAAX,CAAkByN,KAAlB,CAAwBC,YAAxB,CAAqClN,KAAKJ,GAA1C,EAA+C,KAA/C;AAEAtD,aAAWkD,MAAX,CAAkBkD,YAAlB,CAA+B+B,MAA/B,CAAsCuH,aAAtC,EAAqD;AACpDtH,SAAM;AACL2E,aAASvL,YAAYuL,OADhB;AAELxJ,UAAM/B,YAAY+B,IAFb;AAGLkG,YAAQjI,YAAYiI,MAHf;AAILC,WAAOlI,YAAYkI,KAJd;AAKLF,WAAOhI,YAAYgI,KALd;AAMLjJ,aAASoC,QANJ;AAOL6B,YAAQhD,YAAYgD,MAPf;AAQLD,mBAAe/C,YAAY+C,aARtB;AASLW,oBAAgB1D,YAAY0D,cATvB;AAULG,iBAAa7D,YAAY6D,WAVpB;AAWLyE,gBAAY,IAAIxB,IAAJ,EAXP;AAYLyI,gBAAY/Q,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC,KAAKV,MAArC,EAA6C;AAACgO,aAAQ;AAAC1O,gBAAU;AAAX;AAAT,KAA7C;AAZP;AAD8C,GAArD;AAiBA,SAAOhC,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAAP;AACA;AA/Fa,CAAf,0H;;;;;;;;;;;ACHA5N,OAAOuO,OAAP,CAAe;AACdW,0BADc,YACYtB,aADZ,EAC2B;AACxC,MAAIlO,oBAAJ;;AAEA,MAAIxB,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAAJ,EAAwE;AACvElB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAAd;AACA,GAFD,MAEO,IAAI1P,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAAJ,EAA4E;AAClFlB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,EAAsD;AAAEgB,YAAS;AAAE,uBAAkB,KAAKhO;AAAzB;AAAX,IAAtD,CAAd;AACA,GAFM,MAEA;AACN,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,cAAnC,EAAmD;AAAEyI,YAAQ;AAAV,IAAnD,CAAN;AACA;;AAED,MAAI,CAAChJ,WAAL,EAAkB;AACjB,SAAM,IAAIM,OAAOC,KAAX,CAAiB,2BAAjB,EAA8C,qBAA9C,EAAqE;AAAEyI,YAAQ;AAAV,IAArE,CAAN;AACA;;AAEDxK,aAAWkD,MAAX,CAAkBkD,YAAlB,CAA+B0J,MAA/B,CAAsC;AAAExM,QAAKoM;AAAP,GAAtC;AAEA,SAAO,IAAP;AACA;AAnBa,CAAf,0H;;;;;;;;;;;ACAA5N,OAAOuO,OAAP,CAAe;AACdY,uBADc,YACSzP,WADT,EACsB;AACnC,MAAI,CAACxB,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAAD,IACA,CAAC1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CADD,IAEA,CAAC1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,EAAmE,KAAnE,CAFD,IAGA,CAAC1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,EAAuE,KAAvE,CAHL,EAGoF;AACnF,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,CAAN;AACA;;AAEDP,gBAAcxB,WAAWC,YAAX,CAAwBgE,gBAAxB,CAAyCzC,WAAzC,EAAsD,KAAKkB,MAA3D,CAAd;AAEAlB,cAAY6G,UAAZ,GAAyB,IAAIC,IAAJ,EAAzB;AACA9G,cAAYiP,UAAZ,GAAyBzQ,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC,KAAKV,MAArC,EAA6C;AAACgO,WAAQ;AAAC1O,cAAU;AAAX;AAAT,GAA7C,CAAzB;AACAR,cAAY8B,GAAZ,GAAkBtD,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BmC,MAA/B,CAAsC/G,WAAtC,CAAlB;AAEA,SAAOA,WAAP;AACA;AAhBa,CAAf,0H;;;;;;;;;;;ACAAM,OAAOuO,OAAP,CAAe;AACda,0BADc,YACYxB,aADZ,EAC2BlO,WAD3B,EACwC;AACrDA,gBAAcxB,WAAWC,YAAX,CAAwBgE,gBAAxB,CAAyCzC,WAAzC,EAAsD,KAAKkB,MAA3D,CAAd;;AAEA,MAAI,CAAClB,YAAY+L,KAAb,IAAsB/L,YAAY+L,KAAZ,CAAkB1L,IAAlB,OAA6B,EAAvD,EAA2D;AAC1D,SAAM,IAAIC,OAAOC,KAAX,CAAiB,qBAAjB,EAAwC,eAAxC,EAAyD;AAAEyI,YAAQ;AAAV,IAAzD,CAAN;AACA;;AAED,MAAIsG,2BAAJ;;AAEA,MAAI9Q,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,CAAJ,EAAwE;AACvEoO,wBAAqB9Q,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAArB;AACA,GAFD,MAEO,IAAI1P,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,CAAJ,EAA4E;AAClFoO,wBAAqB9Q,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuC;AAAEE,SAAKoM,aAAP;AAAsB,sBAAkB,KAAKhN;AAA7C,IAAvC,CAArB;AACA,GAFM,MAEA;AACN,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,cAAnC,EAAmD;AAAEyI,YAAQ;AAAV,IAAnD,CAAN;AACA;;AAED,MAAI,CAACsG,kBAAL,EAAyB;AACxB,SAAM,IAAIhP,OAAOC,KAAX,CAAiB,qBAAjB,EAAwC,8DAAxC,CAAN;AACA;;AAED/B,aAAWkD,MAAX,CAAkBkD,YAAlB,CAA+B+B,MAA/B,CAAsCuH,aAAtC,EAAqD;AACpDtH,SAAM;AACL3G,WAAOD,YAAYC,KADd;AAELsL,aAASvL,YAAYuL,OAFhB;AAGLxJ,UAAM/B,YAAY+B,IAHb;AAILkG,YAAQjI,YAAYiI,MAJf;AAKLC,WAAOlI,YAAYkI,KALd;AAMLF,WAAOhI,YAAYgI,KANd;AAOLjJ,aAASiB,YAAYjB,OAPhB;AAQLE,gBAAYe,YAAYf,UARnB;AASLmI,qBAAiBpH,YAAYoH,eATxB;AAUL5G,cAAUR,YAAYQ,QAVjB;AAWLU,YAAQlB,YAAYkB,MAXf;AAYLT,UAAMT,YAAYS,IAZb;AAaLsL,WAAO/L,YAAY+L,KAbd;AAcL/I,YAAQhD,YAAYgD,MAdf;AAeLD,mBAAe/C,YAAY+C,aAftB;AAgBLW,oBAAgB1D,YAAY0D,cAhBvB;AAiBLG,iBAAa7D,YAAY6D,WAjBpB;AAkBL7E,kBAAcgB,YAAYhB,YAlBrB;AAmBLoD,sBAAkBpC,YAAYoC,gBAnBzB;AAoBLC,gBAAYrC,YAAYqC,UApBnB;AAqBLE,gBAAYvC,YAAYuC,UArBnB;AAsBLsJ,yBAAqB7L,YAAY6L,mBAtB5B;AAuBLvD,gBAAY,IAAIxB,IAAJ,EAvBP;AAwBLyI,gBAAY/Q,WAAWkD,MAAX,CAAkBM,KAAlB,CAAwBJ,OAAxB,CAAgC,KAAKV,MAArC,EAA6C;AAACgO,aAAQ;AAAC1O,gBAAU;AAAX;AAAT,KAA7C;AAxBP;AAD8C,GAArD;AA6BA,SAAOhC,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAAP;AACA;AApDa,CAAf,0H;;;;;;;;;;;ACAA5N,OAAOuO,OAAP,CAAe;AACdc,0BADc,kBAC0C;AAAA,MAA5BzB,aAA4B,QAA5BA,aAA4B;AAAA,MAAbxI,SAAa,QAAbA,SAAa;AACvD,MAAI1F,oBAAJ;;AAEA,MAAIxB,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,KAAsE1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,EAAmE,KAAnE,CAA1E,EAAqJ;AACpJlB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAAd;AACA,GAFD,MAEO,IAAI1P,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,KAA0E1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,EAAuE,KAAvE,CAA9E,EAA6J;AACnKlB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,EAAsD;AAAEgB,YAAQ;AAAE,uBAAkB,KAAKhO;AAAzB;AAAV,IAAtD,CAAd;AACA,GAFM,MAEA;AACN,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,cAAnC,EAAmD;AAAEyI,YAAQ;AAAV,IAAnD,CAAN;AACA;;AAED,MAAI,CAAChJ,WAAL,EAAkB;AACjB,SAAM,IAAIM,OAAOC,KAAX,CAAiB,2BAAjB,EAA8C,qBAA9C,EAAqE;AAAEyI,YAAQ;AAAV,IAArE,CAAN;AACA;;AAED,MAAMzC,UAAU/H,WAAWkD,MAAX,CAAkBgF,kBAAlB,CAAqCuH,kCAArC,CAAwEjO,YAAY8B,GAApF,EAAyF4D,SAAzF,CAAhB;;AAEA,MAAI,CAACa,OAAL,EAAc;AACb,SAAM,IAAIjG,OAAOC,KAAX,CAAiB,mCAAjB,EAAsD,6BAAtD,EAAqF;AAAEyI,YAAQ;AAAV,IAArF,CAAN;AACA;;AAEDxK,aAAWC,YAAX,CAAwB4F,cAAxB,CAAuCkJ,MAAvC,CAA8CvN,WAA9C,EAA2DuG,OAA3D;AAEA,SAAO,IAAP;AACA;AAzBa,CAAf,0H;;;;;;;;;;;ACAAjG,OAAOuO,OAAP,CAAe;AACde,0BADc,YACY1B,aADZ,EAC2B;AACxC,MAAIlO,oBAAJ;;AAEA,MAAIxB,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,KAAsE1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,EAAmE,KAAnE,CAA1E,EAAqJ;AACpJlB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAAd;AACA,GAFD,MAEO,IAAI1P,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,KAA0E1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,EAAuE,KAAvE,CAA9E,EAA6J;AACnKlB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,EAAsD;AAAEgB,YAAQ;AAAE,uBAAkB,KAAKhO;AAAzB;AAAV,IAAtD,CAAd;AACA,GAFM,MAEA;AACN,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,cAAnC,EAAmD;AAAEyI,YAAQ;AAAV,IAAnD,CAAN;AACA;;AAED,MAAI,CAAChJ,WAAL,EAAkB;AACjB,SAAM,IAAIM,OAAOC,KAAX,CAAiB,2BAAjB,EAA8C,qBAA9C,EAAqE;AAAEyI,YAAQ;AAAV,IAArE,CAAN;AACA;;AAEDxK,aAAWkD,MAAX,CAAkBkD,YAAlB,CAA+B0J,MAA/B,CAAsC;AAAExM,QAAKoM;AAAP,GAAtC;AACA1P,aAAWkD,MAAX,CAAkBgF,kBAAlB,CAAqC2H,qBAArC,CAA2DH,aAA3D;AAEA,SAAO,IAAP;AACA;AApBa,CAAf,0H;;;;;;;;;;;ACAA5N,OAAOuO,OAAP,CAAe;AACdgB,wBADc,YACU3B,aADV,EACyB;AACtC,MAAIlO,oBAAJ;;AAEA,MAAIxB,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,KAAsE1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,qBAA5C,EAAmE,KAAnE,CAA1E,EAAqJ;AACpJlB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,CAAd;AACA,GAFD,MAEO,IAAI1P,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,KAA0E1C,WAAW6C,KAAX,CAAiBC,aAAjB,CAA+B,KAAKJ,MAApC,EAA4C,yBAA5C,EAAuE,KAAvE,CAA9E,EAA6J;AACnKlB,iBAAcxB,WAAWkD,MAAX,CAAkBkD,YAAlB,CAA+BhD,OAA/B,CAAuCsM,aAAvC,EAAsD;AAAEgB,YAAQ;AAAE,uBAAkB,KAAKhO;AAAzB;AAAV,IAAtD,CAAd;AACA,GAFM,MAEA;AACN,SAAM,IAAIZ,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,cAAnC,EAAmD;AAAEyI,YAAQ;AAAV,IAAnD,CAAN;AACA;;AAED,MAAI,CAAChJ,WAAL,EAAkB;AACjB,SAAM,IAAIM,OAAOC,KAAX,CAAiB,2BAAjB,EAA8C,qBAA9C,EAAqE;AAAEyI,YAAQ;AAAV,IAArE,CAAN;AACA;;AAEDxK,aAAWkD,MAAX,CAAkBgF,kBAAlB,CAAqC2H,qBAArC,CAA2DH,aAA3D;AAEA,SAAO,IAAP;AACA;AAnBa,CAAf,0H;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA,IAAM4B;AAAkB,UAASC,gBAAT,CAA0BC,SAA1B,EAAqC;AAC5D;AAAO,YAASC,gBAAT,GAA4B;AAAA;;AAClC,WAAO,oCAAWxR,YAAX,CAAwB4F,cAAxB,EAAuC0G,eAAvC,+BAAuDiF,SAAvD,oCAAqE/F,SAArE,GAAP;AACA;;AAFD,UAAgBgG,gBAAhB;AAAA;AAGA;;AAJK,QAA2BF,gBAA3B;AAAA,GAAN;;AAMAvR,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,kBAAzB,EAA6CL,gBAAgB,aAAhB,CAA7C,EAA6EtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAA3G;AACA7R,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,oBAAzB,EAA+CL,gBAAgB,aAAhB,CAA/C,EAA+EtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAA7G;AACA7R,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,yBAAzB,EAAoDL,gBAAgB,aAAhB,CAApD,EAAoFtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAAlH;AACA7R,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,iBAAzB,EAA4CL,gBAAgB,aAAhB,CAA5C,EAA4EtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAA1G;AACA7R,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,eAAzB,EAA0CL,gBAAgB,YAAhB,CAA1C,EAAyEtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAAvG;AACA7R,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,gBAAzB,EAA2CL,gBAAgB,UAAhB,CAA3C,EAAwEtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAAtG;AACA7R,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,mBAAzB,EAA8CL,gBAAgB,cAAhB,CAA9C,EAA+EtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAA7G;AACA7R,WAAW0R,SAAX,CAAqBC,GAArB,CAAyB,iBAAzB,EAA4CL,gBAAgB,cAAhB,CAA5C,EAA6EtR,WAAW0R,SAAX,CAAqBE,QAArB,CAA8BC,GAA3G,c;;;;;;;;;;;ACbA,KAAKlI,qBAAL,GAA6B,UAASmI,UAAT,EAAqBpO,IAArB,EAA8F;AAAA,KAAnE6F,aAAmE,uEAAnD;AAAEhJ,WAAS,EAAX;AAAeiJ,SAAO,EAAtB;AAA0BC,UAAQ,EAAlC;AAAsCC,SAAO;AAA7C,EAAmD;AAC1H,KAAMqI,WAAW,EAAjB;AACA,KAAMpP,WAAW,GAAGmE,MAAH,CAAUgL,WAAWvR,OAAX,IAAsBuR,WAAWE,MAAjC,IAA2CzI,cAAchJ,OAAnE,CAAjB;;AAEA,sBAAsBoC,QAAtB,kHAAgC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,MAArBpC,OAAqB;AAC/B,MAAMyC,cAAczC,QAAQ,CAAR,CAApB;AAEA,MAAI0R,eAAe1R,QAAQ0C,MAAR,CAAe,CAAf,CAAnB;AACA,MAAIgF,aAAJ;;AAEA,UAAQjF,WAAR;AACC,QAAK,GAAL;AACCiF,WAAOjI,WAAWgJ,iCAAX,CAA6C;AAAEC,oBAAevF,KAAKJ,GAAtB;AAA2BoF,eAAUuJ,YAArC;AAAmDC,kBAAa;AAAhE,KAA7C,CAAP;AACA;;AACD,QAAK,GAAL;AACCjK,WAAOjI,WAAWgJ,iCAAX,CAA6C;AAAEC,oBAAevF,KAAKJ,GAAtB;AAA2BoF,eAAUuJ,YAArC;AAAmDzM,WAAM;AAAzD,KAA7C,CAAP;AACA;;AACD;AACCyM,mBAAejP,cAAciP,YAA7B,CADD,CAGC;;AACAhK,WAAOjI,WAAWgJ,iCAAX,CAA6C;AAAEC,oBAAevF,KAAKJ,GAAtB;AAA2BoF,eAAUuJ,YAArC;AAAmDC,kBAAa,IAAhE;AAAsEhJ,mBAAc;AAApF,KAA7C,CAAP;;AACA,QAAIjB,IAAJ,EAAU;AACT;AACA,KAPF,CASC;;;AACAA,WAAOjI,WAAWgJ,iCAAX,CAA6C;AAAEC,oBAAevF,KAAKJ,GAAtB;AAA2BoF,eAAUuJ,YAArC;AAAmDzM,WAAM,GAAzD;AAA8D2M,4BAAuB;AAArF,KAA7C,CAAP;;AACA,QAAIlK,IAAJ,EAAU;AACT;AACA,KAbF,CAeC;;;AACA,UAAM,IAAInG,OAAOC,KAAX,CAAiB,iBAAjB,CAAN;AAvBF;;AA0BA,MAAI+P,WAAWjD,WAAX,IAA0B,CAACxM,EAAE+P,OAAF,CAAUN,WAAWjD,WAArB,CAA/B,EAAkE;AACjE5E,WAAQoI,GAAR,CAAY,8CAA8CC,GAA1D,EAA+DR,WAAWjD,WAA1E;AACAiD,cAAWjD,WAAX,GAAyBtM,SAAzB;AACA;;AAED,MAAMoG,UAAU;AACfa,UAAOsI,WAAW9P,QAAX,IAAuB8P,WAAWtI,KAAlC,IAA2CD,cAAcC,KADjD;AAEf6C,QAAKhK,EAAER,IAAF,CAAOiQ,WAAW1F,IAAX,IAAmB0F,WAAWzF,GAA9B,IAAqC,EAA5C,CAFU;AAGfwC,gBAAaiD,WAAWjD,WAHT;AAIf0D,cAAWT,WAAWS,SAAX,KAAyBhQ,SAAzB,GAAqCuP,WAAWS,SAAhD,GAA4D,CAACT,WAAWjD,WAJpE;AAKfxF,QAAKyI,WAAWzI,GALD;AAMfmJ,cAAYV,WAAWU,SAAX,KAAyBjQ,SAA1B,GAAuCuP,WAAWU,SAAlD,GAA8D;AAN1D,GAAhB;;AASA,MAAI,CAACnQ,EAAEwE,OAAF,CAAUiL,WAAWW,QAArB,CAAD,IAAmC,CAACpQ,EAAEwE,OAAF,CAAUiL,WAAWrI,MAArB,CAAxC,EAAsE;AACrEd,WAAQc,MAAR,GAAiBqI,WAAWW,QAAX,IAAuBX,WAAWrI,MAAnD;AACA,GAFD,MAEO,IAAI,CAACpH,EAAEwE,OAAF,CAAUiL,WAAWY,UAArB,CAAD,IAAqC,CAACrQ,EAAEwE,OAAF,CAAUiL,WAAWpI,KAArB,CAA1C,EAAuE;AAC7Ef,WAAQe,KAAR,GAAgBoI,WAAWY,UAAX,IAAyBZ,WAAWpI,KAApD;AACA,GAFM,MAEA,IAAI,CAACrH,EAAEwE,OAAF,CAAU0C,cAAcE,MAAxB,CAAL,EAAsC;AAC5Cd,WAAQc,MAAR,GAAiBF,cAAcE,MAA/B;AACA,GAFM,MAEA,IAAI,CAACpH,EAAEwE,OAAF,CAAU0C,cAAcG,KAAxB,CAAL,EAAqC;AAC3Cf,WAAQe,KAAR,GAAgBH,cAAcG,KAA9B;AACA;;AAED,MAAIrH,EAAE+P,OAAF,CAAUzJ,QAAQkG,WAAlB,CAAJ,EAAoC;AACnC,QAAK,IAAIvF,IAAI,CAAb,EAAgBA,IAAIX,QAAQkG,WAAR,CAAoBrM,MAAxC,EAAgD8G,GAAhD,EAAqD;AACpD,QAAMqJ,aAAahK,QAAQkG,WAAR,CAAoBvF,CAApB,CAAnB;;AACA,QAAIqJ,WAAWtG,GAAf,EAAoB;AACnBsG,gBAAWvG,IAAX,GAAkB/J,EAAER,IAAF,CAAO8Q,WAAWtG,GAAlB,CAAlB;AACA,YAAOsG,WAAWtG,GAAlB;AACA;AACD;AACD;;AAED,MAAMuG,gBAAgB5S,WAAWG,WAAX,CAAuBuD,IAAvB,EAA6BiF,OAA7B,EAAsCV,IAAtC,CAAtB;AACA8J,WAAStF,IAAT,CAAc;AAAElM,YAASA,OAAX;AAAoBoI,YAASiK;AAA7B,GAAd;AACA;;AAED,QAAOb,QAAP;AACA,CA3ED,2H","file":"/packages/rocketchat_integrations.js","sourcesContent":["RocketChat.integrations = {\n\toutgoingEvents: {\n\t\tsendMessage: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_SendMessage',\n\t\t\tvalue: 'sendMessage',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: true,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tfileUploaded: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_FileUploaded',\n\t\t\tvalue: 'fileUploaded',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomArchived: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomArchived',\n\t\t\tvalue: 'roomArchived',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomCreated',\n\t\t\tvalue: 'roomCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomJoined: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomJoined',\n\t\t\tvalue: 'roomJoined',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomLeft: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomLeft',\n\t\t\tvalue: 'roomLeft',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tuserCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_UserCreated',\n\t\t\tvalue: 'userCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: true\n\t\t\t}\n\t\t}\n\t}\n};\n","/* globals logger:true */\n/* exported logger */\n\nlogger = new Logger('Integrations', {\n\tsections: {\n\t\tincoming: 'Incoming WebHook',\n\t\toutgoing: 'Outgoing WebHook'\n\t}\n});\n","/* global Babel */\nconst scopedChannels = ['all_public_channels', 'all_private_groups', 'all_direct_messages'];\nconst validChannelChars = ['@', '#'];\n\nfunction _verifyRequiredFields(integration) {\n\tif (!integration.event || !Match.test(integration.event, String) || integration.event.trim() === '' || !RocketChat.integrations.outgoingEvents[integration.event]) {\n\t\tthrow new Meteor.Error('error-invalid-event-type', 'Invalid event type', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!integration.username || !Match.test(integration.username, String) || integration.username.trim() === '') {\n\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.targetRoom && !integration.targetRoom) {\n\t\tthrow new Meteor.Error('error-invalid-targetRoom', 'Invalid Target Room', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!Match.test(integration.urls, [String])) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tfor (const [index, url] of integration.urls.entries()) {\n\t\tif (url.trim() === '') {\n\t\t\tdelete integration.urls[index];\n\t\t}\n\t}\n\n\tintegration.urls = _.without(integration.urls, [undefined]);\n\n\tif (integration.urls.length === 0) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n}\n\nfunction _verifyUserHasPermissionForChannels(integration, userId, channels) {\n\tfor (let channel of channels) {\n\t\tif (scopedChannels.includes(channel)) {\n\t\t\tif (channel === 'all_public_channels') {\n\t\t\t\t// No special permissions needed to add integration to public channels\n\t\t\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t} else {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(userId, 'manage-integrations') && RocketChat.authz.hasPermission(userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction _verifyRetryInformation(integration) {\n\tif (!integration.retryFailedCalls) {\n\t\treturn;\n\t}\n\n\t// Don't allow negative retry counts\n\tintegration.retryCount = integration.retryCount && parseInt(integration.retryCount) > 0 ? parseInt(integration.retryCount) : 4;\n\tintegration.retryDelay = !integration.retryDelay || !integration.retryDelay.trim() ? 'powers-of-ten' : integration.retryDelay.toLowerCase();\n}\n\nRocketChat.integrations.validateOutgoing = function _validateOutgoing(integration, userId) {\n\tif (integration.channel && Match.test(integration.channel, String) && integration.channel.trim() === '') {\n\t\tdelete integration.channel;\n\t}\n\n\t//Moved to it's own function to statisfy the complexity rule\n\t_verifyRequiredFields(integration);\n\n\tlet channels = [];\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.channel) {\n\t\tif (!Match.test(integration.channel, String)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing' });\n\t\t} else {\n\t\t\tchannels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\t\tfor (const channel of channels) {\n\t\t\t\tif (!validChannelChars.includes(channel[0]) && !scopedChannels.includes(channel.toLowerCase())) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { function: 'validateOutgoing' });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\tthrow new Meteor.Error('error-invalid-permissions', 'Invalid permission for required Integration creation.', { function: 'validateOutgoing' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.triggerWords && integration.triggerWords) {\n\t\tif (!Match.test(integration.triggerWords, [String])) {\n\t\t\tthrow new Meteor.Error('error-invalid-triggerWords', 'Invalid triggerWords', { function: 'validateOutgoing' });\n\t\t}\n\n\t\tfor (const [index, triggerWord] of integration.triggerWords) {\n\t\t\tif (triggerWord.trim() === '') {\n\t\t\t\tdelete integration.triggerWords[index];\n\t\t\t}\n\t\t}\n\n\t\tintegration.triggerWords = _.without(integration.triggerWords, [undefined]);\n\t} else {\n\t\tdelete integration.triggerWords;\n\t}\n\n\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\ttry {\n\t\t\tconst babelOptions = Object.assign(Babel.getDefaultOptions({ runtime: false }), { compact: true, minified: true, comments: false });\n\n\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\tintegration.scriptError = undefined;\n\t\t} catch (e) {\n\t\t\tintegration.scriptCompiled = undefined;\n\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t}\n\t}\n\n\t_verifyUserHasPermissionForChannels(integration, userId, channels);\n\t_verifyRetryInformation(integration);\n\n\tconst user = RocketChat.models.Users.findOne({ username: integration.username });\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { function: 'validateOutgoing' });\n\t}\n\n\tintegration.type = 'webhook-outgoing';\n\tintegration.userId = user._id;\n\tintegration.channel = channels;\n\n\treturn integration;\n};\n","/* global logger, processWebhookMessage */\nimport moment from 'moment';\n\nRocketChat.integrations.triggerHandler = new class RocketChatIntegrationHandler {\n\tconstructor() {\n\t\tthis.vm = Npm.require('vm');\n\t\tthis.successResults = [200, 201, 202];\n\t\tthis.compiledScripts = {};\n\t\tthis.triggers = {};\n\n\t\tRocketChat.models.Integrations.find({type: 'webhook-outgoing'}).observe({\n\t\t\tadded: (record) => {\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tchanged: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tremoved: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t}\n\t\t});\n\t}\n\n\taddIntegration(record) {\n\t\tlogger.outgoing.debug(`Adding the integration ${record.name} of the event ${record.event}!`);\n\t\tlet channels;\n\t\tif (record.event && !RocketChat.integrations.outgoingEvents[record.event].use.channel) {\n\t\t\tlogger.outgoing.debug('The integration doesnt rely on channels.');\n\t\t\t//We don't use any channels, so it's special ;)\n\t\t\tchannels = ['__any'];\n\t\t} else if (_.isEmpty(record.channel)) {\n\t\t\tlogger.outgoing.debug('The integration had an empty channel property, so it is going on all the public channels.');\n\t\t\tchannels = ['all_public_channels'];\n\t\t} else {\n\t\t\tlogger.outgoing.debug('The integration is going on these channels:', record.channel);\n\t\t\tchannels = [].concat(record.channel);\n\t\t}\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!this.triggers[channel]) {\n\t\t\t\tthis.triggers[channel] = {};\n\t\t\t}\n\n\t\t\tthis.triggers[channel][record._id] = record;\n\t\t}\n\t}\n\n\tremoveIntegration(record) {\n\t\tfor (const trigger of Object.values(this.triggers)) {\n\t\t\tdelete trigger[record._id];\n\t\t}\n\t}\n\n\tupdateHistory({ historyId, step, integration, event, data, triggerWord, ranPrepareScript, prepareSentMessage, processSentMessage, resultMessage, finished, url, httpCallData, httpError, httpResult, error, errorStack }) {\n\t\tconst history = {\n\t\t\ttype: 'outgoing-webhook',\n\t\t\tstep\n\t\t};\n\n\t\t// Usually is only added on initial insert\n\t\tif (integration) {\n\t\t\thistory.integration = integration;\n\t\t}\n\n\t\t// Usually is only added on initial insert\n\t\tif (event) {\n\t\t\thistory.event = event;\n\t\t}\n\n\t\tif (data) {\n\t\t\thistory.data = data;\n\n\t\t\tif (data.user) {\n\t\t\t\thistory.data.user = _.omit(data.user, ['meta', '$loki', 'services']);\n\t\t\t}\n\n\t\t\tif (data.room) {\n\t\t\t\thistory.data.room = _.omit(data.room, ['meta', '$loki', 'usernames']);\n\t\t\t\thistory.data.room.usernames = ['this_will_be_filled_in_with_usernames_when_replayed'];\n\t\t\t}\n\t\t}\n\n\t\tif (triggerWord) {\n\t\t\thistory.triggerWord = triggerWord;\n\t\t}\n\n\t\tif (typeof ranPrepareScript !== 'undefined') {\n\t\t\thistory.ranPrepareScript = ranPrepareScript;\n\t\t}\n\n\t\tif (prepareSentMessage) {\n\t\t\thistory.prepareSentMessage = prepareSentMessage;\n\t\t}\n\n\t\tif (processSentMessage) {\n\t\t\thistory.processSentMessage = processSentMessage;\n\t\t}\n\n\t\tif (resultMessage) {\n\t\t\thistory.resultMessage = resultMessage;\n\t\t}\n\n\t\tif (typeof finished !== 'undefined') {\n\t\t\thistory.finished = finished;\n\t\t}\n\n\t\tif (url) {\n\t\t\thistory.url = url;\n\t\t}\n\n\t\tif (typeof httpCallData !== 'undefined') {\n\t\t\thistory.httpCallData = httpCallData;\n\t\t}\n\n\t\tif (httpError) {\n\t\t\thistory.httpError = httpError;\n\t\t}\n\n\t\tif (typeof httpResult !== 'undefined') {\n\t\t\thistory.httpResult = httpResult;\n\t\t}\n\n\t\tif (typeof error !== 'undefined') {\n\t\t\thistory.error = error;\n\t\t}\n\n\t\tif (typeof errorStack !== 'undefined') {\n\t\t\thistory.errorStack = errorStack;\n\t\t}\n\n\t\tif (historyId) {\n\t\t\tRocketChat.models.IntegrationHistory.update({ _id: historyId }, { $set: history });\n\t\t\treturn historyId;\n\t\t} else {\n\t\t\thistory._createdAt = new Date();\n\t\t\treturn RocketChat.models.IntegrationHistory.insert(Object.assign({ _id: Random.id() }, history));\n\t\t}\n\t}\n\n\t//Trigger is the trigger, nameOrId is a string which is used to try and find a room, room is a room, message is a message, and data contains \"user_name\" if trigger.impersonateUser is truthful.\n\tsendMessage({ trigger, nameOrId = '', room, message, data }) {\n\t\tlet user;\n\t\t//Try to find the user who we are impersonating\n\t\tif (trigger.impersonateUser) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(data.user_name);\n\t\t}\n\n\t\t//If they don't exist (aka the trigger didn't contain a user) then we set the user based upon the\n\t\t//configured username for the integration since this is required at all times.\n\t\tif (!user) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(trigger.username);\n\t\t}\n\n\t\tlet tmpRoom;\n\t\tif (nameOrId || trigger.targetRoom) {\n\t\t\ttmpRoom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: nameOrId || trigger.targetRoom, errorOnEmpty: false }) || room;\n\t\t} else {\n\t\t\ttmpRoom = room;\n\t\t}\n\n\t\t//If no room could be found, we won't be sending any messages but we'll warn in the logs\n\t\tif (!tmpRoom) {\n\t\t\tlogger.outgoing.warn(`The Integration \"${trigger.name}\" doesn't have a room configured nor did it provide a room to send the message to.`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found a room for ${trigger.name} which is: ${tmpRoom.name} with a type of ${tmpRoom.t}`);\n\n\t\tmessage.bot = { i: trigger._id };\n\n\t\tconst defaultValues = {\n\t\t\talias: trigger.alias,\n\t\t\tavatar: trigger.avatar,\n\t\t\temoji: trigger.emoji\n\t\t};\n\n\t\tif (tmpRoom.t === 'd') {\n\t\t\tmessage.channel = '@' + tmpRoom._id;\n\t\t} else {\n\t\t\tmessage.channel = '#' + tmpRoom._id;\n\t\t}\n\n\t\tmessage = processWebhookMessage(message, user, defaultValues);\n\t\treturn message;\n\t}\n\n\tgetIntegrationScript(integration) {\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\tconst store = {};\n\t\tconst sandbox = {\n\t\t\t_, s, console, moment,\n\t\t\tStore: {\n\t\t\t\tset: (key, val) => store[key] = val,\n\t\t\t\tget: (key) => store[key]\n\t\t\t},\n\t\t\tHTTP: (method, url, options) => {\n\t\t\t\ttry {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t\t};\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn { error };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tlet vmScript;\n\t\ttry {\n\t\t\tlogger.outgoing.info('Will evaluate script of Trigger', integration.name);\n\t\t\tlogger.outgoing.debug(script);\n\n\t\t\tvmScript = this.vm.createScript(script, 'script.js');\n\n\t\t\tvmScript.runInNewContext(sandbox);\n\n\t\t\tif (sandbox.Script) {\n\t\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\t\tstore,\n\t\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t\t};\n\n\t\t\t\treturn this.compiledScripts[integration._id].script;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlogger.outgoing.error(`Error evaluating Script in Trigger ${integration.name}:`);\n\t\t\tlogger.outgoing.error(script.replace(/^/gm, '  '));\n\t\t\tlogger.outgoing.error('Stack Trace:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\tthrow new Meteor.Error('error-evaluating-script');\n\t\t}\n\n\t\tif (!sandbox.Script) {\n\t\t\tlogger.outgoing.error(`Class \"Script\" not in Trigger ${integration.name}:`);\n\t\t\tthrow new Meteor.Error('class-script-not-found');\n\t\t}\n\t}\n\n\thasScriptAndMethod(integration, method) {\n\t\tif (integration.scriptEnabled !== true || !integration.scriptCompiled || integration.scriptCompiled.trim() === '') {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn typeof script[method] !== 'undefined';\n\t}\n\n\texecuteScript(integration, method, params, historyId) {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: 'execute-script-getting-script', error: true, errorStack: e });\n\t\t\treturn;\n\t\t}\n\n\t\tif (!script[method]) {\n\t\t\tlogger.outgoing.error(`Method \"${method}\" no found in the Integration \"${integration.name}\"`);\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-no-method-${method}` });\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst store = this.compiledScripts[integration._id].store;\n\t\t\tconst sandbox = {\n\t\t\t\t_, s, console, moment,\n\t\t\t\tStore: {\n\t\t\t\t\tset: (key, val) => store[key] = val,\n\t\t\t\t\tget: (key) => store[key]\n\t\t\t\t},\n\t\t\t\tHTTP: (method, url, options) => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t\t\t};\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\treturn { error };\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tscript,\n\t\t\t\tmethod,\n\t\t\t\tparams\n\t\t\t};\n\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-before-running-${method}` });\n\t\t\tconst result = this.vm.runInNewContext('script[method](params)', sandbox, { timeout: 3000 });\n\n\t\t\tlogger.outgoing.debug(`Script method \"${method}\" result of the Integration \"${integration.name}\" is:`);\n\t\t\tlogger.outgoing.debug(result);\n\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-error-running-${method}`, error: true, errorStack: e.stack.replace(/^/gm, '  ') });\n\t\t\tlogger.outgoing.error(`Error running Script in the Integration ${integration.name}:`);\n\t\t\tlogger.outgoing.debug(integration.scriptCompiled.replace(/^/gm, '  ')); // Only output the compiled script if debugging is enabled, so the logs don't get spammed.\n\t\t\tlogger.outgoing.error('Stack:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\treturn;\n\t\t}\n\t}\n\n\teventNameArgumentsToObject() {\n\t\tconst argObject = {\n\t\t\tevent: arguments[0]\n\t\t};\n\n\t\tswitch (argObject.event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.message = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\tconst arghhh = arguments[1];\n\t\t\t\t\targObject.user = arghhh.user;\n\t\t\t\t\targObject.room = arghhh.room;\n\t\t\t\t\targObject.message = arghhh.message;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.room = arguments[1];\n\t\t\t\t\targObject.user = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.owner = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.outgoing.warn(`An Unhandled Trigger Event was called: ${argObject.event}`);\n\t\t\t\targObject.event = undefined;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Got the event arguments for the event: ${argObject.event}`, argObject);\n\n\t\treturn argObject;\n\t}\n\n\tmapEventArgsToData(data, { event, message, room, owner, user }) {\n\t\tswitch (event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\t\t\t\tdata.message = message;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.timestamp = room.ts;\n\t\t\t\tdata.user_id = owner._id;\n\t\t\t\tdata.user_name = owner.username;\n\t\t\t\tdata.owner = owner;\n\t\t\t\tdata.room = room;\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tdata.timestamp = new Date();\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tdata.timestamp = user.createdAt;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\texecuteTriggers() {\n\t\tlogger.outgoing.debug('Execute Trigger:', arguments[0]);\n\n\t\tconst argObject = this.eventNameArgumentsToObject(...arguments);\n\t\tconst { event, message, room } = argObject;\n\n\t\t//Each type of event should have an event and a room attached, otherwise we\n\t\t//wouldn't know how to handle the trigger nor would we have anywhere to send the\n\t\t//result of the integration\n\t\tif (!event) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst triggersToExecute = [];\n\n\t\tlogger.outgoing.debug('Starting search for triggers for the room:', room ? room._id : '__any');\n\t\tif (room) {\n\t\t\tswitch (room.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tconst id = room._id.replace(message.u._id, '');\n\t\t\t\t\tconst username = _.without(room.usernames, message.u.username)[0];\n\n\t\t\t\t\tif (this.triggers['@'+id]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers['@'+id])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers.all_direct_messages) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_direct_messages)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (id !== username && this.triggers['@'+username]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers['@'+username])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'c':\n\t\t\t\t\tif (this.triggers.all_public_channels) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_public_channels)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers['#'+room._id]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers['#'+room._id])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers['#'+room.name]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers['#'+room.name])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tif (this.triggers.all_private_groups) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_private_groups)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers['#'+room._id]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers['#'+room._id])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers['#'+room.name]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers['#'+room.name])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t} else if (this.triggers.__any) {\n\t\t\t//For outgoing integration which don't rely on rooms.\n\t\t\tfor (const trigger of Object.values(this.triggers.__any)) {\n\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t}\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found ${triggersToExecute.length} to iterate over and see if the match the event.`);\n\n\t\tfor (const triggerToExecute of triggersToExecute) {\n\t\t\tlogger.outgoing.debug(`Is ${triggerToExecute.name} enabled, ${triggerToExecute.enabled}, and what is the event? ${triggerToExecute.event}`);\n\t\t\tif (triggerToExecute.enabled === true && triggerToExecute.event === event) {\n\t\t\t\tthis.executeTrigger(triggerToExecute, argObject);\n\t\t\t}\n\t\t}\n\t}\n\n\texecuteTrigger(trigger, argObject) {\n\t\tfor (const url of trigger.urls) {\n\t\t\tthis.executeTriggerUrl(url, trigger, argObject, 0);\n\t\t}\n\t}\n\n\texecuteTriggerUrl(url, trigger, { event, message, room, owner, user }, theHistoryId, tries = 0) {\n\t\tlogger.outgoing.debug(`Starting to execute trigger: ${trigger.name} (${trigger._id})`);\n\n\t\tlet word;\n\t\t//Not all triggers/events support triggerWords\n\t\tif (RocketChat.integrations.outgoingEvents[event].use.triggerWords) {\n\t\t\tif (trigger.triggerWords && trigger.triggerWords.length > 0) {\n\t\t\t\tfor (const triggerWord of trigger.triggerWords) {\n\t\t\t\t\tif (!trigger.triggerWordAnywhere && message.msg.indexOf(triggerWord) === 0) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (trigger.triggerWordAnywhere && message.msg.includes(triggerWord)) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Stop if there are triggerWords but none match\n\t\t\t\tif (!word) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst historyId = this.updateHistory({ step: 'start-execute-trigger-url', integration: trigger, event });\n\n\t\tconst data = {\n\t\t\ttoken: trigger.token,\n\t\t\tbot: false\n\t\t};\n\n\t\tif (word) {\n\t\t\tdata.trigger_word = word;\n\t\t}\n\n\t\tthis.mapEventArgsToData(data, { trigger, event, message, room, owner, user });\n\t\tthis.updateHistory({ historyId, step: 'mapped-args-to-data', data, triggerWord: word });\n\n\t\tlogger.outgoing.info(`Will be executing the Integration \"${trigger.name}\" to the url: ${url}`);\n\t\tlogger.outgoing.debug(data);\n\n\t\tlet opts = {\n\t\t\tparams: {},\n\t\t\tmethod: 'POST',\n\t\t\turl,\n\t\t\tdata,\n\t\t\tauth: undefined,\n\t\t\tnpmRequestOptions: {\n\t\t\t\trejectUnauthorized: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs'),\n\t\t\t\tstrictSSL: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs')\n\t\t\t},\n\t\t\theaders: {\n\t\t\t\t'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36'\n\t\t\t}\n\t\t};\n\n\t\tif (this.hasScriptAndMethod(trigger, 'prepare_outgoing_request')) {\n\t\t\topts = this.executeScript(trigger, 'prepare_outgoing_request', { request: opts }, historyId);\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'after-maybe-ran-prepare', ranPrepareScript: true });\n\n\t\tif (!opts) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-opts', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tif (opts.message) {\n\t\t\tconst prepareMessage = this.sendMessage({ trigger, room, message: opts.message, data });\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-send-message', prepareSentMessage: prepareMessage });\n\t\t}\n\n\t\tif (!opts.url || !opts.method) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-url_or_method', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'pre-http-call', url: opts.url, httpCallData: opts.data });\n\t\tHTTP.call(opts.method, opts.url, opts, (error, result) => {\n\t\t\tif (!result) {\n\t\t\t\tlogger.outgoing.warn(`Result for the Integration ${trigger.name} to ${url} is empty`);\n\t\t\t} else {\n\t\t\t\tlogger.outgoing.info(`Status code for the Integration ${trigger.name} to ${url} is ${result.statusCode}`);\n\t\t\t}\n\n\t\t\tthis.updateHistory({ historyId, step: 'after-http-call', httpError: error, httpResult: result });\n\n\t\t\tif (this.hasScriptAndMethod(trigger, 'process_outgoing_response')) {\n\t\t\t\tconst sandbox = {\n\t\t\t\t\trequest: opts,\n\t\t\t\t\tresponse: {\n\t\t\t\t\t\terror,\n\t\t\t\t\t\tstatus_code: result ? result.statusCode : undefined, //These values will be undefined to close issues #4175, #5762, and #5896\n\t\t\t\t\t\tcontent: result ? result.data : undefined,\n\t\t\t\t\t\tcontent_raw: result ? result.content : undefined,\n\t\t\t\t\t\theaders: result ? result.headers : {}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst scriptResult = this.executeScript(trigger, 'process_outgoing_response', sandbox, historyId);\n\n\t\t\t\tif (scriptResult && scriptResult.content) {\n\t\t\t\t\tconst resultMessage = this.sendMessage({ trigger, room, message: scriptResult.content, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-send-message', processSentMessage: resultMessage, finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (scriptResult === false) {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-false-result', finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if the result contained nothing or wasn't a successful statusCode\n\t\t\tif (!result || !this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (error) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${trigger.name}\" to ${url} is:`);\n\t\t\t\t\tlogger.outgoing.error(error);\n\t\t\t\t}\n\n\t\t\t\tif (result) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${trigger.name}\" to ${url} is:`);\n\t\t\t\t\tlogger.outgoing.error(result);\n\n\t\t\t\t\tif (result.statusCode === 410) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-410', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Disabling the Integration \"${trigger.name}\" because the status code was 401 (Gone).`);\n\t\t\t\t\t\tRocketChat.models.Integrations.update({ _id: trigger._id }, { $set: { enabled: false }});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result.statusCode === 500) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-500', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Error \"500\" for the Integration \"${trigger.name}\" to ${url}.`);\n\t\t\t\t\t\tlogger.outgoing.error(result.content);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (trigger.retryFailedCalls) {\n\t\t\t\t\tif (tries < trigger.retryCount && trigger.retryDelay) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, error: true, step: `going-to-retry-${tries + 1}` });\n\n\t\t\t\t\t\tlet waitTime;\n\n\t\t\t\t\t\tswitch (trigger.retryDelay) {\n\t\t\t\t\t\t\tcase 'powers-of-ten':\n\t\t\t\t\t\t\t\t// Try again in 0.1s, 1s, 10s, 1m40s, 16m40s, 2h46m40s, 27h46m40s, etc\n\t\t\t\t\t\t\t\twaitTime = Math.pow(10, tries + 2);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'powers-of-two':\n\t\t\t\t\t\t\t\t// 2 seconds, 4 seconds, 8 seconds\n\t\t\t\t\t\t\t\twaitTime = Math.pow(2, tries + 1) * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'increments-of-two':\n\t\t\t\t\t\t\t\t// 2 second, 4 seconds, 6 seconds, etc\n\t\t\t\t\t\t\t\twaitTime = (tries + 1) * 2 * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tconst er = new Error('The integration\\'s retryDelay setting is invalid.');\n\t\t\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-retry-delay-is-invalid', error: true, errorStack: er.stack });\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlogger.outgoing.info(`Trying the Integration ${trigger.name} to ${url} again in ${waitTime} milliseconds.`);\n\t\t\t\t\t\tMeteor.setTimeout(() => {\n\t\t\t\t\t\t\tthis.executeTriggerUrl(url, trigger, { event, message, room, owner, user }, historyId, tries + 1);\n\t\t\t\t\t\t}, waitTime);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'too-many-retries', error: true });\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-not-configured-to-retry', error: true });\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//process outgoing webhook response as a new message\n\t\t\tif (result && this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (result && result.data && (result.data.text || result.data.attachments)) {\n\t\t\t\t\tconst resultMsg = this.sendMessage({ trigger, room, message: result.data, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'url-response-sent-message', resultMessage: resultMsg, finished: true });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\treplay(integration, history) {\n\t\tif (!integration || integration.type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('integration-type-must-be-outgoing', 'The integration type to replay must be an outgoing webhook.');\n\t\t}\n\n\t\tif (!history || !history.data) {\n\t\t\tthrow new Meteor.Error('history-data-must-be-defined', 'The history data must be defined to replay an integration.');\n\t\t}\n\n\t\tconst event = history.event;\n\t\tconst message = RocketChat.models.Messages.findOneById(history.data.message_id);\n\t\tconst room = RocketChat.models.Rooms.findOneById(history.data.channel_id);\n\t\tconst user = RocketChat.models.Users.findOneById(history.data.user_id);\n\t\tlet owner;\n\n\t\tif (history.data.owner && history.data.owner._id) {\n\t\t\towner = RocketChat.models.Users.findOneById(history.data.owner._id);\n\t\t}\n\n\t\tthis.executeTriggerUrl(history.url, integration, { event, message, room, owner, user });\n\t}\n};\n","RocketChat.models.Integrations = new class Integrations extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integrations');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'webhook-incoming' && type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('invalid-type-to-find');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tdisableByUserId(userId) {\n\t\treturn this.update({ userId }, { $set: { enabled: false }}, { multi: true });\n\t}\n};\n","RocketChat.models.IntegrationHistory = new class IntegrationHistory extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integration_history');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'outgoing-webhook' || type !== 'incoming-webhook') {\n\t\t\tthrow new Meteor.Error('invalid-integration-type');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tfindByIntegrationId(id, options) {\n\t\treturn this.find({ 'integration._id': id }, options);\n\t}\n\n\tfindByIntegrationIdAndCreatedBy(id, creatorId, options) {\n\t\treturn this.find({ 'integration._id': id, 'integration._createdBy._id': creatorId }, options);\n\t}\n\n\tfindOneByIntegrationIdAndHistoryId(integrationId, historyId) {\n\t\treturn this.findOne({ 'integration._id': integrationId, _id: historyId });\n\t}\n\n\tfindByEventName(event, options) {\n\t\treturn this.find({ event }, options);\n\t}\n\n\tfindFailed(options) {\n\t\treturn this.find({ error: true }, options);\n\t}\n\n\tremoveByIntegrationId(integrationId) {\n\t\treturn this.remove({ 'integration._id': integrationId });\n\t}\n};\n","Meteor.publish('integrations', function _integrationPublication() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.Integrations.find();\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.Integrations.find({ '_createdBy._id': this.userId });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","Meteor.publish('integrationHistory', function _integrationHistoryPublication(integrationId, limit = 25) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationId(integrationId, { sort: { _updatedAt: -1 }, limit });\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationIdAndCreatedBy(integrationId, this.userId, { sort: { _updatedAt: -1 }, limit });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","/* global Babel */\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\taddIncomingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (!_.isString(integration.channel)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tif (!_.isString(integration.username) || integration.username.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'addIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'addIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({username: integration.username});\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst token = Random.id(48);\n\n\t\tintegration.type = 'webhook-incoming';\n\t\tintegration.token = token;\n\t\tintegration.channel = channels;\n\t\tintegration.userId = user._id;\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","/* global Babel */\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\tupdateIncomingIntegration(integrationId, integration) {\n\t\tif (!_.isString(integration.channel) || integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\t\t\tlet record;\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({ username: currentIntegration.username });\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: channels,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\tdeleteIncomingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields : { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\taddOutgoingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","Meteor.methods({\n\tupdateOutgoingIntegration(integrationId, integration) {\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tevent: integration.event,\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: integration.channel,\n\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\tusername: integration.username,\n\t\t\t\tuserId: integration.userId,\n\t\t\t\turls: integration.urls,\n\t\t\t\ttoken: integration.token,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\treplayOutgoingIntegration({ integrationId, historyId }) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tconst history = RocketChat.models.IntegrationHistory.findOneByIntegrationIdAndHistoryId(integration._id, historyId);\n\n\t\tif (!history) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration-history', 'Invalid Integration History', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.integrations.triggerHandler.replay(integration, history);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tdeleteOutgoingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tclearIntegrationHistory(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","const callbackHandler = function _callbackHandler(eventType) {\n\treturn function _wrapperFunction() {\n\t\treturn RocketChat.integrations.triggerHandler.executeTriggers(eventType, ...arguments);\n\t};\n};\n\nRocketChat.callbacks.add('afterSaveMessage', callbackHandler('sendMessage'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateChannel', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreatePrivateGroup', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateUser', callbackHandler('userCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterJoinRoom', callbackHandler('roomJoined'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterLeaveRoom', callbackHandler('roomLeft'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterRoomArchived', callbackHandler('roomArchived'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterFileUpload', callbackHandler('fileUploaded'), RocketChat.callbacks.priority.LOW);\n","this.processWebhookMessage = function(messageObj, user, defaultValues = { channel: '', alias: '', avatar: '', emoji: '' }) {\n\tconst sentData = [];\n\tconst channels = [].concat(messageObj.channel || messageObj.roomId || defaultValues.channel);\n\n\tfor (const channel of channels) {\n\t\tconst channelType = channel[0];\n\n\t\tlet channelValue = channel.substr(1);\n\t\tlet room;\n\n\t\tswitch (channelType) {\n\t\t\tcase '#':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true });\n\t\t\t\tbreak;\n\t\t\tcase '@':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd' });\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tchannelValue = channelType + channelValue;\n\n\t\t\t\t//Try to find the room by id or name if they didn't include the prefix.\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true, errorOnEmpty: false });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//We didn't get a room, let's try finding direct messages\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd', tryDirectByUserIdOnly: true });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//No room, so throw an error\n\t\t\t\tthrow new Meteor.Error('invalid-channel');\n\t\t}\n\n\t\tif (messageObj.attachments && !_.isArray(messageObj.attachments)) {\n\t\t\tconsole.log('Attachments should be Array, ignoring value'.red, messageObj.attachments);\n\t\t\tmessageObj.attachments = undefined;\n\t\t}\n\n\t\tconst message = {\n\t\t\talias: messageObj.username || messageObj.alias || defaultValues.alias,\n\t\t\tmsg: _.trim(messageObj.text || messageObj.msg || ''),\n\t\t\tattachments: messageObj.attachments,\n\t\t\tparseUrls: messageObj.parseUrls !== undefined ? messageObj.parseUrls : !messageObj.attachments,\n\t\t\tbot: messageObj.bot,\n\t\t\tgroupable: (messageObj.groupable !== undefined) ? messageObj.groupable : false\n\t\t};\n\n\t\tif (!_.isEmpty(messageObj.icon_url) || !_.isEmpty(messageObj.avatar)) {\n\t\t\tmessage.avatar = messageObj.icon_url || messageObj.avatar;\n\t\t} else if (!_.isEmpty(messageObj.icon_emoji) || !_.isEmpty(messageObj.emoji)) {\n\t\t\tmessage.emoji = messageObj.icon_emoji || messageObj.emoji;\n\t\t} else if (!_.isEmpty(defaultValues.avatar)) {\n\t\t\tmessage.avatar = defaultValues.avatar;\n\t\t} else if (!_.isEmpty(defaultValues.emoji)) {\n\t\t\tmessage.emoji = defaultValues.emoji;\n\t\t}\n\n\t\tif (_.isArray(message.attachments)) {\n\t\t\tfor (let i = 0; i < message.attachments.length; i++) {\n\t\t\t\tconst attachment = message.attachments[i];\n\t\t\t\tif (attachment.msg) {\n\t\t\t\t\tattachment.text = _.trim(attachment.msg);\n\t\t\t\t\tdelete attachment.msg;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst messageReturn = RocketChat.sendMessage(user, message, room);\n\t\tsentData.push({ channel: channel, message: messageReturn });\n\t}\n\n\treturn sentData;\n};\n"]}