{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAgentData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatTriggers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ðŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ðŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/roomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js"],"names":["url","module","import","v","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteList","RocketChat","settings","get","headers","referer","_","isEmpty","trim","map","split","domain","contains","host","protocol","head","Assets","getText","html","autoupdateVersion","JSON","stringify","__meteor_runtime_config__","write","end","startup","roomTypes","setRoomFind","code","models","Rooms","findLivechatByCode","authz","addRoomAccessValidator","room","user","t","hasPermission","_id","callbacks","add","Error","TAPi18n","__","lng","language","priority","LOW","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","token","defer","response","HTTP","post","data","query","msg","lang","sessionId","status","result","fulfillment","speech","LivechatExternalMessage","insert","rid","orig","ts","Date","e","SystemLogger","error","waitingResponse","now","setResponseByRoomId","u","username","responseDate","responseTime","getTime","postData","type","sentAt","visitor","name","email","Livechat","sendRequest","MEDIUM","sendToCRM","hook","open","getLivechatRoomGuestInfo","messages","Messages","findVisibleByRoomId","sort","forEach","agentId","push","saveCRMDataByRoomId","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","findOneOpenByVisitorId","closeRoom","comment","roomId","findOneById","usernames","indexOf","LivechatCustomField","find","fetch","check","String","profile","servedBy","getAgentInfo","visitorToken","info","enabled","title","color","registrationForm","triggers","departments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","findOpenByVisitorToken","fields","cl","length","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","agentData","LivechatTrigger","findEnabled","trigger","pick","LivechatDepartment","findEnabledWithAgents","department","findOnlineAgents","count","getVisitorByToken","stampedToken","Accounts","_generateStampedLoginToken","hashStampedToken","_hashStampedToken","updateUser","$set","services","resume","loginTokens","users","update","pageInfo","savePageHistory","registerGuest","call","loginToken","LivechatPageVisited","keepHistoryForToken","removeAgent","customField","removeById","removeDepartment","removeManager","triggerId","validSettings","valid","every","setting","updateById","customFieldData","Match","ObjectIncluding","field","label","scope","visibility","test","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","phone","topic","tags","ret","saveGuest","saveRoomInfo","run","values","s","visitorRoom","formData","undefined","updateData","item","updateSurveyFeedbackById","Maybe","description","Boolean","conditions","Array","actions","isString","findOneByUsername","sendMessageLivechat","guest","findOne","sendMessage","dns","Npm","require","header","placeholders","replace","footer","fromEmail","match","emailDomain","substr","lastIndexOf","wrapAsync","resolveMx","Email","send","to","from","replyTo","subject","substring","DDPRateLimiter","addRule","connectionId","overwrite","updateLivechatDataByToken","Random","id","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","jitsiRoom","CryptoJS","MD5","toString","transferData","departmentId","transfer","postCatchError","options","resolve","err","unblock","sampleData","createdAt","lastMessageAt","customFields","productId","ip","browser","os","customerId","agent","console","log","statusCode","inquiryId","inquiry","LivechatInquiry","subscriptionData","alert","unread","desktopNotifications","mobilePushNotifications","emailNotifications","Subscriptions","changeAgentByRoomId","takeInquiry","createCommandWithRoomIdAndUser","stream","emit","removeByRoomId","removeUsernameById","openInquiry","day","start","finish","LivechatOfficeHour","updateHours","moment","userLanguage","author","datetime","locale","format","singleMessage","emailSettings","setOperator","operator","$exists","$ne","roles","findAgents","findOnlineUserFromList","userList","$in","concat","getNextAgent","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","findVisitorByToken","closeOffice","self","openOffice","livechatData","findOneVisitorByPhone","getNextVisitorUsername","settingsRaw","Settings","saveGuestById","setData","unsetData","visitorEmails","address","phoneNumber","$unset","findOneGuestByEmailAddress","emailAddress","RegExp","escapeRegExp","emails","surveyFeedback","findLivechat","filter","offset","limit","extend","parseInt","getNextLivechatRoomCode","findByVisitorToken","findByVisitorId","visitorId","responseBy","closeByRoomId","closeInfo","closedBy","closedAt","chatDuration","setLabelByRoomId","findOpenByAgent","newAgent","crmData","isClient","_initModel","findByRoomId","_Base","extraData","record","remove","tryEnsureIndex","numAgents","findByDepartmentId","createOrUpdateDepartment","agents","showOnRegistration","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","page","expireAt","findByToken","multi","removeAll","findById","getStatus","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","UAParser","historyMonitorType","logger","Logger","sections","webhook","getAgents","getOnlineAgents","roomInfo","newRoom","dept","routingMethod","QueueMethods","alias","showConnecting","$addToSet","existingUser","userData","globalRoles","joinDefaultChannels","connection","userAgent","httpHeaders","clientAddress","insertUserDoc","number","groupable","hideByRoomIdAndUserId","findNotHiddenPublic","saveRoomById","updateNameByRoomId","closeOpenChats","forwardOpenChats","change","without","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","callback","trying","warn","setTimeout","ua","setUA","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","Streamer","allowRead","roomCode","msgs","agentIds","setInterval","SMS","sms","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","onlineAgents","queue","clearTimeout","exists","runAgentLeaveAction","action","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","$gte","setDate","getDate","setSeconds","getSeconds","$lte","handleDepts","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","register","instance","tabBar","isServer","Notifications","notifyRoom","setHiddenById","template","route","path","openRoom","link","sub","findRoom","identifier","ChatRoom","roomName","condition","hasAllPermission","canSendMessage","getUserStatus","guestName","Session","notSubscribedTpl","addGroup","group","section","i18nDescription","enableQuery","API","v1","addRoute","authRequired","unauthorized","success","bodyParams","Object","failure","urlParams","put","service","rooms","body","extra","fromCountry","fromState","fromCity","role"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport url from 'url';\n\nWebApp = Package.webapp.WebApp;\nconst Autoupdate = Package.autoupdate.Autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tvar domainWhiteList = RocketChat.settings.get('Livechat_AllowedDomainsList');\n\tif (req.headers.referer && !_.isEmpty(domainWhiteList.trim())) {\n\t\tdomainWhiteList = _.map(domainWhiteList.split(','), function(domain) {\n\t\t\treturn domain.trim();\n\t\t});\n\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (!_.contains(domainWhiteList, referer.host)) {\n\t\t\tres.setHeader('X-FRAME-OPTIONS', 'DENY');\n\t\t\treturn next();\n\t\t}\n\n\t\tres.setHeader('X-FRAME-OPTIONS', `ALLOW-FROM ${referer.protocol}//${referer.host}`);\n\t}\n\n\tconst head = Assets.getText('public/head.html');\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"/livechat/livechat.css?_dc=${Autoupdate.autoupdateVersion}\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${JSON.stringify(__meteor_runtime_config__)};\n\t\t\t</script>\n\n\t\t\t${head}\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"/livechat/livechat.js?_dc=${Autoupdate.autoupdateVersion}\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setRoomFind('l', (code) => {\n\t\treturn RocketChat.models.Rooms.findLivechatByCode(code);\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && room.v && room.v._id === user._id;\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en'\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals HTTP, SystemLogger */\n\nvar knowledgeEnabled = false;\nvar apiaiKey = '';\nvar apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage,\n\t\t\t\t\tsessionId: room._id\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\t'Authorization': 'Bearer ' + apiaiKey\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date()\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username\n\t\t\t},\n\t\t\tresponseDate: now,\n\t\t\tresponseTime: (now.getTime() - room.ts) / 1000\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tconst postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email\n\t\t},\n\t\tmessage: data.message\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToCRM(hook, room) {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\t// Do not send to CRM if the chat is still open\n\tif (hook === 'saveLivechatInfo' && room.open) {\n\t\treturn room;\n\t}\n\n\tconst postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\tif (hook === 'closeRoom') {\n\t\tpostData.type = 'LivechatSession';\n\t} else if (hook === 'saveLivechatInfo') {\n\t\tpostData.type = 'LivechatEdit';\n\t}\n\n\tpostData.messages = [];\n\n\tRocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } }).forEach((message) => {\n\t\tif (message.t) {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = {\n\t\t\tusername: message.u.username,\n\t\t\tmsg: message.msg,\n\t\t\tts: message.ts\n\t\t};\n\n\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\tmsg.agentId = message.u._id;\n\t\t}\n\t\tpostData.messages.push(msg);\n\t});\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\treturn sendToCRM('closeRoom', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\treturn sendToCRM('saveLivechatInfo', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeByVisitor'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorId(Meteor.userId());\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst language = (user && user.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser: user,\n\t\t\troom: room,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language })\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1 && !RocketChat.authz.hasPermission(Meteor.userId(), 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser: user,\n\t\t\troom: room,\n\t\t\tcomment: comment\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t}\n});\n","Meteor.methods({\n\t'livechat:getAgentData'(roomId) {\n\t\tcheck(roomId, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst user = Meteor.user();\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || !user.profile || room.v.token !== user.profile.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:getInitialData'(visitorToken) {\n\t\tvar info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null\n\t\t};\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1,\n\t\t\t\tservedBy: 1\n\t\t\t}\n\t\t}).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\n\t\tinfo.agentData = room && room[0] && room[0].servedBy && RocketChat.models.Users.getAgentInfo(room[0].servedBy._id);\n\n\t\tRocketChat.models.LivechatTrigger.findEnabled().forEach((trigger) => {\n\t\t\tinfo.triggers.push(_.pick(trigger, '_id', 'actions', 'conditions'));\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\n\t\treturn info;\n\t}\n});\n","Meteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst user = RocketChat.models.Users.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst stampedToken = Accounts._generateStampedLoginToken();\n\t\tconst hashStampedToken = Accounts._hashStampedToken(stampedToken);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tservices: {\n\t\t\t\t\tresume: {\n\t\t\t\t\t\tloginTokens: [ hashStampedToken ]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tMeteor.users.update(user._id, updateUser);\n\n\t\treturn {\n\t\t\ttoken: stampedToken.token\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, pageInfo) {\n\t\treturn RocketChat.Livechat.savePageHistory(token, pageInfo);\n\t}\n});\n","Meteor.methods({\n\t'livechat:registerGuest': function({ token, name, email, department } = {}) {\n\t\tvar stampedToken = Accounts._generateStampedLoginToken();\n\t\tvar hashStampedToken = Accounts._hashStampedToken(stampedToken);\n\n\t\tconst userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken: token,\n\t\t\tname: name,\n\t\t\temail: email,\n\t\t\tdepartment: department,\n\t\t\tloginToken: hashStampedToken\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn {\n\t\t\tuserId: userId,\n\t\t\ttoken: stampedToken.token\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tvar customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(triggerId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\tcheck(triggerId, String);\n\n\t\treturn RocketChat.models.LivechatTrigger.removeById(triggerId);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveAppearance'(settings) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveAppearance' });\n\t\t}\n\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_email'\n\t\t];\n\n\t\tconst valid = settings.every((setting) => {\n\t\t\treturn validSettings.indexOf(setting._id) !== -1;\n\t\t});\n\n\t\tif (!valid) {\n\t\t\tthrow new Meteor.Error('invalid-setting');\n\t\t}\n\n\t\tsettings.forEach((setting) => {\n\t\t\tRocketChat.settings.updateById(setting._id, setting.value);\n\t\t});\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo': function(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String)\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String)\n\t\t}));\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values['Livechat_webhookUrl'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values['Livechat_webhookUrl']));\n\t\t}\n\n\t\tif (typeof values['Livechat_secret_token'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values['Livechat_secret_token']));\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_close'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values['Livechat_webhook_on_close']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_offline_msg'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values['Livechat_webhook_on_offline_msg']);\n\t\t}\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = RocketChat.models.Users.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && visitor.profile !== undefined && room.v.token === visitor.profile.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (var item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\tcheck(trigger, {\n\t\t\t_id: Match.Maybe(String),\n\t\t\tname: String,\n\t\t\tdescription: String,\n\t\t\tenabled: Boolean,\n\t\t\tconditions: Array,\n\t\t\tactions: Array\n\t\t});\n\n\t\tif (trigger._id) {\n\t\t\treturn RocketChat.models.LivechatTrigger.updateById(trigger._id, trigger);\n\t\t} else {\n\t\t\treturn RocketChat.models.LivechatTrigger.insert(trigger);\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tvar user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t}\n});\n","Meteor.methods({\n\tsendMessageLivechat: function(message) {\n\t\tvar guest;\n\n\t\tcheck(message.rid, String);\n\t\tcheck(message.token, String);\n\n\t\tguest = Meteor.users.findOne(Meteor.userId(), {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.Livechat.sendMessage({ guest: guest, message: message });\n\t}\n});\n","/* globals DDPRateLimiter */\nconst dns = Npm.require('dns');\n\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String\n\t\t});\n\n\t\tif (!RocketChat.settings.get('Livechat_display_offline_form')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tconst message = (data.message + '').replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${data.name}</p>\n\t\t\t<p><strong>Visitor email:</strong> ${data.email}</p>\n\t\t\t<p><strong>Message:</strong><br>${message}</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tif (RocketChat.settings.get('Livechat_validate_offline_email')) {\n\t\t\tconst emailDomain = data.email.substr(data.email.lastIndexOf('@') + 1);\n\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(dns.resolveMx)(emailDomain);\n\t\t\t} catch (e) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email-address', 'Invalid email address', { method: 'livechat:sendOfflineMessage' });\n\t\t\t}\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send({\n\t\t\t\tto: RocketChat.settings.get('Livechat_offline_email'),\n\t\t\t\tfrom: `${data.name} - ${data.email} <${fromEmail}>`,\n\t\t\t\treplyTo: `${data.name} <${data.email}>`,\n\t\t\t\tsubject: `Livechat offline message from ${data.name}: ${(data.message + '').substring(0, 20)}`,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","Meteor.methods({\n\t'livechat:setCustomField'(token, key, value, overwrite = true) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn RocketChat.models.Users.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date()\n\t\t};\n\n\t\tconst { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' }\n\t\t\t]\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + CryptoJS.MD5(RocketChat.settings.get('uniqueID') + roomId).toString()\n\t\t};\n\t}\n});\n\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdepartmentId: Match.Optional(String)\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t}\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcode: 123123,\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3'\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456'\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456'\n\t\t\t\t}\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com'\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date()\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date()\n\t\t\t}]\n\t\t};\n\n\t\tconst options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t},\n\t\t\tdata: sampleData\n\t\t};\n\n\t\tconst response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t}\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username\n\t\t};\n\n\t\t// add subscription\n\t\tvar subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tcode: inquiry.code,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, agent);\n\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// remove sending message from guest widget\n\t\t// dont check if setting is true, because if settingwas switched off inbetween  guest entered pool,\n\t\t// and inquiry being taken, message would not be switched off.\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('connected', room._id, user);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\t// return room corresponding to inquiry (for redirecting agent to the room route)\n\t\treturn room;\n\t}\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\t// //delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove user from room\n\t\tvar username = Meteor.user().username;\n\n\t\tRocketChat.models.Rooms.removeUsernameById(rid, username);\n\n\t\t// find inquiry corresponding to room\n\t\tvar inquiry = RocketChat.models.LivechatInquiry.findOne({rid: rid});\n\n\t\t// mark inquiry as open\n\t\treturn RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t}\n});\n","/* globals emailSettings, DDPRateLimiter */\n/* Send a transcript of the room converstation to the given email */\nimport moment from 'moment';\n\nMeteor.methods({\n\t'livechat:sendTranscript'(rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\tconst user = Meteor.user();\n\t\tconst userLanguage = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || !user.profile || room.v.token !== user.profile.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomId(rid, { sort: { 'ts' : 1 }});\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tvar html = '<div> <hr>';\n\t\tmessages.forEach(message => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar author;\n\t\t\tif (message.u._id === Meteor.userId()) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tvar datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tvar singleMessage = `\n\t\t\t\t<p><strong>${author}</strong>  <em>${datetime}</em></p>\n\t\t\t\t<p>${message.msg}</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = html + '</div>';\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\temailSettings = {\n\t\t\tto: email,\n\t\t\tfrom: fromEmail,\n\t\t\treplyTo: fromEmail,\n\t\t\tsubject: TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage }),\n\t\t\thtml: header + html + footer\n\t\t};\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send(emailSettings);\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tvar update = {\n\t\t$set: {\n\t\t\toperator: operator\n\t\t}\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tvar query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tvar query = {\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tvar query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList)\n\t\t}\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tvar query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\tvar collectionObj = this.model.rawCollection();\n\tvar findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tvar sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1\n\t};\n\n\tvar update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1\n\t\t}\n\t};\n\n\tvar user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.getVisitorByToken = function(token, options) {\n\tvar query = {\n\t\t'profile.guest': true,\n\t\t'profile.token': token\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.findVisitorByToken = function(token) {\n\tvar query = {\n\t\t'profile.guest': true,\n\t\t'profile.token': token\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tconst query = {\n\t\t'_id': userId\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'statusLivechat': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'profile.token': token\n\t};\n\n\tif (!overwrite) {\n\t\tconst user = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (user.livechatData && typeof user.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${key}`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * Find a visitor by their phone number\n * @return {object} User from db\n */\nRocketChat.models.Users.findOneVisitorByPhone = function(phone) {\n\tconst query = {\n\t\t'phone.phoneNumber': phone\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Users.getNextVisitorUsername = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_guest_count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn 'guest-' + (livechatCount.value.value + 1);\n};\n\nRocketChat.models.Users.saveGuestById = function(_id, data) {\n\tconst setData = {};\n\tconst unsetData = {};\n\n\tif (data.name) {\n\t\tif (!_.isEmpty(s.trim(data.name))) {\n\t\t\tsetData.name = s.trim(data.name);\n\t\t} else {\n\t\t\tunsetData.name = 1;\n\t\t}\n\t}\n\n\tif (data.email) {\n\t\tif (!_.isEmpty(s.trim(data.email))) {\n\t\t\tsetData.visitorEmails = [\n\t\t\t\t{ address: s.trim(data.email) }\n\t\t\t];\n\t\t} else {\n\t\t\tunsetData.visitorEmails = 1;\n\t\t}\n\t}\n\n\tif (data.phone) {\n\t\tif (!_.isEmpty(s.trim(data.phone))) {\n\t\t\tsetData.phone = [\n\t\t\t\t{ phoneNumber: s.trim(data.phone) }\n\t\t\t];\n\t\t} else {\n\t\t\tunsetData.phone = 1;\n\t\t}\n\t}\n\n\tconst update = {};\n\n\tif (!_.isEmpty(setData)) {\n\t\tupdate.$set = setData;\n\t}\n\n\tif (!_.isEmpty(unsetData)) {\n\t\tupdate.$unset = unsetData;\n\t}\n\n\tif (_.isEmpty(update)) {\n\t\treturn true;\n\t}\n\n\treturn this.update({ _id }, update);\n};\n\nRocketChat.models.Users.findOneGuestByEmailAddress = function(emailAddress) {\n\tconst query = {\n\t\t'visitorEmails.address': new RegExp('^' + s.escapeRegExp(emailAddress) + '$', 'i')\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Users.getAgentInfo = function(agentId) {\n\tconst query = {\n\t\t_id: agentId\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\temails: 1,\n\t\t\tcustomFields: 1\n\t\t}\n\t};\n\n\treturn this.findOne(query, options);\n};\n","/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id: _id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback: surveyFeedback\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tif (!overwrite) {\n\t\tconst room = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (room.livechatData && typeof room.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${key}`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l'\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset: offset, limit: limit });\n};\n\nRocketChat.models.Rooms.findLivechatByCode = function(code, fields) {\n\tcode = parseInt(code);\n\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\t// if (this.useCache) {\n\t// \treturn this.cache.findByIndex('t,code', ['l', code], options).fetch();\n\t// }\n\n\tconst query = {\n\t\tt: 'l',\n\t\tcode: code\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.getNextLivechatRoomCode = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByVisitorId = function(visitorId) {\n\tconst query = {\n\t\topen: true,\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username\n\t\t\t},\n\t\t\tresponseDate: response.responseDate,\n\t\t\tresponseTime: response.responseTime\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tclosedBy: {\n\t\t\t\t_id: closeInfo.user._id,\n\t\t\t\tusername: closeInfo.user.username\n\t\t\t},\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\tchatDuration: closeInfo.chatDuration\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.setLabelByRoomId = function(roomId, label) {\n\treturn this.update({ _id: roomId }, { $set: { label: label } });\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newAgent) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\n\t\tif (Meteor.isClient) {\n\t\t\tthis._initModel('livechat_external_message');\n\t\t}\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort: sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tvar record = {\n\t\t\tlabel: label,\n\t\t\tscope: scope,\n\t\t\tvisibility: visibility\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id: _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\n\t\tthis.tryEnsureIndex({\n\t\t\tnumAgents: 1,\n\t\t\tenabled: 1\n\t\t});\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, { enabled, name, description, showOnRegistration }, agents) {\n\t\tagents = [].concat(agents);\n\n\t\tvar record = {\n\t\t\tenabled: enabled,\n\t\t\tname: name,\n\t\t\tdescription: description,\n\t\t\tnumAgents: agents.length,\n\t\t\tshowOnRegistration: showOnRegistration\n\t\t};\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id: _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tvar savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tvar agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id: _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id: _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tvar query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId: departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order)\n\t\t\t}\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId: departmentId, agentId: agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tvar agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tvar onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tvar query = {\n\t\t\tdepartmentId: departmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tvar sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1\n\t\t};\n\t\tvar update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1\n\t\t\t}\n\t\t};\n\n\t\tvar collectionObj = this.model.rawCollection();\n\t\tvar findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tvar agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tvar agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tvar onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tvar onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tvar query = {\n\t\t\tdepartmentId: departmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tvar depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tconst query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList\n\t\t\t};\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1\n\t\t\t}\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ 'token': 1 });\n\t\tthis.tryEnsureIndex({ 'ts': 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ 'expireAt': 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tvar keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken: token,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token: token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken: token,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true\n\t\t\t}\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1\n\t\t\t}\n\t\t}, {\n\t\t\tmulti: true\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\tupdateById(_id, data) {\n\t\treturn this.update({ _id }, { $set: data });\n\t}\n\n\tremoveAll() {\n\t\treturn this.remove({});\n\t}\n\n\tfindById(_id) {\n\t\treturn this.find({ _id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n\tfindEnabled() {\n\t\treturn this.find({ enabled: true });\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ code: 1 });\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n\tRocketChat.models.Users.tryEnsureIndex({ 'visitorEmails.address': 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ 'rid': 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ 'name': 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ 'message': 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ 'ts': 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ 'code': 1 }); // (for routing)\n\t\tthis.tryEnsureIndex({ 'agents': 1}); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ 'status': 1}); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'taken' }\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'open' }\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({'_id': inquiryId}).status;\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","import moment from 'moment';\n\nclass LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ 'day': 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ 'start': 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ 'finish': 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ 'open': 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({'day' : 'Monday', 'start' : '08:00', 'finish' : '20:00', 'code' : 1, 'open' : true });\n\t\t\tthis.insert({'day' : 'Tuesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 2, 'open' : true });\n\t\t\tthis.insert({'day' : 'Wednesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 3, 'open' : true });\n\t\t\tthis.insert({'day' : 'Thursday', 'start' : '08:00', 'finish' : '20:00', 'code' : 4, 'open' : true });\n\t\t\tthis.insert({'day' : 'Friday', 'start' : '08:00', 'finish' : '20:00', 'code' : 5, 'open' : true });\n\t\t\tthis.insert({'day' : 'Saturday', 'start' : '08:00', 'finish' : '20:00', 'code' : 6, 'open' : false });\n\t\t\tthis.insert({'day' : 'Sunday', 'start' : '08:00', 'finish' : '20:00', 'code' : 0, 'open' : false });\n\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\t'day': day\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tvar currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tvar todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvar start = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.start, 'dddd:HH:mm');\n\t\tvar finish = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.finish, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tvar result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tvar currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tvar todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvar start = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.start, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tvar currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tvar todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tvar finish = moment.utc(todaysOfficeHours.day + ':' + todaysOfficeHours.finish, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","/* globals HTTP */\nimport UAParser from 'ua-parser-js';\n\nRocketChat.Livechat = {\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook'\n\t\t}\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.getNextAgent();\n\t\t}\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findAgents();\n\t\t}\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t\t}\n\t},\n\tgetRoom(guest, message, roomInfo) {\n\t\tvar room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tvar newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and pick the first\n\t\t\tif (!guest.department) {\n\t\t\t\tvar departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\t\t\t\tif (departments.count() > 0) {\n\t\t\t\t\tdepartments.forEach((dept) => {\n\t\t\t\t\t\tif (!guest.department && dept.showOnRegistration) {\n\t\t\t\t\t\t\tguest.department = dept._id;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo);\n\n\t\t\tnewRoom = true;\n\t\t} else {\n\t\t\troom = Meteor.call('canAccessRoom', message.rid, guest._id);\n\t\t}\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('cannot-acess-room');\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\tsendMessage({ guest, message, roomInfo }) {\n\t\tconst { room, newRoom } = this.getRoom(guest, message, roomInfo);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\n\t\t// return messages;\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom: newRoom, showConnecting: this.showConnecting() });\n\t},\n\tregisterGuest({ token, name, email, department, phone, loginToken, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tprofile: {\n\t\t\t\t\tguest: true,\n\t\t\t\t\ttoken: token\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tconst user = RocketChat.models.Users.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t\tif (loginToken) {\n\t\t\t\tif (!updateUser.$addToSet) {\n\t\t\t\t\tupdateUser.$addToSet = {};\n\t\t\t\t}\n\t\t\t\tupdateUser.$addToSet['services.resume.loginTokens'] = loginToken;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = RocketChat.models.Users.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tvar existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = RocketChat.models.Users.findOneGuestByEmailAddress(email))) {\n\t\t\t\tif (loginToken) {\n\t\t\t\t\tif (!updateUser.$addToSet) {\n\t\t\t\t\t\tupdateUser.$addToSet = {};\n\t\t\t\t\t}\n\t\t\t\t\tupdateUser.$addToSet['services.resume.loginTokens'] = loginToken;\n\t\t\t\t}\n\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\t\t\t\tupdateUser.$set.name = name;\n\n\t\t\t\tvar userData = {\n\t\t\t\t\tusername: username,\n\t\t\t\t\tglobalRoles: ['livechat-guest'],\n\t\t\t\t\tdepartment: department,\n\t\t\t\t\ttype: 'visitor',\n\t\t\t\t\tjoinDefaultChannels: false\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = Accounts.insertUserDoc({}, userData);\n\n\t\t\t\tif (loginToken) {\n\t\t\t\t\tupdateUser.$set.services = {\n\t\t\t\t\t\tresume: {\n\t\t\t\t\t\t\tloginTokens: [ loginToken ]\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number }\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.visitorEmails = [\n\t\t\t\t{ address: email }\n\t\t\t];\n\t\t}\n\n\t\tMeteor.users.update(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tconst updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = RocketChat.models.Users.saveGuestById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, room, comment }) {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username\n\t\t\t},\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000\n\t\t});\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, user._id);\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, user);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tgetInitSettings() {\n\t\tconst settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message'\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif (!RocketChat.models.Rooms.saveRoomById(roomData._id, roomData)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setLabelByRoomId(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment});\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\t\t\treturn RocketChat.models.LivechatPageVisited.saveByToken(token, pageInfo);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t}\n\n\t\tconst servedBy = room.servedBy;\n\n\t\tif (agent && agent.agentId !== servedBy._id) {\n\t\t\troom.usernames = _.without(room.usernames, servedBy.username).concat(agent.username);\n\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, agent);\n\n\t\t\tconst subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tcode: room.code,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all'\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: servedBy._id, username: servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tconst options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t\t},\n\t\t\t\tdata: postData\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error('Response error on ' + trying + ' try ->', e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = RocketChat.models.Users.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tconst postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.label,\n\t\t\ttopic: room.topic,\n\t\t\tcode: room.code,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (ua.getOS().name + ' ' + ua.getOS().version),\n\t\t\t\tbrowser: ua.getBrowser().name && (ua.getBrowser().name + ' ' + ua.getBrowser().version),\n\t\t\t\tcustomFields: visitor.livechatData\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null\n\t\t\t}\n\t\t};\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails[0].address;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone[0].phoneNumber;\n\t\t}\n\n\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tshowOnRegistration: Boolean\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String\n\t\t\t})\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tvar department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t},\n\n\tshowConnecting() {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'Guest_Pool') {\n\t\t\treturn RocketChat.settings.get('Livechat_open_inquiery_show_connecting');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n};\n\nRocketChat.Livechat.stream = new Meteor.Streamer('livechat-room');\nRocketChat.Livechat.stream.allowRead('logged');\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","RocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount' : function(guest, message, roomInfo) {\n\t\tconst agent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\tif (!agent) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tconst subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tcode: roomCode,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\n\t\tRocketChat.models.Rooms.insert(room);\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool' : function(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tvar inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tt: 'l'\n\t\t};\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\treturn room;\n\t}\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = RocketChat.models.Users.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.profile || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nconst onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t}\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status/*, statusConnection*/) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (status === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","Meteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id: _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId: departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tvar self = this;\n\n\tvar handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:appearance', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tconst query = {\n\t\t_id: {\n\t\t\t$in: [\n\t\t\t\t'Livechat_title',\n\t\t\t\t'Livechat_title_color',\n\t\t\t\t'Livechat_display_offline_form',\n\t\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t\t'Livechat_offline_message',\n\t\t\t\t'Livechat_offline_success_message',\n\t\t\t\t'Livechat_offline_title',\n\t\t\t\t'Livechat_offline_title_color',\n\t\t\t\t'Livechat_offline_email'\n\t\t\t]\n\t\t}\n\t};\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.find(query).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatAppearance', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatAppearance', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatAppearance', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tvar self = this;\n\n\tvar handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tvar self = this;\n\n\tvar handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(Date),\n\t\tto: Match.Maybe(Date)\n\t});\n\n\tconst query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from) {\n\t\tquery.ts = {\n\t\t\t$gte: filter.from\n\t\t};\n\t}\n\tif (filter.to) {\n\t\tfilter.to.setDate(filter.to.getDate() + 1);\n\t\tfilter.to.setSeconds(filter.to.getSeconds() - 1);\n\n\t\tif (!query.ts) {\n\t\t\tquery.ts = {};\n\t\t}\n\t\tquery.ts.$lte = filter.to;\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.findLivechat(query, offset, limit).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatRoom', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatRoom', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatRoom', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tconst self = this;\n\n\tconst handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:triggers', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatTrigger.findById(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatTrigger.find();\n\t}\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tvar room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (room.usernames.indexOf(user.username) === -1) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (room && room.v && room.v._id) {\n\t\t// CACHE: can we stop using publications here?\n\t\treturn RocketChat.models.Rooms.findByVisitorId(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tvar room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn RocketChat.models.Users.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tvar room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v.token) {\n\t\treturn RocketChat.models.LivechatPageVisited.findByToken(room.v.token);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tconst query = {\n\t\tagents: this.userId,\n\t\tstatus: 'open'\n\t};\n\n\treturn RocketChat.models.LivechatInquiry.find(query);\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});\n","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\n","Meteor.startup(() => {\n\tvar roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request'\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(message, params, instance) {\n\tif (Meteor.isClient) {\n\t\tinstance.tabBar.open('video');\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/*, params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language })\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","/* globals openRoom, LivechatInquiry */\n\nRocketChat.roomTypes.add('l', 5, {\n\ttemplate: 'livechat',\n\ticon: 'icon-chat-empty',\n\troute: {\n\t\tname: 'live',\n\t\tpath: '/live/:code(\\\\d+)',\n\t\taction(params/*, queryParams*/) {\n\t\t\topenRoom('l', params.code);\n\t\t},\n\t\tlink(sub) {\n\t\t\treturn {\n\t\t\t\tcode: sub.code\n\t\t\t};\n\t\t}\n\t},\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({ code: parseInt(identifier) });\n\t},\n\n\troomName(roomData) {\n\t\tif (!roomData.name) {\n\t\t\treturn roomData.label;\n\t\t} else {\n\t\t\treturn roomData.name;\n\t\t}\n\t},\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t},\n\n\tcanSendMessage(roomId) {\n\t\tconst room = ChatRoom.findOne({ _id: roomId }, { fields: { open: 1 } });\n\t\treturn room && room.open === true;\n\t},\n\n\tgetUserStatus(roomId) {\n\t\tlet guestName;\n\t\tconst room = Session.get('roomData' + roomId);\n\n\t\tif (room) {\n\t\t\tguestName = room.v && room.v.username;\n\t\t} else {\n\t\t\tconst inquiry = LivechatInquiry.findOne({ rid: roomId });\n\t\t\tguestName = inquiry && inquiry.v && inquiry.v.username;\n\t\t}\n\n\t\tif (guestName) {\n\t\t\treturn Session.get('user_' + guestName + '_status');\n\t\t}\n\t},\n\n\tnotSubscribedTpl: {\n\t\ttemplate: 'livechatNotSubscribed'\n\t}\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', { type: 'color', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form'\n\t});\n\n\tRocketChat.settings.add('Livechat_validate_offline_email', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Validate_email_address'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title'\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color'\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', 'We are not online right now. Please leave us a message:', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message'\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline'\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_preregistration_form' });\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' }\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Webhook_URL'\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Secret_token'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language'\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' }\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tvalues: [\n\t\t\t{key: 'Least_Amount', i18nLabel: 'Least_Amount'},\n\t\t\t{key: 'Guest_Pool', i18nLabel: 'Guest_Pool'}\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Show_queue_list_to_all_agents'\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_hours_enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', 'Would you like a copy of this chat emailed?', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_open_inquiery_show_connecting', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_open_inquiery_show_connecting',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_AllowedDomainsList', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_AllowedDomainsList',\n\t\ti18nDescription: 'Domains_allowed_to_embed_the_livechat_widget'\n\t});\n});\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch()\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: department,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","RocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tvar visitor = RocketChat.models.Users.findOneVisitorByPhone(sms.from);\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id()\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.profile.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.profile.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t}\n});\n","RocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tconst users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map(user => ({ _id: user._id, username: user.username }))\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username')\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n"]}