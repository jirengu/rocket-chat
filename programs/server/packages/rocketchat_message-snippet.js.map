{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/methods/snippetMessage.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/requests.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/publications/snippetedMessagesByRoom.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/publications/snippetedMessage.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","models","Permissions","upsert","$setOnInsert","roles","methods","snippetMessage","message","filename","userId","Error","method","room","Rooms","findOne","_id","rid","Array","isArray","usernames","indexOf","user","username","get","Messages","cloneAndSaveAsHistoryById","me","Users","findOneById","snippeted","snippetedAt","Date","now","snippetedBy","callbacks","run","setSnippetedByIdAndUserId","createWithTypeRoomIdMessageAndUser","WebApp","connectHandlers","use","req","res","cookie","rawCookies","ref","token","uid","Cookies","headers","query","rc_uid","rc_token","findOneByIdAndLoginToken","writeHead","end","match","exec","url","snippet","undefined","setHeader","encodeURIComponent","snippetName","snippetContent","msg","substr","length","write","publish","limit","ready","publication","cursorHandle","findSnippetedByRoom","sort","ts","observeChanges","added","record","changed","removed","onStop","stop","roomSnippetQuery","cursor","find"],"mappings":"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","file":"/packages/rocketchat_message-snippet.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('Message_AllowSnippeting', false, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\tgroup: 'Message'\n\t});\n\tRocketChat.models.Permissions.upsert('snippet-message', {\n\t\t$setOnInsert: {\n\t\t\troles: ['owner', 'moderator', 'admin']\n\t\t}\n\t});\n});\n\n","Meteor.methods({\n\tsnippetMessage: function(message, filename) {\n\t\tif ((typeof Meteor.userId() === 'undefined') || (Meteor.userId() === null)) {\n\t\t\t//noinspection JSUnresolvedFunction\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user',\n\t\t\t\t{method: 'snippetMessage'});\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOne({ _id: message.rid });\n\n\t\tif ((typeof room === 'undefined') || (room === null)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (Array.isArray(room.usernames) && (room.usernames.indexOf(Meteor.user().username) === -1)) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// If we keep history of edits, insert a new message to store history information\n\t\tif (RocketChat.settings.get('Message_KeepHistory')) {\n\t\t\tRocketChat.models.Messages.cloneAndSaveAsHistoryById(message._id);\n\t\t}\n\n\t\tconst me = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tmessage.snippeted = true;\n\t\tmessage.snippetedAt = Date.now;\n\t\tmessage.snippetedBy = {\n\t\t\t_id: Meteor.userId(),\n\t\t\tusername: me.username\n\t\t};\n\n\t\tmessage = RocketChat.callbacks.run('beforeSaveMessage', message);\n\n\t\t// Create the SnippetMessage\n\t\tRocketChat.models.Messages.setSnippetedByIdAndUserId(message, filename, message.snippetedBy,\n\t\t\tmessage.snippeted, Date.now, filename);\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser(\n\t\t\t'message_snippeted', message.rid, '', me, {\t'snippetId': message._id, 'snippetName': filename });\n\t}\n});\n","/* global Cookies */\nWebApp.connectHandlers.use('/snippet/download', function(req, res) {\n\tvar cookie, rawCookies, ref, token, uid;\n\tcookie = new Cookies();\n\n\tif ((typeof req !== 'undefined' && req !== null ? (ref = req.headers) !== null ? ref.cookie : void 0 : void 0) !== null) {\n\t\trawCookies = req.headers.cookie;\n\t}\n\n\tif (rawCookies !== null) {\n\t\tuid = cookie.get('rc_uid', rawCookies);\n\t}\n\n\tif (rawCookies !== null) {\n\t\ttoken = cookie.get('rc_token', rawCookies);\n\t}\n\n\tif (uid === null) {\n\t\tuid = req.query.rc_uid;\n\t\ttoken = req.query.rc_token;\n\t}\n\n\tconst user = RocketChat.models.Users.findOneByIdAndLoginToken(uid, token);\n\n\tif (!(uid && token && user)) {\n\t\tres.writeHead(403);\n\t\tres.end();\n\t\treturn false;\n\t}\n\tvar match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst snippet = RocketChat.models.Messages.findOne(\n\t\t\t{\n\t\t\t\t'_id': match[1],\n\t\t\t\t'snippeted': true\n\t\t\t}\n\t\t);\n\t\tconst room = RocketChat.models.Rooms.findOne({ '_id': snippet.rid, 'usernames': { '$in': [user.username] }});\n\t\tif (room === undefined) {\n\t\t\tres.writeHead(403);\n\t\t\tres.end();\n\t\t\treturn false;\n\t\t}\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(snippet.snippetName)}`);\n\t\tres.setHeader('Content-Type', 'application/octet-stream');\n\n\t\t// Removing the ``` contained in the msg.\n\t\tconst snippetContent = snippet.msg.substr(3, snippet.msg.length - 6);\n\t\tres.setHeader('Content-Length', snippetContent.length);\n\t\tres.write(snippetContent);\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","Meteor.publish('snippetedMessages', function(rid, limit=50) {\n\tif (typeof this.userId === 'undefined' || this.userId === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst publication = this;\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (typeof user === 'undefined' || user === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst cursorHandle = RocketChat.models.Messages.findSnippetedByRoom(\n\t\trid,\n\t\t{\n\t\t\tsort: {ts: -1},\n\t\t\tlimit: limit\n\t\t}\n\t).observeChanges({\n\t\tadded: function(_id, record) {\n\t\t\tpublication.added('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tchanged: function(_id, record) {\n\t\t\tpublication.changed('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tremoved: function(_id) {\n\t\t\tpublication.removed('rocketchat_snippeted_message', _id);\n\t\t}\n\t});\n\tthis.ready();\n\n\tthis.onStop = function() {\n\t\tcursorHandle.stop();\n\t};\n});\n","Meteor.publish('snippetedMessage', function(_id) {\n\tif (typeof this.userId === 'undefined' || this.userId === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst snippet = RocketChat.models.Messages.findOne({'_id': _id, snippeted: true});\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\tconst roomSnippetQuery = {\n\t\t'_id': snippet.rid,\n\t\t'usernames': {\n\t\t\t'$in': [\n\t\t\t\tuser.username\n\t\t\t]\n\t\t}\n\t};\n\n\tif (RocketChat.models.Rooms.findOne(roomSnippetQuery) === undefined) {\n\t\treturn this.ready();\n\t}\n\n\tconst publication = this;\n\n\n\tif (typeof user === 'undefined' || user === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst cursor = RocketChat.models.Messages.find(\n\t\t{ '_id': _id }\n\t).observeChanges({\n\t\tadded: function(_id, record) {\n\t\t\tpublication.added('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tchanged: function(_id, record) {\n\t\t\tpublication.changed('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tremoved: function(_id) {\n\t\t\tpublication.removed('rocketchat_snippeted_message', _id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop = function() {\n\t\tcursor.stop();\n\t};\n});\n"]}