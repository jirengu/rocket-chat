{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/configFileUploadAmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/configFileUploadFileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/configFileUploadGoogleStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/configFileUploadGridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/getS3FileUrl.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js"],"names":["filesize","module","import","v","slingShotConfig","authorize","file","userId","Meteor","Error","RocketChat","fileUploadIsValidContentType","type","TAPi18n","__","maxFileSize","settings","get","size","maxSize","allowedFileTypes","Slingshot","fileRestrictions","FileUpload","validateFileUpload","Match","test","rid","String","user","room","models","Rooms","findOneById","directMessageAllow","fileUploadAllowed","authz","canAccessRoom","reason","language","t","parseInt","key","value","UploadFS","config","defaultStorePermissions","StorePermissions","insert","update","doc","remove","hasPermission","FileUploadBase","meta","id","Random","getProgress","getFileName","name","start","stop","mime","handlers","addHandler","store","handler","delete","fileId","Uploads","_id","req","res","next","call","writeHead","end","addExtensionTo","lookup","ext","extension","RegExp","protectedFiles","WebApp","connectHandlers","use","match","exec","url","public","sandstorm","rawCookies","ref","token","uid","cookie","Cookies","headers","query","rc_uid","rc_token","Users","findOneByIdAndLoginToken","crypto","Npm","require","S3accessKey","S3secretKey","S3expiryTimeSpan","generateURL","s3","resourceURL","bucket","path","expires","Date","getTime","Math","max","StringToSign","signature","createHmac","Buffer","digest","encodeURIComponent","fileUrl","setHeader","AWS","S3","request","deleteObject","Bucket","Key","send","createS3Directive","_","debounce","directiveName","acl","accessKey","secretKey","cdn","region","bucketUrl","accessKeyId","secretAccessKey","isEmpty","_directives","AWSAccessKeyId","AWSSecretAccessKey","metaContext","hostname","upload","insertFileInit","createDirective","S3Storage","e","SystemLogger","error","message","storeName","FileSystemStore","createFileSystemStore","stores","getStores","Local","collection","model","filter","Filter","onCheck","transformWrite","readStream","writeStream","RocketChatFile","enabled","pipe","stream","identify","err","data","format","undefined","indexOf","Orientation","gm","autoOrient","fs","filePath","getFilePath","stat","wrapAsync","isFile","uploadedAt","toUTCString","getReadStream","generateUrlParts","accessId","secret","googleCloudStorage","generateGetURL","parts","createSign","sign","generateDeleteUrl","console","warn","HTTP","createGoogleStorageDirective","GoogleAccessId","GoogleSecretKey","_googleCloudStorageKey","GoogleCloud","zlib","util","logger","Logger","ExtractRange","options","bytes_read","Transform","inherits","prototype","_transform","chunk","enc","cb","length","newchunk","slice","push","getByteRange","header","matches","readFromGridFS","getStore","rs","ws","PassThrough","on","onReadError","emit","accept","transformRead","range","out_of_range","createGzip","createDeflate","debug","fileStore","methods","roomId","msgData","method","check","avatar","Optional","emoji","alias","groupable","Boolean","msg","updateFileComplete","omit","attachment","title","description","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","audio_url","audio_type","audio_size","video_url","video_type","video_size","Object","assign","ts","attachments","defer","callbacks","run","getS3FileUrl","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery","multiline"],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nconst slingShotConfig = {\n\tauthorize: function(file/*, metaContext*/) {\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-required', 'Please login before posting files');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tconst maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n};\n\nSlingshot.fileRestrictions('rocketchat-uploads', slingShotConfig);\nSlingshot.fileRestrictions('rocketchat-uploads-gs', slingShotConfig);\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (!Match.test(file.rid, String)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tconst room = RocketChat.models.Rooms.findOneById(file.rid);\n\t\tconst directMessageAllow = RocketChat.settings.get('FileUpload_Enabled_Direct');\n\t\tconst fileUploadAllowed = RocketChat.settings.get('FileUpload_Enabled');\n\n\t\tif (RocketChat.authz.canAccessRoom(room, user) !== true) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!fileUploadAllowed) {\n\t\t\tconst reason = TAPi18n.__('FileUpload_Disabled', user.language);\n\t\t\tthrow new Meteor.Error('error-file-upload-disabled', reason);\n\t\t}\n\n\t\tif (!directMessageAllow && room.t === 'd') {\n\t\t\tconst reason = TAPi18n.__('File_not_allowed_direct_messages', user.language);\n\t\t\tthrow new Meteor.Error('error-direct-message-file-upload-not-allowed', reason);\n\t\t}\n\n\t\tif (file.size > maxFileSize) {\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, user.language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (parseInt(maxFileSize) > 0) {\n\t\t\tif (file.size > maxFileSize) {\n\t\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t\t}, user.language);\n\t\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t\t}\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', user.language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\tmaxFileSize = value;\n});","/* globals FileUploadBase:true, UploadFS */\n/* exported FileUploadBase */\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert: function(userId/*, doc*/) {\n\t\treturn userId;\n\t},\n\tupdate: function(userId, doc) {\n\t\treturn userId === doc.userId;\n\t},\n\tremove: function(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t}\n});\n\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart() {\n\n\t}\n\n\tstop() {\n\n\t}\n};\n","/* globals FileUpload:true */\nimport mime from 'mime-type/with-db';\n\nFileUpload.handlers = {};\n\nFileUpload.addHandler = function(store, handler) {\n\tthis.handlers[store] = handler;\n};\n\nFileUpload.delete = function(fileId) {\n\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\n\tif (!file) {\n\t\treturn;\n\t}\n\n\tthis.handlers[file.store].delete(file);\n\n\treturn RocketChat.models.Uploads.remove(file._id);\n};\n\nFileUpload.get = function(file, req, res, next) {\n\tif (file.store && this.handlers && this.handlers[file.store] && this.handlers[file.store].get) {\n\t\tthis.handlers[file.store].get.call(this, file, req, res, next);\n\t} else {\n\t\tres.writeHead(404);\n\t\tres.end();\n\t\treturn;\n\t}\n};\n\nFileUpload.addExtensionTo = function(file) {\n\tif (mime.lookup(file.name) === file.type) {\n\t\treturn file;\n\t}\n\n\tconst ext = mime.extension(file.type);\n\tif (ext && false === new RegExp(`\\.${ext}$`, 'i').test(file.name)) {\n\t\tfile.name = `${file.name}.${ext}`;\n\t}\n\n\treturn file;\n};\n","/* globals FileUpload, WebApp, Cookies */\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nWebApp.connectHandlers.use('/file-upload/', function(req, res, next) {\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst file = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && protectedFiles) {\n\t\t\t\tlet rawCookies, ref, token, uid;\n\t\t\t\tconst cookie = new Cookies();\n\n\t\t\t\tif ((typeof req !== 'undefined' && req !== null ? (ref = req.headers) != null ? ref.cookie : void 0 : void 0) != null) {\n\t\t\t\t\trawCookies = req.headers.cookie;\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\tuid = cookie.get('rc_uid', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\ttoken = cookie.get('rc_token', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (uid == null) {\n\t\t\t\t\tuid = req.query.rc_uid;\n\t\t\t\t\ttoken = req.query.rc_token;\n\t\t\t\t}\n\n\t\t\t\tif (!(uid && token && RocketChat.models.Users.findOneByIdAndLoginToken(uid, token))) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","/* globals Slingshot, FileUpload, AWS, SystemLogger */\nconst crypto = Npm.require('crypto');\n\nlet S3accessKey, S3secretKey, S3expiryTimeSpan;\n\nconst generateURL = function(file) {\n\tif (!file || !file.s3) {\n\t\treturn;\n\t}\n\tconst resourceURL = '/' + file.s3.bucket + '/' + file.s3.path + file._id;\n\tconst expires = parseInt(new Date().getTime() / 1000) + Math.max(5, S3expiryTimeSpan);\n\tconst StringToSign = 'GET\\n\\n\\n' + expires +'\\n'+resourceURL;\n\tconst signature = crypto.createHmac('sha1', S3secretKey).update(new Buffer(StringToSign, 'utf-8')).digest('base64');\n\treturn file.url + '?AWSAccessKeyId='+encodeURIComponent(S3accessKey)+'&Expires='+expires+'&Signature='+encodeURIComponent(signature);\n};\n\nFileUpload.addHandler('s3', {\n\tget(file, req, res) {\n\t\tconst fileUrl = generateURL(file);\n\n\t\tif (fileUrl) {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t}\n\t\tres.end();\n\t},\n\tdelete(file) {\n\t\tconst s3 = new AWS.S3();\n\t\tconst request = s3.deleteObject({\n\t\t\tBucket: file.s3.bucket,\n\t\t\tKey: file.s3.path + file._id\n\t\t});\n\t\trequest.send();\n\t}\n});\n\nconst createS3Directive = _.debounce(() => {\n\tconst directiveName = 'rocketchat-uploads';\n\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tAWS.config.update({\n\t\taccessKeyId: RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId'),\n\t\tsecretAccessKey: RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey')\n\t});\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives[directiveName]) {\n\t\t\tdelete Slingshot._directives[directiveName];\n\t\t}\n\t\tconst config = {\n\t\t\tbucket: bucket,\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey,\n\t\t\tkey: function(file, metaContext) {\n\t\t\t\tconst path = RocketChat.hostname + '/' + metaContext.rid + '/' + this.userId + '/';\n\n\t\t\t\tconst upload = { s3: {\n\t\t\t\t\tbucket,\n\t\t\t\t\tregion,\n\t\t\t\t\tpath\n\t\t\t\t}};\n\t\t\t\tconst fileId = RocketChat.models.Uploads.insertFileInit(metaContext.rid, this.userId, 's3', file, upload);\n\n\t\t\t\treturn path + fileId;\n\t\t\t}\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective(directiveName, Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error configuring S3 ->', e.message);\n\t\t}\n\t} else if (Slingshot._directives[directiveName]) {\n\t\tdelete Slingshot._directives[directiveName];\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Bucket', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Acl', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_AWSAccessKeyId', function(key, value) {\n\tS3accessKey = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey', function(key, value) {\n\tS3secretKey = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan', function(key, value) {\n\tS3expiryTimeSpan = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_CDN', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Region', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_BucketURL', createS3Directive);\n","/* globals FileSystemStore:true, FileUpload, UploadFS, RocketChatFile */\n\nconst storeName = 'fileSystem';\n\nFileSystemStore = null;\n\nconst createFileSystemStore = _.debounce(function() {\n\tconst stores = UploadFS.getStores();\n\tif (stores[storeName]) {\n\t\tdelete stores[storeName];\n\t}\n\tFileSystemStore = new UploadFS.store.Local({\n\t\tcollection: RocketChat.models.Uploads.model,\n\t\tname: storeName,\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath'), //'/tmp/uploads/photos',\n\t\tfilter: new UploadFS.Filter({\n\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t}),\n\t\ttransformWrite: function(readStream, writeStream, fileId, file) {\n\t\t\tif (RocketChatFile.enabled === false || !/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\t\treturn readStream.pipe(writeStream);\n\t\t\t}\n\n\t\t\tlet stream = void 0;\n\n\t\t\tconst identify = function(err, data) {\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t\t}\n\n\t\t\t\tfile.identify = {\n\t\t\t\t\tformat: data.format,\n\t\t\t\t\tsize: data.size\n\t\t\t\t};\n\n\t\t\t\tif ([null, undefined, '', 'Unknown', 'Undefined'].indexOf(data.Orientation) === -1) {\n\t\t\t\t\treturn RocketChatFile.gm(stream).autoOrient().stream().pipe(writeStream);\n\t\t\t\t} else {\n\t\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tstream = RocketChatFile.gm(readStream).identify(identify).stream();\n\t\t\treturn;\n\t\t}\n\t});\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n\nconst fs = Npm.require('fs');\n\nFileUpload.addHandler(storeName, {\n\tget(file, req, res) {\n\t\tconst filePath = FileSystemStore.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tFileSystemStore.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t},\n\n\tdelete(file) {\n\t\treturn FileSystemStore.delete(file._id);\n\t}\n});\n","/* globals FileUpload, Slingshot, SystemLogger */\n\nconst crypto = Npm.require('crypto');\n\nfunction generateUrlParts({ file }) {\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tif (!file || !file.googleCloudStorage || _.isEmpty(accessId) || _.isEmpty(secret)) {\n\t\treturn;\n\t}\n\n\treturn {\n\t\taccessId: encodeURIComponent(accessId),\n\t\tsecret,\n\t\tpath: file.googleCloudStorage.path + file._id\n\t};\n}\n\nfunction generateGetURL({ file }) {\n\tconst parts = generateUrlParts({ file });\n\n\tif (!parts) {\n\t\treturn;\n\t}\n\n\tconst expires = new Date().getTime() + 120000;\n\tconst signature = crypto.createSign('RSA-SHA256').update(`GET\\n\\n\\n${expires}\\n/${file.googleCloudStorage.bucket}/${parts.path}`).sign(parts.secret, 'base64');\n\n\treturn `${file.url}?GoogleAccessId=${parts.accessId}&Expires=${expires}&Signature=${encodeURIComponent(signature)}`;\n}\n\nfunction generateDeleteUrl({ file }) {\n\tconst parts = generateUrlParts({ file });\n\n\tif (!parts) {\n\t\treturn;\n\t}\n\n\tconst expires = new Date().getTime() + 5000;\n\tconst signature = crypto.createSign('RSA-SHA256').update(`DELETE\\n\\n\\n${expires}\\n/${file.googleCloudStorage.bucket}/${encodeURIComponent(parts.path)}`).sign(parts.secret, 'base64');\n\n\treturn `https://${file.googleCloudStorage.bucket}.storage.googleapis.com/${encodeURIComponent(parts.path)}?GoogleAccessId=${parts.accessId}&Expires=${expires}&Signature=${encodeURIComponent(signature)}`;\n}\n\nFileUpload.addHandler('googleCloudStorage', {\n\tget(file, req, res) {\n\t\tconst fileUrl = generateGetURL({ file });\n\n\t\tif (fileUrl) {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t}\n\t\tres.end();\n\t},\n\tdelete(file) {\n\t\tif (!file || !file.googleCloudStorage) {\n\t\t\tconsole.warn('Failed to delete a file which is uploaded to Google Cloud Storage, the file and googleCloudStorage properties are not defined.');\n\t\t\treturn;\n\t\t}\n\n\t\tconst url = generateDeleteUrl({ file });\n\n\t\tif (_.isEmpty(url)) {\n\t\t\tconsole.warn('Failed to delete a file which is uploaded to Google Cloud Storage, failed to generate a delete url.');\n\t\t\treturn;\n\t\t}\n\n\t\tHTTP.call('DELETE', url);\n\t}\n});\n\nconst createGoogleStorageDirective = _.debounce(() => {\n\tconst directiveName = 'rocketchat-uploads-gs';\n\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tif (type === 'GoogleCloudStorage' && !_.isEmpty(secret) && !_.isEmpty(accessId) && !_.isEmpty(bucket)) {\n\t\tif (Slingshot._directives[directiveName]) {\n\t\t\tdelete Slingshot._directives[directiveName];\n\t\t}\n\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tGoogleAccessId: accessId,\n\t\t\tGoogleSecretKey: secret,\n\t\t\tkey: function _googleCloudStorageKey(file, metaContext) {\n\t\t\t\tconst path = RocketChat.settings.get('uniqueID') + '/' + metaContext.rid + '/' + this.userId + '/';\n\t\t\t\tconst fileId = RocketChat.models.Uploads.insertFileInit(metaContext.rid, this.userId, 'googleCloudStorage', file, { googleCloudStorage: { bucket, path }});\n\n\t\t\t\treturn path + fileId;\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tSlingshot.createDirective(directiveName, Slingshot.GoogleCloud, config);\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error configuring GoogleCloudStorage ->', e.message);\n\t\t}\n\t} else {\n\t\tdelete Slingshot._directives[directiveName];\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createGoogleStorageDirective);\nRocketChat.settings.get('FileUpload_GoogleStorage_Bucket', createGoogleStorageDirective);\nRocketChat.settings.get('FileUpload_GoogleStorage_AccessId', createGoogleStorageDirective);\nRocketChat.settings.get('FileUpload_GoogleStorage_Secret', createGoogleStorageDirective);\n","/* globals FileUpload, UploadFS */\nconst stream = Npm.require('stream');\nconst zlib = Npm.require('zlib');\nconst util = Npm.require('util');\nconst logger = new Logger('FileUpload');\n\nfunction ExtractRange(options) {\n\tif (!(this instanceof ExtractRange)) {\n\t\treturn new ExtractRange(options);\n\t}\n\n\tthis.start = options.start;\n\tthis.stop = options.stop;\n\tthis.bytes_read = 0;\n\n\tstream.Transform.call(this, options);\n}\nutil.inherits(ExtractRange, stream.Transform);\n\n\nExtractRange.prototype._transform = function(chunk, enc, cb) {\n\tif (this.bytes_read > this.stop) {\n\t\t// done reading\n\t\tthis.end();\n\t} else if (this.bytes_read + chunk.length < this.start) {\n\t\t// this chunk is still before the start byte\n\t} else {\n\t\tlet start, stop;\n\t\tif (this.start <= this.bytes_read) {\n\t\t\tstart = 0;\n\t\t} else {\n\t\t\tstart = this.start - this.bytes_read;\n\t\t}\n\t\tif ((this.stop - this.bytes_read + 1) < chunk.length) {\n\t\t\tstop = this.stop - this.bytes_read + 1;\n\t\t} else {\n\t\t\tstop = chunk.length;\n\t\t}\n\t\tconst newchunk = chunk.slice(start, stop);\n\t\tthis.push(newchunk);\n\t}\n\tthis.bytes_read += chunk.length;\n\tcb();\n};\n\n\nconst getByteRange = function(header) {\n\tif (header) {\n\t\tconst matches = header.match(/(\\d+)-(\\d+)/);\n\t\tif (matches) {\n\t\t\treturn {\n\t\t\t\tstart: parseInt(matches[1], 10),\n\t\t\t\tstop: parseInt(matches[2], 10)\n\t\t\t};\n\t\t}\n\t}\n\treturn null;\n};\n\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L91\nconst readFromGridFS = function(storeName, fileId, file, headers, req, res) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\tconst ws = new stream.PassThrough();\n\n\trs.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tconst accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\tconst range = getByteRange(req.headers.range);\n\tlet out_of_range = false;\n\tif (range) {\n\t\tout_of_range = (range.start > file.size) || (range.stop <= range.start) || (range.stop > file.size);\n\t}\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/) && range === null) {\n\t\theaders['Content-Encoding'] = 'gzip';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/) && range === null) {\n\t\t// Compress data using deflate\n\t\theaders['Content-Encoding'] = 'deflate';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else if (range && out_of_range) {\n\t\t// out of range request, return 416\n\t\tdelete headers['Content-Length'];\n\t\tdelete headers['Content-Type'];\n\t\tdelete headers['Content-Disposition'];\n\t\tdelete headers['Last-Modified'];\n\t\theaders['Content-Range'] = 'bytes */' + file.size;\n\t\tres.writeHead(416, headers);\n\t\tres.end();\n\t} else if (range) {\n\t\theaders['Content-Range'] = 'bytes ' + range.start + '-' + range.stop + '/' + file.size;\n\t\tdelete headers['Content-Length'];\n\t\theaders['Content-Length'] = range.stop - range.start + 1;\n\t\tres.writeHead(206, headers);\n\t\tlogger.debug('File upload extracting range');\n\t\tws.pipe(new ExtractRange({ start: range.start, stop: range.stop })).pipe(res);\n\t} else {\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(res);\n\t}\n};\n\nFileUpload.addHandler('rocketchat_uploads', {\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst headers = {\n\t\t\t'Content-Disposition': `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`,\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t},\n\tdelete(file) {\n\t\treturn Meteor.fileStore.delete(file._id);\n\t}\n});\n","Meteor.methods({\n\t'sendFileMessage'(roomId, store, file, msgData = {}) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String)\n\t\t});\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tconst fileUrl = '/file-upload/' + file._id + '/' + file.name;\n\n\t\tconst attachment = {\n\t\t\ttitle: `${TAPi18n.__('Attachment_File_Uploaded')}: ${file.name}`,\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tlet msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t}, msgData);\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\n\t\tMeteor.defer(() => RocketChat.callbacks.run('afterFileUpload', { user, room, message: msg }));\n\n\t\treturn msg;\n\t}\n});\n","const crypto = Npm.require('crypto');\nlet protectedFiles, S3accessKey, S3secretKey, S3expiryTimeSpan;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nRocketChat.settings.get('FileUpload_S3_AWSAccessKeyId', function(key, value) {\n\tS3accessKey = value;\n});\n\nRocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey', function(key, value) {\n\tS3secretKey = value;\n});\n\nRocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan', function(key, value) {\n\tS3expiryTimeSpan = value;\n});\n\nMeteor.methods({\n\tgetS3FileUrl(fileId) {\n\t\tif (protectedFiles && !Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\t\tconst resourceURL = '/' + file.s3.bucket + '/' + file.s3.path + file._id;\n\t\tconst expires = parseInt(new Date().getTime() / 1000) + Math.max(5, S3expiryTimeSpan);\n\t\tconst StringToSign = 'GET\\n\\n\\n' + expires +'\\n'+resourceURL;\n\t\tconst signature = crypto.createHmac('sha1', S3secretKey).update(new Buffer(StringToSign, 'utf-8')).digest('base64');\n\t\treturn {\n\t\t\turl:file.url + '?AWSAccessKeyId='+encodeURIComponent(S3accessKey)+'&Expires='+expires+'&Signature='+encodeURIComponent(signature)\n\t\t};\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'GoogleCloudStorage',\n\t\t\ti18nLabel: 'GoogleCloudStorage'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t});\n\n\tthis.section('Google Cloud Storage', function() {\n\t\tthis.add('FileUpload_GoogleStorage_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_AccessId', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Secret', '', {\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.add('FileUpload_Enabled_Direct', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n});\n"]}