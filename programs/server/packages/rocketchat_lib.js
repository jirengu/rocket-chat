(function () {

/* Imports */
var Meteor = Package.meteor.Meteor;
var global = Package.meteor.global;
var meteorEnv = Package.meteor.meteorEnv;
var RateLimiter = Package['rate-limit'].RateLimiter;
var ReactiveVar = Package['reactive-var'].ReactiveVar;
var ReactiveDict = Package['reactive-dict'].ReactiveDict;
var Accounts = Package['accounts-base'].Accounts;
var ECMAScript = Package.ecmascript.ECMAScript;
var Random = Package.random.Random;
var check = Package.check.check;
var Match = Package.check.Match;
var Tracker = Package.tracker.Tracker;
var Deps = Package.tracker.Deps;
var DDPRateLimiter = Package['ddp-rate-limiter'].DDPRateLimiter;
var _ = Package.underscore._;
var MongoInternals = Package.mongo.MongoInternals;
var Mongo = Package.mongo.Mongo;
var s = Package['underscorestring:underscore.string'].s;
var CollectionHooks = Package['matb33:collection-hooks'].CollectionHooks;
var ServiceConfiguration = Package['service-configuration'].ServiceConfiguration;
var Streamer = Package['rocketchat:streamer'].Streamer;
var Logger = Package['rocketchat:logger'].Logger;
var CustomOAuth = Package['rocketchat:custom-oauth'].CustomOAuth;
var FlowRouter = Package['kadira:flow-router'].FlowRouter;
var Symbol = Package['ecmascript-runtime'].Symbol;
var Map = Package['ecmascript-runtime'].Map;
var Set = Package['ecmascript-runtime'].Set;
var meteorBabelHelpers = Package['babel-runtime'].meteorBabelHelpers;
var Promise = Package.promise.Promise;
var meteorInstall = Package.modules.meteorInstall;
var Buffer = Package.modules.Buffer;
var process = Package.modules.process;

/* Package-scope variables */
var __coffeescriptShare, RocketChat, RocketChatTabBar;

var require = meteorInstall({"node_modules":{"meteor":{"rocketchat:lib":{"lib":{"core.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/core.coffee.js                                                                          //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
/*                                                                                                                     //
 * Kick off the global namespace for RocketChat.                                                                       //
 * @namespace RocketChat                                                                                               //
 */RocketChat = {                                                                                                      //
  models: {}                                                                                                           //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getURL.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/getURL.js                                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.getURL = function (path) {                                                                                  // 1
	var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},                                    // 1
	    _ref$cdn = _ref.cdn,                                                                                              // 1
	    cdn = _ref$cdn === undefined ? true : _ref$cdn,                                                                   // 1
	    _ref$full = _ref.full,                                                                                            // 1
	    full = _ref$full === undefined ? false : _ref$full;                                                               // 1
                                                                                                                       //
	var cdnPrefix = _.rtrim(_.trim(RocketChat.settings.get('CDN_PREFIX') || ''), '/');                                    // 2
                                                                                                                       //
	var pathPrefix = _.rtrim(_.trim(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX || ''), '/');                          // 3
                                                                                                                       //
	var basePath = void 0;                                                                                                // 5
                                                                                                                       //
	var finalPath = _.ltrim(_.trim(path), '/');                                                                           // 7
                                                                                                                       //
	if (cdn && cdnPrefix !== '') {                                                                                        // 9
		basePath = cdnPrefix + pathPrefix;                                                                                   // 10
	} else if (full || Meteor.isCordova) {                                                                                // 11
		return Meteor.absoluteUrl(finalPath);                                                                                // 12
	} else {                                                                                                              // 13
		basePath = pathPrefix;                                                                                               // 14
	}                                                                                                                     // 15
                                                                                                                       //
	return basePath + '/' + finalPath;                                                                                    // 17
};                                                                                                                     // 18
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settings.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/settings.coffee.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
/*                                                                                                                     //
 * RocketChat.settings holds all packages settings                                                                     //
 * @namespace RocketChat.settings                                                                                      //
 */RocketChat.settings = {                                                                                             //
  callbacks: {},                                                                                                       //
  regexCallbacks: {},                                                                                                  //
  ts: new Date(),                                                                                                      //
  get: function (_id, callback) {                                                                                      //
    var items, key, ref, ref1, ref2, ref3, ref4, ref5, value;                                                          //
                                                                                                                       //
    if (callback != null) {                                                                                            //
      RocketChat.settings.onload(_id, callback);                                                                       //
                                                                                                                       //
      if (_id === '*' && Meteor.settings != null) {                                                                    //
        ref = Meteor.settings;                                                                                         //
                                                                                                                       //
        for (key in meteorBabelHelpers.sanitizeForInObject(ref)) {                                                     //
          value = ref[key];                                                                                            //
          callback(key, value);                                                                                        //
        }                                                                                                              //
                                                                                                                       //
        return;                                                                                                        //
      }                                                                                                                //
                                                                                                                       //
      if (_.isRegExp(_id)) {                                                                                           //
        ref1 = Meteor.settings;                                                                                        //
                                                                                                                       //
        for (key in meteorBabelHelpers.sanitizeForInObject(ref1)) {                                                    //
          value = ref1[key];                                                                                           //
                                                                                                                       //
          if (_id.test(key)) {                                                                                         //
            callback(key, value);                                                                                      //
          }                                                                                                            //
        }                                                                                                              //
                                                                                                                       //
        return;                                                                                                        //
      }                                                                                                                //
                                                                                                                       //
      if (((ref2 = Meteor.settings) != null ? ref2[_id] : void 0) != null) {                                           //
        return callback(_id, (ref3 = Meteor.settings) != null ? ref3[_id] : void 0);                                   //
      }                                                                                                                //
    } else {                                                                                                           //
      if (_.isRegExp(_id)) {                                                                                           //
        items = [];                                                                                                    //
        ref4 = Meteor.settings;                                                                                        //
                                                                                                                       //
        for (key in meteorBabelHelpers.sanitizeForInObject(ref4)) {                                                    //
          value = ref4[key];                                                                                           //
                                                                                                                       //
          if (_id.test(key)) {                                                                                         //
            items.push({                                                                                               //
              key: key,                                                                                                //
              value: value                                                                                             //
            });                                                                                                        //
          }                                                                                                            //
        }                                                                                                              //
                                                                                                                       //
        return items;                                                                                                  //
      }                                                                                                                //
                                                                                                                       //
      return (ref5 = Meteor.settings) != null ? ref5[_id] : void 0;                                                    //
    }                                                                                                                  //
  },                                                                                                                   //
  set: function (_id, value, callback) {                                                                               //
    return Meteor.call('saveSetting', _id, value, callback);                                                           //
  },                                                                                                                   //
  batchSet: function (settings, callback) {                                                                            //
    var actions, save;                                                                                                 //
                                                                                                                       //
    save = function (setting) {                                                                                        //
      return function (callback) {                                                                                     //
        return Meteor.call('saveSetting', setting._id, setting.value, setting.editor, callback);                       //
      };                                                                                                               //
    };                                                                                                                 //
                                                                                                                       //
    actions = _.map(settings, function (setting) {                                                                     //
      return save(setting);                                                                                            //
    });                                                                                                                //
    return _(actions).reduceRight(_.wrap, function (err, success) {                                                    //
      return callback(err, success);                                                                                   //
    })();                                                                                                              //
  },                                                                                                                   //
  load: function (key, value, initialLoad) {                                                                           //
    var callback, cbKey, cbValue, i, j, len, len1, ref, ref1, ref2, results;                                           //
                                                                                                                       //
    if (RocketChat.settings.callbacks[key] != null) {                                                                  //
      ref = RocketChat.settings.callbacks[key];                                                                        //
                                                                                                                       //
      for (i = 0, len = ref.length; i < len; i++) {                                                                    //
        callback = ref[i];                                                                                             //
        callback(key, value, initialLoad);                                                                             //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    if (RocketChat.settings.callbacks['*'] != null) {                                                                  //
      ref1 = RocketChat.settings.callbacks['*'];                                                                       //
                                                                                                                       //
      for (j = 0, len1 = ref1.length; j < len1; j++) {                                                                 //
        callback = ref1[j];                                                                                            //
        callback(key, value, initialLoad);                                                                             //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    ref2 = RocketChat.settings.regexCallbacks;                                                                         //
    results = [];                                                                                                      //
                                                                                                                       //
    for (cbKey in meteorBabelHelpers.sanitizeForInObject(ref2)) {                                                      //
      cbValue = ref2[cbKey];                                                                                           //
                                                                                                                       //
      if (cbValue.regex.test(key)) {                                                                                   //
        results.push(function () {                                                                                     //
          var l, len2, ref3, results1;                                                                                 //
          ref3 = cbValue.callbacks;                                                                                    //
          results1 = [];                                                                                               //
                                                                                                                       //
          for (l = 0, len2 = ref3.length; l < len2; l++) {                                                             //
            callback = ref3[l];                                                                                        //
            results1.push(callback(key, value, initialLoad));                                                          //
          }                                                                                                            //
                                                                                                                       //
          return results1;                                                                                             //
        }());                                                                                                          //
      } else {                                                                                                         //
        results.push(void 0);                                                                                          //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    return results;                                                                                                    //
  },                                                                                                                   //
  onload: function (key, callback) {                                                                                   //
    var base, base1, i, k, keys, len, name, results;                                                                   //
    keys = [].concat(key);                                                                                             //
    results = [];                                                                                                      //
                                                                                                                       //
    for (i = 0, len = keys.length; i < len; i++) {                                                                     //
      k = keys[i];                                                                                                     //
                                                                                                                       //
      if (_.isRegExp(k)) {                                                                                             //
        if ((base = RocketChat.settings.regexCallbacks)[name = k.source] == null) {                                    //
          base[name] = {                                                                                               //
            regex: k,                                                                                                  //
            callbacks: []                                                                                              //
          };                                                                                                           //
        }                                                                                                              //
                                                                                                                       //
        results.push(RocketChat.settings.regexCallbacks[k.source].callbacks.push(callback));                           //
      } else {                                                                                                         //
        if ((base1 = RocketChat.settings.callbacks)[k] == null) {                                                      //
          base1[k] = [];                                                                                               //
        }                                                                                                              //
                                                                                                                       //
        results.push(RocketChat.settings.callbacks[k].push(callback));                                                 //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    return results;                                                                                                    //
  }                                                                                                                    //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"configLogger.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/configLogger.coffee.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.settings.get('Log_Package', function (key, value) {                                                         //
  return typeof LoggerManager !== "undefined" && LoggerManager !== null ? LoggerManager.showPackage = value : void 0;  //
});                                                                                                                    //
RocketChat.settings.get('Log_File', function (key, value) {                                                            //
  return typeof LoggerManager !== "undefined" && LoggerManager !== null ? LoggerManager.showFileAndLine = value : void 0;
});                                                                                                                    //
RocketChat.settings.get('Log_Level', function (key, value) {                                                           //
  if (value != null) {                                                                                                 //
    if (typeof LoggerManager !== "undefined" && LoggerManager !== null) {                                              //
      LoggerManager.logLevel = parseInt(value);                                                                        //
    }                                                                                                                  //
                                                                                                                       //
    return Meteor.setTimeout(function () {                                                                             //
      return typeof LoggerManager !== "undefined" && LoggerManager !== null ? LoggerManager.enable(true) : void 0;     //
    }, 200);                                                                                                           //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"callbacks.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/callbacks.coffee.js                                                                     //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
/*                                                                                                                     //
 * Callback hooks provide an easy way to add extra steps to common operations.                                         //
 * @namespace RocketChat.callbacks                                                                                     //
 */RocketChat.callbacks = {};                                                                                          //
                                                                                                                       //
if (Meteor.isServer) {                                                                                                 //
  RocketChat.callbacks.showTime = true;                                                                                //
  RocketChat.callbacks.showTotalTime = true;                                                                           //
} else {                                                                                                               //
  RocketChat.callbacks.showTime = false;                                                                               //
  RocketChat.callbacks.showTotalTime = false;                                                                          //
} /*                                                                                                                   //
   * Callback priorities                                                                                               //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.callbacks.priority = {                                                                                      //
  HIGH: -1000,                                                                                                         //
  MEDIUM: 0,                                                                                                           //
  LOW: 1000                                                                                                            //
}; /*                                                                                                                  //
    * Add a callback function to a hook                                                                                //
    * @param {String} hook - The name of the hook                                                                      //
    * @param {Function} callback - The callback function                                                               //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.callbacks.add = function (hook, callback, priority, id) {                                                   //
  var base, cb, err, i, len, ref;                                                                                      //
                                                                                                                       //
  if (priority == null) {                                                                                              //
    priority = RocketChat.callbacks.priority.MEDIUM;                                                                   //
  }                                                                                                                    //
                                                                                                                       //
  if (!_.isNumber(priority)) {                                                                                         //
    priority = RocketChat.callbacks.priority.MEDIUM;                                                                   //
  }                                                                                                                    //
                                                                                                                       //
  callback.priority = priority;                                                                                        //
  callback.id = id || Random.id();                                                                                     //
                                                                                                                       //
  if ((base = RocketChat.callbacks)[hook] == null) {                                                                   //
    base[hook] = [];                                                                                                   //
  }                                                                                                                    //
                                                                                                                       //
  if (RocketChat.callbacks.showTime === true) {                                                                        //
    err = new Error();                                                                                                 //
    callback.stack = err.stack;                                                                                        //
  }                                                                                                                    //
                                                                                                                       //
  ref = RocketChat.callbacks[hook];                                                                                    //
                                                                                                                       //
  for (i = 0, len = ref.length; i < len; i++) {                                                                        //
    cb = ref[i];                                                                                                       //
                                                                                                                       //
    if (cb.id === callback.id) {                                                                                       //
      return;                                                                                                          //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  RocketChat.callbacks[hook].push(callback);                                                                           //
}; /*                                                                                                                  //
    * Remove a callback from a hook                                                                                    //
    * @param {string} hook - The name of the hook                                                                      //
    * @param {string} id - The callback's id                                                                           //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.callbacks.remove = function (hookName, id) {                                                                //
  RocketChat.callbacks[hookName] = _.reject(RocketChat.callbacks[hookName], function (callback) {                      //
    return callback.id === id;                                                                                         //
  });                                                                                                                  //
}; /*                                                                                                                  //
    * Successively run all of a hook's callbacks on an item                                                            //
    * @param {String} hook - The name of the hook                                                                      //
    * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                           //
    * @param {Object} [constant] - An optional constant that will be passed along to each callback                     //
    * @returns {Object} Returns the item after it's been through all the callbacks for this hook                       //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.callbacks.run = function (hook, item, constant) {                                                           //
  var callbacks, result, totalTime;                                                                                    //
  callbacks = RocketChat.callbacks[hook];                                                                              //
                                                                                                                       //
  if (!!(callbacks != null ? callbacks.length : void 0)) {                                                             //
    if (RocketChat.callbacks.showTotalTime === true) {                                                                 //
      totalTime = 0;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    result = _.sortBy(callbacks, function (callback) {                                                                 //
      return callback.priority || RocketChat.callbacks.priority.MEDIUM;                                                //
    }).reduce(function (result, callback) {                                                                            //
      var callbackResult, currentTime, ref, ref1, ref2, time;                                                          //
                                                                                                                       //
      if (RocketChat.callbacks.showTime === true || RocketChat.callbacks.showTotalTime === true) {                     //
        time = Date.now();                                                                                             //
      }                                                                                                                //
                                                                                                                       //
      callbackResult = callback(result, constant);                                                                     //
                                                                                                                       //
      if (RocketChat.callbacks.showTime === true || RocketChat.callbacks.showTotalTime === true) {                     //
        currentTime = Date.now() - time;                                                                               //
        totalTime += currentTime;                                                                                      //
                                                                                                                       //
        if (RocketChat.callbacks.showTime === true) {                                                                  //
          if (Meteor.isServer) {                                                                                       //
            RocketChat.statsTracker.timing('callbacks.time', currentTime, ["hook:" + hook, "callback:" + callback.id]);
          } else {                                                                                                     //
            console.log(String(currentTime), hook, callback.id, (ref = callback.stack) != null ? typeof ref.split === "function" ? (ref1 = ref.split('\n')[2]) != null ? (ref2 = ref1.match(/\(.+\)/)) != null ? ref2[0] : void 0 : void 0 : void 0 : void 0);
          }                                                                                                            //
        }                                                                                                              //
      }                                                                                                                //
                                                                                                                       //
      if (typeof callbackResult === 'undefined') {                                                                     //
        return result;                                                                                                 //
      } else {                                                                                                         //
        return callbackResult;                                                                                         //
      }                                                                                                                //
    }, item);                                                                                                          //
                                                                                                                       //
    if (RocketChat.callbacks.showTotalTime === true) {                                                                 //
      if (Meteor.isServer) {                                                                                           //
        RocketChat.statsTracker.timing('callbacks.totalTime', totalTime, ["hook:" + hook]);                            //
      } else {                                                                                                         //
        console.log(hook + ':', totalTime);                                                                            //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    return result;                                                                                                     //
  } else {                                                                                                             //
    return item;                                                                                                       //
  }                                                                                                                    //
}; /*                                                                                                                  //
    * Successively run all of a hook's callbacks on an item, in async mode (only works on server)                      //
    * @param {String} hook - The name of the hook                                                                      //
    * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                           //
    * @param {Object} [constant] - An optional constant that will be passed along to each callback                     //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.callbacks.runAsync = function (hook, item, constant) {                                                      //
  var callbacks;                                                                                                       //
  callbacks = RocketChat.callbacks[hook];                                                                              //
                                                                                                                       //
  if (Meteor.isServer && !!(callbacks != null ? callbacks.length : void 0)) {                                          //
    Meteor.defer(function () {                                                                                         //
      _.sortBy(callbacks, function (callback) {                                                                        //
        return callback.priority || RocketChat.callbacks.priority.MEDIUM;                                              //
      }).forEach(function (callback) {                                                                                 //
        callback(item, constant);                                                                                      //
      });                                                                                                              //
    });                                                                                                                //
  } else {                                                                                                             //
    return item;                                                                                                       //
  }                                                                                                                    //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"fileUploadRestrictions.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/fileUploadRestrictions.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.fileUploadMediaWhiteList = function () {                                                                    // 1
	var mediaTypeWhiteList = RocketChat.settings.get('FileUpload_MediaTypeWhiteList');                                    // 2
                                                                                                                       //
	if (!mediaTypeWhiteList || mediaTypeWhiteList === '*') {                                                              // 4
		return;                                                                                                              // 5
	}                                                                                                                     // 6
                                                                                                                       //
	return _.map(mediaTypeWhiteList.split(','), function (item) {                                                         // 7
		return item.trim();                                                                                                  // 8
	});                                                                                                                   // 9
};                                                                                                                     // 10
                                                                                                                       //
RocketChat.fileUploadIsValidContentType = function (type) {                                                            // 12
	var list, wildCardGlob, wildcards;                                                                                    // 13
	list = RocketChat.fileUploadMediaWhiteList();                                                                         // 14
                                                                                                                       //
	if (!list || _.contains(list, type)) {                                                                                // 15
		return true;                                                                                                         // 16
	} else {                                                                                                              // 17
		wildCardGlob = '/*';                                                                                                 // 18
		wildcards = _.filter(list, function (item) {                                                                         // 19
			return item.indexOf(wildCardGlob) > 0;                                                                              // 20
		});                                                                                                                  // 21
                                                                                                                       //
		if (_.contains(wildcards, type.replace(/(\/.*)$/, wildCardGlob))) {                                                  // 22
			return true;                                                                                                        // 23
		}                                                                                                                    // 24
	}                                                                                                                     // 25
                                                                                                                       //
	return false;                                                                                                         // 26
};                                                                                                                     // 27
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"placeholders.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/placeholders.js                                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.placeholders = {};                                                                                          // 1
                                                                                                                       //
RocketChat.placeholders.replace = function (str, data) {                                                               // 3
	if (!str) {                                                                                                           // 4
		return '';                                                                                                           // 5
	}                                                                                                                     // 6
                                                                                                                       //
	str = str.replace(/\[Site_Name\]/g, RocketChat.settings.get('Site_Name') || '');                                      // 8
	str = str.replace(/\[Site_URL\]/g, RocketChat.settings.get('Site_Url') || '');                                        // 9
                                                                                                                       //
	if (data) {                                                                                                           // 11
		str = str.replace(/\[name\]/g, data.name || '');                                                                     // 12
		str = str.replace(/\[fname\]/g, _.strLeft(data.name, ' ') || '');                                                    // 13
		str = str.replace(/\[lname\]/g, _.strRightBack(data.name, ' ') || '');                                               // 14
		str = str.replace(/\[email\]/g, data.email || '');                                                                   // 15
		str = str.replace(/\[password\]/g, data.password || '');                                                             // 16
                                                                                                                       //
		if (data.unsubscribe) {                                                                                              // 18
			str = str.replace(/\[unsubscribe\]/g, data.unsubscribe);                                                            // 19
		}                                                                                                                    // 20
	}                                                                                                                     // 21
                                                                                                                       //
	str = str.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + '<br>' + '$2');                                             // 23
	return str;                                                                                                           // 26
};                                                                                                                     // 27
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"promises.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/promises.coffee.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
/*                                                                                                                     //
 * Callback hooks provide an easy way to add extra steps to common operations.                                         //
 * @namespace RocketChat.promises                                                                                      //
 */RocketChat.promises = {}; /*                                                                                        //
                              * Callback priorities                                                                    //
                              */                                                                                       //
RocketChat.promises.priority = {                                                                                       //
  HIGH: -1000,                                                                                                         //
  MEDIUM: 0,                                                                                                           //
  LOW: 1000                                                                                                            //
}; /*                                                                                                                  //
    * Add a callback function to a hook                                                                                //
    * @param {String} hook - The name of the hook                                                                      //
    * @param {Function} callback - The callback function                                                               //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.promises.add = function (hook, callback, priority, id) {                                                    //
  var base, cb, i, len, ref;                                                                                           //
                                                                                                                       //
  if (priority == null) {                                                                                              //
    priority = RocketChat.promises.priority.MEDIUM;                                                                    //
  }                                                                                                                    //
                                                                                                                       //
  if (!_.isNumber(priority)) {                                                                                         //
    priority = RocketChat.promises.priority.MEDIUM;                                                                    //
  }                                                                                                                    //
                                                                                                                       //
  callback.priority = priority;                                                                                        //
  callback.id = id || Random.id();                                                                                     //
                                                                                                                       //
  if ((base = RocketChat.promises)[hook] == null) {                                                                    //
    base[hook] = [];                                                                                                   //
  }                                                                                                                    //
                                                                                                                       //
  ref = RocketChat.promises[hook];                                                                                     //
                                                                                                                       //
  for (i = 0, len = ref.length; i < len; i++) {                                                                        //
    cb = ref[i];                                                                                                       //
                                                                                                                       //
    if (cb.id === callback.id) {                                                                                       //
      return;                                                                                                          //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  RocketChat.promises[hook].push(callback);                                                                            //
}; /*                                                                                                                  //
    * Remove a callback from a hook                                                                                    //
    * @param {string} hook - The name of the hook                                                                      //
    * @param {string} id - The callback's id                                                                           //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.promises.remove = function (hookName, id) {                                                                 //
  RocketChat.promises[hookName] = _.reject(RocketChat.promises[hookName], function (callback) {                        //
    return callback.id === id;                                                                                         //
  });                                                                                                                  //
}; /*                                                                                                                  //
    * Successively run all of a hook's callbacks on an item                                                            //
    * @param {String} hook - The name of the hook                                                                      //
    * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                           //
    * @param {Object} [constant] - An optional constant that will be passed along to each callback                     //
    * @returns {Object} Returns the item after it's been through all the callbacks for this hook                       //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.promises.run = function (hook, item, constant) {                                                            //
  var callbacks;                                                                                                       //
  callbacks = RocketChat.promises[hook];                                                                               //
                                                                                                                       //
  if (!!(callbacks != null ? callbacks.length : void 0)) {                                                             //
    callbacks = _.sortBy(callbacks, function (callback) {                                                              //
      return callback.priority || RocketChat.promises.priority.MEDIUM;                                                 //
    });                                                                                                                //
    return callbacks.reduce(function (previousPromise, callback) {                                                     //
      return new Promise(function (resolve, reject) {                                                                  //
        return previousPromise.then(function (result) {                                                                //
          return callback(result, constant).then(resolve, reject);                                                     //
        });                                                                                                            //
      });                                                                                                              //
    }, Promise.resolve(item));                                                                                         //
  } else {                                                                                                             //
    return Promise.resolve(item);                                                                                      //
  }                                                                                                                    //
}; /*                                                                                                                  //
    * Successively run all of a hook's callbacks on an item, in async mode (only works on server)                      //
    * @param {String} hook - The name of the hook                                                                      //
    * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                           //
    * @param {Object} [constant] - An optional constant that will be passed along to each callback                     //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.promises.runAsync = function (hook, item, constant) {                                                       //
  var callbacks;                                                                                                       //
  callbacks = RocketChat.promises[hook];                                                                               //
                                                                                                                       //
  if (Meteor.isServer && !!(callbacks != null ? callbacks.length : void 0)) {                                          //
    Meteor.defer(function () {                                                                                         //
      _.sortBy(callbacks, function (callback) {                                                                        //
        return callback.priority || RocketChat.promises.priority.MEDIUM;                                               //
      }).forEach(function (callback) {                                                                                 //
        callback(item, constant);                                                                                      //
      });                                                                                                              //
    });                                                                                                                //
  } else {                                                                                                             //
    return item;                                                                                                       //
  }                                                                                                                    //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"roomTypesCommon.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/roomTypesCommon.coffee.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
this.roomTypesCommon = function () {                                                                                   //
  function roomTypesCommon() {}                                                                                        //
                                                                                                                       //
  roomTypesCommon.prototype.roomTypes = {};                                                                            //
  roomTypesCommon.prototype.roomTypesOrder = [];                                                                       //
  roomTypesCommon.prototype.mainOrder = 1; /* Adds a room type to app                                                  //
                                           	@param identifier An identifier to the room type. If a real room, MUST BE the same of `db.rocketchat_room.t` field, if not, can be null
                                           	@param order Order number of the type                                      //
                                           	@param config                                                              //
                                           		template: template name to render on sideNav                              //
                                           		icon: icon class                                                          //
                                           		route:                                                                    //
                                           			name: route name                                                         //
                                           			action: route action function                                            //
                                            */                                                                         //
                                                                                                                       //
  roomTypesCommon.prototype.add = function (identifier, order, config) {                                               //
    var ref, ref1, ref2, routeConfig;                                                                                  //
                                                                                                                       //
    if (identifier == null) {                                                                                          //
      identifier = Random.id();                                                                                        //
    }                                                                                                                  //
                                                                                                                       //
    if (this.roomTypes[identifier] != null) {                                                                          //
      return false;                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    if (order == null) {                                                                                               //
      order = this.mainOrder + 10;                                                                                     //
      this.mainOrder += 10;                                                                                            //
    }                                                                                                                  //
                                                                                                                       //
    this.roomTypesOrder.push({                                                                                         //
      identifier: identifier,                                                                                          //
      order: order                                                                                                     //
    });                                                                                                                //
    this.roomTypes[identifier] = config;                                                                               //
                                                                                                                       //
    if (((ref = config.route) != null ? ref.path : void 0) != null && ((ref1 = config.route) != null ? ref1.name : void 0) != null && ((ref2 = config.route) != null ? ref2.action : void 0) != null) {
      routeConfig = {                                                                                                  //
        name: config.route.name,                                                                                       //
        action: config.route.action                                                                                    //
      };                                                                                                               //
                                                                                                                       //
      if (Meteor.isClient) {                                                                                           //
        routeConfig.triggersExit = [roomExit];                                                                         //
      }                                                                                                                //
                                                                                                                       //
      return FlowRouter.route(config.route.path, routeConfig);                                                         //
    }                                                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  roomTypesCommon.prototype.hasCustomLink = function (roomType) {                                                      //
    var ref, ref1;                                                                                                     //
    return ((ref = this.roomTypes[roomType]) != null ? (ref1 = ref.route) != null ? ref1.link : void 0 : void 0) != null;
  }; /*                                                                                                                //
     	@param roomType: room type (e.g.: c (for channels), d (for direct channels))                                     //
     	@param subData: the user's subscription data                                                                     //
      */                                                                                                               //
                                                                                                                       //
  roomTypesCommon.prototype.getRouteLink = function (roomType, subData) {                                              //
    var ref, ref1, routeData;                                                                                          //
                                                                                                                       //
    if (this.roomTypes[roomType] == null) {                                                                            //
      return false;                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    routeData = {};                                                                                                    //
                                                                                                                       //
    if (((ref = this.roomTypes[roomType]) != null ? (ref1 = ref.route) != null ? ref1.link : void 0 : void 0) != null) {
      routeData = this.roomTypes[roomType].route.link(subData);                                                        //
    } else if ((subData != null ? subData.name : void 0) != null) {                                                    //
      routeData = {                                                                                                    //
        name: subData.name                                                                                             //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return FlowRouter.path(this.roomTypes[roomType].route.name, routeData);                                            //
  };                                                                                                                   //
                                                                                                                       //
  roomTypesCommon.prototype.openRouteLink = function (roomType, subData, queryParams) {                                //
    var ref, ref1, routeData;                                                                                          //
                                                                                                                       //
    if (this.roomTypes[roomType] == null) {                                                                            //
      return false;                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    routeData = {};                                                                                                    //
                                                                                                                       //
    if (((ref = this.roomTypes[roomType]) != null ? (ref1 = ref.route) != null ? ref1.link : void 0 : void 0) != null) {
      routeData = this.roomTypes[roomType].route.link(subData);                                                        //
    } else if ((subData != null ? subData.name : void 0) != null) {                                                    //
      routeData = {                                                                                                    //
        name: subData.name                                                                                             //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return FlowRouter.go(this.roomTypes[roomType].route.name, routeData, queryParams);                                 //
  };                                                                                                                   //
                                                                                                                       //
  return roomTypesCommon;                                                                                              //
}();                                                                                                                   //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"slashCommand.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/slashCommand.coffee.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.slashCommands = {                                                                                           //
  commands: {}                                                                                                         //
};                                                                                                                     //
                                                                                                                       //
RocketChat.slashCommands.add = function (command, callback, options) {                                                 //
  RocketChat.slashCommands.commands[command] = {                                                                       //
    command: command,                                                                                                  //
    callback: callback,                                                                                                //
    params: options != null ? options.params : void 0,                                                                 //
    description: options != null ? options.description : void 0,                                                       //
    clientOnly: (options != null ? options.clientOnly : void 0) || false                                               //
  };                                                                                                                   //
};                                                                                                                     //
                                                                                                                       //
RocketChat.slashCommands.run = function (command, params, item) {                                                      //
  var callback, ref;                                                                                                   //
                                                                                                                       //
  if (((ref = RocketChat.slashCommands.commands[command]) != null ? ref.callback : void 0) != null) {                  //
    callback = RocketChat.slashCommands.commands[command].callback;                                                    //
    return callback(command, params, item);                                                                            //
  }                                                                                                                    //
};                                                                                                                     //
                                                                                                                       //
Meteor.methods({                                                                                                       //
  slashCommand: function (command) {                                                                                   //
    if (!Meteor.userId()) {                                                                                            //
      throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                   //
        method: 'slashCommand'                                                                                         //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    return RocketChat.slashCommands.run(command.cmd, command.params, command.msg);                                     //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Message.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/Message.coffee.js                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.Message = {                                                                                                 //
  parse: function (msg, language) {                                                                                    //
    var messageType, ref;                                                                                              //
    messageType = RocketChat.MessageTypes.getType(msg);                                                                //
                                                                                                                       //
    if ((messageType != null ? messageType.render : void 0) != null) {                                                 //
      return messageType.render(msg);                                                                                  //
    } else if ((messageType != null ? messageType.template : void 0) != null) {} else if ((messageType != null ? messageType.message : void 0) != null) {
      if (!language && (typeof localStorage !== "undefined" && localStorage !== null ? localStorage.getItem('userLanguage') : void 0)) {
        language = localStorage.getItem('userLanguage');                                                               //
      }                                                                                                                //
                                                                                                                       //
      if ((typeof messageType.data === "function" ? messageType.data(msg) : void 0) != null) {                         //
        return TAPi18n.__(messageType.message, messageType.data(msg), language);                                       //
      } else {                                                                                                         //
        return TAPi18n.__(messageType.message, {}, language);                                                          //
      }                                                                                                                //
    } else {                                                                                                           //
      if (((ref = msg.u) != null ? ref.username : void 0) === RocketChat.settings.get('Chatops_Username')) {           //
        msg.html = msg.msg;                                                                                            //
        return msg.html;                                                                                               //
      }                                                                                                                //
                                                                                                                       //
      msg.html = msg.msg;                                                                                              //
                                                                                                                       //
      if (_.trim(msg.html) !== '') {                                                                                   //
        msg.html = _.escapeHTML(msg.html);                                                                             //
      }                                                                                                                //
                                                                                                                       //
      msg.html = msg.html.replace(/\n/gm, '<br/>');                                                                    //
      return msg.html;                                                                                                 //
    }                                                                                                                  //
  }                                                                                                                    //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"MessageTypes.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/MessageTypes.coffee.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.MessageTypes = new (function () {                                                                           //
  var getType, isSystemMessage, registerType, types;                                                                   //
                                                                                                                       //
  function _Class() {}                                                                                                 //
                                                                                                                       //
  types = {};                                                                                                          //
                                                                                                                       //
  registerType = function (options) {                                                                                  //
    return types[options.id] = options;                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  getType = function (message) {                                                                                       //
    return types[message != null ? message.t : void 0];                                                                //
  };                                                                                                                   //
                                                                                                                       //
  isSystemMessage = function (message) {                                                                               //
    var ref;                                                                                                           //
    return (ref = types[message != null ? message.t : void 0]) != null ? ref.system : void 0;                          //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.registerType = registerType;                                                                        //
  _Class.prototype.getType = getType;                                                                                  //
  _Class.prototype.isSystemMessage = isSystemMessage;                                                                  //
  return _Class;                                                                                                       //
}())();                                                                                                                //
Meteor.startup(function () {                                                                                           //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'r',                                                                                                           //
    system: true,                                                                                                      //
    message: 'Room_name_changed',                                                                                      //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        room_name: message.msg,                                                                                        //
        user_by: message.u.username                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'au',                                                                                                          //
    system: true,                                                                                                      //
    message: 'User_added_by',                                                                                          //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user_added: message.msg,                                                                                       //
        user_by: message.u.username                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'ru',                                                                                                          //
    system: true,                                                                                                      //
    message: 'User_removed_by',                                                                                        //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user_removed: message.msg,                                                                                     //
        user_by: message.u.username                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'ul',                                                                                                          //
    system: true,                                                                                                      //
    message: 'User_left',                                                                                              //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user_left: message.u.username                                                                                  //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'uj',                                                                                                          //
    system: true,                                                                                                      //
    message: 'User_joined_channel',                                                                                    //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user: message.u.username                                                                                       //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'wm',                                                                                                          //
    system: true,                                                                                                      //
    message: 'Welcome',                                                                                                //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user: message.u.username                                                                                       //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'rm',                                                                                                          //
    system: true,                                                                                                      //
    message: 'Message_removed',                                                                                        //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user: message.u.username                                                                                       //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'rtc',                                                                                                         //
    render: function (message) {                                                                                       //
      return RocketChat.callbacks.run('renderRtcMessage', message);                                                    //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'user-muted',                                                                                                  //
    system: true,                                                                                                      //
    message: 'User_muted_by',                                                                                          //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user_muted: message.msg,                                                                                       //
        user_by: message.u.username                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'user-unmuted',                                                                                                //
    system: true,                                                                                                      //
    message: 'User_unmuted_by',                                                                                        //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        user_unmuted: message.msg,                                                                                     //
        user_by: message.u.username                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'subscription-role-added',                                                                                     //
    system: true,                                                                                                      //
    message: '__username__was_set__role__by__user_by_',                                                                //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        username: message.msg,                                                                                         //
        role: message.role,                                                                                            //
        user_by: message.u.username                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'subscription-role-removed',                                                                                   //
    system: true,                                                                                                      //
    message: '__username__is_no_longer__role__defined_by__user_by_',                                                   //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        username: message.msg,                                                                                         //
        role: message.role,                                                                                            //
        user_by: message.u.username                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.MessageTypes.registerType({                                                                               //
    id: 'room-archived',                                                                                               //
    system: true,                                                                                                      //
    message: 'This_room_has_been_archived_by__username_',                                                              //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        username: message.u.username                                                                                   //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
  return RocketChat.MessageTypes.registerType({                                                                        //
    id: 'room-unarchived',                                                                                             //
    system: true,                                                                                                      //
    message: 'This_room_has_been_unarchived_by__username_',                                                            //
    data: function (message) {                                                                                         //
      return {                                                                                                         //
        username: message.u.username                                                                                   //
      };                                                                                                               //
    }                                                                                                                  //
  });                                                                                                                  //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"startup":{"settingsOnLoadSiteUrl.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/startup/settingsOnLoadSiteUrl.coffee.js                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.settings.get('Site_Url', function (key, value) {                                                            //
  var host, match, prefix, ref;                                                                                        //
                                                                                                                       //
  if ((value != null ? value.trim() : void 0) !== '') {                                                                //
    host = value.replace(/\/$/, '');                                                                                   //
    prefix = "";                                                                                                       //
    match = value.match(/([^\/]+\/{2}[^\/]+)(\/.+)/);                                                                  //
                                                                                                                       //
    if (match != null) {                                                                                               //
      host = match[1];                                                                                                 //
      prefix = match[2].replace(/\/$/, '');                                                                            //
    }                                                                                                                  //
                                                                                                                       //
    __meteor_runtime_config__.ROOT_URL = host;                                                                         //
                                                                                                                       //
    if (((ref = Meteor.absoluteUrl.defaultOptions) != null ? ref.rootUrl : void 0) != null) {                          //
      Meteor.absoluteUrl.defaultOptions.rootUrl = host;                                                                //
    }                                                                                                                  //
                                                                                                                       //
    if (Meteor.isServer) {                                                                                             //
      RocketChat.hostname = host.replace(/^https?:\/\//, '');                                                          //
      process.env.MOBILE_ROOT_URL = host;                                                                              //
      process.env.MOBILE_DDP_URL = host;                                                                               //
                                                                                                                       //
      if (typeof WebAppInternals !== "undefined" && WebAppInternals !== null ? WebAppInternals.generateBoilerplate : void 0) {
        return WebAppInternals.generateBoilerplate();                                                                  //
      }                                                                                                                //
    }                                                                                                                  //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}},"server":{"lib":{"debug.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/debug.js                                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var logger = new Logger('Meteor', {                                                                                    // 1
	methods: {                                                                                                            // 2
		method: {                                                                                                            // 3
			type: 'debug'                                                                                                       // 4
		},                                                                                                                   // 3
		publish: {                                                                                                           // 6
			type: 'debug'                                                                                                       // 7
		}                                                                                                                    // 6
	}                                                                                                                     // 2
});                                                                                                                    // 1
                                                                                                                       //
var wrapMethods = function (name, originalHandler, methodsMap) {                                                       // 12
	methodsMap[name] = function () {                                                                                      // 13
		var args = name === 'ufsWrite' ? Array.prototype.slice.call(arguments, 1) : arguments;                               // 14
		logger.method(name, '-> userId:', Meteor.userId(), ', arguments: ', args);                                           // 15
		return originalHandler.apply(this, arguments);                                                                       // 17
	};                                                                                                                    // 18
};                                                                                                                     // 19
                                                                                                                       //
var originalMeteorMethods = Meteor.methods;                                                                            // 21
                                                                                                                       //
Meteor.methods = function (methodMap) {                                                                                // 23
	_.each(methodMap, function (handler, name) {                                                                          // 24
		wrapMethods(name, handler, methodMap);                                                                               // 25
	});                                                                                                                   // 26
                                                                                                                       //
	originalMeteorMethods(methodMap);                                                                                     // 27
};                                                                                                                     // 28
                                                                                                                       //
var originalMeteorPublish = Meteor.publish;                                                                            // 30
                                                                                                                       //
Meteor.publish = function (name, func) {                                                                               // 32
	return originalMeteorPublish(name, function () {                                                                      // 33
		logger.publish(name, '-> userId:', this.userId, ', arguments: ', arguments);                                         // 34
		return func.apply(this, arguments);                                                                                  // 36
	});                                                                                                                   // 37
};                                                                                                                     // 38
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"bugsnag.js":["bugsnag",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/bugsnag.js                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var bugsnag = void 0;                                                                                                  // 1
module.import('bugsnag', {                                                                                             // 1
	"default": function (v) {                                                                                             // 1
		bugsnag = v;                                                                                                         // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
RocketChat.bugsnag = bugsnag;                                                                                          // 3
RocketChat.settings.get('Bugsnag_api_key', function (key, value) {                                                     // 5
	if (value) {                                                                                                          // 6
		bugsnag.register(value);                                                                                             // 7
	}                                                                                                                     // 8
});                                                                                                                    // 9
                                                                                                                       //
var notify = function (message, stack) {                                                                               // 11
	if (typeof stack === 'string') {                                                                                      // 12
		message += ' ' + stack;                                                                                              // 13
	}                                                                                                                     // 14
                                                                                                                       //
	var options = {};                                                                                                     // 15
                                                                                                                       //
	if (RocketChat.Info) {                                                                                                // 16
		options = {                                                                                                          // 17
			app: {                                                                                                              // 17
				version: RocketChat.Info.version,                                                                                  // 17
				info: RocketChat.Info                                                                                              // 17
			}                                                                                                                   // 17
		};                                                                                                                   // 17
	}                                                                                                                     // 18
                                                                                                                       //
	var error = new Error(message);                                                                                       // 19
	error.stack = stack;                                                                                                  // 20
	RocketChat.bugsnag.notify(error, options);                                                                            // 21
};                                                                                                                     // 22
                                                                                                                       //
process.on('uncaughtException', Meteor.bindEnvironment(function (error) {                                              // 24
	notify(error.message, error.stack);                                                                                   // 25
	throw error;                                                                                                          // 26
}));                                                                                                                   // 27
var originalMeteorDebug = Meteor._debug;                                                                               // 29
                                                                                                                       //
Meteor._debug = function () {                                                                                          // 30
	notify.apply(undefined, arguments);                                                                                   // 31
	return originalMeteorDebug.apply(undefined, arguments);                                                               // 32
};                                                                                                                     // 33
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"metrics.js":["prom-client",function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/metrics.js                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var client = require('prom-client');                                                                                   // 1
                                                                                                                       //
RocketChat.promclient = client;                                                                                        // 3
RocketChat.metrics = {}; // one sample metrics only - a counter                                                        // 5
                                                                                                                       //
RocketChat.metrics.messagesSent = new client.Counter('messages_sent', 'cumulated number of messages sent');            // 9
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"RateLimiter.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/RateLimiter.coffee.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.RateLimiter = new (function () {                                                                            //
  function _Class() {}                                                                                                 //
                                                                                                                       //
  _Class.prototype.limitFunction = function (fn, numRequests, timeInterval, matchers) {                                //
    var rateLimiter;                                                                                                   //
                                                                                                                       //
    if (process.env.TEST_MODE === 'true') {                                                                            //
      return fn;                                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    rateLimiter = new RateLimiter();                                                                                   //
    rateLimiter.addRule(matchers, numRequests, timeInterval);                                                          //
    return function () {                                                                                               //
      var args, match, rateLimitResult;                                                                                //
      match = {};                                                                                                      //
      args = arguments;                                                                                                //
                                                                                                                       //
      _.each(matchers, function (matcher, key) {                                                                       //
        return match[key] = args[key];                                                                                 //
      });                                                                                                              //
                                                                                                                       //
      rateLimiter.increment(match);                                                                                    //
      rateLimitResult = rateLimiter.check(match);                                                                      //
                                                                                                                       //
      if (rateLimitResult.allowed) {                                                                                   //
        return fn.apply(null, arguments);                                                                              //
      } else {                                                                                                         //
        throw new Meteor.Error('error-too-many-requests', "Error, too many requests. Please slow down. You must wait " + Math.ceil(rateLimitResult.timeToReset / 1000) + " seconds before trying again.", {
          timeToReset: rateLimitResult.timeToReset,                                                                    //
          seconds: Math.ceil(rateLimitResult.timeToReset / 1000)                                                       //
        });                                                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.limitMethod = function (methodName, numRequests, timeInterval, matchers) {                          //
    var match;                                                                                                         //
                                                                                                                       //
    if (process.env.TEST_MODE === 'true') {                                                                            //
      return;                                                                                                          //
    }                                                                                                                  //
                                                                                                                       //
    match = {                                                                                                          //
      type: 'method',                                                                                                  //
      name: methodName                                                                                                 //
    };                                                                                                                 //
                                                                                                                       //
    _.each(matchers, function (matcher, key) {                                                                         //
      return match[key] = matchers[key];                                                                               //
    });                                                                                                                //
                                                                                                                       //
    return DDPRateLimiter.addRule(match, numRequests, timeInterval);                                                   //
  };                                                                                                                   //
                                                                                                                       //
  return _Class;                                                                                                       //
}())();                                                                                                                //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"PushNotification.js":["babel-runtime/helpers/classCallCheck",function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/PushNotification.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals Push */var PushNotification = function () {                                                                 // 1
	function PushNotification() {                                                                                         //
		(0, _classCallCheck3.default)(this, PushNotification);                                                               //
	}                                                                                                                     //
                                                                                                                       //
	PushNotification.prototype.getNotificationId = function () {                                                          //
		function getNotificationId(roomId) {                                                                                 //
			var serverId = RocketChat.settings.get('uniqueID');                                                                 // 4
			return this.hash(serverId + "|" + roomId); // hash                                                                  // 5
		}                                                                                                                    // 6
                                                                                                                       //
		return getNotificationId;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	PushNotification.prototype.hash = function () {                                                                       //
		function hash(str) {                                                                                                 //
			var hash = 0,                                                                                                       // 9
			    i = str.length;                                                                                                 // 9
                                                                                                                       //
			while (i) {                                                                                                         // 12
				hash = (hash << 5) - hash + str.charCodeAt(--i);                                                                   // 13
				hash = hash & hash; // Convert to 32bit integer                                                                    // 14
			}                                                                                                                   // 15
                                                                                                                       //
			return hash;                                                                                                        // 16
		}                                                                                                                    // 17
                                                                                                                       //
		return hash;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	PushNotification.prototype.send = function () {                                                                       //
		function send(_ref) {                                                                                                //
			var roomName = _ref.roomName,                                                                                       // 19
			    roomId = _ref.roomId,                                                                                           // 19
			    username = _ref.username,                                                                                       // 19
			    message = _ref.message,                                                                                         // 19
			    usersTo = _ref.usersTo,                                                                                         // 19
			    payload = _ref.payload;                                                                                         // 19
			var title = void 0;                                                                                                 // 20
                                                                                                                       //
			if (roomName && roomName !== '') {                                                                                  // 21
				title = "" + roomName;                                                                                             // 22
				message = username + ": " + message;                                                                               // 23
			} else {                                                                                                            // 24
				title = "" + username;                                                                                             // 25
			}                                                                                                                   // 26
                                                                                                                       //
			var icon = RocketChat.settings.get('Assets_favicon_192').url || RocketChat.settings.get('Assets_favicon_192').defaultUrl;
			var config = {                                                                                                      // 28
				from: 'push',                                                                                                      // 29
				badge: 1,                                                                                                          // 30
				sound: 'default',                                                                                                  // 31
				title: title,                                                                                                      // 32
				text: message,                                                                                                     // 33
				payload: payload,                                                                                                  // 34
				query: usersTo,                                                                                                    // 35
				notId: this.getNotificationId(roomId),                                                                             // 36
				gcm: {                                                                                                             // 37
					style: 'inbox',                                                                                                   // 38
					summaryText: '%n% new messages',                                                                                  // 39
					image: RocketChat.getURL(icon, {                                                                                  // 40
						full: true                                                                                                       // 40
					})                                                                                                                // 40
				},                                                                                                                 // 37
				apn: {                                                                                                             // 42
					text: title + (title !== '' && message !== '' ? '\n' : '') + message                                              // 43
				}                                                                                                                  // 42
			};                                                                                                                  // 28
			return Push.send(config);                                                                                           // 47
		}                                                                                                                    // 48
                                                                                                                       //
		return send;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	return PushNotification;                                                                                              //
}();                                                                                                                   //
                                                                                                                       //
RocketChat.PushNotification = new PushNotification();                                                                  // 51
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"defaultBlockedDomainsList.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/defaultBlockedDomainsList.js                                                     //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.emailDomainDefaultBlackList = ['0-mail.com', '0815.ru', '0815.su', '0clickemail.com', '0wnd.net', '0wnd.org', '10mail.org', '10minut.com.pl', '10minutemail.co.za', '10minutemail.com', '10minutemail.de', '123-m.com', '1chuan.com', '1fsdfdsfsdf.tk', '1pad.de', '1zhuan.com', '20email.eu', '20mail.eu', '20mail.it', '20minutemail.com', '21cn.com', '2fdgdfgdfgdf.tk', '2prong.com', '30minutemail.com', '33mail.com', '3d-painting.com', '3trtretgfrfe.tk', '4gfdsgfdgfd.tk', '4warding.com', '4warding.net', '4warding.org', '5ghgfhfghfgh.tk', '60minutemail.com', '675hosting.com', '675hosting.net', '675hosting.org', '6hjgjhgkilkj.tk', '6ip.us', '6paq.com', '6url.com', '75hosting.com', '75hosting.net', '75hosting.org', '7days-printing.com', '7tags.com', '99experts.com', '9ox.net', 'a-bc.net', 'a45.in', 'abcmail.email', 'abyssmail.com', 'acentri.com', 'advantimo.com', 'afrobacon.com', 'ag.us.to', 'agedmail.com', 'ahk.jp', 'ajaxapp.net', 'alivance.com', 'ama-trade.de', 'amail.com', 'amilegit.com', 'amiri.net', 'amiriindustries.com', 'anappthat.com', 'ano-mail.net', 'anonbox.net', 'anonmails.de', 'anonymail.dk', 'anonymbox.com', 'antichef.com', 'antichef.net', 'antireg.ru', 'antispam.de', 'antispammail.de', 'appixie.com', 'armyspy.com', 'artman-conception.com', 'aver.com', 'azmeil.tk', 'baxomale.ht.cx', 'beddly.com', 'beefmilk.com', 'bigprofessor.so', 'bigstring.com', 'binkmail.com', 'bio-muesli.net', 'blogmyway.org', 'bobmail.info', 'bofthew.com', 'bootybay.de', 'boun.cr', 'bouncr.com', 'boxformail.in', 'breakthru.com', 'brefmail.com', 'brennendesreich.de', 'broadbandninja.com', 'bsnow.net', 'bspamfree.org', 'bu.mintemail.com', 'buffemail.com', 'bugmenot.com', 'bumpymail.com', 'bund.us', 'bundes-li.ga', 'burnthespam.info', 'burstmail.info', 'buymoreplays.com', 'buyusedlibrarybooks.org', 'byom.de', 'c2.hu', 'cachedot.net', 'card.zp.ua', 'casualdx.com', 'cbair.com', 'cek.pm', 'cellurl.com', 'centermail.com', 'centermail.net', 'chammy.info', 'cheatmail.de', 'childsavetrust.org', 'chogmail.com', 'choicemail1.com', 'chong-mail.com', 'chong-mail.net', 'chong-mail.org', 'clixser.com', 'cmail.com', 'cmail.net', 'cmail.org', 'coldemail.info', 'consumerriot.com', 'cool.fr.nf', 'correo.blogos.net', 'cosmorph.com', 'courriel.fr.nf', 'courrieltemporaire.com', 'crapmail.org', 'crazymailing.com', 'cubiclink.com', 'curryworld.de', 'cust.in', 'cuvox.de', 'd3p.dk', 'dacoolest.com', 'daintly.com', 'dandikmail.com', 'dayrep.com', 'dbunker.com', 'dcemail.com', 'deadaddress.com', 'deadspam.com', 'deagot.com', 'dealja.com', 'delikkt.de', 'despam.it', 'despammed.com', 'devnullmail.com', 'dfgh.net', 'digitalsanctuary.com', 'dingbone.com', 'discard.email', 'discardmail.com', 'discardmail.de', 'disposableaddress.com', 'disposableemailaddresses.com', 'disposableemailaddresses.emailmiser.com', 'disposableinbox.com', 'dispose.it', 'disposeamail.com', 'disposemail.com', 'dispostable.com', 'dlemail.ru', 'dm.w3internet.co.uk', 'dm.w3internet.co.ukexample.com', 'dodgeit.com', 'dodgit.com', 'dodgit.org', 'doiea.com', 'domozmail.com', 'donemail.ru', 'dontreg.com', 'dontsendmespam.de', 'dotmsg.com', 'drdrb.com', 'drdrb.net', 'droplar.com', 'dropmail.me', 'dt.com', 'duam.net', 'dudmail.com', 'dump-email.info', 'dumpandjunk.com', 'dumpmail.de', 'dumpyemail.com', 'duskmail.com', 'e-mail.com', 'e-mail.org', 'e4ward.com', 'easytrashmail.com', 'einmalmail.de', 'einrot.com', 'einrot.de', 'eintagsmail.de', 'email60.com', 'emaildienst.de', 'emailgo.de', 'emailias.com', 'emailigo.de', 'emailinfive.com', 'emaillime.com', 'emailmiser.com', 'emailproxsy.com', 'emailsensei.com', 'emailtemporanea.com', 'emailtemporanea.net', 'emailtemporar.ro', 'emailtemporario.com.br', 'emailthe.net', 'emailtmp.com', 'emailto.de', 'emailwarden.com', 'emailx.at.hm', 'emailxfer.com', 'emeil.in', 'emeil.ir', 'emil.com', 'emz.net', 'enterto.com', 'ephemail.net', 'ero-tube.org', 'etranquil.com', 'etranquil.net', 'etranquil.org', 'evopo.com', 'explodemail.com', 'express.net.ua', 'eyepaste.com', 'fakeinbox.com', 'fakeinformation.com', 'fakemail.fr', 'fakemailz.com', 'fammix.com', 'fansworldwide.de', 'fantasymail.de', 'fastacura.com', 'fastchevy.com', 'fastchrysler.com', 'fastkawasaki.com', 'fastmazda.com', 'fastmitsubishi.com', 'fastnissan.com', 'fastsubaru.com', 'fastsuzuki.com', 'fasttoyota.com', 'fastyamaha.com', 'fatflap.com', 'fdfdsfds.com', 'fightallspam.com', 'figjs.com', 'fiifke.de', 'filzmail.com', 'fivemail.de', 'fixmail.tk', 'fizmail.com', 'fleckens.hu', 'flemail.ru', 'flyspam.com', 'footard.com', 'forgetmail.com', 'fr33mail.info', 'frapmail.com', 'freundin.ru', 'friendlymail.co.uk', 'front14.org', 'fuckingduh.com', 'fudgerub.com', 'fux0ringduh.com', 'fyii.de', 'garliclife.com', 'gehensiemirnichtaufdensack.de', 'gelitik.in', 'get1mail.com', 'get2mail.fr', 'getairmail.com', 'getmails.eu', 'getonemail.com', 'getonemail.net', 'ghosttexter.de', 'giantmail.de', 'girlsundertheinfluence.com', 'gishpuppy.com', 'gmial.com', 'goemailgo.com', 'gorillaswithdirtyarmpits.com', 'gotmail.com', 'gotmail.net', 'gotmail.org', 'gotti.otherinbox.com', 'gowikibooks.com', 'gowikicampus.com', 'gowikicars.com', 'gowikifilms.com', 'gowikigames.com', 'gowikimusic.com', 'gowikimusic.great-host.in', 'gowikinetwork.com', 'gowikitravel.com', 'gowikitv.com', 'grandmamail.com', 'grandmasmail.com', 'great-host.in', 'greensloth.com', 'grr.la', 'gsrv.co.uk', 'guerillamail.biz', 'guerillamail.com', 'guerillamail.net', 'guerillamail.org', 'guerrillamail.biz', 'guerrillamail.com', 'guerrillamail.de', 'guerrillamail.info', 'guerrillamail.net', 'guerrillamail.org', 'guerrillamailblock.com', 'gustr.com', 'h.mintemail.com', 'h8s.org', 'hacccc.com', 'haltospam.com', 'harakirimail.com', 'hartbot.de', 'hat-geld.de', 'hatespam.org', 'hellodream.mobi', 'herp.in', 'hidemail.de', 'hidzz.com', 'hmamail.com', 'hochsitze.com', 'hopemail.biz', 'hotpop.com', 'hulapla.de', 'iaoss.com', 'ieatspam.eu', 'ieatspam.info', 'ieh-mail.de', 'ihateyoualot.info', 'iheartspam.org', 'ikbenspamvrij.nl', 'imails.info', 'imgof.com', 'imstations.com', 'inbax.tk', 'inbox.si', 'inboxalias.com', 'inboxclean.com', 'inboxclean.org', 'inboxproxy.com', 'incognitomail.com', 'incognitomail.net', 'incognitomail.org', 'infocom.zp.ua', 'inoutmail.de', 'inoutmail.eu', 'inoutmail.info', 'inoutmail.net', 'insorg-mail.info', 'instant-mail.de', 'ip6.li', 'ipoo.org', 'irish2me.com', 'iwi.net', 'jamit.com.au', 'jetable.com', 'jetable.fr.nf', 'jetable.net', 'jetable.org', 'jnxjn.com', 'jourrapide.com', 'jsrsolutions.com', 'junk1e.com', 'kasmail.com', 'kaspop.com', 'keepmymail.com', 'killmail.com', 'killmail.net', 'kimsdisk.com', 'kingsq.ga', 'kir.ch.tc', 'klassmaster.com', 'klassmaster.net', 'klzlk.com', 'kook.ml', 'koszmail.pl', 'kulturbetrieb.info', 'kurzepost.de', 'l33r.eu', 'lackmail.net', 'lags.us', 'lawlita.com', 'lazyinbox.com', 'letthemeatspam.com', 'lhsdv.com', 'lifebyfood.com', 'link2mail.net', 'litedrop.com', 'loadby.us', 'login-email.ml', 'lol.ovpn.to', 'lolfreak.net', 'lookugly.com', 'lopl.co.cc', 'lortemail.dk', 'lovemeleaveme.com', 'lr78.com', 'lroid.com', 'lukop.dk', 'm21.cc', 'm4ilweb.info', 'maboard.com', 'mail-filter.com', 'mail-temporaire.fr', 'mail.by', 'mail.mezimages.net', 'mail.zp.ua', 'mail114.net', 'mail1a.de', 'mail21.cc', 'mail2rss.org', 'mail333.com', 'mail4trash.com', 'mailbidon.com', 'mailbiz.biz', 'mailblocks.com', 'mailbucket.org', 'mailcat.biz', 'mailcatch.com', 'mailde.de', 'mailde.info', 'maildrop.cc', 'maildx.com', 'maileater.com', 'mailed.ro', 'maileimer.de', 'mailexpire.com', 'mailfa.tk', 'mailforspam.com', 'mailfreeonline.com', 'mailfs.com', 'mailguard.me', 'mailimate.com', 'mailin8r.com', 'mailinater.com', 'mailinator.com', 'mailinator.net', 'mailinator.org', 'mailinator.us', 'mailinator2.com', 'mailincubator.com', 'mailismagic.com', 'mailmate.com', 'mailme.ir', 'mailme.lv', 'mailme24.com', 'mailmetrash.com', 'mailmetrash.comilzilla.org', 'mailmoat.com', 'mailms.com', 'mailnator.com', 'mailnesia.com', 'mailnull.com', 'mailorg.org', 'mailpick.biz', 'mailproxsy.com', 'mailquack.com', 'mailrock.biz', 'mailscrap.com', 'mailshell.com', 'mailsiphon.com', 'mailslapping.com', 'mailslite.com', 'mailtemp.info', 'mailtome.de', 'mailtothis.com', 'mailtrash.net', 'mailtv.net', 'mailtv.tv', 'mailzilla.com', 'mailzilla.org', 'mailzilla.orgmbx.cc', 'makemetheking.com', 'manifestgenerator.com', 'manybrain.com', 'mbx.cc', 'mega.zik.dj', 'meinspamschutz.de', 'meltmail.com', 'messagebeamer.de', 'mezimages.net', 'mierdamail.com', 'migumail.com', 'ministry-of-silly-walks.de', 'mintemail.com', 'misterpinball.de', 'mjukglass.nu', 'mmailinater.com', 'moakt.com', 'mobi.web.id', 'mobileninja.co.uk', 'moburl.com', 'mohmal.com', 'moncourrier.fr.nf', 'monemail.fr.nf', 'monmail.fr.nf', 'monumentmail.com', 'msa.minsmail.com', 'mt2009.com', 'mt2014.com', 'mx0.wwwnew.eu', 'my10minutemail.com', 'mycard.net.ua', 'mycleaninbox.net', 'myemailboxy.com', 'mymail-in.net', 'mymailoasis.com', 'mynetstore.de', 'mypacks.net', 'mypartyclip.de', 'myphantomemail.com', 'mysamp.de', 'myspaceinc.com', 'myspaceinc.net', 'myspaceinc.org', 'myspacepimpedup.com', 'myspamless.com', 'mytemp.email', 'mytempemail.com', 'mytempmail.com', 'mytrashmail.com', 'nabuma.com', 'neomailbox.com', 'nepwk.com', 'nervmich.net', 'nervtmich.net', 'netmails.com', 'netmails.net', 'netzidiot.de', 'neverbox.com', 'nice-4u.com', 'nincsmail.com', 'nincsmail.hu', 'nnh.com', 'no-spam.ws', 'noblepioneer.com', 'nobulk.com', 'noclickemail.com', 'nogmailspam.info', 'nomail.pw', 'nomail.xl.cx', 'nomail2me.com', 'nomorespamemails.com', 'nonspam.eu', 'nonspammer.de', 'noref.in', 'nospam.ze.tc', 'nospam4.us', 'nospamfor.us', 'nospammail.net', 'nospamthanks.info', 'notmailinator.com', 'notsharingmy.info', 'nowhere.org', 'nowmymail.com', 'nurfuerspam.de', 'nus.edu.sg', 'nwldx.com', 'objectmail.com', 'obobbo.com', 'odaymail.com', 'odnorazovoe.ru', 'one-time.email', 'oneoffemail.com', 'oneoffmail.com', 'onewaymail.com', 'onlatedotcom.info', 'online.ms', 'oopi.org', 'opayq.com', 'ordinaryamerican.net', 'otherinbox.codupmyspace.com', 'otherinbox.com', 'ourklips.com', 'outlawspam.com', 'ovpn.to', 'owlpic.com', 'pancakemail.com', 'paplease.com', 'pcusers.otherinbox.com', 'pepbot.com', 'pfui.ru', 'pimpedupmyspace.com', 'pjjkp.com', 'plexolan.de', 'poczta.onet.pl', 'politikerclub.de', 'pooae.com', 'poofy.org', 'pookmail.com', 'privacy.net', 'privatdemail.net', 'privy-mail.com', 'privymail.de', 'proxymail.eu', 'prtnx.com', 'prtz.eu', 'punkass.com', 'putthisinyourspamdatabase.com', 'pwrby.com', 'quickinbox.com', 'quickmail.nl', 'rcpt.at', 'reallymymail.com', 'realtyalerts.ca', 'recode.me', 'recursor.net', 'recyclemail.dk', 'regbypass.com', 'regbypass.comsafe-mail.net', 'rejectmail.com', 'reliable-mail.com', 'rhyta.com', 'rklips.com', 'rmqkr.net', 'royal.net', 'rppkn.com', 'rtrtr.com', 's0ny.net', 'safe-mail.net', 'safersignup.de', 'safetymail.info', 'safetypost.de', 'sandelf.de', 'saynotospams.com', 'schafmail.de', 'schrott-email.de', 'secretemail.de', 'secure-mail.biz', 'selfdestructingmail.com', 'selfdestructingmail.org', 'sendspamhere.com', 'sendspamhere.com', 'senseless-entertainment.com', 'services391.com', 'sharedmailbox.org', 'sharklasers.com', 'shieldedmail.com', 'shieldemail.com', 'shiftmail.com', 'shitmail.me', 'shitmail.org', 'shitware.nl', 'shmeriously.com', 'shortmail.net', 'shotmail.ru', 'showslow.de', 'sibmail.com', 'sinnlos-mail.de', 'siteposter.net', 'skeefmail.com', 'slapsfromlastnight.com', 'slaskpost.se', 'slipry.net', 'slopsbox.com', 'slushmail.com', 'smashmail.de', 'smellfear.com', 'smellrear.com', 'snakemail.com', 'sneakemail.com', 'sneakmail.de', 'snkmail.com', 'sofimail.com', 'sofort-mail.de', 'softpls.asia', 'sogetthis.com', 'sohu.com', 'solvemail.info', 'soodonims.com', 'spa.com', 'spaereplease.com', 'spam.la', 'spam.su', 'spam4.me', 'spamail.de', 'spamarrest.com', 'spamavert.com', 'spambob.com', 'spambob.net', 'spambob.org', 'spambog.com', 'spambog.de', 'spambog.net', 'spambog.ru', 'spambox.info', 'spambox.irishspringrealty.com', 'spambox.us', 'spamcannon.com', 'spamcannon.net', 'spamcero.com', 'spamcon.org', 'spamcorptastic.com', 'spamcowboy.com', 'spamcowboy.net', 'spamcowboy.org', 'spamday.com', 'spamex.com', 'spamfree.eu', 'spamfree24.com', 'spamfree24.de', 'spamfree24.eu', 'spamfree24.info', 'spamfree24.net', 'spamfree24.org', 'spamgoes.in', 'spamgourmet.com', 'spamgourmet.net', 'spamgourmet.org', 'spamherelots.com', 'spamhereplease.com', 'spamhole.com', 'spamify.com', 'spaminator.de', 'spamkill.info', 'spaml.com', 'spaml.de', 'spammotel.com', 'spamobox.com', 'spamoff.de', 'spamsalad.in', 'spamslicer.com', 'spamspot.com', 'spamstack.net', 'spamthis.co.uk', 'spamthisplease.com', 'spamtrail.com', 'spamtroll.net', 'speed.1s.fr', 'spikio.com', 'spoofmail.de', 'squizzy.de', 'ssoia.com', 'startkeys.com', 'stinkefinger.net', 'stop-my-spam.com', 'stuffmail.de', 'super-auswahl.de', 'supergreatmail.com', 'supermailer.jp', 'superrito.com', 'superstachel.de', 'suremail.info', 'svk.jp', 'sweetxxx.de', 'tagyourself.com', 'talkinator.com', 'tapchicuoihoi.com', 'teewars.org', 'teleosaurs.xyz', 'teleworm.com', 'teleworm.us', 'temp-mail.org', 'temp-mail.ru', 'temp.emeraldwebmail.com', 'temp.headstrong.de', 'tempalias.com', 'tempe-mail.com', 'tempemail.biz', 'tempemail.co.za', 'tempemail.com', 'tempemail.net', 'tempemail.net', 'tempinbox.co.uk', 'tempinbox.com', 'tempmail.eu', 'tempmail.it', 'tempmail2.com', 'tempmaildemo.com', 'tempmailer.com', 'tempmailer.de', 'tempomail.fr', 'temporarily.de', 'temporarioemail.com.br', 'temporaryemail.net', 'temporaryemail.us', 'temporaryforwarding.com', 'temporaryinbox.com', 'temporarymailaddress.com', 'tempsky.com', 'tempthe.net', 'tempymail.com', 'thanksnospam.info', 'thankyou2010.com', 'thc.st', 'thecloudindex.com', 'thelimestones.com', 'thisisnotmyrealemail.com', 'thismail.net', 'thrma.com', 'throwawayemailaddress.com', 'tilien.com', 'tittbit.in', 'tizi.com', 'tmail.ws', 'tmailinator.com', 'toiea.com', 'toomail.biz', 'topranklist.de', 'tradermail.info', 'trash-amil.com', 'trash-mail.at', 'trash-mail.com', 'trash-mail.de', 'trash2009.com', 'trash2010.com', 'trash2011.com', 'trashdevil.com', 'trashdevil.de', 'trashemail.de', 'trashmail.at', 'trashmail.com', 'trashmail.de', 'trashmail.me', 'trashmail.net', 'trashmail.org', 'trashmail.ws', 'trashmailer.com', 'trashymail.com', 'trashymail.net', 'trbvm.com', 'trbvn.com', 'trialmail.de', 'trillianpro.com', 'tryalert.com', 'turual.com', 'twinmail.de', 'twoweirdtricks.com', 'tyldd.com', 'uggsrock.com', 'umail.net', 'upliftnow.com', 'uplipht.com', 'uroid.com', 'us.af', 'username.e4ward.com', 'venompen.com', 'veryrealemail.com', 'vidchart.com', 'viditag.com', 'viewcastmedia.com', 'viewcastmedia.net', 'viewcastmedia.org', 'viewcastmediae', 'viralplays.com', 'vkcode.ru', 'vomoto.com', 'vpn.st', 'vsimcard.com', 'vubby.com', 'walala.org', 'walkmail.net', 'walkmail.ru', 'wasteland.rfc822.org', 'webemail.me', 'webm4il.info', 'webuser.in', 'wee.my', 'weg-werf-email.de', 'wegwerf-email-addressen.de', 'wegwerf-emails.de', 'wegwerfadresse.de', 'wegwerfemail.com', 'wegwerfemail.de', 'wegwerfmail.de', 'wegwerfmail.info', 'wegwerfmail.net', 'wegwerfmail.org', 'wetrainbayarea.com', 'wetrainbayarea.org', 'wh4f.org', 'whatiaas.com', 'whatpaas.com', 'whatsaas.com', 'whopy.com', 'whtjddn.33mail.com', 'whyspam.me', 'wilemail.com', 'willhackforfood.biz', 'willselfdestruct.com', 'winemaven.info', 'wronghead.com', 'wuzup.net', 'wuzupmail.net', 'www.e4ward.com', 'www.gishpuppy.com', 'www.mailinator.com', 'wwwnew.eu', 'x.ip6.li', 'xagloo.com', 'xemaps.com', 'xents.com', 'xmaily.com', 'xoxy.net', 'xyzfree.net', 'yapped.net', 'yeah.net', 'yep.it', 'yogamaven.com', 'yomail.info', 'yopmail.com', 'yopmail.fr', 'yopmail.net', 'yourdomain.com', 'ypmail.webarnak.fr.eu.org', 'yuurok.com', 'z1p.biz', 'za.com', 'zehnminuten.de', 'zehnminutenmail.de', 'zetmail.com', 'zippymail.info', 'zoaxe.com', 'zoemail.com', 'zoemail.net', 'zoemail.org', 'zomg.info', 'zxcv.com', 'zxcvbnm.com', 'zzz.com'];
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"notifyUsersOnMessage.js":["moment",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/notifyUsersOnMessage.js                                                          //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.import('moment', {                                                                                              // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
RocketChat.callbacks.add('afterSaveMessage', function (message, room) {                                                // 3
	// skips this callback if the message was edited and increments it if the edit was way in the past (aka imported)     // 4
	if (message.editedAt && Math.abs(moment(message.editedAt).diff()) > 60000) {                                          // 5
		//TODO: Review as I am not sure how else to get around this as the incrementing of the msgs count shouldn't be in this callback
		RocketChat.models.Rooms.incMsgCountById(message.rid, 1);                                                             // 7
		return message;                                                                                                      // 8
	} else if (message.editedAt) {                                                                                        // 9
		// skips this callback if the message was edited                                                                     // 10
		return message;                                                                                                      // 11
	}                                                                                                                     // 12
                                                                                                                       //
	if (message.ts && Math.abs(moment(message.ts).diff()) > 60000) {                                                      // 14
		RocketChat.models.Rooms.incMsgCountById(message.rid, 1);                                                             // 15
		return message;                                                                                                      // 16
	} /**                                                                                                                 // 17
    * Chechs if a messages contains a user highlight                                                                   //
    *                                                                                                                  //
    * @param {string} message                                                                                          //
    * @param {array|undefined} highlights                                                                              //
    *                                                                                                                  //
    * @returns {boolean}                                                                                               //
       */                                                                                                              //
                                                                                                                       //
	function messageContainsHighlight(message, highlights) {                                                              // 27
		if (!highlights || highlights.length === 0) {                                                                        // 28
			return false;                                                                                                       // 28
		}                                                                                                                    // 28
                                                                                                                       //
		var has = false;                                                                                                     // 30
		highlights.some(function (highlight) {                                                                               // 31
			var regexp = new RegExp(s.escapeRegExp(highlight), 'i');                                                            // 32
                                                                                                                       //
			if (regexp.test(message.msg)) {                                                                                     // 33
				has = true;                                                                                                        // 34
				return true;                                                                                                       // 35
			}                                                                                                                   // 36
		});                                                                                                                  // 37
		return has;                                                                                                          // 39
	}                                                                                                                     // 40
                                                                                                                       //
	if (room.t != null && room.t === 'd') {                                                                               // 42
		// Update the other subscriptions                                                                                    // 43
		RocketChat.models.Subscriptions.incUnreadOfDirectForRoomIdExcludingUserId(message.rid, message.u._id, 1);            // 44
	} else {                                                                                                              // 45
		var mentionIds, toAll, highlightsIds, highlights;                                                                    // 46
		mentionIds = [];                                                                                                     // 48
		highlightsIds = [];                                                                                                  // 49
		toAll = false;                                                                                                       // 50
		highlights = RocketChat.models.Users.findUsersByUsernamesWithHighlights(room.usernames, {                            // 51
			fields: {                                                                                                           // 51
				'_id': 1,                                                                                                          // 51
				'settings.preferences.highlights': 1                                                                               // 51
			}                                                                                                                   // 51
		}).fetch();                                                                                                          // 51
                                                                                                                       //
		if (message.mentions != null) {                                                                                      // 53
			message.mentions.forEach(function (mention) {                                                                       // 54
				if (!toAll && mention._id === 'all') {                                                                             // 55
					toAll = true;                                                                                                     // 56
				}                                                                                                                  // 57
                                                                                                                       //
				if (mention._id !== message.u._id) {                                                                               // 58
					mentionIds.push(mention._id);                                                                                     // 59
				}                                                                                                                  // 60
			});                                                                                                                 // 61
		}                                                                                                                    // 62
                                                                                                                       //
		highlights.forEach(function (user) {                                                                                 // 64
			if (user && user.settings && user.settings.preferences && messageContainsHighlight(message, user.settings.preferences.highlights)) {
				if (user._id !== message.u._id) {                                                                                  // 66
					highlightsIds.push(user._id);                                                                                     // 67
				}                                                                                                                  // 68
			}                                                                                                                   // 69
		});                                                                                                                  // 70
                                                                                                                       //
		if (toAll) {                                                                                                         // 72
			RocketChat.models.Subscriptions.incUnreadForRoomIdExcludingUserId(room._id, message.u._id);                         // 73
		} else if (mentionIds && mentionIds.length > 0 || highlightsIds && highlightsIds.length > 0) {                       // 74
			RocketChat.models.Subscriptions.incUnreadForRoomIdAndUserIds(room._id, _.compact(_.unique(mentionIds.concat(highlightsIds))));
		}                                                                                                                    // 76
	} // Update all the room activity tracker fields                                                                      // 77
                                                                                                                       //
                                                                                                                       //
	RocketChat.models.Rooms.incMsgCountAndSetLastMessageTimestampById(message.rid, 1, message.ts); // Update all other subscriptions to alert their owners but witout incrementing
	// the unread counter, as it is only for mentions and direct messages                                                 // 83
                                                                                                                       //
	RocketChat.models.Subscriptions.setAlertForRoomIdExcludingUserId(message.rid, message.u._id);                         // 84
	return message;                                                                                                       // 86
}, RocketChat.callbacks.priority.LOW, 'notifyUsersOnMessage');                                                         // 88
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"roomTypes.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/roomTypes.coffee.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var roomTypesServer,                                                                                                   //
    extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
RocketChat.roomTypes = new (roomTypesServer = function (superClass) {                                                  //
  extend(roomTypesServer, superClass);                                                                                 //
                                                                                                                       //
  function roomTypesServer() {                                                                                         //
    return roomTypesServer.__super__.constructor.apply(this, arguments);                                               //
  } /* add a publish for a room type                                                                                   //
    	@param roomType: room type (e.g.: c (for channels), d (for direct channels))                                      //
    	@param callback: function that will return the publish's data                                                     //
     */                                                                                                                //
                                                                                                                       //
  roomTypesServer.prototype.setPublish = function (roomType, callback) {                                               //
    var ref;                                                                                                           //
                                                                                                                       //
    if (((ref = this.roomTypes[roomType]) != null ? ref.publish : void 0) != null) {                                   //
      throw new Meteor.Error('route-publish-exists', 'Publish for the given type already exists');                     //
    }                                                                                                                  //
                                                                                                                       //
    if (this.roomTypes[roomType] == null) {                                                                            //
      this.roomTypes[roomType] = {};                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    return this.roomTypes[roomType].publish = callback;                                                                //
  };                                                                                                                   //
                                                                                                                       //
  roomTypesServer.prototype.setRoomFind = function (roomType, callback) {                                              //
    var ref;                                                                                                           //
                                                                                                                       //
    if (((ref = this.roomTypes[roomType]) != null ? ref.roomFind : void 0) != null) {                                  //
      throw new Meteor.Error('room-find-exists', 'Room find for the given type already exists');                       //
    }                                                                                                                  //
                                                                                                                       //
    if (this.roomTypes[roomType] == null) {                                                                            //
      this.roomTypes[roomType] = {};                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    return this.roomTypes[roomType].roomFind = callback;                                                               //
  };                                                                                                                   //
                                                                                                                       //
  roomTypesServer.prototype.getRoomFind = function (roomType) {                                                        //
    var ref;                                                                                                           //
                                                                                                                       //
    if (((ref = this.roomTypes[roomType]) != null ? ref.roomFind : void 0) == null) {                                  //
      return;                                                                                                          //
    }                                                                                                                  //
                                                                                                                       //
    return this.roomTypes[roomType].roomFind;                                                                          //
  }; /* run the publish for a room type                                                                                //
     	@param scope: Meteor publish scope                                                                               //
     	@param roomType: room type (e.g.: c (for channels), d (for direct channels))                                     //
     	@param identifier: identifier of the room                                                                        //
      */                                                                                                               //
                                                                                                                       //
  roomTypesServer.prototype.runPublish = function (scope, roomType, identifier) {                                      //
    var ref;                                                                                                           //
                                                                                                                       //
    if (((ref = this.roomTypes[roomType]) != null ? ref.publish : void 0) == null) {                                   //
      return;                                                                                                          //
    }                                                                                                                  //
                                                                                                                       //
    return this.roomTypes[roomType].publish.call(scope, identifier);                                                   //
  };                                                                                                                   //
                                                                                                                       //
  return roomTypesServer;                                                                                              //
}(roomTypesCommon))();                                                                                                 //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendEmailOnMessage.js":["moment",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/sendEmailOnMessage.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.import('moment', {                                                                                              // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
RocketChat.callbacks.add('afterSaveMessage', function (message, room) {                                                // 3
	// skips this callback if the message was edited                                                                      // 4
	if (message.editedAt) {                                                                                               // 5
		return message;                                                                                                      // 6
	}                                                                                                                     // 7
                                                                                                                       //
	if (message.ts && Math.abs(moment(message.ts).diff()) > 60000) {                                                      // 9
		return message;                                                                                                      // 10
	}                                                                                                                     // 11
                                                                                                                       //
	var emailSubject,                                                                                                     // 13
	    usersToSendEmail = {};                                                                                            // 13
	var directMessage = room.t === 'd';                                                                                   // 14
                                                                                                                       //
	if (directMessage) {                                                                                                  // 16
		usersToSendEmail[message.rid.replace(message.u._id, '')] = 1;                                                        // 17
		emailSubject = TAPi18n.__('Offline_DM_Email', {                                                                      // 19
			user: message.u.username                                                                                            // 20
		});                                                                                                                  // 19
	} else {                                                                                                              // 23
		if (message.mentions) {                                                                                              // 24
			message.mentions.forEach(function (mention) {                                                                       // 25
				usersToSendEmail[mention._id] = 1;                                                                                 // 26
			});                                                                                                                 // 27
		}                                                                                                                    // 28
                                                                                                                       //
		emailSubject = TAPi18n.__('Offline_Mention_Email', {                                                                 // 30
			user: message.u.username,                                                                                           // 31
			room: room.name                                                                                                     // 32
		});                                                                                                                  // 30
	}                                                                                                                     // 34
                                                                                                                       //
	var getMessageLink = function (room, sub) {                                                                           // 36
		var roomPath = RocketChat.roomTypes.getRouteLink(room.t, sub);                                                       // 37
		var path = Meteor.absoluteUrl(roomPath ? roomPath.replace(/^\//, '') : '');                                          // 38
		var style = ['color: #fff;', 'padding: 9px 12px;', 'border-radius: 4px;', 'background-color: #04436a;', 'text-decoration: none;'].join(' ');
                                                                                                                       //
		var message = TAPi18n.__('Offline_Link_Message');                                                                    // 46
                                                                                                                       //
		return "<p style=\"text-align:center;margin-bottom:8px;\"><a style=\"" + style + "\" href=\"" + path + "\">" + message + "</a>";
	};                                                                                                                    // 48
                                                                                                                       //
	var divisorMessage = '<hr style="margin: 20px auto; border: none; border-bottom: 1px solid #dddddd;">';               // 50
	var messageHTML = s.escapeHTML(message.msg);                                                                          // 51
	message = RocketChat.callbacks.run('renderMessage', message);                                                         // 53
                                                                                                                       //
	if (message.tokens && message.tokens.length > 0) {                                                                    // 54
		message.tokens.forEach(function (token) {                                                                            // 55
			token.text = token.text.replace(/([^\$])(\$[^\$])/gm, '$1$$$2');                                                    // 56
			messageHTML = messageHTML.replace(token.token, token.text);                                                         // 57
		});                                                                                                                  // 58
	}                                                                                                                     // 59
                                                                                                                       //
	var header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');                          // 61
	var footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');                          // 62
	messageHTML = messageHTML.replace(/\n/gm, '<br/>');                                                                   // 63
	RocketChat.models.Subscriptions.findWithSendEmailByRoomId(room._id).forEach(function (sub) {                          // 65
		switch (sub.emailNotifications) {                                                                                    // 66
			case 'all':                                                                                                         // 67
				usersToSendEmail[sub.u._id] = 'force';                                                                             // 68
				break;                                                                                                             // 69
                                                                                                                       //
			case 'mentions':                                                                                                    // 70
				if (usersToSendEmail[sub.u._id]) {                                                                                 // 71
					usersToSendEmail[sub.u._id] = 'force';                                                                            // 72
				}                                                                                                                  // 73
                                                                                                                       //
				break;                                                                                                             // 74
                                                                                                                       //
			case 'nothing':                                                                                                     // 75
				delete usersToSendEmail[sub.u._id];                                                                                // 76
				break;                                                                                                             // 77
                                                                                                                       //
			case 'default':                                                                                                     // 78
				break;                                                                                                             // 79
		}                                                                                                                    // 66
	});                                                                                                                   // 81
	var userIdsToSendEmail = Object.keys(usersToSendEmail);                                                               // 83
	var defaultLink;                                                                                                      // 85
	var linkByUser = {};                                                                                                  // 87
                                                                                                                       //
	if (RocketChat.roomTypes.hasCustomLink(room.t)) {                                                                     // 88
		RocketChat.models.Subscriptions.findByRoomIdAndUserIds(room._id, userIdsToSendEmail).forEach(function (sub) {        // 89
			linkByUser[sub.u._id] = getMessageLink(room, sub);                                                                  // 90
		});                                                                                                                  // 91
	} else {                                                                                                              // 92
		defaultLink = getMessageLink(room, {                                                                                 // 93
			name: room.name                                                                                                     // 93
		});                                                                                                                  // 93
	}                                                                                                                     // 94
                                                                                                                       //
	if (userIdsToSendEmail.length > 0) {                                                                                  // 96
		var usersOfMention = RocketChat.models.Users.getUsersToSendOfflineEmail(userIdsToSendEmail).fetch();                 // 97
                                                                                                                       //
		if (usersOfMention && usersOfMention.length > 0) {                                                                   // 99
			var siteName = RocketChat.settings.get('Site_Name');                                                                // 100
			usersOfMention.forEach(function (user) {                                                                            // 102
				if (user.settings && user.settings.preferences && user.settings.preferences.emailNotificationMode && user.settings.preferences.emailNotificationMode === 'disabled' && usersToSendEmail[user._id] !== 'force') {
					return;                                                                                                           // 104
				} // Checks if user is in the room he/she is mentioned (unless it's public channel)                                // 105
                                                                                                                       //
                                                                                                                       //
				if (room.t !== 'c' && room.usernames.indexOf(user.username) === -1) {                                              // 108
					return;                                                                                                           // 109
				}                                                                                                                  // 110
                                                                                                                       //
				user.emails.some(function (email) {                                                                                // 112
					if (email.verified) {                                                                                             // 113
						email = {                                                                                                        // 114
							to: email.address,                                                                                              // 115
							from: RocketChat.settings.get('From_Email'),                                                                    // 116
							subject: "[" + siteName + "] " + emailSubject,                                                                  // 117
							html: header + messageHTML + divisorMessage + (linkByUser[user._id] || defaultLink) + footer                    // 118
						};                                                                                                               // 114
						Meteor.defer(function () {                                                                                       // 121
							Email.send(email);                                                                                              // 122
						});                                                                                                              // 123
						return true;                                                                                                     // 125
					}                                                                                                                 // 126
				});                                                                                                                // 127
			});                                                                                                                 // 128
		}                                                                                                                    // 129
	}                                                                                                                     // 130
                                                                                                                       //
	return message;                                                                                                       // 132
}, RocketChat.callbacks.priority.LOW, 'sendEmailOnMessage');                                                           // 134
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"sendNotificationsOnMessage.js":["moment",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/sendNotificationsOnMessage.js                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.import('moment', {                                                                                              // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
RocketChat.callbacks.add('afterSaveMessage', function (message, room) {                                                // 4
	// skips this callback if the message was edited                                                                      // 5
	if (message.editedAt) {                                                                                               // 6
		return message;                                                                                                      // 7
	}                                                                                                                     // 8
                                                                                                                       //
	if (message.ts && Math.abs(moment(message.ts).diff()) > 60000) {                                                      // 10
		return message;                                                                                                      // 11
	}                                                                                                                     // 12
                                                                                                                       //
	var user = RocketChat.models.Users.findOneById(message.u._id); /*                                                     // 14
                                                                Increment unread couter if direct messages             //
                                                                 */                                                    //
                                                                                                                       //
	var indexOf = [].indexOf || function (item) {                                                                         // 19
		for (var i = 0, l = this.length; i < l; i++) {                                                                       // 20
			if (i in this && this[i] === item) {                                                                                // 21
				return i;                                                                                                          // 22
			}                                                                                                                   // 23
		}                                                                                                                    // 24
                                                                                                                       //
		return -1;                                                                                                           // 25
	};                                                                                                                    // 26
                                                                                                                       //
	var settings, desktopMentionIds, i, j, len, len1, highlights, mentionIds, highlightsIds, usersWithHighlights, mobileMentionIds, ref, ref1, toAll, toHere, userIdsToNotify, userIdsToPushNotify, userOfMention, userOfMentionId, usersOfDesktopMentions, usersOfMentionId, usersOfMentionItem, usersOfMobileMentions; /**
                                                                                                                                                                                                                                                                                                                       * Checks if a given user can be notified
                                                                                                                                                                                                                                                                                                                       *
                                                                                                                                                                                                                                                                                                                       * @param {string} id
                                                                                                                                                                                                                                                                                                                       * @param {string} type - mobile|desktop
                                                                                                                                                                                                                                                                                                                       *
                                                                                                                                                                                                                                                                                                                       * @returns {boolean}
                                                                                                                                                                                                                                                                                                                          */
                                                                                                                       //
	function canBeNotified(id, type) {                                                                                    // 38
		var types = {                                                                                                        // 39
			mobile: ['dontNotifyDesktopUsers', 'alwaysNotifyDesktopUsers'],                                                     // 40
			desktop: ['dontNotifyMobileUsers', 'alwaysNotifyMobileUsers']                                                       // 41
		};                                                                                                                   // 39
		return settings[types[type][0]].indexOf(id) === -1 || settings[types[type][1]].indexOf(id) !== -1;                   // 44
	} /**                                                                                                                 // 45
    * Checks if a message contains a user highlight                                                                    //
    *                                                                                                                  //
    * @param {string} message                                                                                          //
    * @param {array|undefined} highlights                                                                              //
    *                                                                                                                  //
    * @returns {boolean}                                                                                               //
    */                                                                                                                 //
                                                                                                                       //
	function messageContainsHighlight(message, highlights) {                                                              // 55
		if (!highlights || highlights.length === 0) {                                                                        // 56
			return false;                                                                                                       // 56
		}                                                                                                                    // 56
                                                                                                                       //
		var has = false;                                                                                                     // 58
		highlights.some(function (highlight) {                                                                               // 59
			var regexp = new RegExp(s.escapeRegExp(highlight), 'i');                                                            // 60
                                                                                                                       //
			if (regexp.test(message.msg)) {                                                                                     // 61
				has = true;                                                                                                        // 62
				return true;                                                                                                       // 63
			}                                                                                                                   // 64
		});                                                                                                                  // 65
		return has;                                                                                                          // 67
	}                                                                                                                     // 68
                                                                                                                       //
	settings = {};                                                                                                        // 70
	settings.alwaysNotifyDesktopUsers = [];                                                                               // 72
	settings.dontNotifyDesktopUsers = [];                                                                                 // 73
	settings.alwaysNotifyMobileUsers = [];                                                                                // 74
	settings.dontNotifyMobileUsers = [];                                                                                  // 75
	settings.desktopNotificationDurations = {};                                                                           // 76
	var notificationPreferencesByRoom = RocketChat.models.Subscriptions.findNotificationPreferencesByRoom(room._id);      // 78
	notificationPreferencesByRoom.forEach(function (subscription) {                                                       // 79
		if (subscription.desktopNotifications === 'all') {                                                                   // 80
			settings.alwaysNotifyDesktopUsers.push(subscription.u._id);                                                         // 81
		} else if (subscription.desktopNotifications === 'nothing') {                                                        // 82
			settings.dontNotifyDesktopUsers.push(subscription.u._id);                                                           // 83
		}                                                                                                                    // 84
                                                                                                                       //
		if (subscription.mobilePushNotifications === 'all') {                                                                // 85
			settings.alwaysNotifyMobileUsers.push(subscription.u._id);                                                          // 86
		} else if (subscription.mobilePushNotifications === 'nothing') {                                                     // 87
			settings.dontNotifyMobileUsers.push(subscription.u._id);                                                            // 88
		}                                                                                                                    // 89
                                                                                                                       //
		settings.desktopNotificationDurations[subscription.u._id] = subscription.desktopNotificationDuration;                // 90
	});                                                                                                                   // 91
	userIdsToNotify = [];                                                                                                 // 93
	userIdsToPushNotify = [];                                                                                             // 94
	usersWithHighlights = [];                                                                                             // 95
	highlights = RocketChat.models.Users.findUsersByUsernamesWithHighlights(room.usernames, {                             // 97
		fields: {                                                                                                            // 97
			'_id': 1,                                                                                                           // 97
			'settings.preferences.highlights': 1                                                                                // 97
		}                                                                                                                    // 97
	}).fetch();                                                                                                           // 97
	highlights.forEach(function (user) {                                                                                  // 99
		if (messageContainsHighlight(message, user.settings.preferences.highlights)) {                                       // 100
			usersWithHighlights.push(user);                                                                                     // 101
		}                                                                                                                    // 102
	});                                                                                                                   // 103
	var push_message = void 0; //Set variables depending on Push Notification settings                                    // 105
                                                                                                                       //
	if (RocketChat.settings.get('Push_show_message')) {                                                                   // 107
		push_message = message.msg;                                                                                          // 108
	} else {                                                                                                              // 109
		push_message = ' ';                                                                                                  // 110
	}                                                                                                                     // 111
                                                                                                                       //
	var push_username = void 0;                                                                                           // 113
	var push_room = void 0;                                                                                               // 114
                                                                                                                       //
	if (RocketChat.settings.get('Push_show_username_room')) {                                                             // 115
		push_username = user.username;                                                                                       // 116
		push_room = '#' + room.name;                                                                                         // 117
	} else {                                                                                                              // 118
		push_username = '';                                                                                                  // 119
		push_room = '';                                                                                                      // 120
	}                                                                                                                     // 121
                                                                                                                       //
	if (room.t == null || room.t === 'd') {                                                                               // 123
		userOfMentionId = message.rid.replace(message.u._id, '');                                                            // 124
		userOfMention = RocketChat.models.Users.findOne({                                                                    // 125
			_id: userOfMentionId                                                                                                // 126
		}, {                                                                                                                 // 125
			fields: {                                                                                                           // 128
				username: 1,                                                                                                       // 129
				statusConnection: 1                                                                                                // 130
			}                                                                                                                   // 128
		}); // Always notify Sandstorm                                                                                       // 127
                                                                                                                       //
		if (userOfMention != null) {                                                                                         // 135
			RocketChat.Sandstorm.notify(message, [userOfMention._id], '@' + user.username + ': ' + message.msg, 'privateMessage');
		}                                                                                                                    // 139
                                                                                                                       //
		if (userOfMention != null && canBeNotified(userOfMentionId, 'mobile')) {                                             // 140
			RocketChat.Notifications.notifyUser(userOfMention._id, 'notification', {                                            // 141
				title: '@' + user.username,                                                                                        // 142
				text: message.msg,                                                                                                 // 143
				duration: settings.desktopNotificationDurations[userOfMention._id],                                                // 144
				payload: {                                                                                                         // 145
					_id: message._id,                                                                                                 // 146
					rid: message.rid,                                                                                                 // 147
					sender: message.u,                                                                                                // 148
					type: room.t,                                                                                                     // 149
					name: room.name                                                                                                   // 150
				}                                                                                                                  // 145
			});                                                                                                                 // 141
		}                                                                                                                    // 153
                                                                                                                       //
		if (userOfMention != null && canBeNotified(userOfMentionId, 'desktop')) {                                            // 155
			if (Push.enabled === true && userOfMention.statusConnection !== 'online') {                                         // 156
				RocketChat.PushNotification.send({                                                                                 // 157
					roomId: message.rid,                                                                                              // 158
					username: push_username,                                                                                          // 159
					message: push_message,                                                                                            // 160
					payload: {                                                                                                        // 161
						host: Meteor.absoluteUrl(),                                                                                      // 162
						rid: message.rid,                                                                                                // 163
						sender: message.u,                                                                                               // 164
						type: room.t,                                                                                                    // 165
						name: room.name                                                                                                  // 166
					},                                                                                                                // 161
					usersTo: {                                                                                                        // 168
						userId: userOfMention._id                                                                                        // 169
					}                                                                                                                 // 168
				});                                                                                                                // 157
				return message;                                                                                                    // 172
			}                                                                                                                   // 173
		}                                                                                                                    // 174
	} else {                                                                                                              // 176
		mentionIds = [];                                                                                                     // 177
                                                                                                                       //
		if ((ref = message.mentions) != null) {                                                                              // 178
			ref.forEach(function (mention) {                                                                                    // 179
				return mentionIds.push(mention._id);                                                                               // 180
			});                                                                                                                 // 181
		}                                                                                                                    // 182
                                                                                                                       //
		toAll = mentionIds.indexOf('all') > -1;                                                                              // 183
		toHere = mentionIds.indexOf('here') > -1;                                                                            // 184
                                                                                                                       //
		if (mentionIds.length > 0 || settings.alwaysNotifyDesktopUsers.length > 0) {                                         // 185
			desktopMentionIds = _.union(mentionIds, settings.alwaysNotifyDesktopUsers);                                         // 186
			desktopMentionIds = _.difference(desktopMentionIds, settings.dontNotifyDesktopUsers);                               // 187
			usersOfDesktopMentions = RocketChat.models.Users.find({                                                             // 189
				_id: {                                                                                                             // 190
					$in: desktopMentionIds                                                                                            // 191
				}                                                                                                                  // 190
			}, {                                                                                                                // 189
				fields: {                                                                                                          // 194
					_id: 1,                                                                                                           // 195
					username: 1,                                                                                                      // 196
					active: 1                                                                                                         // 197
				}                                                                                                                  // 194
			}).fetch();                                                                                                         // 193
                                                                                                                       //
			if (room.t === 'c' && !toAll) {                                                                                     // 200
				var callJoin = function (usersOfMentionItem) {                                                                     // 201
					if (usersOfMentionItem.active) {                                                                                  // 202
						Meteor.runAsUser(usersOfMentionItem._id, function () {                                                           // 203
							return Meteor.call('joinRoom', room._id);                                                                       // 204
						});                                                                                                              // 205
					}                                                                                                                 // 206
				};                                                                                                                 // 207
                                                                                                                       //
				for (i = 0, len = usersOfDesktopMentions.length; i < len; i++) {                                                   // 208
					usersOfMentionItem = usersOfDesktopMentions[i];                                                                   // 209
                                                                                                                       //
					if (room.usernames.indexOf(usersOfMentionItem.username) === -1) {                                                 // 210
						callJoin(usersOfMentionItem);                                                                                    // 211
					}                                                                                                                 // 212
				}                                                                                                                  // 213
			}                                                                                                                   // 214
                                                                                                                       //
			if (room.t !== 'c') {                                                                                               // 216
				usersOfDesktopMentions = _.reject(usersOfDesktopMentions, function (usersOfMentionItem) {                          // 217
					return room.usernames.indexOf(usersOfMentionItem.username) === -1;                                                // 218
				});                                                                                                                // 219
			}                                                                                                                   // 220
                                                                                                                       //
			userIdsToNotify = _.pluck(usersOfDesktopMentions, '_id');                                                           // 222
		}                                                                                                                    // 223
                                                                                                                       //
		if (mentionIds.length > 0 || settings.alwaysNotifyMobileUsers.length > 0) {                                          // 225
			mobileMentionIds = _.union(mentionIds, settings.alwaysNotifyMobileUsers);                                           // 226
			mobileMentionIds = _.difference(mobileMentionIds, settings.dontNotifyMobileUsers);                                  // 227
			usersOfMobileMentions = RocketChat.models.Users.find({                                                              // 229
				_id: {                                                                                                             // 230
					$in: mobileMentionIds                                                                                             // 231
				}                                                                                                                  // 230
			}, {                                                                                                                // 229
				fields: {                                                                                                          // 234
					_id: 1,                                                                                                           // 235
					username: 1,                                                                                                      // 236
					statusConnection: 1                                                                                               // 237
				}                                                                                                                  // 234
			}).fetch();                                                                                                         // 233
                                                                                                                       //
			if (room.t !== 'c') {                                                                                               // 241
				usersOfMobileMentions = _.reject(usersOfMobileMentions, function (usersOfMentionItem) {                            // 242
					return room.usernames.indexOf(usersOfMentionItem.username) === -1;                                                // 243
				});                                                                                                                // 244
			}                                                                                                                   // 245
                                                                                                                       //
			userIdsToPushNotify = _.pluck(_.filter(usersOfMobileMentions, function (user) {                                     // 247
				return user.statusConnection !== 'online';                                                                         // 248
			}), '_id');                                                                                                         // 249
		}                                                                                                                    // 250
                                                                                                                       //
		if ((toAll || toHere) && ((ref1 = room.usernames) != null ? ref1.length : void 0) > 0) {                             // 252
			RocketChat.models.Users.find({                                                                                      // 253
				username: {                                                                                                        // 254
					$in: room.usernames                                                                                               // 255
				},                                                                                                                 // 254
				_id: {                                                                                                             // 257
					$ne: user._id                                                                                                     // 258
				}                                                                                                                  // 257
			}, {                                                                                                                // 253
				fields: {                                                                                                          // 261
					_id: 1,                                                                                                           // 262
					username: 1,                                                                                                      // 263
					status: 1,                                                                                                        // 264
					statusConnection: 1                                                                                               // 265
				}                                                                                                                  // 261
			}).forEach(function (user) {                                                                                        // 260
				var ref2, ref3, ref4;                                                                                              // 268
                                                                                                                       //
				if (((ref2 = user.status) === 'online' || ref2 === 'away' || ref2 === 'busy') && (ref3 = user._id, indexOf.call(settings.dontNotifyDesktopUsers, ref3) < 0)) {
					userIdsToNotify.push(user._id);                                                                                   // 270
				}                                                                                                                  // 271
                                                                                                                       //
				if (toAll && user.statusConnection !== 'online' && (ref4 = user._id, indexOf.call(settings.dontNotifyMobileUsers, ref4) < 0)) {
					return userIdsToPushNotify.push(user._id);                                                                        // 273
				}                                                                                                                  // 274
			});                                                                                                                 // 275
		}                                                                                                                    // 276
                                                                                                                       //
		if (usersWithHighlights.length > 0) {                                                                                // 278
			highlightsIds = _.pluck(usersWithHighlights, '_id');                                                                // 279
			userIdsToNotify = userIdsToNotify.concat(highlightsIds);                                                            // 280
			userIdsToPushNotify = userIdsToPushNotify.concat(highlightsIds);                                                    // 281
		}                                                                                                                    // 282
                                                                                                                       //
		userIdsToNotify = _.without(_.compact(_.unique(userIdsToNotify)), message.u._id);                                    // 284
		userIdsToPushNotify = _.without(_.compact(_.unique(userIdsToPushNotify)), message.u._id);                            // 285
                                                                                                                       //
		if (userIdsToNotify.length > 0) {                                                                                    // 287
			for (j = 0, len1 = userIdsToNotify.length; j < len1; j++) {                                                         // 288
				usersOfMentionId = userIdsToNotify[j];                                                                             // 289
				var title = '@' + user.username;                                                                                   // 290
                                                                                                                       //
				if (room.name) {                                                                                                   // 291
					title += ' @ #' + room.name;                                                                                      // 292
				}                                                                                                                  // 293
                                                                                                                       //
				RocketChat.Notifications.notifyUser(usersOfMentionId, 'notification', {                                            // 294
					title: title,                                                                                                     // 295
					text: message.msg,                                                                                                // 296
					duration: settings.desktopNotificationDurations[usersOfMentionId],                                                // 297
					payload: {                                                                                                        // 298
						_id: message._id,                                                                                                // 299
						rid: message.rid,                                                                                                // 300
						sender: message.u,                                                                                               // 301
						type: room.t,                                                                                                    // 302
						name: room.name                                                                                                  // 303
					}                                                                                                                 // 298
				});                                                                                                                // 294
			}                                                                                                                   // 306
		}                                                                                                                    // 307
                                                                                                                       //
		if (userIdsToPushNotify.length > 0) {                                                                                // 309
			if (Push.enabled === true) {                                                                                        // 310
				RocketChat.PushNotification.send({                                                                                 // 311
					roomId: message.rid,                                                                                              // 312
					roomName: push_room,                                                                                              // 313
					username: push_username,                                                                                          // 314
					message: push_message,                                                                                            // 315
					payload: {                                                                                                        // 316
						host: Meteor.absoluteUrl(),                                                                                      // 317
						rid: message.rid,                                                                                                // 318
						sender: message.u,                                                                                               // 319
						type: room.t,                                                                                                    // 320
						name: room.name                                                                                                  // 321
					},                                                                                                                // 316
					usersTo: {                                                                                                        // 323
						userId: {                                                                                                        // 324
							$in: userIdsToPushNotify                                                                                        // 325
						}                                                                                                                // 324
					}                                                                                                                 // 323
				});                                                                                                                // 311
			}                                                                                                                   // 329
		}                                                                                                                    // 330
                                                                                                                       //
		var allUserIdsToNotify = _.unique(userIdsToNotify.concat(userIdsToPushNotify));                                      // 332
                                                                                                                       //
		if (room.t === 'p') {                                                                                                // 333
			RocketChat.Sandstorm.notify(message, allUserIdsToNotify, '@' + user.username + ': ' + message.msg, 'privateMessage');
		} else {                                                                                                             // 336
			RocketChat.Sandstorm.notify(message, allUserIdsToNotify, '@' + user.username + ': ' + message.msg, 'message');      // 337
		}                                                                                                                    // 339
	}                                                                                                                     // 340
                                                                                                                       //
	return message;                                                                                                       // 342
}, RocketChat.callbacks.priority.LOW, 'sendNotificationOnMessage');                                                    // 344
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"validateEmailDomain.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/validateEmailDomain.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var dns = Npm.require('dns');                                                                                          // 1
                                                                                                                       //
var emailDomainBlackList = [];                                                                                         // 3
var emailDomainWhiteList = [];                                                                                         // 4
var useDefaultBlackList = false;                                                                                       // 5
var useDNSDomainCheck = false;                                                                                         // 6
RocketChat.settings.get('Accounts_BlockedDomainsList', function (key, value) {                                         // 8
	emailDomainBlackList = _.map(value.split(','), function (domain) {                                                    // 9
		return domain.trim();                                                                                                // 9
	});                                                                                                                   // 9
});                                                                                                                    // 10
RocketChat.settings.get('Accounts_AllowedDomainsList', function (key, value) {                                         // 11
	emailDomainWhiteList = _.map(value.split(','), function (domain) {                                                    // 12
		return domain.trim();                                                                                                // 12
	});                                                                                                                   // 12
});                                                                                                                    // 13
RocketChat.settings.get('Accounts_UseDefaultBlockedDomainsList', function (key, value) {                               // 14
	useDefaultBlackList = value;                                                                                          // 15
});                                                                                                                    // 16
RocketChat.settings.get('Accounts_UseDNSDomainCheck', function (key, value) {                                          // 17
	useDNSDomainCheck = value;                                                                                            // 18
});                                                                                                                    // 19
                                                                                                                       //
RocketChat.validateEmailDomain = function (email) {                                                                    // 21
	var emailValidation = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                                                                                                                       //
	if (!emailValidation.test(email)) {                                                                                   // 23
		throw new Meteor.Error('error-invalid-email', 'Invalid email ' + email, {                                            // 24
			"function": 'RocketChat.validateEmailDomain',                                                                       // 24
			email: email                                                                                                        // 24
		});                                                                                                                  // 24
	}                                                                                                                     // 25
                                                                                                                       //
	var emailDomain = email.substr(email.lastIndexOf('@') + 1); // if not in whitelist                                    // 27
                                                                                                                       //
	if (emailDomainWhiteList.indexOf(emailDomain) === -1) {                                                               // 30
		if (emailDomainBlackList.indexOf(emailDomain) !== -1 || useDefaultBlackList && RocketChat.emailDomainDefaultBlackList.indexOf(emailDomain) !== -1) {
			throw new Meteor.Error('error-email-domain-blacklisted', 'The email domain is blacklisted', {                       // 32
				"function": 'RocketChat.validateEmailDomain'                                                                       // 32
			});                                                                                                                 // 32
		}                                                                                                                    // 33
	}                                                                                                                     // 34
                                                                                                                       //
	if (useDNSDomainCheck) {                                                                                              // 36
		try {                                                                                                                // 37
			Meteor.wrapAsync(dns.resolveMx)(emailDomain);                                                                       // 38
		} catch (e) {                                                                                                        // 39
			throw new Meteor.Error('error-invalid-domain', 'Invalid domain', {                                                  // 40
				"function": 'RocketChat.validateEmailDomain'                                                                       // 40
			});                                                                                                                 // 40
		}                                                                                                                    // 41
	}                                                                                                                     // 42
};                                                                                                                     // 43
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"functions":{"isDocker.js":["fs",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/isDocker.js                                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var fs = void 0;                                                                                                       // 1
module.import('fs', {                                                                                                  // 1
	"default": function (v) {                                                                                             // 1
		fs = v;                                                                                                              // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
                                                                                                                       //
function hasDockerEnv() {                                                                                              // 3
	try {                                                                                                                 // 4
		fs.statSync('/.dockerenv');                                                                                          // 5
		return true;                                                                                                         // 6
	} catch (err) {                                                                                                       // 7
		return false;                                                                                                        // 8
	}                                                                                                                     // 9
}                                                                                                                      // 10
                                                                                                                       //
function hasDockerCGroup() {                                                                                           // 12
	try {                                                                                                                 // 13
		return fs.readFileSync('/proc/self/cgroup', 'utf8').indexOf('docker') !== -1;                                        // 14
	} catch (err) {                                                                                                       // 15
		return false;                                                                                                        // 16
	}                                                                                                                     // 17
}                                                                                                                      // 18
                                                                                                                       //
function check() {                                                                                                     // 20
	return hasDockerEnv() || hasDockerCGroup();                                                                           // 21
}                                                                                                                      // 22
                                                                                                                       //
var isDocker = void 0;                                                                                                 // 24
                                                                                                                       //
RocketChat.isDocker = function () {                                                                                    // 25
	if (isDocker === undefined) {                                                                                         // 26
		isDocker = check();                                                                                                  // 27
	}                                                                                                                     // 28
                                                                                                                       //
	return isDocker;                                                                                                      // 30
};                                                                                                                     // 31
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"addUserToDefaultChannels.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/addUserToDefaultChannels.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.addUserToDefaultChannels = function (user, silenced) {                                                      // 1
	RocketChat.callbacks.run('beforeJoinDefaultChannels', user);                                                          // 2
	var defaultRooms = RocketChat.models.Rooms.findByDefaultAndTypes(true, ['c', 'p'], {                                  // 3
		fields: {                                                                                                            // 3
			usernames: 0                                                                                                        // 3
		}                                                                                                                    // 3
	}).fetch();                                                                                                           // 3
	defaultRooms.forEach(function (room) {                                                                                // 4
		// put user in default rooms                                                                                         // 6
		var muted = room.ro && !RocketChat.authz.hasPermission(user._id, 'post-readonly');                                   // 7
		RocketChat.models.Rooms.addUsernameById(room._id, user.username, muted);                                             // 8
                                                                                                                       //
		if (!RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, user._id)) {                                 // 10
			// Add a subscription to this user                                                                                  // 12
			RocketChat.models.Subscriptions.createWithRoomAndUser(room, user, {                                                 // 13
				ts: new Date(),                                                                                                    // 14
				open: true,                                                                                                        // 15
				alert: true,                                                                                                       // 16
				unread: 1                                                                                                          // 17
			}); // Insert user joined message                                                                                   // 13
                                                                                                                       //
			if (!silenced) {                                                                                                    // 21
				RocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, user);                                        // 22
			}                                                                                                                   // 23
		}                                                                                                                    // 24
	});                                                                                                                   // 25
};                                                                                                                     // 26
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"addUserToRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/addUserToRoom.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.addUserToRoom = function (rid, user, inviter, silenced) {                                                   // 1
	var now = new Date();                                                                                                 // 2
	var room = RocketChat.models.Rooms.findOneById(rid); // Check if user is already in room                              // 3
                                                                                                                       //
	var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, user._id);                           // 6
                                                                                                                       //
	if (subscription) {                                                                                                   // 7
		return;                                                                                                              // 8
	}                                                                                                                     // 9
                                                                                                                       //
	if (room.t === 'c' || room.t === 'p') {                                                                               // 11
		RocketChat.callbacks.run('beforeJoinRoom', user, room);                                                              // 12
	}                                                                                                                     // 13
                                                                                                                       //
	var muted = room.ro && !RocketChat.authz.hasPermission(user._id, 'post-readonly');                                    // 15
	RocketChat.models.Rooms.addUsernameById(rid, user.username, muted);                                                   // 16
	RocketChat.models.Subscriptions.createWithRoomAndUser(room, user, {                                                   // 17
		ts: now,                                                                                                             // 18
		open: true,                                                                                                          // 19
		alert: true,                                                                                                         // 20
		unread: 1                                                                                                            // 21
	});                                                                                                                   // 17
                                                                                                                       //
	if (!silenced) {                                                                                                      // 24
		if (inviter) {                                                                                                       // 25
			RocketChat.models.Messages.createUserAddedWithRoomIdAndUser(rid, user, {                                            // 26
				ts: now,                                                                                                           // 27
				u: {                                                                                                               // 28
					_id: inviter._id,                                                                                                 // 29
					username: inviter.username                                                                                        // 30
				}                                                                                                                  // 28
			});                                                                                                                 // 26
		} else {                                                                                                             // 33
			RocketChat.models.Messages.createUserJoinWithRoomIdAndUser(rid, user, {                                             // 34
				ts: now                                                                                                            // 34
			});                                                                                                                 // 34
		}                                                                                                                    // 35
	}                                                                                                                     // 36
                                                                                                                       //
	if (room.t === 'c' || room.t === 'p') {                                                                               // 38
		Meteor.defer(function () {                                                                                           // 39
			RocketChat.callbacks.run('afterJoinRoom', user, room);                                                              // 40
		});                                                                                                                  // 41
	}                                                                                                                     // 42
                                                                                                                       //
	return true;                                                                                                          // 44
};                                                                                                                     // 45
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"archiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/archiveRoom.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.archiveRoom = function (rid) {                                                                              // 1
	RocketChat.models.Rooms.archiveById(rid);                                                                             // 2
	RocketChat.models.Subscriptions.archiveByRoomId(rid);                                                                 // 3
	RocketChat.callbacks.run('afterRoomArchived', RocketChat.models.Rooms.findOneById(rid), Meteor.user());               // 5
};                                                                                                                     // 6
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"checkUsernameAvailability.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/checkUsernameAvailability.coffee.js                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.checkUsernameAvailability = function (username) {                                                           //
  var usernameBlackList;                                                                                               //
  usernameBlackList = [];                                                                                              //
  return RocketChat.settings.get('Accounts_BlockedUsernameList', function (_this) {                                    //
    return function (key, value) {                                                                                     //
      var i, len, regex, restrictedUsername;                                                                           //
      usernameBlackList = _.map(value.split(','), function (username) {                                                //
        return username.trim();                                                                                        //
      });                                                                                                              //
                                                                                                                       //
      if (usernameBlackList.length !== 0) {                                                                            //
        for (i = 0, len = usernameBlackList.length; i < len; i++) {                                                    //
          restrictedUsername = usernameBlackList[i];                                                                   //
          regex = new RegExp('^' + s.escapeRegExp(restrictedUsername) + '$', 'i');                                     //
                                                                                                                       //
          if (regex.test(s.trim(s.escapeRegExp(username)))) {                                                          //
            return false;                                                                                              //
          }                                                                                                            //
        }                                                                                                              //
      }                                                                                                                //
                                                                                                                       //
      return !Meteor.users.findOne({                                                                                   //
        username: {                                                                                                    //
          $regex: new RegExp("^" + s.trim(s.escapeRegExp(username)) + "$", "i")                                        //
        }                                                                                                              //
      });                                                                                                              //
    };                                                                                                                 //
  }(this));                                                                                                            //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"checkEmailAvailability.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/checkEmailAvailability.js                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.checkEmailAvailability = function (email) {                                                                 // 1
	return !Meteor.users.findOne({                                                                                        // 2
		'emails.address': {                                                                                                  // 2
			$regex: new RegExp('^' + s.trim(s.escapeRegExp(email)) + '$', 'i')                                                  // 2
		}                                                                                                                    // 2
	});                                                                                                                   // 2
};                                                                                                                     // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"createRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/createRoom.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals RocketChat */RocketChat.createRoom = function (type, name, owner, members, readOnly) {                      // 1
	var extraData = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : {};                               // 2
	name = s.trim(name);                                                                                                  // 3
	owner = s.trim(owner);                                                                                                // 4
	members = [].concat(members);                                                                                         // 5
                                                                                                                       //
	if (!name) {                                                                                                          // 7
		throw new Meteor.Error('error-invalid-name', 'Invalid name', {                                                       // 8
			"function": 'RocketChat.createRoom'                                                                                 // 8
		});                                                                                                                  // 8
	}                                                                                                                     // 9
                                                                                                                       //
	owner = RocketChat.models.Users.findOneByUsername(owner, {                                                            // 11
		fields: {                                                                                                            // 11
			username: 1                                                                                                         // 11
		}                                                                                                                    // 11
	});                                                                                                                   // 11
                                                                                                                       //
	if (!owner) {                                                                                                         // 12
		throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                       // 13
			"function": 'RocketChat.createRoom'                                                                                 // 13
		});                                                                                                                  // 13
	}                                                                                                                     // 14
                                                                                                                       //
	var nameValidation = void 0;                                                                                          // 16
                                                                                                                       //
	try {                                                                                                                 // 17
		nameValidation = new RegExp('^' + RocketChat.settings.get('UTF8_Names_Validation') + '$');                           // 18
	} catch (error) {                                                                                                     // 19
		nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                    // 20
	}                                                                                                                     // 21
                                                                                                                       //
	if (!nameValidation.test(name)) {                                                                                     // 23
		throw new Meteor.Error('error-invalid-name', 'Invalid name', {                                                       // 24
			"function": 'RocketChat.createRoom'                                                                                 // 24
		});                                                                                                                  // 24
	}                                                                                                                     // 25
                                                                                                                       //
	var now = new Date();                                                                                                 // 27
                                                                                                                       //
	if (!_.contains(members, owner.username)) {                                                                           // 28
		members.push(owner.username);                                                                                        // 29
	} // avoid duplicate names                                                                                            // 30
                                                                                                                       //
                                                                                                                       //
	var room = RocketChat.models.Rooms.findOneByName(name);                                                               // 33
                                                                                                                       //
	if (room) {                                                                                                           // 34
		if (room.archived) {                                                                                                 // 35
			throw new Meteor.Error('error-archived-duplicate-name', 'There\'s an archived channel with name ' + name, {         // 36
				"function": 'RocketChat.createRoom',                                                                               // 36
				room_name: name                                                                                                    // 36
			});                                                                                                                 // 36
		} else {                                                                                                             // 37
			throw new Meteor.Error('error-duplicate-channel-name', 'A channel with name \'' + name + '\' exists', {             // 38
				"function": 'RocketChat.createRoom',                                                                               // 38
				room_name: name                                                                                                    // 38
			});                                                                                                                 // 38
		}                                                                                                                    // 39
	}                                                                                                                     // 40
                                                                                                                       //
	if (type === 'c') {                                                                                                   // 42
		RocketChat.callbacks.run('beforeCreateChannel', owner, {                                                             // 43
			t: 'c',                                                                                                             // 44
			name: name,                                                                                                         // 45
			ts: now,                                                                                                            // 46
			ro: readOnly === true,                                                                                              // 47
			sysMes: readOnly !== true,                                                                                          // 48
			usernames: members,                                                                                                 // 49
			u: {                                                                                                                // 50
				_id: owner._id,                                                                                                    // 51
				username: owner.username                                                                                           // 52
			}                                                                                                                   // 50
		});                                                                                                                  // 43
	}                                                                                                                     // 55
                                                                                                                       //
	extraData = Object.assign({}, extraData, {                                                                            // 57
		ts: now,                                                                                                             // 58
		ro: readOnly === true,                                                                                               // 59
		sysMes: readOnly !== true                                                                                            // 60
	});                                                                                                                   // 57
	room = RocketChat.models.Rooms.createWithTypeNameUserAndUsernames(type, name, owner, members, extraData);             // 63
                                                                                                                       //
	for (var _iterator = members, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
		var _ref;                                                                                                            // 65
                                                                                                                       //
		if (_isArray) {                                                                                                      // 65
			if (_i >= _iterator.length) break;                                                                                  // 65
			_ref = _iterator[_i++];                                                                                             // 65
		} else {                                                                                                             // 65
			_i = _iterator.next();                                                                                              // 65
			if (_i.done) break;                                                                                                 // 65
			_ref = _i.value;                                                                                                    // 65
		}                                                                                                                    // 65
                                                                                                                       //
		var username = _ref;                                                                                                 // 65
		var member = RocketChat.models.Users.findOneByUsername(username, {                                                   // 66
			fields: {                                                                                                           // 66
				username: 1                                                                                                        // 66
			}                                                                                                                   // 66
		});                                                                                                                  // 66
                                                                                                                       //
		if (!member) {                                                                                                       // 67
			continue;                                                                                                           // 68
		} // make all room members muted by default, unless they have the post-readonly permission                           // 69
                                                                                                                       //
                                                                                                                       //
		if (readOnly === true && !RocketChat.authz.hasPermission(member._id, 'post-readonly')) {                             // 72
			RocketChat.models.Rooms.muteUsernameByRoomId(room._id, username);                                                   // 73
		}                                                                                                                    // 74
                                                                                                                       //
		var extra = {                                                                                                        // 76
			open: true                                                                                                          // 76
		};                                                                                                                   // 76
                                                                                                                       //
		if (username === owner.username) {                                                                                   // 78
			extra.ls = now;                                                                                                     // 79
		}                                                                                                                    // 80
                                                                                                                       //
		RocketChat.models.Subscriptions.createWithRoomAndUser(room, member, extra);                                          // 82
	}                                                                                                                     // 83
                                                                                                                       //
	RocketChat.authz.addUserRoles(owner._id, ['owner'], room._id);                                                        // 85
                                                                                                                       //
	if (type === 'c') {                                                                                                   // 87
		Meteor.defer(function () {                                                                                           // 88
			RocketChat.callbacks.run('afterCreateChannel', owner, room);                                                        // 89
		});                                                                                                                  // 90
	} else if (type === 'p') {                                                                                            // 91
		Meteor.defer(function () {                                                                                           // 92
			RocketChat.callbacks.run('afterCreatePrivateGroup', owner, room);                                                   // 93
		});                                                                                                                  // 94
	}                                                                                                                     // 95
                                                                                                                       //
	return {                                                                                                              // 97
		rid: room._id                                                                                                        // 98
	};                                                                                                                    // 97
};                                                                                                                     // 100
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"deleteMessage.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/deleteMessage.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals FileUpload */RocketChat.deleteMessage = function (message, user) {                                          // 1
	var keepHistory = RocketChat.settings.get('Message_KeepHistory');                                                     // 3
	var showDeletedStatus = RocketChat.settings.get('Message_ShowDeletedStatus');                                         // 4
	var deletedMsg = void 0;                                                                                              // 5
                                                                                                                       //
	if (keepHistory) {                                                                                                    // 7
		if (showDeletedStatus) {                                                                                             // 8
			RocketChat.models.Messages.cloneAndSaveAsHistoryById(message._id);                                                  // 9
		} else {                                                                                                             // 10
			RocketChat.models.Messages.setHiddenById(message._id, true);                                                        // 11
		}                                                                                                                    // 12
                                                                                                                       //
		if (message.file && message.file._id) {                                                                              // 14
			RocketChat.models.Uploads.update(message.file._id, {                                                                // 15
				$set: {                                                                                                            // 15
					_hidden: true                                                                                                     // 15
				}                                                                                                                  // 15
			});                                                                                                                 // 15
		}                                                                                                                    // 16
	} else {                                                                                                              // 17
		if (!showDeletedStatus) {                                                                                            // 18
			deletedMsg = RocketChat.models.Messages.findOneById(message._id);                                                   // 19
			RocketChat.models.Messages.removeById(message._id);                                                                 // 20
		}                                                                                                                    // 21
                                                                                                                       //
		if (message.file && message.file._id) {                                                                              // 23
			FileUpload.delete(message.file._id);                                                                                // 24
		}                                                                                                                    // 25
                                                                                                                       //
		Meteor.defer(function () {                                                                                           // 27
			RocketChat.callbacks.run('afterDeleteMessage', deletedMsg);                                                         // 28
		});                                                                                                                  // 29
	}                                                                                                                     // 30
                                                                                                                       //
	if (showDeletedStatus) {                                                                                              // 32
		RocketChat.models.Messages.setAsDeletedByIdAndUser(message._id, user);                                               // 33
	} else {                                                                                                              // 34
		RocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', {                                                  // 35
			_id: message._id                                                                                                    // 35
		});                                                                                                                  // 35
	}                                                                                                                     // 36
};                                                                                                                     // 37
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"deleteUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/deleteUser.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals RocketChat */RocketChat.deleteUser = function (userId) {                                                    // 1
	var user = RocketChat.models.Users.findOneById(userId);                                                               // 3
	RocketChat.models.Messages.removeByUserId(userId); // Remove user messages                                            // 5
                                                                                                                       //
	RocketChat.models.Subscriptions.findByUserId(userId).forEach(function (subscription) {                                // 6
		var room = RocketChat.models.Rooms.findOneById(subscription.rid);                                                    // 7
                                                                                                                       //
		if (room) {                                                                                                          // 8
			if (room.t !== 'c' && room.usernames.length === 1) {                                                                // 9
				RocketChat.models.Rooms.removeById(subscription.rid); // Remove non-channel rooms with only 1 user (the one being deleted)
			}                                                                                                                   // 11
                                                                                                                       //
			if (room.t === 'd') {                                                                                               // 12
				RocketChat.models.Subscriptions.removeByRoomId(subscription.rid);                                                  // 13
				RocketChat.models.Messages.removeByRoomId(subscription.rid);                                                       // 14
			}                                                                                                                   // 15
		}                                                                                                                    // 16
	});                                                                                                                   // 17
	RocketChat.models.Subscriptions.removeByUserId(userId); // Remove user subscriptions                                  // 19
                                                                                                                       //
	RocketChat.models.Rooms.removeByTypeContainingUsername('d', user.username); // Remove direct rooms with the user      // 20
                                                                                                                       //
	RocketChat.models.Rooms.removeUsernameFromAll(user.username); // Remove user from all other rooms                     // 21
	// removes user's avatar                                                                                              // 23
                                                                                                                       //
	if (user.avatarOrigin === 'upload' || user.avatarOrigin === 'url') {                                                  // 24
		RocketChatFileAvatarInstance.deleteFile(encodeURIComponent(user.username + '.jpg'));                                 // 25
	}                                                                                                                     // 26
                                                                                                                       //
	RocketChat.models.Integrations.disableByUserId(userId); // Disables all the integrations which rely on the user being deleted.
                                                                                                                       //
	RocketChat.models.Users.removeById(userId); // Remove user from users database                                        // 30
};                                                                                                                     // 31
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getFullUserData.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/getFullUserData.js                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals RocketChat */RocketChat.getFullUserData = function (_ref) {                                                 // 1
	var userId = _ref.userId,                                                                                             // 2
	    filter = _ref.filter,                                                                                             // 2
	    limit = _ref.limit;                                                                                               // 2
	var fields = {                                                                                                        // 3
		name: 1,                                                                                                             // 4
		username: 1,                                                                                                         // 5
		status: 1,                                                                                                           // 6
		utcOffset: 1,                                                                                                        // 7
		type: 1,                                                                                                             // 8
		active: 1                                                                                                            // 9
	};                                                                                                                    // 3
                                                                                                                       //
	if (RocketChat.authz.hasPermission(userId, 'view-full-other-user-info')) {                                            // 12
		fields = _.extend(fields, {                                                                                          // 13
			emails: 1,                                                                                                          // 14
			phone: 1,                                                                                                           // 15
			statusConnection: 1,                                                                                                // 16
			createdAt: 1,                                                                                                       // 17
			lastLogin: 1,                                                                                                       // 18
			services: 1,                                                                                                        // 19
			requirePasswordChange: 1,                                                                                           // 20
			requirePasswordChangeReason: 1,                                                                                     // 21
			roles: 1,                                                                                                           // 22
			customFields: 1                                                                                                     // 23
		});                                                                                                                  // 13
	} else if (limit !== 0) {                                                                                             // 25
		limit = 1;                                                                                                           // 26
	}                                                                                                                     // 27
                                                                                                                       //
	filter = s.trim(filter);                                                                                              // 29
                                                                                                                       //
	if (!filter && limit === 1) {                                                                                         // 31
		return undefined;                                                                                                    // 32
	}                                                                                                                     // 33
                                                                                                                       //
	var options = {                                                                                                       // 35
		fields: fields,                                                                                                      // 36
		limit: limit,                                                                                                        // 37
		sort: {                                                                                                              // 38
			username: 1                                                                                                         // 38
		}                                                                                                                    // 38
	};                                                                                                                    // 35
                                                                                                                       //
	if (filter) {                                                                                                         // 41
		if (limit === 1) {                                                                                                   // 42
			return RocketChat.models.Users.findByUsername(filter, options);                                                     // 43
		} else {                                                                                                             // 44
			var filterReg = new RegExp(s.escapeRegExp(filter), 'i');                                                            // 45
			return RocketChat.models.Users.findByUsernameNameOrEmailAddress(filterReg, options);                                // 46
		}                                                                                                                    // 47
	}                                                                                                                     // 48
                                                                                                                       //
	return RocketChat.models.Users.find({}, options);                                                                     // 50
};                                                                                                                     // 51
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getRoomByNameOrIdWithOptionToJoin.js":["babel-runtime/helpers/typeof",function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/getRoomByNameOrIdWithOptionToJoin.js                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _typeof2 = require("babel-runtime/helpers/typeof");                                                                //
                                                                                                                       //
var _typeof3 = _interopRequireDefault(_typeof2);                                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals RocketChat */RocketChat.getRoomByNameOrIdWithOptionToJoin = function () {                                   // 1
	function _getRoomByNameOrIdWithOptionToJoin(_ref) {                                                                   // 2
		var currentUserId = _ref.currentUserId,                                                                              // 2
		    nameOrId = _ref.nameOrId,                                                                                        // 2
		    _ref$type = _ref.type,                                                                                           // 2
		    type = _ref$type === undefined ? '' : _ref$type,                                                                 // 2
		    _ref$tryDirectByUserI = _ref.tryDirectByUserIdOnly,                                                              // 2
		    tryDirectByUserIdOnly = _ref$tryDirectByUserI === undefined ? false : _ref$tryDirectByUserI,                     // 2
		    _ref$joinChannel = _ref.joinChannel,                                                                             // 2
		    joinChannel = _ref$joinChannel === undefined ? true : _ref$joinChannel,                                          // 2
		    _ref$errorOnEmpty = _ref.errorOnEmpty,                                                                           // 2
		    errorOnEmpty = _ref$errorOnEmpty === undefined ? true : _ref$errorOnEmpty;                                       // 2
		var room = void 0; //If the nameOrId starts with #, then let's try to find a channel or group                        // 3
                                                                                                                       //
		if (nameOrId.startsWith('#')) {                                                                                      // 6
			nameOrId = nameOrId.substring(1);                                                                                   // 7
			room = RocketChat.models.Rooms.findOneByIdOrName(nameOrId);                                                         // 8
		} else if (nameOrId.startsWith('@') || type === 'd') {                                                               // 9
			var _ret = function () {                                                                                            // 9
				//If the nameOrId starts with @ OR type is 'd', then let's try just a direct message                               // 10
				nameOrId = nameOrId.replace('@', '');                                                                              // 11
				var roomUser = void 0;                                                                                             // 13
                                                                                                                       //
				if (tryDirectByUserIdOnly) {                                                                                       // 14
					roomUser = RocketChat.models.Users.findOneById(nameOrId);                                                         // 15
				} else {                                                                                                           // 16
					roomUser = RocketChat.models.Users.findOne({                                                                      // 17
						$or: [{                                                                                                          // 18
							_id: nameOrId                                                                                                   // 18
						}, {                                                                                                             // 18
							username: nameOrId                                                                                              // 18
						}]                                                                                                               // 18
					});                                                                                                               // 17
				}                                                                                                                  // 20
                                                                                                                       //
				var rid = _.isObject(roomUser) ? [currentUserId, roomUser._id].sort().join('') : nameOrId;                         // 22
				room = RocketChat.models.Rooms.findOneById(rid); //If the room hasn't been found yet, let's try some more          // 23
                                                                                                                       //
				if (!_.isObject(room)) {                                                                                           // 26
					//If the roomUser wasn't found, then there's no destination to point towards                                      // 27
					//so return out based upon errorOnEmpty                                                                           // 28
					if (!_.isObject(roomUser)) {                                                                                      // 29
						if (errorOnEmpty) {                                                                                              // 30
							throw new Meteor.Error('invalid-channel');                                                                      // 31
						} else {                                                                                                         // 32
							return {                                                                                                        // 33
								v: void 0                                                                                                      // 33
							};                                                                                                              // 33
						}                                                                                                                // 34
					}                                                                                                                 // 35
                                                                                                                       //
					room = Meteor.runAsUser(currentUserId, function () {                                                              // 37
						var _Meteor$call = Meteor.call('createDirectMessage', roomUser.username),                                        // 37
						    rid = _Meteor$call.rid;                                                                                      // 37
                                                                                                                       //
						return RocketChat.models.Rooms.findOneById(rid);                                                                 // 39
					});                                                                                                               // 40
				}                                                                                                                  // 41
			}();                                                                                                                // 9
                                                                                                                       //
			if ((typeof _ret === "undefined" ? "undefined" : (0, _typeof3.default)(_ret)) === "object") return _ret.v;          // 9
		} else {                                                                                                             // 42
			//Otherwise, we'll treat this as a channel or group.                                                                // 43
			room = RocketChat.models.Rooms.findOneByIdOrName(nameOrId);                                                         // 44
		} //If no room was found, handle the room return based upon errorOnEmpty                                             // 45
                                                                                                                       //
                                                                                                                       //
		if (!room && errorOnEmpty) {                                                                                         // 48
			throw new Meteor.Error('invalid-channel');                                                                          // 49
		} else if (!room) {                                                                                                  // 50
			return;                                                                                                             // 51
		} //If a room was found and they provided a type to search, then check                                               // 52
		//and if the type found isn't what we're looking for then handle                                                     // 55
		//the return based upon errorOnEmpty                                                                                 // 56
                                                                                                                       //
                                                                                                                       //
		if (type && room.t !== type) {                                                                                       // 57
			if (errorOnEmpty) {                                                                                                 // 58
				throw new Meteor.Error('invalid-channel');                                                                         // 59
			} else {                                                                                                            // 60
				return;                                                                                                            // 61
			}                                                                                                                   // 62
		} //If the room type is channel and joinChannel has been passed, try to join them                                    // 63
		//if they can't join the room, this will error out!                                                                  // 66
                                                                                                                       //
                                                                                                                       //
		if (room.t === 'c' && joinChannel) {                                                                                 // 67
			var sub = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, currentUserId);                        // 68
                                                                                                                       //
			if (!sub) {                                                                                                         // 70
				Meteor.runAsUser(currentUserId, function () {                                                                      // 71
					return Meteor.call('joinRoom', room._id);                                                                         // 72
				});                                                                                                                // 73
			}                                                                                                                   // 74
		}                                                                                                                    // 75
                                                                                                                       //
		return room;                                                                                                         // 77
	}                                                                                                                     // 78
                                                                                                                       //
	return _getRoomByNameOrIdWithOptionToJoin;                                                                            // 2
}();                                                                                                                   // 2
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"removeUserFromRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/removeUserFromRoom.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.removeUserFromRoom = function (rid, user) {                                                                 // 1
	var room = RocketChat.models.Rooms.findOneById(rid);                                                                  // 2
                                                                                                                       //
	if (room) {                                                                                                           // 4
		RocketChat.callbacks.run('beforeLeaveRoom', user, room);                                                             // 5
		RocketChat.models.Rooms.removeUsernameById(rid, user.username);                                                      // 6
                                                                                                                       //
		if (room.usernames.indexOf(user.username) !== -1) {                                                                  // 8
			var removedUser = user;                                                                                             // 9
			RocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(rid, removedUser);                                      // 10
		}                                                                                                                    // 11
                                                                                                                       //
		if (room.t === 'l') {                                                                                                // 13
			RocketChat.models.Messages.createCommandWithRoomIdAndUser('survey', rid, user);                                     // 14
		}                                                                                                                    // 15
                                                                                                                       //
		RocketChat.models.Subscriptions.removeByRoomIdAndUserId(rid, user._id);                                              // 17
		Meteor.defer(function () {                                                                                           // 19
			RocketChat.callbacks.run('afterLeaveRoom', user, room);                                                             // 20
		});                                                                                                                  // 21
	}                                                                                                                     // 22
};                                                                                                                     // 23
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"saveUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/saveUser.js                                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals Gravatar */RocketChat.saveUser = function (userId, userData) {                                              // 1
	var user = RocketChat.models.Users.findOneById(userId);                                                               // 3
                                                                                                                       //
	var existingRoles = _.pluck(RocketChat.authz.getRoles(), '_id');                                                      // 4
                                                                                                                       //
	if (userData._id && userId !== userData._id && !RocketChat.authz.hasPermission(userId, 'edit-other-user-info')) {     // 6
		throw new Meteor.Error('error-action-not-allowed', 'Editing user is not allowed', {                                  // 7
			method: 'insertOrUpdateUser',                                                                                       // 7
			action: 'Editing_user'                                                                                              // 7
		});                                                                                                                  // 7
	}                                                                                                                     // 8
                                                                                                                       //
	if (!userData._id && !RocketChat.authz.hasPermission(userId, 'create-user')) {                                        // 10
		throw new Meteor.Error('error-action-not-allowed', 'Adding user is not allowed', {                                   // 11
			method: 'insertOrUpdateUser',                                                                                       // 11
			action: 'Adding_user'                                                                                               // 11
		});                                                                                                                  // 11
	}                                                                                                                     // 12
                                                                                                                       //
	if (userData.roles && _.difference(userData.roles, existingRoles).length > 0) {                                       // 14
		throw new Meteor.Error('error-action-not-allowed', 'The field Roles consist invalid role name', {                    // 15
			method: 'insertOrUpdateUser',                                                                                       // 15
			action: 'Assign_role'                                                                                               // 15
		});                                                                                                                  // 15
	}                                                                                                                     // 16
                                                                                                                       //
	if (userData.roles && _.indexOf(userData.roles, 'admin') >= 0 && !RocketChat.authz.hasPermission(userId, 'assign-admin-role')) {
		throw new Meteor.Error('error-action-not-allowed', 'Assigning admin is not allowed', {                               // 19
			method: 'insertOrUpdateUser',                                                                                       // 19
			action: 'Assign_admin'                                                                                              // 19
		});                                                                                                                  // 19
	}                                                                                                                     // 20
                                                                                                                       //
	if (!userData._id && !s.trim(userData.name)) {                                                                        // 22
		throw new Meteor.Error('error-the-field-is-required', 'The field Name is required', {                                // 23
			method: 'insertOrUpdateUser',                                                                                       // 23
			field: 'Name'                                                                                                       // 23
		});                                                                                                                  // 23
	}                                                                                                                     // 24
                                                                                                                       //
	if (!userData._id && !s.trim(userData.username)) {                                                                    // 26
		throw new Meteor.Error('error-the-field-is-required', 'The field Username is required', {                            // 27
			method: 'insertOrUpdateUser',                                                                                       // 27
			field: 'Username'                                                                                                   // 27
		});                                                                                                                  // 27
	}                                                                                                                     // 28
                                                                                                                       //
	var nameValidation = void 0;                                                                                          // 30
                                                                                                                       //
	try {                                                                                                                 // 32
		nameValidation = new RegExp('^' + RocketChat.settings.get('UTF8_Names_Validation') + '$');                           // 33
	} catch (e) {                                                                                                         // 34
		nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                    // 35
	}                                                                                                                     // 36
                                                                                                                       //
	if (userData.username && !nameValidation.test(userData.username)) {                                                   // 38
		throw new Meteor.Error('error-input-is-not-a-valid-field', _.escape(userData.username) + " is not a valid username", {
			method: 'insertOrUpdateUser',                                                                                       // 39
			input: userData.username,                                                                                           // 39
			field: 'Username'                                                                                                   // 39
		});                                                                                                                  // 39
	}                                                                                                                     // 40
                                                                                                                       //
	if (!userData._id && !userData.password) {                                                                            // 42
		throw new Meteor.Error('error-the-field-is-required', 'The field Password is required', {                            // 43
			method: 'insertOrUpdateUser',                                                                                       // 43
			field: 'Password'                                                                                                   // 43
		});                                                                                                                  // 43
	}                                                                                                                     // 44
                                                                                                                       //
	if (!userData._id) {                                                                                                  // 46
		if (!RocketChat.checkUsernameAvailability(userData.username)) {                                                      // 47
			throw new Meteor.Error('error-field-unavailable', _.escape(userData.username) + " is already in use :(", {          // 48
				method: 'insertOrUpdateUser',                                                                                      // 48
				field: userData.username                                                                                           // 48
			});                                                                                                                 // 48
		}                                                                                                                    // 49
                                                                                                                       //
		if (userData.email && !RocketChat.checkEmailAvailability(userData.email)) {                                          // 51
			throw new Meteor.Error('error-field-unavailable', _.escape(userData.email) + " is already in use :(", {             // 52
				method: 'insertOrUpdateUser',                                                                                      // 52
				field: userData.email                                                                                              // 52
			});                                                                                                                 // 52
		}                                                                                                                    // 53
                                                                                                                       //
		RocketChat.validateEmailDomain(userData.email); // insert user                                                       // 55
                                                                                                                       //
		var createUser = {                                                                                                   // 58
			username: userData.username,                                                                                        // 59
			password: userData.password,                                                                                        // 60
			joinDefaultChannels: userData.joinDefaultChannels                                                                   // 61
		};                                                                                                                   // 58
                                                                                                                       //
		if (userData.email) {                                                                                                // 63
			createUser.email = userData.email;                                                                                  // 64
		}                                                                                                                    // 65
                                                                                                                       //
		var _id = Accounts.createUser(createUser);                                                                           // 67
                                                                                                                       //
		var updateUser = {                                                                                                   // 69
			$set: {                                                                                                             // 70
				name: userData.name,                                                                                               // 71
				roles: userData.roles || ['user']                                                                                  // 72
			}                                                                                                                   // 70
		};                                                                                                                   // 69
                                                                                                                       //
		if (userData.requirePasswordChange) {                                                                                // 76
			updateUser.$set.requirePasswordChange = userData.requirePasswordChange;                                             // 77
		}                                                                                                                    // 78
                                                                                                                       //
		if (userData.verified) {                                                                                             // 80
			updateUser.$set['emails.0.verified'] = true;                                                                        // 81
		}                                                                                                                    // 82
                                                                                                                       //
		Meteor.users.update({                                                                                                // 84
			_id: _id                                                                                                            // 84
		}, updateUser);                                                                                                      // 84
                                                                                                                       //
		if (userData.sendWelcomeEmail) {                                                                                     // 86
			(function () {                                                                                                      // 86
				var header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');                       // 87
				var footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');                       // 88
				var subject = void 0,                                                                                              // 90
				    html = void 0;                                                                                                 // 90
                                                                                                                       //
				if (RocketChat.settings.get('Accounts_UserAddedEmail_Customized')) {                                               // 92
					subject = RocketChat.settings.get('Accounts_UserAddedEmailSubject');                                              // 93
					html = RocketChat.settings.get('Accounts_UserAddedEmail');                                                        // 94
				} else {                                                                                                           // 95
					subject = TAPi18n.__('Accounts_UserAddedEmailSubject_Default', {                                                  // 96
						lng: user.language || RocketChat.settings.get('language') || 'en'                                                // 96
					});                                                                                                               // 96
					html = TAPi18n.__('Accounts_UserAddedEmail_Default', {                                                            // 97
						lng: user.language || RocketChat.settings.get('language') || 'en'                                                // 97
					});                                                                                                               // 97
				}                                                                                                                  // 98
                                                                                                                       //
				subject = RocketChat.placeholders.replace(subject);                                                                // 100
				html = RocketChat.placeholders.replace(html, {                                                                     // 101
					name: userData.name,                                                                                              // 102
					email: userData.email,                                                                                            // 103
					password: userData.password                                                                                       // 104
				});                                                                                                                // 101
				var email = {                                                                                                      // 107
					to: userData.email,                                                                                               // 108
					from: RocketChat.settings.get('From_Email'),                                                                      // 109
					subject: subject,                                                                                                 // 110
					html: header + html + footer                                                                                      // 111
				};                                                                                                                 // 107
				Meteor.defer(function () {                                                                                         // 114
					try {                                                                                                             // 115
						Email.send(email);                                                                                               // 116
					} catch (error) {                                                                                                 // 117
						throw new Meteor.Error('error-email-send-failed', 'Error trying to send email: ' + error.message, {              // 118
							"function": 'RocketChat.saveUser',                                                                              // 118
							message: error.message                                                                                          // 118
						});                                                                                                              // 118
					}                                                                                                                 // 119
				});                                                                                                                // 120
			})();                                                                                                               // 86
		}                                                                                                                    // 121
                                                                                                                       //
		userData._id = _id;                                                                                                  // 123
                                                                                                                       //
		if (RocketChat.settings.get('Accounts_SetDefaultAvatar') === true && userData.email) {                               // 125
			var gravatarUrl = Gravatar.imageUrl(userData.email, {                                                               // 126
				"default": '404',                                                                                                  // 126
				size: 200,                                                                                                         // 126
				secure: true                                                                                                       // 126
			});                                                                                                                 // 126
                                                                                                                       //
			try {                                                                                                               // 128
				RocketChat.setUserAvatar(userData, gravatarUrl, '', 'url');                                                        // 129
			} catch (e) {//Ignore this error for now, as it not being successful isn't bad                                      // 130
			}                                                                                                                   // 132
		}                                                                                                                    // 133
                                                                                                                       //
		return _id;                                                                                                          // 135
	} else {                                                                                                              // 136
		// update user                                                                                                       // 137
		if (userData.username) {                                                                                             // 138
			RocketChat.setUsername(userData._id, userData.username);                                                            // 139
		}                                                                                                                    // 140
                                                                                                                       //
		if (userData.email) {                                                                                                // 142
			RocketChat.setEmail(userData._id, userData.email);                                                                  // 143
		}                                                                                                                    // 144
                                                                                                                       //
		if (userData.password && userData.password.trim() && RocketChat.authz.hasPermission(userId, 'edit-other-user-password')) {
			Accounts.setPassword(userData._id, userData.password.trim());                                                       // 147
		}                                                                                                                    // 148
                                                                                                                       //
		var _updateUser = {                                                                                                  // 150
			$set: {}                                                                                                            // 151
		};                                                                                                                   // 150
                                                                                                                       //
		if (userData.name) {                                                                                                 // 154
			_updateUser.$set.name = userData.name;                                                                              // 155
		}                                                                                                                    // 156
                                                                                                                       //
		if (userData.roles) {                                                                                                // 158
			_updateUser.$set.roles = userData.roles;                                                                            // 159
		}                                                                                                                    // 160
                                                                                                                       //
		if (userData.requirePasswordChange) {                                                                                // 162
			_updateUser.$set.requirePasswordChange = userData.requirePasswordChange;                                            // 163
		}                                                                                                                    // 164
                                                                                                                       //
		if (userData.verified) {                                                                                             // 166
			_updateUser.$set['emails.0.verified'] = userData.verified;                                                          // 167
		}                                                                                                                    // 168
                                                                                                                       //
		Meteor.users.update({                                                                                                // 170
			_id: userData._id                                                                                                   // 170
		}, _updateUser);                                                                                                     // 170
		return true;                                                                                                         // 172
	}                                                                                                                     // 173
};                                                                                                                     // 174
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"saveCustomFields.js":["babel-runtime/helpers/typeof",function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/saveCustomFields.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _typeof2 = require("babel-runtime/helpers/typeof");                                                                //
                                                                                                                       //
var _typeof3 = _interopRequireDefault(_typeof2);                                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.saveCustomFields = function (userId, formData) {                                                            // 1
	if (s.trim(RocketChat.settings.get('Accounts_CustomFields')) !== '') {                                                // 2
		var _ret = function () {                                                                                             // 2
			var customFieldsMeta = void 0;                                                                                      // 3
                                                                                                                       //
			try {                                                                                                               // 4
				customFieldsMeta = JSON.parse(RocketChat.settings.get('Accounts_CustomFields'));                                   // 5
			} catch (e) {                                                                                                       // 6
				throw new Meteor.Error('error-invalid-customfield-json', 'Invalid JSON for Custom Fields');                        // 7
			}                                                                                                                   // 8
                                                                                                                       //
			var customFields = {};                                                                                              // 10
			Object.keys(customFieldsMeta).forEach(function (fieldName) {                                                        // 12
				var field = customFieldsMeta[fieldName];                                                                           // 13
				customFields[fieldName] = formData[fieldName];                                                                     // 15
                                                                                                                       //
				if (field.required && !formData[fieldName]) {                                                                      // 16
					throw new Meteor.Error('error-user-registration-custom-field', "Field " + fieldName + " is required", {           // 17
						method: 'registerUser'                                                                                           // 17
					});                                                                                                               // 17
				}                                                                                                                  // 18
                                                                                                                       //
				if (field.type === 'select' && field.options.indexOf(formData[fieldName]) === -1) {                                // 20
					throw new Meteor.Error('error-user-registration-custom-field', "Value for field " + fieldName + " is invalid", {  // 21
						method: 'registerUser'                                                                                           // 21
					});                                                                                                               // 21
				}                                                                                                                  // 22
                                                                                                                       //
				if (field.maxLength && formData[fieldName].length > field.maxLength) {                                             // 24
					throw new Meteor.Error('error-user-registration-custom-field', "Max length of field " + fieldName + " " + field.maxLength, {
						method: 'registerUser'                                                                                           // 25
					});                                                                                                               // 25
				}                                                                                                                  // 26
                                                                                                                       //
				if (field.minLength && formData[fieldName].length < field.minLength) {                                             // 28
					throw new Meteor.Error('error-user-registration-custom-field', "Min length of field " + fieldName + " " + field.minLength, {
						method: 'registerUser'                                                                                           // 29
					});                                                                                                               // 29
				}                                                                                                                  // 30
			}); // for fieldName, field of customFieldsMeta                                                                     // 31
                                                                                                                       //
			RocketChat.models.Users.setCustomFields(userId, customFields);                                                      // 34
			Object.keys(customFields).forEach(function (fieldName) {                                                            // 36
				if (!customFieldsMeta[fieldName].modifyRecordField) {                                                              // 37
					return;                                                                                                           // 38
				}                                                                                                                  // 39
                                                                                                                       //
				var modifyRecordField = customFieldsMeta[fieldName].modifyRecordField;                                             // 41
				var update = {};                                                                                                   // 42
                                                                                                                       //
				if (modifyRecordField.array) {                                                                                     // 43
					update.$addToSet = {};                                                                                            // 44
					update.$addToSet[modifyRecordField.field] = customFields[fieldName];                                              // 45
				} else {                                                                                                           // 46
					update.$set = {};                                                                                                 // 47
					update.$set[modifyRecordField.field] = customFields[fieldName];                                                   // 48
				}                                                                                                                  // 49
                                                                                                                       //
				RocketChat.models.Users.update(userId, update);                                                                    // 51
			});                                                                                                                 // 52
			return {                                                                                                            // 54
				v: true                                                                                                            // 54
			};                                                                                                                  // 54
		}();                                                                                                                 // 2
                                                                                                                       //
		if ((typeof _ret === "undefined" ? "undefined" : (0, _typeof3.default)(_ret)) === "object") return _ret.v;           // 2
	}                                                                                                                     // 55
};                                                                                                                     // 56
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"sendMessage.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/sendMessage.coffee.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.sendMessage = function (user, message, room, upsert) {                                                      //
  var _id, sandstormSessionId, updated_room, urls;                                                                     //
                                                                                                                       //
  if (upsert == null) {                                                                                                //
    upsert = false;                                                                                                    //
  }                                                                                                                    //
                                                                                                                       //
  if (!user || !message || !room._id) {                                                                                //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  if (message.ts == null) {                                                                                            //
    message.ts = new Date();                                                                                           //
  }                                                                                                                    //
                                                                                                                       //
  message.u = _.pick(user, ['_id', 'username']);                                                                       //
                                                                                                                       //
  if (!Match.test(message.msg, String)) {                                                                              //
    message.msg = '';                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  message.rid = room._id;                                                                                              //
                                                                                                                       //
  if (room.usernames == null || room.usernames.length === 0) {                                                         //
    updated_room = RocketChat.models.Rooms.findOneById(room._id);                                                      //
                                                                                                                       //
    if (updated_room != null) {                                                                                        //
      room = updated_room;                                                                                             //
    } else {                                                                                                           //
      room.usernames = [];                                                                                             //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  if (message.parseUrls !== false) {                                                                                   //
    if (urls = message.msg.match(/([A-Za-z]{3,9}):\/\/([-;:&=\+\$,\w]+@{1})?([-A-Za-z0-9\.]+)+:?(\d+)?((\/[-\+=!:~%\/\.@\,\w]*)?\??([-\+=&!:;%@\/\.\,\w]+)?(?:#([^\s\)]+))?)?/g)) {
      message.urls = urls.map(function (url) {                                                                         //
        return {                                                                                                       //
          url: url                                                                                                     //
        };                                                                                                             //
      });                                                                                                              //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  message = RocketChat.callbacks.run('beforeSaveMessage', message);                                                    //
  sandstormSessionId = null;                                                                                           //
                                                                                                                       //
  if (message.sandstormSessionId) {                                                                                    //
    sandstormSessionId = message.sandstormSessionId;                                                                   //
    delete message.sandstormSessionId;                                                                                 //
  }                                                                                                                    //
                                                                                                                       //
  if (message._id != null && upsert) {                                                                                 //
    _id = message._id;                                                                                                 //
    delete message._id;                                                                                                //
    RocketChat.models.Messages.upsert({                                                                                //
      _id: _id,                                                                                                        //
      'u._id': message.u._id                                                                                           //
    }, message);                                                                                                       //
    message._id = _id;                                                                                                 //
  } else {                                                                                                             //
    message._id = RocketChat.models.Messages.insert(message);                                                          //
  } /*                                                                                                                 //
    	Defer other updates as their return is not interesting to the user                                                //
     */                                                                                                                //
                                                                                                                       //
  Meteor.defer(function () {                                                                                           //
    message.sandstormSessionId = sandstormSessionId;                                                                   //
    return RocketChat.callbacks.run('afterSaveMessage', message, room);                                                //
  });                                                                                                                  //
  return message;                                                                                                      //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settings.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/settings.coffee.js                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var blockedSettings, hiddenSettings, ref, ref1;                                                                        //
blockedSettings = {};                                                                                                  //
                                                                                                                       //
if ((ref = process.env.SETTINGS_BLOCKED) != null) {                                                                    //
  ref.split(',').forEach(function (settingId) {                                                                        //
    return blockedSettings[settingId] = 1;                                                                             //
  });                                                                                                                  //
}                                                                                                                      //
                                                                                                                       //
hiddenSettings = {};                                                                                                   //
                                                                                                                       //
if ((ref1 = process.env.SETTINGS_HIDDEN) != null) {                                                                    //
  ref1.split(',').forEach(function (settingId) {                                                                       //
    return hiddenSettings[settingId] = 1;                                                                              //
  });                                                                                                                  //
}                                                                                                                      //
                                                                                                                       //
RocketChat.settings._sorter = {}; /*                                                                                   //
                                   * Add a setting                                                                     //
                                   * @param {String} _id                                                               //
                                   * @param {Mixed} value                                                              //
                                   * @param {Object} setting                                                           //
                                   */                                                                                  //
                                                                                                                       //
RocketChat.settings.add = function (_id, value, options) {                                                             //
  var base, existantSetting, name, query, ref2, ref3, ref4, updateOperations;                                          //
                                                                                                                       //
  if (options == null) {                                                                                               //
    options = {};                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  if (!_id || value == null) {                                                                                         //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  if ((base = RocketChat.settings._sorter)[name = options.group] == null) {                                            //
    base[name] = 0;                                                                                                    //
  }                                                                                                                    //
                                                                                                                       //
  options.packageValue = value;                                                                                        //
  options.valueSource = 'packageValue';                                                                                //
  options.hidden = false;                                                                                              //
  options.blocked = options.blocked || false;                                                                          //
                                                                                                                       //
  if (options.sorter == null) {                                                                                        //
    options.sorter = RocketChat.settings._sorter[options.group]++;                                                     //
  }                                                                                                                    //
                                                                                                                       //
  if (options.enableQuery != null) {                                                                                   //
    options.enableQuery = JSON.stringify(options.enableQuery);                                                         //
  }                                                                                                                    //
                                                                                                                       //
  if (options.i18nDefaultQuery != null) {                                                                              //
    options.i18nDefaultQuery = JSON.stringify(options.i18nDefaultQuery);                                               //
  }                                                                                                                    //
                                                                                                                       //
  if ((typeof process !== "undefined" && process !== null ? (ref2 = process.env) != null ? ref2[_id] : void 0 : void 0) != null) {
    value = process.env[_id];                                                                                          //
                                                                                                                       //
    if (value.toLowerCase() === "true") {                                                                              //
      value = true;                                                                                                    //
    } else if (value.toLowerCase() === "false") {                                                                      //
      value = false;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    options.processEnvValue = value;                                                                                   //
    options.valueSource = 'processEnvValue';                                                                           //
  } else if (((ref3 = Meteor.settings) != null ? ref3[_id] : void 0) != null) {                                        //
    value = Meteor.settings[_id];                                                                                      //
    options.meteorSettingsValue = value;                                                                               //
    options.valueSource = 'meteorSettingsValue';                                                                       //
  }                                                                                                                    //
                                                                                                                       //
  if (options.i18nLabel == null) {                                                                                     //
    options.i18nLabel = _id;                                                                                           //
  }                                                                                                                    //
                                                                                                                       //
  if (options.i18nDescription == null) {                                                                               //
    options.i18nDescription = _id + "_Description";                                                                    //
  }                                                                                                                    //
                                                                                                                       //
  if (blockedSettings[_id] != null) {                                                                                  //
    options.blocked = true;                                                                                            //
  }                                                                                                                    //
                                                                                                                       //
  if (hiddenSettings[_id] != null) {                                                                                   //
    options.hidden = true;                                                                                             //
  }                                                                                                                    //
                                                                                                                       //
  if ((typeof process !== "undefined" && process !== null ? (ref4 = process.env) != null ? ref4['OVERWRITE_SETTING_' + _id] : void 0 : void 0) != null) {
    value = process.env['OVERWRITE_SETTING_' + _id];                                                                   //
                                                                                                                       //
    if (value.toLowerCase() === "true") {                                                                              //
      value = true;                                                                                                    //
    } else if (value.toLowerCase() === "false") {                                                                      //
      value = false;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    options.value = value;                                                                                             //
    options.processEnvValue = value;                                                                                   //
    options.valueSource = 'processEnvValue';                                                                           //
  }                                                                                                                    //
                                                                                                                       //
  updateOperations = {                                                                                                 //
    $set: options,                                                                                                     //
    $setOnInsert: {                                                                                                    //
      createdAt: new Date()                                                                                            //
    }                                                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  if (options.editor != null) {                                                                                        //
    updateOperations.$setOnInsert.editor = options.editor;                                                             //
    delete options.editor;                                                                                             //
  }                                                                                                                    //
                                                                                                                       //
  if (options.value == null) {                                                                                         //
    if (options.force === true) {                                                                                      //
      updateOperations.$set.value = options.packageValue;                                                              //
    } else {                                                                                                           //
      updateOperations.$setOnInsert.value = value;                                                                     //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  query = _.extend({                                                                                                   //
    _id: _id                                                                                                           //
  }, updateOperations.$set);                                                                                           //
                                                                                                                       //
  if (options.section == null) {                                                                                       //
    updateOperations.$unset = {                                                                                        //
      section: 1                                                                                                       //
    };                                                                                                                 //
    query.section = {                                                                                                  //
      $exists: false                                                                                                   //
    };                                                                                                                 //
  }                                                                                                                    //
                                                                                                                       //
  existantSetting = RocketChat.models.Settings.db.findOne(query);                                                      //
                                                                                                                       //
  if (existantSetting != null) {                                                                                       //
    if (existantSetting.editor == null && updateOperations.$setOnInsert.editor != null) {                              //
      updateOperations.$set.editor = updateOperations.$setOnInsert.editor;                                             //
      delete updateOperations.$setOnInsert.editor;                                                                     //
    }                                                                                                                  //
  } else {                                                                                                             //
    updateOperations.$set.ts = new Date();                                                                             //
  }                                                                                                                    //
                                                                                                                       //
  return RocketChat.models.Settings.upsert({                                                                           //
    _id: _id                                                                                                           //
  }, updateOperations);                                                                                                //
}; /*                                                                                                                  //
    * Add a setting group                                                                                              //
    * @param {String} _id                                                                                              //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.settings.addGroup = function (_id, options, cb) {                                                           //
  if (options == null) {                                                                                               //
    options = {};                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  if (!_id) {                                                                                                          //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  if (_.isFunction(options)) {                                                                                         //
    cb = options;                                                                                                      //
    options = {};                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  if (options.i18nLabel == null) {                                                                                     //
    options.i18nLabel = _id;                                                                                           //
  }                                                                                                                    //
                                                                                                                       //
  if (options.i18nDescription == null) {                                                                               //
    options.i18nDescription = _id + "_Description";                                                                    //
  }                                                                                                                    //
                                                                                                                       //
  options.ts = new Date();                                                                                             //
  options.blocked = false;                                                                                             //
  options.hidden = false;                                                                                              //
                                                                                                                       //
  if (blockedSettings[_id] != null) {                                                                                  //
    options.blocked = true;                                                                                            //
  }                                                                                                                    //
                                                                                                                       //
  if (hiddenSettings[_id] != null) {                                                                                   //
    options.hidden = true;                                                                                             //
  }                                                                                                                    //
                                                                                                                       //
  RocketChat.models.Settings.upsert({                                                                                  //
    _id: _id                                                                                                           //
  }, {                                                                                                                 //
    $set: options,                                                                                                     //
    $setOnInsert: {                                                                                                    //
      type: 'group',                                                                                                   //
      createdAt: new Date()                                                                                            //
    }                                                                                                                  //
  });                                                                                                                  //
                                                                                                                       //
  if (cb != null) {                                                                                                    //
    cb.call({                                                                                                          //
      add: function (id, value, options) {                                                                             //
        if (options == null) {                                                                                         //
          options = {};                                                                                                //
        }                                                                                                              //
                                                                                                                       //
        options.group = _id;                                                                                           //
        return RocketChat.settings.add(id, value, options);                                                            //
      },                                                                                                               //
      section: function (section, cb) {                                                                                //
        return cb.call({                                                                                               //
          add: function (id, value, options) {                                                                         //
            if (options == null) {                                                                                     //
              options = {};                                                                                            //
            }                                                                                                          //
                                                                                                                       //
            options.group = _id;                                                                                       //
            options.section = section;                                                                                 //
            return RocketChat.settings.add(id, value, options);                                                        //
          }                                                                                                            //
        });                                                                                                            //
      }                                                                                                                //
    });                                                                                                                //
  }                                                                                                                    //
}; /*                                                                                                                  //
    * Remove a setting by id                                                                                           //
    * @param {String} _id                                                                                              //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.settings.removeById = function (_id) {                                                                      //
  if (!_id) {                                                                                                          //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  return RocketChat.models.Settings.removeById(_id);                                                                   //
}; /*                                                                                                                  //
    * Update a setting by id                                                                                           //
    * @param {String} _id                                                                                              //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.settings.updateById = function (_id, value, editor) {                                                       //
  if (!_id || value == null) {                                                                                         //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  if (editor != null) {                                                                                                //
    return RocketChat.models.Settings.updateValueAndEditorById(_id, value, editor);                                    //
  }                                                                                                                    //
                                                                                                                       //
  return RocketChat.models.Settings.updateValueById(_id, value);                                                       //
}; /*                                                                                                                  //
    * Update options of a setting by id                                                                                //
    * @param {String} _id                                                                                              //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.settings.updateOptionsById = function (_id, options) {                                                      //
  if (!_id || options == null) {                                                                                       //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  return RocketChat.models.Settings.updateOptionsById(_id, options);                                                   //
}; /*                                                                                                                  //
    * Update a setting by id                                                                                           //
    * @param {String} _id                                                                                              //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.settings.clearById = function (_id) {                                                                       //
  if (_id == null) {                                                                                                   //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  return RocketChat.models.Settings.updateValueById(_id, void 0);                                                      //
}; /*                                                                                                                  //
    * Update a setting by id                                                                                           //
    */                                                                                                                 //
                                                                                                                       //
RocketChat.settings.init = function () {                                                                               //
  var fn, i, len, ref2, results;                                                                                       //
  RocketChat.settings.initialLoad = true;                                                                              //
  RocketChat.models.Settings.find().observe({                                                                          //
    added: function (record) {                                                                                         //
      Meteor.settings[record._id] = record.value;                                                                      //
                                                                                                                       //
      if (record.env === true) {                                                                                       //
        process.env[record._id] = record.value;                                                                        //
      }                                                                                                                //
                                                                                                                       //
      return RocketChat.settings.load(record._id, record.value, RocketChat.settings.initialLoad);                      //
    },                                                                                                                 //
    changed: function (record) {                                                                                       //
      Meteor.settings[record._id] = record.value;                                                                      //
                                                                                                                       //
      if (record.env === true) {                                                                                       //
        process.env[record._id] = record.value;                                                                        //
      }                                                                                                                //
                                                                                                                       //
      return RocketChat.settings.load(record._id, record.value, RocketChat.settings.initialLoad);                      //
    },                                                                                                                 //
    removed: function (record) {                                                                                       //
      delete Meteor.settings[record._id];                                                                              //
                                                                                                                       //
      if (record.env === true) {                                                                                       //
        delete process.env[record._id];                                                                                //
      }                                                                                                                //
                                                                                                                       //
      return RocketChat.settings.load(record._id, void 0, RocketChat.settings.initialLoad);                            //
    }                                                                                                                  //
  });                                                                                                                  //
  RocketChat.settings.initialLoad = false;                                                                             //
  ref2 = RocketChat.settings.afterInitialLoad;                                                                         //
  results = [];                                                                                                        //
                                                                                                                       //
  for (i = 0, len = ref2.length; i < len; i++) {                                                                       //
    fn = ref2[i];                                                                                                      //
    results.push(fn(Meteor.settings));                                                                                 //
  }                                                                                                                    //
                                                                                                                       //
  return results;                                                                                                      //
};                                                                                                                     //
                                                                                                                       //
RocketChat.settings.afterInitialLoad = [];                                                                             //
                                                                                                                       //
RocketChat.settings.onAfterInitialLoad = function (fn) {                                                               //
  RocketChat.settings.afterInitialLoad.push(fn);                                                                       //
                                                                                                                       //
  if (RocketChat.settings.initialLoad === false) {                                                                     //
    return fn(Meteor.settings);                                                                                        //
  }                                                                                                                    //
};                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setUserAvatar.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/setUserAvatar.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.setUserAvatar = function (user, dataURI, contentType, service) {                                            // 1
	var encoding = void 0,                                                                                                // 2
	    image = void 0;                                                                                                   // 2
                                                                                                                       //
	if (service === 'initials') {                                                                                         // 4
		return RocketChat.models.Users.setAvatarOrigin(user._id, service);                                                   // 5
	} else if (service === 'url') {                                                                                       // 6
		var result = null;                                                                                                   // 7
                                                                                                                       //
		try {                                                                                                                // 9
			result = HTTP.get(dataURI, {                                                                                        // 10
				npmRequestOptions: {                                                                                               // 10
					encoding: 'binary'                                                                                                // 10
				}                                                                                                                  // 10
			});                                                                                                                 // 10
		} catch (error) {                                                                                                    // 11
			if (error.response.statusCode !== 404) {                                                                            // 12
				console.log("Error while handling the setting of the avatar from a url (" + dataURI + ") for " + user.username + ":", error);
				throw new Meteor.Error('error-avatar-url-handling', "Error while handling avatar setting from a URL (" + dataURI + ") for " + user.username, {
					"function": 'RocketChat.setUserAvatar',                                                                           // 14
					url: dataURI,                                                                                                     // 14
					username: user.username                                                                                           // 14
				});                                                                                                                // 14
			}                                                                                                                   // 15
		}                                                                                                                    // 16
                                                                                                                       //
		if (result.statusCode !== 200) {                                                                                     // 18
			console.log("Not a valid response, " + result.statusCode + ", from the avatar url: " + dataURI);                    // 19
			throw new Meteor.Error('error-avatar-invalid-url', "Invalid avatar URL: " + dataURI, {                              // 20
				"function": 'RocketChat.setUserAvatar',                                                                            // 20
				url: dataURI                                                                                                       // 20
			});                                                                                                                 // 20
		}                                                                                                                    // 21
                                                                                                                       //
		if (!/image\/.+/.test(result.headers['content-type'])) {                                                             // 23
			console.log("Not a valid content-type from the provided url, " + result.headers['content-type'] + ", from the avatar url: " + dataURI);
			throw new Meteor.Error('error-avatar-invalid-url', "Invalid avatar URL: " + dataURI, {                              // 25
				"function": 'RocketChat.setUserAvatar',                                                                            // 25
				url: dataURI                                                                                                       // 25
			});                                                                                                                 // 25
		}                                                                                                                    // 26
                                                                                                                       //
		encoding = 'binary';                                                                                                 // 28
		image = result.content;                                                                                              // 29
		contentType = result.headers['content-type'];                                                                        // 30
	} else if (service === 'rest') {                                                                                      // 31
		encoding = 'binary';                                                                                                 // 32
		image = dataURI;                                                                                                     // 33
	} else {                                                                                                              // 34
		var fileData = RocketChatFile.dataURIParse(dataURI);                                                                 // 35
		encoding = 'base64';                                                                                                 // 36
		image = fileData.image;                                                                                              // 37
		contentType = fileData.contentType;                                                                                  // 38
	}                                                                                                                     // 39
                                                                                                                       //
	var rs = RocketChatFile.bufferToStream(new Buffer(image, encoding));                                                  // 41
	RocketChatFileAvatarInstance.deleteFile(encodeURIComponent(user.username + ".jpg"));                                  // 42
	var ws = RocketChatFileAvatarInstance.createWriteStream(encodeURIComponent(user.username + ".jpg"), contentType);     // 43
	ws.on('end', Meteor.bindEnvironment(function () {                                                                     // 44
		Meteor.setTimeout(function () {                                                                                      // 45
			RocketChat.models.Users.setAvatarOrigin(user._id, service);                                                         // 46
			RocketChat.Notifications.notifyLogged('updateAvatar', {                                                             // 47
				username: user.username                                                                                            // 47
			});                                                                                                                 // 47
		}, 500);                                                                                                             // 48
	}));                                                                                                                  // 49
	rs.pipe(ws);                                                                                                          // 50
};                                                                                                                     // 51
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setUsername.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/setUsername.coffee.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat._setUsername = function (userId, username) {                                                                //
  var avatarData, avatarSuggestions, error, gravatar, nameValidation, previousUsername, ref, rs, service, user, ws;    //
  username = s.trim(username);                                                                                         //
                                                                                                                       //
  if (!userId || !username) {                                                                                          //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  try {                                                                                                                //
    nameValidation = new RegExp('^' + RocketChat.settings.get('UTF8_Names_Validation') + '$');                         //
  } catch (error1) {                                                                                                   //
    nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  if (!nameValidation.test(username)) {                                                                                //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  user = RocketChat.models.Users.findOneById(userId);                                                                  //
                                                                                                                       //
  if (user.username === username) {                                                                                    //
    return user;                                                                                                       //
  }                                                                                                                    //
                                                                                                                       //
  previousUsername = user.username;                                                                                    //
                                                                                                                       //
  if (!previousUsername || !(username.toLowerCase() === previousUsername.toLowerCase())) {                             //
    if (!RocketChat.checkUsernameAvailability(username)) {                                                             //
      return false;                                                                                                    //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  try {                                                                                                                //
    if (!previousUsername && ((ref = user.emails) != null ? ref.length : void 0) > 0 && RocketChat.settings.get('Accounts_Enrollment_Email')) {
      Accounts.sendEnrollmentEmail(user._id);                                                                          //
    }                                                                                                                  //
  } catch (error1) {                                                                                                   //
    error = error1;                                                                                                    //
  }                                                                                                                    //
                                                                                                                       //
  user.username = username;                                                                                            //
                                                                                                                       //
  if (!previousUsername && RocketChat.settings.get('Accounts_SetDefaultAvatar') === true) {                            //
    avatarSuggestions = getAvatarSuggestionForUser(user);                                                              //
                                                                                                                       //
    for (service in meteorBabelHelpers.sanitizeForInObject(avatarSuggestions)) {                                       //
      avatarData = avatarSuggestions[service];                                                                         //
                                                                                                                       //
      if (service !== 'gravatar') {                                                                                    //
        RocketChat.setUserAvatar(user, avatarData.blob, avatarData.contentType, service);                              //
        gravatar = null;                                                                                               //
        break;                                                                                                         //
      } else {                                                                                                         //
        gravatar = avatarData;                                                                                         //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    if (gravatar != null) {                                                                                            //
      RocketChat.setUserAvatar(user, gravatar.blob, gravatar.contentType, 'gravatar');                                 //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  if (previousUsername) {                                                                                              //
    RocketChat.models.Messages.updateAllUsernamesByUserId(user._id, username);                                         //
    RocketChat.models.Messages.updateUsernameOfEditByUserId(user._id, username);                                       //
    RocketChat.models.Messages.findByMention(previousUsername).forEach(function (msg) {                                //
      var updatedMsg;                                                                                                  //
      updatedMsg = msg.msg.replace(new RegExp("@" + previousUsername, "ig"), "@" + username);                          //
      return RocketChat.models.Messages.updateUsernameAndMessageOfMentionByIdAndOldUsername(msg._id, previousUsername, username, updatedMsg);
    });                                                                                                                //
    RocketChat.models.Rooms.replaceUsername(previousUsername, username);                                               //
    RocketChat.models.Rooms.replaceMutedUsername(previousUsername, username);                                          //
    RocketChat.models.Rooms.replaceUsernameOfUserByUserId(user._id, username);                                         //
    RocketChat.models.Subscriptions.setUserUsernameByUserId(user._id, username);                                       //
    RocketChat.models.Subscriptions.setNameForDirectRoomsWithOldName(previousUsername, username);                      //
    rs = RocketChatFileAvatarInstance.getFileWithReadStream(encodeURIComponent(previousUsername + ".jpg"));            //
                                                                                                                       //
    if (rs != null) {                                                                                                  //
      RocketChatFileAvatarInstance.deleteFile(encodeURIComponent(username + ".jpg"));                                  //
      ws = RocketChatFileAvatarInstance.createWriteStream(encodeURIComponent(username + ".jpg"), rs.contentType);      //
      ws.on('end', Meteor.bindEnvironment(function () {                                                                //
        return RocketChatFileAvatarInstance.deleteFile(encodeURIComponent(previousUsername + ".jpg"));                 //
      }));                                                                                                             //
      rs.readStream.pipe(ws);                                                                                          //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  RocketChat.models.Users.setUsername(user._id, username);                                                             //
  return user;                                                                                                         //
};                                                                                                                     //
                                                                                                                       //
RocketChat.setUsername = RocketChat.RateLimiter.limitFunction(RocketChat._setUsername, 1, 60000, {                     //
  0: function (userId) {                                                                                               //
    return !userId || !RocketChat.authz.hasPermission(userId, 'edit-other-user-info');                                 //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setEmail.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/setEmail.js                                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat._setEmail = function (userId, email) {                                                                      // 1
	email = s.trim(email);                                                                                                // 2
                                                                                                                       //
	if (!userId) {                                                                                                        // 3
		throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                       // 4
			"function": '_setEmail'                                                                                             // 4
		});                                                                                                                  // 4
	}                                                                                                                     // 5
                                                                                                                       //
	if (!email) {                                                                                                         // 7
		throw new Meteor.Error('error-invalid-email', 'Invalid email', {                                                     // 8
			"function": '_setEmail'                                                                                             // 8
		});                                                                                                                  // 8
	}                                                                                                                     // 9
                                                                                                                       //
	RocketChat.validateEmailDomain(email);                                                                                // 11
	var user = RocketChat.models.Users.findOneById(userId); // User already has desired username, return                  // 13
                                                                                                                       //
	if (user.emails && user.emails[0] && user.emails[0].address === email) {                                              // 16
		return user;                                                                                                         // 17
	} // Check email availability                                                                                         // 18
                                                                                                                       //
                                                                                                                       //
	if (!RocketChat.checkEmailAvailability(email)) {                                                                      // 21
		throw new Meteor.Error('error-field-unavailable', email + ' is already in use :(', {                                 // 22
			"function": '_setEmail',                                                                                            // 22
			field: email                                                                                                        // 22
		});                                                                                                                  // 22
	} // Set new email                                                                                                    // 23
                                                                                                                       //
                                                                                                                       //
	RocketChat.models.Users.setEmail(user._id, email);                                                                    // 26
	user.email = email;                                                                                                   // 27
	return user;                                                                                                          // 28
};                                                                                                                     // 29
                                                                                                                       //
RocketChat.setEmail = RocketChat.RateLimiter.limitFunction(RocketChat._setEmail, 1, 60000, {                           // 31
	0: function (userId) {                                                                                                // 32
		return !userId || !RocketChat.authz.hasPermission(userId, 'edit-other-user-info');                                   // 32
	} // Administrators have permission to change others emails, so don't limit those                                     // 32
                                                                                                                       //
});                                                                                                                    // 31
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"unarchiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/unarchiveRoom.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.unarchiveRoom = function (rid) {                                                                            // 1
	RocketChat.models.Rooms.unarchiveById(rid);                                                                           // 2
	RocketChat.models.Subscriptions.unarchiveByRoomId(rid);                                                               // 3
};                                                                                                                     // 4
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"updateMessage.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/updateMessage.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.updateMessage = function (message, user) {                                                                  // 1
	// If we keep history of edits, insert a new message to store history information                                     // 2
	if (RocketChat.settings.get('Message_KeepHistory')) {                                                                 // 3
		RocketChat.models.Messages.cloneAndSaveAsHistoryById(message._id);                                                   // 4
	}                                                                                                                     // 5
                                                                                                                       //
	message.editedAt = new Date();                                                                                        // 7
	message.editedBy = {                                                                                                  // 8
		_id: user._id,                                                                                                       // 9
		username: user.username                                                                                              // 10
	};                                                                                                                    // 8
	var urls = message.msg.match(/([A-Za-z]{3,9}):\/\/([-;:&=\+\$,\w]+@{1})?([-A-Za-z0-9\.]+)+:?(\d+)?((\/[-\+=!:~%\/\.@\,\w]*)?\??([-\+=&!:;%@\/\.\,\w]+)?(?:#([^\s\)]+))?)?/g);
                                                                                                                       //
	if (urls) {                                                                                                           // 14
		message.urls = urls.map(function (url) {                                                                             // 15
			return {                                                                                                            // 15
				url: url                                                                                                           // 15
			};                                                                                                                  // 15
		});                                                                                                                  // 15
	}                                                                                                                     // 16
                                                                                                                       //
	message = RocketChat.callbacks.run('beforeSaveMessage', message);                                                     // 18
	var tempid = message._id;                                                                                             // 20
	delete message._id;                                                                                                   // 21
	RocketChat.models.Messages.update({                                                                                   // 23
		_id: tempid                                                                                                          // 23
	}, {                                                                                                                  // 23
		$set: message                                                                                                        // 23
	});                                                                                                                   // 23
	var room = RocketChat.models.Rooms.findOneById(message.rid);                                                          // 25
	Meteor.defer(function () {                                                                                            // 27
		RocketChat.callbacks.run('afterSaveMessage', RocketChat.models.Messages.findOneById(tempid), room);                  // 28
	});                                                                                                                   // 29
};                                                                                                                     // 30
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Notifications.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/Notifications.coffee.js                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var func,                                                                                                              //
    slice = [].slice;                                                                                                  //
RocketChat.Notifications = new (function () {                                                                          //
  function _Class() {                                                                                                  //
    var self;                                                                                                          //
    self = this;                                                                                                       //
    this.debug = false;                                                                                                //
    this.streamAll = new Meteor.Streamer('notify-all');                                                                //
    this.streamLogged = new Meteor.Streamer('notify-logged');                                                          //
    this.streamRoom = new Meteor.Streamer('notify-room');                                                              //
    this.streamRoomUsers = new Meteor.Streamer('notify-room-users');                                                   //
    this.streamUser = new Meteor.Streamer('notify-user');                                                              //
    this.streamAll.allowWrite('none');                                                                                 //
    this.streamLogged.allowWrite('none');                                                                              //
    this.streamRoom.allowWrite('none');                                                                                //
    this.streamRoomUsers.allowWrite(function () {                                                                      //
      var args, e, eventName, i, len, ref, ref1, roomId, subscription, subscriptions, user;                            //
      eventName = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];                          //
      ref = eventName.split('/'), roomId = ref[0], e = ref[1];                                                         //
      user = Meteor.users.findOne(this.userId, {                                                                       //
        fields: {                                                                                                      //
          username: 1                                                                                                  //
        }                                                                                                              //
      });                                                                                                              //
                                                                                                                       //
      if (RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId) != null) {                     //
        subscriptions = RocketChat.models.Subscriptions.findByRoomIdAndNotUserId(roomId, this.userId).fetch();         //
                                                                                                                       //
        for (i = 0, len = subscriptions.length; i < len; i++) {                                                        //
          subscription = subscriptions[i];                                                                             //
          (ref1 = RocketChat.Notifications).notifyUser.apply(ref1, [subscription.u._id, e].concat(slice.call(args)));  //
        }                                                                                                              //
      }                                                                                                                //
                                                                                                                       //
      return false;                                                                                                    //
    });                                                                                                                //
    this.streamUser.allowWrite('logged');                                                                              //
    this.streamAll.allowRead('all');                                                                                   //
    this.streamLogged.allowRead('logged');                                                                             //
    this.streamRoom.allowRead(function (eventName) {                                                                   //
      var room, roomId, user;                                                                                          //
                                                                                                                       //
      if (this.userId == null) {                                                                                       //
        return false;                                                                                                  //
      }                                                                                                                //
                                                                                                                       //
      roomId = eventName.split('/')[0];                                                                                //
      user = Meteor.users.findOne(this.userId, {                                                                       //
        fields: {                                                                                                      //
          username: 1                                                                                                  //
        }                                                                                                              //
      });                                                                                                              //
      room = RocketChat.models.Rooms.findOneById(roomId);                                                              //
                                                                                                                       //
      if (room.t === 'l' && room.v._id === user._id) {                                                                 //
        return true;                                                                                                   //
      }                                                                                                                //
                                                                                                                       //
      return room.usernames.indexOf(user.username) > -1;                                                               //
    });                                                                                                                //
    this.streamRoomUsers.allowRead('none');                                                                            //
    this.streamUser.allowRead(function (eventName) {                                                                   //
      var userId;                                                                                                      //
      userId = eventName.split('/')[0];                                                                                //
      return this.userId != null && this.userId === userId;                                                            //
    });                                                                                                                //
  }                                                                                                                    //
                                                                                                                       //
  _Class.prototype.notifyAll = function () {                                                                           //
    var args, eventName;                                                                                               //
    eventName = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];                            //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyAll', arguments);                                                                             //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(eventName);                                                                                           //
    return this.streamAll.emit.apply(this.streamAll, args);                                                            //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.notifyLogged = function () {                                                                        //
    var args, eventName;                                                                                               //
    eventName = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];                            //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyLogged', arguments);                                                                          //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(eventName);                                                                                           //
    return this.streamLogged.emit.apply(this.streamLogged, args);                                                      //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.notifyRoom = function () {                                                                          //
    var args, eventName, room;                                                                                         //
    room = arguments[0], eventName = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];       //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyRoom', arguments);                                                                            //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(room + "/" + eventName);                                                                              //
    return this.streamRoom.emit.apply(this.streamRoom, args);                                                          //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.notifyUser = function () {                                                                          //
    var args, eventName, userId;                                                                                       //
    userId = arguments[0], eventName = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];     //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyUser', arguments);                                                                            //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(userId + "/" + eventName);                                                                            //
    return this.streamUser.emit.apply(this.streamUser, args);                                                          //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.notifyAllInThisInstance = function () {                                                             //
    var args, eventName;                                                                                               //
    eventName = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];                            //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyAll', arguments);                                                                             //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(eventName);                                                                                           //
    return this.streamAll.emitWithoutBroadcast.apply(this.streamAll, args);                                            //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.notifyLoggedInThisInstance = function () {                                                          //
    var args, eventName;                                                                                               //
    eventName = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];                            //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyLogged', arguments);                                                                          //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(eventName);                                                                                           //
    return this.streamLogged.emitWithoutBroadcast.apply(this.streamLogged, args);                                      //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.notifyRoomInThisInstance = function () {                                                            //
    var args, eventName, room;                                                                                         //
    room = arguments[0], eventName = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];       //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyRoomAndBroadcast', arguments);                                                                //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(room + "/" + eventName);                                                                              //
    return this.streamRoom.emitWithoutBroadcast.apply(this.streamRoom, args);                                          //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.notifyUserInThisInstance = function () {                                                            //
    var args, eventName, userId;                                                                                       //
    userId = arguments[0], eventName = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];     //
                                                                                                                       //
    if (this.debug === true) {                                                                                         //
      console.log('notifyUserAndBroadcast', arguments);                                                                //
    }                                                                                                                  //
                                                                                                                       //
    args.unshift(userId + "/" + eventName);                                                                            //
    return this.streamUser.emitWithoutBroadcast.apply(this.streamUser, args);                                          //
  };                                                                                                                   //
                                                                                                                       //
  return _Class;                                                                                                       //
}())();                                                                                                                //
                                                                                                                       //
func = function (eventName, username) {                                                                                //
  var e, ref, room, user;                                                                                              //
  ref = eventName.split('/'), room = ref[0], e = ref[1];                                                               //
                                                                                                                       //
  if (e === 'webrtc') {                                                                                                //
    return true;                                                                                                       //
  }                                                                                                                    //
                                                                                                                       //
  if (e === 'typing') {                                                                                                //
    user = Meteor.users.findOne(this.userId, {                                                                         //
      fields: {                                                                                                        //
        username: 1                                                                                                    //
      }                                                                                                                //
    });                                                                                                                //
                                                                                                                       //
    if ((user != null ? user.username : void 0) === username) {                                                        //
      return true;                                                                                                     //
    }                                                                                                                  //
  }                                                                                                                    //
                                                                                                                       //
  return false;                                                                                                        //
};                                                                                                                     //
                                                                                                                       //
RocketChat.Notifications.streamRoom.allowWrite(func);                                                                  //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"models":{"_Base.js":["babel-runtime/helpers/classCallCheck","babel-runtime/helpers/createClass","./_BaseDb","./_BaseCache",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/_Base.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _createClass2 = require("babel-runtime/helpers/createClass");                                                      //
                                                                                                                       //
var _createClass3 = _interopRequireDefault(_createClass2);                                                             //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var ModelsBaseDb = void 0;                                                                                             // 1
module.import('./_BaseDb', {                                                                                           // 1
	"default": function (v) {                                                                                             // 1
		ModelsBaseDb = v;                                                                                                    // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
var ModelsBaseCache = void 0;                                                                                          // 1
module.import('./_BaseCache', {                                                                                        // 1
	"default": function (v) {                                                                                             // 1
		ModelsBaseCache = v;                                                                                                 // 1
	}                                                                                                                     // 1
}, 1);                                                                                                                 // 1
RocketChat.models._CacheControl = new Meteor.EnvironmentVariable();                                                    // 4
                                                                                                                       //
var ModelsBase = function () {                                                                                         //
	function ModelsBase(nameOrModel, useCache) {                                                                          // 7
		(0, _classCallCheck3.default)(this, ModelsBase);                                                                     // 7
		this._db = new ModelsBaseDb(nameOrModel, this);                                                                      // 8
		this.model = this._db.model;                                                                                         // 9
		this.collectionName = this._db.collectionName;                                                                       // 10
		this.name = this._db.name;                                                                                           // 11
		this._useCache = useCache === true;                                                                                  // 13
		this.cache = new ModelsBaseCache(this); // TODO_CACHE: remove                                                        // 15
                                                                                                                       //
		this.on = this.cache.on.bind(this.cache);                                                                            // 17
		this.emit = this.cache.emit.bind(this.cache);                                                                        // 18
		this.getDynamicView = this.cache.getDynamicView.bind(this.cache);                                                    // 19
		this.processQueryOptionsOnResult = this.cache.processQueryOptionsOnResult.bind(this.cache); // END_TODO_CACHE        // 20
                                                                                                                       //
		this.db = this;                                                                                                      // 23
                                                                                                                       //
		if (this._useCache) {                                                                                                // 25
			this.db = new this.constructor(this.model, false);                                                                  // 26
		}                                                                                                                    // 27
	}                                                                                                                     // 28
                                                                                                                       //
	ModelsBase.prototype.arrayToCursor = function () {                                                                    //
		function arrayToCursor(data) {                                                                                       //
			return {                                                                                                            // 43
				fetch: function () {                                                                                               // 44
					return data;                                                                                                      // 45
				},                                                                                                                 // 46
				count: function () {                                                                                               // 47
					return data.length;                                                                                               // 48
				},                                                                                                                 // 49
				forEach: function (fn) {                                                                                           // 50
					return data.forEach(fn);                                                                                          // 51
				}                                                                                                                  // 52
			};                                                                                                                  // 43
		}                                                                                                                    // 54
                                                                                                                       //
		return arrayToCursor;                                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.setUpdatedAt = function () {                                                                     //
		function setUpdatedAt() /*record, checkQuery, query*/{                                                               //
			var _db;                                                                                                            // 56
                                                                                                                       //
			return (_db = this._db).setUpdatedAt.apply(_db, arguments);                                                         // 57
		}                                                                                                                    // 58
                                                                                                                       //
		return setUpdatedAt;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.find = function () {                                                                             //
		function find() {                                                                                                    //
			try {                                                                                                               // 61
				var _origin;                                                                                                       // 61
                                                                                                                       //
				return (_origin = this[this.origin]).find.apply(_origin, arguments);                                               // 62
			} catch (e) {                                                                                                       // 63
				var _console;                                                                                                      // 63
                                                                                                                       //
				(_console = console).error.apply(_console, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 65
		}                                                                                                                    // 66
                                                                                                                       //
		return find;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.findOne = function () {                                                                          //
		function findOne() {                                                                                                 //
			try {                                                                                                               // 69
				var _origin2;                                                                                                      // 69
                                                                                                                       //
				return (_origin2 = this[this.origin]).findOne.apply(_origin2, arguments);                                          // 70
			} catch (e) {                                                                                                       // 71
				var _console2;                                                                                                     // 71
                                                                                                                       //
				(_console2 = console).error.apply(_console2, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 73
		}                                                                                                                    // 74
                                                                                                                       //
		return findOne;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.findOneById = function () {                                                                      //
		function findOneById() {                                                                                             //
			try {                                                                                                               // 77
				var _origin3;                                                                                                      // 77
                                                                                                                       //
				return (_origin3 = this[this.origin]).findOneById.apply(_origin3, arguments);                                      // 78
			} catch (e) {                                                                                                       // 79
				var _console3;                                                                                                     // 79
                                                                                                                       //
				(_console3 = console).error.apply(_console3, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 81
		}                                                                                                                    // 82
                                                                                                                       //
		return findOneById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.findOneByIds = function () {                                                                     //
		function findOneByIds(ids, options) {                                                                                //
			check(ids, [String]);                                                                                               // 85
                                                                                                                       //
			try {                                                                                                               // 87
				return this[this.origin].findOneByIds(ids, options);                                                               // 88
			} catch (e) {                                                                                                       // 89
				var _console4;                                                                                                     // 89
                                                                                                                       //
				(_console4 = console).error.apply(_console4, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 91
		}                                                                                                                    // 92
                                                                                                                       //
		return findOneByIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.insert = function () {                                                                           //
		function insert() /*record*/{                                                                                        //
			var _db2;                                                                                                           // 94
                                                                                                                       //
			return (_db2 = this._db).insert.apply(_db2, arguments);                                                             // 95
		}                                                                                                                    // 96
                                                                                                                       //
		return insert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.update = function () {                                                                           //
		function update() /*query, update, options*/{                                                                        //
			var _db3;                                                                                                           // 98
                                                                                                                       //
			return (_db3 = this._db).update.apply(_db3, arguments);                                                             // 99
		}                                                                                                                    // 100
                                                                                                                       //
		return update;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.upsert = function () {                                                                           //
		function upsert() /*query, update*/{                                                                                 //
			var _db4;                                                                                                           // 102
                                                                                                                       //
			return (_db4 = this._db).upsert.apply(_db4, arguments);                                                             // 103
		}                                                                                                                    // 104
                                                                                                                       //
		return upsert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.remove = function () {                                                                           //
		function remove() /*query*/{                                                                                         //
			var _db5;                                                                                                           // 106
                                                                                                                       //
			return (_db5 = this._db).remove.apply(_db5, arguments);                                                             // 107
		}                                                                                                                    // 108
                                                                                                                       //
		return remove;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.insertOrUpsert = function () {                                                                   //
		function insertOrUpsert() {                                                                                          //
			var _db6;                                                                                                           // 110
                                                                                                                       //
			return (_db6 = this._db).insertOrUpsert.apply(_db6, arguments);                                                     // 111
		}                                                                                                                    // 112
                                                                                                                       //
		return insertOrUpsert;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.allow = function () {                                                                            //
		function allow() {                                                                                                   //
			var _db7;                                                                                                           // 114
                                                                                                                       //
			return (_db7 = this._db).allow.apply(_db7, arguments);                                                              // 115
		}                                                                                                                    // 116
                                                                                                                       //
		return allow;                                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.deny = function () {                                                                             //
		function deny() {                                                                                                    //
			var _db8;                                                                                                           // 118
                                                                                                                       //
			return (_db8 = this._db).deny.apply(_db8, arguments);                                                               // 119
		}                                                                                                                    // 120
                                                                                                                       //
		return deny;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.ensureIndex = function () {                                                                      //
		function ensureIndex() {                                                                                             //
			var _db9;                                                                                                           // 122
                                                                                                                       //
			return (_db9 = this._db).ensureIndex.apply(_db9, arguments);                                                        // 123
		}                                                                                                                    // 124
                                                                                                                       //
		return ensureIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.dropIndex = function () {                                                                        //
		function dropIndex() {                                                                                               //
			var _db10;                                                                                                          // 126
                                                                                                                       //
			return (_db10 = this._db).dropIndex.apply(_db10, arguments);                                                        // 127
		}                                                                                                                    // 128
                                                                                                                       //
		return dropIndex;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.tryEnsureIndex = function () {                                                                   //
		function tryEnsureIndex() {                                                                                          //
			var _db11;                                                                                                          // 130
                                                                                                                       //
			return (_db11 = this._db).tryEnsureIndex.apply(_db11, arguments);                                                   // 131
		}                                                                                                                    // 132
                                                                                                                       //
		return tryEnsureIndex;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.tryDropIndex = function () {                                                                     //
		function tryDropIndex() {                                                                                            //
			var _db12;                                                                                                          // 134
                                                                                                                       //
			return (_db12 = this._db).tryDropIndex.apply(_db12, arguments);                                                     // 135
		}                                                                                                                    // 136
                                                                                                                       //
		return tryDropIndex;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.trashFind = function () {                                                                        //
		function trashFind() /*query, options*/{                                                                             //
			var _db13;                                                                                                          // 138
                                                                                                                       //
			return (_db13 = this._db).trashFind.apply(_db13, arguments);                                                        // 139
		}                                                                                                                    // 140
                                                                                                                       //
		return trashFind;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.trashFindDeletedAfter = function () {                                                            //
		function trashFindDeletedAfter() /*deletedAt, query, options*/{                                                      //
			var _db14;                                                                                                          // 142
                                                                                                                       //
			return (_db14 = this._db).trashFindDeletedAfter.apply(_db14, arguments);                                            // 143
		}                                                                                                                    // 144
                                                                                                                       //
		return trashFindDeletedAfter;                                                                                        //
	}(); // dinamicTrashFindAfter(method, deletedAt, ...args) {                                                           //
	// 	const scope = {                                                                                                   // 147
	// 		find: (query={}) => {                                                                                            // 148
	// 			return this.trashFindDeletedAfter(deletedAt, query, { fields: {_id: 1, _deletedAt: 1} });                       // 149
	// 		}                                                                                                                // 150
	// 	};                                                                                                                // 151
	// 	scope.model = {                                                                                                   // 153
	// 		find: scope.find                                                                                                 // 154
	// 	};                                                                                                                // 155
	// 	return this[method].apply(scope, args);                                                                           // 157
	// }                                                                                                                  // 158
	// dinamicFindAfter(method, updatedAt, ...args) {                                                                     // 160
	// 	const scope = {                                                                                                   // 161
	// 		find: (query={}, options) => {                                                                                   // 162
	// 			query._updatedAt = {                                                                                            // 163
	// 				$gt: updatedAt                                                                                                 // 164
	// 			};                                                                                                              // 165
	// 			return this.find(query, options);                                                                               // 167
	// 		}                                                                                                                // 168
	// 	};                                                                                                                // 169
	// 	scope.model = {                                                                                                   // 171
	// 		find: scope.find                                                                                                 // 172
	// 	};                                                                                                                // 173
	// 	return this[method].apply(scope, args);                                                                           // 175
	// }                                                                                                                  // 176
	// dinamicFindChangesAfter(method, updatedAt, ...args) {                                                              // 178
	// 	return {                                                                                                          // 179
	// 		update: this.dinamicFindAfter(method, updatedAt, ...args).fetch(),                                               // 180
	// 		remove: this.dinamicTrashFindAfter(method, updatedAt, ...args).fetch()                                           // 181
	// 	};                                                                                                                // 182
	// }                                                                                                                  // 183
                                                                                                                       //
                                                                                                                       //
	(0, _createClass3.default)(ModelsBase, [{                                                                             //
		key: "useCache",                                                                                                     //
		get: function () {                                                                                                   //
			if (RocketChat.models._CacheControl.get() === false) {                                                              // 31
				return false;                                                                                                      // 32
			}                                                                                                                   // 33
                                                                                                                       //
			return this._useCache;                                                                                              // 35
		}                                                                                                                    // 36
	}, {                                                                                                                  //
		key: "origin",                                                                                                       //
		get: function () {                                                                                                   //
			return this.useCache === true ? 'cache' : '_db';                                                                    // 39
		}                                                                                                                    // 40
	}]);                                                                                                                  //
	return ModelsBase;                                                                                                    //
}();                                                                                                                   //
                                                                                                                       //
RocketChat.models._Base = ModelsBase;                                                                                  // 187
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"Messages.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Messages.coffee.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
RocketChat.models.Messages = new (function (superClass) {                                                              //
  extend(_Class, superClass);                                                                                          //
                                                                                                                       //
  function _Class() {                                                                                                  //
    _Class.__super__.constructor.call(this, 'message');                                                                //
                                                                                                                       //
    this.tryEnsureIndex({                                                                                              //
      'rid': 1,                                                                                                        //
      'ts': 1                                                                                                          //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'ts': 1                                                                                                          //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'u._id': 1                                                                                                       //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'editedAt': 1                                                                                                    //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'editedBy._id': 1                                                                                                //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'rid': 1,                                                                                                        //
      't': 1,                                                                                                          //
      'u._id': 1                                                                                                       //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'expireAt': 1                                                                                                    //
    }, {                                                                                                               //
      expireAfterSeconds: 0                                                                                            //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'msg': 'text'                                                                                                    //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'file._id': 1                                                                                                    //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'mentions.username': 1                                                                                           //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'pinned': 1                                                                                                      //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'snippeted': 1                                                                                                   //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'location': '2dsphere'                                                                                           //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'slackBotId': 1,                                                                                                 //
      'slackTs': 1                                                                                                     //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
  }                                                                                                                    //
                                                                                                                       //
  _Class.prototype.findByMention = function (username, options) {                                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      "mentions.username": username                                                                                    //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByMentionAndRoomId = function (username, rid, options) {                                 //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      "mentions.username": username,                                                                                   //
      "rid": rid                                                                                                       //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomId = function (roomId, options) {                                                  //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdNotContainingTypes = function (roomId, types, options) {                         //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
                                                                                                                       //
    if (Match.test(types, [String]) && types.length > 0) {                                                             //
      query.t = {                                                                                                      //
        $nin: types                                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findInvisibleByRoomId = function (roomId, options) {                                                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: true,                                                                                                   //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdAfterTimestamp = function (roomId, timestamp, options) {                         //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId,                                                                                                     //
      ts: {                                                                                                            //
        $gt: timestamp                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdBeforeTimestamp = function (roomId, timestamp, options) {                        //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId,                                                                                                     //
      ts: {                                                                                                            //
        $lt: timestamp                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdBeforeTimestampInclusive = function (roomId, timestamp, options) {               //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId,                                                                                                     //
      ts: {                                                                                                            //
        $lte: timestamp                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdBetweenTimestamps = function (roomId, afterTimestamp, beforeTimestamp, options) {
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId,                                                                                                     //
      ts: {                                                                                                            //
        $gt: afterTimestamp,                                                                                           //
        $lt: beforeTimestamp                                                                                           //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdBetweenTimestampsInclusive = function (roomId, afterTimestamp, beforeTimestamp, options) {
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId,                                                                                                     //
      ts: {                                                                                                            //
        $gte: afterTimestamp,                                                                                          //
        $lte: beforeTimestamp                                                                                          //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdBeforeTimestampNotContainingTypes = function (roomId, timestamp, types, options) {
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId,                                                                                                     //
      ts: {                                                                                                            //
        $lt: timestamp                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
                                                                                                                       //
    if (Match.test(types, [String]) && types.length > 0) {                                                             //
      query.t = {                                                                                                      //
        $nin: types                                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleByRoomIdBetweenTimestampsNotContainingTypes = function (roomId, afterTimestamp, beforeTimestamp, types, options) {
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      rid: roomId,                                                                                                     //
      ts: {                                                                                                            //
        $gt: afterTimestamp,                                                                                           //
        $lt: beforeTimestamp                                                                                           //
      }                                                                                                                //
    };                                                                                                                 //
                                                                                                                       //
    if (Match.test(types, [String]) && types.length > 0) {                                                             //
      query.t = {                                                                                                      //
        $nin: types                                                                                                    //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findVisibleCreatedOrEditedAfterTimestamp = function (timestamp, options) {                          //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      $or: [{                                                                                                          //
        ts: {                                                                                                          //
          $gt: timestamp                                                                                               //
        }                                                                                                              //
      }, {                                                                                                             //
        'editedAt': {                                                                                                  //
          $gt: timestamp                                                                                               //
        }                                                                                                              //
      }]                                                                                                               //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findStarredByUserAtRoom = function (userId, roomId, options) {                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      'starred._id': userId,                                                                                           //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findPinnedByRoom = function (roomId, options) {                                                     //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: {                                                                                                             //
        $ne: 'rm'                                                                                                      //
      },                                                                                                               //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      pinned: true,                                                                                                    //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findSnippetedByRoom = function (roomId, options) {                                                  //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      snippeted: true,                                                                                                 //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.getLastTimestamp = function (options) {                                                             //
    var query, ref, ref1, ref2;                                                                                        //
                                                                                                                       //
    if (options == null) {                                                                                             //
      options = {};                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      ts: {                                                                                                            //
        $exists: 1                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    options.sort = {                                                                                                   //
      ts: -1                                                                                                           //
    };                                                                                                                 //
    options.limit = 1;                                                                                                 //
    return (ref = this.find(query, options)) != null ? typeof ref.fetch === "function" ? (ref1 = ref.fetch()) != null ? (ref2 = ref1[0]) != null ? ref2.ts : void 0 : void 0 : void 0 : void 0;
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findByRoomIdAndMessageIds = function (rid, messageIds, options) {                                   //
    var query;                                                                                                         //
    query = {                                                                                                          //
      rid: rid,                                                                                                        //
      _id: {                                                                                                           //
        $in: messageIds                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findOneBySlackBotIdAndSlackTs = function (slackBotId, slackTs) {                                    //
    var query;                                                                                                         //
    query = {                                                                                                          //
      slackBotId: slackBotId,                                                                                          //
      slackTs: slackTs                                                                                                 //
    };                                                                                                                 //
    return this.findOne(query);                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.findOneBySlackTs = function (slackTs) {                                                             //
    var query;                                                                                                         //
    query = {                                                                                                          //
      slackTs: slackTs                                                                                                 //
    };                                                                                                                 //
    return this.findOne(query);                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.cloneAndSaveAsHistoryById = function (_id) {                                                        //
    var me, record;                                                                                                    //
    me = RocketChat.models.Users.findOneById(Meteor.userId());                                                         //
    record = this.findOneById(_id);                                                                                    //
    record._hidden = true;                                                                                             //
    record.parent = record._id;                                                                                        //
    record.editedAt = new Date();                                                                                      //
    record.editedBy = {                                                                                                //
      _id: Meteor.userId(),                                                                                            //
      username: me.username                                                                                            //
    };                                                                                                                 //
    delete record._id;                                                                                                 //
    return this.insert(record);                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.setHiddenById = function (_id, hidden) {                                                            //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (hidden == null) {                                                                                              //
      hidden = true;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        _hidden: hidden                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.setAsDeletedByIdAndUser = function (_id, user) {                                                    //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        msg: '',                                                                                                       //
        t: 'rm',                                                                                                       //
        urls: [],                                                                                                      //
        mentions: [],                                                                                                  //
        attachments: [],                                                                                               //
        reactions: [],                                                                                                 //
        editedAt: new Date(),                                                                                          //
        editedBy: {                                                                                                    //
          _id: user._id,                                                                                               //
          username: user.username                                                                                      //
        }                                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.setPinnedByIdAndUserId = function (_id, pinnedBy, pinned, pinnedAt) {                               //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (pinned == null) {                                                                                              //
      pinned = true;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    if (pinnedAt == null) {                                                                                            //
      pinnedAt = 0;                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        pinned: pinned,                                                                                                //
        pinnedAt: pinnedAt || new Date(),                                                                              //
        pinnedBy: pinnedBy                                                                                             //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.setSnippetedByIdAndUserId = function (message, snippetName, snippetedBy, snippeted, snippetedAt) {  //
    var msg, query, update;                                                                                            //
                                                                                                                       //
    if (snippeted == null) {                                                                                           //
      snippeted = true;                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    if (snippetedAt == null) {                                                                                         //
      snippetedAt = 0;                                                                                                 //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      _id: message._id                                                                                                 //
    };                                                                                                                 //
    msg = "```" + message.msg + "```";                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        msg: msg,                                                                                                      //
        snippeted: snippeted,                                                                                          //
        snippetedAt: snippetedAt || new Date(),                                                                        //
        snippetedBy: snippetedBy,                                                                                      //
        snippetName: snippetName                                                                                       //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.setUrlsById = function (_id, urls) {                                                                //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        urls: urls                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.updateAllUsernamesByUserId = function (userId, username) {                                          //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "u.username": username                                                                                         //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.updateUsernameOfEditByUserId = function (userId, username) {                                        //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      'editedBy._id': userId                                                                                           //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "editedBy.username": username                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.updateUsernameAndMessageOfMentionByIdAndOldUsername = function (_id, oldUsername, newUsername, newMessage) {
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id,                                                                                                        //
      "mentions.username": oldUsername                                                                                 //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "mentions.$.username": newUsername,                                                                            //
        "msg": newMessage                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.updateUserStarById = function (_id, userId, starred) {                                              //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
                                                                                                                       //
    if (starred) {                                                                                                     //
      update = {                                                                                                       //
        $addToSet: {                                                                                                   //
          starred: {                                                                                                   //
            _id: userId                                                                                                //
          }                                                                                                            //
        }                                                                                                              //
      };                                                                                                               //
    } else {                                                                                                           //
      update = {                                                                                                       //
        $pull: {                                                                                                       //
          starred: {                                                                                                   //
            _id: Meteor.userId()                                                                                       //
          }                                                                                                            //
        }                                                                                                              //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.upgradeEtsToEditAt = function () {                                                                  //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      ets: {                                                                                                           //
        $exists: 1                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    update = {                                                                                                         //
      $rename: {                                                                                                       //
        "ets": "editedAt"                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.setMessageAttachments = function (_id, attachments) {                                               //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        attachments: attachments                                                                                       //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.setSlackBotIdAndSlackTs = function (_id, slackBotId, slackTs) {                                     //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        slackBotId: slackBotId,                                                                                        //
        slackTs: slackTs                                                                                               //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createWithTypeRoomIdMessageAndUser = function (type, roomId, message, user, extraData) {            //
    var record, room;                                                                                                  //
    room = RocketChat.models.Rooms.findOneById(roomId, {                                                               //
      fields: {                                                                                                        //
        sysMes: 1                                                                                                      //
      }                                                                                                                //
    });                                                                                                                //
                                                                                                                       //
    if ((room != null ? room.sysMes : void 0) === false) {                                                             //
      return;                                                                                                          //
    }                                                                                                                  //
                                                                                                                       //
    record = {                                                                                                         //
      t: type,                                                                                                         //
      rid: roomId,                                                                                                     //
      ts: new Date(),                                                                                                  //
      msg: message,                                                                                                    //
      u: {                                                                                                             //
        _id: user._id,                                                                                                 //
        username: user.username                                                                                        //
      },                                                                                                               //
      groupable: false                                                                                                 //
    };                                                                                                                 //
                                                                                                                       //
    _.extend(record, extraData);                                                                                       //
                                                                                                                       //
    record._id = this.insertOrUpsert(record);                                                                          //
    RocketChat.models.Rooms.incMsgCountById(room._id, 1);                                                              //
    return record;                                                                                                     //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createUserJoinWithRoomIdAndUser = function (roomId, user, extraData) {                              //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('uj', roomId, message, user, extraData);                            //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createUserLeaveWithRoomIdAndUser = function (roomId, user, extraData) {                             //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('ul', roomId, message, user, extraData);                            //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createUserRemovedWithRoomIdAndUser = function (roomId, user, extraData) {                           //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('ru', roomId, message, user, extraData);                            //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createUserAddedWithRoomIdAndUser = function (roomId, user, extraData) {                             //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('au', roomId, message, user, extraData);                            //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createCommandWithRoomIdAndUser = function (command, roomId, user, extraData) {                      //
    return this.createWithTypeRoomIdMessageAndUser('command', roomId, command, user, extraData);                       //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createUserMutedWithRoomIdAndUser = function (roomId, user, extraData) {                             //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('user-muted', roomId, message, user, extraData);                    //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createUserUnmutedWithRoomIdAndUser = function (roomId, user, extraData) {                           //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('user-unmuted', roomId, message, user, extraData);                  //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createNewModeratorWithRoomIdAndUser = function (roomId, user, extraData) {                          //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('new-moderator', roomId, message, user, extraData);                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createModeratorRemovedWithRoomIdAndUser = function (roomId, user, extraData) {                      //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('moderator-removed', roomId, message, user, extraData);             //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createNewOwnerWithRoomIdAndUser = function (roomId, user, extraData) {                              //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('new-owner', roomId, message, user, extraData);                     //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createOwnerRemovedWithRoomIdAndUser = function (roomId, user, extraData) {                          //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('owner-removed', roomId, message, user, extraData);                 //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createSubscriptionRoleAddedWithRoomIdAndUser = function (roomId, user, extraData) {                 //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('subscription-role-added', roomId, message, user, extraData);       //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.createSubscriptionRoleRemovedWithRoomIdAndUser = function (roomId, user, extraData) {               //
    var message;                                                                                                       //
    message = user.username;                                                                                           //
    return this.createWithTypeRoomIdMessageAndUser('subscription-role-removed', roomId, message, user, extraData);     //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.removeById = function (_id) {                                                                       //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.removeByRoomId = function (roomId) {                                                                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.removeByUserId = function (userId) {                                                                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.getMessageByFileId = function (fileID) {                                                            //
    return this.findOne({                                                                                              //
      'file._id': fileID                                                                                               //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  return _Class;                                                                                                       //
}(RocketChat.models._Base))();                                                                                         //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Reports.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Reports.coffee.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
RocketChat.models.Reports = new (function (superClass) {                                                               //
  extend(_Class, superClass);                                                                                          //
                                                                                                                       //
  function _Class() {                                                                                                  //
    _Class.__super__.constructor.call(this, 'reports');                                                                //
  }                                                                                                                    //
                                                                                                                       //
  _Class.prototype.createWithMessageDescriptionAndUserId = function (message, description, userId, extraData) {        //
    var record;                                                                                                        //
    record = {                                                                                                         //
      message: message,                                                                                                //
      description: description,                                                                                        //
      ts: new Date(),                                                                                                  //
      userId: userId                                                                                                   //
    };                                                                                                                 //
                                                                                                                       //
    _.extend(record, extraData);                                                                                       //
                                                                                                                       //
    record._id = this.insert(record);                                                                                  //
    return record;                                                                                                     //
  };                                                                                                                   //
                                                                                                                       //
  return _Class;                                                                                                       //
}(RocketChat.models._Base))();                                                                                         //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Rooms.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Rooms.coffee.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var ModelRooms,                                                                                                        //
    extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
ModelRooms = function (superClass) {                                                                                   //
  extend(ModelRooms, superClass);                                                                                      //
                                                                                                                       //
  function ModelRooms() {                                                                                              //
    ModelRooms.__super__.constructor.apply(this, arguments);                                                           //
                                                                                                                       //
    this.tryEnsureIndex({                                                                                              //
      'name': 1                                                                                                        //
    }, {                                                                                                               //
      unique: 1,                                                                                                       //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'default': 1                                                                                                     //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'usernames': 1                                                                                                   //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      't': 1                                                                                                           //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'u._id': 1                                                                                                       //
    });                                                                                                                //
    this.cache.ignoreUpdatedFields.push('msgs', 'lm');                                                                 //
    this.cache.ensureIndex(['t', 'name'], 'unique');                                                                   //
    this.cache.options = {                                                                                             //
      fields: {                                                                                                        //
        usernames: 0                                                                                                   //
      }                                                                                                                //
    };                                                                                                                 //
  }                                                                                                                    //
                                                                                                                       //
  ModelRooms.prototype.findOneByIdOrName = function (_idOrName, options) {                                             //
    var query;                                                                                                         //
    query = {                                                                                                          //
      $or: [{                                                                                                          //
        _id: _idOrName                                                                                                 //
      }, {                                                                                                             //
        name: _idOrName                                                                                                //
      }]                                                                                                               //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findOneByImportId = function (_id, options) {                                                   //
    var query;                                                                                                         //
    query = {                                                                                                          //
      importIds: _id                                                                                                   //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findOneByName = function (name, options) {                                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      name: name                                                                                                       //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findOneByNameAndType = function (name, type, options) {                                         //
    var query;                                                                                                         //
    query = {                                                                                                          //
      name: name,                                                                                                      //
      t: type                                                                                                          //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findOneByIdContainingUsername = function (_id, username, options) {                             //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: _id,                                                                                                        //
      usernames: username                                                                                              //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findOneByNameAndTypeNotContainingUsername = function (name, type, username, options) {          //
    var query;                                                                                                         //
    query = {                                                                                                          //
      name: name,                                                                                                      //
      t: type,                                                                                                         //
      usernames: {                                                                                                     //
        $ne: username                                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findById = function (roomId, options) {                                                         //
    return this.find({                                                                                                 //
      _id: roomId                                                                                                      //
    }, options);                                                                                                       //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByIds = function (roomIds, options) {                                                       //
    return this.find({                                                                                                 //
      _id: {                                                                                                           //
        $in: [].concat(roomIds)                                                                                        //
      }                                                                                                                //
    }, options);                                                                                                       //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByType = function (type, options) {                                                         //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type                                                                                                          //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByTypes = function (types, options) {                                                       //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: {                                                                                                             //
        $in: types                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByUserId = function (userId, options) {                                                     //
    var query;                                                                                                         //
    query = {                                                                                                          //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findBySubscriptionUserId = function (userId, options) {                                         //
    var data, query;                                                                                                   //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      data = RocketChat.models.Subscriptions.findByUserId(userId).fetch();                                             //
      data = data.map(function (item) {                                                                                //
        if (item._room) {                                                                                              //
          return item._room;                                                                                           //
        }                                                                                                              //
                                                                                                                       //
        console.log('Empty Room for Subscription', item);                                                              //
        return {};                                                                                                     //
      });                                                                                                              //
      return this.arrayToCursor(this.processQueryOptionsOnResult(data, options));                                      //
    }                                                                                                                  //
                                                                                                                       //
    data = RocketChat.models.Subscriptions.findByUserId(userId, {                                                      //
      fields: {                                                                                                        //
        rid: 1                                                                                                         //
      }                                                                                                                //
    }).fetch();                                                                                                        //
    data = data.map(function (item) {                                                                                  //
      return item.rid;                                                                                                 //
    });                                                                                                                //
    query = {                                                                                                          //
      _id: {                                                                                                           //
        $in: data                                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findBySubscriptionUserIdUpdatedAfter = function (userId, _updatedAt, options) {                 //
    var data, ids, query;                                                                                              //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      data = RocketChat.models.Subscriptions.findByUserId(userId).fetch();                                             //
      data = data.map(function (item) {                                                                                //
        if (item._room) {                                                                                              //
          return item._room;                                                                                           //
        }                                                                                                              //
                                                                                                                       //
        console.log('Empty Room for Subscription', item);                                                              //
        return {};                                                                                                     //
      });                                                                                                              //
      data = data.filter(function (item) {                                                                             //
        return item._updatedAt > _updatedAt;                                                                           //
      });                                                                                                              //
      return this.arrayToCursor(this.processQueryOptionsOnResult(data, options));                                      //
    }                                                                                                                  //
                                                                                                                       //
    ids = RocketChat.models.Subscriptions.findByUserId(userId, {                                                       //
      fields: {                                                                                                        //
        rid: 1                                                                                                         //
      }                                                                                                                //
    }).fetch();                                                                                                        //
    ids = ids.map(function (item) {                                                                                    //
      return item.rid;                                                                                                 //
    });                                                                                                                //
    query = {                                                                                                          //
      _id: {                                                                                                           //
        $in: ids                                                                                                       //
      },                                                                                                               //
      _updatedAt: {                                                                                                    //
        $gt: _updatedAt                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByNameContaining = function (name, options) {                                               //
    var nameRegex, query;                                                                                              //
    nameRegex = new RegExp(s.trim(s.escapeRegExp(name)), "i");                                                         //
    query = {                                                                                                          //
      $or: [{                                                                                                          //
        name: nameRegex                                                                                                //
      }, {                                                                                                             //
        t: 'd',                                                                                                        //
        usernames: nameRegex                                                                                           //
      }]                                                                                                               //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByNameContainingTypesWithUsername = function (name, types, options) {                       //
    var $or, i, len, nameRegex, obj, query, type;                                                                      //
    nameRegex = new RegExp(s.trim(s.escapeRegExp(name)), "i");                                                         //
    $or = [];                                                                                                          //
                                                                                                                       //
    for (i = 0, len = types.length; i < len; i++) {                                                                    //
      type = types[i];                                                                                                 //
      obj = {                                                                                                          //
        name: nameRegex,                                                                                               //
        t: type.type                                                                                                   //
      };                                                                                                               //
                                                                                                                       //
      if (type.username != null) {                                                                                     //
        obj.usernames = type.username;                                                                                 //
      }                                                                                                                //
                                                                                                                       //
      if (type.ids != null) {                                                                                          //
        obj._id = {                                                                                                    //
          $in: type.ids                                                                                                //
        };                                                                                                             //
      }                                                                                                                //
                                                                                                                       //
      $or.push(obj);                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      $or: $or                                                                                                         //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findContainingTypesWithUsername = function (types, options) {                                   //
    var $or, i, len, obj, query, type;                                                                                 //
    $or = [];                                                                                                          //
                                                                                                                       //
    for (i = 0, len = types.length; i < len; i++) {                                                                    //
      type = types[i];                                                                                                 //
      obj = {                                                                                                          //
        t: type.type                                                                                                   //
      };                                                                                                               //
                                                                                                                       //
      if (type.username != null) {                                                                                     //
        obj.usernames = type.username;                                                                                 //
      }                                                                                                                //
                                                                                                                       //
      if (type.ids != null) {                                                                                          //
        obj._id = {                                                                                                    //
          $in: type.ids                                                                                                //
        };                                                                                                             //
      }                                                                                                                //
                                                                                                                       //
      $or.push(obj);                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      $or: $or                                                                                                         //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByNameContainingAndTypes = function (name, types, options) {                                //
    var nameRegex, query;                                                                                              //
    nameRegex = new RegExp(s.trim(s.escapeRegExp(name)), "i");                                                         //
    query = {                                                                                                          //
      t: {                                                                                                             //
        $in: types                                                                                                     //
      },                                                                                                               //
      $or: [{                                                                                                          //
        name: nameRegex                                                                                                //
      }, {                                                                                                             //
        t: 'd',                                                                                                        //
        usernames: nameRegex                                                                                           //
      }]                                                                                                               //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByNameAndTypeNotContainingUsername = function (name, type, username, options) {             //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type,                                                                                                         //
      name: name,                                                                                                      //
      usernames: {                                                                                                     //
        $ne: username                                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByNameStartingAndTypes = function (name, types, options) {                                  //
    var nameRegex, query;                                                                                              //
    nameRegex = new RegExp("^" + s.trim(s.escapeRegExp(name)), "i");                                                   //
    query = {                                                                                                          //
      t: {                                                                                                             //
        $in: types                                                                                                     //
      },                                                                                                               //
      $or: [{                                                                                                          //
        name: nameRegex                                                                                                //
      }, {                                                                                                             //
        t: 'd',                                                                                                        //
        usernames: nameRegex                                                                                           //
      }]                                                                                                               //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByDefaultAndTypes = function (defaultValue, types, options) {                               //
    var query;                                                                                                         //
    query = {                                                                                                          //
      "default": defaultValue,                                                                                         //
      t: {                                                                                                             //
        $in: types                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByTypeContainingUsername = function (type, username, options) {                             //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type,                                                                                                         //
      usernames: username                                                                                              //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByTypeContainingUsernames = function (type, username, options) {                            //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type,                                                                                                         //
      usernames: {                                                                                                     //
        $all: [].concat(username)                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByTypesAndNotUserIdContainingUsername = function (types, userId, username, options) {       //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: {                                                                                                             //
        $in: types                                                                                                     //
      },                                                                                                               //
      uid: {                                                                                                           //
        $ne: userId                                                                                                    //
      },                                                                                                               //
      usernames: username                                                                                              //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByContainingUsername = function (username, options) {                                       //
    var query;                                                                                                         //
    query = {                                                                                                          //
      usernames: username                                                                                              //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByTypeAndName = function (type, name, options) {                                            //
    var query;                                                                                                         //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      return this.cache.findByIndex('t,name', [type, name], options);                                                  //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      name: name,                                                                                                      //
      t: type                                                                                                          //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByTypeAndNameContainingUsername = function (type, name, username, options) {                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      name: name,                                                                                                      //
      t: type,                                                                                                         //
      usernames: username                                                                                              //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.findByTypeAndArchivationState = function (type, archivationstate, options) {                    //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type                                                                                                          //
    };                                                                                                                 //
                                                                                                                       //
    if (archivationstate) {                                                                                            //
      query.archived = true;                                                                                           //
    } else {                                                                                                           //
      query.archived = {                                                                                               //
        $ne: true                                                                                                      //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.addImportIds = function (_id, importIds) {                                                      //
    var query, update;                                                                                                 //
    importIds = [].concat(importIds);                                                                                  //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $addToSet: {                                                                                                     //
        importIds: {                                                                                                   //
          $each: importIds                                                                                             //
        }                                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.archiveById = function (_id) {                                                                  //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        archived: true                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.unarchiveById = function (_id) {                                                                //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        archived: false                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.addUsernameById = function (_id, username, muted) {                                             //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $addToSet: {                                                                                                     //
        usernames: username                                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
                                                                                                                       //
    if (muted) {                                                                                                       //
      update.$addToSet.muted = username;                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.addUsernamesById = function (_id, usernames) {                                                  //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $addToSet: {                                                                                                     //
        usernames: {                                                                                                   //
          $each: usernames                                                                                             //
        }                                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.addUsernameByName = function (name, username) {                                                 //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      name: name                                                                                                       //
    };                                                                                                                 //
    update = {                                                                                                         //
      $addToSet: {                                                                                                     //
        usernames: username                                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.removeUsernameById = function (_id, username) {                                                 //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $pull: {                                                                                                         //
        usernames: username                                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.removeUsernamesById = function (_id, usernames) {                                               //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $pull: {                                                                                                         //
        usernames: {                                                                                                   //
          $in: usernames                                                                                               //
        }                                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.removeUsernameFromAll = function (username) {                                                   //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      usernames: username                                                                                              //
    };                                                                                                                 //
    update = {                                                                                                         //
      $pull: {                                                                                                         //
        usernames: username                                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.removeUsernameByName = function (name, username) {                                              //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      name: name                                                                                                       //
    };                                                                                                                 //
    update = {                                                                                                         //
      $pull: {                                                                                                         //
        usernames: username                                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.setNameById = function (_id, name) {                                                            //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        name: name                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.incMsgCountById = function (_id, inc) {                                                         //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (inc == null) {                                                                                                 //
      inc = 1;                                                                                                         //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $inc: {                                                                                                          //
        msgs: inc                                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.incMsgCountAndSetLastMessageTimestampById = function (_id, inc, lastMessageTimestamp) {         //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (inc == null) {                                                                                                 //
      inc = 1;                                                                                                         //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        lm: lastMessageTimestamp                                                                                       //
      },                                                                                                               //
      $inc: {                                                                                                          //
        msgs: inc                                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.replaceUsername = function (previousUsername, username) {                                       //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      usernames: previousUsername                                                                                      //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "usernames.$": username                                                                                        //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.replaceMutedUsername = function (previousUsername, username) {                                  //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      muted: previousUsername                                                                                          //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "muted.$": username                                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.replaceUsernameOfUserByUserId = function (userId, username) {                                   //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "u.username": username                                                                                         //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.setJoinCodeById = function (_id, joinCode) {                                                    //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
                                                                                                                       //
    if ((joinCode != null ? joinCode.trim() : void 0) !== '') {                                                        //
      update = {                                                                                                       //
        $set: {                                                                                                        //
          joinCodeRequired: true,                                                                                      //
          joinCode: joinCode                                                                                           //
        }                                                                                                              //
      };                                                                                                               //
    } else {                                                                                                           //
      update = {                                                                                                       //
        $set: {                                                                                                        //
          joinCodeRequired: false                                                                                      //
        },                                                                                                             //
        $unset: {                                                                                                      //
          joinCode: 1                                                                                                  //
        }                                                                                                              //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.setUserById = function (_id, user) {                                                            //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        u: {                                                                                                           //
          _id: user._id,                                                                                               //
          username: user.username                                                                                      //
        }                                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.setTypeById = function (_id, type) {                                                            //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        t: type                                                                                                        //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.setTopicById = function (_id, topic) {                                                          //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        topic: topic                                                                                                   //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.muteUsernameByRoomId = function (_id, username) {                                               //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $addToSet: {                                                                                                     //
        muted: username                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.unmuteUsernameByRoomId = function (_id, username) {                                             //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $pull: {                                                                                                         //
        muted: username                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.saveDefaultById = function (_id, defaultValue) {                                                //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "default": defaultValue === 'true'                                                                             //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.saveRoomById = function (_id, data) {                                                           //
    var setData, unsetData, update;                                                                                    //
    setData = {};                                                                                                      //
    unsetData = {};                                                                                                    //
                                                                                                                       //
    if (data.topic != null) {                                                                                          //
      if (!_.isEmpty(s.trim(data.topic))) {                                                                            //
        setData.topic = s.trim(data.topic);                                                                            //
      } else {                                                                                                         //
        unsetData.topic = 1;                                                                                           //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    if (data.tags != null) {                                                                                           //
      if (!_.isEmpty(s.trim(data.tags))) {                                                                             //
        setData.tags = s.trim(data.tags).split(',').map(function (_this) {                                             //
          return function (tag) {                                                                                      //
            return s.trim(tag);                                                                                        //
          };                                                                                                           //
        }(this));                                                                                                      //
      } else {                                                                                                         //
        unsetData.tags = 1;                                                                                            //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    update = {};                                                                                                       //
                                                                                                                       //
    if (!_.isEmpty(setData)) {                                                                                         //
      update.$set = setData;                                                                                           //
    }                                                                                                                  //
                                                                                                                       //
    if (!_.isEmpty(unsetData)) {                                                                                       //
      update.$unset = unsetData;                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    return this.update({                                                                                               //
      _id: _id                                                                                                         //
    }, update);                                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.createWithTypeNameUserAndUsernames = function (type, name, user, usernames, extraData) {        //
    var room;                                                                                                          //
    room = {                                                                                                           //
      name: name,                                                                                                      //
      t: type,                                                                                                         //
      usernames: usernames,                                                                                            //
      msgs: 0,                                                                                                         //
      u: {                                                                                                             //
        _id: user._id,                                                                                                 //
        username: user.username                                                                                        //
      }                                                                                                                //
    };                                                                                                                 //
                                                                                                                       //
    _.extend(room, extraData);                                                                                         //
                                                                                                                       //
    room._id = this.insert(room);                                                                                      //
    return room;                                                                                                       //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.createWithIdTypeAndName = function (_id, type, name, extraData) {                               //
    var room;                                                                                                          //
    room = {                                                                                                           //
      _id: _id,                                                                                                        //
      ts: new Date(),                                                                                                  //
      t: type,                                                                                                         //
      name: name,                                                                                                      //
      usernames: [],                                                                                                   //
      msgs: 0                                                                                                          //
    };                                                                                                                 //
                                                                                                                       //
    _.extend(room, extraData);                                                                                         //
                                                                                                                       //
    this.insert(room);                                                                                                 //
    return room;                                                                                                       //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.removeById = function (_id) {                                                                   //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  ModelRooms.prototype.removeByTypeContainingUsername = function (type, username) {                                    //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type,                                                                                                         //
      usernames: username                                                                                              //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  return ModelRooms;                                                                                                   //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Rooms = new ModelRooms('room', true);                                                                //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Settings.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Settings.coffee.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var ModelSettings,                                                                                                     //
    extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
ModelSettings = function (superClass) {                                                                                //
  extend(ModelSettings, superClass);                                                                                   //
                                                                                                                       //
  function ModelSettings() {                                                                                           //
    ModelSettings.__super__.constructor.apply(this, arguments);                                                        //
                                                                                                                       //
    this.tryEnsureIndex({                                                                                              //
      'blocked': 1                                                                                                     //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'hidden': 1                                                                                                      //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
  }                                                                                                                    //
                                                                                                                       //
  ModelSettings.prototype.findById = function (_id) {                                                                  //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    return this.find(query);                                                                                           //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findOneNotHiddenById = function (_id) {                                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: _id,                                                                                                        //
      hidden: {                                                                                                        //
        $ne: true                                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    return this.findOne(query);                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findByIds = function (_id) {                                                                 //
    var query;                                                                                                         //
                                                                                                                       //
    if (_id == null) {                                                                                                 //
      _id = [];                                                                                                        //
    }                                                                                                                  //
                                                                                                                       //
    _id = [].concat(_id);                                                                                              //
    query = {                                                                                                          //
      _id: {                                                                                                           //
        $in: _id                                                                                                       //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query);                                                                                           //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findByRole = function (role, options) {                                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      role: role                                                                                                       //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findPublic = function (options) {                                                            //
    var query;                                                                                                         //
    query = {                                                                                                          //
      "public": true                                                                                                   //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findNotHiddenPublic = function (ids) {                                                       //
    var filter;                                                                                                        //
                                                                                                                       //
    if (ids == null) {                                                                                                 //
      ids = [];                                                                                                        //
    }                                                                                                                  //
                                                                                                                       //
    filter = {                                                                                                         //
      hidden: {                                                                                                        //
        $ne: true                                                                                                      //
      },                                                                                                               //
      "public": true                                                                                                   //
    };                                                                                                                 //
                                                                                                                       //
    if (ids.length > 0) {                                                                                              //
      filter._id = {                                                                                                   //
        $in: ids                                                                                                       //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return this.find(filter, {                                                                                         //
      fields: {                                                                                                        //
        _id: 1,                                                                                                        //
        value: 1                                                                                                       //
      }                                                                                                                //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findNotHiddenPublicUpdatedAfter = function (updatedAt) {                                     //
    var filter;                                                                                                        //
    filter = {                                                                                                         //
      hidden: {                                                                                                        //
        $ne: true                                                                                                      //
      },                                                                                                               //
      "public": true,                                                                                                  //
      _updatedAt: {                                                                                                    //
        $gt: updatedAt                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(filter, {                                                                                         //
      fields: {                                                                                                        //
        _id: 1,                                                                                                        //
        value: 1                                                                                                       //
      }                                                                                                                //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findNotHiddenPrivate = function () {                                                         //
    return this.find({                                                                                                 //
      hidden: {                                                                                                        //
        $ne: true                                                                                                      //
      },                                                                                                               //
      "public": {                                                                                                      //
        $ne: true                                                                                                      //
      }                                                                                                                //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findNotHidden = function (options) {                                                         //
    return this.find({                                                                                                 //
      hidden: {                                                                                                        //
        $ne: true                                                                                                      //
      }                                                                                                                //
    }, options);                                                                                                       //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.findNotHiddenUpdatedAfter = function (updatedAt) {                                           //
    return this.find({                                                                                                 //
      hidden: {                                                                                                        //
        $ne: true                                                                                                      //
      },                                                                                                               //
      _updatedAt: {                                                                                                    //
        $gt: updatedAt                                                                                                 //
      }                                                                                                                //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.updateValueById = function (_id, value) {                                                    //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      blocked: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      value: {                                                                                                         //
        $ne: value                                                                                                     //
      },                                                                                                               //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        value: value                                                                                                   //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.updateValueAndEditorById = function (_id, value, editor) {                                   //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      blocked: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      value: {                                                                                                         //
        $ne: value                                                                                                     //
      },                                                                                                               //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        value: value,                                                                                                  //
        editor: editor                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.updateValueNotHiddenById = function (_id, value) {                                           //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id,                                                                                                        //
      hidden: {                                                                                                        //
        $ne: true                                                                                                      //
      },                                                                                                               //
      blocked: {                                                                                                       //
        $ne: true                                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        value: value                                                                                                   //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.updateOptionsById = function (_id, options) {                                                //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      blocked: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: options                                                                                                    //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.createWithIdAndValue = function (_id, value) {                                               //
    var record;                                                                                                        //
    record = {                                                                                                         //
      _id: _id,                                                                                                        //
      value: value,                                                                                                    //
      _createdAt: new Date()                                                                                           //
    };                                                                                                                 //
    return this.insert(record);                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  ModelSettings.prototype.removeById = function (_id) {                                                                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      blocked: {                                                                                                       //
        $ne: true                                                                                                      //
      },                                                                                                               //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  return ModelSettings;                                                                                                //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Settings = new ModelSettings('settings', true);                                                      //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Subscriptions.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Subscriptions.coffee.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var ModelSubscriptions,                                                                                                //
    extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
ModelSubscriptions = function (superClass) {                                                                           //
  extend(ModelSubscriptions, superClass);                                                                              //
                                                                                                                       //
  function ModelSubscriptions() {                                                                                      //
    ModelSubscriptions.__super__.constructor.apply(this, arguments);                                                   //
                                                                                                                       //
    this.tryEnsureIndex({                                                                                              //
      'rid': 1,                                                                                                        //
      'u._id': 1                                                                                                       //
    }, {                                                                                                               //
      unique: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'rid': 1,                                                                                                        //
      'alert': 1,                                                                                                      //
      'u._id': 1                                                                                                       //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'rid': 1,                                                                                                        //
      'roles': 1                                                                                                       //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'u._id': 1,                                                                                                      //
      'name': 1,                                                                                                       //
      't': 1                                                                                                           //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'u._id': 1,                                                                                                      //
      'name': 1,                                                                                                       //
      't': 1,                                                                                                          //
      'code': 1                                                                                                        //
    }, {                                                                                                               //
      unique: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'open': 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'alert': 1                                                                                                       //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'unread': 1                                                                                                      //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'ts': 1                                                                                                          //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'ls': 1                                                                                                          //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'audioNotification': 1                                                                                           //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'desktopNotifications': 1                                                                                        //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'mobilePushNotifications': 1                                                                                     //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'emailNotifications': 1                                                                                          //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.cache.ensureIndex('rid', 'array');                                                                            //
    this.cache.ensureIndex('u._id', 'array');                                                                          //
    this.cache.ensureIndex(['rid', 'u._id'], 'unique');                                                                //
    this.cache.ensureIndex(['name', 'u._id'], 'unique');                                                               //
  }                                                                                                                    //
                                                                                                                       //
  ModelSubscriptions.prototype.findOneByRoomIdAndUserId = function (roomId, userId) {                                  //
    var query;                                                                                                         //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      return this.cache.findByIndex('rid,u._id', [roomId, userId]).fetch();                                            //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    return this.findOne(query);                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findOneByRoomNameAndUserId = function (roomName, userId) {                              //
    var query;                                                                                                         //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      return this.cache.findByIndex('name,u._id', [roomName, userId]).fetch();                                         //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      name: roomName,                                                                                                  //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    return this.findOne(query);                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByUserId = function (userId, options) {                                             //
    var query;                                                                                                         //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      return this.cache.findByIndex('u._id', userId, options);                                                         //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByUserIdUpdatedAfter = function (userId, updatedAt, options) {                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      "u._id": userId,                                                                                                 //
      _updatedAt: {                                                                                                    //
        $gt: updatedAt                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByRoomIdAndRoles = function (roomId, roles, options) {                              //
    var query;                                                                                                         //
    roles = [].concat(roles);                                                                                          //
    query = {                                                                                                          //
      "rid": roomId,                                                                                                   //
      "roles": {                                                                                                       //
        $in: roles                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByType = function (types, options) {                                                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: {                                                                                                             //
        $in: types                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByTypeAndUserId = function (type, userId, options) {                                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type,                                                                                                         //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByTypeNameAndUserId = function (type, name, userId, options) {                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      t: type,                                                                                                         //
      name: name,                                                                                                      //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByRoomId = function (roomId, options) {                                             //
    var query;                                                                                                         //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      return this.cache.findByIndex('rid', roomId, options);                                                           //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByRoomIdAndNotUserId = function (roomId, userId, options) {                         //
    var query;                                                                                                         //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': {                                                                                                       //
        $ne: userId                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.getLastSeen = function (options) {                                                      //
    var query, ref, ref1, ref2;                                                                                        //
                                                                                                                       //
    if (options == null) {                                                                                             //
      options = {};                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      ls: {                                                                                                            //
        $exists: 1                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    options.sort = {                                                                                                   //
      ls: -1                                                                                                           //
    };                                                                                                                 //
    options.limit = 1;                                                                                                 //
    return (ref = this.find(query, options)) != null ? typeof ref.fetch === "function" ? (ref1 = ref.fetch()) != null ? (ref2 = ref1[0]) != null ? ref2.ls : void 0 : void 0 : void 0 : void 0;
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.findByRoomIdAndUserIds = function (roomId, userIds) {                                   //
    var query;                                                                                                         //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': {                                                                                                       //
        $in: userIds                                                                                                   //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query);                                                                                           //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.archiveByRoomId = function (roomId) {                                                   //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        alert: false,                                                                                                  //
        open: false,                                                                                                   //
        archived: true                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.unarchiveByRoomId = function (roomId) {                                                 //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        alert: false,                                                                                                  //
        open: true,                                                                                                    //
        archived: false                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.hideByRoomIdAndUserId = function (roomId, userId) {                                     //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        alert: false,                                                                                                  //
        open: false                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.openByRoomIdAndUserId = function (roomId, userId) {                                     //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        open: true                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setAsReadByRoomIdAndUserId = function (roomId, userId) {                                //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        open: true,                                                                                                    //
        alert: false,                                                                                                  //
        unread: 0,                                                                                                     //
        ls: new Date()                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setAsUnreadByRoomIdAndUserId = function (roomId, userId, firstMessageUnreadTimestamp) {
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        open: true,                                                                                                    //
        alert: true,                                                                                                   //
        ls: firstMessageUnreadTimestamp                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setFavoriteByRoomIdAndUserId = function (roomId, userId, favorite) {                    //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (favorite == null) {                                                                                            //
      favorite = true;                                                                                                 //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        f: favorite                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.updateNameAndAlertByRoomId = function (roomId, name) {                                  //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        name: name,                                                                                                    //
        alert: true                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.updateNameByRoomId = function (roomId, name) {                                          //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        name: name                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setUserUsernameByUserId = function (userId, username) {                                 //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "u.username": username                                                                                         //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setNameForDirectRoomsWithOldName = function (oldName, name) {                           //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      name: oldName,                                                                                                   //
      t: "d"                                                                                                           //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        name: name                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.incUnreadOfDirectForRoomIdExcludingUserId = function (roomId, userId, inc) {            //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (inc == null) {                                                                                                 //
      inc = 1;                                                                                                         //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      t: 'd',                                                                                                          //
      'u._id': {                                                                                                       //
        $ne: userId                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        alert: true,                                                                                                   //
        open: true                                                                                                     //
      },                                                                                                               //
      $inc: {                                                                                                          //
        unread: inc                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.incUnreadForRoomIdExcludingUserId = function (roomId, userId, inc) {                    //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (inc == null) {                                                                                                 //
      inc = 1;                                                                                                         //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': {                                                                                                       //
        $ne: userId                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        alert: true,                                                                                                   //
        open: true                                                                                                     //
      },                                                                                                               //
      $inc: {                                                                                                          //
        unread: inc                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.incUnreadForRoomIdAndUserIds = function (roomId, userIds, inc) {                        //
    var query, update;                                                                                                 //
                                                                                                                       //
    if (inc == null) {                                                                                                 //
      inc = 1;                                                                                                         //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': {                                                                                                       //
        $in: userIds                                                                                                   //
      }                                                                                                                //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        alert: true,                                                                                                   //
        open: true                                                                                                     //
      },                                                                                                               //
      $inc: {                                                                                                          //
        unread: inc                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setAlertForRoomIdExcludingUserId = function (roomId, userId) {                          //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      'u._id': {                                                                                                       //
        $ne: userId                                                                                                    //
      },                                                                                                               //
      $or: [{                                                                                                          //
        alert: {                                                                                                       //
          $ne: true                                                                                                    //
        }                                                                                                              //
      }, {                                                                                                             //
        open: {                                                                                                        //
          $ne: true                                                                                                    //
        }                                                                                                              //
      }]                                                                                                               //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        alert: true,                                                                                                   //
        open: true                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setBlockedByRoomId = function (rid, blocked, blocker) {                                 //
    var query, query2, update, update2;                                                                                //
    query = {                                                                                                          //
      rid: rid,                                                                                                        //
      'u._id': blocked                                                                                                 //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        blocked: true                                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    query2 = {                                                                                                         //
      rid: rid,                                                                                                        //
      'u._id': blocker                                                                                                 //
    };                                                                                                                 //
    update2 = {                                                                                                        //
      $set: {                                                                                                          //
        blocker: true                                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update) && this.update(query2, update2);                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.unsetBlockedByRoomId = function (rid, blocked, blocker) {                               //
    var query, query2, update, update2;                                                                                //
    query = {                                                                                                          //
      rid: rid,                                                                                                        //
      'u._id': blocked                                                                                                 //
    };                                                                                                                 //
    update = {                                                                                                         //
      $unset: {                                                                                                        //
        blocked: 1                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    query2 = {                                                                                                         //
      rid: rid,                                                                                                        //
      'u._id': blocker                                                                                                 //
    };                                                                                                                 //
    update2 = {                                                                                                        //
      $unset: {                                                                                                        //
        blocker: 1                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update) && this.update(query2, update2);                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.updateTypeByRoomId = function (roomId, type) {                                          //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        t: type                                                                                                        //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.addRoleById = function (_id, role) {                                                    //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $addToSet: {                                                                                                     //
        roles: role                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.removeRoleById = function (_id, role) {                                                 //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $pull: {                                                                                                         //
        roles: role                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.setArchivedByUsername = function (username, archived) {                                 //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      t: 'd',                                                                                                          //
      name: username                                                                                                   //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        archived: archived                                                                                             //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update, {                                                                                //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.createWithRoomAndUser = function (room, user, extraData) {                              //
    var subscription;                                                                                                  //
    subscription = {                                                                                                   //
      open: false,                                                                                                     //
      alert: false,                                                                                                    //
      unread: 0,                                                                                                       //
      ts: room.ts,                                                                                                     //
      rid: room._id,                                                                                                   //
      name: room.name,                                                                                                 //
      t: room.t,                                                                                                       //
      u: {                                                                                                             //
        _id: user._id,                                                                                                 //
        username: user.username                                                                                        //
      }                                                                                                                //
    };                                                                                                                 //
                                                                                                                       //
    _.extend(subscription, extraData);                                                                                 //
                                                                                                                       //
    return this.insert(subscription);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.removeByUserId = function (userId) {                                                    //
    var query;                                                                                                         //
    query = {                                                                                                          //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.removeByRoomId = function (roomId) {                                                    //
    var query;                                                                                                         //
    query = {                                                                                                          //
      rid: roomId                                                                                                      //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  ModelSubscriptions.prototype.removeByRoomIdAndUserId = function (roomId, userId) {                                   //
    var query;                                                                                                         //
    query = {                                                                                                          //
      rid: roomId,                                                                                                     //
      "u._id": userId                                                                                                  //
    };                                                                                                                 //
    return this.remove(query);                                                                                         //
  };                                                                                                                   //
                                                                                                                       //
  return ModelSubscriptions;                                                                                           //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Subscriptions = new ModelSubscriptions('subscription', true);                                        //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Uploads.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Uploads.coffee.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
RocketChat.models.Uploads = new (function (superClass) {                                                               //
  extend(_Class, superClass);                                                                                          //
                                                                                                                       //
  function _Class() {                                                                                                  //
    _Class.__super__.constructor.call(this, 'uploads');                                                                //
                                                                                                                       //
    this.tryEnsureIndex({                                                                                              //
      'rid': 1                                                                                                         //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'uploadedAt': 1                                                                                                  //
    });                                                                                                                //
  }                                                                                                                    //
                                                                                                                       //
  _Class.prototype.findNotHiddenFilesOfRoom = function (roomId, limit) {                                               //
    var fileOptions, fileQuery;                                                                                        //
    fileQuery = {                                                                                                      //
      rid: roomId,                                                                                                     //
      complete: true,                                                                                                  //
      uploading: false,                                                                                                //
      _hidden: {                                                                                                       //
        $ne: true                                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    fileOptions = {                                                                                                    //
      limit: limit,                                                                                                    //
      sort: {                                                                                                          //
        uploadedAt: -1                                                                                                 //
      },                                                                                                               //
      fields: {                                                                                                        //
        _id: 1,                                                                                                        //
        userId: 1,                                                                                                     //
        rid: 1,                                                                                                        //
        name: 1,                                                                                                       //
        description: 1,                                                                                                //
        type: 1,                                                                                                       //
        url: 1,                                                                                                        //
        uploadedAt: 1                                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(fileQuery, fileOptions);                                                                          //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.insertFileInit = function (roomId, userId, store, file, extra) {                                    //
    var fileData, ref;                                                                                                 //
    fileData = {                                                                                                       //
      rid: roomId,                                                                                                     //
      userId: userId,                                                                                                  //
      store: store,                                                                                                    //
      complete: false,                                                                                                 //
      uploading: true,                                                                                                 //
      progress: 0,                                                                                                     //
      extension: s.strRightBack(file.name, '.'),                                                                       //
      uploadedAt: new Date()                                                                                           //
    };                                                                                                                 //
                                                                                                                       //
    _.extend(fileData, file, extra);                                                                                   //
                                                                                                                       //
    if (((ref = this.model.direct) != null ? ref.insert : void 0) != null) {                                           //
      file = this.model.direct.insert(fileData);                                                                       //
    } else {                                                                                                           //
      file = this.insert(fileData);                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    return file;                                                                                                       //
  };                                                                                                                   //
                                                                                                                       //
  _Class.prototype.updateFileComplete = function (fileId, userId, file) {                                              //
    var filter, ref, result, update;                                                                                   //
                                                                                                                       //
    if (!fileId) {                                                                                                     //
      return;                                                                                                          //
    }                                                                                                                  //
                                                                                                                       //
    filter = {                                                                                                         //
      _id: fileId,                                                                                                     //
      userId: userId                                                                                                   //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        complete: true,                                                                                                //
        uploading: false,                                                                                              //
        progress: 1                                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    update.$set = _.extend(file, update.$set);                                                                         //
                                                                                                                       //
    if (((ref = this.model.direct) != null ? ref.insert : void 0) != null) {                                           //
      result = this.model.direct.update(filter, update);                                                               //
    } else {                                                                                                           //
      result = this.update(filter, update);                                                                            //
    }                                                                                                                  //
                                                                                                                       //
    return result;                                                                                                     //
  };                                                                                                                   //
                                                                                                                       //
  return _Class;                                                                                                       //
}(RocketChat.models._Base))();                                                                                         //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Users.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Users.coffee.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var ModelUsers,                                                                                                        //
    extend = function (child, parent) {                                                                                //
  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {                                                    //
    if (hasProp.call(parent, key)) child[key] = parent[key];                                                           //
  }                                                                                                                    //
                                                                                                                       //
  function ctor() {                                                                                                    //
    this.constructor = child;                                                                                          //
  }                                                                                                                    //
                                                                                                                       //
  ctor.prototype = parent.prototype;                                                                                   //
  child.prototype = new ctor();                                                                                        //
  child.__super__ = parent.prototype;                                                                                  //
  return child;                                                                                                        //
},                                                                                                                     //
    hasProp = {}.hasOwnProperty;                                                                                       //
                                                                                                                       //
ModelUsers = function (superClass) {                                                                                   //
  extend(ModelUsers, superClass);                                                                                      //
                                                                                                                       //
  function ModelUsers() {                                                                                              //
    ModelUsers.__super__.constructor.apply(this, arguments);                                                           //
                                                                                                                       //
    this.tryEnsureIndex({                                                                                              //
      'roles': 1                                                                                                       //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'name': 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'lastLogin': 1                                                                                                   //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'status': 1                                                                                                      //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'active': 1                                                                                                      //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'statusConnection': 1                                                                                            //
    }, {                                                                                                               //
      sparse: 1                                                                                                        //
    });                                                                                                                //
    this.tryEnsureIndex({                                                                                              //
      'type': 1                                                                                                        //
    });                                                                                                                //
  }                                                                                                                    //
                                                                                                                       //
  ModelUsers.prototype.findOneByImportId = function (_id, options) {                                                   //
    return this.findOne({                                                                                              //
      importIds: _id                                                                                                   //
    }, options);                                                                                                       //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findOneByUsername = function (username, options) {                                              //
    var query;                                                                                                         //
    query = {                                                                                                          //
      username: username                                                                                               //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findOneByEmailAddress = function (emailAddress, options) {                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      'emails.address': new RegExp("^" + s.escapeRegExp(emailAddress) + "$", 'i')                                      //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findOneAdmin = function (admin, options) {                                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      admin: admin                                                                                                     //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findOneByIdAndLoginToken = function (_id, token, options) {                                     //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: _id,                                                                                                        //
      'services.resume.loginTokens.hashedToken': Accounts._hashLoginToken(token)                                       //
    };                                                                                                                 //
    return this.findOne(query, options);                                                                               //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findById = function (userId) {                                                                  //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: userId                                                                                                      //
    };                                                                                                                 //
    return this.find(query);                                                                                           //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findUsersNotOffline = function (options) {                                                      //
    var query;                                                                                                         //
    query = {                                                                                                          //
      username: {                                                                                                      //
        $exists: 1                                                                                                     //
      },                                                                                                               //
      status: {                                                                                                        //
        $in: ['online', 'away', 'busy']                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findByUsername = function (username, options) {                                                 //
    var query;                                                                                                         //
    query = {                                                                                                          //
      username: username                                                                                               //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findUsersByUsernamesWithHighlights = function (usernames, options) {                            //
    var query, result;                                                                                                 //
                                                                                                                       //
    if (this.useCache) {                                                                                               //
      result = {                                                                                                       //
        fetch: function () {                                                                                           //
          return RocketChat.models.Users.getDynamicView('highlights').data().filter(function (record) {                //
            return usernames.indexOf(record.username) > -1;                                                            //
          });                                                                                                          //
        },                                                                                                             //
        count: function () {                                                                                           //
          return result.fetch().length;                                                                                //
        },                                                                                                             //
        forEach: function (fn) {                                                                                       //
          return result.fetch().forEach(fn);                                                                           //
        }                                                                                                              //
      };                                                                                                               //
      return result;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      username: {                                                                                                      //
        $in: usernames                                                                                                 //
      },                                                                                                               //
      'settings.preferences.highlights.0': {                                                                           //
        $exists: true                                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findActiveByUsernameOrNameRegexWithExceptions = function (searchTerm, exceptions, options) {    //
    var query, termRegex;                                                                                              //
                                                                                                                       //
    if (exceptions == null) {                                                                                          //
      exceptions = [];                                                                                                 //
    }                                                                                                                  //
                                                                                                                       //
    if (options == null) {                                                                                             //
      options = {};                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    if (!_.isArray(exceptions)) {                                                                                      //
      exceptions = [exceptions];                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    termRegex = new RegExp(s.escapeRegExp(searchTerm), 'i');                                                           //
    query = {                                                                                                          //
      $or: [{                                                                                                          //
        username: termRegex                                                                                            //
      }, {                                                                                                             //
        name: termRegex                                                                                                //
      }],                                                                                                              //
      active: true,                                                                                                    //
      type: {                                                                                                          //
        $in: ['user', 'bot']                                                                                           //
      },                                                                                                               //
      $and: [{                                                                                                         //
        username: {                                                                                                    //
          $exists: true                                                                                                //
        }                                                                                                              //
      }, {                                                                                                             //
        username: {                                                                                                    //
          $nin: exceptions                                                                                             //
        }                                                                                                              //
      }]                                                                                                               //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findByActiveUsersUsernameExcept = function (searchTerm, exceptions, options) {                  //
    var query, termRegex;                                                                                              //
                                                                                                                       //
    if (exceptions == null) {                                                                                          //
      exceptions = [];                                                                                                 //
    }                                                                                                                  //
                                                                                                                       //
    if (options == null) {                                                                                             //
      options = {};                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    if (!_.isArray(exceptions)) {                                                                                      //
      exceptions = [exceptions];                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    termRegex = new RegExp(s.escapeRegExp(searchTerm), 'i');                                                           //
    query = {                                                                                                          //
      $and: [{                                                                                                         //
        active: true,                                                                                                  //
        username: termRegex                                                                                            //
      }, {                                                                                                             //
        username: {                                                                                                    //
          $nin: exceptions                                                                                             //
        }                                                                                                              //
      }]                                                                                                               //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findUsersByNameOrUsername = function (nameOrUsername, options) {                                //
    var query;                                                                                                         //
    query = {                                                                                                          //
      username: {                                                                                                      //
        $exists: 1                                                                                                     //
      },                                                                                                               //
      $or: [{                                                                                                          //
        name: nameOrUsername                                                                                           //
      }, {                                                                                                             //
        username: nameOrUsername                                                                                       //
      }],                                                                                                              //
      type: {                                                                                                          //
        $in: ['user']                                                                                                  //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findByUsernameNameOrEmailAddress = function (usernameNameOrEmailAddress, options) {             //
    var query;                                                                                                         //
    query = {                                                                                                          //
      $or: [{                                                                                                          //
        name: usernameNameOrEmailAddress                                                                               //
      }, {                                                                                                             //
        username: usernameNameOrEmailAddress                                                                           //
      }, {                                                                                                             //
        'emails.address': usernameNameOrEmailAddress                                                                   //
      }],                                                                                                              //
      type: {                                                                                                          //
        $in: ['user', 'bot']                                                                                           //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findLDAPUsers = function (options) {                                                            //
    var query;                                                                                                         //
    query = {                                                                                                          //
      ldap: true                                                                                                       //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findCrowdUsers = function (options) {                                                           //
    var query;                                                                                                         //
    query = {                                                                                                          //
      crowd: true                                                                                                      //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.getLastLogin = function (options) {                                                             //
    var query, ref, ref1, ref2;                                                                                        //
                                                                                                                       //
    if (options == null) {                                                                                             //
      options = {};                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    query = {                                                                                                          //
      lastLogin: {                                                                                                     //
        $exists: 1                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    options.sort = {                                                                                                   //
      lastLogin: -1                                                                                                    //
    };                                                                                                                 //
    options.limit = 1;                                                                                                 //
    return (ref = this.find(query, options)) != null ? typeof ref.fetch === "function" ? (ref1 = ref.fetch()) != null ? (ref2 = ref1[0]) != null ? ref2.lastLogin : void 0 : void 0 : void 0 : void 0;
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.findUsersByUsernames = function (usernames, options) {                                          //
    var query;                                                                                                         //
    query = {                                                                                                          //
      username: {                                                                                                      //
        $in: usernames                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.find(query, options);                                                                                  //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.addImportIds = function (_id, importIds) {                                                      //
    var query, update;                                                                                                 //
    importIds = [].concat(importIds);                                                                                  //
    query = {                                                                                                          //
      _id: _id                                                                                                         //
    };                                                                                                                 //
    update = {                                                                                                         //
      $addToSet: {                                                                                                     //
        importIds: {                                                                                                   //
          $each: importIds                                                                                             //
        }                                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.updateLastLoginById = function (_id) {                                                          //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        lastLogin: new Date()                                                                                          //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setServiceId = function (_id, serviceName, serviceId) {                                         //
    var serviceIdKey, update;                                                                                          //
    update = {                                                                                                         //
      $set: {}                                                                                                         //
    };                                                                                                                 //
    serviceIdKey = "services." + serviceName + ".id";                                                                  //
    update.$set[serviceIdKey] = serviceId;                                                                             //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setUsername = function (_id, username) {                                                        //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        username: username                                                                                             //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setEmail = function (_id, email) {                                                              //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        emails: [{                                                                                                     //
          address: email,                                                                                              //
          verified: false                                                                                              //
        }]                                                                                                             //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setEmailVerified = function (_id, email) {                                                      //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id,                                                                                                        //
      emails: {                                                                                                        //
        $elemMatch: {                                                                                                  //
          address: email,                                                                                              //
          verified: false                                                                                              //
        }                                                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        'emails.$.verified': true                                                                                      //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setName = function (_id, name) {                                                                //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        name: name                                                                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setCustomFields = function (_id, fields) {                                                      //
    var key, update, value, values;                                                                                    //
    values = {};                                                                                                       //
                                                                                                                       //
    for (key in meteorBabelHelpers.sanitizeForInObject(fields)) {                                                      //
      value = fields[key];                                                                                             //
      values["customFields." + key] = value;                                                                           //
    }                                                                                                                  //
                                                                                                                       //
    update = {                                                                                                         //
      $set: values                                                                                                     //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setAvatarOrigin = function (_id, origin) {                                                      //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        avatarOrigin: origin                                                                                           //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.unsetAvatarOrigin = function (_id) {                                                            //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $unset: {                                                                                                        //
        avatarOrigin: 1                                                                                                //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setUserActive = function (_id, active) {                                                        //
    var update;                                                                                                        //
                                                                                                                       //
    if (active == null) {                                                                                              //
      active = true;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        active: active                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setAllUsersActive = function (active) {                                                         //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        active: active                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update({}, update, {                                                                                   //
      multi: true                                                                                                      //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.unsetLoginTokens = function (_id) {                                                             //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "services.resume.loginTokens": []                                                                              //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.unsetRequirePasswordChange = function (_id) {                                                   //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $unset: {                                                                                                        //
        "requirePasswordChange": true,                                                                                 //
        "requirePasswordChangeReason": true                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.resetPasswordAndSetRequirePasswordChange = function (_id, requirePasswordChange, requirePasswordChangeReason) {
    var update;                                                                                                        //
    update = {                                                                                                         //
      $unset: {                                                                                                        //
        "services.password": 1                                                                                         //
      },                                                                                                               //
      $set: {                                                                                                          //
        "requirePasswordChange": requirePasswordChange,                                                                //
        "requirePasswordChangeReason": requirePasswordChangeReason                                                     //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setLanguage = function (_id, language) {                                                        //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        language: language                                                                                             //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setProfile = function (_id, profile) {                                                          //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "settings.profile": profile                                                                                    //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setPreferences = function (_id, preferences) {                                                  //
    var update;                                                                                                        //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        "settings.preferences": preferences                                                                            //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(_id, update);                                                                                   //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.setUtcOffset = function (_id, utcOffset) {                                                      //
    var query, update;                                                                                                 //
    query = {                                                                                                          //
      _id: _id,                                                                                                        //
      utcOffset: {                                                                                                     //
        $ne: utcOffset                                                                                                 //
      }                                                                                                                //
    };                                                                                                                 //
    update = {                                                                                                         //
      $set: {                                                                                                          //
        utcOffset: utcOffset                                                                                           //
      }                                                                                                                //
    };                                                                                                                 //
    return this.update(query, update);                                                                                 //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.saveUserById = function (_id, data) {                                                           //
    var setData, unsetData, update;                                                                                    //
    setData = {};                                                                                                      //
    unsetData = {};                                                                                                    //
                                                                                                                       //
    if (data.name != null) {                                                                                           //
      if (!_.isEmpty(s.trim(data.name))) {                                                                             //
        setData.name = s.trim(data.name);                                                                              //
      } else {                                                                                                         //
        unsetData.name = 1;                                                                                            //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    if (data.email != null) {                                                                                          //
      if (!_.isEmpty(s.trim(data.email))) {                                                                            //
        setData.emails = [{                                                                                            //
          address: s.trim(data.email)                                                                                  //
        }];                                                                                                            //
      } else {                                                                                                         //
        unsetData.emails = 1;                                                                                          //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    if (data.phone != null) {                                                                                          //
      if (!_.isEmpty(s.trim(data.phone))) {                                                                            //
        setData.phone = [{                                                                                             //
          phoneNumber: s.trim(data.phone)                                                                              //
        }];                                                                                                            //
      } else {                                                                                                         //
        unsetData.phone = 1;                                                                                           //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    update = {};                                                                                                       //
                                                                                                                       //
    if (!_.isEmpty(setData)) {                                                                                         //
      update.$set = setData;                                                                                           //
    }                                                                                                                  //
                                                                                                                       //
    if (!_.isEmpty(unsetData)) {                                                                                       //
      update.$unset = unsetData;                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    if (_.isEmpty(update)) {                                                                                           //
      return true;                                                                                                     //
    }                                                                                                                  //
                                                                                                                       //
    return this.update({                                                                                               //
      _id: _id                                                                                                         //
    }, update);                                                                                                        //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.create = function (data) {                                                                      //
    var user;                                                                                                          //
    user = {                                                                                                           //
      createdAt: new Date(),                                                                                           //
      avatarOrigin: 'none'                                                                                             //
    };                                                                                                                 //
                                                                                                                       //
    _.extend(user, data);                                                                                              //
                                                                                                                       //
    return this.insert(user);                                                                                          //
  };                                                                                                                   //
                                                                                                                       //
  ModelUsers.prototype.removeById = function (_id) {                                                                   //
    return this.remove(_id);                                                                                           //
  }; /*                                                                                                                //
     	Find users to send a message by email if:                                                                        //
     	- he is not online                                                                                               //
     	- has a verified email                                                                                           //
     	- has not disabled email notifications                                                                           //
     	- `active` is equal to true (false means they were deactivated and can't login)                                  //
      */                                                                                                               //
                                                                                                                       //
  ModelUsers.prototype.getUsersToSendOfflineEmail = function (usersIds) {                                              //
    var query;                                                                                                         //
    query = {                                                                                                          //
      _id: {                                                                                                           //
        $in: usersIds                                                                                                  //
      },                                                                                                               //
      active: true,                                                                                                    //
      status: 'offline',                                                                                               //
      statusConnection: {                                                                                              //
        $ne: 'online'                                                                                                  //
      },                                                                                                               //
      'emails.verified': true                                                                                          //
    };                                                                                                                 //
    return this.find(query, {                                                                                          //
      fields: {                                                                                                        //
        name: 1,                                                                                                       //
        username: 1,                                                                                                   //
        emails: 1,                                                                                                     //
        'settings.preferences.emailNotificationMode': 1                                                                //
      }                                                                                                                //
    });                                                                                                                //
  };                                                                                                                   //
                                                                                                                       //
  return ModelUsers;                                                                                                   //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Users = new ModelUsers(Meteor.users, true);                                                          //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"_BaseCache.js":["babel-runtime/helpers/toConsumableArray","babel-runtime/helpers/possibleConstructorReturn","babel-runtime/helpers/inherits","babel-runtime/helpers/classCallCheck","lokijs","events","object-path",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/_BaseCache.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _toConsumableArray2 = require("babel-runtime/helpers/toConsumableArray");                                          //
                                                                                                                       //
var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);                                                 //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var loki = void 0;                                                                                                     // 1
module.import('lokijs', {                                                                                              // 1
	"default": function (v) {                                                                                             // 1
		loki = v;                                                                                                            // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
var EventEmitter = void 0;                                                                                             // 1
module.import('events', {                                                                                              // 1
	"EventEmitter": function (v) {                                                                                        // 1
		EventEmitter = v;                                                                                                    // 1
	}                                                                                                                     // 1
}, 1);                                                                                                                 // 1
var objectPath = void 0;                                                                                               // 1
module.import('object-path', {                                                                                         // 1
	"default": function (v) {                                                                                             // 1
		objectPath = v;                                                                                                      // 1
	}                                                                                                                     // 1
}, 2);                                                                                                                 // 1
var logger = new Logger('BaseCache');                                                                                  // 7
var lokiEq = loki.LokiOps.$eq;                                                                                         // 9
var lokiNe = loki.LokiOps.$ne;                                                                                         // 10
                                                                                                                       //
loki.LokiOps.$eq = function (a, b) {                                                                                   // 12
	if (Array.isArray(a)) {                                                                                               // 13
		return a.indexOf(b) !== -1;                                                                                          // 14
	}                                                                                                                     // 15
                                                                                                                       //
	return lokiEq(a, b);                                                                                                  // 16
};                                                                                                                     // 17
                                                                                                                       //
loki.LokiOps.$ne = function (a, b) {                                                                                   // 19
	if (Array.isArray(a)) {                                                                                               // 20
		return a.indexOf(b) === -1;                                                                                          // 21
	}                                                                                                                     // 22
                                                                                                                       //
	return lokiNe(a, b);                                                                                                  // 23
};                                                                                                                     // 24
                                                                                                                       //
var lokiIn = loki.LokiOps.$in;                                                                                         // 26
                                                                                                                       //
loki.LokiOps.$in = function (a, b) {                                                                                   // 27
	if (Array.isArray(a)) {                                                                                               // 28
		return a.some(function (subA) {                                                                                      // 29
			return lokiIn(subA, b);                                                                                             // 29
		});                                                                                                                  // 29
	}                                                                                                                     // 30
                                                                                                                       //
	return lokiIn(a, b);                                                                                                  // 31
};                                                                                                                     // 32
                                                                                                                       //
loki.LokiOps.$nin = function (a, b) {                                                                                  // 34
	return !loki.LokiOps.$in(a, b);                                                                                       // 35
};                                                                                                                     // 36
                                                                                                                       //
loki.LokiOps.$all = function (a, b) {                                                                                  // 38
	return b.every(function (subB) {                                                                                      // 39
		return a.includes(subB);                                                                                             // 39
	});                                                                                                                   // 39
};                                                                                                                     // 40
                                                                                                                       //
loki.LokiOps.$exists = function (a, b) {                                                                               // 42
	if (b) {                                                                                                              // 43
		return loki.LokiOps.$ne(a, undefined);                                                                               // 44
	}                                                                                                                     // 45
                                                                                                                       //
	return loki.LokiOps.$eq(a, undefined);                                                                                // 47
};                                                                                                                     // 48
                                                                                                                       //
loki.LokiOps.$elemMatch = function (a, b) {                                                                            // 50
	return _.findWhere(a, b);                                                                                             // 51
};                                                                                                                     // 52
                                                                                                                       //
var ignore = ['emit', 'load', 'on', 'addToAllIndexes'];                                                                // 54
                                                                                                                       //
function traceMethodCalls(target) {                                                                                    // 61
	target._stats = {};                                                                                                   // 62
                                                                                                                       //
	var _loop = function (property) {                                                                                     // 61
		if (typeof target[property] === 'function' && ignore.indexOf(property) === -1) {                                     // 65
			(function () {                                                                                                      // 65
				target._stats[property] = {                                                                                        // 66
					calls: 0,                                                                                                         // 67
					time: 0,                                                                                                          // 68
					avg: 0                                                                                                            // 69
				};                                                                                                                 // 66
				var origMethod = target[property];                                                                                 // 71
                                                                                                                       //
				target[property] = function () {                                                                                   // 72
					for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {                            // 72
						args[_key] = arguments[_key];                                                                                    // 72
					}                                                                                                                 // 72
                                                                                                                       //
					if (target.loaded !== true) {                                                                                     // 74
						return origMethod.apply(target, args);                                                                           // 75
					}                                                                                                                 // 76
                                                                                                                       //
					var startTime = RocketChat.statsTracker.now();                                                                    // 78
					var result = origMethod.apply(target, args);                                                                      // 79
					var time = Math.round(RocketChat.statsTracker.now() - startTime) / 1000;                                          // 80
					target._stats[property].time += time;                                                                             // 81
					target._stats[property].calls++;                                                                                  // 82
					target._stats[property].avg = target._stats[property].time / target._stats[property].calls;                       // 83
					return result;                                                                                                    // 85
				};                                                                                                                 // 86
			})();                                                                                                               // 65
		}                                                                                                                    // 87
	};                                                                                                                    // 61
                                                                                                                       //
	for (var property in meteorBabelHelpers.sanitizeForInObject(target)) {                                                // 64
		_loop(property);                                                                                                     // 64
	}                                                                                                                     // 88
                                                                                                                       //
	setInterval(function () {                                                                                             // 90
		for (var property in meteorBabelHelpers.sanitizeForInObject(target._stats)) {                                        // 91
			if (target._stats.hasOwnProperty(property) && target._stats[property].time > 0) {                                   // 92
				var tags = ["property:" + property, "collection:" + target.collectionName];                                        // 93
				RocketChat.statsTracker.timing('cache.methods.time', target._stats[property].avg, tags);                           // 94
				RocketChat.statsTracker.increment('cache.methods.totalTime', target._stats[property].time, tags);                  // 95
				RocketChat.statsTracker.increment('cache.methods.count', target._stats[property].calls, tags);                     // 96
				target._stats[property].avg = 0;                                                                                   // 97
				target._stats[property].time = 0;                                                                                  // 98
				target._stats[property].calls = 0;                                                                                 // 99
			}                                                                                                                   // 100
		}                                                                                                                    // 101
	}, 10000);                                                                                                            // 102
                                                                                                                       //
	target._getStatsAvg = function () {                                                                                   // 104
		var stats = [];                                                                                                      // 105
                                                                                                                       //
		for (var property in meteorBabelHelpers.sanitizeForInObject(target._stats)) {                                        // 106
			if (target._stats.hasOwnProperty(property)) {                                                                       // 107
				stats.push([Math.round(target._stats[property].avg * 100) / 100, property]);                                       // 108
			}                                                                                                                   // 109
		}                                                                                                                    // 110
                                                                                                                       //
		return _.sortBy(stats, function (record) {                                                                           // 111
			return record[0];                                                                                                   // 112
		});                                                                                                                  // 113
	};                                                                                                                    // 114
}                                                                                                                      // 115
                                                                                                                       //
var Adapter = function () {                                                                                            //
	function Adapter() {                                                                                                  //
		(0, _classCallCheck3.default)(this, Adapter);                                                                        //
	}                                                                                                                     //
                                                                                                                       //
	Adapter.prototype.loadDatabase = function () {                                                                        //
		function loadDatabase() /*dbname, callback*/{}                                                                       //
                                                                                                                       //
		return loadDatabase;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	Adapter.prototype.saveDatabase = function () {                                                                        //
		function saveDatabase() /*dbname, dbstring, callback*/{}                                                             //
                                                                                                                       //
		return saveDatabase;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	Adapter.prototype.deleteDatabase = function () {                                                                      //
		function deleteDatabase() /*dbname, callback*/{}                                                                     //
                                                                                                                       //
		return deleteDatabase;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	return Adapter;                                                                                                       //
}();                                                                                                                   //
                                                                                                                       //
var db = new loki('rocket.chat.json', {                                                                                // 123
	adapter: Adapter                                                                                                      // 123
});                                                                                                                    // 123
                                                                                                                       //
var ModelsBaseCache = function (_EventEmitter) {                                                                       //
	(0, _inherits3.default)(ModelsBaseCache, _EventEmitter);                                                              //
                                                                                                                       //
	function ModelsBaseCache(model) {                                                                                     // 126
		(0, _classCallCheck3.default)(this, ModelsBaseCache);                                                                // 126
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _EventEmitter.call(this));                                // 126
                                                                                                                       //
		traceMethodCalls(_this);                                                                                             // 129
		_this.indexes = {};                                                                                                  // 131
		_this.ignoreUpdatedFields = ['_updatedAt'];                                                                          // 132
		_this.query = {};                                                                                                    // 134
		_this.options = {};                                                                                                  // 135
                                                                                                                       //
		_this.ensureIndex('_id', 'unique');                                                                                  // 137
                                                                                                                       //
		_this.joins = {};                                                                                                    // 139
                                                                                                                       //
		_this.on('inserted', function () {                                                                                   // 141
			for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {                        // 141
				args[_key2] = arguments[_key2];                                                                                    // 141
			}                                                                                                                   // 141
                                                                                                                       //
			_this.emit.apply(_this, ['changed', 'inserted'].concat(args));                                                      // 141
		});                                                                                                                  // 141
                                                                                                                       //
		_this.on('removed', function () {                                                                                    // 142
			for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {                        // 142
				args[_key3] = arguments[_key3];                                                                                    // 142
			}                                                                                                                   // 142
                                                                                                                       //
			_this.emit.apply(_this, ['changed', 'removed'].concat(args));                                                       // 142
		});                                                                                                                  // 142
                                                                                                                       //
		_this.on('updated', function () {                                                                                    // 143
			for (var _len4 = arguments.length, args = Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {                        // 143
				args[_key4] = arguments[_key4];                                                                                    // 143
			}                                                                                                                   // 143
                                                                                                                       //
			_this.emit.apply(_this, ['changed', 'updated'].concat(args));                                                       // 143
		});                                                                                                                  // 143
                                                                                                                       //
		_this.on('beforeinsert', function () {                                                                               // 145
			for (var _len5 = arguments.length, args = Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {                        // 145
				args[_key5] = arguments[_key5];                                                                                    // 145
			}                                                                                                                   // 145
                                                                                                                       //
			_this.emit.apply(_this, ['beforechange', 'inserted'].concat(args));                                                 // 145
		});                                                                                                                  // 145
                                                                                                                       //
		_this.on('beforeremove', function () {                                                                               // 146
			for (var _len6 = arguments.length, args = Array(_len6), _key6 = 0; _key6 < _len6; _key6++) {                        // 146
				args[_key6] = arguments[_key6];                                                                                    // 146
			}                                                                                                                   // 146
                                                                                                                       //
			_this.emit.apply(_this, ['beforechange', 'removed'].concat(args));                                                  // 146
		});                                                                                                                  // 146
                                                                                                                       //
		_this.on('beforeupdate', function () {                                                                               // 147
			for (var _len7 = arguments.length, args = Array(_len7), _key7 = 0; _key7 < _len7; _key7++) {                        // 147
				args[_key7] = arguments[_key7];                                                                                    // 147
			}                                                                                                                   // 147
                                                                                                                       //
			_this.emit.apply(_this, ['beforechange', 'updated'].concat(args));                                                  // 147
		});                                                                                                                  // 147
                                                                                                                       //
		_this.on('inserted', function () {                                                                                   // 149
			for (var _len8 = arguments.length, args = Array(_len8), _key8 = 0; _key8 < _len8; _key8++) {                        // 149
				args[_key8] = arguments[_key8];                                                                                    // 149
			}                                                                                                                   // 149
                                                                                                                       //
			_this.emit.apply(_this, ['sync', 'inserted'].concat(args));                                                         // 149
		});                                                                                                                  // 149
                                                                                                                       //
		_this.on('updated', function () {                                                                                    // 150
			for (var _len9 = arguments.length, args = Array(_len9), _key9 = 0; _key9 < _len9; _key9++) {                        // 150
				args[_key9] = arguments[_key9];                                                                                    // 150
			}                                                                                                                   // 150
                                                                                                                       //
			_this.emit.apply(_this, ['sync', 'updated'].concat(args));                                                          // 150
		});                                                                                                                  // 150
                                                                                                                       //
		_this.on('beforeremove', function () {                                                                               // 151
			for (var _len10 = arguments.length, args = Array(_len10), _key10 = 0; _key10 < _len10; _key10++) {                  // 151
				args[_key10] = arguments[_key10];                                                                                  // 151
			}                                                                                                                   // 151
                                                                                                                       //
			_this.emit.apply(_this, ['sync', 'removed'].concat(args));                                                          // 151
		});                                                                                                                  // 151
                                                                                                                       //
		_this.db = db;                                                                                                       // 153
		_this.model = model;                                                                                                 // 155
		_this.collectionName = _this.model._db.collectionName;                                                               // 157
		_this.collection = _this.db.addCollection(_this.collectionName);                                                     // 158
		return _this;                                                                                                        // 126
	}                                                                                                                     // 159
                                                                                                                       //
	ModelsBaseCache.prototype.hasOne = function () {                                                                      //
		function hasOne(join, _ref) {                                                                                        //
			var field = _ref.field,                                                                                             // 161
			    link = _ref.link;                                                                                               // 161
			this.join({                                                                                                         // 162
				join: join,                                                                                                        // 162
				field: field,                                                                                                      // 162
				link: link,                                                                                                        // 162
				multi: false                                                                                                       // 162
			});                                                                                                                 // 162
		}                                                                                                                    // 163
                                                                                                                       //
		return hasOne;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.hasMany = function () {                                                                     //
		function hasMany(join, _ref2) {                                                                                      //
			var field = _ref2.field,                                                                                            // 165
			    link = _ref2.link;                                                                                              // 165
			this.join({                                                                                                         // 166
				join: join,                                                                                                        // 166
				field: field,                                                                                                      // 166
				link: link,                                                                                                        // 166
				multi: true                                                                                                        // 166
			});                                                                                                                 // 166
		}                                                                                                                    // 167
                                                                                                                       //
		return hasMany;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.join = function () {                                                                        //
		function join(_ref3) {                                                                                               //
			var _this2 = this;                                                                                                  // 169
                                                                                                                       //
			var _join = _ref3.join,                                                                                             // 169
			    field = _ref3.field,                                                                                            // 169
			    link = _ref3.link,                                                                                              // 169
			    multi = _ref3.multi;                                                                                            // 169
                                                                                                                       //
			if (!RocketChat.models[_join]) {                                                                                    // 170
				console.log("Invalid cache model " + _join);                                                                       // 171
				return;                                                                                                            // 172
			}                                                                                                                   // 173
                                                                                                                       //
			RocketChat.models[_join].cache.on('inserted', function (record) {                                                   // 175
				_this2.processRemoteJoinInserted({                                                                                 // 176
					join: _join,                                                                                                      // 176
					field: field,                                                                                                     // 176
					link: link,                                                                                                       // 176
					multi: multi,                                                                                                     // 176
					record: record                                                                                                    // 176
				});                                                                                                                // 176
			});                                                                                                                 // 177
                                                                                                                       //
			RocketChat.models[_join].cache.on('beforeupdate', function (record, diff) {                                         // 179
				if (diff[link.remote]) {                                                                                           // 180
					_this2.processRemoteJoinRemoved({                                                                                 // 181
						join: _join,                                                                                                     // 181
						field: field,                                                                                                    // 181
						link: link,                                                                                                      // 181
						multi: multi,                                                                                                    // 181
						record: record                                                                                                   // 181
					});                                                                                                               // 181
				}                                                                                                                  // 182
			});                                                                                                                 // 183
                                                                                                                       //
			RocketChat.models[_join].cache.on('updated', function (record, diff) {                                              // 185
				if (diff[link.remote]) {                                                                                           // 186
					_this2.processRemoteJoinInserted({                                                                                // 187
						join: _join,                                                                                                     // 187
						field: field,                                                                                                    // 187
						link: link,                                                                                                      // 187
						multi: multi,                                                                                                    // 187
						record: record                                                                                                   // 187
					});                                                                                                               // 187
				}                                                                                                                  // 188
			});                                                                                                                 // 189
                                                                                                                       //
			RocketChat.models[_join].cache.on('removed', function (record) {                                                    // 191
				_this2.processRemoteJoinRemoved({                                                                                  // 192
					join: _join,                                                                                                      // 192
					field: field,                                                                                                     // 192
					link: link,                                                                                                       // 192
					multi: multi,                                                                                                     // 192
					record: record                                                                                                    // 192
				});                                                                                                                // 192
			});                                                                                                                 // 193
                                                                                                                       //
			this.on('inserted', function (localRecord) {                                                                        // 195
				_this2.processLocalJoinInserted({                                                                                  // 196
					join: _join,                                                                                                      // 196
					field: field,                                                                                                     // 196
					link: link,                                                                                                       // 196
					multi: multi,                                                                                                     // 196
					localRecord: localRecord                                                                                          // 196
				});                                                                                                                // 196
			});                                                                                                                 // 197
			this.on('beforeupdate', function (localRecord, diff) {                                                              // 199
				if (diff[link.local]) {                                                                                            // 200
					if (multi === true) {                                                                                             // 201
						localRecord[field] = [];                                                                                         // 202
					} else {                                                                                                          // 203
						localRecord[field] = undefined;                                                                                  // 204
					}                                                                                                                 // 205
				}                                                                                                                  // 206
			});                                                                                                                 // 207
			this.on('updated', function (localRecord, diff) {                                                                   // 209
				if (diff[link.local]) {                                                                                            // 210
					_this2.processLocalJoinInserted({                                                                                 // 211
						join: _join,                                                                                                     // 211
						field: field,                                                                                                    // 211
						link: link,                                                                                                      // 211
						multi: multi,                                                                                                    // 211
						localRecord: localRecord                                                                                         // 211
					});                                                                                                               // 211
				}                                                                                                                  // 212
			});                                                                                                                 // 213
		}                                                                                                                    // 214
                                                                                                                       //
		return join;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processRemoteJoinInserted = function () {                                                   //
		function processRemoteJoinInserted(_ref4) {                                                                          //
			var field = _ref4.field,                                                                                            // 216
			    link = _ref4.link,                                                                                              // 216
			    multi = _ref4.multi,                                                                                            // 216
			    record = _ref4.record;                                                                                          // 216
                                                                                                                       //
			var localRecords = this._findByIndex(link.local, objectPath.get(record, link.remote));                              // 217
                                                                                                                       //
			if (!localRecords) {                                                                                                // 219
				return;                                                                                                            // 220
			}                                                                                                                   // 221
                                                                                                                       //
			if (!Array.isArray(localRecords)) {                                                                                 // 223
				localRecords = [localRecords];                                                                                     // 224
			}                                                                                                                   // 225
                                                                                                                       //
			for (var i = 0; i < localRecords.length; i++) {                                                                     // 227
				var localRecord = localRecords[i];                                                                                 // 228
                                                                                                                       //
				if (multi === true && !localRecord[field]) {                                                                       // 229
					localRecord[field] = [];                                                                                          // 230
				}                                                                                                                  // 231
                                                                                                                       //
				if (typeof link.transform === 'function') {                                                                        // 233
					record = link.transform(localRecord, record);                                                                     // 234
				}                                                                                                                  // 235
                                                                                                                       //
				if (multi === true) {                                                                                              // 237
					localRecord[field].push(record);                                                                                  // 238
				} else {                                                                                                           // 239
					localRecord[field] = record;                                                                                      // 240
				}                                                                                                                  // 241
                                                                                                                       //
				this.emit("join:" + field + ":inserted", localRecord, record);                                                     // 243
				this.emit("join:" + field + ":changed", 'inserted', localRecord, record);                                          // 244
			}                                                                                                                   // 245
		}                                                                                                                    // 246
                                                                                                                       //
		return processRemoteJoinInserted;                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processLocalJoinInserted = function () {                                                    //
		function processLocalJoinInserted(_ref5) {                                                                           //
			var join = _ref5.join,                                                                                              // 248
			    field = _ref5.field,                                                                                            // 248
			    link = _ref5.link,                                                                                              // 248
			    multi = _ref5.multi,                                                                                            // 248
			    localRecord = _ref5.localRecord;                                                                                // 248
                                                                                                                       //
			var records = RocketChat.models[join].cache._findByIndex(link.remote, objectPath.get(localRecord, link.local));     // 249
                                                                                                                       //
			if (!Array.isArray(records)) {                                                                                      // 251
				records = [records];                                                                                               // 252
			}                                                                                                                   // 253
                                                                                                                       //
			for (var i = 0; i < records.length; i++) {                                                                          // 255
				var record = records[i];                                                                                           // 256
                                                                                                                       //
				if (typeof link.transform === 'function') {                                                                        // 258
					record = link.transform(localRecord, record);                                                                     // 259
				}                                                                                                                  // 260
                                                                                                                       //
				if (multi === true) {                                                                                              // 262
					localRecord[field].push(record);                                                                                  // 263
				} else {                                                                                                           // 264
					localRecord[field] = record;                                                                                      // 265
				}                                                                                                                  // 266
                                                                                                                       //
				this.emit("join:" + field + ":inserted", localRecord, record);                                                     // 268
				this.emit("join:" + field + ":changed", 'inserted', localRecord, record);                                          // 269
			}                                                                                                                   // 270
		}                                                                                                                    // 271
                                                                                                                       //
		return processLocalJoinInserted;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processRemoteJoinRemoved = function () {                                                    //
		function processRemoteJoinRemoved(_ref6) {                                                                           //
			var field = _ref6.field,                                                                                            // 273
			    link = _ref6.link,                                                                                              // 273
			    multi = _ref6.multi,                                                                                            // 273
			    record = _ref6.record;                                                                                          // 273
                                                                                                                       //
			var localRecords = this._findByIndex(link.local, objectPath.get(record, link.remote));                              // 274
                                                                                                                       //
			if (!localRecords) {                                                                                                // 276
				return;                                                                                                            // 277
			}                                                                                                                   // 278
                                                                                                                       //
			if (!Array.isArray(localRecords)) {                                                                                 // 280
				localRecords = [localRecords];                                                                                     // 281
			}                                                                                                                   // 282
                                                                                                                       //
			for (var i = 0; i < localRecords.length; i++) {                                                                     // 284
				var localRecord = localRecords[i];                                                                                 // 285
                                                                                                                       //
				if (multi === true) {                                                                                              // 287
					if (Array.isArray(localRecord[field])) {                                                                          // 288
						if (typeof link.remove === 'function') {                                                                         // 289
							link.remove(localRecord[field], record);                                                                        // 290
						} else if (localRecord[field].indexOf(record) > -1) {                                                            // 291
							localRecord[field].splice(localRecord[field].indexOf(record), 1);                                               // 292
						}                                                                                                                // 293
					}                                                                                                                 // 294
				} else {                                                                                                           // 295
					localRecord[field] = undefined;                                                                                   // 296
				}                                                                                                                  // 297
                                                                                                                       //
				this.emit("join:" + field + ":removed", localRecord, record);                                                      // 299
				this.emit("join:" + field + ":changed", 'removed', localRecord, record);                                           // 300
			}                                                                                                                   // 301
		}                                                                                                                    // 302
                                                                                                                       //
		return processRemoteJoinRemoved;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.ensureIndex = function () {                                                                 //
		function ensureIndex(fields) {                                                                                       //
			var type = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'array';                             // 304
                                                                                                                       //
			if (!Array.isArray(fields)) {                                                                                       // 305
				fields = [fields];                                                                                                 // 306
			}                                                                                                                   // 307
                                                                                                                       //
			this.indexes[fields.join(',')] = {                                                                                  // 309
				type: type,                                                                                                        // 310
				fields: fields,                                                                                                    // 311
				data: {}                                                                                                           // 312
			};                                                                                                                  // 309
		}                                                                                                                    // 314
                                                                                                                       //
		return ensureIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.addToAllIndexes = function () {                                                             //
		function addToAllIndexes(record) {                                                                                   //
			for (var indexName in meteorBabelHelpers.sanitizeForInObject(this.indexes)) {                                       // 317
				if (this.indexes.hasOwnProperty(indexName)) {                                                                      // 318
					this.addToIndex(indexName, record);                                                                               // 319
				}                                                                                                                  // 320
			}                                                                                                                   // 321
		}                                                                                                                    // 322
                                                                                                                       //
		return addToAllIndexes;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.addToIndex = function () {                                                                  //
		function addToIndex(indexName, record) {                                                                             //
			var index = this.indexes[indexName];                                                                                // 325
                                                                                                                       //
			if (!index) {                                                                                                       // 326
				console.error("Index not defined " + indexName);                                                                   // 327
				return;                                                                                                            // 328
			}                                                                                                                   // 329
                                                                                                                       //
			var keys = [];                                                                                                      // 331
                                                                                                                       //
			for (var _iterator = index.fields, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
				var _ref7;                                                                                                         // 332
                                                                                                                       //
				if (_isArray) {                                                                                                    // 332
					if (_i >= _iterator.length) break;                                                                                // 332
					_ref7 = _iterator[_i++];                                                                                          // 332
				} else {                                                                                                           // 332
					_i = _iterator.next();                                                                                            // 332
					if (_i.done) break;                                                                                               // 332
					_ref7 = _i.value;                                                                                                 // 332
				}                                                                                                                  // 332
                                                                                                                       //
				var field = _ref7;                                                                                                 // 332
				keys.push(objectPath.get(record, field));                                                                          // 333
			}                                                                                                                   // 334
                                                                                                                       //
			var key = keys.join('|');                                                                                           // 335
                                                                                                                       //
			if (index.type === 'unique') {                                                                                      // 337
				index.data[key] = record;                                                                                          // 338
				return;                                                                                                            // 339
			}                                                                                                                   // 340
                                                                                                                       //
			if (index.type === 'array') {                                                                                       // 342
				if (!index.data[key]) {                                                                                            // 343
					index.data[key] = [];                                                                                             // 344
				}                                                                                                                  // 345
                                                                                                                       //
				index.data[key].push(record);                                                                                      // 346
				return;                                                                                                            // 347
			}                                                                                                                   // 348
		}                                                                                                                    // 349
                                                                                                                       //
		return addToIndex;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.removeFromAllIndexes = function () {                                                        //
		function removeFromAllIndexes(record) {                                                                              //
			for (var indexName in meteorBabelHelpers.sanitizeForInObject(this.indexes)) {                                       // 352
				if (this.indexes.hasOwnProperty(indexName)) {                                                                      // 353
					this.removeFromIndex(indexName, record);                                                                          // 354
				}                                                                                                                  // 355
			}                                                                                                                   // 356
		}                                                                                                                    // 357
                                                                                                                       //
		return removeFromAllIndexes;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.removeFromIndex = function () {                                                             //
		function removeFromIndex(indexName, record) {                                                                        //
			var index = this.indexes[indexName];                                                                                // 360
                                                                                                                       //
			if (!this.indexes[indexName]) {                                                                                     // 361
				console.error("Index not defined " + indexName);                                                                   // 362
				return;                                                                                                            // 363
			}                                                                                                                   // 364
                                                                                                                       //
			if (!index.data) {                                                                                                  // 366
				return;                                                                                                            // 367
			}                                                                                                                   // 368
                                                                                                                       //
			var key = [];                                                                                                       // 370
                                                                                                                       //
			for (var _iterator2 = index.fields, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
				var _ref8;                                                                                                         // 371
                                                                                                                       //
				if (_isArray2) {                                                                                                   // 371
					if (_i2 >= _iterator2.length) break;                                                                              // 371
					_ref8 = _iterator2[_i2++];                                                                                        // 371
				} else {                                                                                                           // 371
					_i2 = _iterator2.next();                                                                                          // 371
					if (_i2.done) break;                                                                                              // 371
					_ref8 = _i2.value;                                                                                                // 371
				}                                                                                                                  // 371
                                                                                                                       //
				var field = _ref8;                                                                                                 // 371
				key.push(objectPath.get(record, field));                                                                           // 372
			}                                                                                                                   // 373
                                                                                                                       //
			key = key.join('|');                                                                                                // 374
                                                                                                                       //
			if (index.type === 'unique') {                                                                                      // 376
				index.data[key] = undefined;                                                                                       // 377
				return;                                                                                                            // 378
			}                                                                                                                   // 379
                                                                                                                       //
			if (index.type === 'array') {                                                                                       // 381
				if (!index.data[key]) {                                                                                            // 382
					return;                                                                                                           // 383
				}                                                                                                                  // 384
                                                                                                                       //
				var i = index.data[key].indexOf(record);                                                                           // 385
                                                                                                                       //
				if (i > -1) {                                                                                                      // 386
					index.data[key].splice(i, 1);                                                                                     // 387
				}                                                                                                                  // 388
                                                                                                                       //
				return;                                                                                                            // 389
			}                                                                                                                   // 390
		}                                                                                                                    // 391
                                                                                                                       //
		return removeFromIndex;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype._findByIndex = function () {                                                                //
		function _findByIndex(index, keys) {                                                                                 //
			var key = [].concat(keys).join('|');                                                                                // 394
                                                                                                                       //
			if (!this.indexes[index]) {                                                                                         // 395
				return;                                                                                                            // 396
			}                                                                                                                   // 397
                                                                                                                       //
			if (this.indexes[index].data) {                                                                                     // 399
				var result = this.indexes[index].data[key];                                                                        // 400
                                                                                                                       //
				if (result) {                                                                                                      // 401
					return result;                                                                                                    // 402
				}                                                                                                                  // 403
			}                                                                                                                   // 404
                                                                                                                       //
			if (this.indexes[index].type === 'array') {                                                                         // 406
				return [];                                                                                                         // 407
			}                                                                                                                   // 408
		}                                                                                                                    // 409
                                                                                                                       //
		return _findByIndex;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findByIndex = function () {                                                                 //
		function findByIndex(index, keys) {                                                                                  //
			var _this3 = this;                                                                                                  // 411
                                                                                                                       //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 411
			return {                                                                                                            // 412
				fetch: function () {                                                                                               // 413
					return _this3.processQueryOptionsOnResult(_this3._findByIndex(index, keys), options);                             // 414
				},                                                                                                                 // 415
				count: function () {                                                                                               // 417
					var records = _this3.findByIndex(index, keys, options).fetch();                                                   // 418
                                                                                                                       //
					if (Array.isArray(records)) {                                                                                     // 419
						return records.length;                                                                                           // 420
					}                                                                                                                 // 421
                                                                                                                       //
					return !records ? 0 : 1;                                                                                          // 422
				},                                                                                                                 // 423
				forEach: function (fn) {                                                                                           // 425
					var records = _this3.findByIndex(index, keys, options).fetch();                                                   // 426
                                                                                                                       //
					if (Array.isArray(records)) {                                                                                     // 427
						return records.forEach(fn);                                                                                      // 428
					}                                                                                                                 // 429
                                                                                                                       //
					if (records) {                                                                                                    // 430
						return fn(records);                                                                                              // 431
					}                                                                                                                 // 432
				}                                                                                                                  // 433
			};                                                                                                                  // 412
		}                                                                                                                    // 435
                                                                                                                       //
		return findByIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.load = function () {                                                                        //
		function load() {                                                                                                    //
			if (this.model._useCache === false) {                                                                               // 438
				return;                                                                                                            // 439
			}                                                                                                                   // 440
                                                                                                                       //
			console.log('Will load cache for', this.collectionName);                                                            // 442
			this.emit('beforeload');                                                                                            // 443
			this.loaded = false;                                                                                                // 444
			var time = RocketChat.statsTracker.now();                                                                           // 445
			var data = this.model.db.find(this.query, this.options).fetch();                                                    // 446
                                                                                                                       //
			for (var i = 0; i < data.length; i++) {                                                                             // 447
				this.insert(data[i]);                                                                                              // 448
			}                                                                                                                   // 449
                                                                                                                       //
			console.log(String(data.length), 'records load from', this.collectionName);                                         // 450
			RocketChat.statsTracker.timing('cache.load', RocketChat.statsTracker.now() - time, ["collection:" + this.collectionName]);
			this.startSync();                                                                                                   // 453
			this.loaded = true;                                                                                                 // 454
			this.emit('afterload');                                                                                             // 455
		}                                                                                                                    // 456
                                                                                                                       //
		return load;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.startSync = function () {                                                                   //
		function startSync() {                                                                                               //
			var _this4 = this;                                                                                                  // 458
                                                                                                                       //
			if (this.model._useCache === false) {                                                                               // 459
				return;                                                                                                            // 460
			}                                                                                                                   // 461
                                                                                                                       //
			this.model._db.on('change', function (_ref9) {                                                                      // 463
				var action = _ref9.action,                                                                                         // 463
				    id = _ref9.id,                                                                                                 // 463
				    data = _ref9.data;                                                                                             // 463
                                                                                                                       //
				switch (action) {                                                                                                  // 464
					case 'insert':                                                                                                    // 465
						data._id = id;                                                                                                   // 466
                                                                                                                       //
						_this4.insert(data);                                                                                             // 467
                                                                                                                       //
						break;                                                                                                           // 468
                                                                                                                       //
					case 'remove':                                                                                                    // 470
						_this4.removeById(id);                                                                                           // 471
                                                                                                                       //
						break;                                                                                                           // 472
                                                                                                                       //
					case 'update:record':                                                                                             // 474
						_this4.updateDiffById(id, data);                                                                                 // 475
                                                                                                                       //
						break;                                                                                                           // 476
                                                                                                                       //
					case 'update:diff':                                                                                               // 478
						_this4.updateDiffById(id, data);                                                                                 // 479
                                                                                                                       //
						break;                                                                                                           // 480
                                                                                                                       //
					case 'update:query':                                                                                              // 482
						_this4.update(data.query, data.update, data.options);                                                            // 483
                                                                                                                       //
						break;                                                                                                           // 484
				}                                                                                                                  // 464
			});                                                                                                                 // 486
		}                                                                                                                    // 487
                                                                                                                       //
		return startSync;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processQueryOptionsOnResult = function () {                                                 //
		function processQueryOptionsOnResult(result) {                                                                       //
			var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                               // 489
                                                                                                                       //
			if (result === undefined || result === null) {                                                                      // 490
				return undefined;                                                                                                  // 491
			}                                                                                                                   // 492
                                                                                                                       //
			if (Array.isArray(result)) {                                                                                        // 494
				if (options.sort) {                                                                                                // 495
					result = result.sort(function (a, b) {                                                                            // 496
						var r = 0;                                                                                                       // 497
                                                                                                                       //
						for (var field in meteorBabelHelpers.sanitizeForInObject(options.sort)) {                                        // 498
							if (options.sort.hasOwnProperty(field)) {                                                                       // 499
								var direction = options.sort[field];                                                                           // 500
								var valueA = void 0;                                                                                           // 501
								var valueB = void 0;                                                                                           // 502
                                                                                                                       //
								if (field.indexOf('.') > -1) {                                                                                 // 503
									valueA = objectPath.get(a, field);                                                                            // 504
									valueB = objectPath.get(b, field);                                                                            // 505
								} else {                                                                                                       // 506
									valueA = a[field];                                                                                            // 507
									valueB = b[field];                                                                                            // 508
								}                                                                                                              // 509
                                                                                                                       //
								if (valueA > valueB) {                                                                                         // 510
									r = direction;                                                                                                // 511
									break;                                                                                                        // 512
								}                                                                                                              // 513
                                                                                                                       //
								if (valueA < valueB) {                                                                                         // 514
									r = -direction;                                                                                               // 515
									break;                                                                                                        // 516
								}                                                                                                              // 517
							}                                                                                                               // 518
						}                                                                                                                // 519
                                                                                                                       //
						return r;                                                                                                        // 520
					});                                                                                                               // 521
				}                                                                                                                  // 522
                                                                                                                       //
				if (typeof options.skip === 'number') {                                                                            // 524
					result.splice(0, options.skip);                                                                                   // 525
				}                                                                                                                  // 526
                                                                                                                       //
				if (typeof options.limit === 'number' && options.limit !== 0) {                                                    // 528
					result.splice(options.limit);                                                                                     // 529
				}                                                                                                                  // 530
			}                                                                                                                   // 531
                                                                                                                       //
			if (!options.fields) {                                                                                              // 533
				options.fields = {};                                                                                               // 534
			}                                                                                                                   // 535
                                                                                                                       //
			var fieldsToRemove = [];                                                                                            // 537
			var fieldsToGet = [];                                                                                               // 538
                                                                                                                       //
			for (var field in meteorBabelHelpers.sanitizeForInObject(options.fields)) {                                         // 540
				if (options.fields.hasOwnProperty(field)) {                                                                        // 541
					if (options.fields[field] === 0) {                                                                                // 542
						fieldsToRemove.push(field);                                                                                      // 543
					} else if (options.fields[field] === 1) {                                                                         // 544
						fieldsToGet.push(field);                                                                                         // 545
					}                                                                                                                 // 546
				}                                                                                                                  // 547
			}                                                                                                                   // 548
                                                                                                                       //
			if (fieldsToRemove.length > 0 && fieldsToGet.length > 0) {                                                          // 550
				console.warn('Can\'t mix remove and get fields');                                                                  // 551
				fieldsToRemove.splice(0, fieldsToRemove.length);                                                                   // 552
			}                                                                                                                   // 553
                                                                                                                       //
			if (fieldsToGet.length > 0 && fieldsToGet.indexOf('_id') === -1) {                                                  // 555
				fieldsToGet.push('_id');                                                                                           // 556
			}                                                                                                                   // 557
                                                                                                                       //
			var pickFields = function (obj, fields) {                                                                           // 559
				var picked = {};                                                                                                   // 560
				fields.forEach(function (field) {                                                                                  // 561
					if (field.indexOf('.') !== -1) {                                                                                  // 562
						objectPath.set(picked, field, objectPath.get(obj, field));                                                       // 563
					} else {                                                                                                          // 564
						picked[field] = obj[field];                                                                                      // 565
					}                                                                                                                 // 566
				});                                                                                                                // 567
				return picked;                                                                                                     // 568
			};                                                                                                                  // 569
                                                                                                                       //
			if (fieldsToRemove.length > 0 || fieldsToGet.length > 0) {                                                          // 571
				if (Array.isArray(result)) {                                                                                       // 572
					result = result.map(function (record) {                                                                           // 573
						if (fieldsToRemove.length > 0) {                                                                                 // 574
							var _ref10;                                                                                                     // 574
                                                                                                                       //
							return (_ref10 = _).omit.apply(_ref10, [record].concat(fieldsToRemove));                                        // 575
						}                                                                                                                // 576
                                                                                                                       //
						if (fieldsToGet.length > 0) {                                                                                    // 578
							return pickFields(record, fieldsToGet);                                                                         // 579
						}                                                                                                                // 580
					});                                                                                                               // 581
				} else {                                                                                                           // 582
					if (fieldsToRemove.length > 0) {                                                                                  // 583
						var _ref11;                                                                                                      // 583
                                                                                                                       //
						return (_ref11 = _).omit.apply(_ref11, [result].concat(fieldsToRemove));                                         // 584
					}                                                                                                                 // 585
                                                                                                                       //
					if (fieldsToGet.length > 0) {                                                                                     // 587
						return pickFields(result, fieldsToGet);                                                                          // 588
					}                                                                                                                 // 589
				}                                                                                                                  // 590
			}                                                                                                                   // 591
                                                                                                                       //
			return result;                                                                                                      // 593
		}                                                                                                                    // 594
                                                                                                                       //
		return processQueryOptionsOnResult;                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processQuery = function () {                                                                //
		function processQuery(query, parentField) {                                                                          //
			var _this5 = this;                                                                                                  // 596
                                                                                                                       //
			if (!query) {                                                                                                       // 597
				return query;                                                                                                      // 598
			}                                                                                                                   // 599
                                                                                                                       //
			if (Match.test(query, String)) {                                                                                    // 601
				return {                                                                                                           // 602
					_id: query                                                                                                        // 603
				};                                                                                                                 // 602
			}                                                                                                                   // 605
                                                                                                                       //
			if (Object.keys(query).length > 1 && parentField !== '$elemMatch') {                                                // 607
				var and = [];                                                                                                      // 608
                                                                                                                       //
				for (var field in meteorBabelHelpers.sanitizeForInObject(query)) {                                                 // 609
					if (query.hasOwnProperty(field)) {                                                                                // 610
						var _and$push;                                                                                                   // 610
                                                                                                                       //
						and.push((_and$push = {}, _and$push[field] = query[field], _and$push));                                          // 611
					}                                                                                                                 // 614
				}                                                                                                                  // 615
                                                                                                                       //
				query = {                                                                                                          // 616
					$and: and                                                                                                         // 616
				};                                                                                                                 // 616
			}                                                                                                                   // 617
                                                                                                                       //
			var _loop2 = function (_field) {                                                                                    // 596
				if (query.hasOwnProperty(_field)) {                                                                                // 620
					var value = query[_field];                                                                                        // 621
                                                                                                                       //
					if (value instanceof RegExp && _field !== '$regex') {                                                             // 622
						query[_field] = {                                                                                                // 623
							$regex: value                                                                                                   // 624
						};                                                                                                               // 623
					}                                                                                                                 // 626
                                                                                                                       //
					if (_field === '$and' || _field === '$or') {                                                                      // 628
						query[_field] = value.map(function (subValue) {                                                                  // 629
							return _this5.processQuery(subValue, _field);                                                                   // 630
						});                                                                                                              // 631
					}                                                                                                                 // 632
                                                                                                                       //
					if (Match.test(value, Object) && Object.keys(value).length > 0) {                                                 // 634
						query[_field] = _this5.processQuery(value, _field);                                                              // 635
					}                                                                                                                 // 636
				}                                                                                                                  // 637
			};                                                                                                                  // 596
                                                                                                                       //
			for (var _field in meteorBabelHelpers.sanitizeForInObject(query)) {                                                 // 619
				_loop2(_field);                                                                                                    // 619
			}                                                                                                                   // 638
                                                                                                                       //
			return query;                                                                                                       // 640
		}                                                                                                                    // 641
                                                                                                                       //
		return processQuery;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.find = function () {                                                                        //
		function find(query) {                                                                                               //
			var _this6 = this,                                                                                                  // 643
			    _arguments = arguments;                                                                                         // 643
                                                                                                                       //
			var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                               // 643
			return {                                                                                                            // 644
				fetch: function () {                                                                                               // 645
					try {                                                                                                             // 646
						query = _this6.processQuery(query);                                                                              // 647
						return _this6.processQueryOptionsOnResult(_this6.collection.find(query), options);                               // 648
					} catch (e) {                                                                                                     // 649
						console.error('Exception on cache find for', _this6.collectionName);                                             // 650
						console.error('Query:', JSON.stringify(query, null, 2));                                                         // 651
						console.error('Options:', JSON.stringify(options, null, 2));                                                     // 652
						console.error(e.stack);                                                                                          // 653
						throw e;                                                                                                         // 654
					}                                                                                                                 // 655
				},                                                                                                                 // 656
				count: function () {                                                                                               // 658
					try {                                                                                                             // 659
						query = _this6.processQuery(query);                                                                              // 660
						var limit = options.limit,                                                                                       // 659
						    skip = options.skip;                                                                                         // 659
						return _this6.processQueryOptionsOnResult(_this6.collection.find(query), {                                       // 662
							limit: limit,                                                                                                   // 662
							skip: skip                                                                                                      // 662
						}).length;                                                                                                       // 662
					} catch (e) {                                                                                                     // 663
						console.error('Exception on cache find for', _this6.collectionName);                                             // 664
						console.error('Query:', JSON.stringify(query, null, 2));                                                         // 665
						console.error('Options:', JSON.stringify(options, null, 2));                                                     // 666
						console.error(e.stack);                                                                                          // 667
						throw e;                                                                                                         // 668
					}                                                                                                                 // 669
				},                                                                                                                 // 670
				forEach: function (fn) {                                                                                           // 672
					return _this6.find(query, options).fetch().forEach(fn);                                                           // 673
				},                                                                                                                 // 674
				observe: function (obj) {                                                                                          // 676
					var _model$db;                                                                                                    // 676
                                                                                                                       //
					logger.debug(_this6.collectionName, 'Falling back observe to model with query:', query);                          // 677
					return (_model$db = _this6.model.db).find.apply(_model$db, _arguments).observe(obj);                              // 678
				},                                                                                                                 // 679
				observeChanges: function (obj) {                                                                                   // 681
					var _model$db2;                                                                                                   // 681
                                                                                                                       //
					logger.debug(_this6.collectionName, 'Falling back observeChanges to model with query:', query);                   // 682
					return (_model$db2 = _this6.model.db).find.apply(_model$db2, _arguments).observeChanges(obj);                     // 683
				},                                                                                                                 // 684
				_publishCursor: function (cursor, sub, collection) {                                                               // 686
					var _model$db3;                                                                                                   // 686
                                                                                                                       //
					logger.debug(_this6.collectionName, 'Falling back _publishCursor to model with query:', query);                   // 687
					return (_model$db3 = _this6.model.db).find.apply(_model$db3, _arguments)._publishCursor(cursor, sub, collection);
				}                                                                                                                  // 689
			};                                                                                                                  // 644
		}                                                                                                                    // 691
                                                                                                                       //
		return find;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findOne = function () {                                                                     //
		function findOne(query, options) {                                                                                   //
			try {                                                                                                               // 694
				query = this.processQuery(query);                                                                                  // 695
				return this.processQueryOptionsOnResult(this.collection.findOne(query), options);                                  // 696
			} catch (e) {                                                                                                       // 697
				console.error('Exception on cache findOne for', this.collectionName);                                              // 698
				console.error('Query:', JSON.stringify(query, null, 2));                                                           // 699
				console.error('Options:', JSON.stringify(options, null, 2));                                                       // 700
				console.error(e.stack);                                                                                            // 701
				throw e;                                                                                                           // 702
			}                                                                                                                   // 703
		}                                                                                                                    // 704
                                                                                                                       //
		return findOne;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findOneById = function () {                                                                 //
		function findOneById(_id, options) {                                                                                 //
			return this.findByIndex('_id', _id, options).fetch();                                                               // 707
		}                                                                                                                    // 708
                                                                                                                       //
		return findOneById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findOneByIds = function () {                                                                //
		function findOneByIds(ids, options) {                                                                                //
			var query = this.processQuery({                                                                                     // 711
				_id: {                                                                                                             // 711
					$in: ids                                                                                                          // 711
				}                                                                                                                  // 711
			});                                                                                                                 // 711
			return this.processQueryOptionsOnResult(this.collection.findOne(query), options);                                   // 712
		}                                                                                                                    // 713
                                                                                                                       //
		return findOneByIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findWhere = function () {                                                                   //
		function findWhere(query, options) {                                                                                 //
			query = this.processQuery(query);                                                                                   // 716
			return this.processQueryOptionsOnResult(this.collection.findWhere(query), options);                                 // 717
		}                                                                                                                    // 718
                                                                                                                       //
		return findWhere;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.addDynamicView = function () {                                                              //
		function addDynamicView() {                                                                                          //
			var _collection;                                                                                                    // 720
                                                                                                                       //
			return (_collection = this.collection).addDynamicView.apply(_collection, arguments);                                // 721
		}                                                                                                                    // 722
                                                                                                                       //
		return addDynamicView;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.getDynamicView = function () {                                                              //
		function getDynamicView() {                                                                                          //
			var _collection2;                                                                                                   // 724
                                                                                                                       //
			return (_collection2 = this.collection).getDynamicView.apply(_collection2, arguments);                              // 725
		}                                                                                                                    // 726
                                                                                                                       //
		return getDynamicView;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.insert = function () {                                                                      //
		function insert(record) {                                                                                            //
			if (Array.isArray(record)) {                                                                                        // 729
				for (var _iterator3 = record, _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[Symbol.iterator]();;) {
					var _ref12;                                                                                                       // 730
                                                                                                                       //
					if (_isArray3) {                                                                                                  // 730
						if (_i3 >= _iterator3.length) break;                                                                             // 730
						_ref12 = _iterator3[_i3++];                                                                                      // 730
					} else {                                                                                                          // 730
						_i3 = _iterator3.next();                                                                                         // 730
						if (_i3.done) break;                                                                                             // 730
						_ref12 = _i3.value;                                                                                              // 730
					}                                                                                                                 // 730
                                                                                                                       //
					var item = _ref12;                                                                                                // 730
					this.insert(item);                                                                                                // 731
				}                                                                                                                  // 732
			} else {                                                                                                            // 733
				// TODO remove - ignore updates in room.usernames                                                                  // 734
				if (this.collectionName === 'rocketchat_room' && record.usernames) {                                               // 735
					delete record.usernames;                                                                                          // 736
				}                                                                                                                  // 737
                                                                                                                       //
				this.emit('beforeinsert', record);                                                                                 // 738
				this.addToAllIndexes(record);                                                                                      // 739
				this.collection.insert(record);                                                                                    // 740
				this.emit('inserted', record);                                                                                     // 741
			}                                                                                                                   // 742
		}                                                                                                                    // 743
                                                                                                                       //
		return insert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.updateDiffById = function () {                                                              //
		function updateDiffById(id, diff) {                                                                                  //
			var _ref13;                                                                                                         // 745
                                                                                                                       //
			// TODO remove - ignore updates in room.usernames                                                                   // 746
			if (this.collectionName === 'rocketchat_room' && diff.usernames) {                                                  // 747
				delete diff.usernames;                                                                                             // 748
			}                                                                                                                   // 749
                                                                                                                       //
			var record = this._findByIndex('_id', id);                                                                          // 751
                                                                                                                       //
			if (!record) {                                                                                                      // 752
				console.error('Cache.updateDiffById: No record', this.collectionName, id, diff);                                   // 753
				return;                                                                                                            // 754
			}                                                                                                                   // 755
                                                                                                                       //
			var updatedFields = (_ref13 = _).without.apply(_ref13, [Object.keys(diff)].concat((0, _toConsumableArray3.default)(this.ignoreUpdatedFields)));
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 759
				this.emit('beforeupdate', record, diff);                                                                           // 760
			}                                                                                                                   // 761
                                                                                                                       //
			for (var key in meteorBabelHelpers.sanitizeForInObject(diff)) {                                                     // 763
				if (diff.hasOwnProperty(key)) {                                                                                    // 764
					objectPath.set(record, key, diff[key]);                                                                           // 765
				}                                                                                                                  // 766
			}                                                                                                                   // 767
                                                                                                                       //
			this.collection.update(record);                                                                                     // 769
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 771
				this.emit('updated', record, diff);                                                                                // 772
			}                                                                                                                   // 773
		}                                                                                                                    // 774
                                                                                                                       //
		return updateDiffById;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.updateRecord = function () {                                                                //
		function updateRecord(record, update) {                                                                              //
			var _ref14;                                                                                                         // 776
                                                                                                                       //
			// TODO remove - ignore updates in room.usernames                                                                   // 777
			if (this.collectionName === 'rocketchat_room' && (record.usernames || record.$set && record.$set.usernames)) {      // 778
				delete record.usernames;                                                                                           // 779
                                                                                                                       //
				if (record.$set && record.$set.usernames) {                                                                        // 780
					delete record.$set.usernames;                                                                                     // 781
				}                                                                                                                  // 782
			}                                                                                                                   // 783
                                                                                                                       //
			var topLevelFields = Object.keys(update).map(function (field) {                                                     // 785
				return field.split('.')[0];                                                                                        // 785
			});                                                                                                                 // 785
                                                                                                                       //
			var updatedFields = (_ref14 = _).without.apply(_ref14, [topLevelFields].concat((0, _toConsumableArray3.default)(this.ignoreUpdatedFields)));
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 788
				this.emit('beforeupdate', record, record);                                                                         // 789
			}                                                                                                                   // 790
                                                                                                                       //
			if (update.$set) {                                                                                                  // 792
				_.each(update.$set, function (value, field) {                                                                      // 793
					objectPath.set(record, field, value);                                                                             // 794
				});                                                                                                                // 795
			}                                                                                                                   // 796
                                                                                                                       //
			if (update.$unset) {                                                                                                // 798
				_.each(update.$unset, function (value, field) {                                                                    // 799
					objectPath.del(record, field);                                                                                    // 800
				});                                                                                                                // 801
			}                                                                                                                   // 802
                                                                                                                       //
			if (update.$min) {                                                                                                  // 804
				_.each(update.$min, function (value, field) {                                                                      // 805
					var curValue = objectPath.get(record, field);                                                                     // 806
                                                                                                                       //
					if (curValue === undefined || value < curValue) {                                                                 // 807
						objectPath.set(record, field, value);                                                                            // 808
					}                                                                                                                 // 809
				});                                                                                                                // 810
			}                                                                                                                   // 811
                                                                                                                       //
			if (update.$max) {                                                                                                  // 813
				_.each(update.$max, function (value, field) {                                                                      // 814
					var curValue = objectPath.get(record, field);                                                                     // 815
                                                                                                                       //
					if (curValue === undefined || value > curValue) {                                                                 // 816
						objectPath.set(record, field, value);                                                                            // 817
					}                                                                                                                 // 818
				});                                                                                                                // 819
			}                                                                                                                   // 820
                                                                                                                       //
			if (update.$inc) {                                                                                                  // 822
				_.each(update.$inc, function (value, field) {                                                                      // 823
					var curValue = objectPath.get(record, field);                                                                     // 824
                                                                                                                       //
					if (curValue === undefined) {                                                                                     // 825
						curValue = value;                                                                                                // 826
					} else {                                                                                                          // 827
						curValue += value;                                                                                               // 828
					}                                                                                                                 // 829
                                                                                                                       //
					objectPath.set(record, field, curValue);                                                                          // 830
				});                                                                                                                // 831
			}                                                                                                                   // 832
                                                                                                                       //
			if (update.$mul) {                                                                                                  // 834
				_.each(update.$mul, function (value, field) {                                                                      // 835
					var curValue = objectPath.get(record, field);                                                                     // 836
                                                                                                                       //
					if (curValue === undefined) {                                                                                     // 837
						curValue = 0;                                                                                                    // 838
					} else {                                                                                                          // 839
						curValue *= value;                                                                                               // 840
					}                                                                                                                 // 841
                                                                                                                       //
					objectPath.set(record, field, curValue);                                                                          // 842
				});                                                                                                                // 843
			}                                                                                                                   // 844
                                                                                                                       //
			if (update.$rename) {                                                                                               // 846
				_.each(update.$rename, function (value, field) {                                                                   // 847
					var curValue = objectPath.get(record, field);                                                                     // 848
                                                                                                                       //
					if (curValue !== undefined) {                                                                                     // 849
						objectPath.set(record, value, curValue);                                                                         // 850
						objectPath.del(record, field);                                                                                   // 851
					}                                                                                                                 // 852
				});                                                                                                                // 853
			}                                                                                                                   // 854
                                                                                                                       //
			if (update.$pullAll) {                                                                                              // 856
				_.each(update.$pullAll, function (value, field) {                                                                  // 857
					var curValue = objectPath.get(record, field);                                                                     // 858
                                                                                                                       //
					if (Array.isArray(curValue)) {                                                                                    // 859
						curValue = _.difference(curValue, value);                                                                        // 860
						objectPath.set(record, field, curValue);                                                                         // 861
					}                                                                                                                 // 862
				});                                                                                                                // 863
			}                                                                                                                   // 864
                                                                                                                       //
			if (update.$pop) {                                                                                                  // 866
				_.each(update.$pop, function (value, field) {                                                                      // 867
					var curValue = objectPath.get(record, field);                                                                     // 868
                                                                                                                       //
					if (Array.isArray(curValue)) {                                                                                    // 869
						if (value === -1) {                                                                                              // 870
							curValue.shift();                                                                                               // 871
						} else {                                                                                                         // 872
							curValue.pop();                                                                                                 // 873
						}                                                                                                                // 874
                                                                                                                       //
						objectPath.set(record, field, curValue);                                                                         // 875
					}                                                                                                                 // 876
				});                                                                                                                // 877
			}                                                                                                                   // 878
                                                                                                                       //
			if (update.$addToSet) {                                                                                             // 880
				_.each(update.$addToSet, function (value, field) {                                                                 // 881
					var curValue = objectPath.get(record, field);                                                                     // 882
                                                                                                                       //
					if (curValue === undefined) {                                                                                     // 883
						curValue = [];                                                                                                   // 884
					}                                                                                                                 // 885
                                                                                                                       //
					if (Array.isArray(curValue)) {                                                                                    // 886
						var length = curValue.length;                                                                                    // 887
                                                                                                                       //
						if (value && value.$each && Array.isArray(value.$each)) {                                                        // 889
							for (var _iterator4 = value.$each, _isArray4 = Array.isArray(_iterator4), _i4 = 0, _iterator4 = _isArray4 ? _iterator4 : _iterator4[Symbol.iterator]();;) {
								var _ref15;                                                                                                    // 890
                                                                                                                       //
								if (_isArray4) {                                                                                               // 890
									if (_i4 >= _iterator4.length) break;                                                                          // 890
									_ref15 = _iterator4[_i4++];                                                                                   // 890
								} else {                                                                                                       // 890
									_i4 = _iterator4.next();                                                                                      // 890
									if (_i4.done) break;                                                                                          // 890
									_ref15 = _i4.value;                                                                                           // 890
								}                                                                                                              // 890
                                                                                                                       //
								var valueItem = _ref15;                                                                                        // 890
                                                                                                                       //
								if (curValue.indexOf(valueItem) === -1) {                                                                      // 891
									curValue.push(valueItem);                                                                                     // 892
								}                                                                                                              // 893
							}                                                                                                               // 894
						} else if (curValue.indexOf(value) === -1) {                                                                     // 895
							curValue.push(value);                                                                                           // 896
						}                                                                                                                // 897
                                                                                                                       //
						if (curValue.length > length) {                                                                                  // 899
							objectPath.set(record, field, curValue);                                                                        // 900
						}                                                                                                                // 901
					}                                                                                                                 // 902
				});                                                                                                                // 903
			}                                                                                                                   // 904
                                                                                                                       //
			this.collection.update(record);                                                                                     // 906
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 908
				this.emit('updated', record, record);                                                                              // 909
			}                                                                                                                   // 910
		}                                                                                                                    // 911
                                                                                                                       //
		return updateRecord;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.update = function () {                                                                      //
		function update(query, _update) {                                                                                    //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 913
			var records = options.multi ? this.find(query).fetch() : this.findOne(query) || [];                                 // 914
                                                                                                                       //
			if (!Array.isArray(records)) {                                                                                      // 915
				records = [records];                                                                                               // 916
			}                                                                                                                   // 917
                                                                                                                       //
			for (var _iterator5 = records, _isArray5 = Array.isArray(_iterator5), _i5 = 0, _iterator5 = _isArray5 ? _iterator5 : _iterator5[Symbol.iterator]();;) {
				var _ref16;                                                                                                        // 919
                                                                                                                       //
				if (_isArray5) {                                                                                                   // 919
					if (_i5 >= _iterator5.length) break;                                                                              // 919
					_ref16 = _iterator5[_i5++];                                                                                       // 919
				} else {                                                                                                           // 919
					_i5 = _iterator5.next();                                                                                          // 919
					if (_i5.done) break;                                                                                              // 919
					_ref16 = _i5.value;                                                                                               // 919
				}                                                                                                                  // 919
                                                                                                                       //
				var record = _ref16;                                                                                               // 919
				this.updateRecord(record, _update);                                                                                // 920
			}                                                                                                                   // 921
		}                                                                                                                    // 922
                                                                                                                       //
		return update;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.removeById = function () {                                                                  //
		function removeById(id) {                                                                                            //
			var record = this._findByIndex('_id', id);                                                                          // 925
                                                                                                                       //
			if (record) {                                                                                                       // 926
				this.emit('beforeremove', record);                                                                                 // 927
				this.collection.removeWhere({                                                                                      // 928
					_id: id                                                                                                           // 928
				});                                                                                                                // 928
				this.removeFromAllIndexes(record);                                                                                 // 929
				this.emit('removed', record);                                                                                      // 930
			}                                                                                                                   // 931
		}                                                                                                                    // 932
                                                                                                                       //
		return removeById;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	return ModelsBaseCache;                                                                                               //
}(EventEmitter);                                                                                                       //
                                                                                                                       //
module.export("default", exports.default = ModelsBaseCache);                                                           // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"_BaseDb.js":["babel-runtime/helpers/classCallCheck","babel-runtime/helpers/createClass","babel-runtime/helpers/possibleConstructorReturn","babel-runtime/helpers/inherits","events",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/_BaseDb.js                                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _createClass2 = require("babel-runtime/helpers/createClass");                                                      //
                                                                                                                       //
var _createClass3 = _interopRequireDefault(_createClass2);                                                             //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var EventEmitter = void 0;                                                                                             // 1
module.import('events', {                                                                                              // 1
	"EventEmitter": function (v) {                                                                                        // 1
		EventEmitter = v;                                                                                                    // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
/* globals MongoInternals */var baseName = 'rocketchat_';                                                              // 1
var trash = new Mongo.Collection(baseName + '_trash');                                                                 // 6
                                                                                                                       //
try {                                                                                                                  // 7
	trash._ensureIndex({                                                                                                  // 8
		collection: 1                                                                                                        // 8
	});                                                                                                                   // 8
                                                                                                                       //
	trash._ensureIndex({                                                                                                  // 9
		_deletedAt: 1                                                                                                        // 9
	}, {                                                                                                                  // 9
		expireAfterSeconds: 60 * 60 * 24 * 30                                                                                // 9
	});                                                                                                                   // 9
} catch (e) {                                                                                                          // 10
	console.log(e);                                                                                                       // 11
}                                                                                                                      // 12
                                                                                                                       //
var isOplogAvailable = MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle && !!MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle.onOplogEntry;
var isOplogEnabled = isOplogAvailable;                                                                                 // 15
RocketChat.settings.get('Force_Disable_OpLog_For_Cache', function (key, value) {                                       // 16
	isOplogEnabled = isOplogAvailable && value === false;                                                                 // 17
});                                                                                                                    // 18
                                                                                                                       //
var ModelsBaseDb = function (_EventEmitter) {                                                                          //
	(0, _inherits3.default)(ModelsBaseDb, _EventEmitter);                                                                 //
                                                                                                                       //
	function ModelsBaseDb(model, baseModel) {                                                                             // 21
		(0, _classCallCheck3.default)(this, ModelsBaseDb);                                                                   // 21
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _EventEmitter.call(this));                                // 21
                                                                                                                       //
		if (Match.test(model, String)) {                                                                                     // 24
			_this.name = model;                                                                                                 // 25
			_this.collectionName = _this.baseName + _this.name;                                                                 // 26
			_this.model = new Mongo.Collection(_this.collectionName);                                                           // 27
		} else {                                                                                                             // 28
			_this.name = model._name;                                                                                           // 29
			_this.collectionName = _this.name;                                                                                  // 30
			_this.model = model;                                                                                                // 31
		}                                                                                                                    // 32
                                                                                                                       //
		_this.baseModel = baseModel;                                                                                         // 34
                                                                                                                       //
		_this.wrapModel(); // When someone start listening for changes we start oplog if available                           // 36
                                                                                                                       //
                                                                                                                       //
		_this.once('newListener', function (event /*, listener*/) {                                                          // 39
			if (event === 'change') {                                                                                           // 40
				if (isOplogEnabled) {                                                                                              // 41
					var query = {                                                                                                     // 42
						collection: _this.collectionName                                                                                 // 43
					};                                                                                                                // 42
                                                                                                                       //
					MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle.onOplogEntry(query, _this.processOplogRecord.bind(_this));
                                                                                                                       //
					MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle._defineTooFarBehind(Number.MAX_SAFE_INTEGER);   // 47
				}                                                                                                                  // 48
			}                                                                                                                   // 49
		});                                                                                                                  // 50
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 52
			'_updatedAt': 1                                                                                                     // 52
		});                                                                                                                  // 52
                                                                                                                       //
		return _this;                                                                                                        // 21
	}                                                                                                                     // 53
                                                                                                                       //
	ModelsBaseDb.prototype.setUpdatedAt = function () {                                                                   //
		function setUpdatedAt() {                                                                                            //
			var record = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};                                // 59
                                                                                                                       //
			// TODO: Check if this can be deleted, Rodrigo does not rememebr WHY he added it. So he removed it to fix issue #5541
			// setUpdatedAt(record = {}, checkQuery = false, query) {                                                           // 62
			// if (checkQuery === true) {                                                                                       // 63
			// 	if (!query || Object.keys(query).length === 0) {                                                                // 64
			// 		throw new Meteor.Error('Models._Base: Empty query');                                                           // 65
			// 	}                                                                                                               // 66
			// }                                                                                                                // 67
			if (/(^|,)\$/.test(Object.keys(record).join(','))) {                                                                // 69
				record.$set = record.$set || {};                                                                                   // 70
				record.$set._updatedAt = new Date();                                                                               // 71
			} else {                                                                                                            // 72
				record._updatedAt = new Date();                                                                                    // 73
			}                                                                                                                   // 74
                                                                                                                       //
			return record;                                                                                                      // 76
		}                                                                                                                    // 77
                                                                                                                       //
		return setUpdatedAt;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.wrapModel = function () {                                                                      //
		function wrapModel() {                                                                                               //
			this.originals = {                                                                                                  // 80
				insert: this.model.insert.bind(this.model),                                                                        // 81
				update: this.model.update.bind(this.model),                                                                        // 82
				remove: this.model.remove.bind(this.model)                                                                         // 83
			};                                                                                                                  // 80
			var self = this;                                                                                                    // 85
                                                                                                                       //
			this.model.insert = function () {                                                                                   // 87
				return self.insert.apply(self, arguments);                                                                         // 88
			};                                                                                                                  // 89
                                                                                                                       //
			this.model.update = function () {                                                                                   // 91
				return self.update.apply(self, arguments);                                                                         // 92
			};                                                                                                                  // 93
                                                                                                                       //
			this.model.remove = function () {                                                                                   // 95
				return self.remove.apply(self, arguments);                                                                         // 96
			};                                                                                                                  // 97
		}                                                                                                                    // 98
                                                                                                                       //
		return wrapModel;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.find = function () {                                                                           //
		function find() {                                                                                                    //
			var _model;                                                                                                         // 100
                                                                                                                       //
			return (_model = this.model).find.apply(_model, arguments);                                                         // 101
		}                                                                                                                    // 102
                                                                                                                       //
		return find;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.findOne = function () {                                                                        //
		function findOne() {                                                                                                 //
			var _model2;                                                                                                        // 104
                                                                                                                       //
			return (_model2 = this.model).findOne.apply(_model2, arguments);                                                    // 105
		}                                                                                                                    // 106
                                                                                                                       //
		return findOne;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.findOneById = function () {                                                                    //
		function findOneById(_id, options) {                                                                                 //
			return this.model.findOne({                                                                                         // 109
				_id: _id                                                                                                           // 109
			}, options);                                                                                                        // 109
		}                                                                                                                    // 110
                                                                                                                       //
		return findOneById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.findOneByIds = function () {                                                                   //
		function findOneByIds(ids, options) {                                                                                //
			return this.model.findOne({                                                                                         // 113
				_id: {                                                                                                             // 113
					$in: ids                                                                                                          // 113
				}                                                                                                                  // 113
			}, options);                                                                                                        // 113
		}                                                                                                                    // 114
                                                                                                                       //
		return findOneByIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.defineSyncStrategy = function () {                                                             //
		function defineSyncStrategy(query, modifier, options) {                                                              //
			if (this.baseModel.useCache === false) {                                                                            // 117
				return 'db';                                                                                                       // 118
			}                                                                                                                   // 119
                                                                                                                       //
			if (options.upsert === true) {                                                                                      // 121
				return 'db';                                                                                                       // 122
			} // const dbModifiers = [                                                                                          // 123
			// 	'$currentDate',                                                                                                 // 126
			// 	'$bit',                                                                                                         // 127
			// 	'$pull',                                                                                                        // 128
			// 	'$pushAll',                                                                                                     // 129
			// 	'$push',                                                                                                        // 130
			// 	'$setOnInsert'                                                                                                  // 131
			// ];                                                                                                               // 132
                                                                                                                       //
                                                                                                                       //
			var cacheAllowedModifiers = ['$set', '$unset', '$min', '$max', '$inc', '$mul', '$rename', '$pullAll', '$pop', '$addToSet'];
			var notAllowedModifiers = Object.keys(modifier).filter(function (i) {                                               // 147
				return i.startsWith('$') && cacheAllowedModifiers.includes(i) === false;                                           // 147
			});                                                                                                                 // 147
                                                                                                                       //
			if (notAllowedModifiers.length > 0) {                                                                               // 149
				return 'db';                                                                                                       // 150
			}                                                                                                                   // 151
                                                                                                                       //
			var placeholderFields = Object.keys(query).filter(function (item) {                                                 // 153
				return item.indexOf('$') > -1;                                                                                     // 153
			});                                                                                                                 // 153
                                                                                                                       //
			if (placeholderFields.length > 0) {                                                                                 // 154
				return 'db';                                                                                                       // 155
			}                                                                                                                   // 156
                                                                                                                       //
			return 'cache';                                                                                                     // 158
		}                                                                                                                    // 159
                                                                                                                       //
		return defineSyncStrategy;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.updateHasPositionalOperator = function () {                                                    //
		function updateHasPositionalOperator(update) {                                                                       //
			for (var key in meteorBabelHelpers.sanitizeForInObject(update)) {                                                   // 162
				if (key.includes('.$')) {                                                                                          // 163
					return true;                                                                                                      // 164
				}                                                                                                                  // 165
                                                                                                                       //
				var value = update[key];                                                                                           // 167
                                                                                                                       //
				if (Match.test(value, Object)) {                                                                                   // 169
					if (this.updateHasPositionalOperator(value) === true) {                                                           // 170
						return true;                                                                                                     // 171
					}                                                                                                                 // 172
				}                                                                                                                  // 173
			}                                                                                                                   // 174
                                                                                                                       //
			return false;                                                                                                       // 176
		}                                                                                                                    // 177
                                                                                                                       //
		return updateHasPositionalOperator;                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.processOplogRecord = function () {                                                             //
		function processOplogRecord(action) {                                                                                //
			if (isOplogEnabled === false) {                                                                                     // 180
				return;                                                                                                            // 181
			}                                                                                                                   // 182
                                                                                                                       //
			if (action.op.op === 'i') {                                                                                         // 184
				this.emit('change', {                                                                                              // 185
					action: 'insert',                                                                                                 // 186
					id: action.op.o._id,                                                                                              // 187
					data: action.op.o,                                                                                                // 188
					oplog: true                                                                                                       // 189
				});                                                                                                                // 185
				return;                                                                                                            // 191
			}                                                                                                                   // 192
                                                                                                                       //
			if (action.op.op === 'u') {                                                                                         // 194
				if (!action.op.o.$set && !action.op.o.$unset) {                                                                    // 195
					this.emit('change', {                                                                                             // 196
						action: 'update:record',                                                                                         // 197
						id: action.id,                                                                                                   // 198
						data: action.op.o,                                                                                               // 199
						oplog: true                                                                                                      // 200
					});                                                                                                               // 196
					return;                                                                                                           // 202
				}                                                                                                                  // 203
                                                                                                                       //
				var diff = {};                                                                                                     // 205
                                                                                                                       //
				if (action.op.o.$set) {                                                                                            // 206
					for (var key in meteorBabelHelpers.sanitizeForInObject(action.op.o.$set)) {                                       // 207
						if (action.op.o.$set.hasOwnProperty(key)) {                                                                      // 208
							diff[key] = action.op.o.$set[key];                                                                              // 209
						}                                                                                                                // 210
					}                                                                                                                 // 211
				}                                                                                                                  // 212
                                                                                                                       //
				if (action.op.o.$unset) {                                                                                          // 214
					for (var _key in meteorBabelHelpers.sanitizeForInObject(action.op.o.$unset)) {                                    // 215
						if (action.op.o.$unset.hasOwnProperty(_key)) {                                                                   // 216
							diff[_key] = undefined;                                                                                         // 217
						}                                                                                                                // 218
					}                                                                                                                 // 219
				}                                                                                                                  // 220
                                                                                                                       //
				this.emit('change', {                                                                                              // 222
					action: 'update:diff',                                                                                            // 223
					id: action.id,                                                                                                    // 224
					data: diff,                                                                                                       // 225
					oplog: true                                                                                                       // 226
				});                                                                                                                // 222
				return;                                                                                                            // 228
			}                                                                                                                   // 229
                                                                                                                       //
			if (action.op.op === 'd') {                                                                                         // 231
				this.emit('change', {                                                                                              // 232
					action: 'remove',                                                                                                 // 233
					id: action.id,                                                                                                    // 234
					oplog: true                                                                                                       // 235
				});                                                                                                                // 232
				return;                                                                                                            // 237
			}                                                                                                                   // 238
		}                                                                                                                    // 239
                                                                                                                       //
		return processOplogRecord;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.insert = function () {                                                                         //
		function insert(record) {                                                                                            //
			var _originals;                                                                                                     // 241
                                                                                                                       //
			this.setUpdatedAt(record);                                                                                          // 242
                                                                                                                       //
			var result = (_originals = this.originals).insert.apply(_originals, arguments);                                     // 244
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0) {                                                          // 245
				this.emit('change', {                                                                                              // 246
					action: 'insert',                                                                                                 // 247
					id: result,                                                                                                       // 248
					data: _.extend({}, record),                                                                                       // 249
					oplog: false                                                                                                      // 250
				});                                                                                                                // 246
			}                                                                                                                   // 252
                                                                                                                       //
			record._id = result;                                                                                                // 254
			return result;                                                                                                      // 256
		}                                                                                                                    // 257
                                                                                                                       //
		return insert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.update = function () {                                                                         //
		function update(query, _update) {                                                                                    //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 259
			this.setUpdatedAt(_update, true, query);                                                                            // 260
			var strategy = this.defineSyncStrategy(query, _update, options);                                                    // 262
			var ids = [];                                                                                                       // 263
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0 && strategy === 'db') {                                     // 264
				var findOptions = {                                                                                                // 265
					fields: {                                                                                                         // 265
						_id: 1                                                                                                           // 265
					}                                                                                                                 // 265
				};                                                                                                                 // 265
				var records = options.multi ? this.find(query, findOptions).fetch() : this.findOne(query, findOptions) || [];      // 266
                                                                                                                       //
				if (!Array.isArray(records)) {                                                                                     // 267
					records = [records];                                                                                              // 268
				}                                                                                                                  // 269
                                                                                                                       //
				ids = records.map(function (item) {                                                                                // 271
					return item._id;                                                                                                  // 271
				});                                                                                                                // 271
                                                                                                                       //
				if (options.upsert !== true && this.updateHasPositionalOperator(_update) === false) {                              // 272
					query = {                                                                                                         // 273
						_id: {                                                                                                           // 274
							$in: ids                                                                                                        // 275
						}                                                                                                                // 274
					};                                                                                                                // 273
				}                                                                                                                  // 278
			}                                                                                                                   // 279
                                                                                                                       //
			var result = this.originals.update(query, _update, options);                                                        // 281
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0) {                                                          // 283
				if (strategy === 'db') {                                                                                           // 284
					if (options.upsert === true) {                                                                                    // 285
						if (result.insertedId) {                                                                                         // 286
							this.emit('change', {                                                                                           // 287
								action: 'insert',                                                                                              // 288
								id: result.insertedId,                                                                                         // 289
								data: this.findOne({                                                                                           // 290
									_id: result.insertedId                                                                                        // 290
								}),                                                                                                            // 290
								oplog: false                                                                                                   // 291
							});                                                                                                             // 287
							return;                                                                                                         // 293
						}                                                                                                                // 294
                                                                                                                       //
						query = {                                                                                                        // 296
							_id: {                                                                                                          // 297
								$in: ids                                                                                                       // 298
							}                                                                                                               // 297
						};                                                                                                               // 296
					}                                                                                                                 // 301
                                                                                                                       //
					var _records = options.multi ? this.find(query).fetch() : this.findOne(query) || [];                              // 303
                                                                                                                       //
					if (!Array.isArray(_records)) {                                                                                   // 304
						_records = [_records];                                                                                           // 305
					}                                                                                                                 // 306
                                                                                                                       //
					for (var _iterator = _records, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
						var _ref;                                                                                                        // 307
                                                                                                                       //
						if (_isArray) {                                                                                                  // 307
							if (_i >= _iterator.length) break;                                                                              // 307
							_ref = _iterator[_i++];                                                                                         // 307
						} else {                                                                                                         // 307
							_i = _iterator.next();                                                                                          // 307
							if (_i.done) break;                                                                                             // 307
							_ref = _i.value;                                                                                                // 307
						}                                                                                                                // 307
                                                                                                                       //
						var record = _ref;                                                                                               // 307
						this.emit('change', {                                                                                            // 308
							action: 'update:record',                                                                                        // 309
							id: record._id,                                                                                                 // 310
							data: record,                                                                                                   // 311
							oplog: false                                                                                                    // 312
						});                                                                                                              // 308
					}                                                                                                                 // 314
				} else {                                                                                                           // 315
					this.emit('change', {                                                                                             // 316
						action: 'update:query',                                                                                          // 317
						id: undefined,                                                                                                   // 318
						data: {                                                                                                          // 319
							query: query,                                                                                                   // 320
							update: _update,                                                                                                // 321
							options: options                                                                                                // 322
						},                                                                                                               // 319
						oplog: false                                                                                                     // 324
					});                                                                                                               // 316
				}                                                                                                                  // 326
			}                                                                                                                   // 327
                                                                                                                       //
			return result;                                                                                                      // 328
		}                                                                                                                    // 329
                                                                                                                       //
		return update;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.upsert = function () {                                                                         //
		function upsert(query, update) {                                                                                     //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 331
			options.upsert = true;                                                                                              // 332
			options._returnObject = true;                                                                                       // 333
			return this.update(query, update, options);                                                                         // 334
		}                                                                                                                    // 335
                                                                                                                       //
		return upsert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.remove = function () {                                                                         //
		function remove(query) {                                                                                             //
			var records = this.model.find(query).fetch();                                                                       // 338
			var ids = [];                                                                                                       // 340
                                                                                                                       //
			for (var _iterator2 = records, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
				var _ref2;                                                                                                         // 341
                                                                                                                       //
				if (_isArray2) {                                                                                                   // 341
					if (_i2 >= _iterator2.length) break;                                                                              // 341
					_ref2 = _iterator2[_i2++];                                                                                        // 341
				} else {                                                                                                           // 341
					_i2 = _iterator2.next();                                                                                          // 341
					if (_i2.done) break;                                                                                              // 341
					_ref2 = _i2.value;                                                                                                // 341
				}                                                                                                                  // 341
                                                                                                                       //
				var record = _ref2;                                                                                                // 341
				ids.push(record._id);                                                                                              // 342
				record._deletedAt = new Date();                                                                                    // 344
				record.__collection__ = this.name;                                                                                 // 345
				trash.upsert({                                                                                                     // 347
					_id: record._id                                                                                                   // 347
				}, _.omit(record, '_id'));                                                                                         // 347
			}                                                                                                                   // 348
                                                                                                                       //
			query = {                                                                                                           // 350
				_id: {                                                                                                             // 350
					$in: ids                                                                                                          // 350
				}                                                                                                                  // 350
			};                                                                                                                  // 350
			var result = this.originals.remove(query);                                                                          // 352
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0) {                                                          // 354
				for (var _iterator3 = records, _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[Symbol.iterator]();;) {
					var _ref3;                                                                                                        // 355
                                                                                                                       //
					if (_isArray3) {                                                                                                  // 355
						if (_i3 >= _iterator3.length) break;                                                                             // 355
						_ref3 = _iterator3[_i3++];                                                                                       // 355
					} else {                                                                                                          // 355
						_i3 = _iterator3.next();                                                                                         // 355
						if (_i3.done) break;                                                                                             // 355
						_ref3 = _i3.value;                                                                                               // 355
					}                                                                                                                 // 355
                                                                                                                       //
					var _record = _ref3;                                                                                              // 355
					this.emit('change', {                                                                                             // 356
						action: 'remove',                                                                                                // 357
						id: _record._id,                                                                                                 // 358
						data: _.extend({}, _record),                                                                                     // 359
						oplog: false                                                                                                     // 360
					});                                                                                                               // 356
				}                                                                                                                  // 362
			}                                                                                                                   // 363
                                                                                                                       //
			return result;                                                                                                      // 365
		}                                                                                                                    // 366
                                                                                                                       //
		return remove;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.insertOrUpsert = function () {                                                                 //
		function insertOrUpsert() {                                                                                          //
			for (var _len = arguments.length, args = Array(_len), _key2 = 0; _key2 < _len; _key2++) {                           // 368
				args[_key2] = arguments[_key2];                                                                                    // 368
			}                                                                                                                   // 368
                                                                                                                       //
			if (args[0] && args[0]._id) {                                                                                       // 369
				var _id = args[0]._id;                                                                                             // 370
				delete args[0]._id;                                                                                                // 371
				args.unshift({                                                                                                     // 372
					_id: _id                                                                                                          // 373
				});                                                                                                                // 372
				this.upsert.apply(this, args);                                                                                     // 376
				return _id;                                                                                                        // 377
			} else {                                                                                                            // 378
				return this.insert.apply(this, args);                                                                              // 379
			}                                                                                                                   // 380
		}                                                                                                                    // 381
                                                                                                                       //
		return insertOrUpsert;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.allow = function () {                                                                          //
		function allow() {                                                                                                   //
			var _model3;                                                                                                        // 383
                                                                                                                       //
			return (_model3 = this.model).allow.apply(_model3, arguments);                                                      // 384
		}                                                                                                                    // 385
                                                                                                                       //
		return allow;                                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.deny = function () {                                                                           //
		function deny() {                                                                                                    //
			var _model4;                                                                                                        // 387
                                                                                                                       //
			return (_model4 = this.model).deny.apply(_model4, arguments);                                                       // 388
		}                                                                                                                    // 389
                                                                                                                       //
		return deny;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.ensureIndex = function () {                                                                    //
		function ensureIndex() {                                                                                             //
			var _model5;                                                                                                        // 391
                                                                                                                       //
			return (_model5 = this.model)._ensureIndex.apply(_model5, arguments);                                               // 392
		}                                                                                                                    // 393
                                                                                                                       //
		return ensureIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.dropIndex = function () {                                                                      //
		function dropIndex() {                                                                                               //
			var _model6;                                                                                                        // 395
                                                                                                                       //
			return (_model6 = this.model)._dropIndex.apply(_model6, arguments);                                                 // 396
		}                                                                                                                    // 397
                                                                                                                       //
		return dropIndex;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.tryEnsureIndex = function () {                                                                 //
		function tryEnsureIndex() {                                                                                          //
			try {                                                                                                               // 400
				return this.ensureIndex.apply(this, arguments);                                                                    // 401
			} catch (e) {                                                                                                       // 402
				var _console;                                                                                                      // 402
                                                                                                                       //
				(_console = console).error.apply(_console, ['Error creating index:', this.name, '->'].concat(Array.prototype.slice.call(arguments), [e]));
			}                                                                                                                   // 404
		}                                                                                                                    // 405
                                                                                                                       //
		return tryEnsureIndex;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.tryDropIndex = function () {                                                                   //
		function tryDropIndex() {                                                                                            //
			try {                                                                                                               // 408
				return this.dropIndex.apply(this, arguments);                                                                      // 409
			} catch (e) {                                                                                                       // 410
				var _console2;                                                                                                     // 410
                                                                                                                       //
				(_console2 = console).error.apply(_console2, ['Error dropping index:', this.name, '->'].concat(Array.prototype.slice.call(arguments), [e]));
			}                                                                                                                   // 412
		}                                                                                                                    // 413
                                                                                                                       //
		return tryDropIndex;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.trashFind = function () {                                                                      //
		function trashFind(query, options) {                                                                                 //
			query.__collection__ = this.name;                                                                                   // 416
			return trash.find(query, options);                                                                                  // 418
		}                                                                                                                    // 419
                                                                                                                       //
		return trashFind;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.trashFindDeletedAfter = function () {                                                          //
		function trashFindDeletedAfter(deletedAt) {                                                                          //
			var query = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                                 // 421
			var options = arguments[2];                                                                                         // 421
			query.__collection__ = this.name;                                                                                   // 422
			query._deletedAt = {                                                                                                // 423
				$gt: deletedAt                                                                                                     // 424
			};                                                                                                                  // 423
			return trash.find(query, options);                                                                                  // 427
		}                                                                                                                    // 428
                                                                                                                       //
		return trashFindDeletedAfter;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	(0, _createClass3.default)(ModelsBaseDb, [{                                                                           //
		key: "baseName",                                                                                                     //
		get: function () {                                                                                                   //
			return baseName;                                                                                                    // 56
		}                                                                                                                    // 57
	}]);                                                                                                                  //
	return ModelsBaseDb;                                                                                                  //
}(EventEmitter);                                                                                                       //
                                                                                                                       //
module.export("default", exports.default = ModelsBaseDb);                                                              // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}]},"startup":{"statsTracker.js":["babel-runtime/helpers/classCallCheck",function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/statsTracker.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.statsTracker = new (function () {                                                                           // 1
	function StatsTracker() {                                                                                             // 2
		(0, _classCallCheck3.default)(this, StatsTracker);                                                                   // 2
		this.StatsD = Npm.require('node-dogstatsd').StatsD;                                                                  // 3
		this.dogstatsd = new this.StatsD();                                                                                  // 4
	}                                                                                                                     // 5
                                                                                                                       //
	StatsTracker.prototype.track = function () {                                                                          // 1
		function track(type, stats) {                                                                                        // 1
			var _dogstatsd;                                                                                                     // 7
                                                                                                                       //
			for (var _len = arguments.length, args = Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {           // 7
				args[_key - 2] = arguments[_key];                                                                                  // 7
			}                                                                                                                   // 7
                                                                                                                       //
			(_dogstatsd = this.dogstatsd)[type].apply(_dogstatsd, ["RocketChat." + stats].concat(args));                        // 8
		}                                                                                                                    // 9
                                                                                                                       //
		return track;                                                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.now = function () {                                                                            // 1
		function now() {                                                                                                     // 1
			var hrtime = process.hrtime();                                                                                      // 12
			return hrtime[0] * 1000000 + hrtime[1] / 1000;                                                                      // 13
		}                                                                                                                    // 14
                                                                                                                       //
		return now;                                                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.timing = function () {                                                                         // 1
		function timing(stats, time, tags) {                                                                                 // 1
			this.track('timing', stats, time, tags);                                                                            // 17
		}                                                                                                                    // 18
                                                                                                                       //
		return timing;                                                                                                       // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.increment = function () {                                                                      // 1
		function increment(stats, time, tags) {                                                                              // 1
			this.track('increment', stats, time, tags);                                                                         // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return increment;                                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.decrement = function () {                                                                      // 1
		function decrement(stats, time, tags) {                                                                              // 1
			this.track('decrement', stats, time, tags);                                                                         // 25
		}                                                                                                                    // 26
                                                                                                                       //
		return decrement;                                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.histogram = function () {                                                                      // 1
		function histogram(stats, time, tags) {                                                                              // 1
			this.track('histogram', stats, time, tags);                                                                         // 29
		}                                                                                                                    // 30
                                                                                                                       //
		return histogram;                                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.gauge = function () {                                                                          // 1
		function gauge(stats, time, tags) {                                                                                  // 1
			this.track('gauge', stats, time, tags);                                                                             // 33
		}                                                                                                                    // 34
                                                                                                                       //
		return gauge;                                                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.unique = function () {                                                                         // 1
		function unique(stats, time, tags) {                                                                                 // 1
			this.track('unique', stats, time, tags);                                                                            // 37
		}                                                                                                                    // 38
                                                                                                                       //
		return unique;                                                                                                       // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.set = function () {                                                                            // 1
		function set(stats, time, tags) {                                                                                    // 1
			this.track('set', stats, time, tags);                                                                               // 41
		}                                                                                                                    // 42
                                                                                                                       //
		return set;                                                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	return StatsTracker;                                                                                                  // 1
}())();                                                                                                                // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"cache":{"CacheLoad.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/cache/CacheLoad.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.models.Rooms.cache.hasMany('Subscriptions', {                                                               // 1
	field: 'usernames',                                                                                                   // 2
	link: {                                                                                                               // 3
		local: '_id',                                                                                                        // 4
		remote: 'rid',                                                                                                       // 5
		transform: function (room, subscription) {                                                                           // 6
			return subscription.u.username;                                                                                     // 7
		},                                                                                                                   // 8
		remove: function (arr, subscription) {                                                                               // 9
			if (arr.indexOf(subscription.u.username) > -1) {                                                                    // 10
				arr.splice(arr.indexOf(subscription.u.username), 1);                                                               // 11
			}                                                                                                                   // 12
		}                                                                                                                    // 13
	}                                                                                                                     // 3
});                                                                                                                    // 1
RocketChat.models.Subscriptions.cache.hasOne('Rooms', {                                                                // 18
	field: '_room',                                                                                                       // 19
	link: {                                                                                                               // 20
		local: 'rid',                                                                                                        // 21
		remote: '_id'                                                                                                        // 22
	}                                                                                                                     // 20
});                                                                                                                    // 18
RocketChat.models.Subscriptions.cache.hasOne('Users', {                                                                // 27
	field: '_user',                                                                                                       // 28
	link: {                                                                                                               // 29
		local: 'u._id',                                                                                                      // 30
		remote: '_id'                                                                                                        // 31
	}                                                                                                                     // 29
});                                                                                                                    // 27
RocketChat.models.Users.cache.load();                                                                                  // 36
RocketChat.models.Rooms.cache.load();                                                                                  // 37
RocketChat.models.Subscriptions.cache.load();                                                                          // 38
RocketChat.models.Settings.cache.load();                                                                               // 39
RocketChat.models.Users.cache.addDynamicView('highlights').applyFind({                                                 // 42
	'settings.preferences.highlights': {                                                                                  // 43
		$size: {                                                                                                             // 43
			$gt: 0                                                                                                              // 43
		}                                                                                                                    // 43
	}                                                                                                                     // 43
});                                                                                                                    // 42
RocketChat.models.Subscriptions.cache.addDynamicView('notifications').applyFind({                                      // 46
	$or: [{                                                                                                               // 47
		desktopNotifications: {                                                                                              // 48
			$in: ['all', 'nothing']                                                                                             // 48
		}                                                                                                                    // 48
	}, {                                                                                                                  // 48
		mobilePushNotifications: {                                                                                           // 49
			$in: ['all', 'nothing']                                                                                             // 49
		}                                                                                                                    // 49
	}]                                                                                                                    // 49
});                                                                                                                    // 46
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"settingsOnLoadCdnPrefix.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/settingsOnLoadCdnPrefix.coffee.js                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.settings.onload('CDN_PREFIX', function (key, value, initialLoad) {                                          //
  if (_.isString(value)) {                                                                                             //
    if (!!value) {                                                                                                     //
      return typeof WebAppInternals !== "undefined" && WebAppInternals !== null ? WebAppInternals.setBundledJsCssPrefix(value) : void 0;
    }                                                                                                                  //
  }                                                                                                                    //
});                                                                                                                    //
Meteor.startup(function () {                                                                                           //
  var value;                                                                                                           //
  value = RocketChat.settings.get('CDN_PREFIX');                                                                       //
                                                                                                                       //
  if (_.isString(value)) {                                                                                             //
    if (!!value) {                                                                                                     //
      return typeof WebAppInternals !== "undefined" && WebAppInternals !== null ? WebAppInternals.setBundledJsCssPrefix(value) : void 0;
    }                                                                                                                  //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settingsOnLoadSMTP.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/settingsOnLoadSMTP.coffee.js                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var buildMailURL;                                                                                                      //
buildMailURL = _.debounce(function () {                                                                                //
  console.log('Updating process.env.MAIL_URL');                                                                        //
                                                                                                                       //
  if (RocketChat.settings.get('SMTP_Host')) {                                                                          //
    process.env.MAIL_URL = "smtp://";                                                                                  //
                                                                                                                       //
    if (RocketChat.settings.get('SMTP_Username') && RocketChat.settings.get('SMTP_Password')) {                        //
      process.env.MAIL_URL += encodeURIComponent(RocketChat.settings.get('SMTP_Username')) + ':' + encodeURIComponent(RocketChat.settings.get('SMTP_Password')) + '@';
    }                                                                                                                  //
                                                                                                                       //
    process.env.MAIL_URL += encodeURIComponent(RocketChat.settings.get('SMTP_Host'));                                  //
                                                                                                                       //
    if (RocketChat.settings.get('SMTP_Port')) {                                                                        //
      return process.env.MAIL_URL += ':' + parseInt(RocketChat.settings.get('SMTP_Port'));                             //
    }                                                                                                                  //
  }                                                                                                                    //
}, 500);                                                                                                               //
RocketChat.settings.onload('SMTP_Host', function (key, value, initialLoad) {                                           //
  if (_.isString(value)) {                                                                                             //
    return buildMailURL();                                                                                             //
  }                                                                                                                    //
});                                                                                                                    //
RocketChat.settings.onload('SMTP_Port', function (key, value, initialLoad) {                                           //
  return buildMailURL();                                                                                               //
});                                                                                                                    //
RocketChat.settings.onload('SMTP_Username', function (key, value, initialLoad) {                                       //
  if (_.isString(value)) {                                                                                             //
    return buildMailURL();                                                                                             //
  }                                                                                                                    //
});                                                                                                                    //
RocketChat.settings.onload('SMTP_Password', function (key, value, initialLoad) {                                       //
  if (_.isString(value)) {                                                                                             //
    return buildMailURL();                                                                                             //
  }                                                                                                                    //
});                                                                                                                    //
Meteor.startup(function () {                                                                                           //
  return buildMailURL();                                                                                               //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"oAuthServicesUpdate.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/oAuthServicesUpdate.coffee.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var OAuthServicesRemove, OAuthServicesUpdate, logger, timer;                                                           //
logger = new Logger('rocketchat:lib', {                                                                                //
  methods: {                                                                                                           //
    oauth_updated: {                                                                                                   //
      type: 'info'                                                                                                     //
    }                                                                                                                  //
  }                                                                                                                    //
});                                                                                                                    //
timer = void 0;                                                                                                        //
                                                                                                                       //
OAuthServicesUpdate = function () {                                                                                    //
  if (timer != null) {                                                                                                 //
    Meteor.clearTimeout(timer);                                                                                        //
  }                                                                                                                    //
                                                                                                                       //
  return timer = Meteor.setTimeout(function () {                                                                       //
    var data, i, len, results, service, serviceName, services;                                                         //
    services = RocketChat.settings.get(/^(Accounts_OAuth_|Accounts_OAuth_Custom-)[a-z0-9_]+$/i);                       //
    results = [];                                                                                                      //
                                                                                                                       //
    for (i = 0, len = services.length; i < len; i++) {                                                                 //
      service = services[i];                                                                                           //
      logger.oauth_updated(service.key);                                                                               //
      serviceName = service.key.replace('Accounts_OAuth_', '');                                                        //
                                                                                                                       //
      if (serviceName === 'Meteor') {                                                                                  //
        serviceName = 'meteor-developer';                                                                              //
      }                                                                                                                //
                                                                                                                       //
      if (/Accounts_OAuth_Custom-/.test(service.key)) {                                                                //
        serviceName = service.key.replace('Accounts_OAuth_Custom-', '');                                               //
      }                                                                                                                //
                                                                                                                       //
      if (service.value === true) {                                                                                    //
        data = {                                                                                                       //
          clientId: RocketChat.settings.get(service.key + "_id"),                                                      //
          secret: RocketChat.settings.get(service.key + "_secret")                                                     //
        };                                                                                                             //
                                                                                                                       //
        if (/Accounts_OAuth_Custom-/.test(service.key)) {                                                              //
          data.custom = true;                                                                                          //
          data.clientId = RocketChat.settings.get(service.key + "-id");                                                //
          data.secret = RocketChat.settings.get(service.key + "-secret");                                              //
          data.serverURL = RocketChat.settings.get(service.key + "-url");                                              //
          data.tokenPath = RocketChat.settings.get(service.key + "-token_path");                                       //
          data.identityPath = RocketChat.settings.get(service.key + "-identity_path");                                 //
          data.authorizePath = RocketChat.settings.get(service.key + "-authorize_path");                               //
          data.scope = RocketChat.settings.get(service.key + "-scope");                                                //
          data.buttonLabelText = RocketChat.settings.get(service.key + "-button_label_text");                          //
          data.buttonLabelColor = RocketChat.settings.get(service.key + "-button_label_color");                        //
          data.loginStyle = RocketChat.settings.get(service.key + "-login_style");                                     //
          data.buttonColor = RocketChat.settings.get(service.key + "-button_color");                                   //
          data.tokenSentVia = RocketChat.settings.get(service.key + "-token_sent_via");                                //
          data.usernameField = RocketChat.settings.get(service.key + "-username_field");                               //
          data.mergeUsers = RocketChat.settings.get(service.key + "-merge_users");                                     //
          new CustomOAuth(serviceName.toLowerCase(), {                                                                 //
            serverURL: data.serverURL,                                                                                 //
            tokenPath: data.tokenPath,                                                                                 //
            identityPath: data.identityPath,                                                                           //
            authorizePath: data.authorizePath,                                                                         //
            scope: data.scope,                                                                                         //
            loginStyle: data.loginStyle,                                                                               //
            tokenSentVia: data.tokenSentVia,                                                                           //
            usernameField: data.usernameField,                                                                         //
            mergeUsers: data.mergeUsers                                                                                //
          });                                                                                                          //
        }                                                                                                              //
                                                                                                                       //
        if (serviceName === 'Facebook') {                                                                              //
          data.appId = data.clientId;                                                                                  //
          delete data.clientId;                                                                                        //
        }                                                                                                              //
                                                                                                                       //
        if (serviceName === 'Twitter') {                                                                               //
          data.consumerKey = data.clientId;                                                                            //
          delete data.clientId;                                                                                        //
        }                                                                                                              //
                                                                                                                       //
        results.push(ServiceConfiguration.configurations.upsert({                                                      //
          service: serviceName.toLowerCase()                                                                           //
        }, {                                                                                                           //
          $set: data                                                                                                   //
        }));                                                                                                           //
      } else {                                                                                                         //
        results.push(ServiceConfiguration.configurations.remove({                                                      //
          service: serviceName.toLowerCase()                                                                           //
        }));                                                                                                           //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    return results;                                                                                                    //
  }, 2000);                                                                                                            //
};                                                                                                                     //
                                                                                                                       //
OAuthServicesRemove = function (_id) {                                                                                 //
  var serviceName;                                                                                                     //
  serviceName = _id.replace('Accounts_OAuth_Custom-', '');                                                             //
  return ServiceConfiguration.configurations.remove({                                                                  //
    service: serviceName.toLowerCase()                                                                                 //
  });                                                                                                                  //
};                                                                                                                     //
                                                                                                                       //
RocketChat.settings.get(/^Accounts_OAuth_.+/, function (key, value) {                                                  //
  return OAuthServicesUpdate();                                                                                        //
});                                                                                                                    //
RocketChat.settings.get(/^Accounts_OAuth_Custom-[a-z0-9_]+/, function (key, value) {                                   //
  if (!value) {                                                                                                        //
    return OAuthServicesRemove(key);                                                                                   //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settings.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/settings.coffee.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
RocketChat.settings.add('uniqueID', process.env.DEPLOYMENT_ID || Random.id(), {                                        //
  "public": true,                                                                                                      //
  hidden: true                                                                                                         //
});                                                                                                                    //
RocketChat.settings.addGroup('Accounts', function () {                                                                 //
  this.add('Accounts_AllowDeleteOwnAccount', false, {                                                                  //
    type: 'boolean',                                                                                                   //
    "public": true,                                                                                                    //
    enableQuery: {                                                                                                     //
      _id: 'Accounts_AllowUserProfileChange',                                                                          //
      value: true                                                                                                      //
    }                                                                                                                  //
  });                                                                                                                  //
  this.add('Accounts_AllowUserProfileChange', true, {                                                                  //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Accounts_AllowUserAvatarChange', true, {                                                                   //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Accounts_AllowUsernameChange', true, {                                                                     //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Accounts_AllowEmailChange', true, {                                                                        //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Accounts_AllowPasswordChange', true, {                                                                     //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Accounts_LoginExpiration', 90, {                                                                           //
    type: 'int',                                                                                                       //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Accounts_ShowFormLogin', true, {                                                                           //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Accounts_EmailOrUsernamePlaceholder', '', {                                                                //
    type: 'string',                                                                                                    //
    "public": true,                                                                                                    //
    i18nLabel: 'Placeholder_for_email_or_username_login_field'                                                         //
  });                                                                                                                  //
  this.add('Accounts_PasswordPlaceholder', '', {                                                                       //
    type: 'string',                                                                                                    //
    "public": true,                                                                                                    //
    i18nLabel: 'Placeholder_for_password_login_field'                                                                  //
  });                                                                                                                  //
  this.add('Accounts_ForgetUserSessionOnWindowClose', false, {                                                         //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.section('Registration', function () {                                                                           //
    this.add('Accounts_RequireNameForSignUp', true, {                                                                  //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_RequirePasswordConfirmation', true, {                                                           //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_EmailVerification', false, {                                                                    //
      type: 'boolean',                                                                                                 //
      "public": true,                                                                                                  //
      enableQuery: {                                                                                                   //
        _id: 'SMTP_Host',                                                                                              //
        value: {                                                                                                       //
          $exists: 1,                                                                                                  //
          $ne: ""                                                                                                      //
        }                                                                                                              //
      }                                                                                                                //
    });                                                                                                                //
    this.add('Accounts_ManuallyApproveNewUsers', false, {                                                              //
      type: 'boolean'                                                                                                  //
    });                                                                                                                //
    this.add('Accounts_AllowedDomainsList', '', {                                                                      //
      type: 'string',                                                                                                  //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_BlockedDomainsList', '', {                                                                      //
      type: 'string'                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_BlockedUsernameList', '', {                                                                     //
      type: 'string'                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_UseDefaultBlockedDomainsList', true, {                                                          //
      type: 'boolean'                                                                                                  //
    });                                                                                                                //
    this.add('Accounts_UseDNSDomainCheck', false, {                                                                    //
      type: 'boolean'                                                                                                  //
    });                                                                                                                //
    this.add('Accounts_RegistrationForm', 'Public', {                                                                  //
      type: 'select',                                                                                                  //
      "public": true,                                                                                                  //
      values: [{                                                                                                       //
        key: 'Public',                                                                                                 //
        i18nLabel: 'Accounts_RegistrationForm_Public'                                                                  //
      }, {                                                                                                             //
        key: 'Disabled',                                                                                               //
        i18nLabel: 'Accounts_RegistrationForm_Disabled'                                                                //
      }, {                                                                                                             //
        key: 'Secret URL',                                                                                             //
        i18nLabel: 'Accounts_RegistrationForm_Secret_URL'                                                              //
      }]                                                                                                               //
    });                                                                                                                //
    this.add('Accounts_RegistrationForm_SecretURL', Random.id(), {                                                     //
      type: 'string'                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_RegistrationForm_LinkReplacementText', 'New user registration is currently disabled', {         //
      type: 'string',                                                                                                  //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_Registration_AuthenticationServices_Enabled', true, {                                           //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_Registration_AuthenticationServices_Default_Roles', 'user', {                                   //
      type: 'string',                                                                                                  //
      enableQuery: {                                                                                                   //
        _id: 'Accounts_Registration_AuthenticationServices_Enabled',                                                   //
        value: true                                                                                                    //
      }                                                                                                                //
    });                                                                                                                //
    this.add('Accounts_PasswordReset', true, {                                                                         //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    return this.add('Accounts_CustomFields', '', {                                                                     //
      type: 'code',                                                                                                    //
      "public": true,                                                                                                  //
      i18nLabel: 'Custom_Fields'                                                                                       //
    });                                                                                                                //
  });                                                                                                                  //
  return this.section('Avatar', function () {                                                                          //
    this.add('Accounts_AvatarResize', true, {                                                                          //
      type: 'boolean'                                                                                                  //
    });                                                                                                                //
    this.add('Accounts_AvatarSize', 200, {                                                                             //
      type: 'int',                                                                                                     //
      enableQuery: {                                                                                                   //
        _id: 'Accounts_AvatarResize',                                                                                  //
        value: true                                                                                                    //
      }                                                                                                                //
    });                                                                                                                //
    this.add('Accounts_AvatarStoreType', 'GridFS', {                                                                   //
      type: 'select',                                                                                                  //
      values: [{                                                                                                       //
        key: 'GridFS',                                                                                                 //
        i18nLabel: 'GridFS'                                                                                            //
      }, {                                                                                                             //
        key: 'FileSystem',                                                                                             //
        i18nLabel: 'FileSystem'                                                                                        //
      }]                                                                                                               //
    });                                                                                                                //
    this.add('Accounts_AvatarStorePath', '', {                                                                         //
      type: 'string',                                                                                                  //
      enableQuery: {                                                                                                   //
        _id: 'Accounts_AvatarStoreType',                                                                               //
        value: 'FileSystem'                                                                                            //
      }                                                                                                                //
    });                                                                                                                //
    return this.add('Accounts_SetDefaultAvatar', true, {                                                               //
      type: 'boolean'                                                                                                  //
    });                                                                                                                //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('OAuth', function () {                                                                    //
  this.section('Facebook', function () {                                                                               //
    var enableQuery;                                                                                                   //
    enableQuery = {                                                                                                    //
      _id: 'Accounts_OAuth_Facebook',                                                                                  //
      value: true                                                                                                      //
    };                                                                                                                 //
    this.add('Accounts_OAuth_Facebook', false, {                                                                       //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_OAuth_Facebook_id', '', {                                                                       //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    this.add('Accounts_OAuth_Facebook_secret', '', {                                                                   //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    return this.add('Accounts_OAuth_Facebook_callback_url', '_oauth/facebook', {                                       //
      type: 'relativeUrl',                                                                                             //
      readonly: true,                                                                                                  //
      force: true,                                                                                                     //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Google', function () {                                                                                 //
    var enableQuery;                                                                                                   //
    enableQuery = {                                                                                                    //
      _id: 'Accounts_OAuth_Google',                                                                                    //
      value: true                                                                                                      //
    };                                                                                                                 //
    this.add('Accounts_OAuth_Google', false, {                                                                         //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_OAuth_Google_id', '', {                                                                         //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    this.add('Accounts_OAuth_Google_secret', '', {                                                                     //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    return this.add('Accounts_OAuth_Google_callback_url', '_oauth/google', {                                           //
      type: 'relativeUrl',                                                                                             //
      readonly: true,                                                                                                  //
      force: true,                                                                                                     //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('GitHub', function () {                                                                                 //
    var enableQuery;                                                                                                   //
    enableQuery = {                                                                                                    //
      _id: 'Accounts_OAuth_Github',                                                                                    //
      value: true                                                                                                      //
    };                                                                                                                 //
    this.add('Accounts_OAuth_Github', false, {                                                                         //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_OAuth_Github_id', '', {                                                                         //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    this.add('Accounts_OAuth_Github_secret', '', {                                                                     //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    return this.add('Accounts_OAuth_Github_callback_url', '_oauth/github', {                                           //
      type: 'relativeUrl',                                                                                             //
      readonly: true,                                                                                                  //
      force: true,                                                                                                     //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Linkedin', function () {                                                                               //
    var enableQuery;                                                                                                   //
    enableQuery = {                                                                                                    //
      _id: 'Accounts_OAuth_Linkedin',                                                                                  //
      value: true                                                                                                      //
    };                                                                                                                 //
    this.add('Accounts_OAuth_Linkedin', false, {                                                                       //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_OAuth_Linkedin_id', '', {                                                                       //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    this.add('Accounts_OAuth_Linkedin_secret', '', {                                                                   //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    return this.add('Accounts_OAuth_Linkedin_callback_url', '_oauth/linkedin', {                                       //
      type: 'relativeUrl',                                                                                             //
      readonly: true,                                                                                                  //
      force: true,                                                                                                     //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Meteor', function () {                                                                                 //
    var enableQuery;                                                                                                   //
    enableQuery = {                                                                                                    //
      _id: 'Accounts_OAuth_Meteor',                                                                                    //
      value: true                                                                                                      //
    };                                                                                                                 //
    this.add('Accounts_OAuth_Meteor', false, {                                                                         //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_OAuth_Meteor_id', '', {                                                                         //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    this.add('Accounts_OAuth_Meteor_secret', '', {                                                                     //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    return this.add('Accounts_OAuth_Meteor_callback_url', '_oauth/meteor', {                                           //
      type: 'relativeUrl',                                                                                             //
      readonly: true,                                                                                                  //
      force: true,                                                                                                     //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
  });                                                                                                                  //
  return this.section('Twitter', function () {                                                                         //
    var enableQuery;                                                                                                   //
    enableQuery = {                                                                                                    //
      _id: 'Accounts_OAuth_Twitter',                                                                                   //
      value: true                                                                                                      //
    };                                                                                                                 //
    this.add('Accounts_OAuth_Twitter', false, {                                                                        //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Accounts_OAuth_Twitter_id', '', {                                                                        //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    this.add('Accounts_OAuth_Twitter_secret', '', {                                                                    //
      type: 'string',                                                                                                  //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
    return this.add('Accounts_OAuth_Twitter_callback_url', '_oauth/twitter', {                                         //
      type: 'relativeUrl',                                                                                             //
      readonly: true,                                                                                                  //
      force: true,                                                                                                     //
      enableQuery: enableQuery                                                                                         //
    });                                                                                                                //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('General', function () {                                                                  //
  this.add('Site_Url', typeof __meteor_runtime_config__ !== "undefined" && __meteor_runtime_config__ !== null ? __meteor_runtime_config__.ROOT_URL : void 0, {
    type: 'string',                                                                                                    //
    i18nDescription: 'Site_Url_Description',                                                                           //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Site_Name', 'Rocket.Chat', {                                                                               //
    type: 'string',                                                                                                    //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Language', '', {                                                                                           //
    type: 'language',                                                                                                  //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Allow_Invalid_SelfSigned_Certs', false, {                                                                  //
    type: 'boolean'                                                                                                    //
  });                                                                                                                  //
  this.add('Favorite_Rooms', true, {                                                                                   //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('CDN_PREFIX', '', {                                                                                         //
    type: 'string',                                                                                                    //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Force_SSL', false, {                                                                                       //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('GoogleTagManager_id', '', {                                                                                //
    type: 'string',                                                                                                    //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Bugsnag_api_key', '', {                                                                                    //
    type: 'string',                                                                                                    //
    "public": false                                                                                                    //
  });                                                                                                                  //
  this.add('Force_Disable_OpLog_For_Cache', false, {                                                                   //
    type: 'boolean',                                                                                                   //
    "public": false                                                                                                    //
  });                                                                                                                  //
  this.add('Restart', 'restart_server', {                                                                              //
    type: 'action',                                                                                                    //
    actionText: 'Restart_the_server'                                                                                   //
  });                                                                                                                  //
  this.section('UTF8', function () {                                                                                   //
    this.add('UTF8_Names_Validation', '[0-9a-zA-Z-_.]+', {                                                             //
      type: 'string',                                                                                                  //
      "public": true,                                                                                                  //
      i18nDescription: 'UTF8_Names_Validation_Description'                                                             //
    });                                                                                                                //
    return this.add('UTF8_Names_Slugify', true, {                                                                      //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Reporting', function () {                                                                              //
    return this.add('Statistics_reporting', true, {                                                                    //
      type: 'boolean'                                                                                                  //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Notifications', function () {                                                                          //
    return this.add('Desktop_Notifications_Duration', 0, {                                                             //
      type: 'int',                                                                                                     //
      "public": true,                                                                                                  //
      i18nDescription: 'Desktop_Notification_Durations_Description'                                                    //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('REST API', function () {                                                                               //
    return this.add('API_User_Limit', 500, {                                                                           //
      type: 'int',                                                                                                     //
      "public": true,                                                                                                  //
      i18nDescription: 'API_User_Limit'                                                                                //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Iframe_Integration', function () {                                                                     //
    this.add('Iframe_Integration_send_enable', false, {                                                                //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Iframe_Integration_send_target_origin', '*', {                                                           //
      type: 'string',                                                                                                  //
      "public": true,                                                                                                  //
      enableQuery: {                                                                                                   //
        _id: 'Iframe_Integration_send_enable',                                                                         //
        value: true                                                                                                    //
      }                                                                                                                //
    });                                                                                                                //
    this.add('Iframe_Integration_receive_enable', false, {                                                             //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    return this.add('Iframe_Integration_receive_origin', '*', {                                                        //
      type: 'string',                                                                                                  //
      "public": true,                                                                                                  //
      enableQuery: {                                                                                                   //
        _id: 'Iframe_Integration_receive_enable',                                                                      //
        value: true                                                                                                    //
      }                                                                                                                //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Translations', function () {                                                                           //
    return this.add('Custom_Translations', '', {                                                                       //
      type: 'code',                                                                                                    //
      "public": true                                                                                                   //
    });                                                                                                                //
  });                                                                                                                  //
  return this.section('Stream_Cast', function () {                                                                     //
    return this.add('Stream_Cast_Address', '', {                                                                       //
      type: 'string'                                                                                                   //
    });                                                                                                                //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('Email', function () {                                                                    //
  this.section('Header_and_Footer', function () {                                                                      //
    this.add('Email_Header', '<table border="0" cellspacing="0" cellpadding="0" width="100%" bgcolor="#f3f3f3" style="color:#4a4a4a;font-family: Helvetica,Arial,sans-serif;font-size:14px;line-height:20px;border-collapse:callapse;border-spacing:0;margin:0 auto"><tr><td style="padding:1em"><table border="0" cellspacing="0" cellpadding="0" align="center" width="100%" style="width:100%;margin:0 auto;max-width:800px"><tr><td bgcolor="#ffffff" style="background-color:#ffffff; border: 1px solid #DDD; font-size: 10pt; font-family: Helvetica,Arial,sans-serif;"><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td style="background-color: #04436a;"><h1 style="font-family: Helvetica,Arial,sans-serif; padding: 0 1em; margin: 0; line-height: 70px; color: #FFF;">[Site_Name]</h1></td></tr><tr><td style="padding: 1em; font-size: 10pt; font-family: Helvetica,Arial,sans-serif;">', {
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      i18nLabel: 'Header'                                                                                              //
    });                                                                                                                //
    return this.add('Email_Footer', '</td></tr></table></td></tr><tr><td border="0" cellspacing="0" cellpadding="0" width="100%" style="font-family: Helvetica,Arial,sans-serif; max-width: 800px; margin: 0 auto; padding: 1.5em; text-align: center; font-size: 8pt; color: #999;">Powered by <a href="https://rocket.chat" target="_blank">Rocket.Chat</a></td></tr></table></td></tr></table>', {
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      i18nLabel: 'Footer'                                                                                              //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('SMTP', function () {                                                                                   //
    this.add('SMTP_Host', '', {                                                                                        //
      type: 'string',                                                                                                  //
      env: true,                                                                                                       //
      i18nLabel: 'Host'                                                                                                //
    });                                                                                                                //
    this.add('SMTP_Port', '', {                                                                                        //
      type: 'string',                                                                                                  //
      env: true,                                                                                                       //
      i18nLabel: 'Port'                                                                                                //
    });                                                                                                                //
    this.add('SMTP_Username', '', {                                                                                    //
      type: 'string',                                                                                                  //
      env: true,                                                                                                       //
      i18nLabel: 'Username'                                                                                            //
    });                                                                                                                //
    this.add('SMTP_Password', '', {                                                                                    //
      type: 'password',                                                                                                //
      env: true,                                                                                                       //
      i18nLabel: 'Password'                                                                                            //
    });                                                                                                                //
    this.add('From_Email', '', {                                                                                       //
      type: 'string',                                                                                                  //
      placeholder: 'email@domain'                                                                                      //
    });                                                                                                                //
    return this.add('SMTP_Test_Button', 'sendSMTPTestEmail', {                                                         //
      type: 'action',                                                                                                  //
      actionText: 'Send_a_test_mail_to_my_user'                                                                        //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Invitation', function () {                                                                             //
    this.add('Invitation_Customized', false, {                                                                         //
      type: 'boolean',                                                                                                 //
      i18nLabel: 'Custom'                                                                                              //
    });                                                                                                                //
    this.add('Invitation_Subject', '', {                                                                               //
      type: 'string',                                                                                                  //
      i18nLabel: 'Subject',                                                                                            //
      enableQuery: {                                                                                                   //
        _id: 'Invitation_Customized',                                                                                  //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Invitation_Customized',                                                                                  //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
    return this.add('Invitation_HTML', '', {                                                                           //
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      i18nLabel: 'Body',                                                                                               //
      i18nDescription: 'Invitation_HTML_Description',                                                                  //
      enableQuery: {                                                                                                   //
        _id: 'Invitation_Customized',                                                                                  //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Invitation_Customized',                                                                                  //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Registration', function () {                                                                           //
    this.add('Accounts_Enrollment_Customized', false, {                                                                //
      type: 'boolean',                                                                                                 //
      i18nLabel: 'Custom'                                                                                              //
    });                                                                                                                //
    this.add('Accounts_Enrollment_Email_Subject', '', {                                                                //
      type: 'string',                                                                                                  //
      i18nLabel: 'Subject',                                                                                            //
      enableQuery: {                                                                                                   //
        _id: 'Accounts_Enrollment_Customized',                                                                         //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Accounts_Enrollment_Customized',                                                                         //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
    return this.add('Accounts_Enrollment_Email', '', {                                                                 //
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      i18nLabel: 'Body',                                                                                               //
      enableQuery: {                                                                                                   //
        _id: 'Accounts_Enrollment_Customized',                                                                         //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Accounts_Enrollment_Customized',                                                                         //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Registration_via_Admin', function () {                                                                 //
    this.add('Accounts_UserAddedEmail_Customized', false, {                                                            //
      type: 'boolean',                                                                                                 //
      i18nLabel: 'Custom'                                                                                              //
    });                                                                                                                //
    this.add('Accounts_UserAddedEmailSubject', '', {                                                                   //
      type: 'string',                                                                                                  //
      i18nLabel: "Subject",                                                                                            //
      enableQuery: {                                                                                                   //
        _id: 'Accounts_UserAddedEmail_Customized',                                                                     //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Accounts_UserAddedEmail_Customized',                                                                     //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
    return this.add('Accounts_UserAddedEmail', '', {                                                                   //
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      i18nLabel: 'Body',                                                                                               //
      i18nDescription: 'Accounts_UserAddedEmail_Description',                                                          //
      enableQuery: {                                                                                                   //
        _id: 'Accounts_UserAddedEmail_Customized',                                                                     //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Accounts_UserAddedEmail_Customized',                                                                     //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Forgot_password_section', function () {                                                                //
    this.add('Forgot_Password_Customized', false, {                                                                    //
      type: 'boolean',                                                                                                 //
      i18nLabel: 'Custom'                                                                                              //
    });                                                                                                                //
    this.add('Forgot_Password_Email_Subject', '', {                                                                    //
      type: 'string',                                                                                                  //
      i18nLabel: 'Subject',                                                                                            //
      enableQuery: {                                                                                                   //
        _id: 'Forgot_Password_Customized',                                                                             //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Forgot_Password_Customized',                                                                             //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
    return this.add('Forgot_Password_Email', '', {                                                                     //
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      i18nLabel: 'Body',                                                                                               //
      i18nDescription: 'Forgot_Password_Description',                                                                  //
      enableQuery: {                                                                                                   //
        _id: 'Forgot_Password_Customized',                                                                             //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Forgot_Password_Customized',                                                                             //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
  });                                                                                                                  //
  return this.section('Verification', function () {                                                                    //
    this.add('Verification_Customized', false, {                                                                       //
      type: 'boolean',                                                                                                 //
      i18nLabel: 'Custom'                                                                                              //
    });                                                                                                                //
    this.add('Verification_Email_Subject', '', {                                                                       //
      type: 'string',                                                                                                  //
      i18nLabel: 'Subject',                                                                                            //
      enableQuery: {                                                                                                   //
        _id: 'Verification_Customized',                                                                                //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Verification_Customized',                                                                                //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
    return this.add('Verification_Email', '', {                                                                        //
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      i18nLabel: 'Body',                                                                                               //
      i18nDescription: 'Verification_Description',                                                                     //
      enableQuery: {                                                                                                   //
        _id: 'Verification_Customized',                                                                                //
        value: true                                                                                                    //
      },                                                                                                               //
      i18nDefaultQuery: {                                                                                              //
        _id: 'Verification_Customized',                                                                                //
        value: false                                                                                                   //
      }                                                                                                                //
    });                                                                                                                //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('Message', function () {                                                                  //
  this.add('Message_AllowEditing', true, {                                                                             //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_AllowEditing_BlockEditInMinutes', 0, {                                                             //
    type: 'int',                                                                                                       //
    "public": true,                                                                                                    //
    i18nDescription: 'Message_AllowEditing_BlockEditInMinutesDescription'                                              //
  });                                                                                                                  //
  this.add('Message_AllowDeleting', true, {                                                                            //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_AllowDeleting_BlockDeleteInMinutes', 0, {                                                          //
    type: 'int',                                                                                                       //
    "public": true,                                                                                                    //
    i18nDescription: 'Message_AllowDeleting_BlockDeleteInMinutes'                                                      //
  });                                                                                                                  //
  this.add('Message_AllowUnrecognizedSlashCommand', false, {                                                           //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_AlwaysSearchRegExp', false, {                                                                      //
    type: 'boolean'                                                                                                    //
  });                                                                                                                  //
  this.add('Message_ShowEditedStatus', true, {                                                                         //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_ShowDeletedStatus', false, {                                                                       //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_AllowBadWordsFilter', false, {                                                                     //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_BadWordsFilterList', '', {                                                                         //
    type: 'string',                                                                                                    //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_KeepHistory', false, {                                                                             //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_MaxAll', 0, {                                                                                      //
    type: 'int',                                                                                                       //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_MaxAllowedSize', 5000, {                                                                           //
    type: 'int',                                                                                                       //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_ShowFormattingTips', true, {                                                                       //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_SetNameToAliasEnabled', false, {                                                                   //
    type: 'boolean',                                                                                                   //
    "public": false,                                                                                                   //
    i18nDescription: 'Message_SetNameToAliasEnabled_Description'                                                       //
  });                                                                                                                  //
  this.add('Message_AudioRecorderEnabled', true, {                                                                     //
    type: 'boolean',                                                                                                   //
    "public": true,                                                                                                    //
    i18nDescription: 'Message_AudioRecorderEnabledDescription'                                                         //
  });                                                                                                                  //
  this.add('Message_GroupingPeriod', 300, {                                                                            //
    type: 'int',                                                                                                       //
    "public": true,                                                                                                    //
    i18nDescription: 'Message_GroupingPeriodDescription'                                                               //
  });                                                                                                                  //
  this.add('API_Embed', true, {                                                                                        //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('API_EmbedCacheExpirationDays', 30, {                                                                       //
    type: 'int',                                                                                                       //
    "public": false                                                                                                    //
  });                                                                                                                  //
  this.add('API_Embed_clear_cache_now', 'OEmbedCacheCleanup', {                                                        //
    type: 'action',                                                                                                    //
    actionText: 'clear',                                                                                               //
    i18nLabel: 'clear_cache_now'                                                                                       //
  });                                                                                                                  //
  this.add('API_EmbedDisabledFor', '', {                                                                               //
    type: 'string',                                                                                                    //
    "public": true,                                                                                                    //
    i18nDescription: 'API_EmbedDisabledFor_Description'                                                                //
  });                                                                                                                  //
  this.add('API_EmbedIgnoredHosts', 'localhost, 127.0.0.1, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16', {               //
    type: 'string',                                                                                                    //
    i18nDescription: 'API_EmbedIgnoredHosts_Description'                                                               //
  });                                                                                                                  //
  this.add('API_EmbedSafePorts', '80, 443', {                                                                          //
    type: 'string'                                                                                                     //
  });                                                                                                                  //
  this.add('Message_TimeFormat', 'LT', {                                                                               //
    type: 'string',                                                                                                    //
    "public": true,                                                                                                    //
    i18nDescription: 'Message_TimeFormat_Description'                                                                  //
  });                                                                                                                  //
  this.add('Message_DateFormat', 'LL', {                                                                               //
    type: 'string',                                                                                                    //
    "public": true,                                                                                                    //
    i18nDescription: 'Message_DateFormat_Description'                                                                  //
  });                                                                                                                  //
  this.add('Message_TimeAndDateFormat', 'LLL', {                                                                       //
    type: 'string',                                                                                                    //
    "public": true,                                                                                                    //
    i18nDescription: 'Message_TimeAndDateFormat_Description'                                                           //
  });                                                                                                                  //
  this.add('Message_HideType_uj', false, {                                                                             //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_HideType_ul', false, {                                                                             //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_HideType_ru', false, {                                                                             //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Message_HideType_au', false, {                                                                             //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  return this.add('Message_HideType_mute_unmute', false, {                                                             //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('Meta', function () {                                                                     //
  this.add('Meta_language', '', {                                                                                      //
    type: 'string'                                                                                                     //
  });                                                                                                                  //
  this.add('Meta_fb_app_id', '', {                                                                                     //
    type: 'string'                                                                                                     //
  });                                                                                                                  //
  this.add('Meta_robots', 'INDEX,FOLLOW', {                                                                            //
    type: 'string'                                                                                                     //
  });                                                                                                                  //
  this.add('Meta_google-site-verification', '', {                                                                      //
    type: 'string'                                                                                                     //
  });                                                                                                                  //
  this.add('Meta_msvalidate01', '', {                                                                                  //
    type: 'string'                                                                                                     //
  });                                                                                                                  //
  return this.add('Meta_custom', '', {                                                                                 //
    type: 'code',                                                                                                      //
    code: 'text/html',                                                                                                 //
    multiline: true                                                                                                    //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('Push', function () {                                                                     //
  this.add('Push_enable', true, {                                                                                      //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Push_debug', false, {                                                                                      //
    type: 'boolean',                                                                                                   //
    "public": true,                                                                                                    //
    enableQuery: {                                                                                                     //
      _id: 'Push_enable',                                                                                              //
      value: true                                                                                                      //
    }                                                                                                                  //
  });                                                                                                                  //
  this.add('Push_enable_gateway', true, {                                                                              //
    type: 'boolean',                                                                                                   //
    enableQuery: {                                                                                                     //
      _id: 'Push_enable',                                                                                              //
      value: true                                                                                                      //
    }                                                                                                                  //
  });                                                                                                                  //
  this.add('Push_gateway', 'https://gateway.rocket.chat', {                                                            //
    type: 'string',                                                                                                    //
    enableQuery: [{                                                                                                    //
      _id: 'Push_enable',                                                                                              //
      value: true                                                                                                      //
    }, {                                                                                                               //
      _id: 'Push_enable_gateway',                                                                                      //
      value: true                                                                                                      //
    }]                                                                                                                 //
  });                                                                                                                  //
  this.add('Push_production', true, {                                                                                  //
    type: 'boolean',                                                                                                   //
    "public": true,                                                                                                    //
    enableQuery: [{                                                                                                    //
      _id: 'Push_enable',                                                                                              //
      value: true                                                                                                      //
    }, {                                                                                                               //
      _id: 'Push_enable_gateway',                                                                                      //
      value: false                                                                                                     //
    }]                                                                                                                 //
  });                                                                                                                  //
  this.add('Push_test_push', 'push_test', {                                                                            //
    type: 'action',                                                                                                    //
    actionText: 'Send_a_test_push_to_my_user',                                                                         //
    enableQuery: {                                                                                                     //
      _id: 'Push_enable',                                                                                              //
      value: true                                                                                                      //
    }                                                                                                                  //
  });                                                                                                                  //
  this.section('Certificates_and_Keys', function () {                                                                  //
    this.add('Push_apn_passphrase', '', {                                                                              //
      type: 'string'                                                                                                   //
    });                                                                                                                //
    this.add('Push_apn_key', '', {                                                                                     //
      type: 'string',                                                                                                  //
      multiline: true                                                                                                  //
    });                                                                                                                //
    this.add('Push_apn_cert', '', {                                                                                    //
      type: 'string',                                                                                                  //
      multiline: true                                                                                                  //
    });                                                                                                                //
    this.add('Push_apn_dev_passphrase', '', {                                                                          //
      type: 'string'                                                                                                   //
    });                                                                                                                //
    this.add('Push_apn_dev_key', '', {                                                                                 //
      type: 'string',                                                                                                  //
      multiline: true                                                                                                  //
    });                                                                                                                //
    this.add('Push_apn_dev_cert', '', {                                                                                //
      type: 'string',                                                                                                  //
      multiline: true                                                                                                  //
    });                                                                                                                //
    this.add('Push_gcm_api_key', '', {                                                                                 //
      type: 'string'                                                                                                   //
    });                                                                                                                //
    return this.add('Push_gcm_project_number', '', {                                                                   //
      type: 'string',                                                                                                  //
      "public": true                                                                                                   //
    });                                                                                                                //
  });                                                                                                                  //
  return this.section('Privacy', function () {                                                                         //
    this.add('Push_show_username_room', true, {                                                                        //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    return this.add('Push_show_message', true, {                                                                       //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('Layout', function () {                                                                   //
  this.section('Content', function () {                                                                                //
    this.add('Layout_Home_Title', 'Home', {                                                                            //
      type: 'string',                                                                                                  //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Layout_Home_Body', 'Welcome to Rocket.Chat <br> Go to APP SETTINGS -> Layout to customize this intro.', {
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Layout_Terms_of_Service', 'Terms of Service <br> Go to APP SETTINGS -> Layout to customize this page.', {
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Layout_Login_Terms', 'By proceeding you are agreeing to our <a href="/terms-of-service">Terms of Service</a> and <a href="/privacy-policy">Privacy Policy</a>.', {
      type: 'string',                                                                                                  //
      multiline: true,                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('Layout_Privacy_Policy', 'Privacy Policy <br> Go to APP SETTINGS -> Layout to customize this page.', {    //
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      multiline: true,                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    return this.add('Layout_Sidenav_Footer', '<img src="/assets/logo" />', {                                           //
      type: 'code',                                                                                                    //
      code: 'text/html',                                                                                               //
      "public": true,                                                                                                  //
      i18nDescription: 'Layout_Sidenav_Footer_description'                                                             //
    });                                                                                                                //
  });                                                                                                                  //
  this.section('Custom_Scripts', function () {                                                                         //
    this.add('Custom_Script_Logged_Out', '//Add your script', {                                                        //
      type: 'code',                                                                                                    //
      multiline: true,                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    return this.add('Custom_Script_Logged_In', '//Add your script', {                                                  //
      type: 'code',                                                                                                    //
      multiline: true,                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
  });                                                                                                                  //
  return this.section('User_Interface', function () {                                                                  //
    this.add('UI_DisplayRoles', true, {                                                                                //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    this.add('UI_Merge_Channels_Groups', true, {                                                                       //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
    return this.add('UI_Use_Name_Avatar', false, {                                                                     //
      type: 'boolean',                                                                                                 //
      "public": true                                                                                                   //
    });                                                                                                                //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.addGroup('Logs', function () {                                                                     //
  this.add('Log_Level', '0', {                                                                                         //
    type: 'select',                                                                                                    //
    values: [{                                                                                                         //
      key: '0',                                                                                                        //
      i18nLabel: '0_Errors_Only'                                                                                       //
    }, {                                                                                                               //
      key: '1',                                                                                                        //
      i18nLabel: '1_Errors_and_Information'                                                                            //
    }, {                                                                                                               //
      key: '2',                                                                                                        //
      i18nLabel: '2_Erros_Information_and_Debug'                                                                       //
    }],                                                                                                                //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Log_Package', false, {                                                                                     //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  this.add('Log_File', false, {                                                                                        //
    type: 'boolean',                                                                                                   //
    "public": true                                                                                                     //
  });                                                                                                                  //
  return this.add('Log_View_Limit', 1000, {                                                                            //
    type: 'int'                                                                                                        //
  });                                                                                                                  //
});                                                                                                                    //
RocketChat.settings.init();                                                                                            //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"publications":{"settings.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/publications/settings.coffee.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
Meteor.methods({                                                                                                       //
  'public-settings/get': function (updatedAt) {                                                                        //
    var records, result;                                                                                               //
    this.unblock();                                                                                                    //
    records = RocketChat.models.Settings.find().fetch().filter(function (record) {                                     //
      return record.hidden !== true && record["public"] === true;                                                      //
    });                                                                                                                //
                                                                                                                       //
    if (updatedAt instanceof Date) {                                                                                   //
      result = {                                                                                                       //
        update: records.filter(function (record) {                                                                     //
          return record._updatedAt > updatedAt;                                                                        //
        }),                                                                                                            //
        remove: RocketChat.models.Settings.trashFindDeletedAfter(updatedAt, {                                          //
          hidden: {                                                                                                    //
            $ne: true                                                                                                  //
          },                                                                                                           //
          "public": true                                                                                               //
        }, {                                                                                                           //
          fields: {                                                                                                    //
            _id: 1,                                                                                                    //
            _deletedAt: 1                                                                                              //
          }                                                                                                            //
        }).fetch()                                                                                                     //
      };                                                                                                               //
      return result;                                                                                                   //
    }                                                                                                                  //
                                                                                                                       //
    return records;                                                                                                    //
  },                                                                                                                   //
  'private-settings/get': function (updatedAt) {                                                                       //
    var records;                                                                                                       //
                                                                                                                       //
    if (!Meteor.userId()) {                                                                                            //
      return [];                                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    this.unblock();                                                                                                    //
                                                                                                                       //
    if (!RocketChat.authz.hasPermission(Meteor.userId(), 'view-privileged-setting')) {                                 //
      return [];                                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    records = RocketChat.models.Settings.find().fetch().filter(function (record) {                                     //
      return record.hidden !== true;                                                                                   //
    });                                                                                                                //
                                                                                                                       //
    if (updatedAt instanceof Date) {                                                                                   //
      return {                                                                                                         //
        update: records.filter(function (record) {                                                                     //
          return record._updatedAt > updatedAt;                                                                        //
        }),                                                                                                            //
        remove: RocketChat.models.Settings.trashFindDeletedAfter(updatedAt, {                                          //
          hidden: {                                                                                                    //
            $ne: true                                                                                                  //
          }                                                                                                            //
        }, {                                                                                                           //
          fields: {                                                                                                    //
            _id: 1,                                                                                                    //
            _deletedAt: 1                                                                                              //
          }                                                                                                            //
        }).fetch()                                                                                                     //
      };                                                                                                               //
    }                                                                                                                  //
                                                                                                                       //
    return records;                                                                                                    //
  }                                                                                                                    //
});                                                                                                                    //
RocketChat.models.Settings.cache.on('changed', function (type, setting) {                                              //
  if (setting["public"] === true) {                                                                                    //
    RocketChat.Notifications.notifyAllInThisInstance('public-settings-changed', type, _.pick(setting, '_id', 'value'));
  }                                                                                                                    //
                                                                                                                       //
  return RocketChat.Notifications.notifyLoggedInThisInstance('private-settings-changed', type, setting);               //
});                                                                                                                    //
RocketChat.Notifications.streamAll.allowRead('private-settings-changed', function () {                                 //
  if (this.userId == null) {                                                                                           //
    return false;                                                                                                      //
  }                                                                                                                    //
                                                                                                                       //
  return RocketChat.authz.hasPermission(this.userId, 'view-privileged-setting');                                       //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"methods":{"addOAuthService.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/addOAuthService.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* eslint no-multi-spaces: 0 */ /* eslint comma-spacing: 0 */Meteor.methods({                                          // 1
	addOAuthService: function (name) {                                                                                    // 5
		check(name, String);                                                                                                 // 7
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 9
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 10
				method: 'addOAuthService'                                                                                          // 10
			});                                                                                                                 // 10
		}                                                                                                                    // 11
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'add-oauth-service') !== true) {                                 // 13
			throw new Meteor.Error('error-action-not-allowed', 'Adding OAuth Services is not allowed', {                        // 14
				method: 'addOAuthService',                                                                                         // 14
				action: 'Adding_OAuth_Services'                                                                                    // 14
			});                                                                                                                 // 14
		}                                                                                                                    // 15
                                                                                                                       //
		name = name.toLowerCase().replace(/[^a-z0-9_]/g, '');                                                                // 17
		name = s.capitalize(name);                                                                                           // 18
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name, false, {                                                    // 19
			type: 'boolean',                                                                                                    // 19
			group: 'OAuth',                                                                                                     // 19
			section: "Custom OAuth: " + name,                                                                                   // 19
			i18nLabel: 'Accounts_OAuth_Custom_Enable',                                                                          // 19
			persistent: true                                                                                                    // 19
		});                                                                                                                  // 19
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-url", '', {                                              // 20
			type: 'string',                                                                                                     // 20
			group: 'OAuth',                                                                                                     // 20
			section: "Custom OAuth: " + name,                                                                                   // 20
			i18nLabel: 'URL',                                                                                                   // 20
			persistent: true                                                                                                    // 20
		});                                                                                                                  // 20
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-token_path", '/oauth/token', {                           // 21
			type: 'string',                                                                                                     // 21
			group: 'OAuth',                                                                                                     // 21
			section: "Custom OAuth: " + name,                                                                                   // 21
			i18nLabel: 'Accounts_OAuth_Custom_Token_Path',                                                                      // 21
			persistent: true                                                                                                    // 21
		});                                                                                                                  // 21
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-identity_path", '/me', {                                 // 22
			type: 'string',                                                                                                     // 22
			group: 'OAuth',                                                                                                     // 22
			section: "Custom OAuth: " + name,                                                                                   // 22
			i18nLabel: 'Accounts_OAuth_Custom_Identity_Path',                                                                   // 22
			persistent: true                                                                                                    // 22
		});                                                                                                                  // 22
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-authorize_path", '/oauth/authorize', {                   // 23
			type: 'string',                                                                                                     // 23
			group: 'OAuth',                                                                                                     // 23
			section: "Custom OAuth: " + name,                                                                                   // 23
			i18nLabel: 'Accounts_OAuth_Custom_Authorize_Path',                                                                  // 23
			persistent: true                                                                                                    // 23
		});                                                                                                                  // 23
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-scope", 'openid', {                                      // 24
			type: 'string',                                                                                                     // 24
			group: 'OAuth',                                                                                                     // 24
			section: "Custom OAuth: " + name,                                                                                   // 24
			i18nLabel: 'Accounts_OAuth_Custom_Scope',                                                                           // 24
			persistent: true                                                                                                    // 24
		});                                                                                                                  // 24
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-token_sent_via", 'payload', {                            // 25
			type: 'select',                                                                                                     // 25
			group: 'OAuth',                                                                                                     // 25
			section: "Custom OAuth: " + name,                                                                                   // 25
			i18nLabel: 'Accounts_OAuth_Custom_Token_Sent_Via',                                                                  // 25
			persistent: true,                                                                                                   // 25
			values: [{                                                                                                          // 25
				key: 'header',                                                                                                     // 25
				i18nLabel: 'Header'                                                                                                // 25
			}, {                                                                                                                // 25
				key: 'payload',                                                                                                    // 25
				i18nLabel: 'Payload'                                                                                               // 25
			}]                                                                                                                  // 25
		});                                                                                                                  // 25
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-id", '', {                                               // 26
			type: 'string',                                                                                                     // 26
			group: 'OAuth',                                                                                                     // 26
			section: "Custom OAuth: " + name,                                                                                   // 26
			i18nLabel: 'Accounts_OAuth_Custom_id',                                                                              // 26
			persistent: true                                                                                                    // 26
		});                                                                                                                  // 26
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-secret", '', {                                           // 27
			type: 'string',                                                                                                     // 27
			group: 'OAuth',                                                                                                     // 27
			section: "Custom OAuth: " + name,                                                                                   // 27
			i18nLabel: 'Accounts_OAuth_Custom_Secret',                                                                          // 27
			persistent: true                                                                                                    // 27
		});                                                                                                                  // 27
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-login_style", 'popup', {                                 // 28
			type: 'select',                                                                                                     // 28
			group: 'OAuth',                                                                                                     // 28
			section: "Custom OAuth: " + name,                                                                                   // 28
			i18nLabel: 'Accounts_OAuth_Custom_Login_Style',                                                                     // 28
			persistent: true,                                                                                                   // 28
			values: [{                                                                                                          // 28
				key: 'redirect',                                                                                                   // 28
				i18nLabel: 'Redirect'                                                                                              // 28
			}, {                                                                                                                // 28
				key: 'popup',                                                                                                      // 28
				i18nLabel: 'Popup'                                                                                                 // 28
			}, {                                                                                                                // 28
				key: '',                                                                                                           // 28
				i18nLabel: 'Default'                                                                                               // 28
			}]                                                                                                                  // 28
		});                                                                                                                  // 28
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-button_label_text", '', {                                // 29
			type: 'string',                                                                                                     // 29
			group: 'OAuth',                                                                                                     // 29
			section: "Custom OAuth: " + name,                                                                                   // 29
			i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Text',                                                               // 29
			persistent: true                                                                                                    // 29
		});                                                                                                                  // 29
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-button_label_color", '#FFFFFF', {                        // 30
			type: 'string',                                                                                                     // 30
			group: 'OAuth',                                                                                                     // 30
			section: "Custom OAuth: " + name,                                                                                   // 30
			i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Color',                                                              // 30
			persistent: true                                                                                                    // 30
		});                                                                                                                  // 30
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-button_color", '#13679A', {                              // 31
			type: 'string',                                                                                                     // 31
			group: 'OAuth',                                                                                                     // 31
			section: "Custom OAuth: " + name,                                                                                   // 31
			i18nLabel: 'Accounts_OAuth_Custom_Button_Color',                                                                    // 31
			persistent: true                                                                                                    // 31
		});                                                                                                                  // 31
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-username_field", '', {                                   // 32
			type: 'string',                                                                                                     // 32
			group: 'OAuth',                                                                                                     // 32
			section: "Custom OAuth: " + name,                                                                                   // 32
			i18nLabel: 'Accounts_OAuth_Custom_Username_Field',                                                                  // 32
			persistent: true                                                                                                    // 32
		});                                                                                                                  // 32
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-merge_users", false, {                                   // 33
			type: 'boolean',                                                                                                    // 33
			group: 'OAuth',                                                                                                     // 33
			section: "Custom OAuth: " + name,                                                                                   // 33
			i18nLabel: 'Accounts_OAuth_Custom_Merge_Users',                                                                     // 33
			persistent: true                                                                                                    // 33
		});                                                                                                                  // 33
	}                                                                                                                     // 34
});                                                                                                                    // 4
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"refreshOAuthService.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/refreshOAuthService.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	refreshOAuthService: function () {                                                                                    // 2
		if (!Meteor.userId()) {                                                                                              // 3
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 4
				method: 'refreshOAuthService'                                                                                      // 4
			});                                                                                                                 // 4
		}                                                                                                                    // 5
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'add-oauth-service') !== true) {                                 // 7
			throw new Meteor.Error('error-action-not-allowed', 'Refresh OAuth Services is not allowed', {                       // 8
				method: 'refreshOAuthService',                                                                                     // 8
				action: 'Refreshing_OAuth_Services'                                                                                // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		ServiceConfiguration.configurations.remove({});                                                                      // 11
		RocketChat.models.Settings.update({                                                                                  // 13
			_id: /^Accounts_OAuth_.+/                                                                                           // 13
		}, {                                                                                                                 // 13
			$set: {                                                                                                             // 13
				_updatedAt: new Date()                                                                                             // 13
			}                                                                                                                   // 13
		}, {                                                                                                                 // 13
			multi: true                                                                                                         // 13
		});                                                                                                                  // 13
	}                                                                                                                     // 14
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"addUserToRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/addUserToRoom.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	addUserToRoom: function (data) {                                                                                      // 2
		return Meteor.call('addUsersToRoom', {                                                                               // 3
			rid: data.rid,                                                                                                      // 4
			users: [data.username]                                                                                              // 5
		});                                                                                                                  // 3
	}                                                                                                                     // 7
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"addUsersToRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/addUsersToRoom.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	addUsersToRoom: function () {                                                                                         // 2
		var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};                                   // 2
                                                                                                                       //
		// Validate user and room                                                                                            // 3
		if (!Meteor.userId()) {                                                                                              // 4
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 5
				method: 'addUsersToRoom'                                                                                           // 6
			});                                                                                                                 // 5
		}                                                                                                                    // 8
                                                                                                                       //
		if (!Match.test(data.rid, String)) {                                                                                 // 10
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 11
				method: 'addUsersToRoom'                                                                                           // 12
			});                                                                                                                 // 11
		} // Get user and room details                                                                                       // 14
                                                                                                                       //
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(data.rid);                                                            // 17
		var userId = Meteor.userId();                                                                                        // 18
		var user = Meteor.user();                                                                                            // 19
		var userInRoom = Array.isArray(room.usernames) && room.usernames.includes(user.username); // Can't add to direct room ever
                                                                                                                       //
		if (room.t === 'd') {                                                                                                // 23
			throw new Meteor.Error('error-cant-invite-for-direct-room', 'Can\'t invite user to direct rooms', {                 // 24
				method: 'addUsersToRoom'                                                                                           // 25
			});                                                                                                                 // 24
		} // Can add to any room you're in, with permission, otherwise need specific room type permission                    // 27
                                                                                                                       //
                                                                                                                       //
		var canAddUser = false;                                                                                              // 30
                                                                                                                       //
		if (userInRoom && RocketChat.authz.hasPermission(userId, 'add-user-to-joined-room', room._id)) {                     // 31
			canAddUser = true;                                                                                                  // 32
		} else if (room.t === 'c' && RocketChat.authz.hasPermission(userId, 'add-user-to-any-c-room')) {                     // 33
			canAddUser = true;                                                                                                  // 34
		} else if (room.t === 'p' && RocketChat.authz.hasPermission(userId, 'add-user-to-any-p-room')) {                     // 35
			canAddUser = true;                                                                                                  // 36
		} // Adding wasn't allowed                                                                                           // 37
                                                                                                                       //
                                                                                                                       //
		if (!canAddUser) {                                                                                                   // 40
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 41
				method: 'addUsersToRoom'                                                                                           // 42
			});                                                                                                                 // 41
		} // Missing the users to be added                                                                                   // 44
                                                                                                                       //
                                                                                                                       //
		if (!Array.isArray(data.users)) {                                                                                    // 47
			throw new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {                                            // 48
				method: 'addUsersToRoom'                                                                                           // 49
			});                                                                                                                 // 48
		} // Validate each user, then add to room                                                                            // 51
                                                                                                                       //
                                                                                                                       //
		data.users.forEach(function (username) {                                                                             // 54
			var newUser = RocketChat.models.Users.findOneByUsername(username);                                                  // 55
                                                                                                                       //
			if (!newUser) {                                                                                                     // 56
				throw new Meteor.Error('error-invalid-username', 'Invalid username', {                                             // 57
					method: 'addUsersToRoom'                                                                                          // 58
				});                                                                                                                // 57
			}                                                                                                                   // 60
                                                                                                                       //
			RocketChat.addUserToRoom(data.rid, newUser, user);                                                                  // 62
		});                                                                                                                  // 63
		return true;                                                                                                         // 65
	}                                                                                                                     // 66
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"archiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/archiveRoom.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	archiveRoom: function (rid) {                                                                                         // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'archiveRoom'                                                                                              // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 12
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 13
				method: 'archiveRoom'                                                                                              // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'archive-room', room._id)) {                                    // 16
			throw new Meteor.Error('error-not-authorized', 'Not authorized', {                                                  // 17
				method: 'archiveRoom'                                                                                              // 17
			});                                                                                                                 // 17
		}                                                                                                                    // 18
                                                                                                                       //
		return RocketChat.archiveRoom(rid);                                                                                  // 20
	}                                                                                                                     // 21
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"blockUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/blockUser.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	blockUser: function (_ref) {                                                                                          // 2
		var rid = _ref.rid,                                                                                                  // 2
		    blocked = _ref.blocked;                                                                                          // 2
		check(rid, String);                                                                                                  // 4
		check(blocked, String);                                                                                              // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 7
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 8
				method: 'blockUser'                                                                                                // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());                   // 11
		var subscription2 = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, blocked);                          // 12
                                                                                                                       //
		if (!subscription || !subscription2) {                                                                               // 14
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 15
				method: 'blockUser'                                                                                                // 15
			});                                                                                                                 // 15
		}                                                                                                                    // 16
                                                                                                                       //
		RocketChat.models.Subscriptions.setBlockedByRoomId(rid, blocked, Meteor.userId());                                   // 18
		return true;                                                                                                         // 20
	}                                                                                                                     // 21
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"checkRegistrationSecretURL.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/checkRegistrationSecretURL.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	checkRegistrationSecretURL: function (hash) {                                                                         // 2
		check(hash, String);                                                                                                 // 4
		return hash === RocketChat.settings.get('Accounts_RegistrationForm_SecretURL');                                      // 6
	}                                                                                                                     // 7
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"cleanChannelHistory.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/cleanChannelHistory.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	cleanChannelHistory: function (_ref) {                                                                                // 2
		var roomId = _ref.roomId,                                                                                            // 2
		    latest = _ref.latest,                                                                                            // 2
		    oldest = _ref.oldest,                                                                                            // 2
		    inclusive = _ref.inclusive;                                                                                      // 2
		check(roomId, String);                                                                                               // 3
		check(latest, Date);                                                                                                 // 4
		check(oldest, Date);                                                                                                 // 5
		check(inclusive, Boolean);                                                                                           // 6
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 8
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 9
				method: 'cleanChannelHistory'                                                                                      // 9
			});                                                                                                                 // 9
		}                                                                                                                    // 10
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'clean-channel-history')) {                                     // 12
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 13
				method: 'cleanChannelHistory'                                                                                      // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (inclusive) {                                                                                                     // 16
			RocketChat.models.Messages.remove({                                                                                 // 17
				rid: roomId,                                                                                                       // 18
				ts: {                                                                                                              // 19
					$gte: oldest,                                                                                                     // 20
					$lte: latest                                                                                                      // 21
				}                                                                                                                  // 19
			});                                                                                                                 // 17
		} else {                                                                                                             // 24
			RocketChat.models.Messages.remove({                                                                                 // 25
				rid: roomId,                                                                                                       // 26
				ts: {                                                                                                              // 27
					$gt: oldest,                                                                                                      // 28
					$lt: latest                                                                                                       // 29
				}                                                                                                                  // 27
			});                                                                                                                 // 25
		}                                                                                                                    // 32
	}                                                                                                                     // 33
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"createChannel.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/createChannel.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	createChannel: function (name, members) {                                                                             // 2
		var readOnly = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;                            // 2
		var customFields = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};                           // 2
		check(name, String);                                                                                                 // 3
		check(members, Match.Optional([String]));                                                                            // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'createChannel'                                                                                            // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'create-c')) {                                                  // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'createChannel'                                                                                            // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		return RocketChat.createRoom('c', name, Meteor.user() && Meteor.user().username, members, readOnly, {                // 14
			customFields: customFields                                                                                          // 14
		});                                                                                                                  // 14
	}                                                                                                                     // 15
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"createPrivateGroup.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/createPrivateGroup.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	createPrivateGroup: function (name, members) {                                                                        // 2
		var readOnly = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;                            // 2
		var customFields = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};                           // 2
		check(name, String);                                                                                                 // 3
		check(members, Match.Optional([String]));                                                                            // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'createPrivateGroup'                                                                                       // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'create-p')) {                                                  // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'createPrivateGroup'                                                                                       // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		return RocketChat.createRoom('p', name, Meteor.user() && Meteor.user().username, members, readOnly, {                // 14
			customFields: customFields                                                                                          // 14
		});                                                                                                                  // 14
	}                                                                                                                     // 15
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"deleteMessage.coffee.js":["moment",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/deleteMessage.coffee.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var moment = void 0;                                                                                                   //
module.import('moment', {                                                                                              //
  "default": function (v) {                                                                                            //
    moment = v;                                                                                                        //
  }                                                                                                                    //
}, 0);                                                                                                                 //
Meteor.methods({                                                                                                       //
  deleteMessage: function (message) {                                                                                  //
    var blockDeleteInMinutes, currentTsDiff, deleteAllowed, deleteOwn, hasPermission, msgTs, originalMessage, ref;     //
    check(message, Match.ObjectIncluding({                                                                             //
      _id: String                                                                                                      //
    }));                                                                                                               //
                                                                                                                       //
    if (!Meteor.userId()) {                                                                                            //
      throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                   //
        method: 'deleteMessage'                                                                                        //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    originalMessage = RocketChat.models.Messages.findOneById(message._id, {                                            //
      fields: {                                                                                                        //
        u: 1,                                                                                                          //
        rid: 1,                                                                                                        //
        file: 1                                                                                                        //
      }                                                                                                                //
    });                                                                                                                //
                                                                                                                       //
    if (originalMessage == null) {                                                                                     //
      throw new Meteor.Error('error-action-not-allowed', 'Not allowed', {                                              //
        method: 'deleteMessage',                                                                                       //
        action: 'Delete_message'                                                                                       //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', originalMessage.rid);            //
    deleteAllowed = RocketChat.settings.get('Message_AllowDeleting');                                                  //
    deleteOwn = (originalMessage != null ? (ref = originalMessage.u) != null ? ref._id : void 0 : void 0) === Meteor.userId();
                                                                                                                       //
    if (!(hasPermission || deleteAllowed && deleteOwn)) {                                                              //
      throw new Meteor.Error('error-action-not-allowed', 'Not allowed', {                                              //
        method: 'deleteMessage',                                                                                       //
        action: 'Delete_message'                                                                                       //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    blockDeleteInMinutes = RocketChat.settings.get('Message_AllowDeleting_BlockDeleteInMinutes');                      //
                                                                                                                       //
    if (blockDeleteInMinutes != null && blockDeleteInMinutes !== 0) {                                                  //
      if (originalMessage.ts != null) {                                                                                //
        msgTs = moment(originalMessage.ts);                                                                            //
      }                                                                                                                //
                                                                                                                       //
      if (msgTs != null) {                                                                                             //
        currentTsDiff = moment().diff(msgTs, 'minutes');                                                               //
      }                                                                                                                //
                                                                                                                       //
      if (currentTsDiff > blockDeleteInMinutes) {                                                                      //
        throw new Meteor.Error('error-message-deleting-blocked', 'Message deleting is blocked', {                      //
          method: 'deleteMessage'                                                                                      //
        });                                                                                                            //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    return RocketChat.deleteMessage(originalMessage, Meteor.user());                                                   //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"deleteUserOwnAccount.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/deleteUserOwnAccount.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	deleteUserOwnAccount: function (password) {                                                                           // 2
		check(password, String);                                                                                             // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'deleteUserOwnAccount'                                                                                     // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (!RocketChat.settings.get('Accounts_AllowDeleteOwnAccount')) {                                                    // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'deleteUserOwnAccount'                                                                                     // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		var userId = Meteor.userId();                                                                                        // 14
		var user = RocketChat.models.Users.findOneById(userId);                                                              // 15
                                                                                                                       //
		if (!user) {                                                                                                         // 17
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 18
				method: 'deleteUserOwnAccount'                                                                                     // 18
			});                                                                                                                 // 18
		}                                                                                                                    // 19
                                                                                                                       //
		if (user.services && user.services.password && s.trim(user.services.password.bcrypt)) {                              // 21
			var result = Accounts._checkPassword(user, {                                                                        // 22
				digest: password,                                                                                                  // 22
				algorithm: 'sha-256'                                                                                               // 22
			});                                                                                                                 // 22
                                                                                                                       //
			if (result.error) {                                                                                                 // 23
				throw new Meteor.Error('error-invalid-password', 'Invalid password', {                                             // 24
					method: 'deleteUserOwnAccount'                                                                                    // 24
				});                                                                                                                // 24
			}                                                                                                                   // 25
		} else if (user.username !== s.trim(password)) {                                                                     // 26
			throw new Meteor.Error('error-invalid-username', 'Invalid username', {                                              // 27
				method: 'deleteUserOwnAccount'                                                                                     // 27
			});                                                                                                                 // 27
		}                                                                                                                    // 28
                                                                                                                       //
		Meteor.defer(function () {                                                                                           // 30
			RocketChat.deleteUser(userId);                                                                                      // 31
		});                                                                                                                  // 32
		return true;                                                                                                         // 34
	}                                                                                                                     // 35
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"filterBadWords.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/filterBadWords.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var Filter = Npm.require('bad-words');                                                                                 // 1
                                                                                                                       //
RocketChat.callbacks.add('beforeSaveMessage', function (message) {                                                     // 3
	if (RocketChat.settings.get('Message_AllowBadWordsFilter')) {                                                         // 5
		var badWordsList = RocketChat.settings.get('Message_BadWordsFilterList');                                            // 6
		var options; // Add words to the blacklist                                                                           // 7
                                                                                                                       //
		if (!!badWordsList && badWordsList.length) {                                                                         // 10
			options = {                                                                                                         // 11
				list: badWordsList.split(',')                                                                                      // 12
			};                                                                                                                  // 11
		}                                                                                                                    // 14
                                                                                                                       //
		var filter = new Filter(options);                                                                                    // 15
		message.msg = filter.clean(message.msg);                                                                             // 16
	}                                                                                                                     // 17
                                                                                                                       //
	return message;                                                                                                       // 19
}, 1, 'filterBadWords');                                                                                               // 21
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"filterATAllTag.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/filterATAllTag.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.callbacks.add('beforeSaveMessage', function (message) {                                                     // 1
	// Test if the message mentions include @all.                                                                         // 2
	if (message.mentions != null && _.pluck(message.mentions, '_id').some(function (item) {                               // 3
		return item === 'all';                                                                                               // 4
	})) {                                                                                                                 // 4
		// Check if the user has permissions to use @all.                                                                    // 6
		if (!RocketChat.authz.hasPermission(message.u._id, 'mention-all')) {                                                 // 7
			// Get the language of the user for the error notification.                                                         // 9
			var language = RocketChat.models.Users.findOneById(message.u._id).language;                                         // 10
                                                                                                                       //
			var action = TAPi18n.__('Notify_all_in_this_room', {}, language); // Add a notification to the chat, informing the user that this
			// action is not allowed.                                                                                           // 14
                                                                                                                       //
                                                                                                                       //
			RocketChat.Notifications.notifyUser(message.u._id, 'message', {                                                     // 15
				_id: Random.id(),                                                                                                  // 16
				rid: message.rid,                                                                                                  // 17
				ts: new Date(),                                                                                                    // 18
				msg: TAPi18n.__('error-action-not-allowed', {                                                                      // 19
					action: action                                                                                                    // 19
				}, language)                                                                                                       // 19
			}); // Also throw to stop propagation of 'sendMessage'.                                                             // 15
                                                                                                                       //
			throw new Meteor.Error('error-action-not-allowed', 'Notify all in this room not allowed', {                         // 23
				method: 'filterATAllTag',                                                                                          // 27
				action: 'Notify_all_in_this_room'                                                                                  // 28
			});                                                                                                                 // 26
		}                                                                                                                    // 31
	}                                                                                                                     // 32
                                                                                                                       //
	return message;                                                                                                       // 34
}, 1, 'filterATAllTag');                                                                                               // 36
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getChannelHistory.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getChannelHistory.js                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getChannelHistory: function (_ref) {                                                                                  // 2
		var rid = _ref.rid,                                                                                                  // 2
		    latest = _ref.latest,                                                                                            // 2
		    oldest = _ref.oldest,                                                                                            // 2
		    inclusive = _ref.inclusive,                                                                                      // 2
		    _ref$count = _ref.count,                                                                                         // 2
		    count = _ref$count === undefined ? 20 : _ref$count,                                                              // 2
		    unreads = _ref.unreads;                                                                                          // 2
		check(rid, String);                                                                                                  // 3
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'getChannelHistory'                                                                                        // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		var fromUserId = Meteor.userId();                                                                                    // 9
		var room = Meteor.call('canAccessRoom', rid, fromUserId);                                                            // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 11
			return false;                                                                                                       // 12
		} //Make sure they can access the room                                                                               // 13
                                                                                                                       //
                                                                                                                       //
		if (room.t === 'c' && !RocketChat.authz.hasPermission(fromUserId, 'preview-c-room') && room.usernames.indexOf(room.username) === -1) {
			return false;                                                                                                       // 17
		} //Ensure latest is always defined.                                                                                 // 18
                                                                                                                       //
                                                                                                                       //
		if (_.isUndefined(latest)) {                                                                                         // 21
			latest = new Date();                                                                                                // 22
		} //Verify oldest is a date if it exists                                                                             // 23
                                                                                                                       //
                                                                                                                       //
		if (!_.isUndefined(oldest) && !_.isDate(oldest)) {                                                                   // 26
			throw new Meteor.Error('error-invalid-date', 'Invalid date', {                                                      // 27
				method: 'getChannelHistory'                                                                                        // 27
			});                                                                                                                 // 27
		}                                                                                                                    // 28
                                                                                                                       //
		var options = {                                                                                                      // 30
			sort: {                                                                                                             // 31
				ts: -1                                                                                                             // 32
			},                                                                                                                  // 31
			limit: count                                                                                                        // 34
		};                                                                                                                   // 30
                                                                                                                       //
		if (!RocketChat.settings.get('Message_ShowEditedStatus')) {                                                          // 37
			options.fields = {                                                                                                  // 38
				'editedAt': 0                                                                                                      // 38
			};                                                                                                                  // 38
		}                                                                                                                    // 39
                                                                                                                       //
		var records = [];                                                                                                    // 41
                                                                                                                       //
		if (_.isUndefined(oldest) && inclusive) {                                                                            // 42
			records = RocketChat.models.Messages.findVisibleByRoomIdBeforeTimestampInclusive(rid, latest, options).fetch();     // 43
		} else if (_.isUndefined(oldest) && !inclusive) {                                                                    // 44
			records = RocketChat.models.Messages.findVisibleByRoomIdBeforeTimestamp(rid, latest, options).fetch();              // 45
		} else if (!_.isUndefined(oldest) && inclusive) {                                                                    // 46
			records = RocketChat.models.Messages.findVisibleByRoomIdBetweenTimestampsInclusive(rid, oldest, latest, options).fetch();
		} else {                                                                                                             // 48
			records = RocketChat.models.Messages.findVisibleByRoomIdBetweenTimestamps(rid, oldest, latest, options).fetch();    // 49
		}                                                                                                                    // 50
                                                                                                                       //
		var messages = _.map(records, function (message) {                                                                   // 52
			message.starred = _.findWhere(message.starred, {                                                                    // 53
				_id: fromUserId                                                                                                    // 53
			});                                                                                                                 // 53
			return message;                                                                                                     // 54
		});                                                                                                                  // 55
                                                                                                                       //
		if (unreads) {                                                                                                       // 57
			var unreadNotLoaded = 0;                                                                                            // 58
			var firstUnread = undefined;                                                                                        // 59
                                                                                                                       //
			if (!_.isUndefined(oldest)) {                                                                                       // 61
				var firstMsg = messages[messages.length - 1];                                                                      // 62
                                                                                                                       //
				if (!_.isUndefined(firstMsg) && firstMsg.ts > oldest) {                                                            // 63
					var unreadMessages = RocketChat.models.Messages.findVisibleByRoomIdBetweenTimestamps(rid, oldest, firstMsg.ts, {  // 64
						limit: 1,                                                                                                        // 64
						sort: {                                                                                                          // 64
							ts: 1                                                                                                           // 64
						}                                                                                                                // 64
					});                                                                                                               // 64
					firstUnread = unreadMessages.fetch()[0];                                                                          // 65
					unreadNotLoaded = unreadMessages.count();                                                                         // 66
				}                                                                                                                  // 67
			}                                                                                                                   // 68
                                                                                                                       //
			return {                                                                                                            // 70
				messages: messages,                                                                                                // 71
				firstUnread: firstUnread,                                                                                          // 72
				unreadNotLoaded: unreadNotLoaded                                                                                   // 73
			};                                                                                                                  // 70
		}                                                                                                                    // 75
                                                                                                                       //
		return {                                                                                                             // 77
			messages: messages                                                                                                  // 78
		};                                                                                                                   // 77
	}                                                                                                                     // 80
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getFullUserData.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getFullUserData.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getFullUserData: function (_ref) {                                                                                    // 2
		var _ref$filter = _ref.filter,                                                                                       // 2
		    filter = _ref$filter === undefined ? '' : _ref$filter,                                                           // 2
		    limit = _ref.limit;                                                                                              // 2
		var result = RocketChat.getFullUserData({                                                                            // 3
			userId: Meteor.userId(),                                                                                            // 3
			filter: filter,                                                                                                     // 3
			limit: limit                                                                                                        // 3
		});                                                                                                                  // 3
                                                                                                                       //
		if (!result) {                                                                                                       // 5
			return result;                                                                                                      // 6
		}                                                                                                                    // 7
                                                                                                                       //
		return result.fetch();                                                                                               // 9
	}                                                                                                                     // 10
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getRoomRoles.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getRoomRoles.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getRoomRoles: function (rid) {                                                                                        // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'getRoomRoles'                                                                                             // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		check(rid, String);                                                                                                  // 10
		var options = {                                                                                                      // 12
			sort: {                                                                                                             // 13
				'u.username': 1                                                                                                    // 14
			},                                                                                                                  // 13
			fields: {                                                                                                           // 16
				rid: 1,                                                                                                            // 17
				u: 1,                                                                                                              // 18
				roles: 1                                                                                                           // 19
			}                                                                                                                   // 16
		};                                                                                                                   // 12
		var roles = RocketChat.models.Roles.find({                                                                           // 23
			scope: 'Subscriptions',                                                                                             // 23
			description: {                                                                                                      // 23
				$exists: 1,                                                                                                        // 23
				$ne: ''                                                                                                            // 23
			}                                                                                                                   // 23
		}).fetch();                                                                                                          // 23
		return RocketChat.models.Subscriptions.findByRoomIdAndRoles(rid, _.pluck(roles, '_id'), options).fetch();            // 24
	}                                                                                                                     // 25
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getServerInfo.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getServerInfo.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getServerInfo: function () {                                                                                          // 2
		return RocketChat.Info;                                                                                              // 3
	}                                                                                                                     // 4
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getUserRoles.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getUserRoles.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getUserRoles: function () {                                                                                           // 2
		if (!Meteor.userId()) {                                                                                              // 4
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 5
				method: 'getUserRoles'                                                                                             // 5
			});                                                                                                                 // 5
		}                                                                                                                    // 6
                                                                                                                       //
		var options = {                                                                                                      // 8
			sort: {                                                                                                             // 9
				'username': 1                                                                                                      // 10
			},                                                                                                                  // 9
			fields: {                                                                                                           // 12
				username: 1,                                                                                                       // 13
				roles: 1                                                                                                           // 14
			}                                                                                                                   // 12
		};                                                                                                                   // 8
		var roles = RocketChat.models.Roles.find({                                                                           // 18
			scope: 'Users',                                                                                                     // 18
			description: {                                                                                                      // 18
				$exists: 1,                                                                                                        // 18
				$ne: ''                                                                                                            // 18
			}                                                                                                                   // 18
		}).fetch();                                                                                                          // 18
                                                                                                                       //
		var roleIds = _.pluck(roles, '_id'); // Security issue: we should not send all user's roles to all clients, only the 'public' roles
		// We must remove all roles that are not part of the query from the returned users                                   // 22
                                                                                                                       //
                                                                                                                       //
		var users = RocketChat.models.Users.findUsersInRoles(roleIds, null, options).fetch();                                // 23
                                                                                                                       //
		for (var _iterator = users, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
			var _ref;                                                                                                           // 24
                                                                                                                       //
			if (_isArray) {                                                                                                     // 24
				if (_i >= _iterator.length) break;                                                                                 // 24
				_ref = _iterator[_i++];                                                                                            // 24
			} else {                                                                                                            // 24
				_i = _iterator.next();                                                                                             // 24
				if (_i.done) break;                                                                                                // 24
				_ref = _i.value;                                                                                                   // 24
			}                                                                                                                   // 24
                                                                                                                       //
			var user = _ref;                                                                                                    // 24
			user.roles = _.intersection(user.roles, roleIds);                                                                   // 25
		}                                                                                                                    // 26
                                                                                                                       //
		return users;                                                                                                        // 27
	}                                                                                                                     // 28
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"insertOrUpdateUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/insertOrUpdateUser.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	insertOrUpdateUser: function (userData) {                                                                             // 2
		check(userData, Object);                                                                                             // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'insertOrUpdateUser'                                                                                       // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		return RocketChat.saveUser(Meteor.userId(), userData);                                                               // 10
	}                                                                                                                     // 11
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"joinDefaultChannels.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/joinDefaultChannels.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	joinDefaultChannels: function (silenced) {                                                                            // 2
		check(silenced, Match.Optional(Boolean));                                                                            // 3
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'joinDefaultChannels'                                                                                      // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		this.unblock();                                                                                                      // 9
		return RocketChat.addUserToDefaultChannels(Meteor.user(), silenced);                                                 // 10
	}                                                                                                                     // 11
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"joinRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/joinRoom.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	joinRoom: function (rid, code) {                                                                                      // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'joinRoom'                                                                                                 // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 12
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 13
				method: 'joinRoom'                                                                                                 // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (room.t !== 'c' || RocketChat.authz.hasPermission(Meteor.userId(), 'view-c-room') !== true) {                     // 16
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 17
				method: 'joinRoom'                                                                                                 // 17
			});                                                                                                                 // 17
		}                                                                                                                    // 18
                                                                                                                       //
		if (room.joinCodeRequired === true && code !== room.joinCode) {                                                      // 20
			throw new Meteor.Error('error-code-invalid', 'Invalid Code', {                                                      // 21
				method: 'joinRoom'                                                                                                 // 21
			});                                                                                                                 // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return RocketChat.addUserToRoom(rid, Meteor.user());                                                                 // 24
	}                                                                                                                     // 25
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"leaveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/leaveRoom.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	leaveRoom: function (rid) {                                                                                           // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'leaveRoom'                                                                                                // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		this.unblock();                                                                                                      // 10
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 12
		var user = Meteor.user();                                                                                            // 13
                                                                                                                       //
		if (room.t === 'd') {                                                                                                // 15
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 16
				method: 'leaveRoom'                                                                                                // 16
			});                                                                                                                 // 16
		}                                                                                                                    // 17
                                                                                                                       //
		if (!Array.from(room.usernames || []).includes(user.username)) {                                                     // 19
			throw new Meteor.Error('error-user-not-in-room', 'You are not in this room', {                                      // 20
				method: 'leaveRoom'                                                                                                // 20
			});                                                                                                                 // 20
		} // If user is room owner, check if there are other owners. If there isn't anyone else, warn user to set a new owner.
                                                                                                                       //
                                                                                                                       //
		if (RocketChat.authz.hasRole(user._id, 'owner', room._id)) {                                                         // 24
			var numOwners = RocketChat.authz.getUsersInRole('owner', room._id).fetch().length;                                  // 25
                                                                                                                       //
			if (numOwners === 1) {                                                                                              // 26
				throw new Meteor.Error('error-you-are-last-owner', 'You are the last owner. Please set new owner before leaving the room.', {
					method: 'leaveRoom'                                                                                               // 27
				});                                                                                                                // 27
			}                                                                                                                   // 28
		}                                                                                                                    // 29
                                                                                                                       //
		return RocketChat.removeUserFromRoom(rid, Meteor.user());                                                            // 31
	}                                                                                                                     // 32
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"removeOAuthService.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/removeOAuthService.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	removeOAuthService: function (name) {                                                                                 // 2
		check(name, String);                                                                                                 // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'removeOAuthService'                                                                                       // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'add-oauth-service') !== true) {                                 // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'removeOAuthService'                                                                                       // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		name = name.toLowerCase().replace(/[^a-z0-9_]/g, '');                                                                // 14
		name = s.capitalize(name);                                                                                           // 15
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name);                                                     // 16
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-url");                                            // 17
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-token_path");                                     // 18
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-identity_path");                                  // 19
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-authorize_path");                                 // 20
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-scope");                                          // 21
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-token_sent_via");                                 // 22
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-id");                                             // 23
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-secret");                                         // 24
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-button_label_text");                              // 25
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-button_label_color");                             // 26
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-button_color");                                   // 27
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-login_style");                                    // 28
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-username_field");                                 // 29
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-merge_users");                                    // 30
	}                                                                                                                     // 31
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"restartServer.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/restartServer.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	restart_server: function () {                                                                                         // 2
		if (!Meteor.userId()) {                                                                                              // 3
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 4
				method: 'restart_server'                                                                                           // 4
			});                                                                                                                 // 4
		}                                                                                                                    // 5
                                                                                                                       //
		if (RocketChat.authz.hasRole(Meteor.userId(), 'admin') !== true) {                                                   // 7
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 8
				method: 'restart_server'                                                                                           // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		Meteor.setTimeout(function () {                                                                                      // 11
			return process.exit(1);                                                                                             // 11
		}, 2000);                                                                                                            // 11
		return {                                                                                                             // 14
			message: 'The_server_will_restart_in_s_seconds',                                                                    // 15
			params: [2]                                                                                                         // 16
		};                                                                                                                   // 14
	}                                                                                                                     // 18
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"robotMethods.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/robotMethods.coffee.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
Meteor.methods({                                                                                                       //
  'robot.modelCall': function (model, method, args) {                                                                  //
    var call, ref;                                                                                                     //
    check(model, String);                                                                                              //
    check(method, String);                                                                                             //
                                                                                                                       //
    if (!Meteor.userId()) {                                                                                            //
      throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                   //
        method: 'robot.modelCall'                                                                                      //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    if (!RocketChat.authz.hasRole(Meteor.userId(), 'robot')) {                                                         //
      throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                     //
        method: 'robot.modelCall'                                                                                      //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    if (!_.isFunction((ref = RocketChat.models[model]) != null ? ref[method] : void 0)) {                              //
      throw new Meteor.Error('error-invalid-method', 'Invalid method', {                                               //
        method: 'robot.modelCall'                                                                                      //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    call = RocketChat.models[model][method].apply(RocketChat.models[model], args);                                     //
                                                                                                                       //
    if ((call != null ? typeof call.fetch === "function" ? call.fetch() : void 0 : void 0) != null) {                  //
      return call.fetch();                                                                                             //
    } else {                                                                                                           //
      return call;                                                                                                     //
    }                                                                                                                  //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"saveSetting.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/saveSetting.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	saveSetting: function (_id, value, editor) {                                                                          // 2
		if (Meteor.userId() === null) {                                                                                      // 3
			throw new Meteor.Error('error-action-not-allowed', 'Editing settings is not allowed', {                             // 4
				method: 'saveSetting'                                                                                              // 5
			});                                                                                                                 // 4
		}                                                                                                                    // 7
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'edit-privileged-setting')) {                                   // 9
			throw new Meteor.Error('error-action-not-allowed', 'Editing settings is not allowed', {                             // 10
				method: 'saveSetting'                                                                                              // 11
			});                                                                                                                 // 10
		} //Verify the _id passed in is a string.                                                                            // 13
                                                                                                                       //
                                                                                                                       //
		check(_id, String);                                                                                                  // 16
		var setting = RocketChat.models.Settings.db.findOneById(_id); //Verify the value is what it should be                // 18
                                                                                                                       //
		switch (setting.type) {                                                                                              // 21
			case 'roomPick':                                                                                                    // 22
				check(value, [Object]);                                                                                            // 23
				break;                                                                                                             // 24
                                                                                                                       //
			case 'boolean':                                                                                                     // 25
				check(value, Boolean);                                                                                             // 26
				break;                                                                                                             // 27
                                                                                                                       //
			case 'int':                                                                                                         // 28
				check(value, Number);                                                                                              // 29
				break;                                                                                                             // 30
                                                                                                                       //
			default:                                                                                                            // 31
				check(value, String);                                                                                              // 32
				break;                                                                                                             // 33
		}                                                                                                                    // 21
                                                                                                                       //
		RocketChat.settings.updateById(_id, value, editor);                                                                  // 36
		return true;                                                                                                         // 37
	}                                                                                                                     // 38
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendInvitationEmail.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/sendInvitationEmail.coffee.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
Meteor.methods({                                                                                                       //
  sendInvitationEmail: function (emails) {                                                                             //
    var email, error, footer, header, html, i, len, ref, ref1, rfcMailPattern, subject, validEmails;                   //
    check(emails, [String]);                                                                                           //
                                                                                                                       //
    if (!Meteor.userId()) {                                                                                            //
      throw new Meteor.Error('error-invalid-user', "Invalid user", {                                                   //
        method: 'sendInvitationEmail'                                                                                  //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    if (!RocketChat.authz.hasRole(Meteor.userId(), 'admin')) {                                                         //
      throw new Meteor.Error('error-not-allowed', "Not allowed", {                                                     //
        method: 'sendInvitationEmail'                                                                                  //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    rfcMailPattern = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
    validEmails = _.compact(_.map(emails, function (email) {                                                           //
      if (rfcMailPattern.test(email)) {                                                                                //
        return email;                                                                                                  //
      }                                                                                                                //
    }));                                                                                                               //
    header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || "");                           //
    footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || "");                           //
                                                                                                                       //
    if (RocketChat.settings.get('Invitation_Customized')) {                                                            //
      subject = RocketChat.settings.get('Invitation_Subject');                                                         //
      html = RocketChat.settings.get('Invitation_HTML');                                                               //
    } else {                                                                                                           //
      subject = TAPi18n.__('Invitation_Subject_Default', {                                                             //
        lng: ((ref = Meteor.user()) != null ? ref.language : void 0) || RocketChat.settings.get('language') || 'en'    //
      });                                                                                                              //
      html = TAPi18n.__('Invitation_HTML_Default', {                                                                   //
        lng: ((ref1 = Meteor.user()) != null ? ref1.language : void 0) || RocketChat.settings.get('language') || 'en'  //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    subject = RocketChat.placeholders.replace(subject);                                                                //
                                                                                                                       //
    for (i = 0, len = validEmails.length; i < len; i++) {                                                              //
      email = validEmails[i];                                                                                          //
      this.unblock();                                                                                                  //
      html = RocketChat.placeholders.replace(html, {                                                                   //
        email: email                                                                                                   //
      });                                                                                                              //
                                                                                                                       //
      try {                                                                                                            //
        Email.send({                                                                                                   //
          to: email,                                                                                                   //
          from: RocketChat.settings.get('From_Email'),                                                                 //
          subject: subject,                                                                                            //
          html: header + html + footer                                                                                 //
        });                                                                                                            //
      } catch (error1) {                                                                                               //
        error = error1;                                                                                                //
        throw new Meteor.Error('error-email-send-failed', 'Error trying to send email: ' + error.message, {            //
          method: 'sendInvitationEmail',                                                                               //
          message: error.message                                                                                       //
        });                                                                                                            //
      }                                                                                                                //
    }                                                                                                                  //
                                                                                                                       //
    return validEmails;                                                                                                //
  }                                                                                                                    //
});                                                                                                                    //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendMessage.coffee.js":["moment",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/sendMessage.coffee.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
var moment = void 0;                                                                                                   //
module.import('moment', {                                                                                              //
  "default": function (v) {                                                                                            //
    moment = v;                                                                                                        //
  }                                                                                                                    //
}, 0);                                                                                                                 //
                                                                                                                       //
var indexOf = [].indexOf || function (item) {                                                                          //
  for (var i = 0, l = this.length; i < l; i++) {                                                                       //
    if (i in this && this[i] === item) return i;                                                                       //
  }                                                                                                                    //
                                                                                                                       //
  return -1;                                                                                                           //
};                                                                                                                     //
                                                                                                                       //
Meteor.methods({                                                                                                       //
  sendMessage: function (message) {                                                                                    //
    var ref, ref1, room, subscription, tsDiff, user;                                                                   //
    check(message, Object);                                                                                            //
                                                                                                                       //
    if (!Meteor.userId()) {                                                                                            //
      throw new Meteor.Error('error-invalid-user', "Invalid user", {                                                   //
        method: 'sendMessage'                                                                                          //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    if (message.ts) {                                                                                                  //
      tsDiff = Math.abs(moment(message.ts).diff());                                                                    //
                                                                                                                       //
      if (tsDiff > 60000) {                                                                                            //
        throw new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {                   //
          method: 'sendMessage',                                                                                       //
          message_ts: message.ts,                                                                                      //
          server_ts: new Date().getTime()                                                                              //
        });                                                                                                            //
      } else if (tsDiff > 10000) {                                                                                     //
        message.ts = new Date();                                                                                       //
      }                                                                                                                //
    } else {                                                                                                           //
      message.ts = new Date();                                                                                         //
    }                                                                                                                  //
                                                                                                                       //
    if (((ref = message.msg) != null ? ref.length : void 0) > RocketChat.settings.get('Message_MaxAllowedSize')) {     //
      throw new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {           //
        method: 'sendMessage'                                                                                          //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    user = RocketChat.models.Users.findOneById(Meteor.userId(), {                                                      //
      fields: {                                                                                                        //
        username: 1,                                                                                                   //
        name: 1                                                                                                        //
      }                                                                                                                //
    });                                                                                                                //
    room = Meteor.call('canAccessRoom', message.rid, user._id);                                                        //
                                                                                                                       //
    if (!room) {                                                                                                       //
      return false;                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(message.rid, Meteor.userId());             //
                                                                                                                       //
    if (subscription && (subscription.blocked || subscription.blocker)) {                                              //
      RocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {                                                //
        _id: Random.id(),                                                                                              //
        rid: room._id,                                                                                                 //
        ts: new Date(),                                                                                                //
        msg: TAPi18n.__('room_is_blocked', {}, user.language)                                                          //
      });                                                                                                              //
      return false;                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    if (ref1 = user.username, indexOf.call(room.muted || [], ref1) >= 0) {                                             //
      RocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {                                                //
        _id: Random.id(),                                                                                              //
        rid: room._id,                                                                                                 //
        ts: new Date(),                                                                                                //
        msg: TAPi18n.__('You_have_been_muted', {}, user.language)                                                      //
      });                                                                                                              //
      return false;                                                                                                    //
    }                                                                                                                  //
                                                                                                                       //
    if (message.alias == null && RocketChat.settings.get('Message_SetNameToAliasEnabled')) {                           //
      message.alias = user.name;                                                                                       //
    }                                                                                                                  //
                                                                                                                       //
    if (Meteor.settings["public"].sandstorm) {                                                                         //
      message.sandstormSessionId = this.connection.sandstormSessionId();                                               //
    }                                                                                                                  //
                                                                                                                       //
    RocketChat.metrics.messagesSent.inc();                                                                             //
    return RocketChat.sendMessage(user, message, room);                                                                //
  }                                                                                                                    //
});                                                                                                                    //
DDPRateLimiter.addRule({                                                                                               //
  type: 'method',                                                                                                      //
  name: 'sendMessage',                                                                                                 //
  userId: function (userId) {                                                                                          //
    var user;                                                                                                          //
    user = RocketChat.models.Users.findOneById(userId);                                                                //
                                                                                                                       //
    if (!(user != null ? user.roles : void 0)) {                                                                       //
      return true;                                                                                                     //
    }                                                                                                                  //
                                                                                                                       //
    return indexOf.call(user.roles, 'bot') < 0;                                                                        //
  }                                                                                                                    //
}, 5, 1000);                                                                                                           //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}],"sendSMTPTestEmail.coffee.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/sendSMTPTestEmail.coffee.js                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;
Meteor.methods({                                                                                                       //
  sendSMTPTestEmail: function () {                                                                                     //
    var error, footer, header, ref, ref1, user;                                                                        //
                                                                                                                       //
    if (!Meteor.userId()) {                                                                                            //
      throw new Meteor.Error('error-invalid-user', "Invalid user", {                                                   //
        method: 'sendSMTPTestEmail'                                                                                    //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    user = Meteor.user();                                                                                              //
                                                                                                                       //
    if (!((ref = user.emails) != null ? (ref1 = ref[0]) != null ? ref1.address : void 0 : void 0)) {                   //
      throw new Meteor.Error('error-invalid-email', "Invalid email", {                                                 //
        method: 'sendSMTPTestEmail'                                                                                    //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    this.unblock();                                                                                                    //
    header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');                           //
    footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');                           //
    console.log('Sending test email to ' + user.emails[0].address);                                                    //
                                                                                                                       //
    try {                                                                                                              //
      Email.send({                                                                                                     //
        to: user.emails[0].address,                                                                                    //
        from: RocketChat.settings.get('From_Email'),                                                                   //
        subject: "SMTP Test Email",                                                                                    //
        html: header + "<p>You have successfully sent an email</p>" + footer                                           //
      });                                                                                                              //
    } catch (error1) {                                                                                                 //
      error = error1;                                                                                                  //
      throw new Meteor.Error('error-email-send-failed', 'Error trying to send email: ' + error.message, {              //
        method: 'sendSMTPTestEmail',                                                                                   //
        message: error.message                                                                                         //
      });                                                                                                              //
    }                                                                                                                  //
                                                                                                                       //
    return {                                                                                                           //
      message: "Your_mail_was_sent_to_s",                                                                              //
      params: [user.emails[0].address]                                                                                 //
    };                                                                                                                 //
  }                                                                                                                    //
});                                                                                                                    //
DDPRateLimiter.addRule({                                                                                               //
  type: 'method',                                                                                                      //
  name: 'sendSMTPTestEmail',                                                                                           //
  userId: function (userId) {                                                                                          //
    return true;                                                                                                       //
  }                                                                                                                    //
}, 1, 1000);                                                                                                           //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setAdminStatus.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setAdminStatus.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setAdminStatus: function (userId, admin) {                                                                            // 2
		check(userId, String);                                                                                               // 4
		check(admin, Match.Optional(Boolean));                                                                               // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 7
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 8
				method: 'setAdminStatus'                                                                                           // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'assign-admin-role') !== true) {                                 // 11
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 12
				method: 'setAdminStatus'                                                                                           // 12
			});                                                                                                                 // 12
		}                                                                                                                    // 13
                                                                                                                       //
		var user = Meteor.users.findOne({                                                                                    // 15
			_id: userId                                                                                                         // 15
		}, {                                                                                                                 // 15
			fields: {                                                                                                           // 15
				username: 1                                                                                                        // 15
			}                                                                                                                   // 15
		});                                                                                                                  // 15
                                                                                                                       //
		if (admin) {                                                                                                         // 17
			return Meteor.call('authorization:addUserToRole', 'admin', user.username);                                          // 18
		} else {                                                                                                             // 19
			return Meteor.call('authorization:removeUserFromRole', 'admin', user.username);                                     // 20
		}                                                                                                                    // 21
	}                                                                                                                     // 22
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setRealName.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setRealName.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setRealName: function (name) {                                                                                        // 2
		check(name, String);                                                                                                 // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'setRealName'                                                                                              // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var user = Meteor.user();                                                                                            // 10
                                                                                                                       //
		if (user.name === name) {                                                                                            // 12
			return name;                                                                                                        // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (_.trim(name)) {                                                                                                  // 16
			name = _.trim(name);                                                                                                // 17
		}                                                                                                                    // 18
                                                                                                                       //
		if (!RocketChat.models.Users.setName(Meteor.userId(), name)) {                                                       // 20
			throw new Meteor.Error('error-could-not-change-name', 'Could not change name', {                                    // 21
				method: 'setRealName'                                                                                              // 21
			});                                                                                                                 // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return name;                                                                                                         // 24
	}                                                                                                                     // 25
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setUsername.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setUsername.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setUsername: function (username) {                                                                                    // 2
		var param = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                                  // 2
		var joinDefaultChannelsSilenced = param.joinDefaultChannelsSilenced;                                                 // 2
		check(username, String);                                                                                             // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'setUsername'                                                                                              // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var user = Meteor.user();                                                                                            // 10
                                                                                                                       //
		if (user.username && !RocketChat.settings.get('Accounts_AllowUsernameChange')) {                                     // 12
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 13
				method: 'setUsername'                                                                                              // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (user.username === username) {                                                                                    // 16
			return username;                                                                                                    // 17
		}                                                                                                                    // 18
                                                                                                                       //
		var nameValidation = void 0;                                                                                         // 20
                                                                                                                       //
		try {                                                                                                                // 21
			nameValidation = new RegExp("^" + RocketChat.settings.get('UTF8_Names_Validation') + "$");                          // 22
		} catch (error) {                                                                                                    // 23
			nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                   // 24
		}                                                                                                                    // 25
                                                                                                                       //
		if (!nameValidation.test(username)) {                                                                                // 27
			throw new Meteor.Error('username-invalid', _.escape(username) + " is not a valid username, use only letters, numbers, dots, hyphens and underscores");
		}                                                                                                                    // 29
                                                                                                                       //
		if (user.username !== undefined) {                                                                                   // 31
			if (!username.toLowerCase() === user.username.toLowerCase()) {                                                      // 32
				if (!RocketChat.checkUsernameAvailability(username)) {                                                             // 33
					throw new Meteor.Error('error-field-unavailable', "<strong>" + _.escape(username) + "</strong> is already in use :(", {
						method: 'setUsername',                                                                                           // 34
						field: username                                                                                                  // 34
					});                                                                                                               // 34
				}                                                                                                                  // 35
			}                                                                                                                   // 36
		} else if (!RocketChat.checkUsernameAvailability(username)) {                                                        // 37
			throw new Meteor.Error('error-field-unavailable', "<strong>" + _.escape(username) + "</strong> is already in use :(", {
				method: 'setUsername',                                                                                             // 38
				field: username                                                                                                    // 38
			});                                                                                                                 // 38
		}                                                                                                                    // 39
                                                                                                                       //
		if (!RocketChat.setUsername(user._id, username)) {                                                                   // 41
			throw new Meteor.Error('error-could-not-change-username', 'Could not change username', {                            // 42
				method: 'setUsername'                                                                                              // 42
			});                                                                                                                 // 42
		}                                                                                                                    // 43
                                                                                                                       //
		if (!user.username) {                                                                                                // 45
			Meteor.runAsUser(user._id, function () {                                                                            // 46
				return Meteor.call('joinDefaultChannels', joinDefaultChannelsSilenced);                                            // 46
			});                                                                                                                 // 46
			Meteor.defer(function () {                                                                                          // 47
				return RocketChat.callbacks.run('afterCreateUser', RocketChat.models.Users.findOneById(user._id));                 // 48
			});                                                                                                                 // 49
		}                                                                                                                    // 50
                                                                                                                       //
		return username;                                                                                                     // 52
	}                                                                                                                     // 53
});                                                                                                                    // 1
RocketChat.RateLimiter.limitMethod('setUsername', 1, 1000, {                                                           // 56
	userId: function () {                                                                                                 // 57
		return true;                                                                                                         // 57
	}                                                                                                                     // 57
});                                                                                                                    // 56
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setEmail.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setEmail.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setEmail: function (email) {                                                                                          // 2
		check(email, String);                                                                                                // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'setEmail'                                                                                                 // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var user = Meteor.user();                                                                                            // 10
                                                                                                                       //
		if (!RocketChat.settings.get('Accounts_AllowEmailChange')) {                                                         // 12
			throw new Meteor.Error('error-action-not-allowed', 'Changing email is not allowed', {                               // 13
				method: 'setEmail',                                                                                                // 13
				action: 'Changing_email'                                                                                           // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (user.emails && user.emails[0] && user.emails[0].address === email) {                                             // 16
			return email;                                                                                                       // 17
		}                                                                                                                    // 18
                                                                                                                       //
		if (!RocketChat.setEmail(user._id, email)) {                                                                         // 20
			throw new Meteor.Error('error-could-not-change-email', 'Could not change email', {                                  // 21
				method: 'setEmail'                                                                                                 // 21
			});                                                                                                                 // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return email;                                                                                                        // 24
	}                                                                                                                     // 25
});                                                                                                                    // 1
RocketChat.RateLimiter.limitMethod('setEmail', 1, 1000, {                                                              // 28
	userId: function () /*userId*/{                                                                                       // 29
		return true;                                                                                                         // 29
	}                                                                                                                     // 29
});                                                                                                                    // 28
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"unarchiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/unarchiveRoom.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	unarchiveRoom: function (rid) {                                                                                       // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'unarchiveRoom'                                                                                            // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 12
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 13
				method: 'unarchiveRoom'                                                                                            // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'unarchive-room', room._id)) {                                  // 16
			throw new Meteor.Error('error-not-authorized', 'Not authorized', {                                                  // 17
				method: 'unarchiveRoom'                                                                                            // 17
			});                                                                                                                 // 17
		}                                                                                                                    // 18
                                                                                                                       //
		return RocketChat.unarchiveRoom(rid);                                                                                // 20
	}                                                                                                                     // 21
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"unblockUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/unblockUser.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	unblockUser: function (_ref) {                                                                                        // 2
		var rid = _ref.rid,                                                                                                  // 2
		    blocked = _ref.blocked;                                                                                          // 2
		check(rid, String);                                                                                                  // 4
		check(blocked, String);                                                                                              // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 7
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 8
				method: 'blockUser'                                                                                                // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());                   // 11
		var subscription2 = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, blocked);                          // 12
                                                                                                                       //
		if (!subscription || !subscription2) {                                                                               // 14
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 15
				method: 'blockUser'                                                                                                // 15
			});                                                                                                                 // 15
		}                                                                                                                    // 16
                                                                                                                       //
		RocketChat.models.Subscriptions.unsetBlockedByRoomId(rid, blocked, Meteor.userId());                                 // 18
		return true;                                                                                                         // 20
	}                                                                                                                     // 21
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"updateMessage.js":["moment",function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/updateMessage.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.import('moment', {                                                                                              // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
Meteor.methods({                                                                                                       // 3
	updateMessage: function (message) {                                                                                   // 4
		check(message, Match.ObjectIncluding({                                                                               // 6
			_id: String                                                                                                         // 6
		}));                                                                                                                 // 6
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 8
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 9
				method: 'updateMessage'                                                                                            // 9
			});                                                                                                                 // 9
		}                                                                                                                    // 10
                                                                                                                       //
		var originalMessage = RocketChat.models.Messages.findOneById(message._id);                                           // 12
                                                                                                                       //
		if (!originalMessage || !originalMessage._id) {                                                                      // 14
			return;                                                                                                             // 15
		}                                                                                                                    // 16
                                                                                                                       //
		var hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'edit-message', message.rid);                    // 18
		var editAllowed = RocketChat.settings.get('Message_AllowEditing');                                                   // 19
		var editOwn = originalMessage.u && originalMessage.u._id === Meteor.userId();                                        // 20
                                                                                                                       //
		if (!hasPermission && (!editAllowed || !editOwn)) {                                                                  // 22
			throw new Meteor.Error('error-action-not-allowed', 'Message editing not allowed', {                                 // 23
				method: 'updateMessage',                                                                                           // 23
				action: 'Message_editing'                                                                                          // 23
			});                                                                                                                 // 23
		}                                                                                                                    // 24
                                                                                                                       //
		var blockEditInMinutes = RocketChat.settings.get('Message_AllowEditing_BlockEditInMinutes');                         // 26
                                                                                                                       //
		if (Match.test(blockEditInMinutes, Number) && blockEditInMinutes !== 0) {                                            // 27
			var currentTsDiff = void 0,                                                                                         // 28
			    msgTs = void 0;                                                                                                 // 28
                                                                                                                       //
			if (Match.test(originalMessage.ts, Number)) {                                                                       // 29
				msgTs = moment(originalMessage.ts);                                                                                // 29
			}                                                                                                                   // 29
                                                                                                                       //
			if (msgTs) {                                                                                                        // 30
				currentTsDiff = moment().diff(msgTs, 'minutes');                                                                   // 30
			}                                                                                                                   // 30
                                                                                                                       //
			if (currentTsDiff > blockEditInMinutes) {                                                                           // 31
				throw new Meteor.Error('error-message-editing-blocked', 'Message editing is blocked', {                            // 32
					method: 'updateMessage'                                                                                           // 32
				});                                                                                                                // 32
			}                                                                                                                   // 33
		}                                                                                                                    // 34
                                                                                                                       //
		message.u = originalMessage.u;                                                                                       // 36
		return RocketChat.updateMessage(message, Meteor.user());                                                             // 38
	}                                                                                                                     // 39
});                                                                                                                    // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}]}},"startup":{"defaultRoomTypes.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/startup/defaultRoomTypes.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals openRoom */RocketChat.roomTypes.add(null, 0, {                                                              // 1
	template: 'starredRooms',                                                                                             // 4
	icon: 'icon-star'                                                                                                     // 5
});                                                                                                                    // 3
RocketChat.roomTypes.add('c', 10, {                                                                                    // 8
	template: 'channels',                                                                                                 // 9
	icon: 'icon-hash',                                                                                                    // 10
	route: {                                                                                                              // 11
		name: 'channel',                                                                                                     // 12
		path: '/channel/:name',                                                                                              // 13
		action: function (params) {                                                                                          // 14
			return openRoom('c', params.name);                                                                                  // 15
		}                                                                                                                    // 16
	},                                                                                                                    // 11
	findRoom: function (identifier) {                                                                                     // 19
		var query = {                                                                                                        // 20
			t: 'c',                                                                                                             // 21
			name: identifier                                                                                                    // 22
		};                                                                                                                   // 20
		return ChatRoom.findOne(query);                                                                                      // 24
	},                                                                                                                    // 25
	roomName: function (roomData) {                                                                                       // 27
		return roomData.name;                                                                                                // 28
	},                                                                                                                    // 29
	condition: function () {                                                                                              // 31
		return RocketChat.authz.hasAtLeastOnePermission(['view-c-room', 'view-joined-room']);                                // 32
	},                                                                                                                    // 33
	showJoinLink: function (roomId) {                                                                                     // 35
		return !!ChatRoom.findOne({                                                                                          // 36
			_id: roomId,                                                                                                        // 36
			t: 'c'                                                                                                              // 36
		});                                                                                                                  // 36
	}                                                                                                                     // 37
});                                                                                                                    // 8
RocketChat.roomTypes.add('d', 20, {                                                                                    // 40
	template: 'directMessages',                                                                                           // 41
	icon: 'icon-at',                                                                                                      // 42
	route: {                                                                                                              // 43
		name: 'direct',                                                                                                      // 44
		path: '/direct/:username',                                                                                           // 45
		action: function (params) {                                                                                          // 46
			return openRoom('d', params.username);                                                                              // 47
		},                                                                                                                   // 48
		link: function (sub) {                                                                                               // 49
			return {                                                                                                            // 50
				username: sub.name                                                                                                 // 50
			};                                                                                                                  // 50
		}                                                                                                                    // 51
	},                                                                                                                    // 43
	findRoom: function (identifier) {                                                                                     // 54
		var query = {                                                                                                        // 55
			t: 'd',                                                                                                             // 56
			name: identifier                                                                                                    // 57
		};                                                                                                                   // 55
		var subscription = ChatSubscription.findOne(query);                                                                  // 60
                                                                                                                       //
		if (subscription && subscription.rid) {                                                                              // 61
			return ChatRoom.findOne(subscription.rid);                                                                          // 62
		}                                                                                                                    // 63
	},                                                                                                                    // 64
	roomName: function (roomData) {                                                                                       // 66
		var room = ChatSubscription.findOne({                                                                                // 67
			rid: roomData._id                                                                                                   // 67
		}, {                                                                                                                 // 67
			fields: {                                                                                                           // 67
				name: 1                                                                                                            // 67
			}                                                                                                                   // 67
		});                                                                                                                  // 67
		return room && room.name;                                                                                            // 68
	},                                                                                                                    // 69
	condition: function () {                                                                                              // 71
		return RocketChat.authz.hasAtLeastOnePermission(['view-d-room', 'view-joined-room']);                                // 72
	},                                                                                                                    // 73
	getUserStatus: function (roomId) {                                                                                    // 75
		var subscription = RocketChat.models.Subscriptions.findOne({                                                         // 76
			rid: roomId                                                                                                         // 76
		});                                                                                                                  // 76
                                                                                                                       //
		if (subscription == null) {                                                                                          // 77
			return;                                                                                                             // 77
		}                                                                                                                    // 77
                                                                                                                       //
		return Session.get("user_" + subscription.name + "_status");                                                         // 79
	}                                                                                                                     // 80
});                                                                                                                    // 40
RocketChat.roomTypes.add('p', 30, {                                                                                    // 83
	template: 'privateGroups',                                                                                            // 84
	icon: 'icon-lock',                                                                                                    // 85
	route: {                                                                                                              // 86
		name: 'group',                                                                                                       // 87
		path: '/group/:name',                                                                                                // 88
		action: function (params) {                                                                                          // 89
			return openRoom('p', params.name);                                                                                  // 90
		}                                                                                                                    // 91
	},                                                                                                                    // 86
	findRoom: function (identifier) {                                                                                     // 94
		var query = {                                                                                                        // 95
			t: 'p',                                                                                                             // 96
			name: identifier                                                                                                    // 97
		};                                                                                                                   // 95
		return ChatRoom.findOne(query);                                                                                      // 99
	},                                                                                                                    // 100
	roomName: function (roomData) {                                                                                       // 102
		return roomData.name;                                                                                                // 103
	},                                                                                                                    // 104
	condition: function () {                                                                                              // 106
		return RocketChat.authz.hasAllPermission('view-p-room');                                                             // 107
	}                                                                                                                     // 108
});                                                                                                                    // 83
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"rocketchat.info.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/rocketchat.info.js                                                                          //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.Info = {
    "version": "0.53.0",
    "build": {
        "date": "2017-03-02T21:35:45.599Z",
        "nodeVersion": "v4.7.3",
        "arch": "x64",
        "platform": "linux",
        "osRelease": "4.4.0-51-generic",
        "totalMemory": 7843356672,
        "freeMemory": 224792576,
        "cpus": 2
    },
    "travis": {
        "buildNumber": "8231",
        "branch": "0.53.0",
        "tag": "0.53.0"
    },
    "commit": {
        "hash": "0ebae3ac3682f8b71c42712618176aa394ba7575",
        "date": "Thu Mar 2 18:17:49 2017 -0300",
        "author": "Gabriel Engel",
        "subject": "Merge pull request #6222 from RocketChat/geekgonecrazy-patch-1",
        "tag": "0.53.0",
        "branch": "HEAD"
    }
};
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"node_modules":{"bugsnag":{"package.json":function(require,exports){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// ../../.meteor/local/isopacks/rocketchat_lib/npm/node_modules/bugsnag/package.json                                   //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
exports.name = "bugsnag";
exports.version = "1.8.0";
exports.main = "./lib/bugsnag.js";

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"lib":{"bugsnag.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat:lib/node_modules/bugsnag/lib/bugsnag.js                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var domain = require("domain"),
    path = require("path"),
    Utils = require("./utils"),
    Logger = require("./logger"),
    Configuration = require("./configuration"),
    BugsnagError = require("./error"),
    Notification = require("./notification"),
    requestInfo = require("./request_info");

// Ensure we get all stack frames from thrown errors.
Error.stackTraceLimit = Infinity;

function autoNotifyCallback(notifiedError, uncaughtError) {
    if (!uncaughtError) {
        uncaughtError = notifiedError.domain;
    }
    return function(error) {
        if (error) {
            Configuration.logger.error("Bugsnag: error notifying bugsnag.com - " + error);
        }
        if (Configuration.onUncaughtError && uncaughtError) {
            return Configuration.onUncaughtError(notifiedError);
        }
    };
}

var unCaughtErrorHandlerAdded = false;

var Bugsnag = {};

// This allows people to directly play with metaData without knowledge of Configuration
Object.defineProperty(Bugsnag, 'metaData', {
    get: function() {
        return Configuration.metaData;
    },
    set: function(metaData) {
        Configuration.metaData = metaData;
    }
});

// This allows people to directly play with requestData without knowledge of domains
Object.defineProperty(Bugsnag, 'requestData', {
    get: function () {
        return process.domain && process.domain._bugsnagOptions;
    },

    set: function (requestData) {
        if (process.domain) {
            process.domain._bugsnagOptions = requestData;
        }
    }
});

// Register sets api key and will configure bugsnag based on options
Bugsnag.register = function(apiKey, options) {
    if (!options) {
        options = {};
    }
    Configuration.apiKey = apiKey;
    Bugsnag.configure(options);
    Configuration.logger.info("Registered with apiKey " + apiKey);
    return Bugsnag;
};

// Configure bugsnag using the provided options
Bugsnag.configure = function(options) {
    Configuration.configure(options);

    // If we should auto notify we also configure the uncaught exception handler, we can't do this
    // by default as it changes the way the app response by removing the default handler.
    if (Configuration.autoNotifyUncaught && !unCaughtErrorHandlerAdded) {
        unCaughtErrorHandlerAdded = true;
        Configuration.logger.info("Configuring uncaughtExceptionHandler");
        process.on("uncaughtException", function(err) {
            Bugsnag.notify(err, {
                severity: "error"
            }, autoNotifyCallback(err, true));
        });
    }
};

// Only error is required and that can be a string or error object
Bugsnag.notify = function(error, options, cb) {
    var bugsnagErrors, notification;
    if (Utils.typeOf(options) === "function") {
        cb = options;
        options = {};
    }
    if (!options) {
        options = {};
    }
    if (!Bugsnag.shouldNotify()) {
        if (cb) {
            if (!Configuration.apiKey) {
                cb(new Error("Bugsnag has not been configured with an api key!"));
            } else {
                cb(new Error("Current release stage not permitted to send events to Bugsnag."));
            }
        }
        return;
    }
    Configuration.logger.info("Notifying Bugsnag of exception...\n" + (error && error.stack || error));
    bugsnagErrors = BugsnagError.buildErrors(error, options.errorName);
    delete options.errorName;
    notification = new Notification(bugsnagErrors, options);
    if (Configuration.sendCode === true) {
        notification.loadCode(function () {
            notification.deliver(cb);
        });
    } else {
        notification.deliver(cb);
    }
};

// The error handler express/connext middleware. Performs a notify
Bugsnag.errorHandler = function(err, req, res, next) {
    Configuration.logger.info("Handling express error: " + (err.stack || err));
    Bugsnag.notify(err, {
        req: req,
        severity: "error"
    }, autoNotifyCallback(err));
    return next(err);
};

// The request middleware for express/connect. Ensures next(err) is called when there is an error, and
// tracks the request for manual notifies.
Bugsnag.requestHandler = function(req, res, next) {
    var dom;
    dom = domain.create();
    dom._bugsnagOptions = {
        cleanedRequest: requestInfo(req)
    };
    dom.on('error', next);
    return dom.run(next);
};

Bugsnag.restifyHandler = function(req, res, route, err) {
    Bugsnag.notify(err, {
        req: req,
        severity: "error"
    }, autoNotifyCallback(err));
};

Bugsnag.koaHandler = function(err, ctx) {
    var request;
    Configuration.logger.info("Handling koa error: " + (err.stack || err));
    request = ctx.req;
    request.protocol = ctx.request.protocol;
    request.host = ctx.request.host.split(':', 1)[0];
    return Bugsnag.notify(err, {
        req: request,
        severity: "error"
    }, autoNotifyCallback(err));
};

// Intercepts the first argument from a callback and interprets it as an error.
// if the error is not null it notifies bugsnag and doesn't call the callback
Bugsnag.intercept = function(cb) {
    if (!cb) {
        cb = (function() {});
    }
    if (process.domain) {
        return process.domain.intercept(cb);
    } else {
        return function() {
            var err = arguments[0];
            var args = Array.prototype.slice.call(arguments, 1);
            if (err && (err instanceof Error)) {
                return Bugsnag.notify(err, {
                    severity: "error"
                }, autoNotifyCallback(err));
            }
            if (cb) {
                return cb.apply(null, args);
            }
        };
    }
};

// Automatically notifies of uncaught exceptions in the callback and error
// event emitters. Returns an event emitter, you can hook into .on("error") if
// you want to.
Bugsnag.autoNotify = function(options, cb) {
    var dom;
    if (Utils.typeOf(options) === "function") {
        cb = options;
        options = {};
    }
    dom = domain.create();
    dom._bugsnagOptions = options;
    options.severity = "error";
    dom.on('error', function(err) {
        return Bugsnag.notify(err, options, autoNotifyCallback(err));
    });
    process.nextTick(function() {
        return dom.run(cb);
    });
    return dom;
};

Bugsnag.shouldNotify = function() {
    return (Configuration.notifyReleaseStages === null || Configuration.notifyReleaseStages.indexOf(Configuration.releaseStage) !== -1) && Configuration.apiKey;
};

Bugsnag.onBeforeNotify = function (callback) {
    if (typeof callback !== "function") {
        throw new Error("must pass a callback to onBeforeNotify");
    }

    Configuration.beforeNotifyCallbacks.push(callback);
};

module.exports = Bugsnag;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}},"prom-client":{"package.json":function(require,exports){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// ../../.meteor/local/isopacks/rocketchat_lib/npm/node_modules/prom-client/package.json                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
exports.name = "prom-client";
exports.version = "7.0.1";
exports.main = "index.js";

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"index.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat:lib/node_modules/prom-client/index.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/**
 * Prometheus client
 * @module Prometheus client
 */

'use strict';

exports.register = require('./lib/register');

exports.Counter = require('./lib/counter');
exports.Gauge = require('./lib/gauge');
exports.Histogram = require('./lib/histogram');
exports.Summary = require('./lib/summary');
exports.Pushgateway = require('./lib/pushgateway');

exports.linearBuckets = require('./lib/bucketGenerators').linearBuckets;
exports.exponentialBuckets = require('./lib/bucketGenerators').exponentialBuckets;

var defaultMetrics = require('./lib/defaultMetrics');

defaultMetrics();

exports.defaultMetrics = defaultMetrics;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"lokijs":{"package.json":function(require,exports){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// ../../.meteor/local/isopacks/rocketchat_lib/npm/node_modules/lokijs/package.json                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
exports.name = "lokijs";
exports.version = "1.4.1";
exports.main = "src/lokijs.js";

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"src":{"lokijs.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat:lib/node_modules/lokijs/src/lokijs.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/**
 * LokiJS
 * @author Joe Minichino <joe.minichino@gmail.com>
 *
 * A lightweight document oriented javascript database
 */
(function (root, factory) {
  if (typeof define === 'function' && define.amd) {
    // AMD
    define([], factory);
  } else if (typeof exports === 'object') {
    // CommonJS
    module.exports = factory();
  } else {
    // Browser globals
    root.loki = factory();
  }
}(this, function () {

  return (function () {
    'use strict';

    var hasOwnProperty = Object.prototype.hasOwnProperty;

    var Utils = {
      copyProperties: function (src, dest) {
        var prop;
        for (prop in src) {
          dest[prop] = src[prop];
        }
      },
      // used to recursively scan hierarchical transform step object for param substitution
      resolveTransformObject: function (subObj, params, depth) {
        var prop,
          pname;

        if (typeof depth !== 'number') {
          depth = 0;
        }

        if (++depth >= 10) return subObj;

        for (prop in subObj) {
          if (typeof subObj[prop] === 'string' && subObj[prop].indexOf("[%lktxp]") === 0) {
            pname = subObj[prop].substring(8);
            if (params.hasOwnProperty(pname)) {
              subObj[prop] = params[pname];
            }
          } else if (typeof subObj[prop] === "object") {
            subObj[prop] = Utils.resolveTransformObject(subObj[prop], params, depth);
          }
        }

        return subObj;
      },
      // top level utility to resolve an entire (single) transform (array of steps) for parameter substitution
      resolveTransformParams: function (transform, params) {
        var idx,
          clonedStep,
          resolvedTransform = [];

        if (typeof params === 'undefined') return transform;

        // iterate all steps in the transform array
        for (idx = 0; idx < transform.length; idx++) {
          // clone transform so our scan and replace can operate directly on cloned transform
          clonedStep = JSON.parse(JSON.stringify(transform[idx]));
          resolvedTransform.push(Utils.resolveTransformObject(clonedStep, params));
        }

        return resolvedTransform;
      }
    };

    /** Helper function for determining 'less-than' conditions for ops, sorting, and binary indices.
     *     In the future we might want $lt and $gt ops to use their own functionality/helper.
     *     Since binary indices on a property might need to index [12, NaN, new Date(), Infinity], we
     *     need this function (as well as gtHelper) to always ensure one value is LT, GT, or EQ to another.
     */
    function ltHelper(prop1, prop2, equal) {
      var cv1, cv2;

      // 'falsy' and Boolean handling
      if (!prop1 || !prop2 || prop1 === true || prop2 === true) {
        if ((prop1 === true || prop1 === false) && (prop2 === true || prop2 === false)) {
          if (equal) {
            return prop1 === prop2;
          } else {
            if (prop1) {
              return false;
            } else {
              return prop2;
            }
          }
        }

        if (prop2 === undefined || prop2 === null || prop1 === true || prop2 === false) {
          return equal;
        }
        if (prop1 === undefined || prop1 === null || prop1 === false || prop2 === true) {
          return true;
        }
      }

      if (prop1 === prop2) {
        return equal;
      }

      if (prop1 < prop2) {
        return true;
      }

      if (prop1 > prop2) {
        return false;
      }

      // not strict equal nor less than nor gt so must be mixed types, convert to string and use that to compare
      cv1 = prop1.toString();
      cv2 = prop2.toString();

      if (cv1 == cv2) {
        return equal;
      }

      if (cv1 < cv2) {
        return true;
      }

      return false;
    }

    function gtHelper(prop1, prop2, equal) {
      var cv1, cv2;

      // 'falsy' and Boolean handling
      if (!prop1 || !prop2 || prop1 === true || prop2 === true) {
        if ((prop1 === true || prop1 === false) && (prop2 === true || prop2 === false)) {
          if (equal) {
            return prop1 === prop2;
          } else {
            if (prop1) {
              return !prop2;
            } else {
              return false;
            }
          }
        }

        if (prop1 === undefined || prop1 === null || prop1 === false || prop2 === true) {
          return equal;
        }
        if (prop2 === undefined || prop2 === null || prop1 === true || prop2 === false) {
          return true;
        }
      }

      if (prop1 === prop2) {
        return equal;
      }

      if (prop1 > prop2) {
        return true;
      }

      if (prop1 < prop2) {
        return false;
      }

      // not strict equal nor less than nor gt so must be mixed types, convert to string and use that to compare
      cv1 = prop1.toString();
      cv2 = prop2.toString();

      if (cv1 == cv2) {
        return equal;
      }

      if (cv1 > cv2) {
        return true;
      }

      return false;
    }

    function sortHelper(prop1, prop2, desc) {
      if (prop1 === prop2) {
        return 0;
      }

      if (ltHelper(prop1, prop2, false)) {
        return (desc) ? (1) : (-1);
      }

      if (gtHelper(prop1, prop2, false)) {
        return (desc) ? (-1) : (1);
      }

      // not lt, not gt so implied equality-- date compatible
      return 0;
    }

    /**
     * compoundeval() - helper function for compoundsort(), performing individual object comparisons
     *
     * @param {array} properties - array of property names, in order, by which to evaluate sort order
     * @param {object} obj1 - first object to compare
     * @param {object} obj2 - second object to compare
     * @returns {integer} 0, -1, or 1 to designate if identical (sortwise) or which should be first
     */
    function compoundeval(properties, obj1, obj2) {
      var res = 0;
      var prop, field;
      for (var i = 0, len = properties.length; i < len; i++) {
        prop = properties[i];
        field = prop[0];
        res = sortHelper(obj1[field], obj2[field], prop[1]);
        if (res !== 0) {
          return res;
        }
      }
      return 0;
    }

    /**
     * dotSubScan - helper function used for dot notation queries.
     *
     * @param {object} root - object to traverse
     * @param {array} paths - array of properties to drill into
     * @param {function} fun - evaluation function to test with
     * @param {any} value - comparative value to also pass to (compare) fun
     */
    function dotSubScan(root, paths, fun, value) {
      var path = paths[0];
      if (typeof root === 'undefined' || root === null || !root.hasOwnProperty(path)) {
        return false;
      }

      var valueFound = false;
      var element = root[path];
      if (Array.isArray(element)) {
        var index;
        for (index in element) {
          valueFound = valueFound || dotSubScan(element[index], paths.slice(1, paths.length), fun, value);
          if (valueFound === true) {
            break;
          }
        }
      } else if (typeof element === 'object') {
        valueFound = dotSubScan(element, paths.slice(1, paths.length), fun, value);
      } else {
        valueFound = fun(element, value);
      }

      return valueFound;
    }

    function containsCheckFn(a) {
      if (typeof a === 'string' || Array.isArray(a)) {
        return function (b) {
          return a.indexOf(b) !== -1;
        };
      } else if (typeof a === 'object' && a !== null) {
        return function (b) {
          return hasOwnProperty.call(a, b);
        };
      }
      return null;
    }

    function doQueryOp(val, op) {
      for (var p in op) {
        if (hasOwnProperty.call(op, p)) {
          return LokiOps[p](val, op[p]);
        }
      }
      return false;
    }

    var LokiOps = {
      // comparison operators
      // a is the value in the collection
      // b is the query value
      $eq: function (a, b) {
        return a === b;
      },

      // abstract/loose equality
      $aeq: function (a, b) {
        return a == b;
      },

      $ne: function (a, b) {
        // ecma 5 safe test for NaN
        if (b !== b) {
          // ecma 5 test value is not NaN
          return (a === a);
        }

        return a !== b;
      },

      $dteq: function (a, b) {
        if (ltHelper(a, b, false)) {
          return false;
        }
        return !gtHelper(a, b, false);
      },

      $gt: function (a, b) {
        return gtHelper(a, b, false);
      },

      $gte: function (a, b) {
        return gtHelper(a, b, true);
      },

      $lt: function (a, b) {
        return ltHelper(a, b, false);
      },

      $lte: function (a, b) {
        return ltHelper(a, b, true);
      },

      $in: function (a, b) {
        return b.indexOf(a) !== -1;
      },

      $nin: function (a, b) {
        return b.indexOf(a) === -1;
      },

      $keyin: function (a, b) {
        return a in b;
      },

      $nkeyin: function (a, b) {
        return !(a in b);
      },

      $definedin: function (a, b) {
        return b[a] !== undefined;
      },

      $undefinedin: function (a, b) {
        return b[a] === undefined;
      },

      $regex: function (a, b) {
        return b.test(a);
      },

      $containsString: function (a, b) {
        return (typeof a === 'string') && (a.indexOf(b) !== -1);
      },

      $containsNone: function (a, b) {
        return !LokiOps.$containsAny(a, b);
      },

      $containsAny: function (a, b) {
        var checkFn = containsCheckFn(a);
        if (checkFn !== null) {
          return (Array.isArray(b)) ? (b.some(checkFn)) : (checkFn(b));
        }
        return false;
      },

      $contains: function (a, b) {
        var checkFn = containsCheckFn(a);
        if (checkFn !== null) {
          return (Array.isArray(b)) ? (b.every(checkFn)) : (checkFn(b));
        }
        return false;
      },

      $type: function (a, b) {
        var type = typeof a;
        if (type === 'object') {
          if (Array.isArray(a)) {
            type = 'array';
          } else if (a instanceof Date) {
            type = 'date';
          }
        }
        return (typeof b !== 'object') ? (type === b) : doQueryOp(type, b);
      },

      $size: function (a, b) {
        if (Array.isArray(a)) {
          return (typeof b !== 'object') ? (a.length === b) : doQueryOp(a.length, b);
        }
        return false;
      },

      $len: function (a, b) {
        if (typeof a === 'string') {
          return (typeof b !== 'object') ? (a.length === b) : doQueryOp(a.length, b);
        }
        return false;
      },

      $where: function (a, b) {
        return b(a) === true;
      },

      // field-level logical operators
      // a is the value in the collection
      // b is the nested query operation (for '$not')
      //   or an array of nested query operations (for '$and' and '$or')
      $not: function (a, b) {
        return !doQueryOp(a, b);
      },

      $and: function (a, b) {
        for (var idx = 0, len = b.length; idx < len; idx += 1) {
          if (!doQueryOp(a, b[idx])) {
            return false;
          }
        }
        return true;
      },

      $or: function (a, b) {
        for (var idx = 0, len = b.length; idx < len; idx += 1) {
          if (doQueryOp(a, b[idx])) {
            return true;
          }
        }
        return false;
      }
    };

    // making indexing opt-in... our range function knows how to deal with these ops :
    var indexedOpsList = ['$eq', '$aeq', '$dteq', '$gt', '$gte', '$lt', '$lte'];

    function clone(data, method) {
      var cloneMethod = method || 'parse-stringify',
        cloned;

      switch (cloneMethod) {
      case "parse-stringify":
        cloned = JSON.parse(JSON.stringify(data));
        break;
      case "jquery-extend-deep":
        cloned = jQuery.extend(true, {}, data);
        break;
      case "shallow":
        cloned = Object.create(data.prototype || null);
        Object.keys(data).map(function (i) {
          cloned[i] = data[i];
        });
        break;
      default:
        break;
      }

      //if (cloneMethod === 'parse-stringify') {
      //  cloned = JSON.parse(JSON.stringify(data));
      //}
      return cloned;
    }

    function cloneObjectArray(objarray, method) {
      var i,
        result = [];

      if (method == "parse-stringify") {
        return clone(objarray, method);
      }

      i = objarray.length - 1;

      for (; i <= 0; i--) {
        result.push(clone(objarray[i], method));
      }

      return result;
    }

    function localStorageAvailable() {
      try {
        return (window && window.localStorage !== undefined && window.localStorage !== null);
      } catch (e) {
        return false;
      }
    }


    /**
     * LokiEventEmitter is a minimalist version of EventEmitter. It enables any
     * constructor that inherits EventEmitter to emit events and trigger
     * listeners that have been added to the event through the on(event, callback) method
     *
     * @constructor LokiEventEmitter
     */
    function LokiEventEmitter() {}

    /**
     * @prop {hashmap} events - a hashmap, with each property being an array of callbacks
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.events = {};

    /**
     * @prop {boolean} asyncListeners - boolean determines whether or not the callbacks associated with each event
     * should happen in an async fashion or not
     * Default is false, which means events are synchronous
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.asyncListeners = false;

    /**
     * on(eventName, listener) - adds a listener to the queue of callbacks associated to an event
     * @param {string} eventName - the name of the event to listen to
     * @param {function} listener - callback function of listener to attach
     * @returns {int} the index of the callback in the array of listeners for a particular event
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.on = function (eventName, listener) {
      var event = this.events[eventName];
      if (!event) {
        event = this.events[eventName] = [];
      }
      event.push(listener);
      return listener;
    };

    /**
     * emit(eventName, data) - emits a particular event
     * with the option of passing optional parameters which are going to be processed by the callback
     * provided signatures match (i.e. if passing emit(event, arg0, arg1) the listener should take two parameters)
     * @param {string} eventName - the name of the event
     * @param {object=} data - optional object passed with the event
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.emit = function (eventName, data) {
      var self = this;
      if (eventName && this.events[eventName]) {
        this.events[eventName].forEach(function (listener) {
          if (self.asyncListeners) {
            setTimeout(function () {
              listener(data);
            }, 1);
          } else {
            listener(data);
          }

        });
      } else {
        throw new Error('No event ' + eventName + ' defined');
      }
    };

    /**
     * removeListener() - removes the listener at position 'index' from the event 'eventName'
     * @param {string} eventName - the name of the event which the listener is attached to
     * @param {function} listener - the listener callback function to remove from emitter
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.removeListener = function (eventName, listener) {
      if (this.events[eventName]) {
        var listeners = this.events[eventName];
        listeners.splice(listeners.indexOf(listener), 1);
      }
    };

    /**
     * Loki: The main database class
     * @constructor Loki
     * @implements LokiEventEmitter
     * @param {string} filename - name of the file to be saved to
     * @param {object=} options - (Optional) config options object
     * @param {string} options.env - override environment detection as 'NODEJS', 'BROWSER', 'CORDOVA'
     * @param {boolean} options.verbose - enable console output (default is 'false')
     * @param {boolean} options.autosave - enables autosave
     * @param {int} options.autosaveInterval - time interval (in milliseconds) between saves (if dirty)
     * @param {boolean} options.autoload - enables autoload on loki instantiation
     * @param {function} options.autoloadCallback - user callback called after database load
     * @param {adapter} options.adapter - an instance of a loki persistence adapter
     */
    function Loki(filename, options) {
      this.filename = filename || 'loki.db';
      this.collections = [];

      // persist version of code which created the database to the database.
      // could use for upgrade scenarios
      this.databaseVersion = 1.1;
      this.engineVersion = 1.1;

      // autosave support (disabled by default)
      // pass autosave: true, autosaveInterval: 6000 in options to set 6 second autosave
      this.autosave = false;
      this.autosaveInterval = 5000;
      this.autosaveHandle = null;

      this.options = {};

      // currently keeping persistenceMethod and persistenceAdapter as loki level properties that
      // will not or cannot be deserialized.  You are required to configure persistence every time
      // you instantiate a loki object (or use default environment detection) in order to load the database anyways.

      // persistenceMethod could be 'fs', 'localStorage', or 'adapter'
      // this is optional option param, otherwise environment detection will be used
      // if user passes their own adapter we will force this method to 'adapter' later, so no need to pass method option.
      this.persistenceMethod = null;

      // retain reference to optional (non-serializable) persistenceAdapter 'instance'
      this.persistenceAdapter = null;

      // enable console output if verbose flag is set (disabled by default)
      this.verbose = options && options.hasOwnProperty('verbose') ? options.verbose : false;

      this.events = {
        'init': [],
        'loaded': [],
        'flushChanges': [],
        'close': [],
        'changes': [],
        'warning': []
      };

      var getENV = function () {
        // if (typeof global !== 'undefined' && (global.android || global.NSObject)) {
        //   //If no adapter is set use the default nativescript adapter
        //   if (!options.adapter) {
        //     var LokiNativescriptAdapter = require('./loki-nativescript-adapter');
        //     options.adapter=new LokiNativescriptAdapter();
        //   }
        //   return 'NATIVESCRIPT'; //nativescript
        // }

        if (typeof window === 'undefined') {
          return 'NODEJS';
        }

        if (typeof global !== 'undefined' && global.window) {
          return 'NODEJS'; //node-webkit
        }

        if (typeof document !== 'undefined') {
          if (document.URL.indexOf('http://') === -1 && document.URL.indexOf('https://') === -1) {
            return 'CORDOVA';
          }
          return 'BROWSER';
        }
        return 'CORDOVA';
      };

      // refactored environment detection due to invalid detection for browser environments.
      // if they do not specify an options.env we want to detect env rather than default to nodejs.
      // currently keeping two properties for similar thing (options.env and options.persistenceMethod)
      //   might want to review whether we can consolidate.
      if (options && options.hasOwnProperty('env')) {
        this.ENV = options.env;
      } else {
        this.ENV = getENV();
      }

      // not sure if this is necessary now that i have refactored the line above
      if (this.ENV === 'undefined') {
        this.ENV = 'NODEJS';
      }

      //if (typeof (options) !== 'undefined') {
      this.configureOptions(options, true);
      //}

      this.on('init', this.clearChanges);

    }

    // db class is an EventEmitter
    Loki.prototype = new LokiEventEmitter();

    // experimental support for browserify's abstract syntax scan to pick up dependency of indexed adapter.
    // Hopefully, once this hits npm a browserify require of lokijs should scan the main file and detect this indexed adapter reference.
    Loki.prototype.getIndexedAdapter = function () {
      var adapter;

      if (typeof require === 'function') {
        adapter = require("./loki-indexed-adapter.js");
      }

      return adapter;
    };


    /**
     * Allows reconfiguring database options
     *
     * @param {object} options - configuration options to apply to loki db object
     * @param {string} options.env - override environment detection as 'NODEJS', 'BROWSER', 'CORDOVA'
     * @param {boolean} options.verbose - enable console output (default is 'false')
     * @param {boolean} options.autosave - enables autosave
     * @param {int} options.autosaveInterval - time interval (in milliseconds) between saves (if dirty)
     * @param {boolean} options.autoload - enables autoload on loki instantiation
     * @param {function} options.autoloadCallback - user callback called after database load
     * @param {adapter} options.adapter - an instance of a loki persistence adapter
     * @param {boolean} initialConfig - (internal) true is passed when loki ctor is invoking
     * @memberof Loki
     */
    Loki.prototype.configureOptions = function (options, initialConfig) {
      var defaultPersistence = {
          'NODEJS': 'fs',
          'BROWSER': 'localStorage',
          'CORDOVA': 'localStorage'
        },
        persistenceMethods = {
          'fs': LokiFsAdapter,
          'localStorage': LokiLocalStorageAdapter
        };

      this.options = {};

      this.persistenceMethod = null;
      // retain reference to optional persistence adapter 'instance'
      // currently keeping outside options because it can't be serialized
      this.persistenceAdapter = null;

      // process the options
      if (typeof (options) !== 'undefined') {
        this.options = options;


        if (this.options.hasOwnProperty('persistenceMethod')) {
          // check if the specified persistence method is known
          if (typeof (persistenceMethods[options.persistenceMethod]) == 'function') {
            this.persistenceMethod = options.persistenceMethod;
            this.persistenceAdapter = new persistenceMethods[options.persistenceMethod]();
          }
          // should be throw an error here, or just fall back to defaults ??
        }

        // if user passes adapter, set persistence mode to adapter and retain persistence adapter instance
        if (this.options.hasOwnProperty('adapter')) {
          this.persistenceMethod = 'adapter';
          this.persistenceAdapter = options.adapter;
          this.options.adapter = null;
        }


        // if they want to load database on loki instantiation, now is a good time to load... after adapter set and before possible autosave initiation
        if (options.autoload && initialConfig) {
          // for autoload, let the constructor complete before firing callback
          var self = this;
          setTimeout(function () {
            self.loadDatabase(options, options.autoloadCallback);
          }, 1);
        }

        if (this.options.hasOwnProperty('autosaveInterval')) {
          this.autosaveDisable();
          this.autosaveInterval = parseInt(this.options.autosaveInterval, 10);
        }

        if (this.options.hasOwnProperty('autosave') && this.options.autosave) {
          this.autosaveDisable();
          this.autosave = true;

          if (this.options.hasOwnProperty('autosaveCallback')) {
            this.autosaveEnable(options, options.autosaveCallback);
          } else {
            this.autosaveEnable();
          }
        }
      } // end of options processing

      // if by now there is no adapter specified by user nor derived from persistenceMethod: use sensible defaults
      if (this.persistenceAdapter === null) {
        this.persistenceMethod = defaultPersistence[this.ENV];
        if (this.persistenceMethod) {
          this.persistenceAdapter = new persistenceMethods[this.persistenceMethod]();
        }
      }

    };

    /**
     * Shorthand method for quickly creating and populating an anonymous collection.
     *    This collection is not referenced internally so upon losing scope it will be garbage collected.
     *
     * @example
     * var results = new loki().anonym(myDocArray).find({'age': {'$gt': 30} });
     *
     * @param {Array} docs - document array to initialize the anonymous collection with
     * @param {object} options - configuration object, see {@link Loki#addCollection} options
     * @returns {Collection} New collection which you can query or chain
     * @memberof Loki
     */
    Loki.prototype.anonym = function (docs, options) {
      var collection = new Collection('anonym', options);
      collection.insert(docs);

      if (this.verbose)
        collection.console = console;

      return collection;
    };

    /**
     * Adds a collection to the database.
     * @param {string} name - name of collection to add
     * @param {object=} options - (optional) options to configure collection with.
     * @param {array} options.unique - array of property names to define unique constraints for
     * @param {array} options.exact - array of property names to define exact constraints for
     * @param {array} options.indices - array property names to define binary indexes for
     * @param {boolean} options.asyncListeners - default is false
     * @param {boolean} options.disableChangesApi - default is true
     * @param {boolean} options.autoupdate - use Object.observe to update objects automatically (default: false)
     * @param {boolean} options.clone - specify whether inserts and queries clone to/from user
     * @param {string} options.cloneMethod - 'parse-stringify' (default), 'jquery-extend-deep', 'shallow'
     * @param {int} options.ttlInterval - time interval for clearing out 'aged' documents; not set by default.
     * @returns {Collection} a reference to the collection which was just added
     * @memberof Loki
     */
    Loki.prototype.addCollection = function (name, options) {
      var collection = new Collection(name, options);
      this.collections.push(collection);

      if (this.verbose)
        collection.console = console;

      return collection;
    };

    Loki.prototype.loadCollection = function (collection) {
      if (!collection.name) {
        throw new Error('Collection must have a name property to be loaded');
      }
      this.collections.push(collection);
    };

    /**
     * Retrieves reference to a collection by name.
     * @param {string} collectionName - name of collection to look up
     * @returns {Collection} Reference to collection in database by that name, or null if not found
     * @memberof Loki
     */
    Loki.prototype.getCollection = function (collectionName) {
      var i,
        len = this.collections.length;

      for (i = 0; i < len; i += 1) {
        if (this.collections[i].name === collectionName) {
          return this.collections[i];
        }
      }

      // no such collection
      this.emit('warning', 'collection ' + collectionName + ' not found');
      return null;
    };

    Loki.prototype.listCollections = function () {

      var i = this.collections.length,
        colls = [];

      while (i--) {
        colls.push({
          name: this.collections[i].name,
          type: this.collections[i].objType,
          count: this.collections[i].data.length
        });
      }
      return colls;
    };

    /**
     * Removes a collection from the database.
     * @param {string} collectionName - name of collection to remove
     * @memberof Loki
     */
    Loki.prototype.removeCollection = function (collectionName) {
      var i,
        len = this.collections.length;

      for (i = 0; i < len; i += 1) {
        if (this.collections[i].name === collectionName) {
          var tmpcol = new Collection(collectionName, {});
          var curcol = this.collections[i];
          for (var prop in curcol) {
            if (curcol.hasOwnProperty(prop) && tmpcol.hasOwnProperty(prop)) {
              curcol[prop] = tmpcol[prop];
            }
          }
          this.collections.splice(i, 1);
          return;
        }
      }
    };

    Loki.prototype.getName = function () {
      return this.name;
    };

    /**
     * serializeReplacer - used to prevent certain properties from being serialized
     *
     */
    Loki.prototype.serializeReplacer = function (key, value) {
      switch (key) {
      case 'autosaveHandle':
      case 'persistenceAdapter':
      case 'constraints':
        return null;
      default:
        return value;
      }
    };

    /**
     * Serialize database to a string which can be loaded via {@link Loki#loadJSON}
     *
     * @returns {string} Stringified representation of the loki database.
     * @memberof Loki
     */
    Loki.prototype.serialize = function () {
      return JSON.stringify(this, this.serializeReplacer);
    };
    // alias of serialize
    Loki.prototype.toJson = Loki.prototype.serialize;

    /**
     * Inflates a loki database from a serialized JSON string
     *
     * @param {string} serializedDb - a serialized loki database string
     * @param {object} options - apply or override collection level settings
     * @memberof Loki
     */
    Loki.prototype.loadJSON = function (serializedDb, options) {
      var dbObject;
      if (serializedDb.length === 0) {
        dbObject = {};
      } else {
        dbObject = JSON.parse(serializedDb);
      }

      this.loadJSONObject(dbObject, options);
    };

    /**
     * Inflates a loki database from a JS object
     *
     * @param {object} dbObject - a serialized loki database string
     * @param {object} options - apply or override collection level settings
     * @memberof Loki
     */
    Loki.prototype.loadJSONObject = function (dbObject, options) {
      var i = 0,
        len = dbObject.collections ? dbObject.collections.length : 0,
        coll,
        copyColl,
        clen,
        j;

      this.name = dbObject.name;

      // restore database version
      this.databaseVersion = 1.0;
      if (dbObject.hasOwnProperty('databaseVersion')) {
        this.databaseVersion = dbObject.databaseVersion;
      }

      this.collections = [];

      for (i; i < len; i += 1) {
        coll = dbObject.collections[i];
        copyColl = this.addCollection(coll.name);

        copyColl.transactional = coll.transactional;
        copyColl.asyncListeners = coll.asyncListeners;
        copyColl.disableChangesApi = coll.disableChangesApi;
        copyColl.cloneObjects = coll.cloneObjects;
        copyColl.cloneMethod = coll.cloneMethod || "parse-stringify";
        copyColl.autoupdate = coll.autoupdate;

        // load each element individually
        clen = coll.data.length;
        j = 0;
        if (options && options.hasOwnProperty(coll.name)) {

          var loader = options[coll.name].inflate ? options[coll.name].inflate : Utils.copyProperties;

          for (j; j < clen; j++) {
            var collObj = new(options[coll.name].proto)();
            loader(coll.data[j], collObj);
            copyColl.data[j] = collObj;
            copyColl.addAutoUpdateObserver(collObj);
          }
        } else {

          for (j; j < clen; j++) {
            copyColl.data[j] = coll.data[j];
            copyColl.addAutoUpdateObserver(copyColl.data[j]);
          }
        }

        copyColl.maxId = (coll.data.length === 0) ? 0 : coll.maxId;
        copyColl.idIndex = coll.idIndex;
        if (typeof (coll.binaryIndices) !== 'undefined') {
          copyColl.binaryIndices = coll.binaryIndices;
        }
        if (typeof coll.transforms !== 'undefined') {
          copyColl.transforms = coll.transforms;
        }

        copyColl.ensureId();

        // regenerate unique indexes
        copyColl.uniqueNames = [];
        if (coll.hasOwnProperty("uniqueNames")) {
          copyColl.uniqueNames = coll.uniqueNames;
          for (j = 0; j < copyColl.uniqueNames.length; j++) {
            copyColl.ensureUniqueIndex(copyColl.uniqueNames[j]);
          }
        }

        // in case they are loading a database created before we added dynamic views, handle undefined
        if (typeof (coll.DynamicViews) === 'undefined') continue;

        // reinflate DynamicViews and attached Resultsets
        for (var idx = 0; idx < coll.DynamicViews.length; idx++) {
          var colldv = coll.DynamicViews[idx];

          var dv = copyColl.addDynamicView(colldv.name, colldv.options);
          dv.resultdata = colldv.resultdata;
          dv.resultsdirty = colldv.resultsdirty;
          dv.filterPipeline = colldv.filterPipeline;

          dv.sortCriteria = colldv.sortCriteria;
          dv.sortFunction = null;

          dv.sortDirty = colldv.sortDirty;
          dv.resultset.filteredrows = colldv.resultset.filteredrows;
          dv.resultset.searchIsChained = colldv.resultset.searchIsChained;
          dv.resultset.filterInitialized = colldv.resultset.filterInitialized;

          dv.rematerialize({
            removeWhereFilters: true
          });
        }
      }
    };

    /**
     * Emits the close event. In autosave scenarios, if the database is dirty, this will save and disable timer.
     * Does not actually destroy the db.
     *
     * @param {function=} callback - (Optional) if supplied will be registered with close event before emitting.
     * @memberof Loki
     */
    Loki.prototype.close = function (callback) {
      // for autosave scenarios, we will let close perform final save (if dirty)
      // For web use, you might call from window.onbeforeunload to shutdown database, saving pending changes
      if (this.autosave) {
        this.autosaveDisable();
        if (this.autosaveDirty()) {
          this.saveDatabase(callback);
          callback = undefined;
        }
      }

      if (callback) {
        this.on('close', callback);
      }
      this.emit('close');
    };

    /**-------------------------+
    | Changes API               |
    +--------------------------*/

    /**
     * The Changes API enables the tracking the changes occurred in the collections since the beginning of the session,
     * so it's possible to create a differential dataset for synchronization purposes (possibly to a remote db)
     */

    /**
     * (Changes API) : takes all the changes stored in each
     * collection and creates a single array for the entire database. If an array of names
     * of collections is passed then only the included collections will be tracked.
     *
     * @param {array=} optional array of collection names. No arg means all collections are processed.
     * @returns {array} array of changes
     * @see private method createChange() in Collection
     * @memberof Loki
     */
    Loki.prototype.generateChangesNotification = function (arrayOfCollectionNames) {
      function getCollName(coll) {
        return coll.name;
      }
      var changes = [],
        selectedCollections = arrayOfCollectionNames || this.collections.map(getCollName);

      this.collections.forEach(function (coll) {
        if (selectedCollections.indexOf(getCollName(coll)) !== -1) {
          changes = changes.concat(coll.getChanges());
        }
      });
      return changes;
    };

    /**
     * (Changes API) - stringify changes for network transmission
     * @returns {string} string representation of the changes
     * @memberof Loki
     */
    Loki.prototype.serializeChanges = function (collectionNamesArray) {
      return JSON.stringify(this.generateChangesNotification(collectionNamesArray));
    };

    /**
     * (Changes API) : clears all the changes in all collections.
     * @memberof Loki
     */
    Loki.prototype.clearChanges = function () {
      this.collections.forEach(function (coll) {
        if (coll.flushChanges) {
          coll.flushChanges();
        }
      });
    };

    /*------------------+
    | PERSISTENCE       |
    -------------------*/


    /** there are two build in persistence adapters for internal use
     * fs             for use in Nodejs type environments
     * localStorage   for use in browser environment
     * defined as helper classes here so its easy and clean to use
     */

    /**
     * A loki persistence adapter which persists using node fs module
     * @constructor LokiFsAdapter
     */
    function LokiFsAdapter() {
      this.fs = require('fs');
    }

    /**
     * loadDatabase() - Load data from file, will throw an error if the file does not exist
     * @param {string} dbname - the filename of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiFsAdapter
     */
    LokiFsAdapter.prototype.loadDatabase = function loadDatabase(dbname, callback) {
      this.fs.readFile(dbname, {
        encoding: 'utf8'
      }, function readFileCallback(err, data) {
        if (err) {
          callback(new Error(err));
        } else {
          callback(data);
        }
      });
    };

    /**
     * saveDatabase() - save data to file, will throw an error if the file can't be saved
     * might want to expand this to avoid dataloss on partial save
     * @param {string} dbname - the filename of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiFsAdapter
     */
    LokiFsAdapter.prototype.saveDatabase = function saveDatabase(dbname, dbstring, callback) {
      this.fs.writeFile(dbname, dbstring, callback);
    };

    /**
     * deleteDatabase() - delete the database file, will throw an error if the
     * file can't be deleted
     * @param {string} dbname - the filename of the database to delete
     * @param {function} callback - the callback to handle the result
     * @memberof LokiFsAdapter
     */
    LokiFsAdapter.prototype.deleteDatabase = function deleteDatabase(dbname, callback) {
      this.fs.unlink(dbname, function deleteDatabaseCallback(err) {
        if (err) {
          callback(new Error(err));
        } else {
          callback();
        }
      });
    };


    /**
     * A loki persistence adapter which persists to web browser's local storage object
     * @constructor LokiLocalStorageAdapter
     */
    function LokiLocalStorageAdapter() {}

    /**
     * loadDatabase() - Load data from localstorage
     * @param {string} dbname - the name of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiLocalStorageAdapter
     */
    LokiLocalStorageAdapter.prototype.loadDatabase = function loadDatabase(dbname, callback) {
      if (localStorageAvailable()) {
        callback(localStorage.getItem(dbname));
      } else {
        callback(new Error('localStorage is not available'));
      }
    };

    /**
     * saveDatabase() - save data to localstorage, will throw an error if the file can't be saved
     * might want to expand this to avoid dataloss on partial save
     * @param {string} dbname - the filename of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiLocalStorageAdapter
     */
    LokiLocalStorageAdapter.prototype.saveDatabase = function saveDatabase(dbname, dbstring, callback) {
      if (localStorageAvailable()) {
        localStorage.setItem(dbname, dbstring);
        callback(null);
      } else {
        callback(new Error('localStorage is not available'));
      }
    };

    /**
     * deleteDatabase() - delete the database from localstorage, will throw an error if it
     * can't be deleted
     * @param {string} dbname - the filename of the database to delete
     * @param {function} callback - the callback to handle the result
     * @memberof LokiLocalStorageAdapter
     */
    LokiLocalStorageAdapter.prototype.deleteDatabase = function deleteDatabase(dbname, callback) {
      if (localStorageAvailable()) {
        localStorage.removeItem(dbname);
        callback(null);
      } else {
        callback(new Error('localStorage is not available'));
      }
    };

    /**
     * Handles loading from file system, local storage, or adapter (indexeddb)
     *    This method utilizes loki configuration options (if provided) to determine which
     *    persistence method to use, or environment detection (if configuration was not provided).
     *
     * @param {object} options - not currently used (remove or allow overrides?)
     * @param {function=} callback - (Optional) user supplied async callback / error handler
     * @memberof Loki
     */
    Loki.prototype.loadDatabase = function (options, callback) {
      var cFun = callback || function (err, data) {
          if (err) {
            throw err;
          }
        },
        self = this;

      // the persistenceAdapter should be present if all is ok, but check to be sure.
      if (this.persistenceAdapter !== null) {

        this.persistenceAdapter.loadDatabase(this.filename, function loadDatabaseCallback(dbString) {
          if (typeof (dbString) === 'string') {
            var parseSuccess = false;
            try {
              self.loadJSON(dbString, options || {});
              parseSuccess = true;
            } catch (err) {
              cFun(err);
            }
            if (parseSuccess) {
              cFun(null);
              self.emit('loaded', 'database ' + self.filename + ' loaded');
            }
          } else {
            // if adapter has returned an js object (other than null or error) attempt to load from JSON object
            if (typeof (dbString) === "object" && dbString !== null && !(dbString instanceof Error)) {
              self.loadJSONObject(dbString, options || {});
              cFun(null); // return null on success
              self.emit('loaded', 'database ' + self.filename + ' loaded');
            } else {
              // error from adapter (either null or instance of error), pass on to 'user' callback
              cFun(dbString);
            }
          }
        });

      } else {
        cFun(new Error('persistenceAdapter not configured'));
      }
    };

    /**
     * Handles saving to file system, local storage, or adapter (indexeddb)
     *    This method utilizes loki configuration options (if provided) to determine which
     *    persistence method to use, or environment detection (if configuration was not provided).
     *
     * @param {function=} callback - (Optional) user supplied async callback / error handler
     * @memberof Loki
     */
    Loki.prototype.saveDatabase = function (callback) {
      var cFun = callback || function (err) {
          if (err) {
            throw err;
          }
          return;
        },
        self = this;

      // the persistenceAdapter should be present if all is ok, but check to be sure.
      if (this.persistenceAdapter !== null) {
        // check if the adapter is requesting (and supports) a 'reference' mode export
        if (this.persistenceAdapter.mode === "reference" && typeof this.persistenceAdapter.exportDatabase === "function") {
          // filename may seem redundant but loadDatabase will need to expect this same filename
          this.persistenceAdapter.exportDatabase(this.filename, this, function exportDatabaseCallback(err) {
            self.autosaveClearFlags();
            cFun(err);
          });
        }
        // otherwise just pass the serialized database to adapter
        else {
          this.persistenceAdapter.saveDatabase(this.filename, self.serialize(), function saveDatabasecallback(err) {
            self.autosaveClearFlags();
            cFun(err);
          });
        }
      } else {
        cFun(new Error('persistenceAdapter not configured'));
      }
    };

    // alias
    Loki.prototype.save = Loki.prototype.saveDatabase;

    /**
     * Handles deleting a database from file system, local
     *    storage, or adapter (indexeddb)
     *    This method utilizes loki configuration options (if provided) to determine which
     *    persistence method to use, or environment detection (if configuration was not provided).
     *
     * @param {object} options - not currently used (remove or allow overrides?)
     * @param {function=} callback - (Optional) user supplied async callback / error handler
     * @memberof Loki
     */
    Loki.prototype.deleteDatabase = function (options, callback) {
      var cFun = callback || function (err, data) {
        if (err) {
          throw err;
        }
      };

      // the persistenceAdapter should be present if all is ok, but check to be sure.
      if (this.persistenceAdapter !== null) {
        this.persistenceAdapter.deleteDatabase(this.filename, function deleteDatabaseCallback(err) {
          cFun(err);
        });
      } else {
        cFun(new Error('persistenceAdapter not configured'));
      }
    };

    /**
     * autosaveDirty - check whether any collections are 'dirty' meaning we need to save (entire) database
     *
     * @returns {boolean} - true if database has changed since last autosave, false if not.
     */
    Loki.prototype.autosaveDirty = function () {
      for (var idx = 0; idx < this.collections.length; idx++) {
        if (this.collections[idx].dirty) {
          return true;
        }
      }

      return false;
    };

    /**
     * autosaveClearFlags - resets dirty flags on all collections.
     *    Called from saveDatabase() after db is saved.
     *
     */
    Loki.prototype.autosaveClearFlags = function () {
      for (var idx = 0; idx < this.collections.length; idx++) {
        this.collections[idx].dirty = false;
      }
    };

    /**
     * autosaveEnable - begin a javascript interval to periodically save the database.
     *
     * @param {object} options - not currently used (remove or allow overrides?)
     * @param {function=} callback - (Optional) user supplied async callback
     */
    Loki.prototype.autosaveEnable = function (options, callback) {
      this.autosave = true;

      var delay = 5000,
        self = this;

      if (typeof (this.autosaveInterval) !== 'undefined' && this.autosaveInterval !== null) {
        delay = this.autosaveInterval;
      }

      this.autosaveHandle = setInterval(function autosaveHandleInterval() {
        // use of dirty flag will need to be hierarchical since mods are done at collection level with no visibility of 'db'
        // so next step will be to implement collection level dirty flags set on insert/update/remove
        // along with loki level isdirty() function which iterates all collections to see if any are dirty

        if (self.autosaveDirty()) {
          self.saveDatabase(callback);
        }
      }, delay);
    };

    /**
     * autosaveDisable - stop the autosave interval timer.
     *
     */
    Loki.prototype.autosaveDisable = function () {
      if (typeof (this.autosaveHandle) !== 'undefined' && this.autosaveHandle !== null) {
        clearInterval(this.autosaveHandle);
        this.autosaveHandle = null;
      }
    };


    /**
     * Resultset class allowing chainable queries.  Intended to be instanced internally.
     *    Collection.find(), Collection.where(), and Collection.chain() instantiate this.
     *
     * @example
     *    mycollection.chain()
     *      .find({ 'doors' : 4 })
     *      .where(function(obj) { return obj.name === 'Toyota' })
     *      .data();
     *
     * @constructor Resultset
     * @param {Collection} collection - The collection which this Resultset will query against.
     * @param {Object=} options - Object containing one or more options.
     * @param {string} options.queryObj - Optional mongo-style query object to initialize resultset with.
     * @param {function} options.queryFunc - Optional javascript filter function to initialize resultset with.
     * @param {bool} options.firstOnly - Optional boolean used by collection.findOne().
     */
    function Resultset(collection, options) {
      options = options || {};

      options.queryObj = options.queryObj || null;
      options.queryFunc = options.queryFunc || null;
      options.firstOnly = options.firstOnly || false;

      // retain reference to collection we are querying against
      this.collection = collection;

      // if chain() instantiates with null queryObj and queryFunc, so we will keep flag for later
      this.searchIsChained = (!options.queryObj && !options.queryFunc);
      this.filteredrows = [];
      this.filterInitialized = false;

      // if user supplied initial queryObj or queryFunc, apply it
      if (typeof (options.queryObj) !== "undefined" && options.queryObj !== null) {
        return this.find(options.queryObj, options.firstOnly);
      }
      if (typeof (options.queryFunc) !== "undefined" && options.queryFunc !== null) {
        return this.where(options.queryFunc);
      }

      // otherwise return unfiltered Resultset for future filtering
      return this;
    }

    /**
     * reset() - Reset the resultset to its initial state.
     *
     * @returns {Resultset} Reference to this resultset, for future chain operations.
     */
    Resultset.prototype.reset = function () {
      if (this.filteredrows.length > 0) {
        this.filteredrows = [];
      }
      this.filterInitialized = false;
      return this;
    };

    /**
     * toJSON() - Override of toJSON to avoid circular references
     *
     */
    Resultset.prototype.toJSON = function () {
      var copy = this.copy();
      copy.collection = null;
      return copy;
    };

    /**
     * Allows you to limit the number of documents passed to next chain operation.
     *    A resultset copy() is made to avoid altering original resultset.
     *
     * @param {int} qty - The number of documents to return.
     * @returns {Resultset} Returns a copy of the resultset, limited by qty, for subsequent chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.limit = function (qty) {
      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var rscopy = new Resultset(this.collection);
      rscopy.filteredrows = this.filteredrows.slice(0, qty);
      rscopy.filterInitialized = true;
      return rscopy;
    };

    /**
     * Used for skipping 'pos' number of documents in the resultset.
     *
     * @param {int} pos - Number of documents to skip; all preceding documents are filtered out.
     * @returns {Resultset} Returns a copy of the resultset, containing docs starting at 'pos' for subsequent chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.offset = function (pos) {
      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var rscopy = new Resultset(this.collection);
      rscopy.filteredrows = this.filteredrows.slice(pos);
      rscopy.filterInitialized = true;
      return rscopy;
    };

    /**
     * copy() - To support reuse of resultset in branched query situations.
     *
     * @returns {Resultset} Returns a copy of the resultset (set) but the underlying document references will be the same.
     * @memberof Resultset
     */
    Resultset.prototype.copy = function () {
      var result = new Resultset(this.collection);

      if (this.filteredrows.length > 0) {
        result.filteredrows = this.filteredrows.slice();
      }
      result.filterInitialized = this.filterInitialized;

      return result;
    };

    /**
     * Alias of copy()
     * @memberof Resultset
     */
    Resultset.prototype.branch = Resultset.prototype.copy;

    /**
     * transform() - executes a named collection transform or raw array of transform steps against the resultset.
     *
     * @param transform {(string|array)} - name of collection transform or raw transform array
     * @param parameters {object=} - (Optional) object property hash of parameters, if the transform requires them.
     * @returns {Resultset} either (this) resultset or a clone of of this resultset (depending on steps)
     * @memberof Resultset
     */
    Resultset.prototype.transform = function (transform, parameters) {
      var idx,
        step,
        rs = this;

      // if transform is name, then do lookup first
      if (typeof transform === 'string') {
        if (this.collection.transforms.hasOwnProperty(transform)) {
          transform = this.collection.transforms[transform];
        }
      }

      // either they passed in raw transform array or we looked it up, so process
      if (typeof transform !== 'object' || !Array.isArray(transform)) {
        throw new Error("Invalid transform");
      }

      if (typeof parameters !== 'undefined') {
        transform = Utils.resolveTransformParams(transform, parameters);
      }

      for (idx = 0; idx < transform.length; idx++) {
        step = transform[idx];

        switch (step.type) {
        case "find":
          rs.find(step.value);
          break;
        case "where":
          rs.where(step.value);
          break;
        case "simplesort":
          rs.simplesort(step.property, step.desc);
          break;
        case "compoundsort":
          rs.compoundsort(step.value);
          break;
        case "sort":
          rs.sort(step.value);
          break;
        case "limit":
          rs = rs.limit(step.value);
          break; // limit makes copy so update reference
        case "offset":
          rs = rs.offset(step.value);
          break; // offset makes copy so update reference
        case "map":
          rs = rs.map(step.value);
          break;
        case "eqJoin":
          rs = rs.eqJoin(step.joinData, step.leftJoinKey, step.rightJoinKey, step.mapFun);
          break;
          // following cases break chain by returning array data so make any of these last in transform steps
        case "mapReduce":
          rs = rs.mapReduce(step.mapFunction, step.reduceFunction);
          break;
          // following cases update documents in current filtered resultset (use carefully)
        case "update":
          rs.update(step.value);
          break;
        case "remove":
          rs.remove();
          break;
        default:
          break;
        }
      }

      return rs;
    };

    /**
     * User supplied compare function is provided two documents to compare. (chainable)
     * @example
     *    rslt.sort(function(obj1, obj2) {
     *      if (obj1.name === obj2.name) return 0;
     *      if (obj1.name > obj2.name) return 1;
     *      if (obj1.name < obj2.name) return -1;
     *    });
     *
     * @param {function} comparefun - A javascript compare function used for sorting.
     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.
     * @memberof Resultset
     */
    Resultset.prototype.sort = function (comparefun) {
      // if this is chained resultset with no filters applied, just we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var wrappedComparer =
        (function (userComparer, data) {
          return function (a, b) {
            return userComparer(data[a], data[b]);
          };
        })(comparefun, this.collection.data);

      this.filteredrows.sort(wrappedComparer);

      return this;
    };

    /**
     * Simpler, loose evaluation for user to sort based on a property name. (chainable).
     *    Sorting based on the same lt/gt helper functions used for binary indices.
     *
     * @param {string} propname - name of property to sort by.
     * @param {bool=} isdesc - (Optional) If true, the property will be sorted in descending order
     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.
     * @memberof Resultset
     */
    Resultset.prototype.simplesort = function (propname, isdesc) {
      // if this is chained resultset with no filters applied, just we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      if (typeof (isdesc) === 'undefined') {
        isdesc = false;
      }

      var wrappedComparer =
        (function (prop, desc, data) {
          return function (a, b) {
            return sortHelper(data[a][prop], data[b][prop], desc);
          };
        })(propname, isdesc, this.collection.data);

      this.filteredrows.sort(wrappedComparer);

      return this;
    };

    /**
     * Allows sorting a resultset based on multiple columns.
     * @example
     * // to sort by age and then name (both ascending)
     * rs.compoundsort(['age', 'name']);
     * // to sort by age (ascending) and then by name (descending)
     * rs.compoundsort(['age', ['name', true]);
     *
     * @param {array} properties - array of property names or subarray of [propertyname, isdesc] used evaluate sort order
     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.
     * @memberof Resultset
     */
    Resultset.prototype.compoundsort = function (properties) {
      if (properties.length === 0) {
        throw new Error("Invalid call to compoundsort, need at least one property");
      }

      var prop;
      if (properties.length === 1) {
        prop = properties[0];
        if (Array.isArray(prop)) {
          return this.simplesort(prop[0], prop[1]);
        }
        return this.simplesort(prop, false);
      }

      // unify the structure of 'properties' to avoid checking it repeatedly while sorting
      for (var i = 0, len = properties.length; i < len; i += 1) {
        prop = properties[i];
        if (!Array.isArray(prop)) {
          properties[i] = [prop, false];
        }
      }

      // if this is chained resultset with no filters applied, just we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var wrappedComparer =
        (function (props, data) {
          return function (a, b) {
            return compoundeval(props, data[a], data[b]);
          };
        })(properties, this.collection.data);

      this.filteredrows.sort(wrappedComparer);

      return this;
    };

    /**
     * calculateRange() - Binary Search utility method to find range/segment of values matching criteria.
     *    this is used for collection.find() and first find filter of resultset/dynview
     *    slightly different than get() binary search in that get() hones in on 1 value,
     *    but we have to hone in on many (range)
     * @param {string} op - operation, such as $eq
     * @param {string} prop - name of property to calculate range for
     * @param {object} val - value to use for range calculation.
     * @returns {array} [start, end] index array positions
     */
    Resultset.prototype.calculateRange = function (op, prop, val) {
      var rcd = this.collection.data;
      var index = this.collection.binaryIndices[prop].values;
      var min = 0;
      var max = index.length - 1;
      var mid = 0;

      // when no documents are in collection, return empty range condition
      if (rcd.length === 0) {
        return [0, -1];
      }

      var minVal = rcd[index[min]][prop];
      var maxVal = rcd[index[max]][prop];

      // if value falls outside of our range return [0, -1] to designate no results
      switch (op) {
      case '$eq':
      case '$aeq':
        if (ltHelper(val, minVal, false) || gtHelper(val, maxVal, false)) {
          return [0, -1];
        }
        break;
      case '$dteq':
        if (ltHelper(val, minVal, false) || gtHelper(val, maxVal, false)) {
          return [0, -1];
        }
        break;
      case '$gt':
        if (gtHelper(val, maxVal, true)) {
          return [0, -1];
        }
        break;
      case '$gte':
        if (gtHelper(val, maxVal, false)) {
          return [0, -1];
        }
        break;
      case '$lt':
        if (ltHelper(val, minVal, true)) {
          return [0, -1];
        }
        if (ltHelper(maxVal, val, false)) {
          return [0, rcd.length - 1];
        }
        break;
      case '$lte':
        if (ltHelper(val, minVal, false)) {
          return [0, -1];
        }
        if (ltHelper(maxVal, val, true)) {
          return [0, rcd.length - 1];
        }
        break;
      }

      // hone in on start position of value
      while (min < max) {
        mid = (min + max) >> 1;

        if (ltHelper(rcd[index[mid]][prop], val, false)) {
          min = mid + 1;
        } else {
          max = mid;
        }
      }

      var lbound = min;

      // do not reset min, as the upper bound cannot be prior to the found low bound
      max = index.length - 1;

      // hone in on end position of value
      while (min < max) {
        mid = (min + max) >> 1;

        if (ltHelper(val, rcd[index[mid]][prop], false)) {
          max = mid;
        } else {
          min = mid + 1;
        }
      }

      var ubound = max;

      var lval = rcd[index[lbound]][prop];
      var uval = rcd[index[ubound]][prop];

      switch (op) {
      case '$eq':
        if (lval !== val) {
          return [0, -1];
        }
        if (uval !== val) {
          ubound--;
        }

        return [lbound, ubound];
      case '$dteq':
        if (lval > val || lval < val) {
          return [0, -1];
        }
        if (uval > val || uval < val) {
          ubound--;
        }

        return [lbound, ubound];


      case '$gt':
        if (ltHelper(uval, val, true)) {
          return [0, -1];
        }

        return [ubound, rcd.length - 1];

      case '$gte':
        if (ltHelper(lval, val, false)) {
          return [0, -1];
        }

        return [lbound, rcd.length - 1];

      case '$lt':
        if (lbound === 0 && ltHelper(lval, val, false)) {
          return [0, 0];
        }
        return [0, lbound - 1];

      case '$lte':
        if (uval !== val) {
          ubound--;
        }

        if (ubound === 0 && ltHelper(uval, val, false)) {
          return [0, 0];
        }
        return [0, ubound];

      default:
        return [0, rcd.length - 1];
      }
    };

    /**
     * findOr() - oversee the operation of OR'ed query expressions.
     *    OR'ed expression evaluation runs each expression individually against the full collection,
     *    and finally does a set OR on each expression's results.
     *    Each evaluation can utilize a binary index to prevent multiple linear array scans.
     *
     * @param {array} expressionArray - array of expressions
     * @returns {Resultset} this resultset for further chain ops.
     */
    Resultset.prototype.findOr = function (expressionArray) {
      var fr = null,
        fri = 0,
        frlen = 0,
        docset = [],
        idxset = [],
        idx = 0,
        origCount = this.count();

      // If filter is already initialized, then we query against only those items already in filter.
      // This means no index utilization for fields, so hopefully its filtered to a smallish filteredrows.
      for (var ei = 0, elen = expressionArray.length; ei < elen; ei++) {
        // we need to branch existing query to run each filter separately and combine results
        fr = this.branch().find(expressionArray[ei]).filteredrows;
        frlen = fr.length;
        // if the find operation did not reduce the initial set, then the initial set is the actual result
        if (frlen === origCount) {
          return this;
        }

        // add any document 'hits'
        for (fri = 0; fri < frlen; fri++) {
          idx = fr[fri];
          if (idxset[idx] === undefined) {
            idxset[idx] = true;
            docset.push(idx);
          }
        }
      }

      this.filteredrows = docset;
      this.filterInitialized = true;

      return this;
    };
    Resultset.prototype.$or = Resultset.prototype.findOr;

    /**
     * findAnd() - oversee the operation of AND'ed query expressions.
     *    AND'ed expression evaluation runs each expression progressively against the full collection,
     *    internally utilizing existing chained resultset functionality.
     *    Only the first filter can utilize a binary index.
     *
     * @param {array} expressionArray - array of expressions
     * @returns {Resultset} this resultset for further chain ops.
     */
    Resultset.prototype.findAnd = function (expressionArray) {
      // we have already implementing method chaining in this (our Resultset class)
      // so lets just progressively apply user supplied and filters
      for (var i = 0, len = expressionArray.length; i < len; i++) {
        if (this.count() === 0) {
          return this;
        }
        this.find(expressionArray[i]);
      }
      return this;
    };
    Resultset.prototype.$and = Resultset.prototype.findAnd;

    /**
     * Used for querying via a mongo-style query object.
     *
     * @param {object} query - A mongo-style query object used for filtering current results.
     * @param {boolean=} firstOnly - (Optional) Used by collection.findOne()
     * @returns {Resultset} this resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.find = function (query, firstOnly) {
      if (this.collection.data.length === 0) {
        if (this.searchIsChained) {
          this.filteredrows = [];
          this.filterInitialized = true;
          return this;
        }
        return [];
      }

      var queryObject = query || 'getAll',
        p,
        property,
        queryObjectOp,
        operator,
        value,
        key,
        searchByIndex = false,
        result = [],
        index = null;

      // if this was note invoked via findOne()
      firstOnly = firstOnly || false;

      if (typeof queryObject === 'object') {
        for (p in queryObject) {
          if (hasOwnProperty.call(queryObject, p)) {
            property = p;
            queryObjectOp = queryObject[p];
            break;
          }
        }
      }

      // apply no filters if they want all
      if (!property || queryObject === 'getAll') {
        // Chained queries can just do coll.chain().data() but let's
        // be versatile and allow this also coll.chain().find().data()

        // If a chained search, simply leave everything as-is.
        // Note: If no filter at this point, it will be properly
        // created by the follow-up queries or sorts that need it.
        // If not chained, then return the collection data array copy.
        return (this.searchIsChained) ? (this) : (this.collection.data.slice());
      }

      // injecting $and and $or expression tree evaluation here.
      if (property === '$and' || property === '$or') {
        if (this.searchIsChained) {
          this[property](queryObjectOp);

          // for chained find with firstonly,
          if (firstOnly && this.filteredrows.length > 1) {
            this.filteredrows = this.filteredrows.slice(0, 1);
          }

          return this;
        } else {
          // our $and operation internally chains filters
          result = this.collection.chain()[property](queryObjectOp).data();

          // if this was coll.findOne() return first object or empty array if null
          // since this is invoked from a constructor we can't return null, so we will
          // make null in coll.findOne();
          if (firstOnly) {
            return (result.length === 0) ? ([]) : (result[0]);
          }

          // not first only return all results
          return result;
        }
      }

      // see if query object is in shorthand mode (assuming eq operator)
      if (queryObjectOp === null || (typeof queryObjectOp !== 'object' || queryObjectOp instanceof Date)) {
        operator = '$eq';
        value = queryObjectOp;
      } else if (typeof queryObjectOp === 'object') {
        for (key in queryObjectOp) {
          if (hasOwnProperty.call(queryObjectOp, key)) {
            operator = key;
            value = queryObjectOp[key];
            break;
          }
        }
      } else {
        throw new Error('Do not know what you want to do.');
      }

      // for regex ops, precompile
      if (operator === '$regex') {
        if (Array.isArray(value)) {
          value = new RegExp(value[0], value[1]);
        } else if (!(value instanceof RegExp)) {
          value = new RegExp(value);
        }
      }

      // if user is deep querying the object such as find('name.first': 'odin')
      var usingDotNotation = (property.indexOf('.') !== -1);

      // if an index exists for the property being queried against, use it
      // for now only enabling for non-chained query (who's set of docs matches index)
      // or chained queries where it is the first filter applied and prop is indexed
      var doIndexCheck = !usingDotNotation &&
        (!this.searchIsChained || !this.filterInitialized);

      if (doIndexCheck && this.collection.binaryIndices[property] &&
        indexedOpsList.indexOf(operator) !== -1) {
        // this is where our lazy index rebuilding will take place
        // basically we will leave all indexes dirty until we need them
        // so here we will rebuild only the index tied to this property
        // ensureIndex() will only rebuild if flagged as dirty since we are not passing force=true param
        this.collection.ensureIndex(property);

        searchByIndex = true;
        index = this.collection.binaryIndices[property];
      }

      // the comparison function
      var fun = LokiOps[operator];

      // "shortcut" for collection data
      var t = this.collection.data;
      // filter data length
      var i = 0;

      // Query executed differently depending on :
      //    - whether it is chained or not
      //    - whether the property being queried has an index defined
      //    - if chained, we handle first pass differently for initial filteredrows[] population
      //
      // For performance reasons, each case has its own if block to minimize in-loop calculations

      // If not a chained query, bypass filteredrows and work directly against data
      if (!this.searchIsChained) {
        if (!searchByIndex) {
          i = t.length;

          if (firstOnly) {
            if (usingDotNotation) {
              property = property.split('.');
              while (i--) {
                if (dotSubScan(t[i], property, fun, value)) {
                  return (t[i]);
                }
              }
            } else {
              while (i--) {
                if (fun(t[i][property], value)) {
                  return (t[i]);
                }
              }
            }

            return [];
          }

          // if using dot notation then treat property as keypath such as 'name.first'.
          // currently supporting dot notation for non-indexed conditions only
          if (usingDotNotation) {
            property = property.split('.');
            while (i--) {
              if (dotSubScan(t[i], property, fun, value)) {
                result.push(t[i]);
              }
            }
          } else {
            while (i--) {
              if (fun(t[i][property], value)) {
                result.push(t[i]);
              }
            }
          }
        } else {
          // searching by binary index via calculateRange() utility method
          var seg = this.calculateRange(operator, property, value);

          // not chained so this 'find' was designated in Resultset constructor
          // so return object itself
          if (firstOnly) {
            if (seg[1] !== -1) {
              return t[index.values[seg[0]]];
            }
            return [];
          }

          for (i = seg[0]; i <= seg[1]; i++) {
            result.push(t[index.values[i]]);
          }
        }

        // not a chained query so return result as data[]
        return result;
      }


      // Otherwise this is a chained query

      var filter, rowIdx = 0;

      // If the filteredrows[] is already initialized, use it
      if (this.filterInitialized) {
        filter = this.filteredrows;
        i = filter.length;

        // currently supporting dot notation for non-indexed conditions only
        if (usingDotNotation) {
          property = property.split('.');
          while (i--) {
            rowIdx = filter[i];
            if (dotSubScan(t[rowIdx], property, fun, value)) {
              result.push(rowIdx);
            }
          }
        } else {
          while (i--) {
            rowIdx = filter[i];
            if (fun(t[rowIdx][property], value)) {
              result.push(rowIdx);
            }
          }
        }
      }
      // first chained query so work against data[] but put results in filteredrows
      else {
        // if not searching by index
        if (!searchByIndex) {
          i = t.length;

          if (usingDotNotation) {
            property = property.split('.');
            while (i--) {
              if (dotSubScan(t[i], property, fun, value)) {
                result.push(i);
              }
            }
          } else {
            while (i--) {
              if (fun(t[i][property], value)) {
                result.push(i);
              }
            }
          }
        } else {
          // search by index
          var segm = this.calculateRange(operator, property, value);

          for (i = segm[0]; i <= segm[1]; i++) {
            result.push(index.values[i]);
          }
        }

        this.filterInitialized = true; // next time work against filteredrows[]
      }

      this.filteredrows = result;
      return this;
    };


    /**
     * where() - Used for filtering via a javascript filter function.
     *
     * @param {function} fun - A javascript function used for filtering current results by.
     * @returns {Resultset} this resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.where = function (fun) {
      var viewFunction,
        result = [];

      if ('function' === typeof fun) {
        viewFunction = fun;
      } else {
        throw new TypeError('Argument is not a stored view or a function');
      }
      try {
        // if not a chained query then run directly against data[] and return object []
        if (!this.searchIsChained) {
          var i = this.collection.data.length;

          while (i--) {
            if (viewFunction(this.collection.data[i]) === true) {
              result.push(this.collection.data[i]);
            }
          }

          // not a chained query so returning result as data[]
          return result;
        }
        // else chained query, so run against filteredrows
        else {
          // If the filteredrows[] is already initialized, use it
          if (this.filterInitialized) {
            var j = this.filteredrows.length;

            while (j--) {
              if (viewFunction(this.collection.data[this.filteredrows[j]]) === true) {
                result.push(this.filteredrows[j]);
              }
            }

            this.filteredrows = result;

            return this;
          }
          // otherwise this is initial chained op, work against data, push into filteredrows[]
          else {
            var k = this.collection.data.length;

            while (k--) {
              if (viewFunction(this.collection.data[k]) === true) {
                result.push(k);
              }
            }

            this.filteredrows = result;
            this.filterInitialized = true;

            return this;
          }
        }
      } catch (err) {
        throw err;
      }
    };

    /**
     * count() - returns the number of documents in the resultset.
     *
     * @returns {number} The number of documents in the resultset.
     * @memberof Resultset
     */
    Resultset.prototype.count = function () {
      if (this.searchIsChained && this.filterInitialized) {
        return this.filteredrows.length;
      }
      return this.collection.count();
    };

    /**
     * Terminates the chain and returns array of filtered documents
     *
     * @param {object=} options - allows specifying 'forceClones' and 'forceCloneMethod' options.
     * @param {boolean} options.forceClones - Allows forcing the return of cloned objects even when
     *        the collection is not configured for clone object.
     * @param {string} options.forceCloneMethod - Allows overriding the default or collection specified cloning method.
     *        Possible values include 'parse-stringify', 'jquery-extend-deep', and 'shallow'
     *
     * @returns {array} Array of documents in the resultset
     * @memberof Resultset
     */
    Resultset.prototype.data = function (options) {
      var result = [],
        data = this.collection.data,
        len,
        i,
        method;

      options = options || {};

      // if this is chained resultset with no filters applied, just return collection.data
      if (this.searchIsChained && !this.filterInitialized) {
        if (this.filteredrows.length === 0) {
          // determine whether we need to clone objects or not
          if (this.collection.cloneObjects || options.forceClones) {
            len = data.length;
            method = options.forceCloneMethod || this.collection.cloneMethod;

            for (i = 0; i < len; i++) {
              result.push(clone(data[i], method));
            }
            return result;
          }
          // otherwise we are not cloning so return sliced array with same object references
          else {
            return data.slice();
          }
        } else {
          // filteredrows must have been set manually, so use it
          this.filterInitialized = true;
        }
      }

      var fr = this.filteredrows;
      len = fr.length;

      if (this.collection.cloneObjects || options.forceClones) {
        method = options.forceCloneMethod || this.collection.cloneMethod;
        for (i = 0; i < len; i++) {
          result.push(clone(data[fr[i]], method));
        }
      } else {
        for (i = 0; i < len; i++) {
          result.push(data[fr[i]]);
        }
      }
      return result;
    };

    /**
     * Used to run an update operation on all documents currently in the resultset.
     *
     * @param {function} updateFunction - User supplied updateFunction(obj) will be executed for each document object.
     * @returns {Resultset} this resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.update = function (updateFunction) {

      if (typeof (updateFunction) !== "function") {
        throw new TypeError('Argument is not a function');
      }

      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var len = this.filteredrows.length,
        rcd = this.collection.data;

      for (var idx = 0; idx < len; idx++) {
        // pass in each document object currently in resultset to user supplied updateFunction
        updateFunction(rcd[this.filteredrows[idx]]);

        // notify collection we have changed this object so it can update meta and allow DynamicViews to re-evaluate
        this.collection.update(rcd[this.filteredrows[idx]]);
      }

      return this;
    };

    /**
     * Removes all document objects which are currently in resultset from collection (as well as resultset)
     *
     * @returns {Resultset} this (empty) resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.remove = function () {

      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      this.collection.remove(this.data());

      this.filteredrows = [];

      return this;
    };

    /**
     * data transformation via user supplied functions
     *
     * @param {function} mapFunction - this function accepts a single document for you to transform and return
     * @param {function} reduceFunction - this function accepts many (array of map outputs) and returns single value
     * @returns {value} The output of your reduceFunction
     * @memberof Resultset
     */
    Resultset.prototype.mapReduce = function (mapFunction, reduceFunction) {
      try {
        return reduceFunction(this.data().map(mapFunction));
      } catch (err) {
        throw err;
      }
    };

    /**
     * eqJoin() - Left joining two sets of data. Join keys can be defined or calculated properties
     * eqJoin expects the right join key values to be unique.  Otherwise left data will be joined on the last joinData object with that key
     * @param {Array} joinData - Data array to join to.
     * @param {(string|function)} leftJoinKey - Property name in this result set to join on or a function to produce a value to join on
     * @param {(string|function)} rightJoinKey - Property name in the joinData to join on or a function to produce a value to join on
     * @param {function=} mapFun - (Optional) A function that receives each matching pair and maps them into output objects - function(left,right){return joinedObject}
     * @returns {Resultset} A resultset with data in the format [{left: leftObj, right: rightObj}]
     * @memberof Resultset
     */
    Resultset.prototype.eqJoin = function (joinData, leftJoinKey, rightJoinKey, mapFun) {

      var leftData = [],
        leftDataLength,
        rightData = [],
        rightDataLength,
        key,
        result = [],
        leftKeyisFunction = typeof leftJoinKey === 'function',
        rightKeyisFunction = typeof rightJoinKey === 'function',
        joinMap = {};

      //get the left data
      leftData = this.data();
      leftDataLength = leftData.length;

      //get the right data
      if (joinData instanceof Resultset) {
        rightData = joinData.data();
      } else if (Array.isArray(joinData)) {
        rightData = joinData;
      } else {
        throw new TypeError('joinData needs to be an array or result set');
      }
      rightDataLength = rightData.length;

      //construct a lookup table

      for (var i = 0; i < rightDataLength; i++) {
        key = rightKeyisFunction ? rightJoinKey(rightData[i]) : rightData[i][rightJoinKey];
        joinMap[key] = rightData[i];
      }

      if (!mapFun) {
        mapFun = function (left, right) {
          return {
            left: left,
            right: right
          };
        };
      }

      //Run map function over each object in the resultset
      for (var j = 0; j < leftDataLength; j++) {
        key = leftKeyisFunction ? leftJoinKey(leftData[j]) : leftData[j][leftJoinKey];
        result.push(mapFun(leftData[j], joinMap[key] || {}));
      }

      //return return a new resultset with no filters
      this.collection = new Collection('joinData');
      this.collection.insert(result);
      this.filteredrows = [];
      this.filterInitialized = false;

      return this;
    };

    Resultset.prototype.map = function (mapFun) {
      var data = this.data().map(mapFun);
      //return return a new resultset with no filters
      this.collection = new Collection('mappedData');
      this.collection.insert(data);
      this.filteredrows = [];
      this.filterInitialized = false;

      return this;
    };

    /**
     * DynamicView class is a versatile 'live' view class which can have filters and sorts applied.
     *    Collection.addDynamicView(name) instantiates this DynamicView object and notifies it
     *    whenever documents are add/updated/removed so it can remain up-to-date. (chainable)
     *
     * @example
     * var mydv = mycollection.addDynamicView('test');  // default is non-persistent
     * mydv.applyFind({ 'doors' : 4 });
     * mydv.applyWhere(function(obj) { return obj.name === 'Toyota'; });
     * var results = mydv.data();
     *
     * @constructor DynamicView
     * @implements LokiEventEmitter
     * @param {Collection} collection - A reference to the collection to work against
     * @param {string} name - The name of this dynamic view
     * @param {object=} options - (Optional) Pass in object with 'persistent' and/or 'sortPriority' options.
     * @param {boolean} options.persistent - indicates if view is to main internal results array in 'resultdata'
     * @param {string} options.sortPriority - 'passive' (sorts performed on call to data) or 'active' (after updates)
     * @param {number} options.minRebuildInterval - minimum rebuild interval (need clarification to docs here)
     * @see {@link Collection#addDynamicView} to construct instances of DynamicView
     */
    function DynamicView(collection, name, options) {
      this.collection = collection;
      this.name = name;
      this.rebuildPending = false;
      this.options = options || {};

      if (!this.options.hasOwnProperty('persistent')) {
        this.options.persistent = false;
      }

      // 'persistentSortPriority':
      // 'passive' will defer the sort phase until they call data(). (most efficient overall)
      // 'active' will sort async whenever next idle. (prioritizes read speeds)
      if (!this.options.hasOwnProperty('sortPriority')) {
        this.options.sortPriority = 'passive';
      }

      if (!this.options.hasOwnProperty('minRebuildInterval')) {
        this.options.minRebuildInterval = 1;
      }

      this.resultset = new Resultset(collection);
      this.resultdata = [];
      this.resultsdirty = false;

      this.cachedresultset = null;

      // keep ordered filter pipeline
      this.filterPipeline = [];

      // sorting member variables
      // we only support one active search, applied using applySort() or applySimpleSort()
      this.sortFunction = null;
      this.sortCriteria = null;
      this.sortDirty = false;

      // for now just have 1 event for when we finally rebuilt lazy view
      // once we refactor transactions, i will tie in certain transactional events

      this.events = {
        'rebuild': []
      };
    }

    DynamicView.prototype = new LokiEventEmitter();


    /**
     * rematerialize() - intended for use immediately after deserialization (loading)
     *    This will clear out and reapply filterPipeline ops, recreating the view.
     *    Since where filters do not persist correctly, this method allows
     *    restoring the view to state where user can re-apply those where filters.
     *
     * @param {Object=} options - (Optional) allows specification of 'removeWhereFilters' option
     * @returns {DynamicView} This dynamic view for further chained ops.
     * @memberof DynamicView
     * @fires DynamicView.rebuild
     */
    DynamicView.prototype.rematerialize = function (options) {
      var fpl,
        fpi,
        idx;

      options = options || {};

      this.resultdata = [];
      this.resultsdirty = true;
      this.resultset = new Resultset(this.collection);

      if (this.sortFunction || this.sortCriteria) {
        this.sortDirty = true;
      }

      if (options.hasOwnProperty('removeWhereFilters')) {
        // for each view see if it had any where filters applied... since they don't
        // serialize those functions lets remove those invalid filters
        fpl = this.filterPipeline.length;
        fpi = fpl;
        while (fpi--) {
          if (this.filterPipeline[fpi].type === 'where') {
            if (fpi !== this.filterPipeline.length - 1) {
              this.filterPipeline[fpi] = this.filterPipeline[this.filterPipeline.length - 1];
            }

            this.filterPipeline.length--;
          }
        }
      }

      // back up old filter pipeline, clear filter pipeline, and reapply pipeline ops
      var ofp = this.filterPipeline;
      this.filterPipeline = [];

      // now re-apply 'find' filterPipeline ops
      fpl = ofp.length;
      for (idx = 0; idx < fpl; idx++) {
        this.applyFind(ofp[idx].val);
      }

      // during creation of unit tests, i will remove this forced refresh and leave lazy
      this.data();

      // emit rebuild event in case user wants to be notified
      this.emit('rebuild', this);

      return this;
    };

    /**
     * branchResultset() - Makes a copy of the internal resultset for branched queries.
     *    Unlike this dynamic view, the branched resultset will not be 'live' updated,
     *    so your branched query should be immediately resolved and not held for future evaluation.
     *
     * @param {(string|array=)} transform - Optional name of collection transform, or an array of transform steps
     * @param {object=} parameters - optional parameters (if optional transform requires them)
     * @returns {Resultset} A copy of the internal resultset for branched queries.
     * @memberof DynamicView
     */
    DynamicView.prototype.branchResultset = function (transform, parameters) {
      var rs = this.resultset.branch();

      if (typeof transform === 'undefined') {
        return rs;
      }

      return rs.transform(transform, parameters);
    };

    /**
     * toJSON() - Override of toJSON to avoid circular references
     *
     */
    DynamicView.prototype.toJSON = function () {
      var copy = new DynamicView(this.collection, this.name, this.options);

      copy.resultset = this.resultset;
      copy.resultdata = []; // let's not save data (copy) to minimize size
      copy.resultsdirty = true;
      copy.filterPipeline = this.filterPipeline;
      copy.sortFunction = this.sortFunction;
      copy.sortCriteria = this.sortCriteria;
      copy.sortDirty = this.sortDirty;

      // avoid circular reference, reapply in db.loadJSON()
      copy.collection = null;

      return copy;
    };

    /**
     * removeFilters() - Used to clear pipeline and reset dynamic view to initial state.
     *     Existing options should be retained.
     * @memberof DynamicView
     */
    DynamicView.prototype.removeFilters = function () {
      this.rebuildPending = false;
      this.resultset.reset();
      this.resultdata = [];
      this.resultsdirty = false;

      this.cachedresultset = null;

      // keep ordered filter pipeline
      this.filterPipeline = [];

      // sorting member variables
      // we only support one active search, applied using applySort() or applySimpleSort()
      this.sortFunction = null;
      this.sortCriteria = null;
      this.sortDirty = false;
    };

    /**
     * applySort() - Used to apply a sort to the dynamic view
     * @example
     * dv.applySort(function(obj1, obj2) {
     *   if (obj1.name === obj2.name) return 0;
     *   if (obj1.name > obj2.name) return 1;
     *   if (obj1.name < obj2.name) return -1;
     * });
     *
     * @param {function} comparefun - a javascript compare function used for sorting
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applySort = function (comparefun) {
      this.sortFunction = comparefun;
      this.sortCriteria = null;

      this.queueSortPhase();

      return this;
    };

    /**
     * applySimpleSort() - Used to specify a property used for view translation.
     * @example
     * dv.applySimpleSort("name");
     *
     * @param {string} propname - Name of property by which to sort.
     * @param {boolean=} isdesc - (Optional) If true, the sort will be in descending order.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applySimpleSort = function (propname, isdesc) {
      this.sortCriteria = [
        [propname, isdesc || false]
      ];
      this.sortFunction = null;

      this.queueSortPhase();

      return this;
    };

    /**
     * applySortCriteria() - Allows sorting a resultset based on multiple columns.
     * @example
     * // to sort by age and then name (both ascending)
     * dv.applySortCriteria(['age', 'name']);
     * // to sort by age (ascending) and then by name (descending)
     * dv.applySortCriteria(['age', ['name', true]);
     * // to sort by age (descending) and then by name (descending)
     * dv.applySortCriteria(['age', true], ['name', true]);
     *
     * @param {array} properties - array of property names or subarray of [propertyname, isdesc] used evaluate sort order
     * @returns {DynamicView} Reference to this DynamicView, sorted, for future chain operations.
     * @memberof DynamicView
     */
    DynamicView.prototype.applySortCriteria = function (criteria) {
      this.sortCriteria = criteria;
      this.sortFunction = null;

      this.queueSortPhase();

      return this;
    };

    /**
     * startTransaction() - marks the beginning of a transaction.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.startTransaction = function () {
      this.cachedresultset = this.resultset.copy();

      return this;
    };

    /**
     * commit() - commits a transaction.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.commit = function () {
      this.cachedresultset = null;

      return this;
    };

    /**
     * rollback() - rolls back a transaction.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.rollback = function () {
      this.resultset = this.cachedresultset;

      if (this.options.persistent) {
        // for now just rebuild the persistent dynamic view data in this worst case scenario
        // (a persistent view utilizing transactions which get rolled back), we already know the filter so not too bad.
        this.resultdata = this.resultset.data();

        this.emit('rebuild', this);
      }

      return this;
    };


    /**
     * Implementation detail.
     * _indexOfFilterWithId() - Find the index of a filter in the pipeline, by that filter's ID.
     *
     * @param {(string|number)} uid - The unique ID of the filter.
     * @returns {number}: index of the referenced filter in the pipeline; -1 if not found.
     */
    DynamicView.prototype._indexOfFilterWithId = function (uid) {
      if (typeof uid === 'string' || typeof uid === 'number') {
        for (var idx = 0, len = this.filterPipeline.length; idx < len; idx += 1) {
          if (uid === this.filterPipeline[idx].uid) {
            return idx;
          }
        }
      }
      return -1;
    };

    /**
     * Implementation detail.
     * _addFilter() - Add the filter object to the end of view's filter pipeline and apply the filter to the resultset.
     *
     * @param {object} filter - The filter object. Refer to applyFilter() for extra details.
     */
    DynamicView.prototype._addFilter = function (filter) {
      this.filterPipeline.push(filter);
      this.resultset[filter.type](filter.val);
    };

    /**
     * reapplyFilters() - Reapply all the filters in the current pipeline.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.reapplyFilters = function () {
      this.resultset.reset();

      this.cachedresultset = null;
      if (this.options.persistent) {
        this.resultdata = [];
        this.resultsdirty = true;
      }

      var filters = this.filterPipeline;
      this.filterPipeline = [];

      for (var idx = 0, len = filters.length; idx < len; idx += 1) {
        this._addFilter(filters[idx]);
      }

      if (this.sortFunction || this.sortCriteria) {
        this.queueSortPhase();
      } else {
        this.queueRebuildEvent();
      }

      return this;
    };

    /**
     * applyFilter() - Adds or updates a filter in the DynamicView filter pipeline
     *
     * @param {object} filter - A filter object to add to the pipeline.
     *    The object is in the format { 'type': filter_type, 'val', filter_param, 'uid', optional_filter_id }
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applyFilter = function (filter) {
      var idx = this._indexOfFilterWithId(filter.uid);
      if (idx >= 0) {
        this.filterPipeline[idx] = filter;
        return this.reapplyFilters();
      }

      this.cachedresultset = null;
      if (this.options.persistent) {
        this.resultdata = [];
        this.resultsdirty = true;
      }

      this._addFilter(filter);

      if (this.sortFunction || this.sortCriteria) {
        this.queueSortPhase();
      } else {
        this.queueRebuildEvent();
      }

      return this;
    };

    /**
     * applyFind() - Adds or updates a mongo-style query option in the DynamicView filter pipeline
     *
     * @param {object} query - A mongo-style query object to apply to pipeline
     * @param {(string|number)=} uid - Optional: The unique ID of this filter, to reference it in the future.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applyFind = function (query, uid) {
      this.applyFilter({
        type: 'find',
        val: query,
        uid: uid
      });
      return this;
    };

    /**
     * applyWhere() - Adds or updates a javascript filter function in the DynamicView filter pipeline
     *
     * @param {function} fun - A javascript filter function to apply to pipeline
     * @param {(string|number)=} uid - Optional: The unique ID of this filter, to reference it in the future.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applyWhere = function (fun, uid) {
      this.applyFilter({
        type: 'where',
        val: fun,
        uid: uid
      });
      return this;
    };

    /**
     * removeFilter() - Remove the specified filter from the DynamicView filter pipeline
     *
     * @param {(string|number)} uid - The unique ID of the filter to be removed.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.removeFilter = function (uid) {
      var idx = this._indexOfFilterWithId(uid);
      if (idx < 0) {
        throw new Error("Dynamic view does not contain a filter with ID: " + uid);
      }

      this.filterPipeline.splice(idx, 1);
      this.reapplyFilters();
      return this;
    };

    /**
     * count() - returns the number of documents representing the current DynamicView contents.
     *
     * @returns {number} The number of documents representing the current DynamicView contents.
     * @memberof DynamicView
     */
    DynamicView.prototype.count = function () {
      if (this.options.persistent) {
        return this.resultdata.length;
      }
      return this.resultset.count();
    };

    /**
     * data() - resolves and pending filtering and sorting, then returns document array as result.
     *
     * @returns {array} An array of documents representing the current DynamicView contents.
     * @memberof DynamicView
     */
    DynamicView.prototype.data = function () {
      // using final sort phase as 'catch all' for a few use cases which require full rebuild
      if (this.sortDirty || this.resultsdirty) {
        this.performSortPhase({
          suppressRebuildEvent: true
        });
      }
      return (this.options.persistent) ? (this.resultdata) : (this.resultset.data());
    };

    /**
     * queueRebuildEvent() - When the view is not sorted we may still wish to be notified of rebuild events.
     *     This event will throttle and queue a single rebuild event when batches of updates affect the view.
     */
    DynamicView.prototype.queueRebuildEvent = function () {
      if (this.rebuildPending) {
        return;
      }
      this.rebuildPending = true;

      var self = this;
      setTimeout(function () {
        if (self.rebuildPending) {
          self.rebuildPending = false;
          self.emit('rebuild', self);
        }
      }, this.options.minRebuildInterval);
    };

    /**
     * queueSortPhase : If the view is sorted we will throttle sorting to either :
     *    (1) passive - when the user calls data(), or
     *    (2) active - once they stop updating and yield js thread control
     */
    DynamicView.prototype.queueSortPhase = function () {
      // already queued? exit without queuing again
      if (this.sortDirty) {
        return;
      }
      this.sortDirty = true;

      var self = this;
      if (this.options.sortPriority === "active") {
        // active sorting... once they are done and yield js thread, run async performSortPhase()
        setTimeout(function () {
          self.performSortPhase();
        }, this.options.minRebuildInterval);
      } else {
        // must be passive sorting... since not calling performSortPhase (until data call), lets use queueRebuildEvent to
        // potentially notify user that data has changed.
        this.queueRebuildEvent();
      }
    };

    /**
     * performSortPhase() - invoked synchronously or asynchronously to perform final sort phase (if needed)
     *
     */
    DynamicView.prototype.performSortPhase = function (options) {
      // async call to this may have been pre-empted by synchronous call to data before async could fire
      if (!this.sortDirty && !this.resultsdirty) {
        return;
      }

      options = options || {};

      if (this.sortDirty) {
        if (this.sortFunction) {
          this.resultset.sort(this.sortFunction);
        } else if (this.sortCriteria) {
          this.resultset.compoundsort(this.sortCriteria);
        }

        this.sortDirty = false;
      }

      if (this.options.persistent) {
        // persistent view, rebuild local resultdata array
        this.resultdata = this.resultset.data();
        this.resultsdirty = false;
      }

      if (!options.suppressRebuildEvent) {
        this.emit('rebuild', this);
      }
    };

    /**
     * evaluateDocument() - internal method for (re)evaluating document inclusion.
     *    Called by : collection.insert() and collection.update().
     *
     * @param {int} objIndex - index of document to (re)run through filter pipeline.
     * @param {bool} isNew - true if the document was just added to the collection.
     */
    DynamicView.prototype.evaluateDocument = function (objIndex, isNew) {
      // if no filter applied yet, the result 'set' should remain 'everything'
      if (!this.resultset.filterInitialized) {
        if (this.options.persistent) {
          this.resultdata = this.resultset.data();
        }
        // need to re-sort to sort new document
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }
        return;
      }

      var ofr = this.resultset.filteredrows;
      var oldPos = (isNew) ? (-1) : (ofr.indexOf(+objIndex));
      var oldlen = ofr.length;

      // creating a 1-element resultset to run filter chain ops on to see if that doc passes filters;
      // mostly efficient algorithm, slight stack overhead price (this function is called on inserts and updates)
      var evalResultset = new Resultset(this.collection);
      evalResultset.filteredrows = [objIndex];
      evalResultset.filterInitialized = true;
      var filter;
      for (var idx = 0, len = this.filterPipeline.length; idx < len; idx++) {
        filter = this.filterPipeline[idx];
        evalResultset[filter.type](filter.val);
      }

      // not a true position, but -1 if not pass our filter(s), 0 if passed filter(s)
      var newPos = (evalResultset.filteredrows.length === 0) ? -1 : 0;

      // wasn't in old, shouldn't be now... do nothing
      if (oldPos === -1 && newPos === -1) return;

      // wasn't in resultset, should be now... add
      if (oldPos === -1 && newPos !== -1) {
        ofr.push(objIndex);

        if (this.options.persistent) {
          this.resultdata.push(this.collection.data[objIndex]);
        }

        // need to re-sort to sort new document
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }

        return;
      }

      // was in resultset, shouldn't be now... delete
      if (oldPos !== -1 && newPos === -1) {
        if (oldPos < oldlen - 1) {
          // http://dvolvr.davidwaterston.com/2013/06/09/restating-the-obvious-the-fastest-way-to-truncate-an-array-in-javascript/comment-page-1/
          ofr[oldPos] = ofr[oldlen - 1];
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata[oldPos] = this.resultdata[oldlen - 1];
            this.resultdata.length = oldlen - 1;
          }
        } else {
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata.length = oldlen - 1;
          }
        }

        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }

        return;
      }

      // was in resultset, should still be now... (update persistent only?)
      if (oldPos !== -1 && newPos !== -1) {
        if (this.options.persistent) {
          // in case document changed, replace persistent view data with the latest collection.data document
          this.resultdata[oldPos] = this.collection.data[objIndex];
        }

        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }

        return;
      }
    };

    /**
     * removeDocument() - internal function called on collection.delete()
     */
    DynamicView.prototype.removeDocument = function (objIndex) {
      // if no filter applied yet, the result 'set' should remain 'everything'
      if (!this.resultset.filterInitialized) {
        if (this.options.persistent) {
          this.resultdata = this.resultset.data();
        }
        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }
        return;
      }

      var ofr = this.resultset.filteredrows;
      var oldPos = ofr.indexOf(+objIndex);
      var oldlen = ofr.length;
      var idx;

      if (oldPos !== -1) {
        // if not last row in resultdata, swap last to hole and truncate last row
        if (oldPos < oldlen - 1) {
          ofr[oldPos] = ofr[oldlen - 1];
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata[oldPos] = this.resultdata[oldlen - 1];
            this.resultdata.length = oldlen - 1;
          }
        }
        // last row, so just truncate last row
        else {
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata.length = oldlen - 1;
          }
        }

        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }
      }

      // since we are using filteredrows to store data array positions
      // if they remove a document (whether in our view or not),
      // we need to adjust array positions -1 for all document array references after that position
      oldlen = ofr.length;
      for (idx = 0; idx < oldlen; idx++) {
        if (ofr[idx] > objIndex) {
          ofr[idx]--;
        }
      }
    };

    /**
     * mapReduce() - data transformation via user supplied functions
     *
     * @param {function} mapFunction - this function accepts a single document for you to transform and return
     * @param {function} reduceFunction - this function accepts many (array of map outputs) and returns single value
     * @returns The output of your reduceFunction
     * @memberof DynamicView
     */
    DynamicView.prototype.mapReduce = function (mapFunction, reduceFunction) {
      try {
        return reduceFunction(this.data().map(mapFunction));
      } catch (err) {
        throw err;
      }
    };


    /**
     * Collection class that handles documents of same type
     * @constructor Collection
     * @implements LokiEventEmitter
     * @param {string} name - collection name
     * @param {(array|object)=} options - (optional) array of property names to be indicized OR a configuration object
     * @param {array} options.unique - array of property names to define unique constraints for
     * @param {array} options.exact - array of property names to define exact constraints for
     * @param {array} options.indices - array property names to define binary indexes for
     * @param {boolean} options.asyncListeners - default is false
     * @param {boolean} options.disableChangesApi - default is true
     * @param {boolean} options.autoupdate - use Object.observe to update objects automatically (default: false)
     * @param {boolean} options.clone - specify whether inserts and queries clone to/from user
     * @param {string} options.cloneMethod - 'parse-stringify' (default), 'jquery-extend-deep', 'shallow'
     * @param {int} options.ttlInterval - time interval for clearing out 'aged' documents; not set by default.
     * @see {@link Loki#addCollection} for normal creation of collections
     */
    function Collection(name, options) {
      // the name of the collection

      this.name = name;
      // the data held by the collection
      this.data = [];
      this.idIndex = []; // index of id
      this.binaryIndices = {}; // user defined indexes
      this.constraints = {
        unique: {},
        exact: {}
      };

      // unique contraints contain duplicate object references, so they are not persisted.
      // we will keep track of properties which have unique contraint applied here, and regenerate on load
      this.uniqueNames = [];

      // transforms will be used to store frequently used query chains as a series of steps
      // which itself can be stored along with the database.
      this.transforms = {};

      // the object type of the collection
      this.objType = name;

      // in autosave scenarios we will use collection level dirty flags to determine whether save is needed.
      // currently, if any collection is dirty we will autosave the whole database if autosave is configured.
      // defaulting to true since this is called from addCollection and adding a collection should trigger save
      this.dirty = true;

      // private holders for cached data
      this.cachedIndex = null;
      this.cachedBinaryIndex = null;
      this.cachedData = null;
      var self = this;

      /* OPTIONS */
      options = options || {};

      // exact match and unique constraints
      if (options.hasOwnProperty('unique')) {
        if (!Array.isArray(options.unique)) {
          options.unique = [options.unique];
        }
        options.unique.forEach(function (prop) {
          self.uniqueNames.push(prop); // used to regenerate on subsequent database loads
          self.constraints.unique[prop] = new UniqueIndex(prop);
        });
      }

      if (options.hasOwnProperty('exact')) {
        options.exact.forEach(function (prop) {
          self.constraints.exact[prop] = new ExactIndex(prop);
        });
      }

      // is collection transactional
      this.transactional = options.hasOwnProperty('transactional') ? options.transactional : false;

      // options to clone objects when inserting them
      this.cloneObjects = options.hasOwnProperty('clone') ? options.clone : false;

      // default clone method (if enabled) is parse-stringify
      this.cloneMethod = options.hasOwnProperty('cloneMethod') ? options.cloneMethod : "parse-stringify";

      // option to make event listeners async, default is sync
      this.asyncListeners = options.hasOwnProperty('asyncListeners') ? options.asyncListeners : false;

      // disable track changes
      this.disableChangesApi = options.hasOwnProperty('disableChangesApi') ? options.disableChangesApi : true;

      // option to observe objects and update them automatically, ignored if Object.observe is not supported
      this.autoupdate = options.hasOwnProperty('autoupdate') ? options.autoupdate : false;

      //option to activate a cleaner daemon - clears "aged" documents at set intervals.
      this.ttl = {
        age: null,
        ttlInterval: null,
        daemon: null
      };
      this.setTTL(options.ttl || -1, options.ttlInterval);

      // currentMaxId - change manually at your own peril!
      this.maxId = 0;

      this.DynamicViews = [];

      // events
      this.events = {
        'insert': [],
        'update': [],
        'pre-insert': [],
        'pre-update': [],
        'close': [],
        'flushbuffer': [],
        'error': [],
        'delete': [],
        'warning': []
      };

      // changes are tracked by collection and aggregated by the db
      this.changes = [];

      // initialize the id index
      this.ensureId();
      var indices = [];
      // initialize optional user-supplied indices array ['age', 'lname', 'zip']
      if (options && options.indices) {
        if (Object.prototype.toString.call(options.indices) === '[object Array]') {
          indices = options.indices;
        } else if (typeof options.indices === 'string') {
          indices = [options.indices];
        } else {
          throw new TypeError('Indices needs to be a string or an array of strings');
        }
      }

      for (var idx = 0; idx < indices.length; idx++) {
        this.ensureIndex(indices[idx]);
      }

      function observerCallback(changes) {

        var changedObjects = typeof Set === 'function' ? new Set() : [];

        if (!changedObjects.add)
          changedObjects.add = function (object) {
            if (this.indexOf(object) === -1)
              this.push(object);
            return this;
          };

        changes.forEach(function (change) {
          changedObjects.add(change.object);
        });

        changedObjects.forEach(function (object) {
          if (!hasOwnProperty.call(object, '$loki'))
            return self.removeAutoUpdateObserver(object);
          try {
            self.update(object);
          } catch (err) {}
        });
      }

      this.observerCallback = observerCallback;

      /*
       * This method creates a clone of the current status of an object and associates operation and collection name,
       * so the parent db can aggregate and generate a changes object for the entire db
       */
      function createChange(name, op, obj) {
        self.changes.push({
          name: name,
          operation: op,
          obj: JSON.parse(JSON.stringify(obj))
        });
      }

      // clear all the changes
      function flushChanges() {
        self.changes = [];
      }

      this.getChanges = function () {
        return self.changes;
      };

      this.flushChanges = flushChanges;

      /**
       * If the changes API is disabled make sure only metadata is added without re-evaluating everytime if the changesApi is enabled
       */
      function insertMeta(obj) {
        if (!obj) {
          return;
        }
        if (!obj.meta) {
          obj.meta = {};
        }

        obj.meta.created = (new Date()).getTime();
        obj.meta.revision = 0;
      }

      function updateMeta(obj) {
        if (!obj) {
          return;
        }
        obj.meta.updated = (new Date()).getTime();
        obj.meta.revision += 1;
      }

      function createInsertChange(obj) {
        createChange(self.name, 'I', obj);
      }

      function createUpdateChange(obj) {
        createChange(self.name, 'U', obj);
      }

      function insertMetaWithChange(obj) {
        insertMeta(obj);
        createInsertChange(obj);
      }

      function updateMetaWithChange(obj) {
        updateMeta(obj);
        createUpdateChange(obj);
      }


      /* assign correct handler based on ChangesAPI flag */
      var insertHandler, updateHandler;

      function setHandlers() {
        insertHandler = self.disableChangesApi ? insertMeta : insertMetaWithChange;
        updateHandler = self.disableChangesApi ? updateMeta : updateMetaWithChange;
      }

      setHandlers();

      this.setChangesApi = function (enabled) {
        self.disableChangesApi = !enabled;
        setHandlers();
      };
      /**
       * built-in events
       */
      this.on('insert', function insertCallback(obj) {
        insertHandler(obj);
      });

      this.on('update', function updateCallback(obj) {
        updateHandler(obj);
      });

      this.on('delete', function deleteCallback(obj) {
        if (!self.disableChangesApi) {
          createChange(self.name, 'R', obj);
        }
      });

      this.on('warning', function (warning) {
        self.console.warn(warning);
      });
      // for de-serialization purposes
      flushChanges();
    }

    Collection.prototype = new LokiEventEmitter();

    Collection.prototype.console = {
      log: function () {},
      warn: function () {},
      error: function () {},
    };

    Collection.prototype.addAutoUpdateObserver = function (object) {
      if (!this.autoupdate || typeof Object.observe !== 'function')
        return;

      Object.observe(object, this.observerCallback, ['add', 'update', 'delete', 'reconfigure', 'setPrototype']);
    };

    Collection.prototype.removeAutoUpdateObserver = function (object) {
      if (!this.autoupdate || typeof Object.observe !== 'function')
        return;

      Object.unobserve(object, this.observerCallback);
    };

    /**
     * Adds a named collection transform to the collection
     * @param {string} name - name to associate with transform
     * @param {array} transform - an array of transformation 'step' objects to save into the collection
     * @memberof Collection
     */
    Collection.prototype.addTransform = function (name, transform) {
      if (this.transforms.hasOwnProperty(name)) {
        throw new Error("a transform by that name already exists");
      }

      this.transforms[name] = transform;
    };

    /**
     * Updates a named collection transform to the collection
     * @param {string} name - name to associate with transform
     * @param {object} transform - a transformation object to save into collection
     * @memberof Collection
     */
    Collection.prototype.setTransform = function (name, transform) {
      this.transforms[name] = transform;
    };

    /**
     * Removes a named collection transform from the collection
     * @param {string} name - name of collection transform to remove
     * @memberof Collection
     */
    Collection.prototype.removeTransform = function (name) {
      delete this.transforms[name];
    };

    Collection.prototype.byExample = function (template) {
      var k, obj, query;
      query = [];
      for (k in template) {
        if (!template.hasOwnProperty(k)) continue;
        query.push((
          obj = {},
          obj[k] = template[k],
          obj
        ));
      }
      return {
        '$and': query
      };
    };

    Collection.prototype.findObject = function (template) {
      return this.findOne(this.byExample(template));
    };

    Collection.prototype.findObjects = function (template) {
      return this.find(this.byExample(template));
    };

    /*----------------------------+
    | TTL daemon                  |
    +----------------------------*/
    Collection.prototype.ttlDaemonFuncGen = function () {
      var collection = this;
      var age = this.ttl.age;
      return function ttlDaemon() {
        var now = Date.now();
        var toRemove = collection.chain().where(function daemonFilter(member) {
          var timestamp = member.meta.updated || member.meta.created;
          var diff = now - timestamp;
          return age < diff;
        });
        toRemove.remove();
      };
    };

    Collection.prototype.setTTL = function (age, interval) {
      if (age < 0) {
        clearInterval(this.ttl.daemon);
      } else {
        this.ttl.age = age;
        this.ttl.ttlInterval = interval;
        this.ttl.daemon = setInterval(this.ttlDaemonFuncGen(), interval);
      }
    };

    /*----------------------------+
    | INDEXING                    |
    +----------------------------*/

    /**
     * create a row filter that covers all documents in the collection
     */
    Collection.prototype.prepareFullDocIndex = function () {
      var len = this.data.length;
      var indexes = new Array(len);
      for (var i = 0; i < len; i += 1) {
        indexes[i] = i;
      }
      return indexes;
    };

    /**
     * Ensure binary index on a certain field
     * @param {string} property - name of property to create binary index on
     * @param {boolean=} force - (Optional) flag indicating whether to construct index immediately
     * @memberof Collection
     */
    Collection.prototype.ensureIndex = function (property, force) {
      // optional parameter to force rebuild whether flagged as dirty or not
      if (typeof (force) === 'undefined') {
        force = false;
      }

      if (property === null || property === undefined) {
        throw new Error('Attempting to set index without an associated property');
      }

      if (this.binaryIndices[property] && !force) {
        if (!this.binaryIndices[property].dirty) return;
      }

      var index = {
        'name': property,
        'dirty': true,
        'values': this.prepareFullDocIndex()
      };
      this.binaryIndices[property] = index;

      var wrappedComparer =
        (function (p, data) {
          return function (a, b) {
            var objAp = data[a][p],
              objBp = data[b][p];
            if (objAp !== objBp) {
              if (ltHelper(objAp, objBp, false)) return -1;
              if (gtHelper(objAp, objBp, false)) return 1;
            }
            return 0;
          };
        })(property, this.data);

      index.values.sort(wrappedComparer);
      index.dirty = false;

      this.dirty = true; // for autosave scenarios
    };

    Collection.prototype.getSequencedIndexValues = function (property) {
      var idx, idxvals = this.binaryIndices[property].values;
      var result = "";

      for (idx = 0; idx < idxvals.length; idx++) {
        result += " [" + idx + "] " + this.data[idxvals[idx]][property];
      }

      return result;
    };

    Collection.prototype.ensureUniqueIndex = function (field) {
      var index = this.constraints.unique[field];
      if (!index) {
        // keep track of new unique index for regenerate after database (re)load.
        if (this.uniqueNames.indexOf(field) == -1) {
          this.uniqueNames.push(field);
        }
      }

      // if index already existed, (re)loading it will likely cause collisions, rebuild always
      this.constraints.unique[field] = index = new UniqueIndex(field);
      this.data.forEach(function (obj) {
        index.set(obj);
      });
      return index;
    };

    /**
     * Ensure all binary indices
     */
    Collection.prototype.ensureAllIndexes = function (force) {
      var key, bIndices = this.binaryIndices;
      for (key in bIndices) {
        if (hasOwnProperty.call(bIndices, key)) {
          this.ensureIndex(key, force);
        }
      }
    };

    Collection.prototype.flagBinaryIndexesDirty = function () {
      var key, bIndices = this.binaryIndices;
      for (key in bIndices) {
        if (hasOwnProperty.call(bIndices, key)) {
          bIndices[key].dirty = true;
        }
      }
    };

    Collection.prototype.flagBinaryIndexDirty = function (index) {
      if (this.binaryIndices[index])
        this.binaryIndices[index].dirty = true;
    };

    /**
     * Quickly determine number of documents in collection (or query)
     * @param {object=} query - (optional) query object to count results of
     * @returns {number} number of documents in the collection
     * @memberof Collection
     */
    Collection.prototype.count = function (query) {
      if (!query) {
        return this.data.length;
      }

      return this.chain().find(query).filteredrows.length;
    };

    /**
     * Rebuild idIndex
     */
    Collection.prototype.ensureId = function () {
      var len = this.data.length,
        i = 0;

      this.idIndex = [];
      for (i; i < len; i += 1) {
        this.idIndex.push(this.data[i].$loki);
      }
    };

    /**
     * Rebuild idIndex async with callback - useful for background syncing with a remote server
     */
    Collection.prototype.ensureIdAsync = function (callback) {
      this.async(function () {
        this.ensureId();
      }, callback);
    };

    /**
     * Add a dynamic view to the collection
     * @param {string} name - name of dynamic view to add
     * @param {object=} options - (optional) options to configure dynamic view with
     * @param {boolean} options.persistent - indicates if view is to main internal results array in 'resultdata'
     * @param {string} options.sortPriority - 'passive' (sorts performed on call to data) or 'active' (after updates)
     * @param {number} options.minRebuildInterval - minimum rebuild interval (need clarification to docs here)
     * @returns {DynamicView} reference to the dynamic view added
     * @memberof Collection
     **/

    Collection.prototype.addDynamicView = function (name, options) {
      var dv = new DynamicView(this, name, options);
      this.DynamicViews.push(dv);

      return dv;
    };

    /**
     * Remove a dynamic view from the collection
     * @param {string} name - name of dynamic view to remove
     * @memberof Collection
     **/
    Collection.prototype.removeDynamicView = function (name) {
      for (var idx = 0; idx < this.DynamicViews.length; idx++) {
        if (this.DynamicViews[idx].name === name) {
          this.DynamicViews.splice(idx, 1);
        }
      }
    };

    /**
     * Look up dynamic view reference from within the collection
     * @param {string} name - name of dynamic view to retrieve reference of
     * @returns {DynamicView} A reference to the dynamic view with that name
     * @memberof Collection
     **/
    Collection.prototype.getDynamicView = function (name) {
      for (var idx = 0; idx < this.DynamicViews.length; idx++) {
        if (this.DynamicViews[idx].name === name) {
          return this.DynamicViews[idx];
        }
      }

      return null;
    };

    /**
     * find and update: pass a filtering function to select elements to be updated
     * and apply the updatefunctino to those elements iteratively
     * @param {function} filterFunction - filter function whose results will execute update
     * @param {function} updateFunction - update function to run against filtered documents
     * @memberof Collection
     */
    Collection.prototype.findAndUpdate = function (filterFunction, updateFunction) {
      var results = this.where(filterFunction),
        i = 0,
        obj;
      try {
        for (i; i < results.length; i++) {
          obj = updateFunction(results[i]);
          this.update(obj);
        }

      } catch (err) {
        this.rollback();
        this.console.error(err.message);
      }
    };

    /**
     * Adds object(s) to collection, ensure object(s) have meta properties, clone it if necessary, etc.
     * @param {(object|array)} doc - the document (or array of documents) to be inserted
     * @returns {(object|array)} document or documents inserted
     * @memberof Collection
     */
    Collection.prototype.insert = function (doc) {
      if (!Array.isArray(doc)) {
        return this.insertOne(doc);
      }

      // holder to the clone of the object inserted if collections is set to clone objects
      var obj;
      var results = [];
      for (var i = 0, len = doc.length; i < len; i++) {
        obj = this.insertOne(doc[i]);
        if (!obj) {
          return undefined;
        }
        results.push(obj);
      }
      return results.length === 1 ? results[0] : results;
    };

    /**
     * Adds a single object, ensures it has meta properties, clone it if necessary, etc.
     * @param {object} doc - the document to be inserted
     * @returns {object} document or 'undefined' if there was a problem inserting it
     * @memberof Collection
     */
    Collection.prototype.insertOne = function (doc) {
      var err = null;
      if (typeof doc !== 'object') {
        err = new TypeError('Document needs to be an object');
      } else if (doc === null) {
        err = new TypeError('Object cannot be null');
      }

      if (err !== null) {
        this.emit('error', err);
        throw err;
      }

      // if configured to clone, do so now... otherwise just use same obj reference
      var obj = this.cloneObjects ? clone(doc, this.cloneMethod) : doc;

      if (typeof obj.meta === 'undefined') {
        obj.meta = {
          revision: 0,
          created: 0
        };
      }

      this.emit('pre-insert', obj);
      if (!this.add(obj)) {
        return undefined;
      }

      this.addAutoUpdateObserver(obj);
      this.emit('insert', obj);
      return obj;
    };

    /**
     * Empties the collection.
     * @memberof Collection
     */
    Collection.prototype.clear = function () {
      this.data = [];
      this.idIndex = [];
      this.binaryIndices = {};
      this.cachedIndex = null;
      this.cachedBinaryIndex = null;
      this.cachedData = null;
      this.maxId = 0;
      this.DynamicViews = [];
      this.dirty = true;
    };

    /**
     * Updates an object and notifies collection that the document has changed.
     * @param {object} doc - document to update within the collection
     * @memberof Collection
     */
    Collection.prototype.update = function (doc) {
      this.flagBinaryIndexesDirty();

      if (Array.isArray(doc)) {
        var k = 0,
          len = doc.length;
        for (k; k < len; k += 1) {
          this.update(doc[k]);
        }
        return;
      }

      // verify object is a properly formed document
      if (!hasOwnProperty.call(doc, '$loki')) {
        throw new Error('Trying to update unsynced document. Please save the document first by using insert() or addMany()');
      }
      try {
        this.startTransaction();
        var arr = this.get(doc.$loki, true),
          obj,
          position,
          self = this;

        obj = arr[0]; // -internal- obj ref
        position = arr[1]; // position in data array

        if (!arr) {
          throw new Error('Trying to update a document not in collection.');
        }
        this.emit('pre-update', doc);

        Object.keys(this.constraints.unique).forEach(function (key) {
          self.constraints.unique[key].update(obj, doc);
        });

        // operate the update
        this.data[position] = doc;

        if (obj !== doc) {
          this.addAutoUpdateObserver(doc);
        }

        // now that we can efficiently determine the data[] position of newly added document,
        // submit it for all registered DynamicViews to evaluate for inclusion/exclusion
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].evaluateDocument(position, false);
        }

        this.idIndex[position] = obj.$loki;

        this.commit();
        this.dirty = true; // for autosave scenarios
        this.emit('update', doc);
        return doc;
      } catch (err) {
        this.rollback();
        this.console.error(err.message);
        this.emit('error', err);
        throw (err); // re-throw error so user does not think it succeeded
      }
    };

    /**
     * Add object to collection
     */
    Collection.prototype.add = function (obj) {
      // if parameter isn't object exit with throw
      if ('object' !== typeof obj) {
        throw new TypeError('Object being added needs to be an object');
      }
      // if object you are adding already has id column it is either already in the collection
      // or the object is carrying its own 'id' property.  If it also has a meta property,
      // then this is already in collection so throw error, otherwise rename to originalId and continue adding.
      if (typeof (obj.$loki) !== 'undefined') {
        throw new Error('Document is already in collection, please use update()');
      }

      this.flagBinaryIndexesDirty();

      /*
       * try adding object to collection
       */
      try {
        this.startTransaction();
        this.maxId++;

        if (isNaN(this.maxId)) {
          this.maxId = (this.data[this.data.length - 1].$loki + 1);
        }

        obj.$loki = this.maxId;
        obj.meta.version = 0;

        var key, constrUnique = this.constraints.unique;
        for (key in constrUnique) {
          if (hasOwnProperty.call(constrUnique, key)) {
            constrUnique[key].set(obj);
          }
        }

        // add new obj id to idIndex
        this.idIndex.push(obj.$loki);

        // add the object
        this.data.push(obj);

        // now that we can efficiently determine the data[] position of newly added document,
        // submit it for all registered DynamicViews to evaluate for inclusion/exclusion
        var addedPos = this.data.length - 1;
        var dvlen = this.DynamicViews.length;
        for (var i = 0; i < dvlen; i++) {
          this.DynamicViews[i].evaluateDocument(addedPos, true);
        }

        this.commit();
        this.dirty = true; // for autosave scenarios

        return (this.cloneObjects) ? (clone(obj, this.cloneMethod)) : (obj);
      } catch (err) {
        this.rollback();
        this.console.error(err.message);
        this.emit('error', err);
        throw (err); // re-throw error so user does not think it succeeded
      }
    };


    /**
     * Remove all documents matching supplied filter object
     * @param {object} query - query object to filter on
     * @memberof Collection
     */
    Collection.prototype.removeWhere = function (query) {
      var list;
      if (typeof query === 'function') {
        list = this.data.filter(query);
      } else {
        list = new Resultset(this, {
          queryObj: query
        });
      }
      this.remove(list);
    };

    Collection.prototype.removeDataOnly = function () {
      this.remove(this.data.slice());
    };

    /**
     * Remove a document from the collection
     * @param {object} doc - document to remove from collection
     * @memberof Collection
     */
    Collection.prototype.remove = function (doc) {
      if (typeof doc === 'number') {
        doc = this.get(doc);
      }

      if ('object' !== typeof doc) {
        throw new Error('Parameter is not an object');
      }
      if (Array.isArray(doc)) {
        var k = 0,
          len = doc.length;
        for (k; k < len; k += 1) {
          this.remove(doc[k]);
        }
        return;
      }

      if (!hasOwnProperty.call(doc, '$loki')) {
        throw new Error('Object is not a document stored in the collection');
      }

      this.flagBinaryIndexesDirty();

      try {
        this.startTransaction();
        var arr = this.get(doc.$loki, true),
          // obj = arr[0],
          position = arr[1];
        var self = this;
        Object.keys(this.constraints.unique).forEach(function (key) {
          if (doc[key] !== null && typeof doc[key] !== 'undefined') {
            self.constraints.unique[key].remove(doc[key]);
          }
        });
        // now that we can efficiently determine the data[] position of newly added document,
        // submit it for all registered DynamicViews to remove
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].removeDocument(position);
        }

        this.data.splice(position, 1);
        this.removeAutoUpdateObserver(doc);

        // remove id from idIndex
        this.idIndex.splice(position, 1);

        this.commit();
        this.dirty = true; // for autosave scenarios
        this.emit('delete', arr[0]);
        delete doc.$loki;
        delete doc.meta;
        return doc;

      } catch (err) {
        this.rollback();
        this.console.error(err.message);
        this.emit('error', err);
        return null;
      }
    };

    /*---------------------+
    | Finding methods     |
    +----------------------*/

    /**
     * Get by Id - faster than other methods because of the searching algorithm
     * @param {int} id - $loki id of document you want to retrieve
     * @param {boolean} returnPosition - if 'true' we will return [object, position]
     * @returns {(object|array|null)} Object reference if document was found, null if not,
     *     or an array if 'returnPosition' was passed.
     * @memberof Collection
     */
    Collection.prototype.get = function (id, returnPosition) {
      var retpos = returnPosition || false,
        data = this.idIndex,
        max = data.length - 1,
        min = 0,
        mid = (min + max) >> 1;

      id = typeof id === 'number' ? id : parseInt(id, 10);

      if (isNaN(id)) {
        throw new TypeError('Passed id is not an integer');
      }

      while (data[min] < data[max]) {
        mid = (min + max) >> 1;

        if (data[mid] < id) {
          min = mid + 1;
        } else {
          max = mid;
        }
      }

      if (max === min && data[min] === id) {
        if (retpos) {
          return [this.data[min], min];
        }
        return this.data[min];
      }
      return null;

    };

    /**
     * Retrieve doc by Unique index
     * @param {string} field - name of uniquely indexed property to use when doing lookup
     * @param {value} value - unique value to search for
     * @returns {object} document matching the value passed
     * @memberof Collection
     */
    Collection.prototype.by = function (field, value) {
      var self;
      if (value === undefined) {
        self = this;
        return function (value) {
          return self.by(field, value);
        };
      }

      var result = this.constraints.unique[field].get(value);
      if (!this.cloneObjects) {
        return result;
      } else {
        return clone(result, this.cloneMethod);
      }
    };

    /**
     * Find one object by index property, by property equal to value
     * @param {object} query - query object used to perform search with
     * @returns {(object|null)} First matching document, or null if none
     * @memberof Collection
     */
    Collection.prototype.findOne = function (query) {
      // Instantiate Resultset and exec find op passing firstOnly = true param
      var result = new Resultset(this, {
        queryObj: query,
        firstOnly: true
      });
      if (Array.isArray(result) && result.length === 0) {
        return null;
      } else {
        if (!this.cloneObjects) {
          return result;
        } else {
          return clone(result, this.cloneMethod);
        }
      }
    };

    /**
     * Chain method, used for beginning a series of chained find() and/or view() operations
     * on a collection.
     *
     * @param {array} transform - Ordered array of transform step objects similar to chain
     * @param {object} parameters - Object containing properties representing parameters to substitute
     * @returns {Resultset} (this) resultset, or data array if any map or join functions where called
     * @memberof Collection
     */
    Collection.prototype.chain = function (transform, parameters) {
      var rs = new Resultset(this);

      if (typeof transform === 'undefined') {
        return rs;
      }

      return rs.transform(transform, parameters);
    };

    /**
     * Find method, api is similar to mongodb.
     * for more complex queries use [chain()]{@link Collection#chain} or [where()]{@link Collection#where}.
     * @example {@tutorial Query Examples}
     * @param {object} query - 'mongo-like' query object
     * @returns {array} Array of matching documents
     * @memberof Collection
     */
    Collection.prototype.find = function (query) {
      if (typeof (query) === 'undefined') {
        query = 'getAll';
      }

      var results = new Resultset(this, {
        queryObj: query
      });
      if (!this.cloneObjects) {
        return results;
      } else {
        return cloneObjectArray(results, this.cloneMethod);
      }
    };

    /**
     * Find object by unindexed field by property equal to value,
     * simply iterates and returns the first element matching the query
     */
    Collection.prototype.findOneUnindexed = function (prop, value) {
      var i = this.data.length,
        doc;
      while (i--) {
        if (this.data[i][prop] === value) {
          doc = this.data[i];
          return doc;
        }
      }
      return null;
    };

    /**
     * Transaction methods
     */

    /** start the transation */
    Collection.prototype.startTransaction = function () {
      if (this.transactional) {
        this.cachedData = clone(this.data, this.cloneMethod);
        this.cachedIndex = this.idIndex;
        this.cachedBinaryIndex = this.binaryIndices;

        // propagate startTransaction to dynamic views
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].startTransaction();
        }
      }
    };

    /** commit the transation */
    Collection.prototype.commit = function () {
      if (this.transactional) {
        this.cachedData = null;
        this.cachedIndex = null;
        this.cachedBinaryIndex = null;

        // propagate commit to dynamic views
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].commit();
        }
      }
    };

    /** roll back the transation */
    Collection.prototype.rollback = function () {
      if (this.transactional) {
        if (this.cachedData !== null && this.cachedIndex !== null) {
          this.data = this.cachedData;
          this.idIndex = this.cachedIndex;
          this.binaryIndices = this.cachedBinaryIndex;
        }

        // propagate rollback to dynamic views
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].rollback();
        }
      }
    };

    // async executor. This is only to enable callbacks at the end of the execution.
    Collection.prototype.async = function (fun, callback) {
      setTimeout(function () {
        if (typeof fun === 'function') {
          fun();
          callback();
        } else {
          throw new TypeError('Argument passed for async execution is not a function');
        }
      }, 0);
    };

    /**
     * Query the collection by supplying a javascript filter function.
     * @example
     * var results = coll.where(function(obj) {
     *   return obj.legs === 8;
     * });
     *
     * @param {function} fun - filter function to run against all collection docs
     * @returns {array} all documents which pass your filter function
     * @memberof Collection
     */
    Collection.prototype.where = function (fun) {
      var results = new Resultset(this, {
        queryFunc: fun
      });
      if (!this.cloneObjects) {
        return results;
      } else {
        return cloneObjectArray(results, this.cloneMethod);
      }
    };

    /**
     * Map Reduce operation
     *
     * @param {function} mapFunction - function to use as map function
     * @param {function} reduceFunction - function to use as reduce function
     * @returns {data} The result of your mapReduce operation
     * @memberof Collection
     */
    Collection.prototype.mapReduce = function (mapFunction, reduceFunction) {
      try {
        return reduceFunction(this.data.map(mapFunction));
      } catch (err) {
        throw err;
      }
    };

    /**
     * Join two collections on specified properties
     *
     * @param {array} joinData - array of documents to 'join' to this collection
     * @param {string} leftJoinProp - property name in collection
     * @param {string} rightJoinProp - property name in joinData
     * @param {function=} mapFun - (Optional) map function to use
     * @returns {Resultset} Result of the mapping operation
     * @memberof Collection
     */
    Collection.prototype.eqJoin = function (joinData, leftJoinProp, rightJoinProp, mapFun) {
      // logic in Resultset class
      return new Resultset(this).eqJoin(joinData, leftJoinProp, rightJoinProp, mapFun);
    };

    /* ------ STAGING API -------- */
    /**
     * stages: a map of uniquely identified 'stages', which hold copies of objects to be
     * manipulated without affecting the data in the original collection
     */
    Collection.prototype.stages = {};

    /**
     * (Staging API) create a stage and/or retrieve it
     * @memberof Collection
     */
    Collection.prototype.getStage = function (name) {
      if (!this.stages[name]) {
        this.stages[name] = {};
      }
      return this.stages[name];
    };
    /**
     * a collection of objects recording the changes applied through a commmitStage
     */
    Collection.prototype.commitLog = [];

    /**
     * (Staging API) create a copy of an object and insert it into a stage
     * @memberof Collection
     */
    Collection.prototype.stage = function (stageName, obj) {
      var copy = JSON.parse(JSON.stringify(obj));
      this.getStage(stageName)[obj.$loki] = copy;
      return copy;
    };

    /**
     * (Staging API) re-attach all objects to the original collection, so indexes and views can be rebuilt
     * then create a message to be inserted in the commitlog
     * @param {string} stageName - name of stage
     * @param {string} message
     * @memberof Collection
     */
    Collection.prototype.commitStage = function (stageName, message) {
      var stage = this.getStage(stageName),
        prop,
        timestamp = new Date().getTime();

      for (prop in stage) {

        this.update(stage[prop]);
        this.commitLog.push({
          timestamp: timestamp,
          message: message,
          data: JSON.parse(JSON.stringify(stage[prop]))
        });
      }
      this.stages[stageName] = {};
    };

    Collection.prototype.no_op = function () {
      return;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.extract = function (field) {
      var i = 0,
        len = this.data.length,
        isDotNotation = isDeepProperty(field),
        result = [];
      for (i; i < len; i += 1) {
        result.push(deepProperty(this.data[i], field, isDotNotation));
      }
      return result;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.max = function (field) {
      return Math.max.apply(null, this.extract(field));
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.min = function (field) {
      return Math.min.apply(null, this.extract(field));
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.maxRecord = function (field) {
      var i = 0,
        len = this.data.length,
        deep = isDeepProperty(field),
        result = {
          index: 0,
          value: undefined
        },
        max;

      for (i; i < len; i += 1) {
        if (max !== undefined) {
          if (max < deepProperty(this.data[i], field, deep)) {
            max = deepProperty(this.data[i], field, deep);
            result.index = this.data[i].$loki;
          }
        } else {
          max = deepProperty(this.data[i], field, deep);
          result.index = this.data[i].$loki;
        }
      }
      result.value = max;
      return result;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.minRecord = function (field) {
      var i = 0,
        len = this.data.length,
        deep = isDeepProperty(field),
        result = {
          index: 0,
          value: undefined
        },
        min;

      for (i; i < len; i += 1) {
        if (min !== undefined) {
          if (min > deepProperty(this.data[i], field, deep)) {
            min = deepProperty(this.data[i], field, deep);
            result.index = this.data[i].$loki;
          }
        } else {
          min = deepProperty(this.data[i], field, deep);
          result.index = this.data[i].$loki;
        }
      }
      result.value = min;
      return result;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.extractNumerical = function (field) {
      return this.extract(field).map(parseBase10).filter(Number).filter(function (n) {
        return !(isNaN(n));
      });
    };

    /**
     * Calculates the average numerical value of a property
     *
     * @param {string} field - name of property in docs to average
     * @returns {number} average of property in all docs in the collection
     * @memberof Collection
     */
    Collection.prototype.avg = function (field) {
      return average(this.extractNumerical(field));
    };

    /**
     * Calculate standard deviation of a field
     * @memberof Collection
     * @param {string} field
     */
    Collection.prototype.stdDev = function (field) {
      return standardDeviation(this.extractNumerical(field));
    };

    /**
     * @memberof Collection
     * @param {string} field
     */
    Collection.prototype.mode = function (field) {
      var dict = {},
        data = this.extract(field);
      data.forEach(function (obj) {
        if (dict[obj]) {
          dict[obj] += 1;
        } else {
          dict[obj] = 1;
        }
      });
      var max,
        prop, mode;
      for (prop in dict) {
        if (max) {
          if (max < dict[prop]) {
            mode = prop;
          }
        } else {
          mode = prop;
          max = dict[prop];
        }
      }
      return mode;
    };

    /**
     * @memberof Collection
     * @param {string} field - property name
     */
    Collection.prototype.median = function (field) {
      var values = this.extractNumerical(field);
      values.sort(sub);

      var half = Math.floor(values.length / 2);

      if (values.length % 2) {
        return values[half];
      } else {
        return (values[half - 1] + values[half]) / 2.0;
      }
    };

    /**
     * General utils, including statistical functions
     */
    function isDeepProperty(field) {
      return field.indexOf('.') !== -1;
    }

    function parseBase10(num) {
      return parseFloat(num, 10);
    }

    function isNotUndefined(obj) {
      return obj !== undefined;
    }

    function add(a, b) {
      return a + b;
    }

    function sub(a, b) {
      return a - b;
    }

    function median(values) {
      values.sort(sub);
      var half = Math.floor(values.length / 2);
      return (values.length % 2) ? values[half] : ((values[half - 1] + values[half]) / 2.0);
    }

    function average(array) {
      return (array.reduce(add, 0)) / array.length;
    }

    function standardDeviation(values) {
      var avg = average(values);
      var squareDiffs = values.map(function (value) {
        var diff = value - avg;
        var sqrDiff = diff * diff;
        return sqrDiff;
      });

      var avgSquareDiff = average(squareDiffs);

      var stdDev = Math.sqrt(avgSquareDiff);
      return stdDev;
    }

    function deepProperty(obj, property, isDeep) {
      if (isDeep === false) {
        // pass without processing
        return obj[property];
      }
      var pieces = property.split('.'),
        root = obj;
      while (pieces.length > 0) {
        root = root[pieces.shift()];
      }
      return root;
    }

    function binarySearch(array, item, fun) {
      var lo = 0,
        hi = array.length,
        compared,
        mid;
      while (lo < hi) {
        mid = (lo + hi) >> 1;
        compared = fun.apply(null, [item, array[mid]]);
        if (compared === 0) {
          return {
            found: true,
            index: mid
          };
        } else if (compared < 0) {
          hi = mid;
        } else {
          lo = mid + 1;
        }
      }
      return {
        found: false,
        index: hi
      };
    }

    function BSonSort(fun) {
      return function (array, item) {
        return binarySearch(array, item, fun);
      };
    }

    function KeyValueStore() {}

    KeyValueStore.prototype = {
      keys: [],
      values: [],
      sort: function (a, b) {
        return (a < b) ? -1 : ((a > b) ? 1 : 0);
      },
      setSort: function (fun) {
        this.bs = new BSonSort(fun);
      },
      bs: function () {
        return new BSonSort(this.sort);
      },
      set: function (key, value) {
        var pos = this.bs(this.keys, key);
        if (pos.found) {
          this.values[pos.index] = value;
        } else {
          this.keys.splice(pos.index, 0, key);
          this.values.splice(pos.index, 0, value);
        }
      },
      get: function (key) {
        return this.values[binarySearch(this.keys, key, this.sort).index];
      }
    };

    function UniqueIndex(uniqueField) {
      this.field = uniqueField;
      this.keyMap = {};
      this.lokiMap = {};
    }
    UniqueIndex.prototype.keyMap = {};
    UniqueIndex.prototype.lokiMap = {};
    UniqueIndex.prototype.set = function (obj) {
      var fieldValue = obj[this.field];
      if (fieldValue !== null && typeof (fieldValue) !== 'undefined') {
        if (this.keyMap[fieldValue]) {
          throw new Error('Duplicate key for property ' + this.field + ': ' + fieldValue);
        } else {
          this.keyMap[fieldValue] = obj;
          this.lokiMap[obj.$loki] = fieldValue;
        }
      }
    };
    UniqueIndex.prototype.get = function (key) {
      return this.keyMap[key];
    };

    UniqueIndex.prototype.byId = function (id) {
      return this.keyMap[this.lokiMap[id]];
    };
    /**
     * Updates a document's unique index given an updated object.
     * @param  {Object} obj Original document object
     * @param  {Object} doc New document object (likely the same as obj)
     */
    UniqueIndex.prototype.update = function (obj, doc) {
      if (this.lokiMap[obj.$loki] !== doc[this.field]) {
        var old = this.lokiMap[obj.$loki];
        this.set(doc);
        // make the old key fail bool test, while avoiding the use of delete (mem-leak prone)
        this.keyMap[old] = undefined;
      } else {
        this.keyMap[obj[this.field]] = doc;
      }
    };
    UniqueIndex.prototype.remove = function (key) {
      var obj = this.keyMap[key];
      if (obj !== null && typeof obj !== 'undefined') {
        this.keyMap[key] = undefined;
        this.lokiMap[obj.$loki] = undefined;
      } else {
        throw new Error('Key is not in unique index: ' + this.field);
      }
    };
    UniqueIndex.prototype.clear = function () {
      this.keyMap = {};
      this.lokiMap = {};
    };

    function ExactIndex(exactField) {
      this.index = {};
      this.field = exactField;
    }

    // add the value you want returned to the key in the index
    ExactIndex.prototype = {
      set: function add(key, val) {
        if (this.index[key]) {
          this.index[key].push(val);
        } else {
          this.index[key] = [val];
        }
      },

      // remove the value from the index, if the value was the last one, remove the key
      remove: function remove(key, val) {
        var idxSet = this.index[key];
        for (var i in idxSet) {
          if (idxSet[i] == val) {
            idxSet.splice(i, 1);
          }
        }
        if (idxSet.length < 1) {
          this.index[key] = undefined;
        }
      },

      // get the values related to the key, could be more than one
      get: function get(key) {
        return this.index[key];
      },

      // clear will zap the index
      clear: function clear(key) {
        this.index = {};
      }
    };

    function SortedIndex(sortedField) {
      this.field = sortedField;
    }

    SortedIndex.prototype = {
      keys: [],
      values: [],
      // set the default sort
      sort: function (a, b) {
        return (a < b) ? -1 : ((a > b) ? 1 : 0);
      },
      bs: function () {
        return new BSonSort(this.sort);
      },
      // and allow override of the default sort
      setSort: function (fun) {
        this.bs = new BSonSort(fun);
      },
      // add the value you want returned  to the key in the index
      set: function (key, value) {
        var pos = binarySearch(this.keys, key, this.sort);
        if (pos.found) {
          this.values[pos.index].push(value);
        } else {
          this.keys.splice(pos.index, 0, key);
          this.values.splice(pos.index, 0, [value]);
        }
      },
      // get all values which have a key == the given key
      get: function (key) {
        var bsr = binarySearch(this.keys, key, this.sort);
        if (bsr.found) {
          return this.values[bsr.index];
        } else {
          return [];
        }
      },
      // get all values which have a key < the given key
      getLt: function (key) {
        var bsr = binarySearch(this.keys, key, this.sort);
        var pos = bsr.index;
        if (bsr.found) pos--;
        return this.getAll(key, 0, pos);
      },
      // get all values which have a key > the given key
      getGt: function (key) {
        var bsr = binarySearch(this.keys, key, this.sort);
        var pos = bsr.index;
        if (bsr.found) pos++;
        return this.getAll(key, pos, this.keys.length);
      },

      // get all vals from start to end
      getAll: function (key, start, end) {
        var results = [];
        for (var i = start; i < end; i++) {
          results = results.concat(this.values[i]);
        }
        return results;
      },
      // just in case someone wants to do something smart with ranges
      getPos: function (key) {
        return binarySearch(this.keys, key, this.sort);
      },
      // remove the value from the index, if the value was the last one, remove the key
      remove: function (key, value) {
        var pos = binarySearch(this.keys, key, this.sort).index;
        var idxSet = this.values[pos];
        for (var i in idxSet) {
          if (idxSet[i] == value) idxSet.splice(i, 1);
        }
        if (idxSet.length < 1) {
          this.keys.splice(pos, 1);
          this.values.splice(pos, 1);
        }
      },
      // clear will zap the index
      clear: function () {
        this.keys = [];
        this.values = [];
      }
    };


    Loki.LokiOps = LokiOps;
    Loki.Collection = Collection;
    Loki.KeyValueStore = KeyValueStore;
    Loki.persistenceAdapters = {
      fs: LokiFsAdapter,
      localStorage: LokiLocalStorageAdapter
    };
    return Loki;
  }());

}));

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}},"object-path":{"index.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat:lib/node_modules/object-path/index.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
(function (root, factory){
  'use strict';

  /*istanbul ignore next:cant test*/
  if (typeof module === 'object' && typeof module.exports === 'object') {
    module.exports = factory();
  } else if (typeof define === 'function' && define.amd) {
    // AMD. Register as an anonymous module.
    define([], factory);
  } else {
    // Browser globals
    root.objectPath = factory();
  }
})(this, function(){
  'use strict';

  var
    toStr = Object.prototype.toString,
    _hasOwnProperty = Object.prototype.hasOwnProperty;

  function isEmpty(value){
    if (!value) {
      return true;
    }
    if (isArray(value) && value.length === 0) {
        return true;
    } else if (!isString(value)) {
        for (var i in value) {
            if (_hasOwnProperty.call(value, i)) {
                return false;
            }
        }
        return true;
    }
    return false;
  }

  function toString(type){
    return toStr.call(type);
  }

  function isNumber(value){
    return typeof value === 'number' || toString(value) === "[object Number]";
  }

  function isString(obj){
    return typeof obj === 'string' || toString(obj) === "[object String]";
  }

  function isObject(obj){
    return typeof obj === 'object' && toString(obj) === "[object Object]";
  }

  function isArray(obj){
    return typeof obj === 'object' && typeof obj.length === 'number' && toString(obj) === '[object Array]';
  }

  function isBoolean(obj){
    return typeof obj === 'boolean' || toString(obj) === '[object Boolean]';
  }

  function getKey(key){
    var intKey = parseInt(key);
    if (intKey.toString() === key) {
      return intKey;
    }
    return key;
  }

  function set(obj, path, value, doNotReplace){
    if (isNumber(path)) {
      path = [path];
    }
    if (isEmpty(path)) {
      return obj;
    }
    if (isString(path)) {
      return set(obj, path.split('.').map(getKey), value, doNotReplace);
    }
    var currentPath = path[0];

    if (path.length === 1) {
      var oldVal = obj[currentPath];
      if (oldVal === void 0 || !doNotReplace) {
        obj[currentPath] = value;
      }
      return oldVal;
    }

    if (obj[currentPath] === void 0) {
      //check if we assume an array
      if(isNumber(path[1])) {
        obj[currentPath] = [];
      } else {
        obj[currentPath] = {};
      }
    }

    return set(obj[currentPath], path.slice(1), value, doNotReplace);
  }

  function del(obj, path) {
    if (isNumber(path)) {
      path = [path];
    }

    if (isEmpty(obj)) {
      return void 0;
    }

    if (isEmpty(path)) {
      return obj;
    }
    if(isString(path)) {
      return del(obj, path.split('.'));
    }

    var currentPath = getKey(path[0]);
    var oldVal = obj[currentPath];

    if(path.length === 1) {
      if (oldVal !== void 0) {
        if (isArray(obj)) {
          obj.splice(currentPath, 1);
        } else {
          delete obj[currentPath];
        }
      }
    } else {
      if (obj[currentPath] !== void 0) {
        return del(obj[currentPath], path.slice(1));
      }
    }

    return obj;
  }

  var objectPath = function(obj) {
    return Object.keys(objectPath).reduce(function(proxy, prop) {
      if (typeof objectPath[prop] === 'function') {
        proxy[prop] = objectPath[prop].bind(objectPath, obj);
      }

      return proxy;
    }, {});
  };

  objectPath.has = function (obj, path) {
    if (isEmpty(obj)) {
      return false;
    }

    if (isNumber(path)) {
      path = [path];
    } else if (isString(path)) {
      path = path.split('.');
    }

    if (isEmpty(path) || path.length === 0) {
      return false;
    }

    for (var i = 0; i < path.length; i++) {
      var j = path[i];
      if ((isObject(obj) || isArray(obj)) && _hasOwnProperty.call(obj, j)) {
        obj = obj[j];
      } else {
        return false;
      }
    }

    return true;
  };

  objectPath.ensureExists = function (obj, path, value){
    return set(obj, path, value, true);
  };

  objectPath.set = function (obj, path, value, doNotReplace){
    return set(obj, path, value, doNotReplace);
  };

  objectPath.insert = function (obj, path, value, at){
    var arr = objectPath.get(obj, path);
    at = ~~at;
    if (!isArray(arr)) {
      arr = [];
      objectPath.set(obj, path, arr);
    }
    arr.splice(at, 0, value);
  };

  objectPath.empty = function(obj, path) {
    if (isEmpty(path)) {
      return obj;
    }
    if (isEmpty(obj)) {
      return void 0;
    }

    var value, i;
    if (!(value = objectPath.get(obj, path))) {
      return obj;
    }

    if (isString(value)) {
      return objectPath.set(obj, path, '');
    } else if (isBoolean(value)) {
      return objectPath.set(obj, path, false);
    } else if (isNumber(value)) {
      return objectPath.set(obj, path, 0);
    } else if (isArray(value)) {
      value.length = 0;
    } else if (isObject(value)) {
      for (i in value) {
        if (_hasOwnProperty.call(value, i)) {
          delete value[i];
        }
      }
    } else {
      return objectPath.set(obj, path, null);
    }
  };

  objectPath.push = function (obj, path /*, values */){
    var arr = objectPath.get(obj, path);
    if (!isArray(arr)) {
      arr = [];
      objectPath.set(obj, path, arr);
    }

    arr.push.apply(arr, Array.prototype.slice.call(arguments, 2));
  };

  objectPath.coalesce = function (obj, paths, defaultValue) {
    var value;

    for (var i = 0, len = paths.length; i < len; i++) {
      if ((value = objectPath.get(obj, paths[i])) !== void 0) {
        return value;
      }
    }

    return defaultValue;
  };

  objectPath.get = function (obj, path, defaultValue){
    if (isNumber(path)) {
      path = [path];
    }
    if (isEmpty(path)) {
      return obj;
    }
    if (isEmpty(obj)) {
      return defaultValue;
    }
    if (isString(path)) {
      return objectPath.get(obj, path.split('.'), defaultValue);
    }

    var currentPath = getKey(path[0]);

    if (path.length === 1) {
      if (obj[currentPath] === void 0) {
        return defaultValue;
      }
      return obj[currentPath];
    }

    return objectPath.get(obj[currentPath], path.slice(1), defaultValue);
  };

  objectPath.del = function(obj, path) {
    return del(obj, path);
  };

  return objectPath;
});

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}}}}}},{"extensions":[".js",".json",".coffee",".info"]});
require("./node_modules/meteor/rocketchat:lib/lib/core.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/debug.js");
require("./node_modules/meteor/rocketchat:lib/lib/getURL.js");
require("./node_modules/meteor/rocketchat:lib/lib/settings.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/configLogger.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/callbacks.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/fileUploadRestrictions.js");
require("./node_modules/meteor/rocketchat:lib/lib/placeholders.js");
require("./node_modules/meteor/rocketchat:lib/lib/promises.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/roomTypesCommon.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/slashCommand.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/Message.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/MessageTypes.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/bugsnag.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/metrics.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/RateLimiter.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/isDocker.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/addUserToDefaultChannels.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/addUserToRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/archiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/checkUsernameAvailability.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/checkEmailAvailability.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/createRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/deleteMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/deleteUser.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/getFullUserData.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/getRoomByNameOrIdWithOptionToJoin.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/removeUserFromRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/saveUser.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/saveCustomFields.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/sendMessage.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/settings.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/setUserAvatar.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/setUsername.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/setEmail.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/unarchiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/updateMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/Notifications.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/PushNotification.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/defaultBlockedDomainsList.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/notifyUsersOnMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/roomTypes.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/sendEmailOnMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/sendNotificationsOnMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/validateEmailDomain.js");
require("./node_modules/meteor/rocketchat:lib/server/models/_Base.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Messages.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Reports.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Rooms.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Settings.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Subscriptions.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Uploads.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Users.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/statsTracker.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/cache/CacheLoad.js");
require("./node_modules/meteor/rocketchat:lib/server/publications/settings.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/addOAuthService.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/refreshOAuthService.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/addUserToRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/addUsersToRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/archiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/blockUser.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/checkRegistrationSecretURL.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/cleanChannelHistory.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/createChannel.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/createPrivateGroup.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/deleteMessage.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/deleteUserOwnAccount.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/filterBadWords.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/filterATAllTag.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getChannelHistory.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getFullUserData.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getRoomRoles.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getServerInfo.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getUserRoles.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/insertOrUpdateUser.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/joinDefaultChannels.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/joinRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/leaveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/removeOAuthService.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/restartServer.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/robotMethods.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/saveSetting.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/sendInvitationEmail.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/sendMessage.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/sendSMTPTestEmail.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setAdminStatus.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setRealName.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setUsername.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setEmail.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/unarchiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/unblockUser.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/updateMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/settingsOnLoadCdnPrefix.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/settingsOnLoadSMTP.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/oAuthServicesUpdate.coffee.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/settings.coffee.js");
require("./node_modules/meteor/rocketchat:lib/lib/startup/settingsOnLoadSiteUrl.coffee.js");
require("./node_modules/meteor/rocketchat:lib/startup/defaultRoomTypes.js");
require("./node_modules/meteor/rocketchat:lib/rocketchat.info.js");

/* Exports */
if (typeof Package === 'undefined') Package = {};
(function (pkg, symbols) {
  for (var s in symbols)
    (s in pkg) || (pkg[s] = symbols[s]);
})(Package['rocketchat:lib'] = {}, {
  RocketChat: RocketChat,
  RocketChatTabBar: RocketChatTabBar
});

})();

//# sourceMappingURL=rocketchat_lib.js.map
