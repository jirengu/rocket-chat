{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/lib.js","meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/events.js","meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/powerbox.js"],"names":["RocketChat","Sandstorm","process","env","SANDSTORM","Future","Capnp","SandstormHttpBridge","capnpConnection","httpBridge","Npm","require","getHttpBridge","connect","restore","promiseToFuture","promise","result","then","return","bind","throw","waitPromise","wait","UploadFS","Store","prototype","getURL","path","getRelativeURL","notify","ACTIVITY_TYPES","message","userIds","caption","type","sessionId","sandstormSessionId","activity","notification","defaultText","users","_","map","userId","user","Meteor","findOne","_id","fields","identity","getSavedIdentity","services","sandstorm","id","mentioned","getSessionContext","context","offerUiView","Powerbox","Grain","token","serializedDescriptor","session","api","getSandstormApi","cap","Buffer","offer","undefined","tags","value","methods","sandstormClaimRequest","descriptor","parsePacked","PowerboxDescriptor","grainTitle","parse","UiView","PowerboxTag","title","connection","claimRequest","castAs","newToken","save","toString","viewInfo","getViewInfo","appTitle","asset","grainIcon","getUrl","appIconUrl","protocol","hostPath","sandstormOffer"],"mappings":"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","file":"/packages/rocketchat_sandstorm.js","sourcesContent":["/* globals getHttpBridge, waitPromise, UploadFS */\n/* exported getHttpBridge, waitPromise */\n\nRocketChat.Sandstorm = {};\n\nif (process.env.SANDSTORM === '1') {\n\tvar Future = Npm.require('fibers/future');\n\tvar Capnp = Npm.require('capnp');\n\tvar SandstormHttpBridge = Npm.require('sandstorm/sandstorm-http-bridge.capnp').SandstormHttpBridge;\n\n\tvar capnpConnection = null;\n\tvar httpBridge = null;\n\n\tgetHttpBridge = function() {\n\t\tif (!httpBridge) {\n\t\t\tcapnpConnection = Capnp.connect('unix:/tmp/sandstorm-api');\n\t\t\thttpBridge = capnpConnection.restore(null, SandstormHttpBridge);\n\t\t}\n\t\treturn httpBridge;\n\t};\n\n\tconst promiseToFuture = function(promise) {\n\t\tconst result = new Future();\n\t\tpromise.then(result.return.bind(result), result.throw.bind(result));\n\t\treturn result;\n\t};\n\n\twaitPromise = function(promise) {\n\t\treturn promiseToFuture(promise).wait();\n\t};\n\n\t// This usual implementation of this method returns an absolute URL that is invalid\n\t// under Sandstorm.\n\tUploadFS.Store.prototype.getURL = function(path) {\n\t\treturn this.getRelativeURL(path);\n\t};\n}\n","/* globals getHttpBridge, waitPromise */\n\nRocketChat.Sandstorm.notify = function() {};\n\nif (process.env.SANDSTORM === '1') {\n\tvar ACTIVITY_TYPES = {\n\t\t'message': 0,\n\t\t'privateMessage': 1\n\t};\n\n\tRocketChat.Sandstorm.notify = function(message, userIds, caption, type) {\n\t\tvar sessionId = message.sandstormSessionId;\n\t\tif (!sessionId) {\n\t\t\treturn;\n\t\t}\n\t\tvar httpBridge = getHttpBridge();\n\t\tvar activity = {};\n\n\t\tif (type) {\n\t\t\tactivity.type = ACTIVITY_TYPES[type];\n\t\t}\n\n\t\tif (caption) {\n\t\t\tactivity.notification = {caption: {defaultText: caption}};\n\t\t}\n\n\t\tif (userIds) {\n\t\t\tactivity.users = _.map(userIds, function(userId) {\n\t\t\t\tvar user = Meteor.users.findOne({_id: userId}, {fields: {'services.sandstorm.id': 1}});\n\t\t\t\treturn {\n\t\t\t\t\tidentity: waitPromise(httpBridge.getSavedIdentity(user.services.sandstorm.id)).identity,\n\t\t\t\t\tmentioned: true\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\treturn waitPromise(httpBridge.getSessionContext(sessionId).context.activity(activity));\n\t};\n}\n","/* globals getHttpBridge, waitPromise */\n\nRocketChat.Sandstorm.offerUiView = function() {};\n\nif (process.env.SANDSTORM === '1') {\n\tvar Capnp = Npm.require('capnp');\n\tvar Powerbox = Npm.require('sandstorm/powerbox.capnp');\n\tvar Grain = Npm.require('sandstorm/grain.capnp');\n\n\tRocketChat.Sandstorm.offerUiView = function(token, serializedDescriptor, sessionId) {\n\t\tvar httpBridge = getHttpBridge();\n\t\tvar session = httpBridge.getSessionContext(sessionId).context;\n\t\tvar api = httpBridge.getSandstormApi(sessionId).api;\n\t\tvar cap = waitPromise(api.restore(new Buffer(token, 'base64'))).cap;\n\t\treturn waitPromise(session.offer(cap, undefined, {tags: [{\n\t\t\tid: '15831515641881813735',\n\t\t\tvalue: new Buffer(serializedDescriptor, 'base64')\n\t\t}]}));\n\t};\n\n\tMeteor.methods({\n\t\tsandstormClaimRequest: function(token, serializedDescriptor) {\n\t\t\tvar descriptor = Capnp.parsePacked(Powerbox.PowerboxDescriptor, new Buffer(serializedDescriptor, 'base64'));\n\t\t\tvar grainTitle = Capnp.parse(Grain.UiView.PowerboxTag, descriptor.tags[0].value).title;\n\t\t\tvar sessionId = this.connection.sandstormSessionId();\n\t\t\tvar httpBridge = getHttpBridge();\n\t\t\tvar session = httpBridge.getSessionContext(sessionId).context;\n\t\t\tvar cap = waitPromise(session.claimRequest(token)).cap.castAs(Grain.UiView);\n\t\t\tvar api = httpBridge.getSandstormApi(sessionId).api;\n\t\t\tvar newToken = waitPromise(api.save(cap)).token.toString('base64');\n\t\t\tvar viewInfo = waitPromise(cap.getViewInfo());\n\t\t\tvar appTitle = viewInfo.appTitle;\n\t\t\tvar asset = waitPromise(viewInfo.grainIcon.getUrl());\n\t\t\tvar appIconUrl = asset.protocol + '://' + asset.hostPath;\n\t\t\treturn {\n\t\t\t\ttoken: newToken,\n\t\t\t\tappTitle: appTitle,\n\t\t\t\tappIconUrl: appIconUrl,\n\t\t\t\tgrainTitle: grainTitle,\n\t\t\t\tdescriptor: descriptor.tags[0].value.toString('base64')\n\t\t\t};\n\t\t},\n\t\tsandstormOffer: function(token, serializedDescriptor) {\n\t\t\tRocketChat.Sandstorm.offerUiView(token, serializedDescriptor,\n\t\t\t\tthis.connection.sandstormSessionId());\n\t\t}\n\t});\n}\n"]}